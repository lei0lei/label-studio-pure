(self.webpackChunklabelstudio=self.webpackChunklabelstudio||[]).push([[939],{18094:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var i=n(84411),o=n(31085);const s="https://labelstud.io/guide/storage.html#Troubleshoot-CORS-and-access-problems",a={DONE:"Done!",NO_COMP_LEFT:"No more annotations",NO_NEXT_TASK:"No More Tasks Left in Queue",NO_ACCESS:"You don't have access to this task",CONFIRM_TO_DELETE_ALL_REGIONS:"Please confirm you want to delete all labeled regions",ERR_REQUIRED:({modelName:e,field:t})=>`Attribute <b>${t}</b> is required for <b>${e}</b>`,ERR_UNKNOWN_TAG:({modelName:e,field:t,value:n})=>`Tag with name <b>${n}</b> is not registered. Referenced by <b>${e}#${t}</b>.`,ERR_TAG_NOT_FOUND:({modelName:e,field:t,value:n})=>`Tag with name <b>${n}</b> does not exist in the config. Referenced by <b>${e}#${t}</b>.`,ERR_TAG_UNSUPPORTED:({modelName:e,field:t,value:n,validType:i})=>`Invalid attribute <b>${t}</b> for <b>${e}</b>: referenced tag is <b>${n}</b>, but <b>${e}</b> can only control <b>${[].concat(i).join(", ")}</b>`,ERR_PARENT_TAG_UNEXPECTED:({validType:e,value:t})=>`Tag <b>${t}</b> must be a child of one of the tags <b>${[].concat(e).join(", ")}</b>.`,ERR_BAD_TYPE:({modelName:e,field:t,validType:n})=>`Attribute <b>${t}</b> of tag <b>${e}</b> has invalid type. Valid types are: <b>${n}</b>.`,ERR_INTERNAL:({value:e})=>`Internal error. See browser console for more info. Try again or contact developers.<br/>${e}`,ERR_GENERAL:({value:e})=>e,URL_CORS_DOCS:s,URL_TAGS_DOCS:"https://labelstud.io/tags",ERR_LOADING_AUDIO:({attr:e,url:t,error:n})=>(0,o.jsxs)("div",{"data-testid":"error:audio",children:[(0,o.jsxs)("p",{children:["Error while loading audio. Check ",(0,o.jsx)("code",{children:e})," field in task."]}),(0,o.jsxs)("p",{children:["Technical description: ",n]}),(0,o.jsxs)("p",{children:["URL: ",(0,i.htmlEscape)(t)]})]}),ERR_LOADING_S3:({attr:e,url:t})=>`\n    <div>\n      <p>\n        There was an issue loading URL from <code>${e}</code> value.\n        The request parameters are invalid.\n        If you are using S3, make sure youâ€™ve specified the right bucket region name.\n      </p>\n      <p>URL: <code><a href="${encodeURI(t)}" target="_blank" rel="noreferrer">${(0,i.htmlEscape)(t)}</a></code></p>\n    </div>`,ERR_LOADING_CORS:({attr:e,url:t})=>`\n    <div>\n      <p>\n        There was an issue loading URL from <code>${e}</code> value.\n        Most likely that's because static server has wide-open CORS.\n        <a href="${s}" target="_blank">Read more on that here.</a>\n      </p>\n      <p>\n        Also check that:\n        <ul>\n          <li>URL is valid</li>\n          <li>Network is reachable</li>\n        </ul>\n      </p>\n      <p>URL: <code><a href="${encodeURI(t)}" target="_blank" rel="noreferrer">${(0,i.htmlEscape)(t)}</a></code></p>\n    </div>`,ERR_LOADING_HTTP:({attr:e,url:t,error:n})=>`\n    <div data-testid="error:http">\n      <p>\n        There was an issue loading URL from <code>${e}</code> value\n      </p>\n      <p>\n        Things to look out for:\n        <ul>\n          <li>URL is valid</li>\n          <li>URL scheme matches the service scheme, i.e. https and https</li>\n          <li>\n            The static server has wide-open CORS,\n            <a href=${s} target="_blank">more on that here</a>\n          </li>\n        </ul>\n      </p>\n      <p>\n        Technical description: <code>${n}</code>\n        <br />\n        URL: <code><a href="${encodeURI(t)}" target="_blank" rel="noreferrer">${(0,i.htmlEscape)(t)}</a></code>\n      </p>\n    </div>`}},30997:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});const i={onDeleteAnnotation:function(){},onEntityCreate:function(){},onEntityDelete:function(){},onGroundTruth:function(){},onLabelStudioLoad:function(){},onSkipTask:function(){},onUnskipTask:function(){},onSubmitAnnotation:function(){},onSubmitDraft:function(e){},onTaskLoad:function(){},onUpdateAnnotation:function(){},onSelectAnnotation:function(e,t){},onAcceptAnnotation:function(e,t){},onRejectAnnotation:function(e,t){},onStorageInitialized:function(e){},onNextTask:function(e){},onPrevTask:function(e){}}},42938:()=>{},47895:(e,t,n)=>{"use strict";n.d(t,{A:()=>o,l:()=>i});const i={fillcolor:"#666",opacity:.2,strokecolor:"#666",strokewidth:1},o={FILL_COLOR:"",STROKE_COLOR:"",STROKE_WIDTH:1,LABEL_BACKGROUND:"#DA935D",EMPTY_LABEL:"blank",RELATION_BACKGROUND:"#fff",SHOW_LABEL_FILL:"white",SHOW_LABEL_BACKGROUND:"black",HIGHLIGHTED_STROKE_COLOR:"red",HIGHLIGHTED_STROKE_WIDTH:2,HIGHLIGHTED_CSS_BORDER:"1px dashed #00aeff",SUGGESTION_STROKE_WIDTH:4,DEFAULT_CURSOR:"default",CHOOSE_CURSOR:"pointer",POINTER_CURSOR:"pointer",MOVE_CURSOR:"hand",LINKING_MODE_CURSOR:"crosshair",BRIGHTNESS_VALUE:100,BRIGHTNESS_MAX:400,CONTRAST_VALUE:100,CONTRAST_MAX:400}},48862:(e,t,n)=>{"use strict";n.r(t),n.d(t,{atobUnicode:()=>v,camelizeKeys:()=>T,chunks:()=>R,clamp:()=>P,delay:()=>S,destroyMSTObject:()=>K,emailFromCreatedBy:()=>N,escapeHtml:()=>y,findClosestParent:()=>k,fixMobxObserve:()=>D,flatten:()=>p,getUrl:()=>h,hashCode:()=>f,humanDateDiff:()=>E,isArraysEqual:()=>b,isDefined:()=>C,isMacOS:()=>I,isString:()=>c,isStringEmpty:()=>d,isStringJSON:()=>u,isValidObjectURL:()=>g,minMax:()=>A,snakeizeKeys:()=>_,sortAnnotations:()=>O,toArray:()=>w,toTimeString:()=>m,triggerResizeEvent:()=>M,userDisplayName:()=>j,wrapArray:()=>x});var i=n(57958),o=n(77099),s=n(99677),a=n.n(s),r=n(79867),l=n.n(r);const c=e=>"string"==typeof e||e instanceof String,d=e=>!!c(e)&&0===e.length,u=e=>{if(c(e)){try{JSON.parse(e)}catch(e){return!1}return!0}return!1};function h(e,t){const n=t.slice(e),i=/^(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/g.exec(n);return i&&i.length?i[1]:""}function g(e,t=!1){return"string"==typeof e&&(!(!t||!e.startsWith("/"))||/^https?:\/\//.test(e))}function m(e){var t;if("number"==typeof e)return null==(t=new Date(e).toUTCString().match(/(\d\d:\d\d:\d\d)/))?void 0:t[0]}function p(e){return e.reduce((e,t)=>e.concat(Array.isArray(t)?p(t):t),[])}function f(e){let t=0;if(0===e.length)return`${t}`;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return`${t}`}function v(e){return decodeURIComponent(atob(e).split("").map(e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""))}function y(e){return(null!=e?e:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function b(e,t){return e.length===t.length&&e.every((e,n)=>t[n]===e)}function x(e){return[].concat(e)}function w(e){return(Array.isArray(e)?e:[e]).filter(e=>void 0!==e)}function S(e=0){return new Promise(t=>setTimeout(t,e))}const C=e=>null!=e;function k(e,t=()=>!0,n=e=>e.parent){for(;e=n(e);)if(t(e))return e;return null}function P(e,t,n){return Math.min(n,Math.max(t,e))}const R=(e,t)=>{const n=[];let i,o;for(i=0,o=e.length;i<o;i+=t)n.push(e.slice(i,i+t));return n},j=(e={})=>{const{firstName:t,lastName:n}=e;return t||n?[t,n].filter(e=>!!e).join(" ").trim():e.username||e.email},N=e=>{var t;return null==e||null==(t=e.match(/([^@,\s]+@[^@,\s]+)(,\s*\d+)?$/))?void 0:t[1]},T=e=>Object.fromEntries(Object.entries(e).map(([e,t])=>"[object Object]"===Object.prototype.toString.call(t)?[a()(e),T(t)]:[a()(e),t])),_=e=>Object.fromEntries(Object.entries(e).map(([e,t])=>"[object Object]"===Object.prototype.toString.call(t)?[l()(e),_(t)]:[l()(e),t]));function A(e){return e.reduce((e,t)=>(e[0]=void 0===e[0]||t<e[0]?t:e[0],e[1]=void 0===e[1]||t>e[1]?t:e[1],e),[])}function I(){return navigator.platform.indexOf("Mac")>-1}const M=()=>{const e=new Event("resize");e.initEvent("resize",!1,!1),window.dispatchEvent(e)},E=e=>{const t=(0,i.A)(new Date(e),{addSuffix:!0});return"less than a minute ago"===t?"just now":t},K=e=>{e&&((0,o.Yo)(e),(0,o.zr)(e))},D=(...e)=>{},O=e=>e.sort((e,t)=>new Date(t.createdDate).getTime()-new Date(e.createdDate).getTime())},50494:(e,t,n)=>{"use strict";n.d(t,{cn:()=>i._d});var i=n(76316)},50719:(e,t,n)=>{"use strict";n.d(t,{A3:()=>c,BK:()=>i,Cq:()=>a,KC:()=>o,OT:()=>y,P7:()=>m,Rw:()=>u,Um:()=>v,bW:()=>h,cH:()=>f,gt:()=>l,l2:()=>p,pr:()=>d,v:()=>g,vt:()=>r,zO:()=>s});const i={FFT_SAMPLES:512,MEL_BANDS:64,WINDOWING_FUNCTION:"blackman",COLOR_SCHEME:"viridis",MIN_DB:-80,MAX_DB:-10},o=2e3,s=60,a=!0,r=128,l=128,c=140,d=.5,u=1,h=5,g=3,m=60,p=100,f=2,v=5e4,y=1e7},51660:(e,t,n)=>{"use strict";n.r(t),n.d(t,{LabelStudio:()=>GP,default:()=>YP});var i={};n.r(i),n.d(i,{drawMask:()=>yt});var o={};n.r(o),n.d(o,{canvasToBinaryMatrix:()=>wt,createDragBoundFunc:()=>Pt,fixRectToFit:()=>kt,getActualZoomingPosition:()=>jt,getBoundingBoxAfterChanges:()=>Ct,getBoundingBoxAfterTransform:()=>St,getTransformedImageData:()=>Rt,mapKonvaBrightness:()=>Nt,reverseCoordinates:()=>xt});var s={};n.r(s),n.d(s,{currentISODate:()=>It,msToHMS:()=>Tt,prettyDate:()=>_t,toISODateString:()=>At});var a={};n.r(a),n.d(a,{applySpanStyles:()=>Ut,applyTextGranularity:()=>Bt,captureSelection:()=>zt,charsToCodePoints:()=>Xt,findNodesBetween:()=>Gt,fixCodePointsInRange:()=>qt,fixRange:()=>Ht,highlightRange:()=>Vt,highlightRangePart:()=>$t,isSelectionContainsSpan:()=>Qt,isTextNode:()=>Mt,rangeToGlobalOffset:()=>Zt,removeRange:()=>Yt,trimSelection:()=>Ot,wrapWithSpan:()=>Wt});var r={};n.r(r),n.d(r,{AudioVolumeControl:()=>Jn,FramesControl:()=>Wn});var l={};n.r(l),n.d(l,{Bitmask:()=>Sc,BitmaskErase:()=>_c,Brightness:()=>nd,Brush:()=>vc,Contrast:()=>sd,Ellipse:()=>Vc,Erase:()=>Rc,KeyPoint:()=>Ic,MagicWand:()=>ld,Polygon:()=>Ec,Rect:()=>Bc,Rect3Point:()=>Fc,Rotate:()=>Qc,Selection:()=>ud,Vector:()=>Dc,Zoom:()=>qc});var c={};n.r(c),n.d(c,{VideoSettings:()=>Bx});n(81117);var d=n(57896),u=n(77099),h=n(43144),g=n(25873),m=n(99677),p=n.n(m),f=n(14041),v=n(74626),y=n(69447),b=n(56351);const x=()=>{const e=(0,f.useRef)(!0);return(0,f.useEffect)(()=>(e.current=!0,()=>{e.current=!1}),[]),e};var w=n(47895);const S=u.gK.model("CommentMode",{}).volatile(()=>({comment:null})).views(e=>({get annotation(){return(0,u.PA)(e,2)},get regionStore(){return e.annotation.regionStore}})).actions(e=>({start(t){e.comment=t},stop(){e.comment=null,e.regionStore.unhighlightAll()},addLinkedRegion(t){e.comment.setRegionLink(t),e.stop()},addLinkedResult(t){e.comment.setResultLink(t),e.stop()}})),C={key:"link_to_comment",model:S},k={key:"create_relation",model:u.gK.model("RelationsMode",{}).volatile(()=>({region:null})).views(e=>({get annotation(){return(0,u.PA)(e,2)},get regionStore(){return e.annotation.regionStore},get relationStore(){return e.annotation.relationStore}})).actions(e=>({start(t){e.region=t},stop(){e.region=null,e.regionStore.unhighlightAll()},addLinkedRegion(t){e.relationStore.addRelation(e.region,t),e.stop()}}))},P=k.key,R=C.key,j=u.gK.union(C.model,k.model),N=u.gK.model("LinkingModes",{linkingModes:u.gK.optional(u.gK.map(j),()=>({[k.key]:k.model.create({}),[C.key]:C.model.create({})}))}).volatile(e=>({linkingMode:!1})).views(e=>({get currentLinkingMode(){return e.linkingMode&&e.linkingModes.has(e.linkingMode)?e.linkingModes.get(e.linkingMode):null},get isLinkingMode(){return!!e.linkingMode},get relationMode(){return console.warn("`relationMode` is deprecated. Use `isLinkingMode` instead."),e.isLinkingMode}})).actions(e=>({startLinkingMode(t,n){e.isLinkingMode&&e.stopLinkingMode(),e.linkingMode=t,e.currentLinkingMode?(e.currentLinkingMode.start(n),document.body.style.cursor=w.A.CHOOSE_CURSOR):e.linkingMode=!1},stopLinkingMode(){document.body.style.cursor=w.A.DEFAULT_CURSOR,e.currentLinkingMode&&e.currentLinkingMode.stop(),e.linkingMode=!1},addLinkedRegion(t){e.currentLinkingMode&&(null==e.currentLinkingMode.addLinkedRegion||e.currentLinkingMode.addLinkedRegion(t))},addLinkedResult(t){e.currentLinkingMode&&(null==e.currentLinkingMode.addLinkedResult||e.currentLinkingMode.addLinkedResult(t))},startRelationMode(t){console.warn("`startRelationMode` is deprecated. Use `startLinkingMode(CREATE_RELATION_MODE, obj)` instead."),e.startLinkingMode(k.key,t)},stopRelationMode(){console.warn("`stopRelationMode` is deprecated. Use `stopLinkingMode` instead."),e.stopLinkingMode()}}));var T;const _=null!=(T=window.ResizeObserver)?T:class{observe(){}unobserve(){}disconnect(){}};var A=n(74331);const I=(e=10)=>(0,A.Ak)(e);function M(e,t,n=!1){let i;return function(...o){const s=n&&!i;clearTimeout(i),i=setTimeout(()=>{i=null,n||e.apply(this,o)},t),s&&e.apply(this,o)}}var E=n(48862);class K{static normalizeAngle(e){return(e+360)%360*(Math.PI/180)}static getPointsBBox(e){const t=[null,null,null,null];return e.forEach((e,n)=>{const i=2*Math.round(n/2)-n;0===i?((null===t[0]||t[0]>=e)&&(t[0]=e),(null===t[2]||t[2]<=e)&&(t[2]=e)):1===i&&((null===t[1]||t[1]>=e)&&(t[1]=e),(null===t[3]||t[3]<=e)&&(t[3]=e))}),t}static distance(e,t){const[n,i]=e,[o,s]=t;return Math.sqrt((o-n)**2+(s-i)**2)}static toRectCoordinates(e){const{x:t,y:n,width:i,height:o}=e,[s,a]=[t+i,n],[r,l]=[t+i,n+o],[c,d]=[t,n+o];return{x1:t,x2:s,x3:r,x4:c,y1:n,y2:a,y3:l,y4:d}}static convertToRectBBox(e){return{x:e.x1,y:e.y1,width:e.x2-e.x1,height:e.y3-e.y1}}static closestRects(e,t){return e.reduce((e,n)=>{const i=K.toRectCoordinates(n);return t.forEach(t=>{const n=K.toRectCoordinates(t),o=[K.distance([i.x1,i.y1],[n.x1,i.y1]),K.distance([i.x2,i.y2],[n.x2,i.y2]),K.distance([i.x3,i.y3],[n.x3,i.y3]),K.distance([i.x4,i.y4],[n.x4,n.y4])].reduce((e,t)=>e+t)/4;e.push({distance:o,bbox:[K.convertToRectBBox(i),K.convertToRectBBox(n)]})}),e},[]).sort((e,t)=>e.distance-t.distance)[0].bbox}static scaleBBox(e,t=1){return Object.assign({},e,{x:e.x*t,y:e.y*t,width:e.width*t,height:e.height*t})}static modifyBBoxCoords(e,t=e=>e){const n=t([e.x,e.y]),i=t([e.width+e.x,e.height+e.y]);return Object.assign({},e,{x:Math.min(n[0],i[0]),y:Math.min(n[1],i[1]),width:Math.abs(i[0]-n[0]),height:Math.abs(i[1]-n[1])})}static padding(e,t=0){const n=e.width<1?0:t,i=e.height<1?0:t;return Object.assign({},e,{x:e.x-n,y:e.y-i,width:e.width+2*n,height:e.height+2*i})}static getEllipseBBox(e,t,n,i,o){const s=K.normalizeAngle(o),a=2*Math.max(n,i),r=2*Math.min(n,i),[l,c]=(()=>{const t=Math.atan(-r/2*Math.tan(s)/(a/2));return[t,t+Math.PI].map(t=>e+a/2*Math.cos(t)*Math.cos(s)-r/2*Math.sin(t)*Math.sin(s)).sort((e,t)=>t-e)})(),[d,u]=(()=>{const e=Math.atan(r/2*1/Math.tan(s)/(a/2));return[e,e+Math.PI].map(e=>t+r/2*Math.sin(e)*Math.cos(s)+a/2*Math.cos(e)*Math.sin(s)).sort((e,t)=>t-e)})();return{x:c,y:u,width:l-c,height:d-u}}static getRectBBox(e,t,n,i,o){const s=K.normalizeAngle(o),a=(n,i)=>[(n-e)*Math.cos(s)-(i-t)*Math.sin(s)+e,(n-e)*Math.sin(s)+(i-t)*Math.cos(s)+t],[r,l,c,d]=K.getPointsBBox([e,t,...a(e+n,t),...a(e+n,t+i),...a(e,t+i)]);return{x:r,y:l,width:c-r,height:d-l}}static getPolygonBBox(e){const t=e.reduce((e,t)=>[...e,t.x,t.y],[]),[n,i,o,s]=K.getPointsBBox(t);return{x:n,y:i,width:o-n,height:s-i}}static getBrushBBox(e){const[t,n,i,o]=K.getPointsBBox(e);return{x:t,y:n,width:i-t,height:o-n}}static getImageDataBBox(e,t,n){if(e.length!==t*n*4)return null;const i={x:t,y:n},o={x:0,y:0};for(let s=0;s<n;s++)for(let n=0;n<t;n++){e[4*(s*t+n)+3]&&(i.x>n&&(i.x=n),i.y>s&&(i.y=s),o.x<n&&(o.x=n),o.y<s&&(o.y=s))}return i.x<=o.x&&i.y<=o.y?{x:i.x,y:i.y,width:o.x-i.x,height:o.y-i.y}:null}static combineBBoxes(...e){const[t,n,i,o]=K.getPointsBBox(e.reduce((e,t)=>(t&&t.x&&t.y&&(e.push(t.x),e.push(t.y),e.push(t.x+t.width),e.push(t.y+t.height)),e),[]));return{x:t,y:n,width:i-t,height:o-n}}static clampBBox(e,t,n){const i=[(0,E.clamp)(e.x,t.x,n.x),(0,E.clamp)(e.y,t.y,n.y)],o=[(0,E.clamp)(e.width+e.x,t.x,n.x),(0,E.clamp)(e.height+e.y,t.y,n.y)];return{x:i[0],y:i[1],width:o[0]-i[0],height:o[1]-i[1]}}static getDOMBBox(e,t=!1){if(!e)return null;const n=e.getClientRects();if(0===n.length)return null;const i=e=>({x:e.x,y:e.y,width:e.width,height:e.height});return t?i(n[0]):Array.from(e.getClientRects()).map(i)}}const D={x:0,y:0,width:0,height:0};class O{static bbox(e){const t=L(e);return(0,E.wrapArray)(t).map(e=>Object.assign(Object.assign({},D),e))}constructor(e){this.options={},Object.assign(this.options,e)}get _source(){return this.options.source}get x(){return this.options.getX(this._source)}get y(){return this.options.getY(this._source)}get width(){return this.options.getWidth(this._source)}get height(){return this.options.getHeight(this._source)}}const L=e=>{var t;if(!!e.from_name)return K.getDOMBBox(null==(t=e.from_name.elementRef)?void 0:t.current);switch(e.type){case"textrange":case"richtextregion":case"textarearegion":case"paragraphs":case"timeseriesregion":{var n;const t=K.getDOMBBox(e.getRegionElement()),i=null==(n=e.parent)||null==(n=n.mountNodeRef)?void 0:n.current;if("IFRAME"===(null==i?void 0:i.tagName)){const e=K.getDOMBBox(i,!0);return(null==t?void 0:t.map(t=>Object.assign({},t,{x:t.x+e.x,y:t.y+e.y})))||null}return t}case"audioregion":{var i;const t=e.bboxCoordsCanvas,n=null==(i=e.parent)||null==(i=i.stageRef)?void 0:i.current,o=K.getDOMBBox(n,!0);return t?o?{x:o.x+t.left,y:o.y+t.top,width:t.right-t.left,height:t.bottom-t.top}:t:D}case"rectangleregion":case"ellipseregion":case"polygonregion":case"vectorregion":case"keypointregion":case"brushregion":case"bitmaskregion":{const t=e.bboxCoordsCanvas;return t?((e,t)=>{var n;if(null==(n=e.parent)||!n.stageRef)return null;const i=K.getDOMBBox(e.parent.stageRef.content,!0),o=K.clampBBox(K.modifyBBoxCoords(t,e.parent.zoomOriginalCoords),{x:0,y:0},{x:e.parent.canvasSize.width,y:e.parent.canvasSize.height});return Object.assign({},o,{x:i.x+o.x,y:i.y+o.y})})(e,{x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top}):D}default:return console.warn(`Unknown region type: ${e.type}`),Object.assign({},D)}};class z{constructor(e){this.params={},this._onUpdated=null,this.onChanged=()=>{var e;null==(e=this.onUpdated)||e.call(this)},Object.assign(this.params,e),this.params.watcher&&(this._watcher=new this.params.watcher(this.params.root,this.params.element,this.onChanged))}boundingBox(){return O.bbox(this.params.element)}onUpdate(e){this.onUpdated=e}destroy(){this.onUpdated=null}}class B{constructor(e,t,n){this.onUpdate=()=>{this.callback()},this.root=e,this.element=t.getRegionElement(),this.callback=n,this.handleUpdate()}handleResize(){window.addEventListener("resize",this.onUpdate)}handleUpdate(){this.element&&(this.observer=new MutationObserver(this.onUpdate),this.observer.observe(this.element,{attributes:!0}))}destroy(){window.removeEventListener("resize",this.onUpdate),this.observer.disconnect()}}const F=e=>class{constructor(e,t,n){this.onUpdate=M(()=>{this.callback()},10),this.root=e,this.element=t,this.callback=n,this.handleUpdate()}handleUpdate(){this.disposers=this._watchProperties(this.element,e,[])}destroy(){this.disposers.forEach(e=>e())}_watchProperties(e,t,n){return t.reduce((i,o)=>("string"!=typeof o?Object.keys(o).forEach(t=>{this._watchProperties(e[t],o[t],n)}):Array.isArray(e)?e.forEach(e=>this._watchProperties(e,t,n)):i.push((0,d.lB)(e,o,this.onUpdate,!0)),i),n)}},H={parent:["zoomScale","zoomingPositionX","zoomingPositionY","rotation","currentImage","containerWidth","containerHeight","canvasSize"]},V=e=>{if(!!e.from_name)return B;switch(e.type){case"richtextregion":case"paragraphs":return B;case"audioregion":return F(["bboxTriggers"]);case"rectangleregion":return F(["x","y","width","height","hidden",H]);case"ellipseregion":return F(["x","y","radiusX","radiusY","rotation","hidden",H]);case"polygonregion":return F(["hidden",{points:["x","y"]},H]);case"vectorregion":return F(["hidden","bbox",H]);case"keypointregion":return F(["x","y","hidden",H]);case"brushregion":return F(["needsUpdate","hidden","touchesLength",H]);case"timeseriesregion":return F(["start","end",{parent:["zoomedRange"]}]);default:return null}},$=(e,t)=>new z({root:t,element:e,watcher:V(e)}),W=(e,t)=>{var n;const{x:i,y:o}=null!=(n=K.getDOMBBox(t,!0))?n:{x:0,y:0};return e.boundingBox().map(e=>{const t=K.padding(e,3);return Object.assign({},t,{x:t.x-i,y:t.y-o})})},U=({x1:e,y1:t,w1:n,x2:i,y2:o,w2:s,limit:a})=>{const r=e+.5*n,l=i+.5*s,c=Math.min(t,o)-a;return{x1:r,x2:l,y1:t,y2:o,l1:Math.min(c,t-a),l2:Math.min(c,o-a),toEnd:r<l}},G=({x1:e,y1:t,w1:n,h1:i,x2:o,y2:s,w2:a,h2:r,limit:l})=>{let c,d,u,h,g,m,p="left";if(Math.min(e,o)-l<0&&(p="right"),"left"===p){c=e,u=t+.5*i,d=o,h=s+.5*r;const n=Math.min(c,d)-l;g=Math.min(n,c-l),m=Math.min(n,d-l)}else{c=e+n,u=t+.5*i,d=o+a,h=s+.5*r;const p=Math.max(c,d)+l;g=Math.max(p,c+l),m=Math.max(p,d+l)}return{x1:c,x2:d,y1:u,y2:h,l1:g,l2:m,toEnd:u<h,renderingSide:p}},Y=$,X=(e,t)=>{var n;return{id:e.id,label:(0,E.wrapArray)(null!=(n=e.labels)?n:[]).join(", "),color:"#fa541c",direction:e.direction,start:$(e.startNode,t),end:$(e.endNode,t),onChange(e){const t=M(e,50);this.start.onUpdate(t),this.end.onUpdate(t)},destroy(){this.start.destroy(),this.end.destroy()}}},q=({start:e,end:t,root:n})=>{const[i,o]=K.closestRects(W(e,n),W(t,n));return{start:i,end:o}},Z=(e,t)=>{const{x:n,y:i,width:o,height:s}=e,{x:a,y:r,width:l,height:c}=t,d=(({x1:e,y1:t,w1:n,x2:i,y2:o,w2:s})=>t!==o&&(e<=i&&i<=e+n||e<=i+s&&i+s<=e+n))({x1:n,y1:i,w1:o,x2:a,y2:r,w2:l}),u=(({x1:e,y1:t,x2:n,y2:i,l1:o,l2:s,toEnd:a,renderingSide:r},l)=>{const c="vertical"===l;let d,u,h,g,m,p,f,v,y,b,x,w,S;return c?(d=e,u=t,h=e,g=o+5,m=n+5*(a?-1:1),p=s,f=n,v=i,y=a?1:0,b=a?"5 -5":"-5 -5",x=a?"5 5":"-5 5",w=Math.min(e,n)+Math.abs(n-e)/2,S=o):c||"right"!==r?c||"left"!==r||(d=e,u=t,h=o+5,g=t,m=s,p=i+5*(a?-1:1),f=n,v=i,y=a?0:1,b=a?"-5 5":"-5 -5",x=a?"5 5":"5 -5",w=o,S=Math.min(t,i)+Math.abs(i-t)/2):(d=e,u=t,h=o-5,g=t,m=s,p=i+5*(a?-1:1),f=n,v=i,y=a?1:0,b=a?"5 5":"5 -5",x=a?"-5 5":"-5 -5",w=o,S=Math.min(t,i)+Math.abs(i-t)/2),[[`M ${d} ${u}`,`${h} ${g}`,`a 5 5 0 0 ${y} ${b}`,`L ${m} ${p}`,`a 5 5 0 0 ${y} ${x}`,`L ${f} ${v}`].join(" "),[w,S]]})((d?G:U)({x1:n,y1:i,w1:o,h1:s,x2:a,y2:r,w2:l,h2:c,limit:15}),d?"horizontal":"vertical");return u},J=W,Q="container--gJBc5",ee="commentItem--aJS6d",te="commentIcon--X3v6h",ne="commentIconBackground--EofOZ",ie="commentIconLines--uQaUg",oe="_highlighting--qltMP",se="_highlighted--Ksg1R";var ae=n(31085);const re=()=>(0,ae.jsxs)("g",{className:te,children:[(0,ae.jsx)("path",{className:ne,d:"M0 12C0 5.3726 5.3726 0 12 0C18.6274 0 24 5.3726 24 12C24 18.6274 18.6274 24 12 24H0V12Z"}),(0,ae.jsx)("path",{className:ie,d:"M18 8V9.3333H6V8H18ZM6 16H12V14.6667H6V16ZM6 12.6667H18V11.3333H6V12.6667Z"})]}),le=(0,b.PA)(({comment:e,rootRef:t})=>{var n;const i=t.current,o=null==(n=e.regionRef)?void 0:n.overlayNode,s=!o,[a,r]=(0,f.useState)({}),l=(0,f.useCallback)(()=>{e.setHighlighted(!0)},[e]),c=(0,f.useCallback)(()=>{e.setHighlighted(!1)},[e]),d=(0,f.useMemo)(()=>o&&i?Y(o,i):null,[o,i]),{shapeBBox:u,positionStyle:h}=(0,f.useMemo)(()=>{const e=d&&i?J(d,i)[0]:{x:0,y:0,width:0,height:0};return{shapeBBox:e,positionStyle:{transform:`translate(${e.x+e.width-3-4}px, ${e.y-24+3+4}px)`}}},[d,i,a]);if((0,f.useEffect)(()=>(null==d||d.onUpdate(()=>{r({})}),()=>{null==d||d.destroy()}),[d]),!i||!o||s)return null;if(u.width<1||u.height<1)return null;const g=[ee];return e.isHighlighted&&g.push(se),(0,ae.jsx)("g",{className:g.join(" "),style:h,onMouseEnter:l,onMouseLeave:c,onClick:e.scrollIntoView,children:(0,ae.jsx)(re,{})})}),ce=e=>{const{isClassificationTag:t}=e.from_name,n=e.area.classification,i=e.area.selected;return t&&(n||i)},de=(0,b.PA)(({result:e,rootRef:t})=>{const n=t.current,i=e.area,o=!i||i.hidden,[s,a]=(0,f.useState)({}),[r,l]=(0,f.useState)(!1),c=(0,f.useMemo)(()=>e&&n?Y(e,n):null,[e,n]),d=(0,f.useMemo)(()=>c&&n?J(c,n)[0]:{x:0,y:0,width:0,height:0},[c,n,s]);if((0,f.useEffect)(()=>(null==c||c.onUpdate(()=>{a({})}),()=>{null==c||c.destroy()}),[c]),!n||!i||o)return null;if(d.width<1||d.height<1)return null;const u={pointerEvents:"all",stroke:"var(--grape_600)",strokeDasharray:r?void 0:"4 2",cursor:"crosshair"};return(0,ae.jsx)("rect",Object.assign({},d,{rx:3,ry:3,style:u,onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),stroke:"red",strokeWidth:1,fill:"none",onClick:()=>{e.annotation.addLinkedResult(e),e.annotation.stopLinkingMode()}}))}),ue=(0,b.PA)(({annotation:e,commentStore:t})=>{var n;const{overlayComments:i}=t||{},o=(0,f.useRef)(),[s,a]=(0,f.useState)(I()),r=x();(0,f.useEffect)(()=>{(async()=>{await t.listComments({mounted:r,suppressClearComments:t.isRelevantList})})()},[null==(n=t.annotation)?void 0:n.id]);const l=(0,f.useMemo)(()=>{let e;return new _(t=>{cancelAnimationFrame(e),e=requestAnimationFrame(()=>{a(I())})})},[]);(0,f.useEffect)(()=>()=>{null==l||l.disconnect()},[]);const c=(0,f.useCallback)(e=>{const t=e||void 0;e?(null==l||l.observe(e),null==l||l.observe(document.body)):o.current&&(null==l||l.unobserve(o.current),null==l||l.unobserve(document.body)),o.current=t},[]);if(!i)return null;const d=[Q];return null!=t&&t.isHighlighting&&d.push(oe),(0,ae.jsx)("svg",{className:d.join(" "),ref:c,xmlns:"http://www.w3.org/2000/svg",children:(0,ae.jsxs)("g",{children:[e.linkingMode===R&&e.results.filter(ce).map(e=>(0,ae.jsx)(de,{result:e,rootRef:o},e.id)),i.map(e=>{const{id:t}=e;return(0,ae.jsx)(le,{comment:e,rootRef:o},t)})]},s)})}),he=(0,f.memo)((0,b.PA)(({tags:e,children:t})=>Array.from(e.values()).every(e=>{var t;return!!(0,u._n)(e)&&(null==(t=null==e?void 0:e.isReady)||t)},!0)?(0,ae.jsx)(ae.Fragment,{children:t}):null)),ge=(0,b.PA)(e=>{const{annotation:t}=e;return(0,ae.jsx)(he,{tags:t.names,children:(0,ae.jsx)(ue,Object.assign({},e))})});var me=n(39067);const pe="error--SXGAh";var fe=n(84411);const ve=({error:e})=>{if("string"==typeof e)return(0,ae.jsx)("div",{className:pe,dangerouslySetInnerHTML:{__html:(0,fe.sanitizeHtml)(e)}});const t=e instanceof Error?e.message:e;return(0,ae.jsx)("div",{className:pe,children:t})},ye=(0,b.WQ)("store")((0,b.PA)(({store:e,errors:t})=>(0,ae.jsx)("div",{className:"lsf-errors",children:t.map((t,n)=>(0,ae.jsx)(ve,{error:(0,u._$)(e).messages[t.error](t)},`error-${n}`))})));ye.propTypes={errors:me.PropTypes.array.isRequired};class be extends Error{constructor(e){super(e),this.name="ConfigurationError",this.sentry_skip=!0}}const xe=new class{constructor(){this.tags=[],this.customTags=[],this.models={},this.views={},this.regions=[],this.objects=[],this.areas=new Map,this.views_models={},this.tools={},this.perRegionViews={}}addTag(e,t,n){this.tags.push(e),this.models[e]=t,this.views[e]=n,this.views_models[t.name]=n}addRegionType(e,t,n){this.regions.push(e),n&&(e.detectByValue=n);const i=this.areas.get(t);i?i.push(e):this.areas.set(t,[e])}regionTypes(){return this.regions}addObjectType(e){this.objects.push(e)}objectTypes(){return this.objects}modelsArr(){return Object.values(this.models)}getViewByModel(e){const t=this.views_models[e];if(!t)throw new Error(`No view for model: ${e}`);return t}getViewByTag(e){return this.views[e]}getAvailableAreas(e,t){const n=this.areas.get(e);if(!n)return[];if(t)for(const e of n)if(e.detectByValue&&e.detectByValue(t))return[e];return n.filter(e=>!e.detectByValue)}getTool(e){const t=this.tools[e];if(!t){const t=Object.keys(this.tools);throw new Error(`No model registered for tool: ${e}\nAvailable models:\n\t${t.join("\n\t")}`)}return t}getModelByTag(e){const t=this.models[e];if(!t){const t=Object.keys(this.models);throw new be(`No model registered for tag: ${e}\nAvailable models:\n\t${t.join("\n\t")}`)}return t}addPerRegionView(e,t,n){const i=this.perRegionViews[e]||{};i[t]=n,this.perRegionViews[e]=i}getPerRegionView(e,t){var n;return null==(n=this.perRegionViews[e])?void 0:n[t]}addCustomTag(e,t){this.addTag(e.toLowerCase(),t.model,t.view),t.isObject&&this.addObjectType(t.model),t.region&&this.addRegionType(t.region,t.model.name,t.detector),this.customTags.push(t)}};xe.getTool=xe.getTool.bind(xe),xe.getModelByTag=xe.getModelByTag.bind(xe);const we=xe;var Se=n(73033);const Ce={range:(e=0,t=1)=>u.gK.custom({name:`Range(${e}..${t})`,fromSnapshot:e=>Number.parseFloat(e),toSnapshot:e=>e.toString(),isTargetType(n){const i=Number.parseFloat(n);return e<=i&&i<=t},getValidationMessage(n){return this.isTargetType(n)?"":`Value ${n} is outside of range ${e}..${t}.`}}),color:u.gK.custom({name:"CSSColor",fromSnapshot:e=>String(e),toSnapshot:e=>e.toString(),isTargetType(e){const t=(new Option).style;return t.color=e,""!==t.color},getValidationMessage(e){return this.isTargetType(e)?"":`Value ${e} doesn't appear to be a valid HEX color.`}})};function ke(e){return t=>u.gK.maybeNull(u.gK.array(e(t)))}function Pe(e,t){return n=>u.gK.union({dispatcher:i=>{if(n.find(e=>i.type===e))return e(i.type);throw new be(t+i.type)}})}const Re=Pe(we.getModelByTag,"Not expecting tag: ");const je={unionArray:function(e){const t=u.gK.maybeNull(u.gK.array(Re(e)));return t.value=e,t},allModelsTypes:function(){const e=[{dispatcher:e=>{if(!e)return u.gK.literal(void 0);if(we.tags.includes(e.type))return we.getModelByTag(e.type);throw new be(`Not expecting tag: ${e.type}`)}},we.modelsArr()],t=[].concat.apply([],e);return u.gK.union.apply(null,t)},unionTag:function(e){return u.gK.maybeNull(u.gK.enumeration("unionTag",e))},tagsTypes:function(e){const t=u.gK.frozen(e.map(e=>e.toLowerCase()));return t.describe=()=>`(${e.join("|")})`,t.value=e,t},isType:function(e,t){const n=(0,u.Pw)(e);for(const e of t)if(n===e)return!0;return!1},getParentOfTypeString:function(e,t){if((0,u.jX)(e))return null;let n=(0,u.PA)(e);for(Array.isArray(t)||(t=[t]);n;){const e=(0,u.Pw)(n).name;if(t.find(t=>t===e))return n;n=(0,u.jX)(n)?null:(0,u.PA)(n)}return null},getParentTagOfTypeString:function(e,t){let n=(0,u.PA)(e);for(Array.isArray(t)||(t=[t]);n;){const e=n.type;if(t.find(t=>t===e))return n;n=(0,u.jX)(n)?null:(0,u.PA)(n)}return null},tagsArray:ke(Re),toolsArray:ke(Pe(we.getTool,"Not expecting tool: "))};var Ne=n(84826);const Te=u.gK.model("AnnotationMixin",{}).views(e=>({get annotation(){var t;if((0,Ne.VS)(Ne.F5)&&!window.STORE_INIT_OK&&console.error("LSF: annotation accessed before store is initialized",e),!(0,u._n)(e))return null;if((0,Ne.VS)(Ne.cE)){var n;const t=(0,u.Zn)(e);return t===e?e.control?e.control.annotation:e.obj?e.obj.annotation:null:null!=(n=t.annotationStore)&&n.selectedHistory?t.annotationStore.selectedHistory:je.getParentOfTypeString(e,"Annotation")}const i=e.annotationStore;return null!=(t=null==i?void 0:i.selectedHistory)?t:null==i?void 0:i.selected},get annotationOrHistoryItem(){var t;return null!=(t=je.getParentOfTypeString(e,"Annotation"))?t:je.getParentOfTypeString(e,"HistoryItem")},get annotationStore(){const t=(0,u.Zn)(e);return t===e?e.control?(0,u.Zn)(e.control).annotationStore:e.obj?(0,u.Zn)(e.obj).annotationStore:null:t.annotationStore}})),_e=u.gK.model({}).volatile(()=>({_isReady:!0})).views(e=>({get isReady(){return e._isReady}})).actions(e=>({setReady(t){e._isReady=t}})),Ae=_e,Ie=_e.views(e=>({get isReady(){var t;return e._isReady&&!(null!=(t=e.regs)&&t.filter(e=>!e.isReady).length)}}));var Me=n(41880),Ee=n.n(Me),Ke=n(46123),De=n.n(Ke);const Oe=(e,t)=>{var n;const i=/\$[\w[\].{}]+/gi;return e?(null==(n=e.match(i))?void 0:n[0])===e?null!=(o=De()(t,e.slice(1)))?o:"":e.replace(i,e=>{var n;return De()(t,null!=(n=e.slice(1))?n:"")}):"";var o},Le=e=>{var t;const[,n,i]=null!=(t=e.match(/^(\w+)(.)?/))?t:[],o={};if(i){e.split(i).slice(1).forEach(e=>{const[t,n]=e.split("=",2);o[t]=null==n||n})}return{type:n,sep:i,options:o}},ze={csv(e,t={}){const n=!t.headless,{data:i,meta:{fields:o}}=Ee().parse(e,{delimiter:t.separator,header:n}),{column:s=(n?o[0]:0)}=t,a=i[0];let r=a[s];var l;void 0===r&&(r=a[null!=(l=o[s])?l:o[0]]);return String(null!=r?r:"")}},Be=u.gK.model({resolver:u.gK.maybeNull(u.gK.string)}).actions(e=>({updateLocalValue(t){e._value=t},updateValue(t){var n,i;e._value=Oe(e.value,null!=(n=null==t||null==(i=t.task)?void 0:i.dataObj)?n:{})},resolveValue:(0,u.L3)(function*(t){if(!e.resolver)return t;const{type:n,options:i}=Le(e.resolver);if(!Object.prototype.hasOwnProperty.call(ze,n))return console.error(`Resolver "${null!=n?n:e.resolver}" looks unfamiliar`),t;const o=yield fetch(t),s=yield o.text();return ze[n](s,i)})})),Fe=Be;var He=n(37);const Ve=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING);class $e{constructor(){this.syncTargets=new Map,this.locked=null,this.audioTags=0,this.bufferingOrigins=new Set}get isBuffering(){return!!Ve&&this.bufferingOrigins.size>0}isBufferingOrigin(e){return this.bufferingOrigins.has(e)}register(e){this.syncTargets.set(e.name,e),"audio"===e.type&&(this.audioTags+=1)}unregister(e){this.syncTargets.delete(e.name),"audio"===e.type&&(this.audioTags-=1)}isLockable(e){return!Ve||"buffering"!==e&&(!this.isBuffering||!["play","pause"].includes(e))}sync(e,t,n){"buffering"===t&&(e.buffering?this.bufferingOrigins.add(n):this.bufferingOrigins.delete(n));const i=!this.isLockable(t);if(!i&&this.locked&&this.locked!==n||console.log("SYNC",{event:t,locked:this.locked,data:e,origin:n}),!i){if(this.locked&&this.locked!==n)return!1;this.locked||setTimeout(()=>this.locked=null,100),this.locked=n}for(const i of this.syncTargets.values())n!==i.name&&i.syncReceive(e,t);return!0}}const We={managers:new Map,get(e,t){let n=this.managers.get(e);return!n&&t&&(n=this.managers.get(t)),n||(n=new $e,this.managers.set(e,n)),n}},Ue=u.gK.model("SyncableMixin",{name:u.gK.string,type:u.gK.string,sync:u.gK.optional(u.gK.string,"")}).volatile(()=>({syncHandlers:new Map,syncManager:null,isBuffering:!1,wasPlayingBeforeBuffering:!1})).actions(()=>({syncMuted(e){}})).actions(e=>({afterCreate(){if(!e.sync)return;let t=e.sync,n=e.name;if(He.ff.isActive(Ne.cE)){var i;if(!e.annotationStore.initialized)return;const o=`@${null==(i=e.annotationOrHistoryItem)?void 0:i.id}`;t+=o,n+=o}e.syncManager=We.get(t,n),e.syncManager.register(e),e.registerSyncHandlers()},registerSyncHandlers(){},syncSend(t,n){if(!e.sync)return;e.syncManager.sync(t,n,e.name)&&"play"===n&&e.syncMuted("audio"!==e.type&&e.syncManager.audioTags>0)},syncReceive(t,n){const i=e.syncHandlers.get(n);"play"===n&&e.syncMuted("audio"!==e.type),i&&i(t,n)},destroy(){e.syncManager.unregister(e)}})),Ge=u.gK.model({meta:u.gK.frozen({})}).actions(e=>({setMetaText(t){if(t)e.meta=Object.assign({},e.meta,{text:[t]});else{const t=Object.assign({},e.meta);delete t.text,e.meta=t}}})).actions(e=>({deleteMetaText(){e.setMetaText("")}})),Ye=u.gK.model("ReadOnlyControlMixin",{}).views(e=>({isReadOnly(){var t,n;return(null==(t=e.result)?void 0:t.isReadOnly())||(null==(n=e.annotation)?void 0:n.isReadOnly())}})),Xe=u.gK.model("ReadOnlyRegionMixin",{readonly:u.gK.optional(u.gK.boolean,!1)}).views(e=>({isReadOnly(){var t;return!!(0,u._n)(e)&&(e.locked||e.readonly||e.annotation.isReadOnly()||e.parent&&((null==e.parent.isReadOnly?void 0:e.parent.isReadOnly())||(null==(t=e.parent.result)||null==t.isReadOnly?void 0:t.isReadOnly())))}})),qe=u.gK.model({pid:u.gK.optional(u.gK.string,I),score:u.gK.maybeNull(u.gK.number),filtered:u.gK.optional(u.gK.boolean,!1),parentID:u.gK.optional(u.gK.string,""),fromSuggestion:!1,dynamic:!1,origin:u.gK.optional(u.gK.enumeration(["prediction","prediction-changed","manual"]),"manual"),item_index:u.gK.maybeNull(u.gK.number)}).volatile(()=>({_highlighted:!1,hidden:!1,locked:!1,isDrawing:!1,perRegionFocusRequest:null,shapeRef:null,drawingTimeout:null,hideable:!0})).views(e=>({get perRegionStates(){const t=e.states;return t&&t.filter(e=>!0===e.perregion)},get store(){return(0,u.Zn)(e)},get parent(){return(0,u.PA)(e)},get editable(){throw new Error("Not implemented")},get isCompleted(){return!e.isDrawing},get highlighted(){return e._highlighted},get inSelection(){var t;return null==(t=e.annotation)?void 0:t.regionStore.isSelected(e)},get isReady(){return!0},get currentImageEntity(){var t;return e.parent.findImageEntity(null!=(t=e.item_index)?t:0)},getConnectedDynamicRegions(t){var n;const{regions:i=[]}=(null==(n=(0,u.Zn)(e).annotationStore)?void 0:n.selected)||{},{type:o,labelName:s}=e;return i.filter(n=>{var i,a;if(t&&n===e)return!1;return(!e.supportSuggestions||e.dynamic)&&n.type===o&&n.labelName===s&&(null==(i=n.results)||null==(i=i[0])?void 0:i.to_name)===(null==(a=e.results)||null==(a=a[0])?void 0:a.to_name)})},get isRealRegion(){var t;return null==(t=e.annotation)||null==(t=t.areas)?void 0:t.has(e.id)},get shouldNotifyDrawingFinished(){if(!e.isRealRegion)return!1;if(e.annotation.isSuggestionsAccepting)return!1;const t=!e.supportSuggestions||e.dynamic&&!e.fromSuggestion;return e.results.some(e=>e.from_name.smartEnabled)&&t}})).actions(e=>({setParentID(t){e.parentID=t},setDrawing(t){e.isDrawing=t},setShapeRef(t){t&&(e.shapeRef=t)},setItemIndex(t){if(!(0,E.isDefined)(t))throw new Error("Index must be provided for",e);e.item_index=t},beforeDestroy(){if(e.isRealRegion)return e.beforeDestroyArea()},beforeDestroyArea(){e.notifyDrawingFinished({destroy:!0})},setLocked(t){e.locked=t instanceof Function?t(e.locked):t},makeDynamic(){e.dynamic=!0},updateAppearenceFromState(){},serialize(){console.error("Region class needs to implement serialize")},selectRegion(){},afterUnselectRegion(){},onClickRegion(t){const n=e.annotation;(e.isReadOnly()||!e.isDrawing&&!n.isDrawing)&&(!e.isReadOnly()&&n.isLinkingMode?(n.addLinkedRegion(e),n.stopLinkingMode(),n.regionStore.unselectAll()):e._selectArea((null==t?void 0:t.ctrlKey)||(null==t?void 0:t.metaKey)))},_selectArea(t=!1){this.cancelPerRegionFocus();const n=e.annotation;if(t)n.toggleRegionSelection(e);else{!e.selected?n.selectArea(e):n.unselectAll()}},requestPerRegionFocus(){e.perRegionFocusRequest=Date.now()},cancelPerRegionFocus(){e.perRegionFocusRequest=null},setHighlight(t){e._highlighted=t},toggleHighlight(){e.setHighlight(!e._highlighted)},toggleFiltered(t){e.filtered=!e.filtered,e.toggleHidden(t,!0),t&&t.stopPropagation()},toggleHidden(t,n=!1){n||(e.filtered=!1),e.hidden=!e.hidden,t&&t.stopPropagation()},updateOriginOnEdit(){"prediction"===e.origin&&(e.origin="prediction-changed")},notifyDrawingFinished({destroy:t=!1}={}){if(e.updateOriginOnEdit(),e.shouldNotifyDrawingFinished&&(clearTimeout(e.drawingTimeout),!1===e.isDrawing)){const n=(0,u.Pw)(e).name.match(/brush/i)?1200:0,i=(0,u._$)(e);e.drawingTimeout=setTimeout(()=>{const n=e.getConnectedDynamicRegions(t);i.events.invoke("regionFinishedDrawing",e,n)},n)}}})),Ze=u.gK.compose(qe,Xe,Te),Je="skip",Qe="stop";const et=(e,t,n)=>{!function e(i){if(void 0===i.attributes)return;const o=Array.from(i.attributes).map(e=>e.name);for(const e of o){var s;const o=i.getAttribute(e);i.setAttribute(e,null!=(s=null==o||null==o.replace?void 0:o.replace(n,`${t}`))?s:"")}i.childNodes.forEach(t=>e(t))}(e)};function tt(e,t,n){var i,o;const s=function(e,t){const n={};if(!e)return n;for(const i of e.attributes){const{name:e,value:o}=i;if("value"!==e&&["true","false"].includes(o))n[e.toLowerCase()]="true"===o;else if(t){let i=o;for(const[e,n]of Object.entries(t))i=i.replace(e,n);n[e.toLowerCase()]=i}else n[e.toLowerCase()]=o}return n}(e,n),a=e.tagName.toLowerCase(),r=null!=(i=s.indexflag)?i:"{{idx}}",l=(0,Ne.VS)(Ne.cE)&&null!=(o=e.getAttribute("name"))?o:I(),c=Object.assign({},s,{id:l,tagName:e.tagName,type:a});if("repeater"===a){const i=Oe(s.on,t)||[],o=[];for(let s=0;s<i.length;s++){const i=Object.assign({},n,{[r]:s}),a={id:I(),tagName:"View",type:"view",children:[...e.children].map(e=>{const n=e.cloneNode(!0);return et(n,s,r),tt(n,t,i)})};o.push(a)}c.tagName="View","pagination"===s.mode?c.type="pagedview":c.type="view",c.children=o}else if(!e.childNodes.length||e.children.length&&"hypertext"!==a)e.children.length&&(c.children=[...e.children].map(e=>tt(e,t)));else{var d;c.value=(null==(d=e.innerHTML)?void 0:d.trim())||c.value||""}return c}function nt(e,t,n=!0){var i;let o=e;if((0,Ne.VS)(Ne.cE)){var s;if(!t)return null;o=t.ids.get(ot(null!=(s=e.id)?s:e.name))||o}var a;if(!o)return console.error(`Can't find element ${null!=(a=e.id)?a:e.name} in annotation ${null==t?void 0:t.id}`),null;const r=(0,u.Pw)(o),l=r.identifierAttribute,c=r.name,d=we.getViewByModel(c),h=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&(null==t||null==(i=t.store)?void 0:i.hasInterface("annotation:bulk")),g=!0!==o.isIndependent;if(h&&g)return null;if(!d)throw new Error(`No view for model: ${c}`);const m=l&&o[l]||I();return(0,ae.jsx)(d,{item:o},n?m:void 0)}function it(e,t){const n=e=>{const i=t(e);if(i!==Je){if(i===Qe)return Qe;if(e.children)for(const t of e.children){if(n(t)===Qe)return Qe}}};n(e)}const ot=e=>e.replace(/@.*/,"");const st={renderItem:nt,renderChildren:function(e,t){return e&&e.children&&e.children.length?e.children.map(e=>nt(e,t)):null},treeToModel:function(e,t){var n,i,o;const s=(new DOMParser).parseFromString(e,"application/xml"),a=null==s||null==(n=s.children)?void 0:n[0],r=function(e){var t;let n=null==e||null==(t=e.children)?void 0:t[0];for(let e=0;e<3;e++){var i,o;if("parsererror"===(null==(i=n)?void 0:i.tagName))return n.textContent;n=null==(o=n)||null==(o=o.children)?void 0:o[0]}}(s);if(r)throw new Error(r);return tt(a,null!=(i=null==(o=t.task)?void 0:o.dataObj)?i:{})},findParentOfType:function(e,t){for(const n of t)try{const t=(0,u.k2)(e,n);if(t)return t}catch(e){console.error(e)}return null},filterChildrenOfType:function(e,t){const n=[],i=Array.isArray(t)?t:[t];return it(e,e=>{for(const t of i)(0,u.Pw)(e).name===t&&n.push(e)}),n},cssConverter:function(e){if(!e)return null;const t={},n=e.split(";");let i,o,s,a;for(o=0;o<n.length;o++){if(i=n[o].indexOf(":"),s=n[o].substring(0,i),a=n[o].substring(i+1),s=s.replace(/ /g,""),s.length<1)continue;" "===a[0]&&(a=a.substring(1))," "===a[a.length-1]&&(a=a.substring(0,a.length-1));t[s.replace(/(-.)/g,e=>e[1].toUpperCase())]=a}return t},traverseTree:it,extractNames:function(e){const t=[],n=new Map,i=new Map,o=we.objectTypes().map(e=>e.name.replace("Model","").toLowerCase());return it(e,e=>{e.name&&(n.set(ot(e.name),e),o.includes(e.type)&&t.push(ot(e.name)))}),it(e,e=>{if(e.name&&!o.includes(e.type)&&!e.toname&&1===t.length&&(e.toname=t[0]),e&&e.toname){const t=i.get(e.toname);t?t.push(n.get(ot(e.name))):i.set(e.toname,[n.get(ot(e.name))])}}),{names:n,toNames:i}},cleanUpId:ot},at=["labels","hypertextlabels","paragraphlabels","rectangle","keypoint","polygon","brush","bitmask","ellipse","magicwand","rectanglelabels","keypointlabels","polygonlabels","vector","vectorlabels","brushlabels","bitmasklabels","ellipselabels","timeserieslabels","timelinelabels","choices","datetime","number","taxonomy","textarea","rating","pairwise","videorectangle","ranker"],rt={ranker:u.gK.union(u.gK.array(u.gK.string),u.gK.frozen(),u.gK.null),datetime:u.gK.maybe(u.gK.string),number:u.gK.maybe(u.gK.number),rating:u.gK.maybe(u.gK.number),item_index:u.gK.maybeNull(u.gK.number),text:u.gK.maybe(u.gK.union(u.gK.string,u.gK.array(u.gK.string))),choices:u.gK.maybe(u.gK.array(u.gK.union(u.gK.string,u.gK.array(u.gK.string)))),selected:u.gK.maybe(u.gK.enumeration(["left","right"])),labels:u.gK.maybe(u.gK.array(u.gK.string)),htmllabels:u.gK.maybe(u.gK.array(u.gK.string)),hypertextlabels:u.gK.maybe(u.gK.array(u.gK.string)),paragraphlabels:u.gK.maybe(u.gK.array(u.gK.string)),rectanglelabels:u.gK.maybe(u.gK.array(u.gK.string)),keypointlabels:u.gK.maybe(u.gK.array(u.gK.string)),polygonlabels:u.gK.maybe(u.gK.array(u.gK.string)),vectorlabels:u.gK.maybe(u.gK.array(u.gK.string)),ellipselabels:u.gK.maybe(u.gK.array(u.gK.string)),brushlabels:u.gK.maybe(u.gK.array(u.gK.string)),timeserieslabels:u.gK.maybe(u.gK.array(u.gK.string)),timelinelabels:u.gK.maybe(u.gK.array(u.gK.string)),bitmasklabels:u.gK.maybe(u.gK.array(u.gK.string)),taxonomy:u.gK.frozen(),sequence:u.gK.frozen()},lt=u.gK.model("Result",{id:u.gK.optional(u.gK.identifier,I),score:u.gK.maybeNull(u.gK.number),readonly:u.gK.optional(u.gK.boolean,!1),from_name:u.gK.late(()=>u.gK.reference(u.gK.union(...we.modelsArr()))),to_name:u.gK.late(()=>u.gK.reference(u.gK.union(...we.objectTypes()))),type:He.ff.isActive(He.ff.FF_CUSTOM_TAGS)?u.gK.late(()=>u.gK.enumeration([...at,...we.customTags.filter(e=>e.resultName).map(e=>e.resultName)])):u.gK.enumeration([...at]),value:He.ff.isActive(He.ff.FF_CUSTOM_TAGS)?u.gK.late(()=>u.gK.model(Object.assign({},rt,Object.fromEntries(we.customTags.filter(e=>e.resultName).map(e=>[e.resultName,u.gK.maybe(e.result)]))))):u.gK.model(Object.assign({},rt)),meta:u.gK.frozen()}).views(e=>({get perRegionStates(){const t=e.states;return t&&t.filter(e=>!0===e.perregion)},get store(){return(0,u.Zn)(e)},get area(){return(0,u.PA)(e,2)},get mainValue(){return e.value[e.from_name.valueType]},mergeMainValue(t){var n,i,o;t=null!=(n=t)&&n.toJSON?t.toJSON():t;const s=null!=(i=e.mainValue)&&null!=i.toJSON&&i.toJSON()?null==(o=e.mainValue)||null==o.toJSON?void 0:o.toJSON():e.mainValue;return typeof t!=typeof s?null:e.type.endsWith("labels")?t.filter(e=>s.includes(e)):t===s?t:null},get hasValue(){const t=e.mainValue;return!!(0,E.isDefined)(t)&&(!Array.isArray(t)||t.length>0)},get editable(){throw new Error("Not implemented")},isReadOnly:()=>e.readonly||e.area.isReadOnly(),isSelfReadOnly:()=>e.readonly,getSelectedString(t=" "){var n;return(null==(n=e.mainValue)?void 0:n.join(t))||""},get selectedLabels(){var t,n,i;return 0===(null==(t=e.mainValue)?void 0:t.length)&&e.from_name.allowempty?e.from_name.findLabel(null):null!=(n=null==(i=e.mainValue)?void 0:i.map(t=>e.from_name.findLabel(t)).filter(Boolean))?n:[]},get canBeSubmitted(){const t=e.from_name;if(t.perregion){const n=t.whenlabelvalue;if(n&&!e.area.hasLabel(n))return!1}const n=e=>e.map(e=>Array.isArray(e)?e.at(-1):e),i=()=>{var i,o;const s=t.whentagname,a=null!=(i=null==(o=t.whenchoicevalue)?void 0:o.split(","))?i:null,r=e.annotation.results.filter(t=>["choices","taxonomy"].includes(t.type)&&t!==e);if(s){const t=r.find(t=>t.from_name.name===s&&(!t.from_name.perregion||t.area===e.area));if(!t)return!1;if(a&&!a.some(e=>n(t.mainValue).some(n=>t.from_name.selectedChoicesMatch(e,n))))return!1}else{if(!r.length)return!1;if(a&&!r.some(e=>a.some(t=>n(e.mainValue).some(n=>e.from_name.selectedChoicesMatch(t,n)))))return!1}return!0};return t.perregion&&"choice-selected"===t.visiblewhen?i():"choice-unselected"===t.visiblewhen?!i():!(!t.perregion&&function(e,t){let n=e;for(;n;){if(n.visiblewhen===t)return n;try{if(n=(0,u.PA)(n),!n)break}catch(e){break}}return null}(t,"choice-selected"))||!1!==t.isVisible&&i()},get tag(){const t=e.mainValue;return t&&t.length&&e.from_name.findLabel?e.from_name.findLabel(t[0]):null},get style(){var t;if(!e.tag)return null;const n=e.tag.background||(null==(t=e.tag.parent)?void 0:t.fillcolor);if(!n)return null;const i=e.tag.background||e.tag.parent.strokecolor,{strokewidth:o,fillopacity:s,opacity:a}=e.tag.parent;return{strokecolor:i,strokewidth:o,fillcolor:n,fillopacity:s,opacity:a}},get emptyStyle(){const t=e.from_name.emptyLabel;if(!t)return null;const n=t.background||t.parent.fillcolor;if(!n)return null;const i=t.background||t.parent.strokecolor,{strokewidth:o,fillopacity:s,opacity:a}=t.parent;return{strokecolor:i,strokewidth:o,fillcolor:n,fillopacity:s,opacity:a}},get controlStyle(){if(!e.from_name)return null;const{fillcolor:t,strokecolor:n,strokewidth:i,fillopacity:o,opacity:s}=e.from_name;return{strokecolor:n,strokewidth:i,fillcolor:t,fillopacity:o,opacity:s}},getRegionElement(){var t;return null==(t=e.from_name)||null==t.getRegionElement?void 0:t.getRegionElement()}})).volatile(()=>({pid:"",selected:!1})).actions(e=>({setValue(t){e.value[e.from_name.valueType]=t},afterCreate(){e.pid=e.id},afterAttach(){},setParentID(t){e.parentID=t},setMetaValue(t,n){e.meta=Object.assign({},e.meta,{[t]:n})},updateAppearenceFromState(){},serialize(t){var n;const i=(0,u.dV)(e),{type:o,score:s,value:a,meta:r}=i,{valueType:l}=e.from_name,c=e.area?e.area.serialize(t):{},d=null==(n=e.area)?void 0:n.cleanId,h=st.cleanUpId(i.from_name),g=st.cleanUpId(i.to_name);if(!c)return null;if(!e.canBeSubmitted)return null;if((0,E.isDefined)(c.value)||(c.value={}),e.to_name.mergeLabelsAndResults){var m;if("labels"===o)return null;o.endsWith("labels")||null==(m=e.area)||null==(m=m.labels)||!m.length||e.from_name.perregion||(c.value.labels=e.area.labels)}return(r||e.area.meta&&Object.keys(e.area.meta).length)&&(c.meta=Object.assign({},r,e.area.meta)),e.area.parentID&&(c.parentID=e.area.parentID.replace(/#.*/,"")),Object.assign(c,{id:d,from_name:h,to_name:g,type:o,origin:e.area.origin}),(0,E.isDefined)(a[l])&&Object.assign(c.value,{[l]:a[l]}),"number"==typeof s&&(c.score=s),e.isSelfReadOnly()&&(c.readonly=!0),(0,Ne.VS)(Ne.gF)&&(0,E.isDefined)(e.area.item_index)&&(c.item_index=e.area.item_index),c},setHighlight(t){e._highlighted=t},toggleHighlight(){e.setHighlight(!e._highlighted)},toggleHidden(){e.hidden=!e.hidden}})),ct=u.gK.compose("Result",lt,Te),dt={TAG:"tag",REGION_LIST:"region-list"},ut=u.gK.model({perregion:u.gK.optional(u.gK.boolean,!1),whenlabelvalue:u.gK.maybeNull(u.gK.string),displaymode:u.gK.optional(u.gK.enumeration(Object.values(dt)),dt.TAG)}).extend(e=>{if(!0!==e.isClassificationTag)throw new Error("The PerRegionMixin mixin should be used only for classification control-tags");return{}}).volatile(()=>({focusable:!1})).views(e=>({get perRegionArea(){return e.perregion?e.annotation.highlightedNode:null},get _perRegionResult(){const t=e.perRegionArea;return t?e.annotation.results.find(n=>n.from_name===e&&n.area===t):null},perRegionVisible(){if(!e.perregion)return!0;const t=e.perRegionArea;return!!t&&(t.parent.name===e.toname&&(null===e.whenlabelvalue||void 0===e.whenlabelvalue||t.hasLabel(e.whenlabelvalue)))}})).actions(e=>({_validatePerRegion(){const t=e.toNameTag;for(const i of t.allRegs){var n;const t=null==(n=i.results.find(t=>t.from_name===e))?void 0:n.mainValue;if(!e.validateValue(t))return e.annotation.selectArea(i),!1}return!0},createPerRegionResult(){var t;null==(t=e.perRegionArea)||t.setValue(e)}}));let ht=1;const gt=u.gK.model({id:u.gK.optional(u.gK.identifier,I),ouid:u.gK.optional(u.gK.number,()=>ht++),results:u.gK.array(ct),parentID:u.gK.maybeNull(u.gK.string)}).views(e=>({get cleanId(){return e.id.replace(/#.*/,"")},get labelings(){return e.results.filter(e=>e.from_name.isLabeling)},get labeling(){if((0,u._n)(e))return e.results.find(e=>e.from_name.isLabeling&&e.hasValue)},get emptyLabel(){var t;return null==(t=e.results.find(e=>{var t;return null==(t=e.from_name)?void 0:t.emptyLabel}))||null==(t=t.from_name)?void 0:t.emptyLabel},get texting(){return(0,u._n)(e)&&e.results.find(e=>"textarea"===e.type&&e.hasValue)},get tag(){var t;return null==(t=e.labeling)?void 0:t.from_name},hasLabel(t){var n;const i=null==(n=e.labeling)?void 0:n.mainValue;return!(!i||!t)&&(!!i.includes(t)||!!t.includes(",")&&t.split(",").some(e=>i.includes(e)))},get perRegionTags(){var t;return(null==(t=e.annotation.toNames.get(e.object.name))?void 0:t.filter(e=>e.perregion))||[]},get labelingTags(){var t;return(0,Ne.VS)(Ne.um)&&(null==(t=e.annotation.toNames.get(e.object.name))?void 0:t.filter(e=>e.classification&&e.isLabeling))||[]},get perRegionDescControls(){return e.perRegionTags.filter(e=>e.displaymode===dt.REGION_LIST)},get perRegionFocusTarget(){return e.perRegionTags.find(e=>!1!==e.isVisible&&e.focusable)},get labelName(){var t,n;if((0,u._n)(e))return(null==(t=e.labeling)||null==(t=t.mainValue)?void 0:t[0])||(null==(n=e.emptyLabel)?void 0:n._value)},get labels(){var t,n;return Array.from(null!=(t=null==(n=e.labeling)?void 0:n.mainValue)?t:[])},getLabelText(t){var n;const i=e.region_index,o=e.labeling,s=null==(n=e.texting)||null==(n=n.mainValue)||null==(n=n[0])?void 0:n.replace(/\n\r|\n/," "),a=null==o?void 0:o.getSelectedString(t),r=[];return i&&r.push(String(i)),a&&r.push(a),s&&r.push(s),r.join(": ")},get parent(){if((0,u._n)(e))return e.object},get style(){if(!(0,u._n)(e))return;const t=e.results.find(e=>e.style);if(t&&t.style)return t.style;const n=e.results.find(e=>e.emptyStyle);if(n&&n.emptyStyle)return n.emptyStyle;const i=e.results.find(t=>e.type.startsWith(t.type));return i&&i.controlStyle},get selected(){var t;return(null==(t=e.annotation)?void 0:t.highlightedNode)===e},getOneColor:()=>(e.style||w.l).fillcolor,get highlighted(){var t;return null!=(t=e.parent)&&null!=(t=t.selectionArea)&&t.isActive?e.isInSelectionArea:e._highlighted},get isInSelectionArea(){var t;return!((0,Ne.VS)(Ne.q$)&&e.hidden||null==(t=e.parent)||null==(t=t.selectionArea)||!t.isActive)&&e.parent.selectionArea.intersectsBbox(e.bboxCoords)},get supportSuggestions(){return e.object.supportSuggestions},get region_index(){var t;return e.isRealRegion&&(null==(t=e.annotation)?void 0:t.regionStore.regionIndexMap[e.id])||null}})).actions(e=>({beforeDestroy(){var t;e.results.forEach(e=>(0,u.zr)(e)),null==(t=e.annotation)||null==t.updateAppearenceFromState||t.updateAppearenceFromState()},setSelected(t){e.selected=t},deleteRegion(){e.annotation.isReadOnly()||e.isReadOnly()||(e.selected&&e.annotation.unselectAll(!0),e.destroyRegion&&e.destroyRegion(),e.annotation.deleteRegion(e))},addResult(t){e.results.push(t)},applyAdditionalDataFromResult(e){},removeResult(t){const n=e.results.indexOf(t);n<0||(e.results.splice(n,1),(0,u.zr)(t),e.results.length||e.annotation.deleteArea(e))},setValue(t){const n=e.results.find(e=>e.from_name===t),i=t.selectedValues();n?t.holdsState?n.setValue(i):e.removeResult(n):e.results.push({area:e,from_name:t,to_name:e.object,type:t.resultType,value:{[t.valueType]:i}}),e.updateAppearenceFromState&&e.updateAppearenceFromState()}})),mt=u.gK.compose("AreaMixin",gt,Xe);var pt=n(72902),ft=n(21091);const vt=(()=>{const e={};return e.floodFill=(e,t,n,i,o)=>{let s,a,r,l,c,d,u,h,g,m;const p=e.data,f=e.width,v=e.height,y=e.bytes;let b=-1,x=f+1,w=-1,S=v+1,C=n*f+t;const k=new Uint8Array(f*v),P=new Uint8Array(o||f*v);if(1===P[C])return null;C*=y;const R=[p[C],p[C+1],p[C+2],p[C+3]],j=[{y:n,left:t-1,right:t+1,dir:1}];do{for(l=j.shift(),m=!1,a=l.left+1;a<l.right;a++)if(u=l.y*f,C=(u+a)*y,1!==P[u+a]&&(s=p[C]-R[0],!(s>i||s<-i||(s=p[C+1]-R[1],s>i||s<-i||(s=p[C+2]-R[2],s>i||s<-i))))){for(m=!0,k[u+a]=1,P[u+a]=1,d=a-1;!(!(d>-1&&(h=u+d,C=h*y,1!==P[h]))||(s=p[C]-R[0],s>i||s<-i)||(s=p[C+1]-R[1],s>i||s<-i)||(s=p[C+2]-R[2],s>i||s<-i));)k[h]=1,P[h]=1,d--;for(c=a+1;!(!(c<f&&(g=u+c,C=g*y,1!==P[g]))||(s=p[C]-R[0],s>i||s<-i)||(s=p[C+1]-R[1],s>i||s<-i)||(s=p[C+2]-R[2],s>i||s<-i));)k[g]=1,P[g]=1,c++;d<x&&(x=d+1),c>b&&(b=c-1),r=l.y-l.dir,r>=0&&r<v&&(d<l.left&&j.push({y:r,left:d,right:l.left,dir:-l.dir}),l.right<c&&j.push({y:r,left:l.right,right:c,dir:-l.dir})),r=l.y+l.dir,r>=0&&r<v&&d<c&&j.push({y:r,left:d,right:c,dir:l.dir})}m&&(l.y<S&&(S=l.y),l.y>w&&(w=l.y))}while(j.length>0);return{data:k,width:e.width,height:e.height,bounds:{minX:x,minY:S,maxX:b,maxY:w}}},e.gaussBlur=(e,t)=>{let n,i,o,s,a,r,l,c;const d=2*t+1,u=t*t,h=new Float32Array(d);let g=0;const m=e.width,p=e.height,f=e.data,v=e.bounds.minX,y=e.bounds.maxX,b=e.bounds.minY,x=e.bounds.maxY;for(n=0;n<t;n++){const e=(t-n)*(t-n),i=Math.exp(-e/(2*u))/(2*Math.PI*u);h[t+n]=h[t-n]=i,g+=2*i}for(n=0;n<d;n++)h[n]/=g;const w=new Uint8Array(m*p),S=t+m,C=t+p;for(a=b;a<x+1;a++)for(s=v;s<y+1;s++){for(r=0,i=a*m+s,l=t-s>0?t-s:0,c=S-s<d?S-s:d,o=i-t,n=l;n<c;n++)r+=f[o+n]*h[n];for(l=t-a>0?t-a:0,c=C-a<d?C-a:d,o=i-t*m,n=l;n<c;n++)r+=f[o+n*m]*h[n];w[i]=r>.5?1:0}return{data:w,width:m,height:p,bounds:{minX:v,minY:b,maxX:y,maxY:x}}},e.gaussBlurOnlyBorder=(e,t,n)=>{const i=function(e,t,n){let i,o,s,a,r,l,c;const d=e.width,u=e.height,h=e.data,g=new Uint8Array(h),m=e.bounds.minX,p=e.bounds.maxX,f=e.bounds.minY,v=e.bounds.maxY;let y=d*u;const b=new Uint8Array(y),x=[],w=Math.max(m,1),S=Math.min(p,d-2),C=Math.max(f,1),k=Math.min(v,u-2);if(n&&n.length>0)for(r=0;r<y;r++)1===n[r]&&(g[r]=1);for(a=C;a<k+1;a++)for(i=w;i<S+1;i++)r=a*d+i,0!==h[r]&&(l=r+d,c=r-d,0!==g[r+1]&&0!==g[r-1]&&0!==g[l]&&0!==g[l+1]&&0!==g[l-1]&&0!==g[c]&&0!==g[c+1]&&0!==g[c-1]||x.push(r));if(0===m)for(a=f;a<v+1;a++)1===h[a*d]&&x.push(a*d);if(p===d-1)for(a=f;a<v+1;a++)1===h[a*d+p]&&x.push(a*d+p);if(0===f)for(i=m;i<p+1;i++)1===h[i]&&x.push(i);if(v===u-1)for(i=m;i<p+1;i++)1===h[v*d+i]&&x.push(v*d+i);const P=[];let R,j;const N=t+d,T=t+u,_=2*t+1;for(y=x.length,s=0;s<y;s++){for(r=x[s],b[r]=1,P.push(r),i=r%d,a=(r-i)/d,R=t-i>0?t-i:0,j=N-i<_?N-i:_,l=r-t,o=R;o<j;o++)c=l+o,0===b[c]&&(b[c]=1,P.push(c));for(R=t-a>0?t-a:0,j=T-a<_?T-a:_,l=r-t*d,o=R;o<j;o++)c=l+o*d,0===b[c]&&(b[c]=1,P.push(c))}return P}(e,t,n);let o,s,a,r,l,c,d,u,h,g,m;const p=2*t+1,f=2*t*t,v=new Float32Array(p);let y=0;const b=e.width,x=e.height,w=e.data;let S=e.bounds.minX,C=e.bounds.maxX,k=e.bounds.minY,P=e.bounds.maxY;const R=i.length;for(a=0;a<t;a++)s=(t-a)*(t-a),o=Math.exp(-s/f)/Math.PI,v[t+a]=v[t-a]=o,y+=2*o;for(a=0;a<p;a++)v[a]/=y;const j=new Uint8Array(w),N=t+b,T=t+x;for(a=0;a<R;a++){for(l=i[a],h=0,d=l%b,u=(l-d)/b,g=t-d>0?t-d:0,m=N-d<p?N-d:p,c=l-t,r=g;r<m;r++)h+=w[c+r]*v[r];if(h>.5)j[l]=1,d<S&&(S=d),d>C&&(C=d),u<k&&(k=u),u>P&&(P=u);else{for(g=t-u>0?t-u:0,m=T-u<p?T-u:p,c=l-t*b,r=g;r<m;r++)h+=w[c+r*b]*v[r];h>.5?(j[l]=1,d<S&&(S=d),d>C&&(C=d),u<k&&(k=u),u>P&&(P=u)):j[l]=0}}return{data:j,width:b,height:x,bounds:{minX:S,minY:k,maxX:C,maxY:P}}},e.createBorderMask=e=>{let t,n,i,o,s;const a=e.width,r=e.height,l=e.data,c=e.bounds.minX,d=e.bounds.maxX,u=e.bounds.minY,h=e.bounds.maxY,g=d-c+1,m=h-u+1,p=new Uint8Array(g*m),f=Math.max(c,1),v=Math.min(d,a-2),y=Math.max(u,1),b=Math.min(h,r-2);for(n=y;n<b+1;n++)for(t=f;t<v+1;t++)i=n*a+t,0!==l[i]&&(o=i+a,s=i-a,0!==l[i+1]&&0!==l[i-1]&&0!==l[o]&&0!==l[o+1]&&0!==l[o-1]&&0!==l[s]&&0!==l[s+1]&&0!==l[s-1]||(p[(n-u)*g+(t-c)]=1));if(0===c)for(n=u;n<h+1;n++)1===l[n*a]&&(p[(n-u)*g]=1);if(d===a-1)for(n=u;n<h+1;n++)1===l[n*a+d]&&(p[(n-u)*g+(d-c)]=1);if(0===u)for(t=c;t<d+1;t++)1===l[t]&&(p[t-c]=1);if(h===r-1)for(t=c;t<d+1;t++)1===l[h*a+t]&&(p[(h-u)*g+(t-c)]=1);return{data:p,width:g,height:m,offset:{x:c,y:u}}},e.getBorderIndices=e=>{let t,n,i,o,s;const a=e.width,r=e.height,l=e.data,c=[],d=a-1,u=r-1;for(n=1;n<u;n++)for(t=1;t<d;t++)i=n*a+t,0!==l[i]&&(o=i+a,s=i-a,0!==l[i+1]&&0!==l[i-1]&&0!==l[o]&&0!==l[o+1]&&0!==l[o-1]&&0!==l[s]&&0!==l[s+1]&&0!==l[s-1]||c.push(i));for(n=0;n<r;n++)1===l[n*a]&&c.push(n*a);for(t=0;t<a;t++)1===l[t]&&c.push(t);for(i=a-1,n=0;n<r;n++)1===l[n*a+i]&&c.push(n*a+i);for(i=(r-1)*a,t=0;t<a;t++)1===l[i+t]&&c.push(i+t);return c},e.traceContours=e=>{const t=function(e){let t,n;const i=e.width,o=e.data,s=e.bounds.minX,a=e.bounds.maxX,r=e.bounds.minY,l=e.bounds.maxY,c=a-s+3,d=l-r+3,u=new Uint8Array(c*d);for(n=r;n<l+1;n++)for(t=s;t<a+1;t++)1===o[n*i+t]&&(u[(n-r+1)*c+(t-s+1)]=1);return{data:u,width:c,height:d,offset:{x:s-1,y:r-1}}}(e),n=[];let i=0;const o=t.width,s=2*o,a=t.height,r=t.data,l=t.offset.x,c=t.offset.y,d=new Uint8Array(r);let u,h,g,m,p,f,v,y,b,x,w,S,C,k,P;const R=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];for(m=1;m<a-1;m++)for(g=1;g<o-1;g++)if(p=m*o+g,1===r[p])for(u=-o;u<s;u+=s)if(0===r[p+u]&&0===d[p+u]){for(y=u===o,i++,v=[],b=y?2:6,S=C=x={x:g,y:m},w=null;;){for(d[S.y*o+S.x]=i,h=0;h<8;h++){if(b=(b+1)%8,P=R[b],k={x:S.x+P[0],y:S.y+P[1]},f=k.y*o+k.x,1===r[f]){d[f]=i;break}d[f]=-1,k=null}if(null===k)break;if(S=k,w){if(C.x===x.x&&C.y===x.y&&S.x===w.x&&S.y===w.y)break}else w=k;v.push({x:C.x+l,y:C.y+c}),C=S,b=(b+4)%8}null!==k&&(v.push({x:x.x+l,y:x.y+c}),n.push({inner:y,label:i,points:v}))}return n},e.simplifyContours=(e,t,n)=>{const i=e.length,o=[];let s,a,r,l,c,d,u,h,g,m,p,f,v,y,b,x,w,S,C,k,P;for(a=0;a<i;a++)if(l=e[a],c=l.points,d=l.points.length,d<n){for(u=[],r=0;r<d;r++)u.push({x:c[r].x,y:c[r].y});o.push({inner:l.inner,label:l.label,points:u,initialCount:d})}else{h=[0,d-1],g=[{first:0,last:d-1}];do{if(m=g.shift(),!(m.last<=m.first+1)){for(p=-1,f=m.first,s=m.first+1;s<m.last;s++)C=c[s],k=c[m.first],P=c[m.last],w=C.x-k.x,S=C.y-k.y,y=Math.sqrt(w*w+S*S),w=C.x-P.x,S=C.y-P.y,b=Math.sqrt(w*w+S*S),w=k.x-P.x,S=k.y-P.y,x=Math.sqrt(w*w+S*S),v=y>=Math.sqrt(b*b+x*x)?b:b>=Math.sqrt(y*y+x*x)?y:Math.abs((S*C.x-w*C.y+k.x*P.y-P.x*k.y)/x),v>p&&(f=s,p=v);p>t&&(h.push(f),g.push({first:m.first,last:f}),g.push({first:f,last:m.last}))}}while(g.length>0);for(u=[],d=h.length,h.sort((e,t)=>e-t),r=0;r<d;r++)u.push({x:c[h[r]].x,y:c[h[r]].y});o.push({inner:l.inner,label:l.label,points:u,initialCount:l.points.length})}return o},e})();function yt(e,t,n,i,o,s,a,r,l,c,d){const u={data:e.data,width:n,height:i,bytes:4};let h=vt.floodFill(u,o,s,a,null);return h&&(h=vt.gaussBlurOnlyBorder(h,c,null)),d&&function(e,t,n,i,o,s){if(!i)return;const[a,r,l]=(0,ft.A)(o).rgb();let c,d;s=Math.round(255*s);const{data:u,bounds:h,width:g}=i,m=e.createImageData(t,n);for(d=h.minY;d<=h.maxY;d++)for(c=h.minX;c<=h.maxX;c++){if(0===u[d*g+c])continue;const e=4*(d*t+c);m.data[e]=a,m.data[e+1]=r,m.data[e+2]=l,m.data[e+3]=s}e.putImageData(m,0,0)}(t,n,i,h,r,l),h}var bt=n(68541);function xt(e,t){let n,i=e.x,o=e.y,s=t.x,a=t.y;return i>s&&(n=Math.abs(i-s),i=s,s=i+n),o>a&&(n=Math.abs(o-a),o=a,a=o+n),{x1:i,y1:o,x2:s,y2:a}}function wt(e,t){const n=e.stageRef.getLayers().filter(e=>e.attrs.id===t.id)[0].canvas.context,i=n.getImageData(0,0,n.canvas.width,n.canvas.height),o=[];for(let t=0;t<e.stageRef.bufferCanvas.context.canvas.width*e.stageRef.bufferCanvas.context.canvas.height*4;t+=4){const e=i.data[t+0],n=i.data[t+1],s=i.data[t+2],a=i.data[t+3];e>0||n>0||s>0||a>0?o.push(1):o.push(0)}return o}function St(e,t){let n,i,o,s;return[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}].forEach(e=>{const a=t.point(e);void 0===n&&(n=o=a.x,i=s=a.y),n=Math.min(n,a.x),i=Math.min(i,a.y),o=Math.max(o,a.x),s=Math.max(s,a.y)}),{x:n,y:i,width:o-n,height:s-i}}function Ct(e,t,n=0){const i=new bt.A.Transform;return i.translate(t.x,t.y),i.rotate(n),St(e,i)}function kt(e,t,n){let{x:i,y:o,width:s,height:a}=e;return i<0?(s+=i,i=0):i+s>t&&(s=t-i),o<0?(a+=o,o=0):o+a>n&&(a=n-o),Object.assign({},e,{x:i,y:o,width:s,height:a})}function Pt(e,t={x:0,y:0}){const{parent:n}=e;return i=>n.fixForZoomWrapper(i,i=>{let{x:o,y:s}=i;o=n.canvasToInternalX(o),s=n.canvasToInternalY(s),o-=t.x,s-=t.y;const a=e.selected||!e.inSelection,{top:r,left:l,right:c,bottom:d}=e.bboxCoords,{top:u,left:h,right:g,bottom:m}=(null==n?void 0:n.selectedRegionsBBox)||{},p=a?{x:o,y:s,width:c-l,height:d-r}:{x:h-l+o,y:u-r+s,width:g-h,height:m-u},f=kt(p,100,100);return f.width!==p.width&&(o+=(f.width-p.width)*(f.x!==p.x?-1:1)),f.height!==p.height&&(s+=(f.height-p.height)*(f.y!==p.y?-1:1)),o+=t.x,s+=t.y,{x:n.internalToCanvasX(o),y:n.internalToCanvasY(s)}})}function Rt(e,t,n,i,o,s,a,r,l,c,d){let u,h;d?(u=Math.min(s,i),h=Math.min(a,o)):(u=s,h=a);const g=document.createElement("canvas");g.width=u,g.height=h;const m=g.getContext("2d"),[p,f]=jt(t,n,i,o,l,c);let v,y;d?(v=t,y=n):(v=Math.ceil(s/i*t),y=Math.ceil(a/o*n));const b=p,x=f,w=v,S=y,C=u,k=h;let P;m.drawImage(e,b,x,w,S,0,0,C,k);try{P=m.getImageData(0,0,g.width,g.height)}catch(e){const t="Please configure CORS cross-domain headers correctly for getting image labeling data";throw alert(t),console.error(t),t}return[P,g]}function jt(e,t,n,i,o,s){const a=Math.abs(o)/n,r=Math.abs(s)/i;return[Math.floor(a*e),Math.floor(r*t)]}function Nt(e){if(e<=100)return(e-100)/100;return((e-100)/300)**.5*.8}function Tt(e){let t=e/1e3;const n=Number.parseInt(t/3600);t%=3600;const i=Number.parseInt(t/60);return t=Math.floor(t),`${n}:${i}:${t}`}function _t(e){if(!("string"==typeof e||e instanceof Date||(t=e,/\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z)/.test(t))))return;var t;const n=new Date(e),i=((new Date).getTime()-n.getTime())/1e3,o=Math.floor(i/86400);return isNaN(o)||o<0?void 0:0===o&&((i<60?"just now":i<120&&"1 minute ago")||i<3600&&`${Math.floor(i/60)} minutes ago`||i<7200&&"1 hour ago"||i<86400&&`${Math.floor(i/3600)} hours ago`)||1===o&&"Yesterday"||o<7&&`${o} days ago`||o<31&&`${Math.ceil(o/7)} weeks ago`||`${o} days ago`}function At(e){const t=6e4*(e=e||new Date).getTimezoneOffset();return new Date(e.getTime()-t).toISOString().slice(0,-1)}function It(){return At()}const Mt=e=>e&&e.nodeType===Node.TEXT_NODE,Et=e=>e&&/[\w']/i.test(e),Kt=e=>e&&/[\s\t]/i.test(e),Dt=e=>{const t=e.getRangeAt(0),{startOffset:n,startContainer:i,endOffset:o,endContainer:s}=t;return{selection:e,range:t,startOffset:n,startContainer:i,endOffset:o,endContainer:s,firstSymbol:i.textContent[n],prevSymbol:i.textContent[n-1],lastSymbol:s.textContent[o-1],nextSymbol:s.textContent[o]}},Ot=e=>{(e=>{const t=e.getRangeAt(0);e.removeAllRanges(),e.collapse(t.startContainer,t.startOffset);let n=e.getRangeAt(0);do{e.collapse(n.endContainer,n.endOffset),e.modify("extend","forward","character"),n=e.getRangeAt(0)}while(!Mt(n.startContainer)||Kt(n.startContainer.textContent[n.startOffset]));t.setStart(n.startContainer,n.startOffset),e.removeAllRanges(),e.addRange(t)})(e),(e=>{const t=e.getRangeAt(0);e.removeAllRanges(),e.collapse(t.endContainer,t.endOffset);let n=e.getRangeAt(0);do{e.collapse(n.startContainer,n.startOffset),e.modify("extend","backward","character"),n=e.getRangeAt(0)}while(!Mt(n.startContainer)||Kt(n.startContainer.textContent[n.startOffset]));t.setEnd(n.endContainer,n.endOffset),e.removeAllRanges(),e.addRange(t)})(e)},Lt=(e,t)=>{const n="symbol"!==t,{startOffset:i,startContainer:o,endOffset:s,endContainer:a,firstSymbol:r,prevSymbol:l,lastSymbol:c,nextSymbol:d}=Dt(e);if(n)t.endsWith("boundary")?((e,t)=>{const{range:n,startOffset:i,startContainer:o,endOffset:s,endContainer:a}=Dt(e),r={};let l;e.collapse(o,i),e.modify("move","forward","character"),e.modify("move","backward",t),1===e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n)&&(e.collapse(o,i),e.modify("move","backward",t)),l=e.getRangeAt(0),Object.assign(r,{startContainer:l.startContainer,startOffset:l.startOffset}),e.collapse(a,s),e.modify("move","backward","character"),e.modify("move","forward",t),-1===e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n)&&(e.collapse(a,s),e.modify("move","forward",t)),l=e.getRangeAt(0),Object.assign(r,{endContainer:l.endContainer,endOffset:l.endOffset}),e.removeAllRanges();const c=new Range;c.setStart(r.startContainer,r.startOffset),c.setEnd(r.endContainer,r.endOffset),e.addRange(c)})(e,t):((e,t)=>{const{range:n,startOffset:i,startContainer:o,endOffset:s,endContainer:a}=Dt(e),r={};let l;for(e.collapse(a,s);1===e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n);)e.modify("move","backward",t);for(;e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n)<1;)l=e.getRangeAt(0),Object.assign(r,{startContainer:l.startContainer,startOffset:l.startOffset}),e.modify("move","forward",t);for(e.collapse(o,i);-1===e.getRangeAt(0).compareBoundaryPoints(Range.END_TO_END,n);)e.modify("move","forward",t);for(;e.getRangeAt(0).compareBoundaryPoints(Range.END_TO_END,n)>-1;)l=e.getRangeAt(0),Object.assign(r,{endContainer:l.endContainer,endOffset:l.endOffset}),e.modify("move","backward",t);e.removeAllRanges();const c=new Range;c.setStart(r.startContainer,r.startOffset),c.setEnd(r.endContainer,r.endOffset),e.addRange(c),Ot(e)})(e,t);else{if(!Et(r)||Et(l)){e.getRangeAt(0).setEnd(o,i),e.modify("move","backward",t)}if(!Et(c)||Et(d)){e.getRangeAt(0).setEnd(a,s),e.modify("extend","forward",t)}}},zt=(e,{granularity:t,beforeCleanup:n,window:i}={granularity:"symbol"})=>{const o=i.getSelection();if(o.isCollapsed)return;if("symbol"!==t&&Ot(o),o.isCollapsed)return;Bt(o,t);const s=o.toString().replace(/[\n\r]/g,"\\n");for(let t=0;t<o.rangeCount;t++){e({selectionText:s,range:Ht(o.getRangeAt(t))})}null==n||n(),o.removeAllRanges()},Bt=(e,t)=>{if(e.modify&&t&&"symbol"!==t)try{switch(t){case"word":Lt(e,"word");break;case"sentence":Lt(e,"sentenceboundary");break;case"paragraph":Lt(e,"paragraphboundary")}}catch(e){console.warn("Probably, you're using browser that doesn't support granularity.")}},Ft=(e,t,n,i="forward")=>{const o=t===e?t.childNodes[n]:t;if(Mt(o)&&!i.endsWith("next"))return o;const s=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_ALL);let a,r=s.nextNode();for(;r&&r!==o;)Mt(r)&&(a=r),r=s.nextNode();if(r&&i.startsWith("backward"))return a;for("forward-next"===i&&(r=s.nextNode());r;){if(Mt(r))return r;r=s.nextNode()}},Ht=e=>{const{endOffset:t,commonAncestorContainer:n}=e;let{startOffset:i,startContainer:o,endContainer:s}=e;if(!Mt(o)){if(o=Ft(n,o,i,"forward"),!o)return null;e.setStart(o,0),i=0}const a=e=>/^\s*$/.test(e.wholeText);if(o.wholeText.length===i||a(o)){do{if(o=Ft(n,o,i,"forward-next"),!o)return null}while(a(o));e.setStart(o,0),i=0}if(!Mt(s)){if(s=Ft(n,s,t,"backward"),!s)return null;for(;/^\s*$/.test(s.wholeText);)if(s=Ft(n,s,t,"backward-next"),!s)return null;e.setEnd(s,s.length)}return e},Vt=(e,{index:t,label:n,classNames:i})=>{const{startContainer:o,endContainer:s,commonAncestorContainer:a}=e,{startOffset:r,endOffset:l}=e,c=[],d=(...e)=>$t(...e,i);if(o===s)c.push(d(o,r,l));else{Gt(o,s,a).forEach(e=>{let t=r,n=l;e!==o&&(t=0),e!==s&&(n=e.length),c.push(d(e,t,n))})}const u=c[c.length-1];return u&&(u.setAttribute("data-label",null!=n?n:""),u.setAttribute("data-index",t?String(t):"")),c},$t=(e,t,n,i)=>{let o;const s=e.textContent,a=e.parentNode;if(0===t&&e.length===n&&a.classList.contains(i[0])&&a.innerText===s){const t=e.ownerDocument.createElement("span"),n=a.parentNode;n.replaceChild(t,a),o=Wt(a,i),n.replaceChild(o,t)}else{const r=s.substring(t,n),l=e.ownerDocument.createTextNode(r),c=e.cloneNode(),d=e.cloneNode();c.textContent=s.substring(0,t),d.textContent=s.substring(n,s.length);const u=e.ownerDocument.createDocumentFragment();o=Wt(l,i),c.length&&u.appendChild(c),u.appendChild(o),d.length&&u.appendChild(d),a.replaceChild(u,e)}return o},Wt=(e,t,n)=>{const i=e.ownerDocument.createElement("span");return i.appendChild(e),Ut(i,{classNames:t,label:n}),i},Ut=(e,{classNames:t,index:n,label:i})=>{t&&(e.className="",e.classList.add(...t)),null!=i&&i.length?e.setAttribute("data-label",i):e.removeAttribute("data-label"),e.setAttribute("data-index",n?String(n):"")},Gt=(e,t,n)=>{const i=n.ownerDocument.createTreeWalker(n,NodeFilter.SHOW_ALL);let o=!1;const s=[];let{currentNode:a}=i;for(;a&&(a===e&&(o=!0),o&&a.nodeType===Node.TEXT_NODE&&s.push(a),!o||a!==t);)a=i.nextNode();return s},Yt=e=>{e&&e.forEach(e=>{const t=e.ownerDocument.createDocumentFragment(),n=e.parentNode;Array.from(e.childNodes).forEach(e=>{e.remove(),t.appendChild(e)}),n.replaceChild(t,e),Array.from(n.childNodes).forEach(e=>{const t=e.previousSibling;Mt(t)&&Mt(e)&&(t.data+=e.data,e.remove())})})},Xt=({node:e,position:t})=>{const n=e.textContent.substr(0,t);return{node:e,position:[...n].length}},qt=e=>{const t=Xt({node:e.startContainer,position:e.startOffset}),n=Xt({node:e.endContainer,position:e.endOffset});return e.setStart(e.startContainer,t.position),e.setEnd(e.endContainer,n.position),e},Zt=(e,t)=>[Jt(e.startContainer,e.startOffset,t),Jt(e.endContainer,e.endOffset,t)],Jt=(e,t,n)=>{var i;const o=(null!=(i=n.contentDocument)?i:n.ownerDocument).createTreeWalker(n,NodeFilter.SHOW_ALL);let s=0,a=!1,r=o.nextNode();for(;r;){a=a||e===r;const n=e===r||r.contains(e),i=r.nodeType===Node.TEXT_NODE,l="BR"===r.nodeName;if(a&&!1===n)break;if(i||l){let e=(0,E.isDefined)(r.length)?[...r.textContent].length:1;n&&(e=Math.min(t,e)),s+=e}r=o.nextNode()}return s},Qt=e=>{const t=window.getSelection(),n=document.createRange(),i=e.childNodes[0];n.setStart(i,0),n.setEnd(i,i.length);for(let e=t.rangeCount;e--;){const i=t.getRangeAt(e);if(i.compareBoundaryPoints(Range.START_TO_START,n)<1&&i.compareBoundaryPoints(Range.END_TO_END,n)>-1)return!0}return!1};const en={Image:o,HTML:fe,Checkers:E,Colors:pt,UDate:s,guidGenerator:I,debounce:M,styleToProp:function(e){return e?e.split(";").filter(e=>e.split(":")[0]&&e.split(":")[1]).map(e=>[e.split(":")[0].trim().replace(/-./g,e=>e.substr(1).toUpperCase()),e.split(":").slice(1).join(":").trim()]).reduce((e,t)=>Object.assign({},e,{[t[0]]:t[1]}),{}):null},Magicwand:i,Selection:a},tn=u.gK.model("AudioRegionModel",{type:"audioregion",object:u.gK.late(()=>u.gK.reference(yn)),start:u.gK.number,end:u.gK.number,channel:u.gK.optional(u.gK.number,0),selectedregionbg:u.gK.optional(u.gK.string,"rgba(0, 0, 0, 0.5)")}).volatile(()=>({hideable:!0,_ws_region:null})).views(e=>({get bboxTriggers(){var t,n;return[e.start,e.end,e._ws_region,null==(t=e.object)?void 0:t._ws,null==(n=e.object)?void 0:n._wfFrame]},get bboxCoordsCanvas(){if(!e.bboxTriggers)return null;const{_ws_region:t}=e;if(!t)return null;if(!t.inViewport)return null;const{xStart:n,xEnd:i,yStart:o,yEnd:s,visualizer:a}=t;return{left:(0,E.clamp)(n,0,a.width),top:o,right:(0,E.clamp)(i,0,a.width),bottom:s}},wsRegionOptions(){var t;return{id:e.id,start:e.start,end:e.end,color:e.getColor(),visible:!e.hidden,updateable:!e.isReadOnly(),deletable:!e.isReadOnly(),channel:null!=(t=e.channel)?t:0}}})).actions(e=>{const t={setProperty:e.setProperty,setLocked:e.setLocked};return{serialize(){var t;return{original_length:null==(t=e.object._ws)?void 0:t.duration,value:{start:e.start,end:e.end,channel:e.channel}}},getColor:(t=1)=>en.Colors.convertToRGBA(e.getOneColor(),t),updateColor(t=1){var n;const i=e.getColor(t);null==(n=e._ws_region)||n.updateColor(i)},updatePosition(t,n){var i;null==(i=e._ws_region)||i.updatePosition(null!=t?t:e.start,null!=n?n:e.end)},selectRegion(){e._ws_region&&(e._ws_region.handleSelected(!0),e._ws_region.bringToFront(),e._ws_region.scrollToRegion())},deleteRegion(){e.annotation.deleteRegion(e)},afterUnselectRegion(){e._ws_region&&e._ws_region.handleSelected(!1)},setHighlight(t){e._highlighted=t,e._ws_region&&e._ws_region.handleHighlighted(t)},beforeDestroy(){e._ws_region&&e._ws_region.remove()},setLocked(n){t.setLocked(n),e._ws_region&&e._ws_region.setLocked(e.locked)},onMouseOver(){e.annotation.isLinkingMode&&(e.setHighlight(!0),e._ws_region.switchCursor(w.A.LINKING_MODE_CURSOR))},onMouseLeave(){e.annotation.isLinkingMode&&(e.setHighlight(!1),e._ws_region.switchCursor(w.A.MOVE_CURSOR))},onUpdateEnd(){e.start=e._ws_region.start,e.end=e._ws_region.end,e.notifyDrawingFinished()},toggleHidden(t){null==t||t.stopPropagation(),e.hidden=!e.hidden,e._ws_region&&e._ws_region.setVisibility(!e.hidden)},setProperty(n,i){t.setProperty(n,i),["start","end"].includes(n)&&e.updatePosition()},setWSRegion(t){e._ws_region=t,t&&(t.on("mouseOver",e.onMouseOver),t.on("mouseLeave",e.onMouseLeave))}}}),nn=u.gK.model("EditableRegion").volatile(()=>({editorEnabled:!0,editableFields:[]})).views(e=>({getProperty:t=>e[t],getPropertyType:t=>(0,u.Pw)(e).properties[t],isPropertyEditable:t=>e.editableFields.some(e=>e.property===t),get hasEditableFields(){return e.editableFields.length>0}})).actions(e=>({setProperty(t,n){if(!e.isPropertyEditable(t))throw new Error(`Property ${t} of model ${e.type} is not editable`);e[t]=n}})),on=u.gK.model("EditableAudioModel",{}).volatile(()=>({editableFields:[{property:"start",label:"Start"},{property:"end",label:"End"}]})),sn=u.gK.compose("AudioRegionModel",Ze,mt,Ge,nn,on,tn);we.addRegionType(sn,"audioplus"),we.addRegionType(sn,"audio");var an=n(87410),rn=n.n(an),ln=n(72683);const cn=(e,t,n)=>{const i={type:"",title:""};switch(e){case"error":i.type=ln.A.error,i.title="Error";break;case"warning":i.type=ln.A.warning,i.title="Warning";break;case"success":i.type=ln.A.success,i.title="Success";break;default:i.type=ln.A.info,i.title="Info"}return i.type({title:n||i.title,content:t})},dn={error:(e,t)=>cn("error",e,t),warning:(e,t)=>cn("warning",e,t),success:(e,t)=>cn("success",e,t),info:(e,t)=>cn("info",e,t)},un=u.gK.model("BaseTag"),hn=u.gK.model(Object.assign({},(0,Ne.VS)(Ne.cE)?{id:u.gK.identifier,name:u.gK.string}:{name:u.gK.identifier},{_needsUpdate:u.gK.optional(u.gK.number,0)})).volatile(()=>({isObjectTag:!0,supportSuggestions:!1})).views(e=>({get allRegs(){var t;return(null==(t=e.annotation)?void 0:t.regionStore.regions.filter(t=>t.object===e))||[]},get regs(){return e.allRegs},findRegion(t){let n=null;return e._regionsCache&&e._regionsCache.length&&(n=e._regionsCache.find(({region:e})=>rn()(e,t))),n||e.regions.find(e=>rn()(e,t))},get isReady(){return!0}})).actions(e=>{const t={};return{addProp:function(n,i){t[n]=i,e._needsUpdate=e._needsUpdate+1},getProps:function(){return t},getAvailableStates:function(){const t=(e.states()||[]).reduce((e,t)=>t.checkMaxUsages?e.concat(t.checkMaxUsages()):e,[]).filter(e=>e.selected);t.forEach(e=>e.setSelected(!1));const n=e.activeStates()||[];if(0===n.length){if(t.length){const e=t[0];dn.warning(`You can't use ${e.value} more than ${e.maxUsages} time(s)`)}e.annotation.unselectAll()}return n}}}),gn=u.gK.compose(hn,un,Te),mn={min:0,max:1,step:.01,default:1},pn=["playing"],fn=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING),vn=u.gK.model({name:u.gK.identifier,value:u.gK.maybeNull(u.gK.string),muted:u.gK.optional(u.gK.boolean,!1),zoom:u.gK.optional(u.gK.boolean,!0),defaultzoom:u.gK.optional(u.gK.string,1..toString()),volume:u.gK.optional(u.gK.boolean,!0),defaultvolume:u.gK.optional(u.gK.string,mn.default.toString()),speed:u.gK.optional(u.gK.boolean,!0),defaultspeed:u.gK.optional(u.gK.string,1..toString()),hotkey:u.gK.maybeNull(u.gK.string),showlabels:u.gK.optional(u.gK.boolean,!1),showscores:u.gK.optional(u.gK.boolean,!1),height:u.gK.optional(u.gK.string,"96"),waveheight:u.gK.optional(u.gK.string,"32"),cursorwidth:u.gK.optional(u.gK.string,"2"),cursorcolor:u.gK.optional(Ce.color,"#333"),defaultscale:u.gK.optional(u.gK.string,"1"),autocenter:u.gK.optional(u.gK.boolean,!0),scrollparent:u.gK.optional(u.gK.boolean,!0),splitchannels:u.gK.optional(u.gK.boolean,!1),decoder:u.gK.optional(u.gK.enumeration(["ffmpeg","webaudio","none"]),"webaudio"),player:u.gK.optional(u.gK.enumeration(["html5","webaudio"]),"html5"),spectrogram:u.gK.optional(u.gK.boolean,!1)}),yn=u.gK.compose("AudioModel",vn,Ue,Fe,gn,Te,Ae,u.gK.model("AudioModel",{type:"audio",_value:u.gK.optional(u.gK.string,""),regions:u.gK.array(sn)}).volatile(()=>({errors:[],stageRef:(0,f.createRef)(),_ws:null,_wfFrame:null,_skip_seek_event:!1})).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0},get store(){return(0,u.Zn)(e)},states(){var t;return(null==(t=e.annotation)?void 0:t.toNames.get(e.name))||[]},activeStates(){const t=e.states();return null==t?void 0:t.filter(e=>"LabelsModel"===(0,u.Pw)(e).name&&e.isSelected)},get activeState(){const t=e.states();return null==t?void 0:t.filter(e=>"LabelsModel"===(0,u.Pw)(e).name&&e.isSelected)[0]},get activeLabel(){var t;const n=e.activeState;return null==n||null==(t=n.selectedValues())?void 0:t[0]},get activeLabelKey(){var t;const n=null==(t=e.activeState)?void 0:t.selectedValues();return n?n.join(","):""},get readonly(){return e.annotation.isReadOnly()}})).actions(e=>({triggerSync(t,n){e._ws&&e.syncSend(Object.assign({playing:e._ws.playing,time:e._ws.currentTime,speed:e._ws.rate},n),t)},triggerSyncSpeed(t){e.triggerSync("speed",{speed:t})},triggerSyncPlay(t=!1){fn&&e.isBuffering&&!t||(e.wasPlayingBeforeBuffering=!0,e.handleSyncPlay(),e.triggerSync("play",{playing:!0}))},triggerSyncPause(t=!1){fn&&e.isBuffering&&!t||(e.wasPlayingBeforeBuffering=!1,e.handleSyncPause(),e.triggerSync("pause",{playing:!1}))},triggerSyncSeek(t){e.triggerSync("seek",Object.assign({time:t},fn?{playing:e.wasPlayingBeforeBuffering}:{}))},triggerSyncBuffering(t){if(!e._ws)return;const n=e.wasPlayingBeforeBuffering;e.triggerSync("buffering",{buffering:t,playing:n})},registerSyncHandlers(){for(const t of["play","pause","seek"])e.syncHandlers.set(t,e.handleSync);e.syncHandlers.set("speed",e.handleSyncSpeed),fn&&e.syncHandlers.set("buffering",e.handleSyncBuffering)},handleSyncBuffering(t){var n;let{playing:i}=t,o=(0,Se.A)(t,pn);var s,a;(e.isBuffering=null==(n=e.syncManager)?void 0:n.isBuffering,o.buffering)&&(e.wasPlayingBeforeBuffering=i,e._skip_seek_event=!0,e.isPlaying=!1,null==(s=e._ws)||s.pause(),e._skip_seek_event=!1);e.isBuffering||o.buffering||i&&(e._skip_seek_event=!0,e.isPlaying=!0,null==(a=e._ws)||a.play(),e._skip_seek_event=!1);e.handleSyncSeek(o)},handleSync(t,n){var i,o;if(null==(i=e._ws)||!i.loaded)return;fn||e.handleSyncSeek(t);const s=null==(o=e.syncManager)?void 0:o.isBuffering;var a,r;(!fn||!s&&(0,E.isDefined)(t.playing))&&(t.playing?e._ws.playing||(e.isPlaying=!0,null==(a=e._ws)||a.play()):e._ws.playing&&(e.isPlaying=!1,null==(r=e._ws)||r.pause()));["play","pause"].indexOf(n)>-1&&(e.wasPlayingBeforeBuffering=t.playing),fn&&e.handleSyncSeek(t)},handleSyncPlay(){var t,n;null!=(t=e._ws)&&t.playing||(e.isPlaying=!0,null==(n=e._ws)||n.play())},handleSyncPause(){var t;e.isPlaying||(e.isPlaying=!1,null==(t=e._ws)||t.pause())},handleSyncSeek({time:t}){var n;if(null!=(n=e._ws)&&n.loaded&&(0,E.isDefined)(t))try{e._ws.setCurrentTime(t,!0),setTimeout(()=>{var t;(0,u._n)(e)&&(null==(t=e._ws)||t.syncCursor())})}catch(e){console.log(e)}},handleSyncSpeed({speed:t}){e._ws&&(e._ws.rate=t)},syncMuted(t){e._ws&&(e._ws.muted=t)}})).actions(e=>{let t,n=null;return{afterCreate(){t=(0,d.lB)(e,"activeLabelKey",()=>{var t;const n=null==(t=e._ws)||null==(t=t.regions)?void 0:t.selected;if(!n||0===n.length)return;const i=e.activeState,o=null==i?void 0:i.selectedColor,s=null==i?void 0:i.selectedValues();for(const t of n){t.update({color:o,labels:null!=s?s:[]});const n=t.isRegion?e.updateRegion(t):e.addRegion(t);e.annotation.selectArea(n)}n.length&&e.requestWSUpdate()},!1)},needsUpdate(){e.handleNewRegions(),e.requestWSUpdate()},requestWSUpdate(){e._ws&&(n&&clearTimeout(n),n=setTimeout(()=>{e._ws.regions.redraw()},33))},onReady(){e.setReady(!0)},onRateChange(t){e.triggerSyncSpeed(t)},loadSyncedParagraphs(){if(!e.syncManager)return;const t=Array.from(e.syncManager.syncTargets,([,e])=>e).filter(e=>"paragraphs"===e.type&&e.contextscroll);for(const n of t){const t=Object.values(n.regionsStartEnd).map(({start:e,end:t})=>({start:e,end:t,showInTimeline:!0,external:!0,locked:!0}));e._ws.addRegions(t)}},handleNewRegions(){e._ws&&e.regs.map(t=>{t._ws_region?e.updateWsRegion(t):e.createWsRegion(t)})},findRegionByWsRegion:t=>e.regs.find(e=>{var n;return(null==(n=e._ws_region)?void 0:n.id)===(null==t?void 0:t.id)}),getRegionColor(){const t=e.activeState;return t?t.selectedColor:null},onHotKey:t=>(null==t||t.preventDefault(),e._ws.togglePlay(),!1),setRangeValue(t){e.rangeValue=t},setPlaybackRate(t){e.playBackRate=t},addRegion(t){const n=e.annotation.areas.get(t.id);if(n)return n.setWSRegion(t),n.updateColor(),n;if(0===e.getAvailableStates().length)return void(t.isRegion&&t.convertToSegment().handleSelected());const i=e.activeStates(),[o,...s]=i,a={[o.valueType]:o.selectedValues()},r=He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult(t,a,o,e,!1,s):e.annotation.createResult(t,a,o,e,!1),l=t.convertToRegion(a.labels);return r.setWSRegion(l),r.updateColor(),r},updateRegion(t){const n=e.findRegionByWsRegion(t);if(n)return n.onUpdateEnd(),n},createWsRegion(t){var n;if(!e._ws)return;const i=t.wsRegionOptions();i.labels=null!=(n=t.labels)&&n.length?t.labels:void 0;const o=e._ws.addRegion(i,!1);t.setWSRegion(o)},updateWsRegion(t){var n;if(!e._ws)return;const i=t.wsRegionOptions();i.labels=null!=(n=t.labels)&&n.length?t.labels:void 0,e._ws.updateRegion(i,!1)},clearRegionMappings(){for(const t of e.regs)t.setWSRegion(null)},onLoad(t){e.clearRegionMappings(),e._ws=t,e.checkReady(),e.needsUpdate(),(0,Ne.VS)(Ne.LG)&&e.loadSyncedParagraphs()},checkReady(){e._ws&&!e._ws.destroyed&&(e._ws.isDrawing?requestAnimationFrame(()=>e.checkReady()):e.onReady())},onSeek(t){fn&&e._skip_seek_event||e.triggerSyncSeek(t)},onPlaying(t){fn&&e.isPlaying===t||(t?e.triggerSyncPlay():e.triggerSyncPause(),e.isPlaying=t)},handleBuffering(t){var n,i,o,s,a;if(!fn)return;if((null==(n=e.syncManager)?void 0:n.isBufferingOrigin(e.name))===t)return;const r=!(null==(i=e.syncManager)?void 0:i.isBuffering)&&t;var l,c,d;1===(null==(o=e.syncManager)?void 0:o.bufferingOrigins.size)&&(null==(s=e.syncManager)?void 0:s.isBufferingOrigin(e.name))&&!t&&(e.wasPlayingBeforeBuffering&&(e.isPlaying=!0,null==(l=e._ws)||l.play()));(e.triggerSyncBuffering(t),e.isBuffering=null==(a=e.syncManager)?void 0:a.isBuffering,r)&&(null!=(c=e._ws)&&c.playing&&(e.isPlaying=!1,null==(d=e._ws)||d.pause()))},onError(t){let n;n="HTTPError"===t.name?"ERR_LOADING_HTTP":"ERR_LOADING_AUDIO";const i=(0,u._$)(e.store).messages[n]({attr:e.value,url:e._value,error:t.message});e.errors=[i]},beforeDestroy(){try{n&&clearTimeout(n),t&&t(),(0,E.isDefined)(e._ws)&&(e._ws.destroy(),e._ws=null)}catch(t){e._ws=null,console.warn("Already destroyed")}},setWFFrame(t){e._wfFrame=t}}})),bn=(e,t,n={})=>{const{decoder:i,encoder:o}=n,s=(0,f.useMemo)(()=>{var n;const o=localStorage.getItem(e);return"string"==typeof o?null!=(n=null==i?void 0:i(o,t))?n:o:t},[]),[a,r]=(0,f.useState)(s),l=(0,f.useCallback)(t=>{r(n=>{var i;const s=t instanceof Function?t(n):t,a=null!=(i=null==o?void 0:o(s))?i:s.toString();return localStorage.setItem(e,a),s})},[]);return[a,l]};function xn(e,t){try{return JSON.parse(e)}catch(e){return t}}function wn(e){return JSON.stringify(e)}const Sn=(0,f.createContext)({position:0,length:0,regions:[],step:10,playing:!1,settings:{},visibleWidth:0,seekOffset:0,data:void 0}),Cn=Sn.Provider;var kn=n(96235),Pn=n(26102),Rn=n(37442),jn=n.n(Rn),Nn=n(50494);const Tn=e=>(0,ae.jsx)("sup",{className:(0,Nn.cn)("hint").mix(e.className).toClassName(),"data-copy":e.copy,style:e.style,children:e.children}),_n=JSON.parse('{"audio:back":{"key":"ctrl+b","mac":"command+b","description":"Back for one second"},"audio:playpause":{"key":"ctrl+p","mac":"command+p","description":"Play/pause"},"audio:step-backward":{"key":"alt+a","description":"Go one step back"},"audio:step-forward":{"key":"alt+d","description":"Go one step forward"},"ts:grow-left":{"key":"left","description":"Increase region to the left"},"ts:grow-right":{"key":"right","description":"Increase region to the right"},"ts:shrink-left":{"key":"alt+left","description":"Decrease region on the left"},"ts:shrink-right":{"key":"alt+right","description":"Decrease region on the right"},"ts:grow-left-large":{"key":"shift+left"},"ts:grow-right-large":{"key":"shift+right"},"ts:shrink-left-large":{"key":"shift+alt+left"},"ts:shrink-right-large":{"key":"shift+alt+right"},"annotation:submit":{"key":"ctrl+enter","mac":"command+enter","description":"Submit annotation"},"annotation:skip":{"key":"ctrl+space","mac":"alt+enter","description":"Skip task"},"annotation:undo":{"key":"ctrl+z","mac":"command+z","description":"Undo"},"annotation:redo":{"key":"ctrl+shift+z","mac":"command+shift+z","description":"Redo"},"polygon:undo":{"key":"ctrl+z","mac":"command+z","description":"Undo"},"polygon:redo":{"key":"ctrl+shift+z","mac":"command+shift+z","description":"Redo"},"region:delete-all":{"key":"ctrl+backspace","mac":"command+backspace","description":"Delete all regions"},"region:focus":{"key":"enter","description":"Focus first focusable region"},"region:relation":{"key":"alt+r","description":"Create relation between regions"},"region:visibility":{"key":"alt+h","description":"Toggle selected region visibility"},"region:visibility-all":{"key":"ctrl+h","mac":"command+h","description":"Toggle all regions visibility"},"region:lock":{"key":"alt+l","description":"Lock selected region"},"region:meta":{"key":"alt+m","description":"Edit selected region meta"},"region:unselect":{"key":"u","description":"Unselect region"},"region:exit":{"key":"escape","description":"Exit relation mode, unselect region"},"region:delete":{"key":"backspace","description":"Delete selected region"},"region:cycle":{"key":"alt+.","description":"Cycle through regions"},"region:duplicate":{"key":"ctrl+d","mac":"command+d","description":"Duplicate selected region"},"segment:delete":{"key":"delete","description":"Delete selected region"},"media:playpause":{"key":"ctrl+alt+space","mac":"command+alt+space","description":"Play/pause"},"media:step-backward":{"key":"alt+left","description":"Go one step back"},"media:step-forward":{"key":"alt+right","description":"Go one step forward"},"video:keyframe-backward":{"key":"ctrl+alt+left","mac":"command+alt+left","description":"Go to previous keyframe"},"video:keyframe-forward":{"key":"ctrl+alt+right","mac":"command+alt+right","description":"Go to next keyframe"},"video:backward":{"key":"alt+left","description":"Go back"},"video:rewind":{"key":"shift+ctrl+alt+left","mac":"shift+command+alt+left","description":"Go to first frame"},"video:forward":{"key":"shift+alt+right","description":"Go forward"},"video:fastforward":{"key":"shift+ctrl+alt+right","mac":"shift+command+alt+right","description":"Go to last frame"},"video:hop-backward":{"key":"shift+alt+left","description":"Hop Backward"},"video:hop-forward":{"key":"shift+alt+right","description":"Hop Forward"},"repeater:next-page":{"key":"alt+right","description":"Next Page"},"repeater:previous-page":{"key":"alt+left","description":"Previous Page"},"image:prev":{"key":"ctrl+left","mac":"command+left","description":"Previous Image"},"image:next":{"key":"ctrl+right","mac":"command+right","description":"Next Image"},"tool:zoom-in":{"key":"ctrl+plus","mac":"command+plus","description":"Zoom in on the image"},"tool:pan-image":{"key":"H","description":"Pan around the image"},"tool:zoom-to-fit":{"key":"shift+1","description":"Zoom to fit the full image in view"},"tool:zoom-to-actual":{"key":"shift+2","description":"Zoom to actual image size (100%)"},"tool:zoom-out":{"key":"ctrl+minus","mac":"command+minus","description":"Zoom out of the image"},"tool:ellipse":{"key":"O","description":"Select the ellipse tool"},"tool:eraser":{"key":"E","description":"Select the eraser tool"},"tool:auto-detect":{"key":"M","description":"Use the auto-detect tool to automatically suggest regions"},"tool:rect-3point":{"key":"shift+R","description":"Draw a rotated rectangle using 3-point selection"},"tool:key-point":{"key":"K","description":"Select the key point annotation tool"},"tool:magic-wand":{"key":"W","description":"Select the magic wand tool for smart region selection"},"tool:polygon":{"key":"P","description":"Select the polygon annotation tool"},"tool:vector":{"key":"P","description":"Select the vector annotation tool"},"tool:rect":{"key":"R","description":"Select the rectangle annotation tool"},"tool:rotate-left":{"key":"alt+left","description":"Rotate the image 90Â° to the left"},"tool:rotate-right":{"key":"alt+right","description":"Rotate the image 90Â° to the right"},"tool:move":{"key":"V","description":"Select the move tool to reposition annotations"},"tool:brush":{"key":"B","description":"Select the brush tool"},"tool:decrease-tool":{"key":"[","description":"Decrease tool size"},"tool:increase-tool":{"key":"]","description":"Increase tool size"},"phrases:next-phrase":{"key":"ctrl+down","mac":"command+down","description":"Move to next phrase"},"phrases:previous-phrase":{"key":"ctrl+up","mac":"command+up","description":"Move to previous phrase"},"phrases:next-region":{"key":"ctrl+left","mac":"command+left","description":"Select next region in current phrase"},"phrases:previous-region":{"key":"ctrl+right","mac":"command+right","description":"Select previous region in current phrase"},"phrases:select_all_annotate":{"key":"ctrl+shift+a","mac":"command+shift+a","description":"Select all and annotate current phrase"}}'),An=["store","name","children"];if(!(0,Ne.VS)(Ne.xB)){const e=_n["image:prev"],t=_n["image:next"];e&&(e.key=e.mac="ctrl+a"),t&&(t.key=t.mac="ctrl+d")}const In=["key","mac","description","modifier","modifierDescription","active"],Mn=e=>{Object.entries(e).forEach(([e,t])=>{Object.keys(t).forEach(t=>{if(!In.includes(t))throw new Error(`Unknown keymap property ${t} for key ${e}`)})})};Mn(_n);const En="__main__",Kn="__input__",Dn={},On={},Ln=[],zn={[En]:{},[Kn]:{}};jn().filter=e=>{var t;if("__none__"===jn().getScope())return!1;const n=null==(t=e.target||e.srcElement)?void 0:t.tagName;return e.keyCode>=96&&e.keyCode<=105&&(e=>{const t=e.keyCode-48;document.dispatchEvent(new KeyboardEvent("keydown",{keyCode:t}))})(e),n&&jn().setScope(/^(INPUT|TEXTAREA|SELECT)$/.test(n)?Kn:En),!0};const Bn={plus:"=",minus:"-",",":"Â¼"},Fn=(e="global",t="Hotkeys")=>{var n;let i={};On[e]=null!=(n=On[e])?n:{description:t,get keys(){return i},get descriptions(){const e=Object.keys(this.keys).reduce((e,t)=>(Dn[t]&&e.push([t,Dn[t]]),e),[]);return Object.fromEntries(e)}};const o=(t,n)=>{const i=zn[t];i&&i[n]&&(i[n]=i[n].filter(t=>t.namespace!==e))},s=(e,t)=>{const n=zn[e];n&&n[t]&&n[t].forEach(n=>{jn()(t,e,n.func)})},a=e=>[...e.replace(/\s/,"").matchAll(/((?:\w+\+)*(?:[^,]+|,)),?/g)].map(e=>e[1]),r=()=>{for(const e of[En,Kn])for(const t of Object.keys(i)){const n=a(t);for(const t of n)o(e,t),jn().unbind(t,e),s(e,t),delete Dn[t]}i={}};return Ln.push(r),{applyAliases:e=>a(e).map(e=>e.split("+").map(e=>{var t;return null!=(t=Bn[e.trim()])?t:e}).join("+")).join(","),addKey(t,n,o,s=En){if(!(0,E.isDefined)(t))return;i[t]&&console.warn(`Key already added: ${t}. It's possibly a bug.`);const a=this.applyAliases(t.toLowerCase());i[a]=n,o&&(Dn[a]=o),s.split(",").map(e=>e.trim()).filter(Boolean).forEach(t=>{const i=(...e)=>{const t=e[0];t.stopPropagation(),t.preventDefault(),n(...e)};((t,n,i)=>{(0,E.isDefined)(zn[t])||(zn[t]={});const o=zn[t];(0,E.isDefined)(o[n])||(o[n]=[]),o[n].push({namespace:e,func:i})})(t,a,i),jn()(a,t,i)})},overwriteKey(e,t,n,i=En){(0,E.isDefined)(e)&&(this.hasKey(e)&&this.removeKey(e,i),this.addKey(e,t,n,i))},removeKey(e,t=En){if(!(0,E.isDefined)(e))return;const n=e.toLowerCase();this.hasKey(n)&&(t.split(",").map(e=>e.trim()).filter(Boolean).forEach(t=>{o(t,e),jn().unbind(n,t),s(t,e)}),delete i[n],delete Dn[n])},addNamed(e,t,n){const i=Fn.keymap[e];if(!(0,E.isDefined)(i))throw new Error(`Unknown named hotkey ${i}`);{var o;const e=(0,E.isMacOS)()&&null!=(o=i.mac)?o:i.key;this.addKey(e,t,i.description,n),i.modifier&&this.addKey(`${i.modifier}+${e}`,t,i.modifierDescription,n)}},lookupKey(e){const t=Fn.keymap[e];var n;if((0,E.isDefined)(t))return(0,E.isMacOS)()&&null!=(n=t.mac)?n:t.key},removeNamed(e,t){const n=Fn.keymap[e];if(!(0,E.isDefined)(n))throw new Error(`Unknown named hotkey ${n}`);{var i;const e=(0,E.isMacOS)()&&null!=(i=n.mac)?i:n.key;this.removeKey(e,t),n.modifier&&this.removeKey(`${n.modifier}+${e}`)}},overwriteNamed(e,t,n){const i=Fn.keymap[e];if(!(0,E.isDefined)(i))throw new Error(`Unknown named hotkey ${e}`);{var o;const e=(0,E.isMacOS)()&&null!=(o=i.mac)?o:i.key;this.overwriteKey(e,t,i.description,n),i.modifier&&this.overwriteKey(`${i.modifier}+${e}`,t,i.modifierDescription,n)}},hasKey(e){if(!(0,E.isDefined)(e))return;const t=e.toLowerCase();return(0,E.isDefined)(i[t])},hasKeyByName(e){var t;if(!(0,E.isDefined)(e))return;const n=Fn.keymap[e];if(!(0,E.isDefined)(n))return!1;const i=(0,E.isMacOS)()&&null!=(t=n.mac)?t:n.key;return this.hasKey(i)},hasName(e){if(!(0,E.isDefined)(e))return;const t=e.toLowerCase();return(0,E.isDefined)(t in Fn.keymap)},getKeys:()=>Object.keys(i),getNamespace:()=>On[e],addDescription(e,t){i[e]||(Dn[e]=t)},removeDescription(e){i||Dn[e]},unbindAll(){r()},makeComb(){const e="1234567890qwetasdfgzxcvbyiopjklnm".split("");for(let t=0;t<=e.length;t++){let n;if(n=e[t],!{}.hasOwnProperty.call(i,n))return n}return null}}};Fn.DEFAULT_SCOPE=En,Fn.INPUT_SCOPE=Kn,Fn.ALL_SCOPES=[En,Kn].join(","),Fn.keymap=Object.assign({},_n),Fn.setKeymap=e=>{Mn(e),Object.assign(Fn.keymap,e)},Fn.keysDescipritions=()=>Dn,Fn.namespaces=()=>On,Fn.unbindAll=()=>{Ln.forEach(e=>e())},Fn.setScope=e=>{jn().setScope(e)},Fn.Tooltip=(0,b.WQ)("store")((0,b.PA)(e=>{let{store:t,name:n,children:i}=e,o=(0,Se.A)(e,An);const s=Fn.keymap[n],a=t.settings.enableTooltips&&t.settings.enableHotkeys;if((0,E.isDefined)(s)){var r,l;const e=(0,E.isMacOS)()&&null!=(r=s.mac)?r:s.key,t=null!=(l=o.title)?l:s.description,n=[];return a&&e.split(",").forEach(e=>{const t=e.split("+").map(e=>(0,f.createElement)("kbd",{className:(0,Nn.cn)("hotkey").elem("key").toClassName()},e));n.push((0,f.createElement)("span",{className:(0,Nn.cn)("key-group").toClassName(),style:{marginLeft:5}},...t))}),(0,f.createElement)(Pn.m_M,Object.assign({},o,{theme:"light",title:(0,f.createElement)(f.Fragment,{},t,...n)}),i)}return i})),Fn.Hint=(0,b.WQ)("store")((0,b.PA)(({store:e,name:t})=>{const n=Fn.keymap[t],i=e.settings.enableTooltips&&e.settings.enableHotkeys;if((0,E.isDefined)(n)&&i){var o;const e=(0,E.isMacOS)()&&null!=(o=n.mac)?o:n.key;return(0,f.createElement)(Tn,{},[e])}return null}));const Hn=Fn(),Vn=(e,t,n)=>{const i=(0,f.useRef)(null),o=(0,f.useRef)(null),s=(0,f.useRef)(t),a=(0,f.useRef)((e,t)=>{null==s.current||s.current(e,t)});(0,f.useEffect)(()=>{const t=e!==i.current,s=n!==o.current;(t||s)&&(e?(((e,t,n)=>{Fn.keymap[e]?Hn.overwriteNamed(e,t,n):Hn.overwriteKey(e,t,n)})(e,a.current,n),i.current=e):i.current&&!e&&(((e,t)=>{Fn.keymap[e]?Hn.removeNamed(e,t):Hn.removeKey(e,t)})(i.current,o.current),i.current=null))},[e,n]),(0,f.useEffect)(()=>{s.current=t},[t])},$n=(0,f.forwardRef)(({children:e,binging:t,hotkeyScope:n,displayedHotkey:i},o)=>{f.Children.only(e);const{onClick:s,tooltip:a}=e.props,r=(0,f.cloneElement)(e,{ref:o,tooltip:void 0});return Vn(t,s,n),t&&(0,E.isDefined)(Fn.keymap[t])||i&&(0,E.isDefined)(Fn.keymap[i])?(0,ae.jsx)(Fn.Tooltip,{name:t||i,title:a,children:r}):r}),Wn=({position:e=0,length:t=0,onPositionChange:n})=>{const[i,o]=(0,f.useState)(!1),s=(0,f.useMemo)(()=>t-1,[t]);return(0,ae.jsx)("div",{className:(0,Nn.cn)("frames-control").toClassName(),onClick:()=>o(!0),children:i?(0,ae.jsx)(Gn,{length:s,position:e,onChange:e=>{null==n||n((0,E.clamp)(e,0,t))},onFinishEditing:()=>{o(!1)}}):(0,ae.jsxs)(ae.Fragment,{children:[(0,E.clamp)(Math.round(e+1),1,s+1)," ",(0,ae.jsxs)("span",{children:["of ",s+1]})]})})},Un=["ArrowUp","ArrowDown","Backspace","Delete","Enter",/[0-9]/],Gn=({length:e,position:t,onChange:n,onFinishEditing:i})=>{const o=(0,f.useRef)(),s=t=>{null==n||n((0,E.clamp)(t,1,e))};return(0,ae.jsx)("input",{type:"text",ref:o,defaultValue:t+1,autoFocus:!0,onFocus:()=>{var e;return null==(e=o.current)?void 0:e.select()},onKeyDown:t=>{const n=Un.find(e=>e instanceof RegExp?e.test(t.key):e===t.key);n||t.metaKey||t.preventDefault();const a=Number.parseInt(o.current.value),r=t.shiftKey?10:1;"Enter"===t.key?(null==s||s(a),null==i||i()):"Escape"===t.key?null==i||i():"ArrowUp"===n?(o.current.value=(0,E.clamp)(a+r,1,e).toString(),t.preventDefault()):"ArrowDown"===n&&(o.current.value=(0,E.clamp)(a-r,1,e).toString(),t.preventDefault())},onBlur:()=>null==i?void 0:i()})},Yn=(e,t=!1)=>t?[...e].reverse():e,Xn=({value:e,defaultValue:t,multi:n=!1,reverse:i=!1,continuous:o=!1,min:s=0,max:a=100,step:r=1,size:l=120,align:c="horizontal",resetValue:d,minIcon:u,maxIcon:h,onChange:g,onMinIconClick:m,onMaxIconClick:p})=>{var v;const y=null!=(v=null!=e?e:t)?v:n?[0,100]:0,[b,x]=((e,t)=>{const n=(0,f.useMemo)(()=>{var n;return null!=(n=null!=e?e:t)?n:""},[e,t]),[i,o]=(0,f.useState)(n);return(0,f.useEffect)(()=>{o(n)},[n]),[i,e=>o(e)]})(y,null!=t?t:y);let w=b;const S=n&&Array.isArray(b),C=e=>(0,E.clamp)(Math.round(e/r)*r,s,a),k=(e,t=!0,i=!1)=>{const s=n&&Array.isArray(e)?e.map(C):C(e);(w!==s||i)&&(x(s),(t||o||i)&&(null==g||g(e)),w=s)},P=(0,f.useCallback)(e=>(e-s)/(a-s)*100,[s,a]),R=(0,f.useCallback)(e=>{const t=a-s;return(0,E.clamp)(t*(e/l)+s,s,a)},[s,a,l]),j=(0,f.useCallback)(()=>{if(!n)return p?p(b):void k(b+r)},[r,n,b]),N=(0,f.useCallback)(()=>{if(!n)return m?m(b):void k(b-r)},[r,n,b]),T=(0,f.useCallback)(e=>{const t=e.currentTarget.getBoundingClientRect(),o="horizontal"===c,r=o?t.width:t.height,l=o?t.left:t.top,d=o?e.clientX:e.clientY,u=(0,E.clamp)(d-l,0,r)/r;let h=(a-s)*u+s;if(i&&(h=a-h),n&&Array.isArray(b)){const e=u>.5?1:0,t=[...b];t[e]=h,k(t,!0,!1)}else k(h,!0,!1)},[c,s,a,i,b]),_="horizontal"===c?"minWidth":"minHeight";return(0,ae.jsxs)("div",{className:(0,Nn.cn)("range").mod({align:c}).toClassName(),style:{[_]:l},children:[i?h&&(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("icon").toClassName(),onMouseDown:j,children:h}):u&&(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("icon").toClassName(),onMouseDown:N,children:u}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("range").elem("body").toClassName(),onClick:T,children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("line").toClassName()}),(0,ae.jsx)(Zn,{align:c,reverse:i,value:b,valueConvert:P}),S?Yn(b,i).map((e,t)=>{const n=i?0===t?1:0:t,o=0===n?1:0,r=e=>{const t=[],i=b[o];return t[n]=0===n?(0,E.clamp)(e,s,i):(0,E.clamp)(e,i,a),t[o]=b[o],t};return(0,ae.jsx)(qn,{align:c,value:e,bodySize:l,reverse:i,resetValue:d[n],valueConvert:P,offsetConvert:R,onChangePosition:e=>k(r(e),!1),onChange:e=>k(r(e),!0,!0)},`handle-${n}`)}):(0,ae.jsx)(qn,{align:c,bodySize:l,reverse:i,value:b,valueConvert:P,offsetConvert:R,resetValue:d,onChangePosition:e=>k(e,!1),onChange:e=>k(e,!0,!0)})]}),i?u&&(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("icon").toClassName(),onMouseDown:N,children:u}):h&&(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("icon").toClassName(),onMouseDown:j,children:h})]})},qn=({value:e,valueConvert:t,offsetConvert:n,onChangePosition:i,onChange:o,resetValue:s,align:a,bodySize:r,reverse:l=!1})=>{const c=t(e),d="horizontal"===a?l?"right":"left":l?"bottom":"top",u="horizontal"===a?"pageX":"pageY";return(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("range-handle").toClassName(),style:{[d]:`${t(e)}%`},onMouseDownCapture:e=>{e.stopPropagation();const t=e[u];let s;const a=e=>{const o=l?t-e[u]:e[u]-t,a=(0,E.clamp)(o+c/100*r,0,r);s=n(a),requestAnimationFrame(()=>{null==i||i(s)})},d=e=>{e.stopPropagation(),(0,E.isDefined)(s)&&(null==o||o(s)),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)},onDoubleClick:()=>{(0,E.isDefined)(s)&&(null==o||o(s))}})},Zn=({value:e,valueConvert:t,align:n,reverse:i})=>{const o={},s=Array.isArray(e);return"horizontal"===n?(s?(o.left=`${t(e[0])}%`,o.right=100-t(e[1])+"%"):(o.left=0,o.right=100-t(e)+"%"),i&&!s&&([o.left,o.right]=[o.right,o.left])):"vertical"===n&&(s?(o.top=`${t(e[0])}%`,o.bottom=100-t(e[1])+"%"):(o.top=0,o.bottom=100-t(e)+"%"),i&&!s&&([o.top,o.bottom]=[o.bottom,o.top])),(0,ae.jsx)("div",{className:(0,Nn.cn)("range").elem("indicator").toClassName(),style:o})},Jn=({volume:e=.5,onVolumeChange:t})=>{const n=(0,f.useRef)(e),i={color:"#99A0AE"},o=(0,f.useMemo)(()=>e>.5?(0,ae.jsx)(kn.Xaw,{style:i}):e>0?(0,ae.jsx)(kn.JFg,{style:i}):(0,ae.jsx)(kn.zau,{style:i}),[e]);return(0,ae.jsx)(Xn,{continuous:!0,min:mn.min,max:mn.max,step:mn.step,value:e,minIcon:o,onChange:e=>null==t?void 0:t(Number(e)),onMinIconClick:()=>{0===e?null==t||t(n.current):(n.current=e,null==t||t(0))}})},Qn=({description:e,info:t,max:n,min:i,value:o,step:s=1,showInput:a=!0,onChange:r})=>{const l=(0,f.useRef)(),[c,d]=(0,f.useState)();(0,f.useEffect)(()=>{u()},[o]);const u=()=>{l.current&&(l.current.style.backgroundSize=100*(o-i)/(n-i)+"% 100%")},h=e=>{d(void 0);if(e.currentTarget.value.match(/^[0-9]*\.$/))return void d(e.currentTarget.value);const t=e.currentTarget.value.match(/^\.[0-9]*$/)?`0${e.currentTarget.value}`:e.currentTarget.value,o=Number.parseFloat(t);isNaN(o)?d(e.currentTarget.value):o>n||o<i?d(o):r(e)};return(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-slider").toClassName(),children:[(0,ae.jsx)("input",{ref:l,className:(0,Nn.cn)("audio-slider").elem("range").toClassName(),type:"range",min:i,max:n,step:s,value:o,onChange:h}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-slider").elem("control").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-slider").elem("info").toClassName(),children:[e,t&&(0,ae.jsx)(Pn.m_M,{title:t,children:(0,ae.jsx)(kn.ehj,{})})]}),a&&(0,ae.jsx)("input",{className:(0,Nn.cn)("audio-slider").elem("input").mod(void 0!==c&&("string"==typeof c||c>n||c<i)&&{error:"control"}).toClassName(),type:"text",min:i,max:n,value:void 0===c?o:c,onChange:h})]})]})},ei=100,ti=({volume:e,onVolumeChange:t,onSetModal:n,audioModal:i})=>{const[o,s]=(0,f.useState)(!1);(0,f.useEffect)(()=>{s(e<=0)},[e]);const a=e=>{const n=Number.parseInt(e.currentTarget.value);n?n>ei?null==t||t(1):n<0?null==t||t(0):null==t||t(n/ei):null==t||t(0)},r=()=>{s(!o),null==t||t(o?1:0)},l=()=>(0,ae.jsx)("div",{className:(0,Nn.cn)("audio-control").elem("mute").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("audio-control").elem("mute-button").toClassName(),onClick:r,children:o?"Unmute":"Mute"})});return(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-control").toClassName(),onClick:e=>e.stopPropagation(),children:[(0,ae.jsx)(ki,{look:i?"filled":void 0,onClick:n,children:o?(0,ae.jsx)(Pn.I9Y,{}):(0,ae.jsx)(Pn.$Rd,{})}),i&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-control").elem("modal").toClassName(),children:[(0,ae.jsx)(Qn,{min:0,max:ei,value:Math.round(e*ei),onChange:a,description:"Volume",info:"Increase or decrease the volume of the audio"}),l()]})]})};var ni=n(54645),ii=n.n(ni);const oi=512,si=[64,128,256,512,1024,2048],ai=(si.reduce((e,t,n)=>(e[n]=t.toString(),e),{}),si.indexOf(oi)),ri=e=>{const t=e/4-1;return Math.min(t,64)},li=[{value:"hann",label:"Hann"},{value:"hamming",label:"Hamming"},{value:"blackman",label:"Blackman"},{value:"sine",label:"Sine"},{value:"rectangular",label:"Rectangular"}],ci=e=>`linear-gradient(to right, ${ii()({colormap:e,nshades:16,format:"hex",alpha:1}).join(", ")})`,di=(e,t)=>(0,ae.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"},children:[(0,ae.jsx)("span",{children:e}),(0,ae.jsx)("span",{style:{display:"inline-block",width:"50px",height:"10px",marginLeft:"10px",border:"1px solid var(--sand_300)",background:t}})]}),ui=[{label:di("Autumn",ci("autumn")),value:"autumn",key:"autumn"},{label:di("Bathymetry",ci("bathymetry")),value:"bathymetry",key:"bathymetry"},{label:di("Blackbody",ci("blackbody")),value:"blackbody",key:"blackbody"},{label:di("BlueRed",ci("bluered")),value:"bluered",key:"bluered"},{label:di("Bone",ci("bone")),value:"bone",key:"bone"},{label:di("CDOM",ci("cdom")),value:"cdom",key:"cdom"},{label:di("Chlorophyll",ci("chlorophyll")),value:"chlorophyll",key:"chlorophyll"},{label:di("Cool",ci("cool")),value:"cool",key:"cool"},{label:di("Copper",ci("copper")),value:"copper",key:"copper"},{label:di("Cubehelix",ci("cubehelix")),value:"cubehelix",key:"cubehelix"},{label:di("Density",ci("density")),value:"density",key:"density"},{label:di("Earth",ci("earth")),value:"earth",key:"earth"},{label:di("Electric",ci("electric")),value:"electric",key:"electric"},{label:di("Freesurface Blue",ci("freesurface-blue")),value:"freesurface-blue",key:"freesurface-blue"},{label:di("Freesurface Red",ci("freesurface-red")),value:"freesurface-red",key:"freesurface-red"},{label:di("Greens",ci("greens")),value:"greens",key:"greens"},{label:di("Greys",ci("greys")),value:"greys",key:"greys"},{label:di("Hot",ci("hot")),value:"hot",key:"hot"},{label:di("HSV",ci("hsv")),value:"hsv",key:"hsv"},{label:di("Inferno",ci("inferno")),value:"inferno",key:"inferno"},{label:di("Jet",ci("jet")),value:"jet",key:"jet"},{label:di("Magma",ci("magma")),value:"magma",key:"magma"},{label:di("Oxygen",ci("oxygen")),value:"oxygen",key:"oxygen"},{label:di("PAR",ci("par")),value:"par",key:"par"},{label:di("Phase",ci("phase")),value:"phase",key:"phase"},{label:di("Picnic",ci("picnic")),value:"picnic",key:"picnic"},{label:di("Plasma",ci("plasma")),value:"plasma",key:"plasma"},{label:di("Portland",ci("portland")),value:"portland",key:"portland"},{label:di("Rainbow",ci("rainbow")),value:"rainbow",key:"rainbow"},{label:di("Rainbow Soft",ci("rainbow-soft")),value:"rainbow-soft",key:"rainbow-soft"},{label:di("RdBu",ci("RdBu")),value:"RdBu",key:"RdBu"},{label:di("Salinity",ci("salinity")),value:"salinity",key:"salinity"},{label:di("Spring",ci("spring")),value:"spring",key:"spring"},{label:di("Summer",ci("summer")),value:"summer",key:"summer"},{label:di("Temperature",ci("temperature")),value:"temperature",key:"temperature"},{label:di("Turbidity",ci("turbidity")),value:"turbidity",key:"turbidity"},{label:di("Velocity Blue",ci("velocity-blue")),value:"velocity-blue",key:"velocity-blue"},{label:di("Velocity Green",ci("velocity-green")),value:"velocity-green",key:"velocity-green"},{label:di("Viridis",ci("viridis")),value:"viridis",key:"viridis"},{label:di("Warm",ci("warm")),value:"warm",key:"warm"},{label:di("Winter",ci("winter")),value:"winter",key:"winter"},{label:di("YIGnBu",ci("YIGnBu")),value:"YIGnBu",key:"YIGnBu"},{label:di("YIOrRd",ci("YIOrRd")),value:"YIOrRd",key:"YIOrRd"}].sort((e,t)=>e.value.localeCompare(t.value)),hi=[{value:"linear",label:"Linear Frequency"},{value:"log",label:"Logarithmic Frequency"},{value:"mel",label:"Mel Scale"}],gi=({waveform:e})=>{var t,n,i,o,s,a,r;const{settings:l,changeSetting:c}=(0,f.useContext)(Sn),[d,u]=(0,f.useState)(oi.toString()),[h,g]=(0,f.useState)(!1),m=(0,f.useMemo)(()=>{var e;return null!=(e=null==l?void 0:l.spectrogramFftSamples)?e:oi},[null==l?void 0:l.spectrogramFftSamples]),p=(0,f.useMemo)(()=>{const e=si.indexOf(m);return-1!==e?e:-1!==ai?ai:3},[m]),[v,y]=(0,f.useState)(p),[b,x]=(0,f.useState)(null!=(t=null==l?void 0:l.spectrogramColorScheme)?t:"viridis"),[w,S]=(0,f.useState)(null!=(n=null==l?void 0:l.spectrogramMinDb)?n:-80),[C,k]=(0,f.useState)(null!=(i=null==l?void 0:l.spectrogramMaxDb)?i:-10),[P,R]=(0,f.useState)(null!=(o=null==l?void 0:l.spectrogramScale)?o:"mel");(0,f.useEffect)(()=>{u(m.toString()),g(!1)},[m]),(0,f.useEffect)(()=>{const e=null==l?void 0:l.spectrogramColorScheme;e&&e!==b&&x(e)},[null==l?void 0:l.spectrogramColorScheme]),(0,f.useEffect)(()=>{const e=null==l?void 0:l.spectrogramMinDb,t=null==l?void 0:l.spectrogramMaxDb;void 0!==e&&e!==w&&S(e),void 0!==t&&t!==C&&k(t)},[null==l?void 0:l.spectrogramMinDb,null==l?void 0:l.spectrogramMaxDb]),(0,f.useEffect)(()=>{const e=null==l?void 0:l.spectrogramScale;e&&e!==P&&R(e)},[null==l?void 0:l.spectrogramScale]),(0,f.useEffect)(()=>{var e,t;y(p),u(null!=(e=null==(t=si[p])?void 0:t.toString())?e:oi.toString()),g(!1)},[p]);const[j,N]=(0,f.useState)(null),T=e=>{if(!Array.isArray(e)||2!==e.length)return;const[t,n]=e;if(isNaN(t)||isNaN(n)||t>=n)return;const i=Date.now();if(j&&i-j.time<100){if(j.min===t&&j.max!==n&&n!==C)return;if(j.max===n&&j.min!==t&&t!==w)return}N({min:t,max:n,time:i}),S(t),k(n),null==c||c("spectrogramMinDb",t),null==c||c("spectrogramMaxDb",n)},_=Number(d)>1024||"mel"===P&&(null!=(s=null==l?void 0:l.numberOfMelBands)?s:64)>140,A=null!=(a=null==l?void 0:l.numberOfMelBands)?a:64,I=null!=(r=null==l?void 0:l.spectrogramWindowingFunction)?r:"blackman",M="mel"===P;return(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").toClassName(),children:[_&&(0,ae.jsx)(Pn.m_M,{title:"High FFT or mel band values may cause performance issues or artifacts.",children:(0,ae.jsx)(kn.yO6,{style:{color:"var(--color-warning-icon, #faad14)",position:"absolute",top:1,right:15,width:22,zIndex:10,cursor:"pointer",filter:"drop-shadow(0 2px 6px var(--color-warning-shadow, rgba(0,0,0,0.25)))",transition:"color 0.2s"}})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("slider-container").toClassName(),children:[(0,ae.jsx)(Qn,{min:0,max:si.length-1,step:1,value:v,showInput:!1,onChange:e=>{const t="number"==typeof e?e:Number.parseInt(e.currentTarget.value);if(!isNaN(t)){const e=Math.max(0,Math.min(t,si.length-1)),i=si[e];if(void 0!==i){var n;null==c||c("spectrogramFftSamples",i),y(e),u(i.toString()),g(!1);const t=ri(i);t!==(null!=(n=null==l?void 0:l.numberOfMelBands)?n:64)&&(null==c||c("numberOfMelBands",t))}}}}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("control").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("info").toClassName(),children:["FFT Samples",(0,ae.jsx)(Pn.m_M,{title:"Higher values provide more frequency resolution but increase computation.",children:(0,ae.jsx)(kn.ehj,{})})]}),(0,ae.jsx)("input",{className:(0,Nn.cn)("spectrogram-controls").elem("input").mod({error:h}).toClassName(),type:"text",value:d,onChange:e=>{const t=e.target.value;u(t);const n=Number.parseInt(t);if(!isNaN(n)&&si.includes(n)){g(!1);(e=>{const t="number"==typeof e?e:Number.parseInt(e.currentTarget.value);if(!isNaN(t)){const e=Math.max(0,Math.min(t,si.length-1)),i=si[e];if(void 0!==i){var n;null==c||c("spectrogramFftSamples",i);const e=ri(i);e!==(null!=(n=null==l?void 0:l.numberOfMelBands)?n:64)&&(null==c||c("numberOfMelBands",e))}}})(si.indexOf(n))}else g(!0)}})]})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("spectrogram-controls").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("info").toClassName(),children:["Scale",(0,ae.jsx)(Pn.m_M,{title:"Determines the frequency scale mapping: Linear, Logarithmic, or Mel (perceptual).",children:(0,ae.jsx)(kn.ehj,{})})]}),(0,ae.jsx)(Pn.l6P,{value:P,onChange:e=>{R(e),null==c||c("spectrogramScale",e)},options:hi,style:{width:"100%"}})]}),M&&(0,ae.jsx)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("spectrogram-controls").toClassName(),children:(0,ae.jsx)(Qn,{min:20,max:220,step:1,value:A,description:"Number of Mel Bands",info:"Specifies the number of frequency bands using the Mel scale. ",onChange:e=>{const t="number"==typeof e?e:Number.parseInt(e.currentTarget.value);isNaN(t)||null==c||c("numberOfMelBands",t)}})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("spectrogram-controls").toClassName(),children:[(0,ae.jsx)(Xn,{multi:!0,continuous:!0,min:-120,max:0,step:1,value:[w,C],resetValue:[-80,-10],onChange:e=>{const t=Array.isArray(e)?e:[Number(e)];if(!Array.isArray(t)||2!==t.length)return;let[n,i]=t.map(Math.round);const o=n!==w,s=i!==C;o&&!s?i=C:s&&!o&&(n=w),n=Math.max(-120,Math.min(0,n)),i=Math.max(-120,Math.min(0,i)),n>=i&&(o?n=Math.min(n,i-1):i=Math.max(i,n+1)),T([n,i])},size:200}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("control").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("info").toClassName(),children:["Spectogram dB",(0,ae.jsx)(Pn.m_M,{title:"Controls the range of decibel values shown in the spectrogram. Lower values show quieter sounds.",children:(0,ae.jsx)(kn.ehj,{})})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("input-group").toClassName(),children:[(0,ae.jsx)("input",{className:(0,Nn.cn)("spectrogram-controls").elem("input").toClassName(),type:"number",value:w,onChange:e=>{const t=Number(e.target.value);!isNaN(t)&&t<=C-10&&T([t,C])},min:-120,max:C-10}),(0,ae.jsx)("span",{className:(0,Nn.cn)("spectrogram-controls").elem("separator").toClassName(),children:"to"}),(0,ae.jsx)("input",{className:(0,Nn.cn)("spectrogram-controls").elem("input").toClassName(),type:"number",value:C,onChange:e=>{const t=Number(e.target.value);!isNaN(t)&&t>=w+10&&T([w,t])},min:w+10,max:0})]})]})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("spectrogram-controls").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("label").toClassName(),children:"Windowing Function"}),(0,ae.jsx)(Pn.l6P,{value:I,onChange:e=>{null==c||c("spectrogramWindowingFunction",e)},options:li,style:{width:"100%"}})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("spectrogram-controls").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("spectrogram-controls").elem("label").toClassName(),children:"Color Scheme"}),(0,ae.jsx)(Pn.l6P,{value:b,onChange:e=>{x(e),null==c||c("spectrogramColorScheme",e)},style:{width:"100%"},options:ui,listHeight:320,className:"color-scheme-select"})]})]})},mi=({configModal:e,speed:t,amp:n,onSpeedChange:i,onSetModal:o,onAmpChange:s,toggleVisibility:a,layerVisibility:r,waveform:l})=>{const{settings:c,changeSetting:d}=(0,f.useContext)(Sn),[u,g]=(0,f.useState)(!0),[m,p]=(0,f.useState)(!0),[v,y]=(0,f.useState)(!1),b=(0,f.useRef)(null),x=(0,f.useRef)(null);(0,f.useEffect)(()=>{if(e&&b.current&&x.current){const e=x.current.getBoundingClientRect(),t=b.current;t.style.opacity="0",t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px";requestAnimationFrame(()=>{if(!b.current||!x.current)return;const n=t.getBoundingClientRect(),i=window.innerHeight,o=window.innerWidth,s=10;let a=e.bottom+5,r=e.left;if(a+n.height>i-s){const t=e.top-n.height-5;a=t>s?t:i-n.height-s}a<s&&(a=s),r+n.width>o-s&&(r=o-n.width-s),r<s&&(r=s),t.style.top=`${a}px`,t.style.left=`${r}px`,t.style.opacity="1"})}else b.current&&(b.current.style.opacity="0")},[e]),(0,f.useEffect)(()=>{if(r){var e,t,n;const i=!0;g(null!=(e=null==r||null==r.get?void 0:r.get("timeline"))?e:i),p(null!=(t=null==r||null==r.get?void 0:r.get("waveform"))?t:i),y(null!=(n=null==r||null==r.get?void 0:r.get("spectrogram"))&&n)}},[r]);const w=()=>{g(!u),null==a||a("timeline",!u)},S=()=>{p(!m),null==a||a("waveform",!m),null==a||a("regions",!m)},C=()=>{y(!v),null==a||a("spectrogram",!v)},k=e=>{const t=Number.parseFloat(e.currentTarget.value);isNaN(t)||i(t)},P=e=>{const t=Number.parseFloat(e.currentTarget.value);s(t)};return(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").toClassName(),ref:x,onClick:e=>e.stopPropagation(),children:[(0,ae.jsx)(ki,{look:e?"filled":void 0,onClick:o,"aria-label":"Audio settings",children:(0,ae.jsx)(kn.sKi,{})}),e&&(()=>{const e=(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").elem("modal").toClassName(),ref:b,onClick:e=>e.stopPropagation(),style:{opacity:0,position:"fixed"},children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").elem("scroll-content").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("audio-config").elem("section-header").toClassName(),children:"Playback Settings"}),(0,ae.jsx)(Qn,{min:.5,max:2.5,step:.1,value:t,description:"Playback speed",info:"Increase or decrease the playback speed",onChange:k}),(0,ae.jsx)(Qn,{min:1,max:150,step:.1,value:n,description:"Audio zoom y-axis",info:"Increase or decrease the appearance of amplitude",onChange:P}),(0,ae.jsx)("div",{className:(0,Nn.cn)("audio-config").elem("toggle").toClassName(),children:(0,ae.jsx)(Pn.lMk,{checked:null==c?void 0:c.loopRegion,onChange:e=>null==d?void 0:d("loopRegion",e.target.checked),label:"Loop Regions",labelProps:{size:"small"}})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("audio-config").elem("toggle").toClassName(),children:(0,ae.jsx)(Pn.lMk,{checked:null==c?void 0:c.autoPlayNewSegments,onChange:e=>null==d?void 0:d("autoPlayNewSegments",e.target.checked),label:"Auto-play New Regions",labelProps:{size:"small"}})}),(0,Ne.VS)(Ne.ji)&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("audio-config").elem("section-header").toClassName(),children:"Spectrogram Settings"}),(0,ae.jsx)(gi,{waveform:l})]})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").elem("buttons").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").elem("menu-button").toClassName(),onClick:w,children:[u?"Hide":"Show"," timeline"]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").elem("menu-button").toClassName(),onClick:S,children:[m?"Hide":"Show"," audio wave"]}),(0,Ne.VS)(Ne.ji)&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-config").elem("menu-button").toClassName(),onClick:C,children:[v?"Hide":"Show"," spectrogram"]})]})]});return"undefined"!=typeof document?(0,h.createPortal)(e,document.body):null})()]})};class pi{constructor(e,t,n,i="_"){this.input=void 0,this.maskPattern=void 0,this.proxyChar=void 0,this.numValidate=void 0,this.stringValidate=void 0,this.mask=void 0,this.validators=void 0,this.placeholder=void 0,this.regExp=void 0,this.onChange=void 0,this.input=e,this.maskPattern=t,this.proxyChar=i,this.onChange=n,this.numValidate=/^\d$/,this.stringValidate=/^[a-zA-Z]$/,this.mask=t.split("").map(e=>{let t;return"A"===e?t=this.stringValidate:"1"===e&&(t=this.numValidate),{char:e,validator:t}}),this.validators=this.mask.filter(e=>e.validator),this.placeholder=this.mask.map(e=>e.validator?this.proxyChar:e.char).join("");const o="\\^$*+?.()|{}[]".split(""),s=this.mask.map(e=>{const{validator:t,char:n}=e;return t?t===this.numValidate?"\\d":"[a-zA-Z]":o.includes(n)?`\\${n}`:n}).join("");this.regExp=s,e.pattern=s,e.placeholder=e.placeholder||this.placeholder,e.addEventListener("keydown",this.__inputKeydownMask.bind(this)),e.addEventListener("paste",this.__inputPaste.bind(this)),e.addEventListener("focus",this.__inputFocus.bind(this)),e.addEventListener("blur",this.__inputBlur.bind(this))}parseRaw(e){const t=(e=e||"").replace(/\W/g,"");if(t.length===this.validators.length){if(!t.split("").map((e,t)=>!!e.match(this.validators[t].validator)).reduce((e,t)=>!1!==t&&e))return!1;let e=-1;return this.mask.map(n=>n.validator?(e+=1,t[e]):n.char).join("")}}disconnect(){this.input.addEventListener("keydown",this.__inputKeydownMask.bind(this)),this.input.addEventListener("paste",this.__inputPaste.bind(this)),this.input.addEventListener("focus",this.__inputFocus.bind(this)),this.input.addEventListener("blur",this.__inputBlur.bind(this))}get value(){return this.parseRaw(this.input.value)}parsePartial(e=""){const t=(e=e||"").replace(/\W/g,"");let n=-1;return this.mask.map(e=>e.validator?(n+=1,t[n]||this.proxyChar):e.char||this.proxyChar).join("")||this.placeholder}splice(e,t,n){return e.slice(0,t)+n+e.slice(t+1)}__inputBlur(e){e.target.value===this.placeholder&&this.onChange("")}__inputFocus(e){e.target.value||this.onChange(this.placeholder)}__inputKeydownMask(e){const{selectionStart:t,selectionEnd:n}=e.target,i=e.key;let o=t>this.mask.length-1?this.mask.length-1:t,s=this.mask[o];if(!["Tab","Enter","Escape","ArrowLeft","ArrowRight","Shift"].includes(i)&&!e.metaKey)if(t===n){e.preventDefault();let n=null;if("Backspace"===i?n=1:"Delete"===i&&(n=0),null!==n){const i=this.mask[t-n];if(i){const o=i.validator?this.proxyChar:i.char;this.onChange(this.splice(e.target.value,t-n,o)),e.target.setSelectionRange(t-n,t-n)}return}for(;s&&!s.validator&&i!==s.char;)this.onChange(this.splice(e.target.value,o,s.char)),e.target.setSelectionRange(o+1,o+1),s=this.mask[o+1],o+=1;if(s&&s.validator){if(!!!i.match(s.validator))return e.preventDefault(),!1}this.onChange(this.splice(e.target.value,o,i)),setTimeout(e=>e.setSelectionRange(o+1,o+1),0,e.target)}else setTimeout(()=>{let o=e.target.value;const s="Backspace"===i||"Delete"===i?this.proxyChar:i,a="Backspace"===i||"Delete"===i?t:t+1;for(let e=t;e<n;e++)":"!==o[e]&&(o=`${o.substring(0,e)}${e===t?s:this.proxyChar}${o.substring(e+1,o.length)}`);this.onChange(o),this.input.setSelectionRange(a,a)})}__inputPaste(e){const t=e.clipboardData.getData("text/plain"),n=this.parseRaw(t);!1!==n&&setTimeout(()=>{this.onChange(n)})}}const fi=(0,f.forwardRef)(({text:e,children:t,required:n,placement:i,description:o,size:s,large:a,style:r,simple:l,flat:c},d)=>{const u=l?"div":"label",h={size:s,large:a,flat:c,placement:i,withDescription:!!o,empty:!t};return(0,f.createElement)(u,{ref:d,style:r,"data-required":n,className:(0,Nn.cn)("field-label").mod(h).toClassName()},(0,ae.jsx)("div",{className:(0,Nn.cn)("field-label").elem("text").toClassName(),children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("field-label").elem("content").toClassName(),children:[e,o&&(0,ae.jsx)("div",{className:(0,Nn.cn)("field-label").elem("description").toClassName(),children:o})]})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("field-label").elem("field").toClassName(),children:t}))}),vi=["sidepanel","value","readonly","onChange","label"],yi=e=>{let{sidepanel:t=!1,value:n,readonly:i=!1,onChange:o,label:s}=e,a=(0,Se.A)(e,vi);const r=f.createRef(),[l,c]=(0,f.useState)(n);(0,f.useEffect)(()=>{r.current&&new pi(r.current,"11:11:11:111",e=>{c(e)})},[]),(0,f.useEffect)(()=>{c(d(n||0,!0))},[n]);const d=(0,f.useCallback)((e,t=!1)=>{const n=new Date(1e3*e).toISOString();let i=e>3600?n.substr(11,8):`00:${n.substr(14,5)}`;if(t){const e="00"!==n.substr(11,2);i=n.substr(e?11:14,e?12:9).replace(".",":"),i=e?i:`00:${i}`}return i},[]),u=e=>{const t=e.currentTarget.value.split(":");t[0]=1===t[0].toString().length?`0${t[0].toString()}`:`${t[0]}`,(e=>{const t=e.split(":").reverse();let n=0;if(e.indexOf("_")>=0)return;const i=[e=>e/1e3,e=>e,e=>60*e,e=>60*e*60];t.forEach((e,t)=>{n+=i[t](Number.parseFloat(e))}),o(n)})(t.join(":")),c(d(n||0,!0))},h=e=>{var t;"Enter"===e.key&&(null==(t=e.currentTarget)||null==t.blur||t.blur())},g=(0,ae.jsx)("div",Object.assign({className:(0,Nn.cn)("time-box").mod({sidepanel:t}).toClassName()},a,{children:(0,ae.jsx)("input",{className:(0,Nn.cn)("time-box").elem("input-time").toClassName(),maxLength:12,ref:r,type:"text",readOnly:i,value:l,onKeyDown:h,onChange:()=>{},onBlur:u})}));return s?(0,ae.jsx)(fi,{size:"small",flat:!0,text:s,children:g}):g},bi=({isSidepanel:e=!1,startTime:t,endTime:n=0,minTime:i,maxTime:o=0,currentTime:s,startTimeReadonly:a=!1,endTimeReadonly:r=!1,onChangeStartTime:l,onChangeEndTime:c,showDuration:d=!1,showLabels:u=!1})=>{const h=s||t;return(0,ae.jsxs)("div",{className:(0,Nn.cn)("timer-duration-control").toClassName(),children:[(0,ae.jsx)(yi,{sidepanel:e,readonly:a,value:h,onChange:e=>{e>=i&&e<=o&&e<=n&&(null==l||l(e))},label:u?"Start":void 0,"data-testid":"timebox-current-time"}),(0,ae.jsx)(yi,{sidepanel:e,readonly:r,value:n,onChange:e=>{e>=i&&e<=o&&e>=h&&(null==c||c(e))},"data-testid":"timebox-end-time",label:u?"End":void 0}),d&&(0,ae.jsx)(yi,{sidepanel:e,readonly:!0,value:n-t,onChange:()=>{},"data-testid":"timebox-duration-time",label:u?"Duration":void 0})]})},xi=["length","position","frameRate","playing","buffering","collapsed","duration","extraControls","fullscreen","altHopSize","disableFrames","allowFullscreen","allowViewCollapse","onRewind","onForward","onPlay","onPause","onFullScreenToggle","onStepBackward","onPositionChange","onStepForward","onSpeedChange","onToggleCollapsed","formatPosition","toggleVisibility","layerVisibility","mediaType"],wi=["children","hotkey","hotkeyScope"],Si=({time:e,fps:t})=>{const n=Math.round(t).toString(),i=1e3/t,o=1e3*e%1e3;return Math.round(o/i).toString().padStart(n.length,"0")},Ci=(0,f.memo)(e=>{let{length:t=1e3,position:n,frameRate:i=1024,playing:o,buffering:s=!1,collapsed:a,duration:l,extraControls:c,fullscreen:d,altHopSize:u,disableFrames:h,allowFullscreen:g,allowViewCollapse:m,onRewind:p,onForward:v,onPlay:y,onPause:b,onFullScreenToggle:x,onStepBackward:w,onPositionChange:S,onStepForward:C,onSpeedChange:k,onToggleCollapsed:P,formatPosition:R,toggleVisibility:j,layerVisibility:N,mediaType:T}=e,_=(0,Se.A)(e,xi);const{settings:A}=(0,f.useContext)(Sn),[I,M]=(0,f.useState)(!1),[K,D]=(0,f.useState)(!1),[O,L]=(0,f.useState)(!1),[z,B]=[1===n,n===t],F=(0,f.useMemo)(()=>Math.max((t-1)/i,0),[t,i]),H=(0,f.useMemo)(()=>(n-1)/i,[n,i]),V=Ni(_.customControls),$=(e,t)=>n=>{e(n,null!=t?t:void 0)},W=(0,f.useCallback)(()=>{o?null==b||b():null==y||y()},[o,y,b]),U=e=>{e.stopPropagation(),K&&D(!1),L(!O)},G=e=>{e.stopPropagation(),O&&L(!1),D(!K)},Y=()=>{D(!1),L(!1)};(0,f.useEffect)(()=>{const e=e=>{if(null==A||!A.stepSize)return;const t="Shift"===e.key;"keydown"===e.type&&t&&!I?M(!0):"keyup"===e.type&&t&&I&&M(!1)};return document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("click",Y),()=>{document.removeEventListener("keydown",e),document.removeEventListener("keyup",e),document.removeEventListener("click",Y)}},[I]);return(0,ae.jsxs)(Pn.$xS,{className:(0,Nn.cn)("timeline-controls").toClassName(),spread:!0,style:{gridAutoColumns:"auto"},children:[s&&(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-controls").elem("buffering").toClassName(),"aria-label":"Buffering Media Source"}),"audio"===T?(0,ae.jsxs)(Pn.$xS,{className:(0,Nn.cn)("timeline-controls").elem("group").toClassName(),size:"small",style:{gridAutoColumns:"auto"},children:[(0,ae.jsx)(mi,{onSetModal:G,onAmpChange:_.onAmpChange,onSpectrogramFftSamplesChange:_.onSpectrogramFftSamplesChange,onNumberOfMelBandsChange:_.onNumberOfMelBandsChange,onSpectrogramWindowingFunctionChange:_.onSpectrogramWindowingFunctionChange,onSpectrogramColorSchemeChange:_.onSpectrogramColorSchemeChange,configModal:K,onSpeedChange:e=>null==k?void 0:k(e),speed:_.speed||0,amp:_.amp||0,toggleVisibility:j,layerVisibility:N}),(0,ae.jsx)(ti,{volume:_.volume||0,onVolumeChange:_.onVolumeChange,onSetModal:U,audioModal:O})]}):(0,ae.jsxs)(Pn.$xS,{size:"small",children:[_.controls&&Object.entries(_.controls).map(([e,i])=>{if(!1===i)return;const o=r[e];return(0,E.isDefined)(o)&&(0,ae.jsx)(o,{length:t,position:n-1,volume:_.volume,onPositionChange:S,onVolumeChange:_.onVolumeChange},e)}),null==V?void 0:V.left]}),(0,ae.jsxs)(Pn.$xS,{size:"small",className:"justify-between max-w-[310px]",children:[(0,ae.jsx)(Pn.$xS,{size:"small",children:c}),(0,ae.jsxs)(Pn.$xS,{size:"small",children:[null==V?void 0:V.leftCenter,(0,ae.jsx)(ji,{showAlterantive:I&&!h,main:(0,ae.jsxs)(ae.Fragment,{children:[(null==A?void 0:A.stepSize)&&!h&&(0,ae.jsx)(ki,{onClick:$(w,A.stepSize),hotkey:null==A?void 0:A.stepAltBack,disabled:z,"aria-label":"Hop backward",children:(0,ae.jsx)(kn.rH_,{})}),(0,ae.jsx)(ki,{onClick:$(w),hotkey:null==A?void 0:A.stepBackHotkey,disabled:z,"aria-label":"Step backward",children:(0,ae.jsx)(kn.gu7,{})})]}),alt:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(ki,{onClick:()=>null==p?void 0:p(),disabled:z,hotkey:null==A?void 0:A.skipToBeginning,"aria-label":"Skip to start",children:(0,ae.jsx)(kn.f20,{})}),(0,ae.jsx)(ki,{onClick:()=>null==p?void 0:p(u),disabled:z,hotkey:null==A?void 0:A.hopBackward,"aria-label":"Media rewind",children:(0,ae.jsx)(kn.T9g,{})})]})}),(0,ae.jsx)(ki,{"data-testid":"playback-button:"+(o?"pause":"play"),onClick:W,hotkey:null==A?void 0:A.playpauseHotkey,hotkeyScope:Fn.ALL_SCOPES,"aria-label":"Play",children:o?(0,ae.jsx)(kn.jmo,{}):(0,ae.jsx)(kn.PB1,{})}),(0,ae.jsx)(ji,{showAlterantive:I&&!h,main:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(ki,{onClick:$(C),hotkey:null==A?void 0:A.stepForwardHotkey,disabled:B,"aria-label":"Step forward",children:(0,ae.jsx)(kn.Vjx,{})}),(null==A?void 0:A.stepSize)&&!h&&(0,ae.jsx)(ki,{disabled:B,onClick:$(C,A.stepSize),hotkey:null==A?void 0:A.stepAltForward,"aria-label":"Hop forward",children:(0,ae.jsx)(kn.j3e,{})})]}),alt:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(ki,{onClick:()=>null==v?void 0:v(u),disabled:B,hotkey:null==A?void 0:A.hopForward,"aria-label":"Media fast forward",children:(0,ae.jsx)(kn.ZgM,{})}),(0,ae.jsx)(ki,{"aria-label":"Skip to end",onClick:()=>null==v?void 0:v(),disabled:B,hotkey:null==A?void 0:A.skipToEnd,children:(0,ae.jsx)(kn.jau,{})})]})}),null==V?void 0:V.rightCenter]}),(0,ae.jsxs)(Pn.$xS,{className:(0,Nn.cn)("timeline-controls").elem("group").toClassName(),collapsed:!0,children:[!h&&m&&(0,ae.jsx)(ki,{tooltip:"Toggle Timeline",onClick:()=>null==P?void 0:P(!a),children:a?(0,ae.jsx)(kn.iWI,{}):(0,ae.jsx)(kn.tlL,{})}),g&&(0,ae.jsx)(ki,{tooltip:"Fullscreen",onClick:()=>null==x?void 0:x(!1),children:d?(0,ae.jsx)(kn.ReQ,{}):(0,ae.jsx)(kn.L9n,{})})]})]}),(0,ae.jsx)(Pn.$xS,{className:(0,Nn.cn)("timeline-controls").elem("group").toClassName(),size:"small",children:"audio"===T?(0,ae.jsxs)(ae.Fragment,{children:[null==V?void 0:V.right,(0,ae.jsx)(bi,{startTime:0,endTime:l,minTime:0,maxTime:l,endTimeReadonly:!0,currentTime:n,onChangeStartTime:e=>{S(e)}})]}):(0,ae.jsxs)(ae.Fragment,{children:[null==V?void 0:V.right,(0,ae.jsx)(Pi,{currentTime:H,duration:F,length:t,position:n,framerate:i,formatPosition:R})]})})]})}),ki=e=>{let{children:t,hotkey:n,hotkeyScope:i}=e,o=(0,Se.A)(e,wi);return(0,ae.jsx)($n,{binging:n,hotkeyScope:i,children:(0,ae.jsx)(Pn.$nd,Object.assign({},o,{look:"string",size:"small",variant:"neutral",children:t}))})},Pi=({currentTime:e,position:t,duration:n,framerate:i,length:o,formatPosition:s})=>{const a=null!=s?s:Si,r={position:t-1,fps:i,length:o},l=a(Object.assign({time:e},r)),c=a(Object.assign({time:n},r));return(0,ae.jsxs)("div",{className:(0,Nn.cn)("timeline-controls").elem("time").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-controls").elem("time-section").toClassName(),children:(0,ae.jsx)(Ri,{time:e,position:l})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-controls").elem("time-section").toClassName(),children:(0,ae.jsx)(Ri,{time:Math.max(n,0),position:c})})]})},Ri=({time:e,position:t})=>{const n=new Date(1e3*e).toISOString(),i=e>3600?n.substr(11,8):n.substr(14,5);return(0,ae.jsxs)(ae.Fragment,{children:[i,t?(0,ae.jsx)("span",{children:t}):null]})},ji=e=>e.hidden?null:e.showAlterantive?e.alt:e.main,Ni=e=>{if(!e)return null;return null==e?void 0:e.reduce((e,t)=>{var n;const i=null!=(n=e[t.position])?n:[],o=t.component instanceof Function?t.component():t.component;return i.push(o),e[t.position]=i,e},{})};function Ti(e){const t=(0,f.useRef)(e);return t.current=e,t}function _i(e){const t=Ti(e);return(0,f.useCallback)((...e)=>t.current(...e),[])}const Ai=!1,Ii="OffscreenCanvas"in globalThis;let Mi=function(e){return e[e.timelineHeight=32]="timelineHeight",e.timelinePlacement="top",e}({});const Ei=(e="log")=>(...e)=>{Ai},Ki=(Ei("log"),Ei("warn")),Di=(Ei("error"),Ei("info")),Oi=(e,t,n)=>Math.max(t,Math.min(n,e)),Li=(e,t=2)=>{const n=10**t;return Math.round(e*n)/n},zi=(e,t,n)=>e>=t&&e<=n,Bi=(e,t)=>Array.from({length:t}).map(()=>e).join(""),Fi=e=>{const[t,n]=(e=>{const t=e.length;if(t>0){let n,i,o=0;for(n=i=e[0];o<t;){const t=e[o];t>n?n=t:t<i&&(i=t),o++}return[i,n]}return[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY]})(e);return[Oi(t,-1,1),Oi(n,-1,1)]},Hi=e=>e.getBoundingClientRect().left,Vi=e=>e.getBoundingClientRect().top,$i=(e,t)=>e.clientX-Hi(t),Wi=(e,t)=>e.clientY-Vi(t),Ui=(e,t,n)=>e/t*n,Gi=(e,t,n)=>{const{zoomedWidth:i,container:o}=t,s=$i(e,o)+t.getScrollLeftPx();return Ui(s,i,n)},Yi=(e,t,n)=>((e,t)=>Math.abs(e-t)<1e-6)(e/n,t/n),Xi=(()=>{const e=document.createElement("div");e.style.width="100px",e.style.height="100px",e.style.overflow="scroll",e.style.position="absolute",e.style.top="-9999px",document.body.appendChild(e);const t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t})();class qi{constructor(){this.destroyed=!1}get isDestroyed(){return this.destroyed}destroy(){this.destroyed=!0,this.destroy=()=>null}}class Zi extends qi{constructor(...e){super(...e),this.subscriptions=new Map}on(e,t){const n=this.getSubscriptions(e);!1===n.has(t)&&n.add(t)}off(e,t){const n=this.getSubscriptions(e);n.has(t)&&n.delete(t)}invoke(e,t){this.getSubscriptions(e).forEach(e=>e(...null!=t?t:[]))}removeAllListeners(){this.subscriptions.forEach(e=>e.clear()),this.subscriptions.clear()}destroy(){this.removeAllListeners(),this.on=()=>null,this.off=()=>null,this.invoke=()=>null,this.removeAllListeners=()=>null,super.destroy()}getSubscriptions(e){var t;const n=null!=(t=this.subscriptions.get(e))?t:new Set;return this.subscriptions.set(e,n),n}}const Ji=["play","pause"];function Qi(e){if(!(e instanceof HTMLMediaElement))throw new TypeError("patchPlayPauseMethods expects <audio> | <video>");const t=e;if(t._playPausePatched)return t;return Ji.forEach(e=>{const n=t[e].bind(t);t[e]=()=>{let e=n();return e instanceof Promise&&(e=e.catch(()=>{})),e}}),t._playPausePatched=!0,t}class eo extends Zi{constructor(e){super(),this.src=e,this.chunks=void 0,this.cancelled=!1,this.decodeId=0,this._dataLength=0,this._dataSize=0,this._channelCount=1,this._sampleRate=44100,this._duration=0,this.decodingResolve=void 0,this.decodingPromise=void 0,this.buffer=void 0,this.removalId=null}get channelCount(){return this._channelCount}get sampleRate(){return this._sampleRate}get duration(){return this._duration}get dataLength(){var e,t;this.chunks&&!this._dataLength&&(this._dataLength=(null!=(e=null==(t=this.chunks)?void 0:t.reduce((e,t)=>e+t.reduce((e,t)=>e+t.length,0),0))?e:0)/this._channelCount);return this._dataLength}get dataSize(){var e,t;this.chunks&&!this._dataSize&&(this._dataSize=(null!=(e=null==(t=this.chunks)?void 0:t.reduce((e,t)=>e+t.reduce((e,t)=>e+t.byteLength,0),0))?e:0)/this._channelCount);return this._dataSize}get sourceDecoded(){return void 0!==this.chunks}get sourceDecodeCancelled(){return this.cancelled&&0===this.decodeId}cancel(){this.cancelled||Di("decode:cancelled",this.src),this.cancelled=!0,this.decodeId=0,this.dispose()}renew(){this.cancelled=!1}destroy(){super.removeAllListeners(),this.cancel()}cleanupResolvers(){var e;null==(e=this.decodingResolve)||e.call(this),this.decodingResolve=void 0,this.decodingPromise=void 0,Di("decode:cleanup",this.src)}}class to extends eo{constructor(...e){super(...e),this.arraybuffer=void 0,this.context=void 0}async init(e){this.arraybuffer=e,Di("decode:worker:ready",this.src)}async decode(e){if(this.sourceDecoded)Di("decode:cached",this.src);else{if(this.sourceDecodeCancelled)throw new Error("WebAudioDecoder decode cancelled and contains no data, did you call decoder.renew()?");if(this.decodingPromise)return Di("decode:inprogress",this.src),this.decodingPromise;if(!this.arraybuffer)throw new Error("WebAudioDecoder not initialized, did you call decoder.init()?");Di("decode:start",this.src),this.decodeId=Date.now(),this.decodingPromise=new Promise(e=>this.decodingResolve=e);try{const t=await new Promise((e,t)=>{if(this.context||(this.context=this.createOfflineAudioContext()),!this.context||!this.arraybuffer)return t(new Error("WebAudioDecoder not initialized, did you call decoder.init()?"));var n,i;"webkitAudioContext"in window?null==(n=this.context)||n.decodeAudioData(this.arraybuffer,t=>e(t),e=>t(e)):null==(i=this.context)||i.decodeAudioData(this.arraybuffer).then(e).catch(t)});this._channelCount=null!=e&&e.multiChannel?t.numberOfChannels:1,this._sampleRate=t.sampleRate,this._duration=t.duration;const n=Array.from({length:this._channelCount}).map(()=>Array.from({length:1}));return n.forEach((e,i)=>{n[i]=[t.getChannelData(i)]}),this.chunks=n,Di("decode:complete",this.src),null!=e&&e.captureAudioBuffer&&(this.buffer=t),t}finally{this.dispose()}}}dispose(){delete this.arraybuffer,delete this.context,this.cleanupResolvers()}createOfflineAudioContext(e){return window.WebAudioOfflineAudioContext||(window.WebAudioOfflineAudioContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,null!=e?e:this.sampleRate)),window.WebAudioOfflineAudioContext}}var no=n(56969),io=n(64664);class oo{constructor(e){this.worker=void 0,this.worker=e}async compute(e){var t;const n=await this.sendMessage(this.worker,{data:e,type:"compute"},!0);return null==n||null==(t=n.data)||null==(t=t.result)?void 0:t.data}async precompute(e){await this.sendMessage(this.worker,{data:e,type:"precompute"})}async store(e){await this.sendMessage(this.worker,{data:e,type:"store"})}async getStorage(){var e;const t=await this.sendMessage(this.worker,{type:"getStorage"},!0);return null==t||null==(e=t.data)?void 0:e.result}destroy(){this.worker.terminate()}sendMessage(e,t,n=!1){return new Promise(i=>{const o=Math.random().toString();if(n){const t=n=>{o===n.data.eventId&&(e.removeEventListener("message",t),i(n))};e.addEventListener("message",t)}e.postMessage(Object.assign({},t,{eventId:o})),n||i(void 0)})}}oo.Messenger={receive({compute:e,precompute:t}){const n={};self.addEventListener("message",i=>{if(!i.data)return;const{data:o,type:s,eventId:a}=i.data;switch(s){case"compute":((t,i)=>{e(t,n,e=>{self.postMessage({result:e,eventId:i})})})(o,a);break;case"precompute":(e=>{null==t||t(e,n,e=>{Object.assign(n,e)})})(o);break;case"store":(e=>{Object.assign(n,e.data.data)})(i);break;case"getStorage":(e=>{self.postMessage({result:n,eventId:e})})(a)}})}};class so extends qi{constructor(e){super(),this.channelCount=1,so.usage++,so.worker||(so.worker=new oo(new Worker(new URL(n.p+n.u(559),n.b)))),this.channelCount=e}destroy(){var e;(so.usage--,0===so.usage)&&(null==(e=so.worker)||e.destroy(),so.worker=void 0);super.destroy()}async split(e){if(!so.worker)throw new Error("AudioDecoder: worker not initialized");return so.worker.compute({value:e,channelCount:this.channelCount})}}so.usage=0,so.worker=void 0;class ao extends eo{constructor(...e){super(...e),this.worker=void 0}getTotalChunks(){return Math.ceil(this._duration*this._channelCount/1800)}getChunkDuration(){return 1800/this._channelCount}async init(e){this.worker||(this.worker=await(0,no.vy)(io.A,e),Di("decode:worker:ready",this.src))}async decode(e){if(this.sourceDecoded)return void Di("decode:cached",this.src);if(this.sourceDecodeCancelled)throw new Error("AudioDecoder: Worker decode cancelled and contains no data, did you call decoder.renew()?");if(this.decodingPromise)return Di("decode:inprogress",this.src),this.decodingPromise;if(!this.worker)throw new Error("AudioDecoder: Worker not initialized, did you call decoder.init()?");let t;Di("decode:start",this.src),this.decodeId=Date.now(),this.decodingPromise=new Promise(e=>this.decodingResolve=e);try{this._channelCount=null!=e&&e.multiChannel?this.worker.channelCount:1,this._sampleRate=this.worker.sampleRate,this._duration=this.worker.duration;let n=0;const i=this.getTotalChunks(),o=this.chunkDecoder(e);t=this._channelCount>1?new so(this._channelCount):void 0;const s=Array.from({length:this._channelCount}).map(()=>Array.from({length:i}));for(Di("decode:chunk:start",this.src,n,i),this.invoke("progress",[0,i]);n<i;){if(this.sourceDecodeCancelled)return;const e=o.next();if(!e.done){const o=await e.value;if(this.sourceDecodeCancelled)return;if(o)if(1===this._channelCount)s[0][n]=o;else{if(!t)throw new Error("AudioDecoder: splitChannels not initialized");const e=await t.split(o);if(this.sourceDecodeCancelled)return;e.forEach((e,t)=>{s[t][n]=e})}this.invoke("progress",[n+1,i]),Di("decode:chunk:process",this.src,n,i),n++}if(e.done)break}this.chunks=s,Di("decode:complete",this.src)}finally{var n;null==(n=t)||n.destroy(),this.dispose()}}dispose(){this.worker&&(this.worker.dispose(),this.worker=void 0,Di("decode:worker:disposed",this.src)),this.cleanupResolvers()}*chunkDecoder(e){if(!this.worker||this.sourceDecodeCancelled)return null;const t=this.worker.duration;let n=-1;for(;;)yield new Promise((i,o)=>{var s;if(!this.worker||this.sourceDecodeCancelled)return i(null);const a=Oi(t-n,0,this.getChunkDuration()),r=n;n+=a,this.worker.decodeAudioData(r,a,Object.assign({multiChannel:null!=(s=null==e?void 0:e.multiChannel)&&s},e)).then(i).catch(o)})}}class ro{getDecoder(e,t,n="ffmpeg"){const i=function(e,t,n,i="ffmpeg"){var o;const s=`${t}:${n}:${i}`,a=null!=(o=e.get(s))?o:"ffmpeg"===i?new ao(t):new to(t);return a.renew(),e.set(s,a),new Proxy(a,{get(t,n){if(n in t){const t=e.get(s);null!=t&&t.removalId&&(clearTimeout(t.removalId),Di("decode:renew",s),t.removalId=null,t.renew(),e.set(s,t));const i=t[n];return"destroy"===n&&"function"==typeof i?(...n)=>(t.removalId=setTimeout(()=>{Di("decodepool:destroy",s),e.delete(s)},5e3),e.set(s,t),i.bind(t)(...n)):i}}})}(ro.cache,e,t,n);return i}}ro.cache=new Map;const lo=new ro,co=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING);class uo extends Zi{constructor(e){var t,n,i;super(),this.decoder=void 0,this.decoderPromise=void 0,this.mediaPromise=void 0,this.mediaReject=void 0,this.el=void 0,this.buffer=void 0,this.splitChannels=!1,this.decoderType="ffmpeg",this.playerType="html5",this.src=void 0,this.mediaResolve=void 0,this.hasLoadedSource=!1,this._durationOverride=void 0,this.mediaError=()=>{var e,t;this.hasLoadedSource&&this.el?(this.hasLoadedSource=!1,this.invoke("resetSource")):null==(e=this.mediaReject)||e.call(this,null==(t=this.el)?void 0:t.error)},this.mediaWaiting=()=>{this.el&&this.el.buffered.length>0&&this.el.currentTime>this.el.buffered.end(0)||this.invoke("waiting")},this.mediaReady=()=>{var e;this.mediaResolve&&(null==(e=this.mediaResolve)||e.call(this),this.mediaResolve=void 0);this.hasLoadedSource=!0,this.invoke("canplay")},this.splitChannels=null!=(t=e.splitChannels)&&t,this.decoderType=null!=(n=e.decoderType)?n:this.decoderType,this.playerType=null!=(i=e.playerType)?i:this.playerType,this.src=e.src,this.createAudioDecoder(),this.createMediaElement()}get channelCount(){var e;return(null==(e=this.decoder)?void 0:e.channelCount)||1}get duration(){var e,t,n,i;return void 0!==this._durationOverride?this._durationOverride:this.el?null!=(e=null==(t=this.el)?void 0:t.duration)?e:0:null!=(n=null==(i=this.decoder)?void 0:i.duration)?n:0}get sampleRate(){var e;return(null==(e=this.decoder)?void 0:e.sampleRate)||44100}get dataLength(){var e;return(null==(e=this.decoder)?void 0:e.dataLength)||0}get dataSize(){var e;return(null==(e=this.decoder)?void 0:e.dataSize)||0}disconnect(){var e;try{this.el&&!this.el.paused&&this.el.pause()}catch(e){}null==(e=this.decoder)||e.cancel()}setDurationWithoutDecoding(e){this._durationOverride=e}destroy(){var e,t,n,i;super.destroy(),this.disconnect(),delete this.mediaResolve,delete this.mediaReject,delete this.mediaPromise,delete this.decoderPromise,null==(e=this.decoder)||e.destroy(),delete this.decoder,null==(t=this.el)||t.removeEventListener("error",this.mediaReady),null==(n=this.el)||n.removeEventListener("canplaythrough",this.mediaReady),null==(i=this.el)||i.remove(),delete this.el,delete this.buffer}get chunks(){if(this.decoder)return this.decoder.chunks}async sourceDecoded(){if("none"===this.decoderType)return!0;if(!this.decoder)return!1;try{return this.mediaPromise&&await this.mediaPromise,this.decoderPromise&&await this.decoderPromise,"webaudio"===this.playerType&&this.decoder.buffer&&(this.buffer=this.decoder.buffer),this.decoder.sourceDecoded}catch(e){return console.error(e),!1}}async initDecoder(e){if(this.decoder)return!this.decoderPromise&&e&&(this.decoderPromise=this.decoder.init(e)),this.decoderPromise}async decodeAudioData(e={}){if("none"===this.decoderType)return;if(!this.decoder)return;e.captureAudioBuffer="webaudio"===this.playerType;const t=await this.decoder.decode(e);e.captureAudioBuffer&&t&&(this.buffer=t)}createMediaElement(){this.src&&!this.el&&"html5"===this.playerType&&(this.el=Qi(document.createElement("audio")),this.el.preload="auto",this.el.setAttribute("data-testid","waveform-audio"),this.el.style.display="none",this.el.crossOrigin="anonymous",document.body.appendChild(this.el),this.mediaPromise=new Promise((e,t)=>{this.mediaResolve=e,this.mediaReject=t}),this.el.addEventListener("canplaythrough",this.mediaReady),this.el.addEventListener("error",this.mediaError),co&&this.el.addEventListener("waiting",this.mediaWaiting),this.loadMedia())}loadMedia(){this.src&&this.el&&(this.el.src=this.src)}createAudioDecoder(){"none"!==this.decoderType&&this.src&&!this.decoder&&(this.decoder=lo.getDecoder(this.src,this.splitChannels,this.decoderType),this.decoder.on("progress",(e,t)=>{this.invoke("decodingProgress",[e,t])}))}}class ho extends qi{constructor(e,t){super(),this.wf=void 0,this.audio=void 0,this.loaded=!1,this.options=void 0,this.cancel=void 0,this.decoderResolve=void 0,this._duration=0,this.decoderPromise=void 0,this.loadingProgressType=void 0,this.wf=e,this.options=t,this.cancel=()=>{},this.loadingProgressType="determinate"}get duration(){return this._duration}set duration(e){const t=this._duration!==e;this._duration=e,t&&this.wf.invoke("durationChanged",[e])}get sampleRate(){var e;return(null==(e=this.audio)?void 0:e.sampleRate)||0}reset(){this.cancel(),this.loaded=!1,this.loadingProgressType="determinate",this.decoderResolve=void 0,this.decoderPromise=void 0}async decodeAudioData(){return!this.audio||this.isDestroyed?null:await this.audio.decodeAudioData({multiChannel:this.wf.params.splitChannels})}async load(e){if(this.isDestroyed||this.loaded)return null;if("none"===this.wf.params.decoderType)return await this.loadWithoutDecoding(e);if(this.decoderPromise=new Promise(e=>{this.decoderResolve=e}),this.createAnalyzer(Object.assign({},e,{src:this.options.src,splitChannels:this.wf.params.splitChannels,decoderType:this.wf.params.decoderType,playerType:this.wf.params.playerType})),!this.audio)throw new Error("MediaLoader: Failed to allocate audio decoder");var t;if(await this.audio.sourceDecoded())return this.duration=this.audio.duration,null==(t=this.decoderResolve)||t.call(this),this.audio;const n=await this.performRequest(this.options.src).catch(e=>(console.error("An audio loading error occurred",e),null));if(n)try{var i,o;return await this.audio.initDecoder(n),null==(i=this.decoderResolve)||i.call(this),this.audio?(this.duration=this.audio.duration,await this.decodeAudioData(),null!=(o=this.audio)?o:null):null}catch(e){this.wf.setError(`An error occurred while decoding the audio file. Please select another file or try again. ${e.message}`),console.error("An audio decoding error occurred",e)}return null}async loadWithoutDecoding(e){try{var t;const n="html5";this.wf.params.playerType!==n&&console.warn(`Decoder "none" requires HTML5 player, switching from "${this.wf.params.playerType}"`);const i=new Audio;i.preload="metadata";const o=new Promise((e,t)=>{i.addEventListener("loadedmetadata",()=>e(),{once:!0}),i.addEventListener("error",e=>t(e),{once:!0})});if(i.src=this.options.src,await o,this.createAnalyzer(Object.assign({},e,{src:this.options.src,decoderType:"none",playerType:n})),!this.audio)throw new Error("MediaLoader: Failed to create audio instance");return this.duration=i.duration,this.audio.setDurationWithoutDecoding(i.duration),this.loaded=!0,this.decoderPromise=Promise.resolve(),null==(t=this.decoderResolve)||t.call(this),this.wf.setLoadingProgress(void 0,void 0,!0),this.audio}catch(e){return this.wf.setError(`An error occurred while loading the audio file. Please select another file or try again. ${e.message}`),console.error("An audio loading error occurred",e),null}}destroy(){this.isDestroyed||(super.destroy(),this.reset(),this.audio&&(this.audio.destroy(),this.audio=null))}async performRequest(e){var t=this;const n=new XMLHttpRequest;return this.cancel=()=>{null==n||n.abort(),this.cancel=()=>{}},new Promise((i,o)=>{n.responseType="arraybuffer";const s=()=>{const e=new Error(`HTTP error status: ${n.status}`);e.name="HTTPError",this.wf.setError(`HTTP error status: ${n.status}`,e),o(n)};n.addEventListener("progress",e=>{e.lengthComputable?(this.loadingProgressType="determinate",this.wf.setLoadingProgress(e.loaded,e.total)):(this.loadingProgressType="indeterminate",this.wf.setLoadingProgress(e.loaded,-1))}),n.addEventListener("load",async function(){t.wf.setLoadingProgress(void 0,void 0,!0),i(n.response)}),n.addEventListener("error",()=>{s()}),n.addEventListener("readystatechange",()=>{4===n.readyState&&n.status>=400&&0!==n.status&&s()});const a=new URL(e,/^https?/.exec(e)?void 0:window.location.href);["X-Goog-Signature","X-Amz-Signature","sig"].some(e=>a.searchParams.has(e))||a.searchParams.set("lsref","1"),n.open("GET",a.toString(),!0),n.send()})}createAnalyzer(e){return this.audio||(this.audio=new uo(e),this.audio.on("decodingProgress",(e,t)=>{this.wf.setDecodingProgress(e,t)})),this.audio}}const go=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING);class mo extends qi{constructor(e){var t,n,i;super(),this.audio=void 0,this.wf=void 0,this.timer=void 0,this.loop=null,this.timestamp=0,this.time=0,this.connected=!1,this.bufferPromise=void 0,this.bufferResolve=void 0,this.ended=!1,this._rate=1,this._volume=1,this._savedVolume=1,this.buffering=!1,this._buffering=!1,this.playing=!1,this.hasPlayed=!1,this.handlePlayed=()=>{this.hasPlayed=!0},this.handlePaused=()=>{this.hasPlayed=!1},this.handleEnded=()=>{this.loop||this.updateCurrentTime(!0)},this.handleCanPlay=()=>{var e;go?this.updateBuffering():null==(e=this.bufferResolve)||e.call(this)},this.handleWaiting=()=>{go&&this.updateBuffering()},this.updateBufferingTimeoutId=null,this.watch=()=>{this.playing&&(go&&this.buffering||(this.updateCurrentTime(),this.updateLoop(this.time)),this.timer=requestAnimationFrame(this.watch))},this.wf=e,this._rate=null!=(t=e.params.rate)?t:this._rate,this.volume=null!=(n=e.params.volume)?n:this._volume,this._savedVolume=this.volume,this.buffering=null!=(i=e.params.buffering)?i:this.buffering,e.params.muted&&(this.muted=!0)}get currentTime(){return this.time}set currentTime(e){this.ended=!1,this.setCurrentTime(e,!0)}setCurrentTime(e,t=!1){const n=this.time!==e;this.time=e,this.updateCurrentSourceTime(n),t&&n&&this.wf.invoke("seek",[this.time])}canPause(){return this.hasPlayed}get volume(){var e;return null!=(e=this._volume)?e:1}set volume(e){this.volume!==e&&(0===e?this.muted=!0:this.muted?this.muted=!1:this._volume=e,this.adjustVolume(),this.wf.invoke("volumeChanged",[this.volume]))}get muted(){return 0===this._volume}set muted(e){this.muted!==e&&(e?this.mute():this.unmute(),this.wf.invoke("muted",[this.muted]))}mute(){this._savedVolume=this.volume||1,this._volume=0}unmute(){this._volume=this._savedVolume||1}get rate(){return this._rate}set rate(e){const t=this._rate!==e;this._rate=e,t&&this.wf.invoke("rateChanged",[e])}get duration(){var e,t;return null!=(e=null==(t=this.audio)?void 0:t.duration)?e:0}init(e){this.audio=e,this.audio.on("canplay",this.handleCanPlay),this.audio.on("waiting",this.handleWaiting)}seek(e){const t=Oi(e,0,this.duration);this.currentTime=t,this.playing&&this.updatePlayback()}seekSilent(e){const t=Oi(e,0,this.duration);this.ended=!1,this.setCurrentTime(t),this.playing&&this.updatePlayback()}play(e,t){if(this.isDestroyed||this.playing||!this.audio)return;this.ended&&(this.currentTime=null!=e?e:0);const{start:n,end:i}=this.playSelection(e,t);this.playRange(n,i)}playEnded(){this.ended=!0,this.pause(),this.wf.invoke("playend")}pause(){!this.isDestroyed&&this.playing&&this.audio&&(this.stopWatch(),this.disconnectSource(),this.playing=!1,this.loop=null,this.wf.invoke("pause"),this.wf.invoke("seek",[this.currentTime]))}stop(){this.isDestroyed||(this.stopWatch(),this.disconnectSource(),this.playing=!1,this.loop=null)}destroy(){this.stop(),this.cleanupSource(),this.bufferPromise=void 0,this.bufferResolve=void 0,super.destroy()}updateBuffering(){this.updateBufferingTimeoutId&&(clearTimeout(this.updateBufferingTimeoutId),this.updateBufferingTimeoutId=null);const e=this.audio.el;if(!e)return;const t=e.networkState===e.NETWORK_LOADING;var n;(this._buffering!==t&&(this._buffering=t,this.wf.invoke("buffering",[t])),t)?this.updateBufferingTimeoutId=setTimeout(()=>{this.updateBuffering()},16):null==(n=this.bufferResolve)||n.call(this)}updatePlayback(){const{start:e,end:t}=this.playSelection();this.playSource(e,t)}playRange(e,t){e&&(this.currentTime=e),this.playSource(e,t),this.wf.invoke("play")}playSource(e,t){var n;this.stopWatch(),this.connectSource(),this.audio&&(this.playing=!0,this.loop&&((this.currentTime<this.loop.start||this.currentTime>this.loop.end)&&(this.currentTime=this.loop.start),t=Oi(this.loop.end,0,this.duration),e=Oi(this.loop.start,0,t)),this.playAudio(e,t),null==(n=this.updateBuffering)||n.call(this))}playSelection(e,t){const n=this.wf.regions.selected;if(n.length>0){const e=Math.min(...n.map(e=>e.start)),t=Math.max(...n.map(e=>e.end));let i=this.currentTime;return(i<e||i>=t)&&(i=e),this.loop={start:e,end:t},{start:i,end:t}}const i=null!=e?e:this.currentTime;return{start:i,end:void 0!==t?t-i:void 0}}connectSource(){this.isDestroyed||!this.audio||this.connected||(this.connected=!0,this.canPause()&&this.audio.disconnect())}disconnectSource(){return!(this.isDestroyed||!this.audio||!this.connected)&&(this.connected=!1,this.canPause()&&this.audio.disconnect(),!0)}cleanupSource(){!this.isDestroyed&&this.audio&&(this.disconnectSource(),this.audio.destroy(),delete this.audio)}updateLoop(e){!this.isDestroyed&&this.loop&&e>=this.loop.end&&(this.wf.settings.loopRegion?(this.currentTime=this.loop.start,this.playing=!1,this.play()):this.pause())}updateCurrentTime(e=!1){var t,n;const i=performance.now(),o=(i-this.timestamp)/1e3*this.rate;this.timestamp=i;const s=null!=(t=null==(n=this.loop)?void 0:n.end)?t:this.duration,a=e?this.duration:Oi(this.time+o,0,s);this.time=a,!this.loop&&this.time>=this.duration-o?(this.time=this.duration,this.wf.invoke("playing",[this.duration]),this.playEnded()):this.wf.invoke("playing",[this.time])}stopWatch(){cancelAnimationFrame(this.timer)}}class po extends mo{constructor(...e){var t;super(...e),t=this,this.handleResetSource=async function(){var e;if(null==(e=t.audio)||!e.el)return;const n=t.playing;t.stop(),He.ff.isActive(He.ff.FF_SYNCED_BUFFERING)||t.audio.el.load(),n&&t.play()}}mute(){var e;super.mute(),null!=(e=this.audio)&&e.el&&(this.audio.el.muted=!0)}unmute(){var e;super.unmute(),null!=(e=this.audio)&&e.el&&(this.audio.el.muted=!1)}get rate(){var e;return null!=(e=this.audio)&&e.el&&this.audio.el.playbackRate!==this._rate&&(this.audio.el.playbackRate=this._rate),this._rate}set rate(e){const t=this._rate!==e;var n;(this._rate=e,t)&&(null!=(n=this.audio)&&n.el&&(this.audio.el.playbackRate=e),this.wf.invoke("rateChanged",[e]))}init(e){super.init(e),this.audio&&this.audio.el&&(this.audio.on("resetSource",this.handleResetSource),this.audio.el.addEventListener("play",this.handlePlayed),this.audio.el.addEventListener("pause",this.handlePaused))}destroy(){var e;super.destroy(),null!=(e=this.audio)&&e.el&&(this.audio.el.removeEventListener("play",this.handlePlayed),this.audio.el.removeEventListener("pause",this.handlePaused))}adjustVolume(){var e;null!=(e=this.audio)&&e.el&&(this.audio.el.volume=this.volume)}playAudio(e,t){if(!this.audio||!this.audio.el)return;this.audio.el.currentTime=this.currentTime,this.audio.el.addEventListener("ended",this.handleEnded),this.bufferPromise=new Promise(e=>{this.bufferResolve=e});const n=this.currentTime;Promise.all([this.audio.el.play(),this.bufferPromise]).then(()=>{var e;this.timestamp=performance.now(),null!=(e=this.audio)&&e.el&&(this.setCurrentTime(n),this.audio.el.currentTime=this.currentTime,this.watch())})}updateCurrentSourceTime(e){var t;e&&null!=(t=this.audio)&&t.el&&(this.audio.el.currentTime=this.time)}canPause(){var e;return!(null==(e=this.audio)||!e.el||this.audio.el.paused||!this.hasPlayed)}disconnectSource(){var e;return!!super.disconnectSource()&&(null==(e=this.audio)||null==(e=e.el)||e.removeEventListener("ended",this.handleEnded),!0)}}class fo extends mo{constructor(e){super(e),this.audioContext=void 0,this.audioBufferSource=void 0,this.gainNode=void 0,this.audioContext=new AudioContext,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}async init(e){super.init(e),this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume()}get rate(){var e;return null!=(e=this.audioBufferSource)&&e.playbackRate&&this._rate!==this.audioBufferSource.playbackRate.value&&(this.audioBufferSource.playbackRate.value=this._rate),this._rate}set rate(e){const t=this._rate!==e;var n;(this._rate=e,t)&&(null!=(n=this.audioBufferSource)&&n.playbackRate&&(this.audioBufferSource.playbackRate.value=this._rate),this.wf.invoke("rateChanged",[e]))}adjustVolume(){this.gainNode&&(this.gainNode.gain.value=this.volume)}destroy(){super.destroy(),this.audioContext&&this.audioContext.close().finally(()=>{delete this.audioContext})}playAudio(e,t){if(this.audioBufferSource){try{e?this.audioBufferSource.start(0,e):this.audioBufferSource.start(0)}catch(e){if("InvalidStateError"!==e.name)throw e}this.timestamp=performance.now(),this.watch()}}connectSource(){var e;!this.isDestroyed&&this.audioContext&&null!=(e=this.audio)&&e.buffer&&this.gainNode&&!this.connected&&(this.connected=!0,this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=this.audio.buffer,this.audioBufferSource.connect(this.gainNode),this.audioBufferSource.onended=this.handleEnded)}disconnectSource(){if(this.isDestroyed||!this.connected||!this.audioBufferSource)return!1;this.connected=!1;try{this.audioBufferSource.stop()}catch(e){if("InvalidStateError"!==e.name)throw e}return this.audioBufferSource.disconnect(),this.audioBufferSource.onended=null,this.audioBufferSource=void 0,!0}playSource(e,t){this.disconnectSource(),super.playSource(e,t)}updateCurrentSourceTime(e){e&&this.audioBufferSource&&(this.disconnectSource(),this.connectSource(),this.audioBufferSource.start(0,this.time))}cleanupSource(){super.cleanupSource(),this.audioBufferSource=void 0}}const vo=e=>Number.parseInt(e.replace(/_/g,""),36),yo="1q29ehhb 1n09sgk7 1kl1ekf_ _yl4zsno 16z9eiv3 1p29lhp8 _bd9zg04 17u0____ _iw9zhe5 _to73___ _r45e31e _7l6g016 _jh8ouiv _zn3qba8 1jy4zshs 11u87k0u 1ro9yvyo 1aj3xael 1gz9zjz0 _3w8l4xo 1bf1ekf_ _ke3v___ _4rrkb__ 13j776yz _646mbhl _nrjr4__ _le6mbhl 1n37ehkb _m75f91n _qj3bzfz 1939yygw 11i5z6x8 _1k5f8xs 1509441m 15t5lwgf _ae2th1n _tg1ugcv 1lp1ugcv 16e14up_ _h55rw7n _ny9yavn _7a11xb_ 1ih442g9 _pv442g9 1mv16xof 14e6y7tu 1oo9zkds 17d1cisi _4v9y70f _y98m8kc 1019pq0v 12o9zda8 _348j4f4 1et50i2o _8epa8__ _ts6senj 1o350i2o 1mi9eiuo 1259yrp0 1ln80gnw _632xcoy 1cn9zldc _f29edu4 1n490c8q _9f9ziet 1b94vk74 _m49zkct 1kz6s73a 1eu9dtog _q58s1rz 1dy9sjiq __u89jo3 _aj5nkwg _ld89jo3 13h9z6wx _qa9z2ii _l119xgq _bs5arju 1hj4nwk9 1qt4nwk9 1ge6wau6 14j9zlcw 11p1edc_ _ms1zcxe _439shk6 _jt9y70f _754zsow 1la40eju _oq5p___ _x279qkz 1fa5r3rv _yd2d9ip _424tcku _8y1di2_ _zi2uabw _yy7rn9h 12yz980_ __39ljp6 1b59zg0x _n39zfzp 1fy9zest _b33k___ _hp9wq92 1il50hz4 _io472ub _lj9z3eo 19z9ykg0 _8t8iu3a 12b9bl4a 1ak5yw0o _896v4ku _tb8k8lv _s59zi6t _c09ze0p 1lg80oqn 1id9z8wb _238nba5 1kq6wgdi _154zssg _tn3zk49 _da9y6tc 1sg7cv4f _r12jvtt 1gq5fmkz 1cs9rvci _lp9jn1c _xw1tdnb 13f9zje6 16f6973h _vo7ir40 _bt5arjf _rc45e4t _hr4e100 10v4e100 _hc9zke2 _w91egv_ _sj2r1kk 13c87yx8 _vqpds__ _ni8ggk8 _tj9yqfb 1ia2j4r4 _7x9b10u 1fc9ld4j 1eq9zldr _5j9lhpx _ez9zl6o _md61fzm".split(" ").reduce((e,t)=>{const n=vo(t.substring(0,3)),i=vo(t.substring(3)).toString(16);let o="";for(let e=0;e<6-i.length;e++)o+="0";return e[n]=`${o}${i}`,e},{}),bo=new RegExp(`^#${Bi("([a-f0-9])",3)}([a-f0-9])?$`,"i"),xo=new RegExp(`^#${Bi("([a-f0-9]{2})",3)}([a-f0-9]{2})?$`,"i"),wo=new RegExp(`^rgba?\\(\\s*(\\d+)\\s*${Bi(",\\s*(\\d+)\\s*",2)}(?:,\\s*([\\d.]+))?\\s*\\)$`,"i"),So=/^[a-z]+$/i;class Co{constructor(e){this.base=void 0,this.rgba=void 0,this.base=e,this.rgba=e}update(e){const t=Po(e);return this.rgba=t.rgba,this.base=t.base,this}reset(){return this.rgba=this.base,this}clone(){return new Co(this.rgba)}opaque(e){const t=[this.r,this.g,this.b,Oi(Li(this.a+this.a*e,1),0,1)];return this.rgba=t,this}translucent(e){const t=[this.r,this.g,this.b,Oi(Li(this.a-this.a*e,1),0,1)];return this.rgba=t,this}darken(e){const t=[Oi(Math.round(this.r-this.r*e),0,255),Oi(Math.round(this.g-this.g*e),0,255),Oi(Math.round(this.b-this.b*e),0,255),this.a];return this.rgba=t,this}lighten(e){const t=[Oi(Math.round(this.r+this.r*e),0,255),Oi(Math.round(this.g+this.g*e),0,255),Oi(Math.round(this.b+this.b*e),0,255),this.a];return this.rgba=t,this}get luminance(){const[e,t,n]=this.rgba.map(e=>{const t=e/255;return t<=.03928?t/12.92:((t+.055)/1.055)**2.4});return.2126*e+.7152*t+.0722*n}get r(){return this.rgba[0]}set r(e){this.rgba[0]=e}get g(){return this.rgba[1]}set g(e){this.rgba[1]=e}get b(){return this.rgba[2]}set b(e){this.rgba[2]=e}get a(){return this.rgba[3]}set a(e){this.rgba[3]=e}toArray(){return this.rgba}toString(){return`rgba(${this.rgba.join(", ")})`}}const ko=new Co([0,0,0,0]),Po=e=>{if("string"!=typeof e&&!(e instanceof Co))throw new Error(`Color must be a string or an instanceof RgbaColorArray. Received ${JSON.stringify(e)}`);if(e instanceof Co)return e;if("transparent"===(e=e.toString()).trim().toLowerCase())return ko;let t=e.trim();t=So.test(e)?(e=>{const t=e.toLowerCase().trim(),n=yo[(e=>{let t=5381,n=e.length;for(;n;)t=33*t^e.charCodeAt(--n);return(t>>>0)%2341})(t)];if(!n)throw new Error(`Unknown color: ${e}`);return`#${n}`})(e):e;const n=bo.exec(t);if(n){const e=Array.from(n).slice(1);return new Co([...e.slice(0,3).map(e=>Number.parseInt(Bi(e,2),16)),Number.parseInt(Bi(e[3]||"f",2),16)/255])}const i=xo.exec(t);if(i){const e=Array.from(i).slice(1);return new Co([...e.slice(0,3).map(e=>Number.parseInt(e,16)),Number.parseInt(e[3]||"ff",16)/255])}const o=wo.exec(t);if(o){const e=Array.from(o).slice(1);return new Co([...e.slice(0,3).map(e=>Number.parseInt(e,10)),Number.parseFloat(e[3]||"1")])}return ko};class Ro{constructor(e){var t,n,i,o,s;this.id="tooltip",this.visible=!1,this.color=Po("#fff"),this.fontWeight="500",this.backgroundColor=Po("#000"),this.fontSize=16,this.paddingInline=8,this.paddingBlock=4,this.borderRadius=4,this.id=`tooltip-${(0,A.Ak)()}`,this.color=null!=e&&e.color?Po(e.color):this.color,this.backgroundColor=null!=e&&e.backgroundColor?Po(e.backgroundColor):this.backgroundColor,this.paddingInline=null!=(t=null==e?void 0:e.paddingInline)?t:this.paddingInline,this.paddingBlock=null!=(n=null==e?void 0:e.paddingBlock)?n:this.paddingBlock,this.borderRadius=null!=(i=null==e?void 0:e.borderRadius)?i:this.borderRadius,this.fontSize=null!=(o=null==e?void 0:e.fontSize)?o:this.fontSize,this.fontWeight=null!=(s=null==e?void 0:e.fontWeight)?s:this.fontWeight,this.initialize()}initialize(){if(document.getElementById(this.id))return;const e=document.createElement("span"),t=document.body;e.id=this.id,e.style.display="none",e.style.position="absolute",this.apply(e),null==t||t.appendChild(e)}update(e){var t,n,i,o;const s=document.getElementById(this.id);this.color=null!=e&&e.color?Po(e.color):this.color,this.backgroundColor=null!=e&&e.backgroundColor?Po(e.backgroundColor):this.backgroundColor,this.paddingInline=null!=(t=null==e?void 0:e.paddingInline)?t:this.paddingInline,this.paddingBlock=null!=(n=null==e?void 0:e.paddingBlock)?n:this.paddingBlock,this.borderRadius=null!=(i=null==e?void 0:e.borderRadius)?i:this.borderRadius,this.fontSize=null!=(o=null==e?void 0:e.fontSize)?o:this.fontSize,s&&this.apply(s)}apply(e){e.style.color=this.color.toString(),e.style.backgroundColor=this.backgroundColor.toString(),e.style.paddingInline=`${this.paddingInline}px`,e.style.paddingBlock=`${this.paddingBlock}px`,e.style.borderRadius=`${this.borderRadius}px`,e.style.fontSize=`${this.fontSize}px`,e.style.fontWeight=this.fontWeight,e.style.zIndex="9999",e.style.pointerEvents="none"}show(e,t,n,i=!0){const o=document.getElementById(this.id);this.visible=!0,o&&n&&(o.style.display="block",o.style.left=i?e-o.clientWidth/2+"px":`${e}px`,o.style.top=`${t}px`,o.innerText=n)}hide(){if(!this.visible)return;const e=document.getElementById(this.id);this.visible=!1,e&&(e.style.display="none")}destroy(){var e;null==(e=document.getElementById(this.id))||e.remove()}}let jo=function(e){return e.auto="auto",e.crosshair="crosshair",e.default="default",e.pointer="pointer",e.move="move",e.text="text",e.wait="wait",e.help="help",e.progress="progress",e.notAllowed="not-allowed",e.contextMenu="context-menu",e.cell="cell",e.verticalText="vertical-text",e.alias="alias",e.copy="copy",e.noDrop="no-drop",e.allScroll="all-scroll",e.colResize="col-resize",e.rowResize="row-resize",e.grab="grab",e.grabbing="grabbing",e.nResize="n-resize",e.neResize="ne-resize",e.nwResize="nw-resize",e.nsResize="ns-resize",e.neswResize="nesw-resize",e.nwseResize="nwse-resize",e.sResize="s-resize",e.seResize="se-resize",e.swResize="sw-resize",e.wResize="w-resize",e.ewResize="ew-resize",e.zoomIn="zoom-in",e.zoomOut="zoom-out",e}({});class No extends Zi{constructor(e,t){var n,i,o;super(),this.visualizer=void 0,this.symbol=jo.default,this.focusId="",this.id="cursor",this.color="var(--color-neutral-border)",this.x=void 0,this.y=void 0,this.offsetX=0,this.offsetY=0,this.width=2,this.handleMouseMove=e=>{const{container:t}=this.visualizer;this.offsetX=Hi(t),this.offsetY=Vi(t),this.x=$i(e,t),this.y=Wi(e,t),this.invoke("mouseMove",[e,this]),this.visualizer.invoke("mouseMove",[e,this])},this.id=`cursor-${(0,A.Ak)()}`,this.visualizer=t,this.color=null!=e&&e.color?Po(e.color):this.color,this.x=null!=(n=e.x)?n:0,this.y=null!=(i=e.y)?i:0,this.width=null!=(o=e.width)?o:this.width,this.initialize()}initialize(){if(document.getElementById(this.id))return;const e=document.createElement("span"),t=document.body;e.id=this.id,e.style.display="none",e.style.position="absolute",this.apply(e),null==t||t.appendChild(e),this.set(this.symbol),document.addEventListener("mousemove",this.handleMouseMove)}apply(e){e.style.backgroundColor=this.color.toString(),e.style.width=`${this.width}px`,e.style.top="0px",e.style.zIndex="9998",e.style.pointerEvents="none"}show(){if(!this.shouldRender)return void this.hide();const e=document.getElementById(this.id);e&&(e.style.height=`${this.visualizer.height}px`,e.style.display="block",e.style.top=`${this.offsetY}px`,e.style.left=this.x+this.offsetX-e.clientWidth/2+"px")}hide(){const e=document.getElementById(this.id);e&&(e.style.display="none")}destroy(){var e;null==(e=document.getElementById(this.id))||e.remove(),document.removeEventListener("mousemove",this.handleMouseMove),super.destroy()}isOver(e,t,n,i){return!(this.x>e+n||this.y>t+i||this.x<e||this.y<t)}isFocused(e){return this.focusId===e}hasFocus(){return""!==this.focusId}get(){return this.symbol}set(e,t=""){this.focusId=t||"",e!==this.symbol&&(this.symbol=e,this.visualizer.container.style.cursor=this.symbol,this.hasFocus()?this.visualizer.lockSeek():this.visualizer.unlockSeek())}get shouldRender(){return this.inView}get inView(){const{width:e,height:t}=this.visualizer;return this.isOver(0,0,e,t)}}const To=["actualBoundingBoxAscent","actualBoundingBoxDescent","actualBoundingBoxLeft","actualBoundingBoxRight","fontBoundingBoxAscent","fontBoundingBoxDescent","width"];class _o extends Zi{get context(){return this._context}get width(){return this.canvas.width}set width(e){this.canvas&&(this.canvas.width=e*this.pixelRatio,this.canvas instanceof HTMLCanvasElement&&(this.canvas.style.width=`${e}px`))}get height(){return this.canvas.height}set height(e){this.canvas&&(this.canvas.height=e*this.pixelRatio,this.canvas instanceof HTMLCanvasElement&&(this.canvas.style.height=`${e}px`))}get isGroup(){return!1}constructor(e){var t,n,i,o,s,a,r,l;super(),this.container=void 0,this.group=void 0,this.options=void 0,this._context=void 0,this._bufferContext=void 0,this._bufferCanvas=void 0,this.compositeOperation="source-over",this.compositeAsGroup=!1,this.opacity=1,this.pixelRatio=1,this.name=void 0,this.index=1,this.offscreen=!1,this.canvas=void 0,this.isVisible=!0,this.options=e,this.name=e.name,this.group=null!=(t=e.group)?t:void 0,this.container=e.container,this.offscreen=null!=(n=e.offscreen)&&n,this.pixelRatio=null!=(i=e.pixelRatio)?i:1,this.index=null!=(o=e.index)?o:this.index,this.compositeOperation=null!=(s=e.compositeOperation)?s:this.compositeOperation,this.compositeAsGroup=null!=(a=e.compositeAsGroup)?a:this.compositeAsGroup,this.opacity=null!=(r=e.opacity)?r:this.opacity,this.isVisible=null==(l=e.isVisible)||l,this.createCanvas()}setVisibility(e){if(this.isVisible=e,e){var t,n;const e=this.container.clientWidth,i=null!=(t=null!=(n=this.options.height)?n:this.container.clientHeight)?t:100;this.setSize(e,i),this.canvas instanceof HTMLCanvasElement&&(this.canvas.style.visibility="visible"),this.context.resetTransform()}else this.canvas instanceof HTMLCanvasElement&&(this.canvas.style.visibility="hidden");this.save(),this.invoke("layerUpdated",[this])}show(){this.setVisibility(!0)}hide(){this.setVisibility(!1)}moveTo(e,t){var n;null==(n=this.context)||n.moveTo(e*this.pixelRatio,t*this.pixelRatio)}lineTo(e,t){var n;null==(n=this.context)||n.lineTo(e*this.pixelRatio,t*this.pixelRatio)}fillRect(e,t,n,i){var o;null==(o=this.context)||o.fillRect(e*this.pixelRatio,t*this.pixelRatio,n*this.pixelRatio,i*this.pixelRatio)}roundRect(e,t,n,i,o){var s,a,r;null==(s=this.context)||s.beginPath(),null==(a=this.context)||a.roundRect(e*this.pixelRatio,t*this.pixelRatio,n*this.pixelRatio,i*this.pixelRatio,o),null==(r=this.context)||r.fill()}fillText(e,t,n,i){var o;null==(o=this.context)||o.fillText(e,t*this.pixelRatio,n*this.pixelRatio,i)}fitText(e,t,n,i){if(!this.context)return;const o=i/this.pixelRatio,s=this.measureText("...").width;let a=this.measureText(e).width,r=e;if(a<=o||a<=s)r=e;else{let t=e.length;for(;a>=o-s&&t-- >0;)r=e.substring(0,t),a=this.measureText(r).width;r+="..."}this.fillText(r,t,n,i)}measureText(e){if(!this.context)return{width:0};const t=this.context.measureText(e),n={};return To.forEach(e=>{n[e]=t[e]}),n}save(){var e;null==(e=this.context)||e.save()}restore(){var e;null==(e=this.context)||e.restore()}beginPath(){var e;null==(e=this.context)||e.beginPath()}closePath(){var e;null==(e=this.context)||e.closePath()}stroke(){var e;null==(e=this.context)||e.stroke()}fill(){var e;null==(e=this.context)||e.fill()}copyToBuffer(){this.createBufferCanvas(),this._bufferCanvas.width=this.canvas.width,this._bufferCanvas.height=this.canvas.height,this._bufferContext.imageSmoothingEnabled=!1,this._bufferContext.clearRect(0,0,this._bufferCanvas.width,this._bufferCanvas.height),this._bufferContext.drawImage(this.canvas,0,0)}restoreFromBuffer(e=0,t=0){this.clear(),this.context.drawImage(this._bufferCanvas,e*this.pixelRatio,t*this.pixelRatio)}shift(e,t){this.copyToBuffer(),this.restoreFromBuffer(e,t)}set strokeStyle(e){this.context&&(this.context.strokeStyle=e)}get strokeStyle(){return this.context?this.context.strokeStyle:""}set fillStyle(e){this.context&&(this.context.fillStyle=e)}get fillStyle(){return this.context?this.context.fillStyle:""}set lineWidth(e){this.context&&(this.context.lineWidth=e*this.pixelRatio)}get lineWidth(){return this.context?this.context.lineWidth/this.pixelRatio:0}set font(e){this.context&&(this.context.font=e)}get font(){return this.context?this.context.font:""}clear(){this.context&&(this.context.globalAlpha=this.compositeAsGroup?Oi(1.5*this.opacity,0,1):this.opacity,this.context.globalCompositeOperation=this.compositeOperation,this.context.imageSmoothingEnabled=!1,this.context.clearRect(0,0,this.width,this.height))}remove(){this.canvas instanceof HTMLCanvasElement&&this.canvas.remove()}appendTo(e){this.container=e,!this.offscreen&&this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas)}drawToRegion(e,t,n,i,o){try{if(!this.canvas)return;let i,o=1;if(e instanceof _o?(i=e.context,o=e.opacity):i=e.getContext("2d"),!i)return;this.compositeAsGroup&&(i.globalAlpha=this.opacity),this.height>0&&this.width>0&&i.drawImage(this.canvas,0,0,this.width,this.height,t,n,this.width,this.height),this.compositeAsGroup&&(i.globalAlpha=o)}catch(e){console.error("[Layer.drawToRegion] Outer Error:",e,`Layer: ${this.name}, size: ${this.width}x${this.height}`)}}transferTo(e,t=0,n=0){this.drawToRegion(e,t,n,this.width,this.height)}setSize(e,t){this.width=e,this.height=t}createCanvas(){if(this.group)return this.canvas=this.group.canvas,void(this._context=this.group.context);this.offscreen?this.canvas=this.createOffscreenCanvas():this.canvas=this.createVisibleCanvas(),this.offscreen&&this.canvas instanceof HTMLCanvasElement&&document.body.appendChild(this.canvas)}createVisibleCanvas(){var e,t;const n=document.createElement("canvas"),{pixelRatio:i}=this,o=this.container.clientWidth,s=null!=(e=this.options.height)?e:100;return n.id=`waveform-layer-${null!=(t=this.options.name)?t:"default"}`,n.width=o*i,n.height=s*i,n.style.width=`${o}px`,n.style.height=`${s}px`,n.style.visibility=this.isVisible?"visible":"hidden",this._context=n.getContext("2d"),this._context.globalAlpha=this.compositeAsGroup?Oi(1.5*this.opacity,0,1):this.opacity,this._context.globalCompositeOperation=this.compositeOperation,this._context.imageSmoothingEnabled=!1,n}createOffscreenCanvas(){let e;if(Ii){var t;const{pixelRatio:n}=this,i=this.container.clientWidth,o=null!=(t=this.options.height)?t:100;e=new OffscreenCanvas(i*n,o*n),this._context=e.getContext("2d");const s=this.compositeAsGroup?Oi(1.5*this.opacity,0,1):this.opacity;this._context.globalAlpha=s,this._context.globalCompositeOperation=this.compositeOperation,this._context.imageSmoothingEnabled=!1}else e=this.createVisibleCanvas(),Object.assign(e.style,{right:"100%",bottom:"100%",opacity:0,position:"absolute",visibility:this.isVisible?"visible":"hidden"});return e}createBufferCanvas(){if(this._bufferCanvas)return;let e;if(Ii){const{pixelRatio:t}=this,n=this.canvas.width,i=this.canvas.height;e=new OffscreenCanvas(n*t,i*t),this._bufferContext=e.getContext("2d");const o=this.compositeAsGroup?Oi(1.5*this.opacity,0,1):this.opacity;this._bufferContext.globalAlpha=o,this._bufferContext.globalCompositeOperation=this.compositeOperation,this._bufferContext.imageSmoothingEnabled=!1}else e=this.createVisibleCanvas(),Object.assign(e.style,{right:"100%",bottom:"100%",opacity:0,position:"absolute",visibility:"hidden"});this._bufferCanvas=e}}class Ao extends _o{constructor(e){super(e),this.layers=void 0,this.layers=[]}get isGroup(){return!0}get length(){return this.layers.length}addLayer(e){const t=new _o(Object.assign({group:this},e));return this.layers.push(t),this.sortLayers(),t}removeLayer(e){this.layers=this.layers.filter(t=>t!==e)}remove(){this.layers.forEach(e=>{e.remove()}),this.layers=[],super.remove()}clear(){this.layers.forEach(e=>{e.clear()}),super.clear()}setSize(e,t){this.layers.forEach(n=>{n.setSize(e,t)}),super.setSize(e,t)}sortLayers(){this.layers.sort((e,t)=>e.index-t.index)}}class Io extends Zi{constructor(e,t,n){var i,o,s,a,r,l,c;if(super(),this.id=void 0,this.color=Po("#ccc"),this.fillColor=Po("#eee"),this.visualizer=void 0,this.layerName=void 0,this.wf=void 0,this.capWidth=void 0,this.hoveredStrokeMultiplier=void 0,this._x=void 0,this.capHeight=void 0,this.capPadding=void 0,this.width=void 0,this.isHovered=!1,this.isDragging=!1,this.playheadCanvas=void 0,this.playheadCanvasWidth=0,this.playheadCanvasHeight=0,this.mouseDown=e=>{if(this.isHovered){e.preventDefault(),e.stopPropagation(),this.isDragging=!0,this.wf.cursor.set(jo.grabbing,"playhead");const t=e=>{if(this.isDragging){e.preventDefault(),e.stopPropagation();const t=this.visualizer.container.getBoundingClientRect(),n=e.clientX-t.left,i=Oi(n,0,this.visualizer.width);i!==this._x&&(this.setX(i),this.wf.currentTime=Gi(e,this.visualizer,this.wf.duration),this.drawPlayheadSlice(),this.visualizer.transferImage())}},n=e=>{this.isDragging&&(e.preventDefault(),e.stopPropagation(),this.isDragging=!1,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n),this.drawPlayheadSlice(),this.visualizer.draw(),this.wf.cursor.set(jo.default))};document.addEventListener("mousemove",t),document.addEventListener("mouseup",n),this.drawPlayheadSlice(),this.visualizer.transferImage()}},this.mouseEnter=()=>{this.isDragging||(this.wf.cursor.hasFocus()||this.wf.cursor.set(jo.grab,"playhead"),this.isHovered=!0,this.drawPlayheadSlice(),this.visualizer.transferImage())},this.mouseLeave=()=>{this.isDragging||(this.isHovered=!1,this.drawPlayheadSlice(),this.visualizer.transferImage(),this.wf.cursor.isFocused("playhead")&&this.wf.cursor.set(jo.default))},this.playing=(e,t=!0)=>{this.isDragging||this.updatePositionFromTime(e,!0,t)},this.onZoom=()=>{this.playing(this.time,!1)},this.onScroll=()=>{this.playing(this.time,!1)},(null!=(i=null==e?void 0:e.x)?i:0)<0)throw new Error("Playhead start must be greater than 0");this.id=(0,A.Ak)(5),this._x=null!=(o=e.x)?o:0,this.color=e.color?e.color:this.color,this.fillColor=e.fillColor?e.fillColor:this.fillColor,this.width=null!=(s=e.width)?s:1,this.visualizer=t,this.layerName="playhead",this.wf=n,this.capWidth=null!=(a=e.capWidth)?a:8,this.capHeight=null!=(r=e.capHeight)?r:5,this.capPadding=null!=(l=e.capPadding)?l:3,this.hoveredStrokeMultiplier=null!=(c=e.hoveredStrokeMultiplier)?c:2,this.playheadCanvas=document.createElement("canvas")}onInit(){this.drawPlayheadSlice(),this.initialize()}drawPlayheadSlice(){const e=this.visualizer.pixelRatio||window.devicePixelRatio||1,t=this.capWidth+2,n=this.visualizer.height;this.playheadCanvasWidth===t&&this.playheadCanvasHeight===n&&this.playheadCanvas.width===t*e&&this.playheadCanvas.height===n*e||(this.playheadCanvas.width=t*e,this.playheadCanvas.height=n*e,this.playheadCanvasWidth=t,this.playheadCanvasHeight=n);const i=this.playheadCanvas.getContext("2d");i.setTransform(e,0,0,e,0,0),i.clearRect(0,0,t,n),i.save(),this.isHovered?(i.shadowColor="rgba(0,0,0,0.85)",i.shadowBlur=12):(i.shadowColor="rgba(0,0,0,0.45)",i.shadowBlur=16);const o=t/2,s=this.visualizer.reservedSpace;i.fillStyle=this.fillColor.toString(),i.strokeStyle=this.color.toString(),i.lineWidth=this.width,this.moveTo(i,o,s,n),i.closePath(),i.stroke(),i.fill(),i.restore()}moveTo(e,t,n,i){const{capWidth:o,capHeight:s,capPadding:a}=this,r=n-s-a,l=o/2;e.moveTo(t-l,r),e.lineTo(t+l,r),e.lineTo(t+l,r+s-1),e.lineTo(t,r+s),e.lineTo(t,i),e.lineTo(t,r+s),e.lineTo(t-l,r+s-1)}renderTo(e,t){if(!e||0===this.playheadCanvas.width||0===this.playheadCanvas.height||0===e.canvas.width||0===e.canvas.height)return;e.save();const n=this.visualizer.pixelRatio||window.devicePixelRatio||1;e.globalAlpha=1,e.drawImage(this.playheadCanvas,(t-this.playheadCanvasWidth/2)*n,0),e.restore()}updatePositionFromTime(e,t=!1,n=!0){const i=(e/this.wf.duration-this.scroll)*this.fullWidth,o=n?Oi(i,0,this.fullWidth):i;this.setX(o)}initialize(){this.on("mouseDown",this.mouseDown),this.on("mouseEnter",this.mouseEnter),this.on("mouseLeave",this.mouseLeave),this.wf.on("playing",this.playing),this.wf.on("zoom",this.onZoom),this.wf.on("scroll",this.onScroll)}removeEvents(){this.off("mouseDown",this.mouseDown),this.off("mouseEnter",this.mouseEnter),this.off("mouseLeave",this.mouseLeave),this.wf.off("playing",this.playing),this.wf.off("zoom",this.onZoom),this.wf.off("scroll",this.onScroll)}get scroll(){return this.visualizer.getScrollLeft()}get zoom(){return this.wf.zoom}get time(){return this.wf.currentTime}get x(){return this._x+this.scroll}get containerWidth(){return this.visualizer.container.clientWidth}get fullWidth(){return this.visualizer.fullWidth}setX(e){this._x=e}toJSON(){return{x:this.x,color:this.color.toString(),layerName:this.layerName,id:this.id}}destroy(){this.isDestroyed||(this.removeEvents(),super.destroy())}}class Mo extends HTMLElement{constructor(){super(),this._loaded=void 0,this._total=void 0,this._initializing=!1,this._error="",this._loaded=0,this._total=0,this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          display: flex;\n          width: 100%;\n          height: var(--ls-loader-height, calc(100% - var(--ls-loader-offset, 34px)));\n          position: absolute;\n          top: var(--ls-loader-offset, 34px);\n          left: 0;\n          z-index: 9999;\n          justify-content: center;\n          align-items: center;\n          background-color: var(--color-neutral-background);\n          pointer-events: none;\n          color: var(--color-neutral-content);\n        }\n        :host([hidden]) {\n          display: none;\n        }\n        .progress {\n          width: 70%;\n        }\n        .progress-bar {\n          overflow: hidden;\n          display: block;\n          position: relative;\n          width: 100%;\n          height: 100%;\n          background-color: var(--ls-loader-color, rgba(65, 60, 74, 0.08));\n          border-radius: var(--ls-loader-progress-border-radius, 8px);\n          height: var(--ls-loader-progress-height, 8px);\n        }\n        .progress-bar::after {\n          content: \'\';\n          position: absolute;\n          top: 0;\n          height: 100%;\n          width: 100%;\n          border-radius: var(--ls-loader-progress-border-radius, 8px);\n          background-color: var(--ls-loader-progress-color, var(--color-primary-content));\n          transition: transform 0.15s ease;\n          transform-origin: left;\n          transform: translateX(var(--ls-loader-position, -100%));\n        }\n        .progress-bar-indeterminate::after {\n          transform: translateX(0);\n          animation: shimmer 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;\n        }\n        .progress-bar-info {\n          display: flex;\n          justify-content: space-between;\n          color: var(--color-neutral-content);\n        }\n        .progress-bar-text {\n          display: flex;\n        }\n        .progress-bar-totals {\n          display: flex;\n          align-items: center;\n          gap: 4px;\n        }\n        .progress-text {\n          font-size: 9px;\n          line-height: 16px;\n          letter-spacing: 0.5px;\n          font-weight: 500;\n          margin: 0;\n        }\n        .error {\n          color: var(--ls-loader-error-color, var(--color-negative-content));\n        }\n        @keyframes shimmer {\n          50% {\n            opacity: 0.5;\n          }\n        }\n      </style>\n      <div class="progress">\n        <div class="progress-bar-info">\n          <div class="progress-bar-text">\n            <h3 id="text" class="progress-text">Loading file...</h3>\n          </div>\n          <div class="progress-bar-totals progress-text">\n            <span id="loaded">0.0 MB</span><span id="percentage">(0)%</span><span>of</span><span id="total">?? MB</span>\n          </div>\n        </div>\n        <div class="progress-bar"></div>\n      </div>\n    ')}get error(){return this._error}set error(e){this._error=e}get loaded(){return this._loaded}set loaded(e){this._loaded=e}get total(){return this._total}set total(e){this._total=e}get value(){return Math.round(this.loaded/this.total*100)}convertBytesToMegabytes(e){return(e/1024/1024).toFixed(1)}update(){if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector(".progress-bar"),t=this.shadowRoot.querySelector("#text"),n=this.shadowRoot.querySelector("#loaded"),i=this.shadowRoot.querySelector("#total"),o=this.shadowRoot.querySelector("#percentage");if(!e)return;const s=this.total;requestAnimationFrame(()=>{if(this._error)return t.classList.contains("error")||t.classList.add("error"),void(t.innerText=this._error);if(this._initializing)return n.innerText=`${this.loaded}`,i.innerText=`${this.total} chunks`,void(o.innerText=`(${this.value}%)`);if(s<0)return e.classList.contains("progress-bar-indeterminate")||e.classList.add("progress-bar-indeterminate"),void(this.loaded>0&&(n.innerText=`${this.convertBytesToMegabytes(this.loaded)} MB`));const a=this.value;if(100===a)return this._initializing=!0,this.total>0&&(n.innerText=`${this.convertBytesToMegabytes(this.loaded)} MB`,i.innerText=`${this.convertBytesToMegabytes(this.total)} MB`,o.innerText=`(${a}%)`),t.innerText="Initializing...",void e.classList.add("progress-bar-indeterminate");e.style.setProperty("--ls-loader-position",a-100+"%"),a>0&&(o.innerText=`(${a}%)`),this.loaded>0&&(n.innerText=`${this.convertBytesToMegabytes(this.loaded)} MB`),this.total>0&&(i.innerText=`${this.convertBytesToMegabytes(this.total)} MB`)})}static get observedAttributes(){return["hidden"]}}customElements.define("loading-progress-bar",Mo);const Eo="viridis";class Ko{constructor(e=Eo){this.activeColormap=[],this.currentScheme=void 0,this.currentScheme=e,this.cacheColormap()}setColorScheme(e){this.currentScheme!==e&&(this.currentScheme=e,this.cacheColormap())}magnitudeToColor(e){const t=Oi(e,0,1),n=this.activeColormap;if(!n||0===n.length){const e=Math.round(255*t);return`rgba(${e}, ${e}, ${e}, 1)`}const i=n[Math.min(Math.floor(t*n.length),n.length-1)];if(!i||i.length<3){const e=Math.round(255*t);return`rgba(${e}, ${e}, ${e}, 1)`}const o=i[0],s=i[1],a=i[2];return`rgba(${Math.round(255*o)}, ${Math.round(255*s)}, ${Math.round(255*a)}, 1)`}cacheColormap(){try{this.activeColormap=ii()({colormap:this.currentScheme,nshades:512,format:"float"}),console.log(`ColorMapper: Cached colormap '${this.currentScheme}' with ${this.activeColormap.length} shades.`)}catch(e){console.error(`Failed to generate colormap '${this.currentScheme}':`,e),this.activeColormap=Array.from({length:512},(e,t)=>{const n=t/511;return[n,n,n]}),this.currentScheme=Eo,this.cacheColormap()}}}var Do=n(50719);class Oo{constructor(e=Do.zO,t=50){this.zoomDebounceMs=t,this.lastDrawTime=0,this.pendingDraw=null,this.drawScheduled=!1,this._fps=Do.zO,this._minFrameTime=1e3/Do.zO,this.currentWindowStart=0,this.zoomDebounce=null,this.fps=e,this.currentWindowStart=performance.now()}set fps(e){this._fps=e,this._minFrameTime=1e3/this._fps}get fps(){return this._fps}get minFrameTime(){return this._minFrameTime}scheduleDraw(e,t,n=!1){if(n)return this.zoomDebounce&&clearTimeout(this.zoomDebounce),void(this.zoomDebounce=setTimeout(()=>{t(e),this.zoomDebounce=null},this.zoomDebounceMs));const i=performance.now();this.pendingDraw={getContext:()=>e,drawFn:t};const o=i-this.currentWindowStart;if(o>=this.minFrameTime)this.executeDraw(),this.lastDrawTime=i,this.currentWindowStart=i;else if(!this.drawScheduled){this.drawScheduled=!0;const e=this.minFrameTime-o;setTimeout(()=>{this.pendingDraw&&requestAnimationFrame(()=>{this.executeDraw(),this.lastDrawTime=performance.now(),this.currentWindowStart=this.lastDrawTime})},e)}}executeDraw(){if(this.pendingDraw){const{getContext:e,drawFn:t}=this.pendingDraw;t(e()),this.pendingDraw=null,this.drawScheduled=!1}}reset(){this.lastDrawTime=0,this.pendingDraw=null,this.drawScheduled=!1,this.currentWindowStart=performance.now(),this.zoomDebounce&&(clearTimeout(this.zoomDebounce),this.zoomDebounce=null)}}const Lo=(0,Ne.VS)(Ne.ji);class zo{constructor({layer:e,backgroundLayer:t,config:n,onRenderTransfer:i}){this.config=void 0,this.layer=void 0,this.backgroundLayer=void 0,this.onRenderTransfer=void 0,this.audio=void 0,this.lastRenderContext=void 0,this.isDestroyed=!1,this.rateLimitedRenderer=void 0,this.lastRenderedAmp=0,this.lastWaveformRenderedWidth=0,this.lastWaveformRenderedZoom=0,this.lastWaveformRenderedScrollLeftPx=0,this.layer=e,this.backgroundLayer=t,this.config=n,this.onRenderTransfer=i,this.rateLimitedRenderer=new Oo}init(e,t){this.audio=t}draw(e){this.lastRenderContext=e,this.drawMiddleLine(),this.rateLimitedRenderer.scheduleDraw({context:e,renderer:this},({context:e,renderer:t})=>{var n;const i=t.audio,o=t.layer;if(!i||!o||!o.isVisible)return void(t.lastWaveformRenderedWidth=0);const s=e.dataLength,a=e.scrollLeftPx,r=e.samplesPerPx,l=Oi(a*r,0,s),c=Oi(l+e.width*r,0,s),d=c-l,u=e.zoom,h=null!=(n=t.config.amp)?n:1,g=a-t.lastWaveformRenderedScrollLeftPx,m=Lo?Math.abs(g)>=e.width:d<Do.OT;if(e.width!==t.lastWaveformRenderedWidth||u!==t.lastWaveformRenderedZoom||h!==t.lastRenderedAmp||m)for(let n=0;n<i.channelCount;n++)t.renderWave(e,n,o,l,c);else t.renderPartialWave(e,o,l,c,g)},!1)}destroy(){this.isDestroyed=!0,this.rateLimitedRenderer.reset()}renderWave(e,t,n,i,o){var s;const a=this.config.renderId,r=this.audio,l=this.config.waveHeight,c=e.scrollLeftPx,d=e.zoom,u=null!=(s=this.config.amp)?s:1;if(!r)return!1;0===t&&n.clear();const h=this.renderSlice(n,l,i,o,t,0,e),g=()=>{if(this.config.renderId!==a)return!1;var t;if(h.next().done)return this.lastWaveformRenderedWidth=e.width,this.lastWaveformRenderedZoom=d,this.lastRenderedAmp=u,this.lastWaveformRenderedScrollLeftPx=c,null==(t=this.onRenderTransfer)||t.call(this),!0;requestAnimationFrame(g)};return g(),!1}renderPartialWave(e,t,n,i,o){var s;const a=this.config.renderId;let r=0;const l=this.audio,c=null!=(s=null==l?void 0:l.channelCount)?s:1,d=this.config.waveHeight,u=e.scrollLeftPx,h=e.dataLength;this.lastWaveformRenderedScrollLeftPx=u;const g=e.samplesPerPx,m=-o,p=Math.round(o*g);t.shift(m,0);for(let s=0;s<c;s++){let l=n,c=i;o>0?(l=i-p,r=Oi(e.width+m-2,0,e.width)):(c=n-p,r=0),c=Oi(c+2*g,0,h);const u=this.renderSlice(t,d,l,c,s,r,e),f=()=>{if(this.config.renderId!==a)return;var t;u.next().done?(e&&e.notifyRenderComplete&&e.notifyRenderComplete(),null==(t=this.onRenderTransfer)||t.call(this)):requestAnimationFrame(f)};f()}}*renderSlice(e,t,n,i,o,s=0,a){var r,l,c,d,u,h,g,m;const p=this.audio,f=null==p||null==(r=p.chunks)?void 0:r[o];if(!f)return;const v=f.length,y=null!=(l=null==(c=this.config.padding)?void 0:c.top)?l:0,b=null!=(d=null==(u=this.config.padding)?void 0:u.left)?d:0,x=t*o+(null!=(h=this.config.reservedSpace)?h:0),w=x+y+t/2;let S=0;e.save();const C=null!=(g=null==(m=this.config.waveColor)||null==m.toString?void 0:m.toString())?g:"#000";e.strokeStyle=C,e.fillStyle=C,e.lineWidth=1,e.beginPath(),e.moveTo(s,w);const k=performance.now();for(let o=0;o<v;o++){const r=f[o],l=r.length,c=Math.floor(Oi(n-S,0,l)),d=Math.ceil(Oi(i-S,0,l));S+=l;try{const n=r.slice(c,d),i=n.length-1;let o=i+1;for(;o>0;){const r=i-o,l=n.slice(r,r+a.samplesPerPx);k-performance.now()>10&&(yield),s>=0&&l.length>0&&this.renderChunk(l,e,t,s+b,x,a),s+=1,o=Oi(o-a.samplesPerPx,0,i)}}catch(e){}}e.stroke(),e.restore()}renderChunk(e,t,n,i,o,s){var a;t.save();const r=Fi(e),l=null!=(a=this.config.amp)?a:1;r.forEach(e=>{const s=n/2,a=e*l*s;t.lineTo(i+1,o+s+a)}),t.restore()}updateConfig(e){this.config=Object.assign({},this.config,e)}resetRenderState(){this.lastRenderedAmp=0,this.lastWaveformRenderedWidth=0,this.lastWaveformRenderedZoom=0,this.lastWaveformRenderedScrollLeftPx=0}drawMiddleLine(){var e,t;const n=this.backgroundLayer;if(n.clear(),!n.isVisible)return;var i,o,s;this.config.backgroundColor&&(n.save(),n.fillStyle=null!=(i=null==(o=(s=this.config.backgroundColor).toString)?void 0:o.call(s))?i:"#fff",n.fillRect(0,0,n.width,n.height),n.restore());const a=this.config.waveHeight/2;n.save(),n.strokeStyle=null!=(e=null==(t=this.config.middleLineColor)||null==t.toString?void 0:t.toString())?e:"#888",n.lineWidth=1,n.beginPath(),n.moveTo(0,a),n.lineTo(n.width,a),n.stroke(),n.restore()}onResize(){this.resetRenderState()}}class Bo{constructor(e,t=5,n){this.pendingBatches=[],this.name=void 0,this.chunkSize=void 0,this.totalTasksAdded=0,this.totalTasksProcessed=0,this.onBatchComplete=void 0,this.onProgress=void 0,this.priority=void 0,this.name=e,this.chunkSize=Math.max(1,t),this.priority=null!=n?n:e}addBatch(e,t,n){if(0===t.length)return;const i=t.length,o={id:e,metadata:n,pendingTasks:[...t],totalTasks:i,processedTasks:0};this.pendingBatches.push(o),this.totalTasksAdded+=i}async processChunk(){let e=0;const t=[];for(;e<this.chunkSize&&this.hasPendingTasks();){const n=this.pendingBatches[0];if(!n||0===n.pendingTasks.length){console.error(`[WorkerQueue ${this.name}] Inconsistency: hasPendingTasks() true, but no tasks found in front batch ${null==n?void 0:n.id}. Removing problematic batch.`),n&&this.pendingBatches.shift();continue}const i=n.pendingTasks.shift();if(i){e++,this.totalTasksProcessed++,n.processedTasks++;try{await i.taskFn()}catch(e){console.error(`[WorkerQueue ${this.name}] Task ${i.id} (batch ${n.id}) failed:`,e)}0===n.pendingTasks.length&&(t.push(n.id),this.onBatchComplete&&this.onBatchComplete(n.id,n.metadata),this.pendingBatches.shift())}else console.error(`[WorkerQueue ${this.name}] Logic Error: Failed to shift task from non-empty pendingTasks of batch ${n.id}.`)}return this.emitProgress(),{tasksProcessed:e,completedBatchIds:t}}hasPendingTasks(){return this.pendingBatches.some(e=>e.pendingTasks.length>0)}clear(){this.pendingBatches=[],this.totalTasksAdded=0,this.totalTasksProcessed=0,this.emitProgress()}get pendingBatchCount(){return this.pendingBatches.filter(e=>e.pendingTasks.length>0).length}get pendingTaskCount(){return this.pendingBatches.reduce((e,t)=>e+t.pendingTasks.length,0)}get globalTasksAdded(){return this.totalTasksAdded}get globalTasksProcessed(){return this.totalTasksProcessed}cancelBatchesByPriority(e){this.pendingBatches=this.pendingBatches.filter(t=>{var n;return!e.includes(null==(n=t.metadata)?void 0:n.priority)})}getAllBatchProgresses(e){return this.pendingBatches.map(t=>({id:t.id,priority:e,metadata:t.metadata,totalTasks:t.totalTasks,activeTasks:t.pendingTasks.length,completedTasks:t.processedTasks,queuedTasks:t.pendingTasks.length,percentage:t.totalTasks>0?Math.round(t.processedTasks/t.totalTasks*100):0}))}emitProgress(){this.onProgress&&this.onProgress(this.getAllBatchProgresses(this.priority),this.priority)}}let Fo=function(e){return e.HIGH="high",e.NORMAL="normal",e.LOW="low",e}({});class Ho{constructor(e={}){var t,n,i;this.highWorker=void 0,this.normalWorker=void 0,this.lowWorker=void 0,this.running=!1,this.runLoopTimeout=null,this.options=void 0,this.version=0,this.nextBatchId=0,this.activeBatchCounts={[Fo.HIGH]:new Set,[Fo.NORMAL]:new Set,[Fo.LOW]:new Set},this.options=e;const o=e.onBatchComplete,s=(e,t)=>{const n=null==t?void 0:t.priority;n&&this.activeBatchCounts[n]&&(this.activeBatchCounts[n].delete(e),0===this.activeBatchCounts[n].size&&this.options.onAllCategoryComplete&&this.options.onAllCategoryComplete(n)),o&&o(e,t)};if(this.highWorker=new Bo("high",null!=(t=e.highBatchSize)?t:10,Fo.HIGH),this.normalWorker=new Bo("normal",null!=(n=e.normalBatchSize)?n:5,Fo.NORMAL),this.lowWorker=new Bo("low",null!=(i=e.lowBatchSize)?i:1,Fo.LOW),this.highWorker.onBatchComplete=s,this.normalWorker.onBatchComplete=s,this.lowWorker.onBatchComplete=s,e.onProgress){const t=()=>{const t=this.highWorker,n=this.normalWorker,i=this.lowWorker,o=[{priority:Fo.HIGH,pendingTasks:t.pendingTaskCount,pendingBatches:t.pendingBatchCount,totalTasks:t.globalTasksAdded,processedTasks:t.globalTasksProcessed},{priority:Fo.NORMAL,pendingTasks:n.pendingTaskCount,pendingBatches:n.pendingBatchCount,totalTasks:n.globalTasksAdded,processedTasks:n.globalTasksProcessed},{priority:Fo.LOW,pendingTasks:i.pendingTaskCount,pendingBatches:i.pendingBatchCount,totalTasks:i.globalTasksAdded,processedTasks:i.globalTasksProcessed}],s=o.reduce((e,t)=>e+t.totalTasks,0),a=o.reduce((e,t)=>e+t.processedTasks,0),r=s>0?Math.round(a/s*100):0;e.onProgress({batches:[],overall:{totalAdded:s,totalProcessed:a,overallPercentage:r}})};this.highWorker.onProgress=t,this.normalWorker.onProgress=t,this.lowWorker.onProgress=t}}addBatch(e,t){const n="batch-"+this.nextBatchId++,i=e.filter(e=>e.priority===Fo.HIGH).map(e=>({id:e.id,taskFn:e.taskFn})),o=e.filter(e=>e.priority===Fo.NORMAL).map(e=>({id:e.id,taskFn:e.taskFn})),s=e.filter(e=>e.priority===Fo.LOW).map(e=>({id:e.id,taskFn:e.taskFn}));return i.length>0&&(this.highWorker.addBatch(n,i,t),this.activeBatchCounts[Fo.HIGH].add(n)),o.length>0&&(this.normalWorker.addBatch(n,o,t),this.activeBatchCounts[Fo.NORMAL].add(n)),s.length>0&&(this.lowWorker.addBatch(n,s,t),this.activeBatchCounts[Fo.LOW].add(n)),this.startRunLoop(),n}clear(){if(this.highWorker.clear(),this.normalWorker.clear(),this.lowWorker.clear(),this.version++,this.activeBatchCounts[Fo.HIGH].clear(),this.activeBatchCounts[Fo.NORMAL].clear(),this.activeBatchCounts[Fo.LOW].clear(),this.runLoopTimeout&&(clearTimeout(this.runLoopTimeout),this.runLoopTimeout=null),this.running=!1,this.options.onCleared)try{this.options.onCleared()}catch(e){console.error("Error in ComputationQueue onCleared callback:",e)}}startRunLoop(){this.running||(this.running=!0,this.runLoop())}emitAggregateProgress(){if(this.options.onProgress){const e=[...this.highWorker.getAllBatchProgresses(Fo.HIGH),...this.normalWorker.getAllBatchProgresses(Fo.NORMAL),...this.lowWorker.getAllBatchProgresses(Fo.LOW)],t=e.reduce((e,t)=>e+t.totalTasks,0),n=e.reduce((e,t)=>e+t.completedTasks,0),i=t>0?Math.round(n/t*100):0;this.options.onProgress({batches:e,overall:{totalAdded:t,totalProcessed:n,overallPercentage:i}})}}async runLoop(){if(!this.running)return;const e=[this.highWorker,this.normalWorker,this.lowWorker];let t=!1;for(const n of e)if(n.hasPendingTasks()){await n.processChunk(),this.emitAggregateProgress(),t=!0;break}t&&this.running?this.runLoopTimeout=setTimeout(()=>this.runLoop(),0):this.running=!1}hasTask(e){return this.highWorker.hasPendingTasks()||this.normalWorker.hasPendingTasks()||this.lowWorker.hasPendingTasks()}getQueueSize(){return this.highWorker.pendingTaskCount+this.normalWorker.pendingTaskCount+this.lowWorker.pendingTaskCount}getQueueSizes(){return{high:this.highWorker.pendingTaskCount,normal:this.normalWorker.pendingTaskCount,low:this.lowWorker.pendingTaskCount,total:this.getQueueSize()}}cancelBatchesByPriority(e){this.highWorker.cancelBatchesByPriority(e),this.normalWorker.cancelBatchesByPriority(e),this.lowWorker.cancelBatchesByPriority(e)}}class Vo{constructor(e){this.maxSize=void 0,this.map=void 0,this.maxSize=e,this.map=new Map}get(e){if(!this.map.has(e))return;const t=this.map.get(e);return this.map.delete(e),this.map.set(e,t),t}set(e,t){if(this.map.has(e))this.map.delete(e);else if(this.map.size>=this.maxSize){const e=this.map.keys().next();e.done||this.map.delete(e.value)}this.map.set(e,t)}has(e){return this.map.has(e)}get size(){return this.map.size}values(){return this.map.values()}}class $o{constructor(e,t,n,i){this.container=void 0,this.colorMapper=void 0,this.fftCache=void 0,this.config=void 0,this.visible=!0,this.overlayWidth=180,this.overlayBgColor="rgba(0, 0, 0, 0.7)",this.overlayTextColor=void 0,this.overlayFontSize=10,this.barHeight=12,this.barRadius=2,this.barShadow="0 1px 4px rgba(0,0,0,0.18)",this.ariaLabel="Spectrogram progress overlay",this.labels={view:"VIEW",precache:"PRECACHE",cached:"Cached",caching:"Caching"},this.container=e,this.colorMapper=t,this.fftCache=n,this.overlayTextColor=t.magnitudeToColor(1),this.config={visible:i.visible},i&&(void 0!==i.visible&&(this.visible=i.visible),void 0!==i.overlayWidth&&(this.overlayWidth=i.overlayWidth),void 0!==i.overlayBgColor&&(this.overlayBgColor=i.overlayBgColor),void 0!==i.overlayTextColor&&(this.overlayTextColor=i.overlayTextColor),void 0!==i.overlayFontSize&&(this.overlayFontSize=i.overlayFontSize),void 0!==i.barHeight&&(this.barHeight=i.barHeight),void 0!==i.barRadius&&(this.barRadius=i.barRadius),void 0!==i.barShadow&&(this.barShadow=i.barShadow),void 0!==i.ariaLabel&&(this.ariaLabel=i.ariaLabel),i.labels&&(this.labels=Object.assign({},this.labels,i.labels)))}updateConfig(e){const t=Object.assign({},this.config);"visible"in e&&(this.visible=e.visible),this.visible!==t.visible&&(this.visible?this._showProgressOverlay():this._hideProgressOverlay())}renderProgress(e){if(void 0===e||100===e.overall.overallPercentage||0===e.overall.overallPercentage)return void this._hideProgressOverlay();if(!this.visible)return void this._hideProgressOverlay();const t=this._ensureProgressOverlay();t.innerHTML="",t.style.display="block",t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-label",this.ariaLabel||"Spectrogram progress overlay");const{cachingTotal:n,cachingProcessed:i}=this._aggregateProgress(e);t.appendChild(this._createOverallBar(n,i))}_aggregateProgress(e){let t=0,n=0;const i={view:[],precache:[]};if(null!=e&&e.batches)for(const o of e.batches)t+=o.totalTasks,n+=o.completedTasks,o.priority===Fo.HIGH&&i.view.push(o),o.priority===Fo.NORMAL&&i.precache.push(o);return{cachingTotal:t,cachingProcessed:n,batchGroups:i}}_createOverallBar(e,t){var n,i,o,s;const a=this.colorMapper,r=(this.fftCache,document.createElement("div"));r.style.marginBottom="3px",r.style.borderBottom="1px solid #555",r.style.paddingBottom="2px";const l=document.createElement("div");var c,d;(l.style.fontSize=`${null!=(n=this.overlayFontSize)?n:10}px`,l.style.fontWeight="bold",l.style.color=null!=(i=this.overlayTextColor)?i:a.magnitudeToColor(1),l.style.marginBottom="1px",0===e)?l.textContent=`${(null==(c=this.labels)?void 0:c.cached)||"Cached"}`:l.textContent=`${(null==(d=this.labels)?void 0:d.caching)||"Caching"}: ${t} / ${e} (${Math.round(t/e*100)}%)`;const u=this._createBar({percent:e>0?t/e:1,color:a.magnitudeToColor(1),bgColor:a.magnitudeToColor(0),height:4,radius:null!=(o=this.barRadius)?o:2,shadow:null!=(s=this.barShadow)?s:"0 1px 4px rgba(0,0,0,0.18)",opacity:1,position:"relative"});return r.appendChild(l),r.appendChild(u),r}_createPriorityBars(e){var t,n,i,o;const s=this.colorMapper,a=document.createElement("div"),r=[{key:"view",color:s.magnitudeToColor(1),label:null!=(t=null==(n=this.labels)?void 0:n.view)?t:"VIEW"},{key:"precache",color:s.magnitudeToColor(.66),label:null!=(i=null==(o=this.labels)?void 0:o.precache)?i:"PRECACHE"}],l=s.magnitudeToColor(0);for(const{key:t,color:n,label:i}of r){const o=e[t]||[],s=o.length;let r=0,c=0,d=0;o.forEach(e=>{r+=e.completedTasks,c+=e.activeTasks,d+=e.totalTasks});const u=document.createElement("div");u.style.marginBottom="2px",u.style.fontSize="9px";const h=document.createElement("span");if(h.textContent=`${i}: ${r}/${d}`,h.style.color=n,h.style.fontWeight="bold",u.appendChild(h),s>0){const e=document.createElement("span");e.textContent=`  (${s} batch${s>1?"es":""})`,e.style.background="#222",e.style.color="#fff",e.style.fontSize="8px",e.style.borderRadius="6px",e.style.padding="1px 6px",e.style.marginLeft="6px",e.style.verticalAlign="middle",u.appendChild(e)}u.appendChild(this._createBar({percent:d>0?r/d:1,color:n,bgColor:l,height:4,radius:this.barRadius,shadow:this.barShadow,opacity:1,activePercent:d>0?c/d:0,position:"relative"})),a.appendChild(u)}return a}_createBar(e){var t,n,i,o,s,a;const r=document.createElement("div");if(r.style.position=null!=(t=e.position)?t:"absolute","relative"!==e.position?(r.style.left="0",r.style.top="50%",r.style.transform="translateY(-50%)"):r.style.marginTop="2px",r.style.width="100%",r.style.height=`${null!=(n=e.height)?n:12}px`,r.style.backgroundColor=null!=(i=e.bgColor)?i:"#888",r.style.borderRadius=`${null!=(o=e.radius)?o:2}px`,r.style.boxShadow=null!=(s=e.shadow)?s:"none",r.style.opacity=`${null!=(a=e.opacity)?a:1}`,e.percent>0){var l,c,d;const t=document.createElement("div");t.style.width=100*e.percent+"%",t.style.backgroundColor=e.color,t.style.height="100%",t.style.borderRadius=`${null!=(l=e.radius)?l:2}px 0 0 ${null!=(c=e.radius)?c:2}px`,t.style.boxShadow=null!=(d=e.shadow)?d:"none",r.appendChild(t)}return r}_ensureProgressOverlay(){let e=this.container.querySelector("#spectrogram-progress-overlay");var t,n,i,o;e||(e=document.createElement("div"),e.id="spectrogram-progress-overlay",e.style.position="absolute",e.style.opacity="1",e.style.right="10px",e.style.bottom="20px",e.style.width=`${null!=(t=this.overlayWidth)?t:180}px`,e.style.backgroundColor=null!=(n=this.overlayBgColor)?n:"rgba(0, 0, 0, 0.7)",e.style.color=null!=(i=this.overlayTextColor)?i:"white",e.style.padding="5px",e.style.fontSize=`${null!=(o=this.overlayFontSize)?o:10}px`,e.style.fontFamily="monospace",e.style.zIndex="100",e.style.maxHeight="150px",e.style.overflowY="hidden",e.style.pointerEvents="none",this.container.appendChild(e));return e.style.display="block",e}_hideProgressOverlay(){const e=this.container.querySelector("#spectrogram-progress-overlay");e&&(e.style.display="none")}_showProgressOverlay(){const e=this.container.querySelector("#spectrogram-progress-overlay");e&&(e.style.display="block")}init(e,t){this.renderProgress()}render(e){this.renderProgress()}destroy(){this._hideProgressOverlay()}}class Wo{constructor(e,t,n){var i;this.layer=void 0,this.colorMapper=void 0,this.config=void 0,this.audio=null,this.height=0,this.fontSize=11,this.gridNeedsRedraw=!1,this.layer=e,this.colorMapper=t,this.height=n.height,this.fontSize=null!=(i=n.fontSize)?i:11,this.config={visible:n.visible,spectrogramScale:n.spectrogramScale}}updateConfig(e){const t=Object.assign({},this.config);var n;("spectrogramScale"in e&&(this.config=Object.assign({},this.config,e),t.spectrogramScale!==this.config.spectrogramScale&&(this.gridNeedsRedraw=!0)),"visible"in e)&&(this.config.visible=null!=(n=e.visible)?n:this.config.visible,this.gridNeedsRedraw=!0);this.config.visible||this.layer.clear()}init(e,t){this.audio=e,this.gridNeedsRedraw=!0}render(e){this.config.visible&&(this.gridNeedsRedraw&&this.drawFrequencyGrid(e),this.gridNeedsRedraw=!1)}destroy(){this.layer.clear()}requestGridRedraw(){this.gridNeedsRedraw=!0}drawFrequencyGrid(e){var t,n,i;const o=this.audio;if(!o)return;const s=e.width,a=this.height,r=null!=(t=null==(n=e.padding)?void 0:n.left)?t:0,l=this.layer.context,c=o.sampleRate,d=this.config.spectrogramScale,u=this.fontSize,h=this.colorMapper,g=h.magnitudeToColor(1),m=h.magnitudeToColor(0),p=h.magnitudeToColor(0),f=h.magnitudeToColor(1),v=null!=(i=this.layer.pixelRatio)?i:1;this.layer.clear(),this.layer.save(),l.font=u*v+"px sans-serif",l.textBaseline="middle",this.layer.strokeStyle=g,this.layer.fillStyle=f,this.layer.lineWidth=1;let y=[];const b=c/2;if("linear"===d){const e=b/10;let t;t=e>2e3?2e3:e>1e3?1e3:e>500?500:e>100?100:50;for(let e=0;e<=b;e+=t)y.push(e);y[y.length-1]!==b&&y.push(b)}else if("log"===d){const e=Math.floor(Math.log10(b))-1;for(let t=1;t<=e;t++)for(const e of[1,2,5]){const n=e*10**t;if(n>b)break;y.push(n)}0!==y[0]&&y.unshift(0),y[y.length-1]!==b&&y.push(b)}else if("mel"===d){const e=[0,500,1e3,2e3,4e3,8e3,12e3,16e3].filter(e=>e<=b);e.includes(0)||e.unshift(0),e.includes(b)||e.push(b),y=[...new Set(e)].sort((e,t)=>e-t)}if(a<=200&&y.length>2){const e=[y[0]],t=y.slice(1,y.length-1);for(let n=0;n<t.length;n++)n%2==0&&e.push(t[n]);e.push(y[y.length-1]),y=[...new Set(e)].sort((e,t)=>e-t)}const x=5*v;for(const e of y){let t,n;if("linear"===d||"mel"===d)t=a*(1-e/b),"mel"===d&&0===e&&(t-=x);else if("log"===d){const n=10;if(e<n&&0!==e)continue;t=0===e?a:a*(1-Math.log10(e/n)/Math.log10(b/n))}else t=a*(1-e/b);t=Math.max(0,Math.min(a,t)),this.layer.save(),l.shadowColor=m,l.shadowBlur=2*v,l.shadowOffsetY=1*v,l.setLineDash([4*v,4*v]),this.layer.beginPath(),this.layer.moveTo(r,t),this.layer.lineTo(r+s,t),this.layer.stroke(),this.layer.restore(),n=e>=1e3?`${(e/1e3).toFixed(e%1e3==0?0:1)} kHz`:`${Math.round(e)} Hz`;const i=r+2,o=4,c=2,h=(this.layer.measureText(n).width+2*o)/v,g=u+2*c,y=i-o;let w,S;"linear"===d&&0===e||"mel"===d&&0===e||"log"===d&&10===e?(w=t-g,S=t-g/2):e===b?(w=t,S=t+g/2):(S=t,w=S-g/2),this.layer.save(),this.layer.fillStyle=p,this.layer.fillRect(y,w,h,g),this.layer.restore(),this.layer.fillStyle=f,this.layer.fillText(n,i,S)}this.layer.restore()}onResize(){this.requestGridRedraw()}}class Uo{constructor(e,t,n,i,o){if(this.config=void 0,this.audio=void 0,this.onRenderTransfer=void 0,this.spectrogramDrawing=!1,this.forceCachedExcedLimit=0,this.spectrogramMinDb=void 0,this.spectrogramScale=void 0,this.spectrogramHopFactor=void 0,this.colorMapper=void 0,this.fftCache=void 0,this.computationQueue=void 0,this.spectrogramColorScheme=void 0,this.spectrogramMaxDb=void 0,this.numberOfMelBands=void 0,this.spectrogramNeedsRedraw=!1,this.fftProcessor=null,this.fftSamples=void 0,this.windowFunction=void 0,this.spectrogramHighCompleteDebounce=null,this.spectrogramHighCompleteDebounceTime=100,this.progressRendererPlugin=void 0,this.gridRendererPlugin=void 0,this.plugins=void 0,this.lastSpectrogramRenderedWidth=0,this.lastSpectrogramRenderedZoom=0,this.lastSpectrogramRenderedScrollLeftPx=0,this.isDestroyed=!1,this.lastRenderContext=void 0,this.spectrogram=void 0,this.gridLayer=void 0,this.progressContainer=void 0,this.rateLimitedRenderer=void 0,this.config=i,this.spectrogram=t,this.gridLayer=n,this.onRenderTransfer=o,this.progressContainer=e,this.rateLimitedRenderer=new Oo(Do.zO/4),this.spectrogramMinDb=i.spectrogramMinDb,this.spectrogramScale=i.spectrogramScale,this.spectrogramHopFactor=i.spectrogramHopFactor,this.colorMapper=i.colorMapper,this.fftCache=i.fftCache,this.spectrogramColorScheme=i.spectrogramColorScheme,this.spectrogramMaxDb=i.spectrogramMaxDb,this.numberOfMelBands=i.numberOfMelBands,this.fftSamples=i.fftSamples,this.windowFunction=i.windowFunction,this.computationQueue=new Ho({highBatchSize:Do.P7,normalBatchSize:Do.l2,onCleared:()=>{var e;this.renderProgress(),null==(e=this.onRenderTransfer)||e.call(this)},onProgress:e=>{var t;this.renderProgress(e),null==(t=this.onRenderTransfer)||t.call(this)},onBatchComplete:(e,t)=>{var n;if(t)if("current-view-partial"===t.type&&void 0!==t.startSample&&void 0!==t.endSample)this.redrawSpectrogramSliceFromCache(t.correlationId,t.startSample,t.endSample),null==(n=this.onRenderTransfer)||n.call(this);else if("current-view"===t.type){var i;this.redrawSpectrogramFromCache(t.correlationId),null==(i=this.onRenderTransfer)||i.call(this)}},onAllCategoryComplete:e=>{e===Fo.HIGH&&(this.spectrogramHighCompleteDebounce&&clearTimeout(this.spectrogramHighCompleteDebounce),this.spectrogramHighCompleteDebounce=setTimeout(()=>{var e;this.redrawSpectrogramFromCache("all-high-complete"),null==(e=this.onRenderTransfer)||e.call(this)},this.spectrogramHighCompleteDebounceTime))}}),t.on("layerUpdated",()=>{this.setVisibility(this.spectrogram.isVisible)}),this.progressRendererPlugin=new $o(this.progressContainer,this.colorMapper,this.fftCache,{visible:this.spectrogram.isVisible}),!n)throw new Error("Spectrogram grid layer not found");this.gridRendererPlugin=new Wo(n,this.colorMapper,{visible:this.spectrogram.isVisible,fontSize:11,height:i.channelHeight,spectrogramScale:this.config.spectrogramScale}),this.gridRendererPlugin.updateConfig({spectrogramScale:this.spectrogramScale}),this.plugins=[this.progressRendererPlugin,this.gridRendererPlugin]}renderProgress(e){this.progressRendererPlugin.renderProgress(e)}init(e,t){this.audio=t,this.lastRenderContext=e,!this.fftProcessor&&t.sampleRate&&Promise.all([n.e(710),n.e(943)]).then(n.bind(n,6324)).then(e=>{this.fftProcessor=new e.FFTProcessor({fftSamples:this.fftSamples,windowingFunction:this.windowFunction,sampleRate:t.sampleRate})});for(const n of this.plugins)n.init(t,e)}draw(e){var t;!this.isDestroyed&&null!=(t=this.spectrogram)&&t.isVisible&&this.audio&&this.fftProcessor&&this.spectrogram.isVisible&&this.rateLimitedRenderer.scheduleDraw({context:e,renderer:this},({context:e,renderer:t})=>{t._draw(e)},!1)}_draw(e){var t;this.lastRenderContext=e;const n=e.scrollLeftPx,i=n-this.lastSpectrogramRenderedScrollLeftPx;try{var o,s;const t=null!=(o=null==(s=this.audio)?void 0:s.dataLength)?o:0,a=this.computationQueue.getQueueSizes().high>e.width*Do.Rw,r=!this.audio||e.width!==this.lastSpectrogramRenderedWidth||e.zoom!==this.lastSpectrogramRenderedZoom||this.spectrogramNeedsRedraw||Math.abs(i)>=e.width||a;if((r||i>0)&&this.computationQueue.cancelBatchesByPriority([Fo.NORMAL,Fo.LOW]),r){a&&(this.forceCachedExcedLimit+=1),this.computationQueue.clear(),this.spectrogram.clear();const i=this._getCurrentHopSize();if(!this.fftProcessor)return;const o=this.fftProcessor.fftSamples,s=Math.floor(Oi(n*e.samplesPerPx,0,t)),r=Math.ceil(Oi(s+e.width*e.samplesPerPx,0,t)),l=s,c=r,d=c-l;if(0===this._scheduleSpectrogramTasks(l,c,Fo.HIGH,i,o,t,"current-view",Do.P7)&&this.redrawSpectrogramFromCache("all-in-cache"),Do.Cq&&this.audio){const e=this.audio.sampleRate,n=Math.max(d,Math.round(Do.v*e)),s=c,a=s+n;this._scheduleSpectrogramTasks(s,a,Fo.NORMAL,i,o,t,"precache-view-normal",Do.l2)}this.lastSpectrogramRenderedScrollLeftPx=n,this.lastSpectrogramRenderedWidth=e.width,this.lastSpectrogramRenderedZoom=e.zoom,this.spectrogramNeedsRedraw=!1}else if(Math.abs(i)>0){const o=-i;this.spectrogram.shift(o,0),this.lastSpectrogramRenderedScrollLeftPx=n;const s=Math.floor(Oi(n*e.samplesPerPx,0,t)),a=Math.ceil(Oi(s+e.width*e.samplesPerPx,0,t)),r=Math.round(i*e.samplesPerPx);let l,c;const d=Math.ceil(e.samplesPerPx*Do.cH);i>0?(l=Math.max(0,a-r-d),c=a):(l=s,c=Math.min(t,s-r+d));const u=0;l=Math.floor(Oi(l-u,0,t)),c=Math.ceil(Oi(c+u,0,t));0===this.schedulePartialSpectrogramComputations(l,c)&&this.redrawSpectrogramSliceFromCache("all-in-cache",l,c)}else this.redrawSpectrogramFromCache("delta-0")}catch(e){console.warn(`Error during spectrogram sync/schedule phase:${e}`)}for(const t of this.plugins)t.render(e);null==(t=this.onRenderTransfer)||t.call(this)}destroy(){var e;null==(e=this.fftProcessor)||e.dispose(),this.fftProcessor=null}renderFFTData(e,t,n,i,o){const s=Math.floor(i);if(!e)return t.save(),t.fillStyle="rgba(128, 128, 128, 0.05)",t.fillRect(s,Math.floor(o),1,Math.ceil(n)),void t.restore();const a=this.spectrogramScale;let r=e;if("linear"===a){r=function(e,t){const n=e.length;if(t>=n)return e;const i=Math.floor(n/t),o=new Float32Array(t),s=Math.floor(t*Do.pr);for(let n=0;n<t;n++)if(n<s){let t=0;for(let o=0;o<i;o++)t+=e[n*i+o];o[n]=t/i}else{let t=Number.NEGATIVE_INFINITY;for(let o=0;o<i;o++)t=Math.max(t,e[n*i+o]);o[n]=t}return o}(e,Math.min(Do.vt,e.length))}else if("log"===a){r=function(e,t){const n=e.length;if(t>=n)return e;const i=new Float32Array(t),o=Math.log(1),s=Math.log(n+1);for(let a=0;a<t;a++){let r=Math.floor(Math.exp(o+a/t*(s-o))-1),l=Math.floor(Math.exp(o+(a+1)/t*(s-o))-1);r=Math.max(0,r),l=Math.max(r+1,l);let c=0,d=Number.NEGATIVE_INFINITY,u=0;for(let t=r;t<l&&t<n;t++)c+=e[t],d=Math.max(d,e[t]),u++;i[a]=0===u?e[0]:a<t*Do.pr?c/u:d}return i}(e,Math.min(Do.gt,e.length))}else if("mel"===a){r=function(e,t){const n=e.length;if(t>=n)return e;const i=Math.floor(n/t),o=new Float32Array(t);for(let s=0;s<t;s++){let a=0,r=0;const l=Math.floor((s+.5)*n/t),c=Math.max(0,l-Math.floor(i/2)),d=Math.min(n,l+Math.ceil(i/2));for(let t=c;t<d;t++)a+=e[t],r++;o[s]=r>0?a/r:0}return o}(e,Math.min(Do.A3,e.length))}const l=r.length;if(l<=0||n<=0)return;const c=this.spectrogramMinDb,d=this.spectrogramMaxDb-c;if(!(d<=0))for(let e=0;e<l;e++){const i=r[e],u=10*Math.log10(Math.max(1e-9,i)),h=Math.max(0,Math.min(1,(u-c)/d)),g=this.colorMapper.magnitudeToColor(h);let m,p,f;switch(a){case"log":{const t=Math.log(l+1);p=o+n*(1-Math.log(e+1)/t),m=o+n*(1-Math.log(e+2)/t),f=p-m;break}default:p=o+n*(1-e/l),m=o+n*(1-(e+1)/l),f=n/l}const v=Math.max(1,Math.ceil(f));t.fillStyle=g,t.fillRect(s,Math.floor(m),1,v)}}renderSpectrogramSlice(e,t,n,i,o,s=0){if(!this.lastRenderContext||!this.audio||t<=0||this.lastRenderContext.samplesPerPx<=0||!this.fftProcessor)return;const a=this.lastRenderContext.samplesPerPx,r=this.lastRenderContext.width,l=this._getCurrentHopSize(),c=this.fftProcessor.fftSamples,d=Math.floor(c/2),u=o*t;e.save();const h=Math.max(0,Math.floor(s)),g=i-n,m=Math.ceil(g/a),p=Math.min(r,h+m);for(let i=h;i<p;i++){const s=n+(i-h+.5)*a,r=Math.max(0,Math.floor((s-d)/l+.5))*l,c=this.getFFTFromCache(o,r);null!==c&&this.renderFFTData(c,e,t,i,u)}e.restore()}_scheduleSpectrogramTasks(e,t,n,i,o,s,a,r){const l=[];if(!this.audio)return 0;const c=Math.floor(e),d=Math.ceil(t);for(let e=0;e<this.audio.channelCount;e++){const t=Math.floor((c-Math.floor(o/2))/i),a=Math.ceil((d+Math.floor(o/2))/i);for(let r=t;r<=a;r++){const t=r*i;if(t+o>s||t<0)continue;const a=`${e}:${t}`;this.hasFFTInCache(e,t)||l.push({id:a,priority:n,taskFn:()=>this.calculateHopSpectrum(e,t)})}}if(l.length>0){const e={type:a,priority:n,startSample:c,endSample:d,correlationId:`${a}-${n}-${c}-${d}`};void 0!==r&&(e.batchSize=r),this.computationQueue.addBatch(l,e)}return l.length}schedulePartialSpectrogramComputations(e,t){if(!this.lastRenderContext||!this.audio||!this.fftProcessor||e>=t)return 0;const n=this.fftProcessor.fftSamples,i=this.lastRenderContext.dataLength,o=this._getCurrentHopSize(),s=Math.floor(e),a=Math.ceil(t),r=this._scheduleSpectrogramTasks(s,a,Fo.HIGH,o,n,i,"current-view-partial");if(Do.Cq){const e=this.audio.sampleRate,t=this.lastRenderContext.width*this.lastRenderContext.samplesPerPx/e,s=this.getBufferDurationSec(Do.bW,Do.v,t),r=a,l=r+Math.round(e*s);this._scheduleSpectrogramTasks(r,l,Fo.NORMAL,o,n,i,"precache-view-normal",Do.l2)}return r}_getCurrentHopSize(){var e,t;if(!this.lastRenderContext||!this.audio)return 0;if(!this.fftProcessor)return Math.max(1,Math.floor(this.fftSamples/this.spectrogramHopFactor));const n=this.lastRenderContext.samplesPerPx,i=this.lastRenderContext.width,o=null!=(e=null==(t=this.audio)?void 0:t.dataLength)?e:0,s=this.lastRenderContext.scrollLeftPx,a=Math.floor(Oi(s*n,0,o)),r=Math.ceil(Oi(a+i*n,0,o))-a,l=Math.min(i,Do.KC);return Math.max(1,Math.floor(r/l))}hasFFTInCache(e,t){return!!this.fftCache.has(e)&&this.fftCache.get(e).has(t)}getFFTFromCache(e,t){return this.hasFFTInCache(e,t)&&this.fftCache.get(e).get(t)||null}calculateHopSpectrum(e,t){if(!this.lastRenderContext||!this.audio||!this.fftProcessor)return null;const n=t+this.fftProcessor.fftSamples;if(n>this.lastRenderContext.dataLength)return null;const i=this.getChannelDataSlice(e,t,n);if(!i)return null;const o=this.fftProcessor.calculatePowerSpectrum(i);if(!o)return null;let s=null;return s="mel"===this.spectrogramScale?this.fftProcessor.convertToMelScale(o,this.numberOfMelBands):(this.spectrogramScale,o),s&&(this.fftCache.has(e)||this.fftCache.set(e,new Vo(Do.Um)),this.fftCache.get(e).set(t,s)),s}redrawSpectrogramFromCache(e){var t;if(!this.lastRenderContext)return;const n=this.lastRenderContext,i=null==(t=this.lastRenderContext)?void 0:t.scrollLeftPx,o=Oi(i*n.samplesPerPx,0,n.dataLength),s=Oi(o+n.width*n.samplesPerPx,0,n.dataLength);this.redrawSpectrogramSliceFromCache(e,o,s)}redrawSpectrogramSliceFromCache(e,t,n){var i;if(this.lastRenderContext&&!this.isDestroyed&&null!=(i=this.spectrogram)&&i.isVisible&&this.audio){if(this.spectrogramDrawing)return console.warn("redrawSpectrogramSliceFromCache already running.");this.spectrogramDrawing=!0;try{const e=this.lastRenderContext.dataLength,i=this.lastRenderContext.scrollLeftPx,o=this.lastRenderContext.samplesPerPx,s=Oi(t,0,e),a=Oi(Math.ceil(n),0,e),r=s/o-i;for(let e=0;e<this.audio.channelCount;e++)this.renderSpectrogramSlice(this.spectrogram,this.config.channelHeight,s,a,e,r)}catch(e){console.error("Error during redrawSpectrogramSliceFromCache:",e)}finally{this.spectrogramDrawing=!1}}}getChannelDataSlice(e,t,n){if(!this.audio||!this.audio.chunks||!this.audio.chunks[e]||t>=n||e<0||e>=this.audio.channelCount)return null;const i=this.audio.chunks[e],o=new Float32Array(n-t);let s=0;for(const e of i){const i=s,a=i+e.length,r=Math.max(t,i),l=Math.min(n,a);if(r<l){const n=l-r,s=r-i,a=r-t;if(s>=0&&s+n<=e.length&&a>=0&&a+n<=o.length){const t=e.subarray(s,s+n);o.set(t,a)}else console.error("getChannelDataSlice: Calculated indices out of bounds during copy.")}if(s=a,a>=n)break}return o}getForceClearCount(){var e;return null!=(e=this.forceCachedExcedLimit)?e:0}getCurrentHopSize(){return this._getCurrentHopSize()}getBufferDurationSec(e,t,n){return Math.max(e*n,t)}updateConfig(e){const t=void 0!==e.spectrogramScale&&e.spectrogramScale!==this.spectrogramScale||void 0!==e.spectrogramHopFactor&&e.spectrogramHopFactor!==this.spectrogramHopFactor||void 0!==e.colorMapper&&e.colorMapper!==this.colorMapper||void 0!==e.fftCache&&e.fftCache!==this.fftCache||void 0!==e.fftSamples&&e.fftSamples!==this.fftSamples||void 0!==e.windowFunction&&e.windowFunction!==this.windowFunction||void 0!==e.numberOfMelBands&&e.numberOfMelBands!==this.numberOfMelBands;this.config=Object.assign({},this.config,e),void 0!==e.spectrogramMinDb&&(this.spectrogramMinDb=e.spectrogramMinDb),void 0!==e.spectrogramScale&&(this.spectrogramScale=e.spectrogramScale),void 0!==e.spectrogramHopFactor&&(this.spectrogramHopFactor=e.spectrogramHopFactor),void 0!==e.colorMapper&&(this.colorMapper=e.colorMapper),void 0!==e.fftCache&&(this.fftCache=e.fftCache),void 0!==e.spectrogramColorScheme&&(this.spectrogramColorScheme=e.spectrogramColorScheme),void 0!==e.spectrogramMaxDb&&(this.spectrogramMaxDb=e.spectrogramMaxDb),void 0!==e.numberOfMelBands&&(this.numberOfMelBands=e.numberOfMelBands),void 0!==e.fftSamples&&(this.fftSamples=e.fftSamples),void 0!==e.windowFunction&&(this.windowFunction=e.windowFunction),this.spectrogramNeedsRedraw=!0,t&&this.fftCache.clear();for(const t of this.plugins)t.updateConfig(e)}resetRenderState(){this.lastSpectrogramRenderedWidth=0,this.lastSpectrogramRenderedZoom=0,this.lastSpectrogramRenderedScrollLeftPx=0,this.spectrogramNeedsRedraw=!0}setVisibility(e){if(this.spectrogram)for(const t of this.plugins)t.updateConfig({visible:e})}onResize(){this.resetRenderState();for(const e of this.plugins)"function"==typeof e.onResize&&e.onResize()}}class Go{constructor({layer:e,config:t,componentName:n,onNeedsTransfer:i,onHeightChange:o}){this.config=void 0,this.layer=void 0,this.componentName=void 0,this.onNeedsTransfer=void 0,this.onHeightChange=void 0,this.isDestroyed=!1,this.isHovered=!1,this.isDragging=!1,this.dragStartY=0,this.dragStartHeight=0,this.lastRenderContext=void 0,this.handleGlobalMouseMove=e=>{if(this.isDragging&&this.onHeightChange){const t=e.clientY-this.dragStartY,n=Math.max(50,this.dragStartHeight+t);this.onHeightChange(this.componentName,n)}},this.handleGlobalMouseUp=e=>{this.isDragging&&(this.isDragging=!1,this.removeGlobalMouseListeners())},this.layer=e,this.componentName=n,this.onNeedsTransfer=i,this.onHeightChange=o,this.config=Object.assign({borderColor:"#666",borderWidth:1,borderStyle:"solid",opacity:.2,hoverOpacity:.6,handleColor:"#666",handleOpacity:.4,handleHoverOpacity:.9},t)}init(e){}draw(e){var t,n,i,o,s;if(this.lastRenderContext=e,this.isDestroyed||!this.layer.isVisible)return;const a=this.layer.context;if(!a)return;const{width:r}=e,l=this.layer.height/this.layer.pixelRatio,c=this.layer.pixelRatio;if(this.layer.clear(),a.save(),this.isHovered){var d,u;const e=this.isHovered?this.config.hoverOpacity:this.config.opacity;switch(a.globalAlpha=null!=e?e:.2,a.strokeStyle=null!=(d=this.config.borderColor)?d:"#666",a.lineWidth=2*(null!=(u=this.config.borderWidth)?u:1)*c,this.config.borderStyle){case"dashed":a.setLineDash([5*c,5*c]);break;case"dotted":a.setLineDash([2*c,2*c]);break;default:a.setLineDash([])}a.strokeRect(.5*c,.5*c,(r-1)*c,(l-1)*c)}if(this.isDragging){const e=100,t=28,n=(r-e)/2,i=(l-t)/2,o="rgba(0, 0, 0, 0.8)",s="rgba(255, 255, 255, 0.3)",d="#ffffff";a.fillStyle=o,a.globalAlpha=.9,this.drawRoundedRect(a,n*c,i*c,e*c,t*c,4*c),a.strokeStyle=s,a.lineWidth=1*c,a.globalAlpha=.8,this.drawRoundedRect(a,n*c,i*c,e*c,t*c,4*c,!0);const u=`${Math.round(r)}Ã—${Math.round(l)}`;a.fillStyle=d,a.font=`bold ${13*c}px Arial`,a.textAlign="center",a.textBaseline="middle",a.globalAlpha=1,a.fillText(u,r/2*c,l/2*c)}const h=(r-60)/2,g=l-6-8;a.fillStyle=null!=(t=this.config.handleColor)?t:"#666";const m=this.isHovered?this.config.handleHoverOpacity:this.config.handleOpacity;a.globalAlpha=null!=m?m:.4,a.shadowColor=null!=(n=this.config.shadowColor)?n:"rgba(0, 0, 0, 0.3)",a.shadowBlur=(null!=(i=this.config.shadowBlur)?i:4)*c,a.shadowOffsetX=(null!=(o=this.config.shadowOffsetX)?o:0)*c,a.shadowOffsetY=(null!=(s=this.config.shadowOffsetY)?s:2)*c,this.drawRoundedRect(a,h*c,g*c,60*c,6*c,3*c),a.strokeStyle=this.isHovered?"#ffffff":"#cccccc",a.lineWidth=1*c,a.globalAlpha=.8,a.shadowColor="transparent",this.drawRoundedRect(a,h*c,g*c,60*c,6*c,3*c,!0),a.restore(),this.onNeedsTransfer&&this.onNeedsTransfer()}destroy(){this.isDestroyed=!0,this.removeGlobalMouseListeners()}updateConfig(e){this.config=Object.assign({},this.config,e)}onResize(){}hitTest(e,t){if(!this.layer.isVisible||this.isDestroyed||!this.lastRenderContext)return!1;const n=this.lastRenderContext.width,i=this.layer.height/this.layer.pixelRatio;if(e<0||e>n||t<0||t>i)return!1;const o=(n-60)/2,s=i-6-8,a=this.isDragging?8:4,r=o-a,l=s-a;return e>=r&&e<=r+(60+2*a)&&t>=l&&t<=l+(6+2*a)}onMouseEnter(e){this.isHovered||(this.isHovered=!0,this.lastRenderContext&&this.draw(this.lastRenderContext))}onMouseLeave(e){this.isHovered&&!this.isDragging&&(this.isHovered=!1,this.lastRenderContext&&this.draw(this.lastRenderContext))}onMouseMove(e){if(this.isDragging&&this.onHeightChange){const t=e.clientY-this.dragStartY,n=Math.max(50,this.dragStartHeight+t);this.onHeightChange(this.componentName,n)}}onMouseDown(e){this.isDragging=!0,this.dragStartY=e.clientY,this.dragStartHeight=this.layer.height/this.layer.pixelRatio,e.preventDefault(),e.stopPropagation(),document.addEventListener("mousemove",this.handleGlobalMouseMove),document.addEventListener("mouseup",this.handleGlobalMouseUp)}onMouseUp(e){this.isDragging&&(this.isDragging=!1,this.removeGlobalMouseListeners())}removeGlobalMouseListeners(){document.removeEventListener("mousemove",this.handleGlobalMouseMove),document.removeEventListener("mouseup",this.handleGlobalMouseUp)}onClick(e){}getCursor(){return this.isDragging?"grabbing":"ns-resize"}isEnabled(){return!this.isDestroyed&&this.layer.isVisible}getZIndex(){return 200}drawRoundedRect(e,t,n,i,o,s,a=!1){e.beginPath(),e.moveTo(t+s,n),e.lineTo(t+i-s,n),e.quadraticCurveTo(t+i,n,t+i,n+s),e.lineTo(t+i,n+o-s),e.quadraticCurveTo(t+i,n+o,t+i-s,n+o),e.lineTo(t+s,n+o),e.quadraticCurveTo(t,n+o,t,n+o-s),e.lineTo(t,n+s),e.quadraticCurveTo(t,n,t+s,n),e.closePath(),a?e.stroke():e.fill()}}class Yo{constructor(e,t){this.renderFn=void 0,this.props=void 0,this.renderFn=e,this.props=t}static lift(e){return new Yo((t,n)=>{if(!e.isVisible)return;const i=function(e,t){return{x:e.x*t.width,y:e.y*t.height,width:e.width*t.width,height:e.height*t.height}}(n,t);e.drawToRegion(t,i.x,i.y,i.width,i.height)},{isVisible:()=>e.isVisible,width:()=>e.isVisible?e.width:0,height:()=>e.isVisible?e.height:0})}bind(e){return e(this.renderFn,this.props)}map(e){const[t,n]=e(this.renderFn,this.props);return new Yo(t,n)}onTopOf(e){return new Yo((t,n)=>{e.renderTo(t,n),this.renderTo(t,n)},{isVisible:()=>this.props.isVisible()||e.props.isVisible(),width:()=>Math.max(this.props.width(),e.props.width()),height:()=>Math.max(this.props.height(),e.props.height())})}above(e){return new Yo((t,n)=>{const i=[this,e].filter(e=>e.isVisible()),o=i.map(e=>e.props),s=o.reduce((e,t)=>e+t.height(),0);let a=n.y;for(let e=0;e<i.length;e++){const r=o[e].height()/s*n.height;i[e].renderTo(t,{x:n.x,y:a,width:n.width,height:r}),a+=r}},{isVisible:()=>this.props.isVisible()||e.props.isVisible(),width:()=>Math.max(this.props.width(),e.props.width()),height:()=>this.props.height()+e.props.height()})}below(e){return e.above(this)}static vStack(e){if(0===e.length)throw new Error("Cannot create empty vStack");const t=e.map(e=>e.props);return new Yo((t,n)=>{const i=e.filter(e=>e.isVisible()),o=i.map(e=>e.props),s=o.reduce((e,t)=>e+t.height(),0);let a=n.y;for(let e=0;e<i.length;e++){const r=o[e].height()/s*n.height;i[e].renderTo(t,{x:n.x,y:a,width:n.width,height:r}),a+=r}},{isVisible:()=>t.some(e=>e.isVisible()),width:()=>Math.max(...t.map(e=>e.width())),height:()=>t.reduce((e,t)=>e+t.height(),0)})}static hStack(e){if(0===e.length)throw new Error("Cannot create empty hStack");const t=e.map(e=>e.props);return new Yo((t,n)=>{const i=e.filter(e=>e.isVisible()),o=i.map(e=>e.props),s=o.reduce((e,t)=>e+t.width(),0);let a=n.x;for(let e=0;e<i.length;e++){const r=o[e].width()/s*n.width;i[e].renderTo(t,{x:a,y:n.y,width:r,height:n.height}),a+=r}},{isVisible:()=>t.some(e=>e.isVisible()),width:()=>t.reduce((e,t)=>e+t.width(),0),height:()=>Math.max(...t.map(e=>e.height()))})}static overlay(e){if(0===e.length)throw new Error("Cannot create empty overlay");const t=e.map(e=>e.props);return new Yo((t,n)=>{for(const i of e)i.renderTo(t,n)},{isVisible:()=>t.some(e=>e.isVisible()),width:()=>Math.max(...t.map(e=>e.width())),height:()=>Math.max(...t.map(e=>e.height()))})}renderTo(e,t={x:0,y:0,width:1,height:1}){this.renderFn(e,t)}isVisible(){return this.props.isVisible()}getDimensions(){return{width:this.props.width(),height:this.props.height()}}static ifM(e,t,n){const i="function"==typeof e?e:()=>e;return new Yo((e,o)=>{i()?t.renderTo(e,o):n.renderTo(e,o)},{isVisible:()=>i()?t.props.isVisible():n.props.isVisible(),width:()=>i()?t.props.width():n.props.width(),height:()=>i()?t.props.height():n.props.height()})}shift(e,t){const n=this.props;return new Yo((n,i)=>{const o=n.pixelRatio||window.devicePixelRatio||1,s=e*o/n.width,a=t*o/n.height;this.renderTo(n,{x:i.x+s,y:i.y+a,width:i.width-s,height:i.height-a})},n)}}class Xo{constructor({container:e,pixelRatio:t=1,getLayerInfo:n}){this.container=void 0,this.pixelRatio=void 0,this.getLayerInfo=void 0,this.interactiveObjects=[],this.hoveredObject=null,this.draggedObject=null,this.isDestroyed=!1,this.handleMouseMove=e=>{if(this.isDestroyed)return;const{x:t,y:n}=this.getRelativeCoordinates(e);var i,o;if(this.draggedObject)return void(null==(i=(o=this.draggedObject).onMouseMove)||i.call(o,e));const s=this.findInteractiveUnderPoint(t,n);if(s!==this.hoveredObject){var a,r;if(this.hoveredObject)null==(a=(r=this.hoveredObject).onMouseLeave)||a.call(r,e);s&&(null==s.onMouseEnter||s.onMouseEnter(e)),this.hoveredObject=s,this.updateCursor(s)}var l,c;this.hoveredObject&&(null==(l=(c=this.hoveredObject).onMouseMove)||l.call(c,e))},this.handleMouseDown=e=>{if(this.isDestroyed)return;const{x:t,y:n}=this.getRelativeCoordinates(e),i=this.findInteractiveUnderPoint(t,n);i&&(this.draggedObject=i,null==i.onMouseDown||i.onMouseDown(e),this.updateCursor(i))},this.handleMouseUp=e=>{if(this.isDestroyed)return;const{x:t,y:n}=this.getRelativeCoordinates(e),i=this.findInteractiveUnderPoint(t,n);var o,s;this.draggedObject&&(null==(o=(s=this.draggedObject).onMouseUp)||o.call(s,e),this.draggedObject=null);i&&(null==i.onMouseUp||i.onMouseUp(e)),this.updateCursor(i)},this.handleClick=e=>{if(this.isDestroyed)return;const{x:t,y:n}=this.getRelativeCoordinates(e),i=this.findInteractiveUnderPoint(t,n);i&&(null==i.onClick||i.onClick(e))},this.handleDoubleClick=e=>{if(this.isDestroyed)return;const{x:t,y:n}=this.getRelativeCoordinates(e),i=this.findInteractiveUnderPoint(t,n);i&&(null==i.onDoubleClick||i.onDoubleClick(e))},this.handleMouseLeave=e=>{var t,n;this.isDestroyed||this.hoveredObject&&(null==(t=(n=this.hoveredObject).onMouseLeave)||t.call(n,e),this.hoveredObject=null,this.container.style.cursor="")},this.container=e,this.pixelRatio=t,this.getLayerInfo=n,this.attachEvents()}register(e){this.interactiveObjects.includes(e)||(this.interactiveObjects.push(e),this.interactiveObjects.sort((e,t)=>{var n,i;const o=null!=(n=null==e.getZIndex?void 0:e.getZIndex())?n:0;return(null!=(i=null==t.getZIndex?void 0:t.getZIndex())?i:0)-o}))}unregister(e){const t=this.interactiveObjects.indexOf(e);-1!==t&&this.interactiveObjects.splice(t,1),this.hoveredObject===e&&(this.hoveredObject=null),this.draggedObject===e&&(this.draggedObject=null)}findInteractiveUnderPoint(e,t){for(const n of this.interactiveObjects)if(!1!==(null==n.isEnabled?void 0:n.isEnabled())){const i=this.getLayerCoordinates(n,e,t);if(i&&n.hitTest(i.x,i.y))return n}return null}getLayerCoordinates(e,t,n){if(!this.getLayerInfo)return{x:t,y:n};const i=this.getLayerInfo(e);if(!i)return null;const o=t-i.offsetX,s=n-i.offsetY;return o<0||o>i.width||s<0||s>i.height?null:{x:o,y:s}}getRelativeCoordinates(e){const t=this.container.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}updateCursor(e){if(null!=e&&e.getCursor){const t=e.getCursor();this.container.style.cursor=t}else this.container.style.cursor=""}attachEvents(){this.container.addEventListener("mousemove",this.handleMouseMove),this.container.addEventListener("mousedown",this.handleMouseDown),this.container.addEventListener("mouseup",this.handleMouseUp),this.container.addEventListener("click",this.handleClick),this.container.addEventListener("dblclick",this.handleDoubleClick),this.container.addEventListener("mouseleave",this.handleMouseLeave)}removeEvents(){this.container.removeEventListener("mousemove",this.handleMouseMove),this.container.removeEventListener("mousedown",this.handleMouseDown),this.container.removeEventListener("mouseup",this.handleMouseUp),this.container.removeEventListener("click",this.handleClick),this.container.removeEventListener("dblclick",this.handleDoubleClick),this.container.removeEventListener("mouseleave",this.handleMouseLeave)}setPixelRatio(e){this.pixelRatio=e}getInteractiveObjects(){return this.interactiveObjects}destroy(){this.isDestroyed=!0,this.removeEvents(),this.interactiveObjects.length=0,this.hoveredObject=null,this.draggedObject=null}}const qo=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING);class Zo extends Zi{constructor(e,t){var n,i,o,s,a,r,l,c,d,u,h,g,m,p,f,v,y,b,x,w,S,C,k,P,R,j,N,T,_;super(),n=this,this.wrapper=void 0,this.scrollFiller=void 0,this.layers=new Map,this.observer=void 0,this.currentTime=0,this.audio=void 0,this.zoom=1,this.scrollLeft=0,this.renderId=0,this.amp=1,this.seekLocked=!1,this.wf=void 0,this.waveContainer=void 0,this.playheadPadding=4,this.zoomToCursor=!1,this.autoCenter=!1,this.splitChannels=!1,this.padding={top:0,bottom:0,left:0,right:0},this.gridWidth=1,this.gridColor=Po("rgba(0, 0, 0, 0.1)"),this.backgroundColor=Po("#fff"),this.waveColor=Po("#000"),this.waveformHeight=32,this.spectrogramHeight=32,this.timelineHeight=20,this._container=void 0,this._loader=void 0,this.composer=void 0,this.timelinePlacement="top",this.maxZoom=1500,this.playhead=void 0,this.reservedSpace=0,this.samplesPerPx=0,this.waveformRenderer=void 0,this.spectrogramRenderer=void 0,this.waveformResizeRenderer=void 0,this.spectrogramResizeRenderer=void 0,this.renderers=[],this.rateLimitedTransfer=void 0,this.interactionManager=void 0,this.initialSpectrogramHeight=void 0,this.initialWaveformHeight=void 0,this.drawRequestId=null,this.drawRequestDry=!0,this.invokeLayersUpdated=((e,t,{leading:n=!1}={})=>{let i;return(...o)=>{i&&clearTimeout(i),n&&e(...o),i=setTimeout(()=>e(...o),t)}})(async function(){n.invoke("layersUpdated",[n.layers])},150),this.playHeadMove=(e,t)=>{if(this.wf.loaded&&e.target&&this.container.contains(e.target)){const{x:n,y:i}=t,{playhead:o,playheadPadding:s,height:a}=this,r=this.reservedSpace-o.capHeight-o.capPadding;n>=o.x-s&&n<=o.x+o.width+s&&i>=r&&i<=a?(o.isHovered||o.invoke("mouseEnter",[e]),this.draw()):o.isHovered&&(o.invoke("mouseLeave",[e]),this.draw())}},this.handleSeek=e=>{if(e.offsetY>this.height)return;const t=this.getLayer("main");if(!this.wf.loaded||this.seekLocked||!(e.target instanceof Node&&null!=t&&t.canvas&&t.canvas instanceof HTMLCanvasElement&&t.canvas.contains(e.target)))return;const n=this.wrapper.getBoundingClientRect().left,i=e.clientX-n,o=this.wf.duration,s=this.scrollLeft+i/this.container.clientWidth/this.zoom,a=Oi(i,0,this.width);this.playhead.setX(a),this.wf.currentTime=s*o},this.handleMouseDown=e=>{e.offsetY>this.height||this.wf.loaded&&(e._pixelRatio=this.pixelRatio||window.devicePixelRatio||1,this.playhead.invoke("mouseDown",[e]))},this.handlePlaying=e=>{this.wf.loaded&&(this.currentTime=e/this.wf.duration,this.draw())},this.handleScroll=e=>{if(this.wf.loaded)if(this.isZooming(e)){const t=this.wf.currentTime,n=.1*e.deltaY,i=this.zoom*(1-n);requestAnimationFrame(()=>{this.setZoom(i),this.updateCursorToTime(t),this.wf.playing||this.transferImage()})}else if(this.zoom>1){const t=this.scrollWidth,n=t/this.fullWidth*this.zoom,i=(0===Math.abs(e.deltaX)?e.deltaY:e.deltaX)*this.zoom*1.25,o=t*(this.scrollLeft*this.zoom),s=Math.max(0,o+i),a=Oi(s/t,0,n)/this.zoom;a!==this.scrollLeft&&(this.wf.invoke("scroll",[a]),this.setScrollLeft(a))}},this.preventScrollX=e=>{const[t,n]=[Math.abs(e.deltaX),Math.abs(e.deltaY)];(t>=n||this.isZooming(e)&&n>=t)&&(e.preventDefault(),e.stopPropagation())},this.handleResize=()=>{if(!this.wf.duration)return;this.setContainerHeight();const e=this.getLayer("main");e&&(e.pixelRatio=this.pixelRatio,e.width=this.width,e.height=this.height),this.layers.forEach(e=>{"main"!==e.name&&(e.pixelRatio=this.pixelRatio,e.width=this.width,"waveform"===e.name||"waveform-resize"===e.name?e.height=this.waveformLayerHeight:("spectrogram"===e.name||"spectrogram-grid"===e.name||"spectrogram-resize"===e.name)&&(e.height=this.spectrogramLayerHeight),"regions"===e.name&&(e.height=this.height))}),this.updateSize(),this.updateCursorToTime(this.wf.currentTime),this.updateScrollFiller(),this.setScrollLeft(this.scrollLeft),this.wf.renderTimeline(),this.interactionManager&&this.interactionManager.setPixelRatio(this.pixelRatio);for(const e of this.renderers)"function"==typeof e.onResize&&e.onResize();this.draw()},this.handleHeightChange=(e,t)=>{let n=0;var i;if("waveform"===e)n=this.initialWaveformHeight*(this.splitChannels&&(null==(i=this.audio)?void 0:i.channelCount)||1);else if("spectrogram"===e){var o;n=this.initialSpectrogramHeight*(this.splitChannels&&(null==(o=this.audio)?void 0:o.channelCount)||1)}const s=Math.max(500,n),a=Math.max(50,Math.min(s,t));if("waveform"===e){var r;this.splitChannels&&null!=(r=this.audio)&&r.channelCount?this.waveformHeight=a/this.audio.channelCount:this.waveformHeight=a;const e=this.getLayer("waveform"),t=this.getLayer("waveform-resize"),n=this.getLayer("background");e&&(e.height=this.waveformLayerHeight),t&&(t.height=this.waveformLayerHeight),n&&(n.height=this.waveformLayerHeight),this.waveformRenderer&&(this.waveformRenderer.config.waveHeight=this.waveformHeight)}else if("spectrogram"===e){var l;this.splitChannels&&null!=(l=this.audio)&&l.channelCount?this.spectrogramHeight=a/this.audio.channelCount:this.spectrogramHeight=a;const e=this.getLayer("spectrogram"),t=this.getLayer("spectrogram-resize"),n=this.getLayer("spectrogram-grid");e&&(e.height=this.spectrogramLayerHeight),t&&(t.height=this.spectrogramLayerHeight),n&&(n.height=this.spectrogramLayerHeight),this.spectrogramRenderer&&(this.spectrogramRenderer.config.channelHeight=this.channelHeight)}this.setContainerHeight(),this.createComposer();const c=this.getLayer("main");c&&(c.height=this.height);const d=this.getLayer("regions");d&&(d.height=this.height);for(const e of this.renderers)"function"==typeof e.onResize&&e.onResize();this.interactionManager&&this.interactionManager.setPixelRatio(this.pixelRatio),this.transferImage(),this.updateCursorToTime(this.wf.currentTime),this.playhead.onInit(),setTimeout(()=>this.draw())};const A="Dark"===(0,Pn.j17)();if(this.wf=t,this.waveContainer=e.container,this.waveColor=e.waveColor?Po(e.waveColor):this.waveColor,this.padding=Object.assign({},this.padding,e.padding),this.playheadPadding=null!=(i=null==(o=e.playhead)?void 0:o.padding)?i:this.playheadPadding,this.zoomToCursor=null!=(s=e.zoomToCursor)?s:this.zoomToCursor,this.autoCenter=null!=(a=e.autoCenter)?a:this.autoCenter,this.splitChannels=null!=(r=e.splitChannels)?r:this.splitChannels,this.waveformHeight=null!=(l=null!=(c=null!=(d=e.waveformHeight)?d:e.height)?c:e.waveHeight)?l:32,this.spectrogramHeight=null!=(u=null!=(h=null!=(g=e.spectrogramHeight)?g:e.height)?h:e.waveHeight)?u:32,this.initialWaveformHeight=this.waveformHeight,this.initialSpectrogramHeight=this.spectrogramHeight,this.timelineHeight=null!=(m=null!=(p=e.timelineHeight)?p:null==(f=e.timeline)?void 0:f.height)?m:20,this.timelinePlacement=null!=(v=null==e||null==(y=e.timeline)?void 0:y.placement)?v:this.timelinePlacement,this.gridColor=e.gridColor?Po(e.gridColor):this.gridColor,this.gridWidth=null!=(b=e.gridWidth)?b:this.gridWidth,this.backgroundColor=e.backgroundColor?Po(e.backgroundColor):this.backgroundColor,this.zoom=null!=(x=e.zoom)?x:this.zoom,this.amp=null!=(w=e.amp)?w:this.amp,this.playhead=new Io(Object.assign({},e.playhead,{x:0,color:Po(A?"#fff":"#000"),fillColor:Po(A?"#fff":"#BAE7FF"),width:null!=(S=e.cursorWidth)?S:2}),this,this.wf),this.container){const e=this.waveformHeight;this.timelineHeight,this.container.style.height=`${e}px`}this.createLayers();const I=this.getLayer("main");if(!(null!=I&&I.canvas&&I.canvas instanceof HTMLCanvasElement))throw new Error("Main canvas not found or not an HTMLCanvasElement");this.interactionManager=new Xo({container:I.canvas,pixelRatio:this.pixelRatio,getLayerInfo:this.getLayerInfo.bind(this)});const M=this.getLayer("waveform"),E=this.getLayer("background");if(!M)throw new Error("Waveform layer not found");if(!E)throw new Error("Background layer not found");this.waveformRenderer=new zo({layer:M,backgroundLayer:E,config:{renderId:this.renderId,waveHeight:this.waveformHeight,padding:this.padding,reservedSpace:this.reservedSpace,waveColor:this.waveColor},onRenderTransfer:this.transferImage.bind(this)});const K=this.getLayer("waveform-resize");K&&(this.waveformResizeRenderer=new Go({layer:K,config:{borderColor:A?"#444":"#ddd",borderWidth:5,borderStyle:"solid",opacity:.3,hoverOpacity:.6,handleColor:"#ffffff",handleOpacity:.8,handleHoverOpacity:1,shadowColor:"rgba(0, 0, 0, 0.3)",shadowBlur:8,shadowOffsetX:0,shadowOffsetY:4},componentName:"waveform",onNeedsTransfer:this.transferImage.bind(this),onHeightChange:this.handleHeightChange}),this.interactionManager.register(this.waveformResizeRenderer)),this.attachEvents();const D=null!=(C=e.spectrogramColorScheme)?C:Eo,O=new Ko(D),L=null!=(k=e.spectrogramScale)?k:"mel",z=null!=(P=e.numberOfMelBands)?P:Do.BK.MEL_BANDS,B=null!=(R=e.spectrogramHopFactor)?R:2,F=null!=(j=e.spectrogramMinDb)?j:Do.BK.MIN_DB,H=null!=(N=e.spectrogramMaxDb)?N:Do.BK.MAX_DB,V=null!=(T=e.spectrogramFftSamples)?T:Do.BK.FFT_SAMPLES,$=null!=(_=e.spectrogramWindowingFunction)?_:Do.BK.WINDOWING_FUNCTION,W=new Map;if((0,Ne.VS)(Ne.ji)){this.spectrogramRenderer=new Uo(this._container,this.getLayer("spectrogram"),this.getLayer("spectrogram-grid"),{channelHeight:this.channelHeight,spectrogramMinDb:F,spectrogramScale:L,spectrogramHopFactor:B,colorMapper:O,fftCache:W,spectrogramColorScheme:D,spectrogramMaxDb:H,numberOfMelBands:z,fftSamples:V,windowFunction:$},this.transferImage.bind(this));const e=this.getLayer("spectrogram-resize");e&&(this.spectrogramResizeRenderer=new Go({layer:e,config:{borderColor:A?"#444":"#ddd",borderWidth:5,borderStyle:"solid",opacity:.3,hoverOpacity:.6,handleColor:"#ffffff",handleOpacity:.8,handleHoverOpacity:1,shadowColor:"rgba(0, 0, 0, 0.3)",shadowBlur:8,shadowOffsetX:0,shadowOffsetY:4},componentName:"spectrogram",onNeedsTransfer:this.transferImage.bind(this),onHeightChange:this.handleHeightChange}),this.interactionManager.register(this.spectrogramResizeRenderer))}this.rateLimitedTransfer=new Oo}init(e){this.init=()=>Ki("Visualizer is already initialized"),this.audio=e,this.setLoading(!1),this.setContainerHeight();const t=this.getLayer("regions");t&&(t.height=this.height);"none"!==this.wf.params.decoderType?(this.renderers=[this.waveformRenderer],this.waveformResizeRenderer&&this.renderers.push(this.waveformResizeRenderer),(0,Ne.VS)(Ne.ji)&&this.spectrogramRenderer&&(this.renderers.push(this.spectrogramRenderer),this.spectrogramResizeRenderer&&this.renderers.push(this.spectrogramResizeRenderer)),this.audio&&this.width>0&&(this.maxZoom=Math.max(1,Math.ceil(this.audio.dataLength/this.width)))):this.renderers=[],this.createComposer();const n=this.getLayer("timeline");n&&n.on("layerUpdated",this.playhead.onInit.bind(this.playhead)),this.playhead.onInit();for(const e of this.renderers)e.init({scrollLeftPx:this.getScrollLeftPx(),width:this.width,zoom:this.zoom,samplesPerPx:this.samplesPerPx,dataLength:this.dataLength},this.audio);this.invoke("initialized",[this]),setTimeout(()=>this.draw(),10)}createComposer(){const e=Yo.lift(this.layers.get("regions")),t=Yo.lift(this.layers.get("timeline")),n=Yo.overlay([Yo.lift(this.layers.get("background")),Yo.lift(this.layers.get("waveform")),Yo.lift(this.layers.get("waveform-resize"))]);let i=n;if((0,Ne.VS)(Ne.ji)){const e=Yo.overlay([Yo.lift(this.layers.get("spectrogram")),Yo.lift(this.layers.get("spectrogram-grid")),Yo.lift(this.layers.get("spectrogram-resize")),Yo.lift(this.layers.get("progress"))]);i=n.above(e)}const o=Yo.ifM(t.props.isVisible,i.shift(0,this.timelineHeight),i);this.composer=Yo.overlay([t,o,e])}setLoading(e){e?(this._loader=document.createElement("loading-progress-bar"),this._container.appendChild(this._loader)):this._container.removeChild(this._loader)}setLoadingProgress(e,t,n){this._loader&&(n?this._loader.total=this._loader.loaded:(void 0!==e&&(this._loader.loaded=e),void 0!==t&&(this._loader.total=t)),this._loader.update())}setDecodingProgress(e,t){this._loader&&(void 0!==e&&(this._loader.loaded=e),void 0!==t&&(this._loader.total=t),this._loader.update())}setError(e){this._loader&&(this._loader.error=e,this._loader.update())}setZoom(e){this.zoom=Oi(e,1,this.maxZoom),this.zoomToCursor?this.centerToCurrentTime():this.updatePosition(),this.getSamplesPerPx(),this.updateScrollFiller(),this.wf.invoke("zoom",[this.zoom]),this.draw()}getZoom(){return this.zoom}setScrollLeft(e){const t=this.scrollWidth/this.fullWidth,n=Oi(e,0,t);this.wrapper.scrollLeft=n*this.fullWidth}_setScrollLeft(e,t=!0){const n=this.scrollWidth/this.fullWidth;this.scrollLeft=Oi(e,0,n),this.draw()}getScrollLeft(){return this.scrollLeft}getScrollLeftPx(){return this.scrollLeft*this.fullWidth}lockSeek(){this.seekLocked=!0}unlockSeek(){this.seekLocked=!1}draw(e=!1){qo?this.drawRequestId?this.drawRequestDry=this.drawRequestDry&&e:(this.drawRequestDry=e,this.drawRequestId=requestAnimationFrame(()=>{this.drawRequestId=null,this.isDestroyed||this._draw(this.drawRequestDry)})):this._draw(e)}_draw(e=!1){this.isDestroyed||(e||(this.wf.playing&&this.autoCenter&&this.centerToCurrentTime(),this.renderAvailableChannels()),this.invoke("draw",[this]),this.transferImage())}destroy(){if(!this.isDestroyed){this.invoke("destroy",[this]),this.clear(),this.playhead.destroy(),this.audio=null;for(const e of this.renderers)e.destroy();this.waveformResizeRenderer&&this.waveformResizeRenderer.destroy(),this.spectrogramResizeRenderer&&this.spectrogramResizeRenderer.destroy(),this.removeEvents(),this.layers.forEach(e=>e.remove()),this.wrapper.remove(),this.interactionManager&&this.interactionManager.destroy(),super.destroy()}}clear(){var e;null==(e=this.layers.get("main"))||e.clear(),this.transferImage()}centerToCurrentTime(){if(1===this.zoom)return void this.setScrollLeft(0);const e=this.width/2/this.zoomedWidth;this.setScrollLeft(Oi(this.currentTime-e,0,1))}updateCursorToTime(e){this.playhead.updatePositionFromTime(e)}renderAvailableChannels(){if(!this.audio)return;const e={scrollLeftPx:this.getScrollLeftPx(),width:this.width,zoom:this.zoom,samplesPerPx:this.samplesPerPx,dataLength:this.dataLength};for(const t of this.renderers)t.draw(e)}get pixelRatio(){return window.devicePixelRatio}get width(){return this.container.clientWidth}get waveformLayerHeight(){var e;return this.splitChannels&&null!=(e=this.audio)&&e.channelCount?this.waveformHeight*this.audio.channelCount:this.waveformHeight}get spectrogramLayerHeight(){var e;return this.splitChannels&&null!=(e=this.audio)&&e.channelCount?this.spectrogramHeight*this.audio.channelCount:this.spectrogramHeight}get timelineComponentHeight(){return this.timelineHeight}get height(){let e=0;const t=this.getLayer("timeline"),n=this.getLayer("waveform"),i=this.getLayer("spectrogram");return e+=void 0===t||t.isVisible?this.timelineHeight:0,e+=null!=n&&n.isVisible?this.waveformLayerHeight:0,e+=null!=i&&i.isVisible?this.spectrogramLayerHeight:0,e}get scrollWidth(){return this.zoomedWidth-this.width}get fullWidth(){return this.zoomedWidth}get zoomedWidth(){return this.width*this.zoom}get container(){if(this._container)return this._container;let e=null;if(this.waveContainer instanceof HTMLElement?e=this.waveContainer:"string"==typeof this.waveContainer&&(e=document.querySelector(this.waveContainer)),!e)throw new Error("Container element does not exist.");return e.style.position="relative",this._container=e,e}createLayers(){const{container:e}=this;this.wrapper=document.createElement("div"),this.wrapper.style.height="100%";const t=this.createLayer({name:"main"});this.createLayer({name:"background",offscreen:!0,zIndex:0,isVisible:!1,height:this.waveformLayerHeight}),this.createLayer({name:"waveform",offscreen:!0,zIndex:100,height:this.waveformLayerHeight}),this.createLayer({name:"waveform-resize",offscreen:!0,zIndex:200,height:this.waveformLayerHeight,compositeOperation:"difference"}),(0,Ne.VS)(Ne.ji)&&(this.createLayer({name:"spectrogram",offscreen:!0,zIndex:100,isVisible:!0,height:this.spectrogramLayerHeight}),this.createLayer({name:"spectrogram-resize",offscreen:!0,zIndex:200,isVisible:!0,height:this.spectrogramLayerHeight,compositeOperation:"difference"}),this.createLayer({name:"progress",offscreen:!0,zIndex:1020,isVisible:!0,height:0}),this.createLayer({name:"spectrogram-grid",offscreen:!0,zIndex:1100,isVisible:!0,height:this.spectrogramLayerHeight})),this.createLayerGroup({name:"regions",offscreen:!0,zIndex:101,compositeOperation:"source-over",height:this.height}),this.initScrollBar(),t.appendTo(this.wrapper),e.appendChild(this.wrapper)}initScrollBar(){this.wrapper.style.position="relative",this.wrapper.style.overflowX="scroll",this.wrapper.style.overflowY="hidden";const e=this.getLayer("main");e.canvas instanceof HTMLCanvasElement&&(e.canvas.style.position="sticky",e.canvas.style.top="0",e.canvas.style.left="0",e.canvas.style.zIndex="2"),this.scrollFiller=document.createElement("div"),this.scrollFiller.style.position="absolute",this.scrollFiller.style.width="100%",this.scrollFiller.style.height=`${Xi}px`,this.scrollFiller.style.top="100%",this.scrollFiller.style.minHeight="1px",e.canvas instanceof HTMLCanvasElement&&(e.canvas.style.zIndex="1"),this.wrapper.appendChild(this.scrollFiller)}updateScrollFiller(){const{fullWidth:e}=this;this.scrollFiller.style.width=`${e+1}px`}reserveSpace({height:e}){this.reservedSpace=e}createLayer(e){const{name:t,offscreen:n=!1,zIndex:i=1,opacity:o=1,compositeOperation:s="source-over",isVisible:a,height:r}=e;if(!e.groupName&&this.layers.has(t))throw new Error(`Layer ${t} already exists.`);const l={groupName:e.groupName,name:t,container:this.container,height:null!=r?r:this.waveformHeight,pixelRatio:this.pixelRatio,index:i,offscreen:n,compositeOperation:s,opacity:o,isVisible:a};let c;if(e.groupName){const n=this.layers.get(e.groupName);if(!n||!n.isGroup)throw new Error(`LayerGroup ${e.groupName} does not exist.`);c=n.addLayer(l),this.layers.set(t,c)}else c=new _o(l),this.layers.set(t,c);return this.invoke("layerAdded",[c]),c.on("layerUpdated",e=>{const t=this.getLayer("main");this.setContainerHeight(),t&&(t.height=this.height),setTimeout(()=>this.transferImage(),100),this.invokeLayersUpdated()}),c}createLayerGroup(e){const{name:t,offscreen:n=!1,zIndex:i=1,opacity:o=1,compositeOperation:s="source-over",compositeAsGroup:a=!0,height:r}=e;if(this.layers.has(t))throw new Error(`LayerGroup ${t} already exists.`);const l=new Ao({name:t,container:this.container,height:null!=r?r:this.waveformHeight,pixelRatio:this.pixelRatio,index:i,offscreen:n,compositeOperation:s,compositeAsGroup:a,opacity:o});return this.invoke("layerAdded",[l]),l.on("layerUpdated",()=>{this.invokeLayersUpdated()}),this.layers.set(t,l),l}removeLayer(e){if(!this.layers.has(e))throw new Error(`Layer ${e} does not exist.`);const t=this.layers.get(e);t&&(this.invoke("layerRemoved",[t]),t.off("layerUpdated",this.invokeLayersUpdated),t.remove()),this.layers.delete(e)}getLayer(e){return this.layers.get(e)}getLayers(){return this.layers}useLayer(e,t){const n=this.layers.get(e);n&&t(n,n.context)}attachEvents(){this.observer=new ResizeObserver(this.handleResize),this.observer.observe(this.wrapper),this.wrapper.addEventListener("wheel",this.preventScrollX),this.wrapper.addEventListener("wheel",this.handleScroll,{passive:!0}),this.wrapper.addEventListener("click",this.handleSeek),this.wrapper.addEventListener("mousedown",this.handleMouseDown),this.wrapper.addEventListener("scroll",e=>{const t=this.wrapper.scrollLeft/this.fullWidth;this.wf.invoke("scroll",[t]),this._setScrollLeft(t)}),this.on("mouseMove",this.playHeadMove),this.on("layerAdded",this.invokeLayersUpdated),this.on("layerRemoved",this.invokeLayersUpdated),this.wf.on("playing",this.handlePlaying),this.wf.on("seek",this.handlePlaying),this.wf.on("pause",this.draw.bind(this))}removeEvents(){this.observer.unobserve(this.wrapper),this.observer.disconnect(),this.wrapper.removeEventListener("wheel",this.preventScrollX),this.wrapper.removeEventListener("wheel",this.handleScroll),this.wrapper.removeEventListener("click",this.handleSeek),this.wrapper.removeEventListener("mousedown",this.handleMouseDown),this.off("mouseMove",this.playHeadMove),this.off("layerAdded",this.invokeLayersUpdated),this.off("layerRemoved",this.invokeLayersUpdated),this.wf.off("playing",this.handlePlaying),this.wf.off("seek",this.handlePlaying),this.wf.off("pause",this.draw.bind(this))}updatePosition(){if(!this.wf.loaded)return;const e=this.scrollWidth/this.fullWidth*this.zoom;this.setScrollLeft(Oi(this.scrollLeft,0,e))}get dataLength(){var e,t;return null!=(e=null==(t=this.audio)?void 0:t.dataLength)?e:0}getSamplesPerPx(){const e=this.dataLength/this.fullWidth;return e!==this.samplesPerPx&&(this.samplesPerPx=e),this.samplesPerPx}isZooming(e){return e.ctrlKey||e.metaKey}setContainerHeight(){this.container.style.height=`${this.height+Xi}px`}updateSize(){this.getSamplesPerPx()}transferImage(){this.rateLimitedTransfer.scheduleDraw({visualizer:this},({visualizer:e})=>{const t=e.layers.get("main");if(e.composer){t.clear(),e.composer.renderTo(t);const n=e.playhead.x,i=t.context;i&&i instanceof CanvasRenderingContext2D&&e.playhead.renderTo(i,n)}},!1)}updateSpectrogramConfig(e){var t;if(!(0,Ne.VS)(Ne.ji)||!this.spectrogramRenderer)return;let n=!1;const i={},o=this.spectrogramRenderer.config,s=Object.assign({},o);void 0!==e.fftSamples&&o.fftSamples!==e.fftSamples&&(s.fftSamples=e.fftSamples,i.fftSamples=e.fftSamples,n=!0),void 0!==e.melBands&&o.numberOfMelBands!==e.melBands&&(s.numberOfMelBands=e.melBands),void 0!==e.windowingFunction&&o.windowFunction!==e.windowingFunction&&(s.windowFunction=e.windowingFunction,i.windowingFunction=s.windowFunction,n=!0),void 0!==e.hopFactor&&o.spectrogramHopFactor!==e.hopFactor&&(s.spectrogramHopFactor=e.hopFactor>0?e.hopFactor:2),void 0!==e.colorScheme&&o.spectrogramColorScheme!==e.colorScheme&&(s.spectrogramColorScheme=e.colorScheme),void 0!==e.minDb&&o.spectrogramMinDb!==e.minDb&&(s.spectrogramMinDb=e.minDb),void 0!==e.maxDb&&o.spectrogramMaxDb!==e.maxDb&&(s.spectrogramMaxDb=e.maxDb),void 0!==e.scale&&o.spectrogramScale!==e.scale&&(s.spectrogramScale=e.scale),n&&this.spectrogramRenderer.fftProcessor&&null!=(t=this.audio)&&t.sampleRate&&(i.sampleRate=this.audio.sampleRate,this.spectrogramRenderer.fftProcessor.updateParameters(i)),void 0!==e.colorScheme&&this.spectrogramRenderer.colorMapper&&this.spectrogramRenderer.colorMapper.setColorScheme(e.colorScheme),this.spectrogramRenderer.updateConfig(s),setTimeout(()=>this.draw())}syncCursor(){this.updateCursorToTime(this.currentTime)}get channelHeight(){const e=this.getLayer("spectrogram");return null!=e&&e.isVisible?this.spectrogramHeight:0}setAmp(e){this.waveformRenderer.updateConfig({amp:Math.max(1,e)}),this.draw()}getLayerInfo(e){let t=null;if(e===this.waveformResizeRenderer?t="waveform":e===this.spectrogramResizeRenderer&&(t="spectrogram"),!t)return null;const n=this.getLayer("timeline"),i=this.getLayer("waveform");this.getLayer("spectrogram");let o=0;null!=n&&n.isVisible&&("waveform"!==t&&"spectrogram"!==t||(o+=this.timelineHeight)),"spectrogram"===t&&null!=i&&i.isVisible&&(o+=this.waveformLayerHeight);const s=this.width;let a=0;return"waveform"===t?a=this.waveformLayerHeight:"spectrogram"===t&&(a=this.spectrogramLayerHeight),{offsetX:0,offsetY:o,width:s,height:a}}}class Jo extends Zi{constructor(e,t,n,i){var o,s,a,r,l,c;if(super(),this.id=void 0,this.start=0,this.end=0,this.color=Po("#afafaf"),this.selected=!1,this.highlighted=!1,this.active=!1,this.updateable=!0,this.locked=!1,this.deleteable=!0,this.visible=!0,this.showInTimeline=!1,this.external=!1,this.waveform=void 0,this.visualizer=void 0,this.controller=void 0,this.layer=void 0,this.handleWidth=void 0,this.isDragging=void 0,this.draggingStartPosition=void 0,this.isGrabbingEdge=void 0,this.switchCursor=(e,t=!0)=>{this.waveform.cursor.set(e,t&&this.requiresCursorFocus(e)?this.layerName:"")},this.edgeGrabCheck=e=>{const{handleWidth:t,end:n,start:i,visualizer:o}=this,{zoomedWidth:s}=this.visualizer,{duration:a}=this.waveform,r=Gi(e,o,a),l=Ui(t,s,a);return{isRightEdge:r>n-l,isLeftEdge:r<i+l}},this.mouseOver=(e,t)=>{if(!this.controller.layerGroup.isVisible)return;const n=this.edgeGrabCheck(t);this.isDragging||(this.updateable&&(n.isRightEdge||n.isLeftEdge)?this.switchCursor(jo.colResize):this.switchCursor(jo.grab))},this.handleMouseUp=e=>{this.isDragging&&(this.switchCursor(jo.grab),this.handleUpdateEnd()),this.handleSelected(),this.waveform.invoke("regionSelected",[this,e]),this.isDragging=!1,this.draggingStartPosition=null,this.updateable&&(this.isGrabbingEdge={isRightEdge:!1,isLeftEdge:!1}),document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.handleMouseUp)},this.handleDrag=e=>{if(this.updateable&&!this.locked&&this.draggingStartPosition){e.preventDefault(),e.stopPropagation(),this.isDragging=!0;const{isRightEdge:t,isLeftEdge:n}=this.isGrabbingEdge,{grabPosition:i,start:o,end:s}=this.draggingStartPosition,a=t||n,{container:r,zoomedWidth:l}=this.visualizer,{duration:c}=this.waveform,d=this.visualizer.getScrollLeft();let u=$i(e,r)+d;u<0&&(u=0);const h=Ui(u-i,l,c),g=s-o,m=n?o+h:Oi(o+h,0,this.duration-g),p=t?o:m,f=n?s:Oi(s+h,m+(a?0:g),this.duration);t||n?this.switchCursor(jo.colResize):this.switchCursor(jo.grabbing),this.updatePosition(Oi(p,0,c),Oi(f,0,c))}},this.mouseDown=(e,t)=>{if(!this.controller.layerGroup.isVisible)return;if(this.controller.isOverrideKeyPressed(t)||this.controller.isLocked)return;const{container:n}=this.visualizer,i=this.visualizer.getScrollLeft(),o=$i(t,n)+i,{start:s,end:a}=this;this.bringToFront(),this.draggingStartPosition={grabPosition:o,start:s,end:a},document.addEventListener("mouseup",this.handleMouseUp),this.updateable&&(this.isGrabbingEdge=this.edgeGrabCheck(t),document.addEventListener("mousemove",this.handleDrag))},this.handleSelected=e=>{this.isDragging&&this.selected||(this.waveform.playing&&this.waveform.player.pause(),this.selected=null!=e?e:!this.selected,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))},this.handleHighlighted=e=>{!this.updateable||this.isDragging&&this.selected||(this.highlighted=null!=e?e:!this.highlighted,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))},e.start<0)throw new Error("Segment start must be greater than 0");if(e.end<0)throw new Error("Segment end must be greater than 0");this.id=null!=(o=e.id)?o:(0,A.Ak)(5),this.start=e.start,this.end=e.end,this.selected=!!e.selected,this.updateable=null!=(s=e.updateable)?s:this.updateable,this.locked=null!=(a=e.locked)?a:this.locked,this.visible=null!=(r=e.visible)?r:this.visible,this.waveform=t,this.visualizer=n,this.controller=i,this.handleWidth=2,this.isDragging=!1,this.draggingStartPosition=null,this.isGrabbingEdge={isRightEdge:!1,isLeftEdge:!1},this.showInTimeline=null!=(l=e.showInTimeline)?l:this.showInTimeline,this.external=null!=(c=e.external)?c:this.external,this.initialize()}get isRegion(){return!1}update(e){(this.updateable||void 0===e.updateable||e.updateable)&&(void 0!==e.updateable&&(this.updateable=e.updateable),void 0!==e.deleteable&&(this.deleteable=e.deleteable),void 0!==e.locked&&(this.locked=e.locked),void 0!==e.start&&(this.start=e.start),void 0!==e.end&&(this.end=e.end),void 0!==e.selected&&(this.selected=e.selected),void 0!==e.visible&&(this.visible=e.visible),void 0!==e.color&&(this.color=Po(e.color)),void 0!==e.showInTimeline&&(this.showInTimeline=e.showInTimeline),void 0!==e.external&&(this.external=e.external))}setVisibility(e){e!==this.visible&&(this.visible=e,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))}bringToFront(){this.controller.bringRegionToFront(this.id)}get layerName(){return`region-${this.id}`}get duration(){return this.waveform.duration}get zoom(){return this.waveform.zoom}get xStart(){const{width:e}=this.visualizer,t=this.visualizer.getScrollLeft();return(this.start/this.duration*e-e*t)*this.zoom}get xEnd(){return this.xStart+this.width}get yStart(){const{timelinePlacement:e,timelineHeight:t}=this,n=this.visualizer.getLayer("timeline"),i=e===Mi.timelinePlacement;return null!=n&&n.isVisible&&i?t:0}get yEnd(){const{height:e}=this.visualizer,{timelineHeight:t}=this;return this.yStart+(e-t)}get width(){const{start:e,end:t}=this,{width:n}=this.visualizer;return(t-e)/this.waveform.duration*n*this.zoom}get hovered(){return this.controller.isHovered(this)}get timelineHeight(){return this.visualizer.timelineHeight||Mi.timelineHeight}get timelinePlacement(){return this.visualizer.timelinePlacement||Mi.timelinePlacement}get options(){return{start:this.start,end:this.end,id:this.id,selected:this.selected,updateable:this.updateable,locked:this.locked,deleteable:this.deleteable,visible:this.visible}}get inViewport(){const{xStart:e,xEnd:t}=this,n=this.visualizer.width;return!(e<=0&&t<=0)&&!(e>=n&&t>=n)}requiresCursorFocus(e){return![jo.crosshair].includes(e)}initialize(){this.layer=this.visualizer.createLayer({groupName:"regions",name:this.layerName}),this.on("mouseOver",this.mouseOver),this.on("mouseDown",this.mouseDown)}render(){if(!this.visible||!this.inViewport)return;const{color:e,selected:t,highlighted:n,active:i}=this,{height:o}=this.visualizer,s=e.clone(),a=this.yStart,r=this.controller.layerGroup;(t||n||i)&&s.darken(.4),r.fillStyle=s.clone().translucent(.77).toString(),r.fillRect(this.xStart,a,this.width,o),r.fillStyle=t?s.toString():s.clone().translucent(.6).toString(),r.fillRect(this.xStart,a,this.handleWidth,o),r.fillRect(this.xEnd-this.handleWidth,a,this.handleWidth,o)}handleUpdateEnd(){this.invoke("updateEnd",[this]),this.waveform.invoke("regionUpdatedEnd",[this])}setColor(e){this.color.update(e)}setLocked(e){this.locked=e,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this])}updateColor(e){this.updateable&&(this.setColor(e),this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))}updatePosition(e,t){if(!this.updateable)return;let n=null!=e?e:this.start,i=null!=t?t:this.end;n>i&&([n,i]=[i,n]),this.start=n,this.end=i,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this])}scrollToRegion(){this.waveform.scrollToRegion(this.start)}convertToRegion(e,t=!1){if(this.updateable)return this.controller.convertToRegion(this.id,e,t)}convertToSegment(e=!1){if(this.updateable)return this.controller.convertToSegment(this.id,e)}remove(){this.deleteable&&this.waveform.invoke("regionRemoved",[this])}destroy(e=!0){this.deleteable&&!this.isDestroyed&&(e&&this.remove(),super.destroy())}toJSON(){return{start:this.start,end:this.end}}}class Qo extends Jo{constructor(e,t,n,i){var o;super(e,t,n,i),this.labels=void 0,this.labels=null!=(o=e.labels)?o:this.labels,this.color=e.color?Po(e.color):this.color}get isRegion(){return!0}get options(){return Object.assign({},super.options,{labels:this.labels,color:this.color.toString()})}renderLabels(){var e;if(null!=(e=this.labels)&&e.length&&this.controller.showLabels&&this.visible){const e=this.controller.layerGroup,t=this.color,n=this.timelinePlacement,i=this.visualizer.getLayer("timeline"),o=this.timelineHeight,s=(null!=i&&i.isVisible&&n?o:0)+4,a=this.labels.map(t=>e.context.measureText(t)),r=a.reduce((e,t)=>e+t.fontBoundingBoxAscent+t.fontBoundingBoxDescent+2,0),l=this.xStart+this.handleWidth+2,c=a[0].width+10,d=this.xEnd-this.xStart-2*this.handleWidth,u=d<c?d:c,h=this.selected?c:u;e.fillStyle=`rgba(${t.r+t.r}, ${t.g+t.g}, ${t.b+t.b})`,this.selected&&e.roundRect(l,s,h,r+5,4),e.fillStyle=this.selected?"white":"black",e.font="12px Arial",this.labels.forEach((t,n)=>{const i=r/a.length*(n+1)-1;e.fitText(t,l+6,s+i,h-this.handleWidth-6)})}}render(){super.render(),this.renderLabels()}update(e){var t;super.update(e),this.labels=null!=(t=e.labels)?t:this.labels,this.color=e.color?Po(e.color):this.color}toJSON(){return{start:this.start,end:this.end,color:this.color.toString(),labels:this.labels,layerName:this.layerName,id:this.id}}}class es{constructor(e,t,n){var i,o,s,a,r;this.regions=[],this.waveform=void 0,this.visualizer=void 0,this.initialRegions=void 0,this.locked=!1,this.hoveredRegions=new Set,this.defaultColor=Po("#787878"),this.drawingColor=Po("#787878"),this.labels=void 0,this.createable=!0,this.updateable=!0,this.deleteable=!0,this.drawableTarget=Jo,this.showLabels=!1,this.layerGroup=void 0,this.handleDraw=()=>{this.waveform.loaded&&this.renderAll()},this.handleInit=()=>{this.initialRegions.length&&(this.regions=this.initialRegions.map(e=>new Qo(e,this.waveform,this.visualizer,this)),this.initialRegions=[]),this.visualizer.on("draw",this.handleDraw)},this.handleRegionUpdated=()=>{this.visualizer.draw(!0)},this.handleRegionRemoved=e=>{this.removeRegion(e.id)},this.handleDrawRegion=e=>{if(this.locked||!this.createable)return;if(this.hoveredRegions.size>0&&!this.isOverrideKeyPressed(e))return;if(!this.layerGroup.isVisible)return;let t,n;this.lock(),this.waveform.invoke("beforeRegionsDraw",[this]);const i=()=>{const{container:i,zoomedWidth:o,fullWidth:s}=this.visualizer,{settings:{autoPlayNewSegments:a},duration:r}=this.waveform,l=this.visualizer.getScrollLeftPx();n=Oi($i(e,i)+l,0,s);const c=Ui(n,o,r),d=Ui(n,o,r);t=this.addRegion({start:c,end:d,color:this.drawingColor.toString(),selected:!1,labels:this.labels}),a&&!t.isRegion&&this.regions.forEach(e=>e.handleSelected(e.id===t.id))},o=e=>{const{container:o,fullWidth:s}=this.visualizer,a=this.visualizer.getScrollLeftPx(),r=Oi($i(e,o)+a,0,s);if(t||i(),Math.abs(r-n)>5){let e=this.pixelsToTime(n),i=this.pixelsToTime(r);i<e&&([e,i]=[i,e]),t.updatePosition(e,i),t.render()}},s=()=>{const{player:e,settings:{autoPlayNewSegments:n}}=this.waveform;document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s),t&&t.start===t.end?(t.remove(),this.unlock()):t?(this.waveform.invoke("regionCreated",[t]),n&&!t.isRegion?(e.playing&&e.pause(),setTimeout(()=>{this.unlock(),e.seek(t.start),e.play()})):setTimeout(()=>this.unlock(),0)):this.unlock(),this.waveform.invoke("afterRegionsDraw",[this])};document.addEventListener("mousemove",o),document.addEventListener("mouseup",s)},this.handleMouseMove=e=>{const t=this.findRegionUnderCursor(e);t?(t.invoke("mouseOver",[t,e]),t.hovered||(this.hoveredRegions.clear(),this.hover(t,e))):this.hoveredRegions.size&&(this.hoveredRegions.forEach(t=>{t.invoke("mouseLeave",[t,e])}),this.hoveredRegions.clear(),this.cursorLockedByPlayhead||this.waveform.cursor.set(jo.crosshair))},this.handleMouseLeave=e=>{this.hoveredRegions.size&&(this.hoveredRegions.forEach(t=>{t.invoke("mouseLeave",[t,e])}),this.hoveredRegions.clear())},this.handleMouseDown=e=>{if(!this.updateable)return;const t=this.findRegionUnderCursor(e);this.layerGroup.isVisible&&t&&(e.preventDefault(),e.stopPropagation(),t.invoke("mouseDown",[t,e]))},this.handleMouseUp=e=>{if(!this.updateable)return;const t=this.findRegionUnderCursor(e);this.layerGroup.isVisible&&t&&t.invoke("mouseUp",[t,e])},this.handleClick=e=>{var t;const n=this.visualizer.getLayer("main");if(e.target&&null!=n&&null!=(t=n.canvas)&&t.contains(e.target)){const t=this.findRegionUnderCursor(e);this.layerGroup.isVisible&&t&&t.invoke("click",[t,e])}},this.waveform=t,this.visualizer=n,this.initialRegions=null!=(i=null==e?void 0:e.regions)?i:[],this.defaultColor=null!=e&&e.defaultColor?Po(e.defaultColor):this.defaultColor,this.labels=void 0,this.createable=null!=(o=null==e?void 0:e.createable)?o:this.createable,this.updateable=null!=(s=null==e?void 0:e.updateable)?s:this.updateable,this.deleteable=null!=(a=null==e?void 0:e.deleteable)?a:this.deleteable,this.layerGroup=this.visualizer.getLayer("regions"),this.showLabels=null!=(r=this.waveform.params.showLabels)&&r,this.init()}init(){this.visualizer.on("initialized",this.handleInit),this.waveform.on("regionRemoved",this.handleRegionRemoved),this.waveform.on("regionUpdated",this.handleRegionUpdated),this.visualizer.container.addEventListener("mousedown",this.handleDrawRegion);const{container:e}=this.visualizer;e.addEventListener("mousemove",this.handleMouseMove),e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("click",this.handleClick),e.addEventListener("mouseleave",this.handleMouseLeave)}renderAll(){this.layerGroup.clear();const e=this.waveform.currentTime;this.regions.forEach(t=>{t.active=t.start<=e&&t.end>=e,t.render()})}regionDrawableTarget(){this.drawableTarget=Qo}segmentDrawableTarget(){this.drawableTarget=Jo}resetDrawableTarget(){this.segmentDrawableTarget()}clearSegments(e=!1){this.regions=this.regions.filter(t=>!!(t.isRegion||e&&!t.selected||t.external)||(t.destroy(),!1))}addRegions(e,t=!0){e.forEach(e=>this.addRegion(e,!1)),t&&this.redraw()}addRegion(e,t=!0){var n;let i;return i=null!=(n=e.labels)&&n.length||this.drawableTarget===Qo?new Qo(e,this.waveform,this.visualizer,this):new Jo(e,this.waveform,this.visualizer,this),this.regions.push(i),t&&this.redraw(),i}findRegion(e){return this.regions.find(t=>t.id===e)}convertToRegion(e,t,n=!0){let i=this.findRegion(e);const o=this.regions.findIndex(t=>t.id===e);return i=new Qo(Object.assign({},i.options,{labels:t}),this.waveform,this.visualizer,this),this.regions[o]=i,n&&this.redraw(),i}convertToSegment(e,t=!0){let n=this.findRegion(e);const i=this.regions.findIndex(t=>t.id===e);return n=new Jo(n.options,this.waveform,this.visualizer,this),this.regions[i]=n,t&&this.redraw(),n}updateRegion(e,t=!0){if(!this.updateable||!e.id)return;const n=this.findRegion(e.id);return n?(n.update(e),t&&this.redraw(),n):void 0}redraw(){this.visualizer.draw(!0)}removeRegion(e,t=!0){const n=this.findRegion(e);this.deleteable&&null!=n&&n.deleteable&&(n.destroy(!1),this.regions=this.regions.filter(e=>e!==n)),t&&this.redraw()}bringRegionToFront(e){const t=this.regions.findIndex(t=>t.id===e);this.regions.push(...this.regions.splice(t,1))}destroy(){const{container:e}=this.visualizer;this.visualizer.off("initialized",this.handleInit),this.visualizer.off("draw",this.handleDraw),this.waveform.off("regionRemoved",this.handleRegionRemoved),this.waveform.off("regionUpdated",this.handleRegionUpdated),e.removeEventListener("mousemove",this.handleMouseMove),e.removeEventListener("mousedown",this.handleMouseDown),e.removeEventListener("mouseup",this.handleMouseUp),e.removeEventListener("click",this.handleClick),e.removeEventListener("mouseleave",this.handleMouseLeave),this.regions.forEach(e=>e.destroy()),this.regions=[]}setDrawingColor(e){this.drawingColor=Po(e)}updateLabelVisibility(e){this.showLabels=e,this.redraw()}setLabels(e){e&&(this.labels=e)}resetDrawingColor(){this.drawingColor=this.defaultColor.clone()}resetLabels(){this.labels=void 0}get list(){return Array.from(this.regions)}get selected(){return this.regions.filter(e=>e.selected)}get timelineRegions(){return this.regions.filter(e=>e.showInTimeline)}get visible(){return this.regions.filter(e=>e.visible)}isOverrideKeyPressed(e){return e.shiftKey}get cursorLockedByPlayhead(){return this.waveform.cursor.hasFocus()&&this.waveform.cursor.isFocused("playhead")}findRegionUnderCursor(e){return((e,t)=>{for(let n=e.length-1;n>=0;n--)if(t(e[n]))return e[n]})(this.visible,t=>this.cursorInRegion(e,t))}cursorInRegion(e,t){const{xStart:n,width:i}=t,{container:o,timelinePlacement:s,timelineHeight:a=0,height:r}=this.visualizer,l=this.visualizer.getLayer("timeline"),c=s===Mi.timelinePlacement&&null!=l&&l.isVisible?a:0,d=$i(e,o),u=Wi(e,o);if(!zi(d,n,n+i))return!1;return zi(u,c,c+r-a)}lock(){this.locked=!0,this.visualizer.lockSeek()}unlock(){this.locked=!1,this.visualizer.unlockSeek()}get isLocked(){return this.locked}hover(e,t){t&&(this.visualizer.lockSeek(),e.invoke("mouseEnter",[e,t])),this.hoveredRegions.add(e)}unhover(e,t){t&&(this.visualizer.unlockSeek(),e.invoke("mouseLeave",[e,t])),this.hoveredRegions.delete(e)}pixelsToTime(e){const{zoomedWidth:t}=this.visualizer,{duration:n}=this.waveform;return e/t*n}toJSON(){return this.regions.map(e=>e.toJSON())}isHovered(e){return this.hoveredRegions.has(e)}}const ts="Dark"===(0,Pn.j17)();class ns{constructor(e,t,n){var i,o,s,a,r,l;this.waveform=void 0,this.visualizer=void 0,this.layer=void 0,this.placement=void 0,this.padding={left:0,right:0,top:0,bottom:0},this.height=Mi.timelineHeight,this.initHeight=Mi.timelineHeight,this.fontSize=12,this.gridWidth=1,this.fontFamily="Arial",this.fontColor=Po(ts?"rgba(200,200,200,0.8)":"#413C4A"),this.selectionColor=Po(ts?"rgba(200,200,200,0.08)":"rgba(65, 60, 74, 0.08)"),this.gridColor=Po(ts?"rgba(200,200,200,0.16)":"rgba(137,128,152,0.16)"),this.backgroundColor=Po("#fff"),this._labeMaxWidth={true:0,false:0},this.waveform=t,this.visualizer=n,this.placement=(null==e?void 0:e.placement)||Mi.timelinePlacement,this.padding=Object.assign({},this.padding,null==e?void 0:e.padding),this.fontSize=null!=(i=null==e?void 0:e.fontSize)?i:this.fontSize,this.fontFamily=null!=(o=null==e?void 0:e.fontFamily)?o:this.fontFamily,this.height=(null!=(s=null==e?void 0:e.height)?s:Mi.timelinePlacement)?null!=(a=null==e?void 0:e.height)?a:Mi.timelineHeight:this.height,this.initHeight=this.height,this.gridWidth=null!=(r=null==e?void 0:e.gridWidth)?r:this.gridWidth,this.fontColor=null!=e&&e.fontColor?Po(null==e?void 0:e.fontColor):this.fontColor,this.selectionColor=null!=(l=null==e?void 0:e.selectedColor)?l:this.selectionColor,this.gridColor=null!=e&&e.gridColor?Po(null==e?void 0:e.gridColor):this.gridColor,this.backgroundColor=null!=e&&e.backgroundColor?Po(null==e?void 0:e.backgroundColor):this.backgroundColor,this.visualizer.reserveSpace({height:this.height}),this.layer=this.visualizer.createLayer({name:"timeline",offscreen:!0,zIndex:103}),this.visualizer.on("initialized",()=>{this.visualizer.on("draw",()=>this.render())}),this.layer.on("layerUpdated",()=>{this.height=this.layer.isVisible?this.initHeight:0,this.visualizer.reserveSpace({height:this.height}),this.render()})}render(){var e;const{width:t}=this.visualizer,n=this.height,i=this.layer,o=this.visualizer.height-n,s=this.gridWidth,a=this.gridColor.toString(),r=this.backgroundColor.toString(),l=this.placement,c="top"===l?0:o,d="top"===l&&(null==(e=this.padding)?void 0:e.left)||0;i.clear(),this.layer.isVisible&&(i.lineWidth=s,i.strokeStyle=a,i.fillStyle=r,i.beginPath(),i.fillRect(0,c,t+d,n),this.renderTimelineRegions(),this.renderSelected(),this.renderIntervals(),i.fillStyle=a,i.fillRect(0,c+n,t+d,s),i.stroke())}renderTimelineRegions(){var e;const t=null==(e=this.waveform)?void 0:e.regions.timelineRegions;if(t.length){const{height:e}=this,{duration:n}=this.waveform,{zoomedWidth:i}=this.visualizer,o=this.visualizer.getScrollLeftPx(),s=this.waveform.currentTime;t.sort((e,t)=>e.start-t.start).forEach(t=>{const{end:a,start:r,selected:l,color:c}=t,d=r<=s&&a>=s,u=r*i/n-o,h=(a-r)*i/n,g=this.layer,m=c.clone();d&&m.darken(l?.3:.4),g.fillStyle=m.translucent(.8).toString(),g.fillRect(u,0,h,e)})}}renderSelected(){var e;const t=null==(e=this.waveform)?void 0:e.regions.selected;if(t.length){const{selectionColor:e,height:n}=this,{duration:i}=this.waveform,{zoomedWidth:o}=this.visualizer,s=this.visualizer.getScrollLeftPx(),a=t.sort((e,t)=>e.start-t.start)[0].start,r=a*o/i-s,l=(t.sort((e,t)=>t.end-e.end)[0].end-a)*o/i,c=0,d=this.layer;d.fillStyle=e.toString(),d.fillRect(r,c,l,n)}}renderInterval(e){var t;const{pixelRatio:n,height:i}=this.visualizer,o=this.fontSize,s=this.height,a=i-s,r=this.placement,l=this.layer,c="top"===r?0:a,d="top"===r&&(null==(t=this.padding)?void 0:t.left)||0,u="top"===r?"label"===e.type?.75*s:.875*s:c,h="top"===r?"label"===e.type?.25*s:.125*s:"label"===e.type?s/2:s/3;if(l.moveTo(e.x+d,u),l.lineTo(e.x+d,u+h),"label"===e.type){var g;const t=this.formatTime(1e3*e.time,e.includeMs),i="top"===r?e.x-this.getDownscaledTextWidth(l,t)/2:e.x+((null==(g=this.padding)?void 0:g.left)||6);l.fillStyle=this.fontColor.toString(),l.font=`${o*n}px ${this.fontFamily}`,l.fillText(t,i,"top"===r?c+.75*s/2+o/2-this.gridWidth:c+s-8)}}getDownscaledTextWidth(e,t){const{pixelRatio:n}=this.visualizer;return e.measureText(t).width/n}renderIntervals(){const{width:e}=this.visualizer,t=this.visualizer.getScrollLeftPx(),n=this.mapToTime(e),[i,o]=this.getIntervals(n),s=this.mapToTime(Math.abs(t)),a=Math.floor(s/i)*i,r=a+n,l=n<60,c=10**10;let d=Number.NEGATIVE_INFINITY;for(let e=a;e<r;e+=i){const t=Li(e,10),n=Math.round(t*c)%Math.round(o*c),i=this.mapToPx(e-s);let a="mark";0===n&&i-d>=40&&(a="label",d=i),this.renderInterval({x:i,time:t,type:a,includeMs:l})}}getLabelPadding(){return this.fontSize}mapToTime(e){const{duration:t}=this.waveform,{fullWidth:n}=this.visualizer;return e/n*t}mapToPx(e){const{duration:t}=this.waveform,{fullWidth:n}=this.visualizer;return e/t*n}getLabelMaxWidth(e=!1){const t=e.toString();if(this._labeMaxWidth[t])return this._labeMaxWidth[t];const n="MM:MM:MM:MM"+(e?"M":""),i=this.layer.measureText(n).width;return this._labeMaxWidth[t]=i,i}getIntervals(e){const t=this.gridWidth,n=this.mapToTime(10+t),i=Math.floor(Math.log10(n)),o=Li(n,Math.abs(i)),s=Math.ceil(o/10**i);let a=10**i;s>6?a=10**i*7.5:s>4?a=10**i*5:s>2?a=10**i*2.5:s>1&&(a=10**i*1.25);const r=e<60,l=Math.ceil((this.getLabelMaxWidth(r)+2*this.getLabelPadding())/this.mapToPx(a))*a,c=Math.floor(Math.log10(l)),d=Math.ceil(l/10**c);let u=Li(10,c);return d>5?u=10**c*7.5:d>3?u=10**c*5:d>2?u=10**c*2.5:d>1&&(u=10**c*1.25),[a,u]}formatTime(e,t=!1){const n=e>3600?11:14,i=t?23:19;return new Date(e).toISOString().substring(n,i)}}class is extends Zi{constructor(e){var t,n;super(),this.src=void 0,this.media=void 0,this.visualizer=void 0,this.timeline=void 0,this.focusTimeout=null,this.tooltip=void 0,this.cursor=void 0,this.player=void 0,this.params=void 0,this.regions=void 0,this.loaded=!1,this.renderedChannels=!1,this.settings={},this.handleDrawn=()=>{const e={width:this.visualizer.width,height:this.visualizer.height,zoom:this.zoom,scroll:this.visualizer.getScrollLeftPx()};this.invoke("frameDrawn",[e])},this.handleCursorMove=e=>{if(e.target&&this.visualizer.container.contains(e.target)){if(this.loaded&&this.cursor.inView){var t;this.focusTimeout&&clearTimeout(this.focusTimeout),this.focusTimeout=setTimeout(()=>{this.cursor.hasFocus()||this.cursor.set(jo.crosshair)},1);const n=Gi(e,this.visualizer,this.duration),i=null==(t=new Date(1e3*n).toISOString().match(/T(.*?)Z/))?void 0:t[1];this.tooltip.show(e.pageX,e.pageY+16,i)}else this.cursor.set(jo.default);this.cursor.show()}else this.cursor.hide(),this.tooltip.hide()},null!=e&&e.timeline||(e.timeline={placement:"top"}),e.decoderType=null!=(t=e.decoderType)?t:"webaudio",e.playerType="ffmpeg"===e.decoderType?"html5":null!=(n=e.playerType)?n:"html5",this.src=e.src,this.params=e,this.init()}init(){var e,t,n,i,o,s;this.media=new ho(this,{src:this.src}),this.tooltip=new Ro(null==(e=this.params)?void 0:e.tooltip),this.visualizer=new Zo(this.params,this),this.cursor=new No(Object.assign({x:0,y:0,width:null!=(t=null==(n=this.params)?void 0:n.cursorWidth)?t:1},null==(i=this.params)?void 0:i.cursor),this.visualizer),this.timeline=new ns(Object.assign({gridColor:this.params.gridColor,gridWidth:this.params.gridWidth},null==(o=this.params)?void 0:o.timeline),this,this.visualizer),this.regions=new es(Object.assign({},null==(s=this.params)?void 0:s.regions),this,this.visualizer),this.player="html5"===this.params.playerType?new po(this):new fo(this),this.initEvents(),this.loadingState()}renderTimeline(){this.timeline.render()}loadingState(){this.visualizer.setLoading(!0),this.renderTimeline(),this.visualizer.draw(!0)}async load(){var e,t,n;if(this.isDestroyed)return;"none"===this.params.decoderType&&(this.params.splitChannels&&console.warn('splitChannels is not available when decoder="none" (requires decoded audio data)'),"webaudio"===this.params.playerType&&console.warn('playerType="webaudio" is not available when decoder="none", forcing HTML5 player'));const i=this.media.load({muted:null!=(e=this.params.muted)&&e,volume:null!=(t=this.params.volume)?t:1,rate:null!=(n=this.params.rate)?n:1});this.media.decoderPromise&&(await this.media.decoderPromise,this.renderTimeline(),this.visualizer.draw(!0));const o=await i;this.isDestroyed||o&&("webaudio"===this.params.playerType&&(this.media.duration=o.duration,this.renderTimeline(),this.visualizer.draw(!0)),this.player.init(o),this.visualizer.init(o),this.loaded=!0,this.invoke("load"))}syncCursor(){const e=this.currentTime;this.visualizer.updateCursorToTime(e),this.visualizer.transferImage()}seek(e){this.player.seek(e)}seekForward(e){var t;this.seek(this.currentTime+(null!=(t=null!=e?e:this.params.seekStep)?t:1))}seekBackward(e){var t;this.seek(this.currentTime-(null!=(t=null!=e?e:this.params.seekStep)?t:1))}scrollToRegion(e){if(1===this.zoom)return;const t=this.visualizer.width/2/this.visualizer.zoomedWidth,n=Oi(e/this.duration-t,0,1);this.visualizer.setScrollLeft(n),this.invoke("scroll",[n])}play(e,t){this.player.play(e,t)}pause(){this.player.pause()}togglePlay(){this.playing?this.pause():this.play()}setLoadingProgress(e,t,n){this.visualizer.setLoadingProgress(e,t,n)}setDecodingProgress(e,t){this.visualizer.setDecodingProgress(e,t)}setError(e,t){this.invoke("error",[t||new Error(e)]),this.visualizer.setError(e)}stop(){this.player.stop()}destroy(){this.isDestroyed||(this.regions.destroy(),this.media.destroy(),this.player.destroy(),this.visualizer.destroy(),this.cursor.destroy(),this.tooltip.destroy(),super.destroy())}addRegions(e,t=!0){this.regions.addRegions(e,t)}addRegion(e,t=!0){return this.regions.addRegion(e,t)}updateRegion(e,t=!0){return this.regions.updateRegion(e,t)}updateLabelVisibility(e){this.regions.updateLabelVisibility(e)}removeRegion(e,t=!0){this.regions.removeRegion(e,t)}getLayers(){return this.visualizer.getLayers()}getLayer(e){return this.visualizer.getLayer(e)}get playing(){return this.player.playing}get buffering(){return this.player.buffering}set buffering(e){this.player.buffering=e}get zoom(){return this.visualizer.getZoom()}set zoom(e){this.visualizer.setZoom(e)}get volume(){return this.player.volume}set volume(e){this.player.volume=e}get muted(){return this.player.muted}set muted(e){this.player.muted=e}get scroll(){return this.duration*this.visualizer.getScrollLeft()/this.zoom*1e3}set scroll(e){const t=e/this.duration*this.zoom;this.visualizer.setScrollLeft(t),this.invoke("scroll",[t])}get rate(){return this.player.rate}set rate(e){this.player.rate=e}get currentTime(){return this.player.currentTime}set currentTime(e){this.setCurrentTime(e,!0)}setCurrentTime(e,t=!1){t?this.player.seek(e):this.player.seekSilent(e)}updateSpectrogramConfig(e){this.visualizer.updateSpectrogramConfig(e)}set amp(e){this.visualizer.setAmp(e)}get duration(){return this.media.duration}get sampleRate(){return this.media.sampleRate}initEvents(){this.cursor.on("mouseMove",this.handleCursorMove),this.visualizer.on("layersUpdated",()=>this.invoke("layersUpdated",[this.getLayers()])),this.visualizer.on("draw",()=>this.handleDrawn())}}const os=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING);const ss=["waveform"],as=(0,Ne.VS)(Ne.ji),rs=as?function(e){const{settings:t,changeSetting:n}=(0,f.useContext)(Sn);return(0,f.useEffect)(()=>{if(!e.current||!t)return;const n=e.current,i={};void 0!==t.spectrogramFftSamples&&(i.fftSamples=t.spectrogramFftSamples),void 0!==t.numberOfMelBands&&(i.melBands=t.numberOfMelBands),t.spectrogramWindowingFunction&&(i.windowingFunction=t.spectrogramWindowingFunction),t.spectrogramColorScheme&&(i.colorScheme=t.spectrogramColorScheme),void 0!==t.spectrogramMinDb&&(i.minDb=t.spectrogramMinDb),void 0!==t.spectrogramMaxDb&&(i.maxDb=t.spectrogramMaxDb),t.spectrogramScale&&(i.scale=t.spectrogramScale),Object.keys(i).length>0&&n.updateSpectrogramConfig(i)},[null==t?void 0:t.spectrogramFftSamples,null==t?void 0:t.numberOfMelBands,null==t?void 0:t.spectrogramWindowingFunction,null==t?void 0:t.spectrogramColorScheme,null==t?void 0:t.spectrogramMinDb,null==t?void 0:t.spectrogramMaxDb,null==t?void 0:t.spectrogramScale,e]),{setFftSamples:(0,f.useCallback)(t=>{e.current&&(t<Do.BK.FFT_SAMPLES/8||t>4*Do.BK.FFT_SAMPLES?console.warn(`Invalid FFT samples value: ${t}`):(e.current.updateSpectrogramConfig({fftSamples:t}),null==n||n("spectrogramFftSamples",t)))},[e,n]),setMelBands:(0,f.useCallback)(t=>{e.current&&(t<1||t>512?console.warn(`Invalid mel bands value: ${t}`):(e.current.updateSpectrogramConfig({melBands:t}),null==n||n("numberOfMelBands",t)))},[e,n]),setWindowingFunction:(0,f.useCallback)(t=>{e.current&&(e.current.updateSpectrogramConfig({windowingFunction:t}),null==n||n("spectrogramWindowingFunction",t))},[e,n]),setColorScheme:(0,f.useCallback)(t=>{e.current&&(e.current.updateSpectrogramConfig({colorScheme:t}),null==n||n("spectrogramColorScheme",t))},[e,n]),setDbRange:(0,f.useCallback)((t,i)=>{e.current&&(t>=i?console.warn(`Invalid dB range: min (${t}) must be less than max (${i})`):(e.current.updateSpectrogramConfig({minDb:t,maxDb:i}),null==n||n("spectrogramMinDb",t),null==n||n("spectrogramMaxDb",i)))},[e,n]),setScale:(0,f.useCallback)(t=>{e.current&&(["linear","log","mel"].includes(t)?(e.current.updateSpectrogramConfig({scale:t}),null==n||n("spectrogramScale",t)):console.warn(`Invalid spectrogram scale: ${t}`))},[e,n])}}:()=>{},ls=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING),cs=(0,b.PA)(({item:e,children:t,settings:n={},changeSetting:i=()=>{}})=>{const o=(0,f.useRef)(),s="Dark"===(0,Pn.j17)(),a=((e,t)=>{var n,i,o,s,a;const r=(0,f.useRef)(),{showLabels:l=!0}=t,[c,d]=(0,f.useState)(1),[u,h]=(0,f.useState)(null!=(n=null==t?void 0:t.volume)?n:1),[g,m]=(0,f.useState)(!1),p=_i(null!=(i=null==t?void 0:t.onBuffering)?i:()=>{}),[v,y]=(0,f.useState)(0),[b,x]=(0,f.useState)(0),[w,S]=(0,f.useState)(null!=(o=null==t?void 0:t.amp)?o:1),[C,k]=(0,f.useState)(null!=(s=null==t?void 0:t.rate)?s:1),[P,R]=(0,f.useState)(null!=(a=null==t?void 0:t.muted)&&a),[j,N]=(0,f.useState)([]),[T,_]=(0,f.useState)(new Map),{settings:A}=(0,f.useContext)(Sn);(0,f.useEffect)(()=>{r.current&&A&&(r.current.settings=A)},[A,r.current]),os&&(0,f.useEffect)(()=>{r.current&&(r.current.buffering=(null==t?void 0:t.buffering)||!1)},[null==t?void 0:t.buffering]);const I=(0,f.useRef)(null==t?void 0:t.onFrameChanged);I.current=null==t?void 0:t.onFrameChanged;const M=(0,f.useMemo)(()=>{let e=null,t=-1;return n=>{cancelAnimationFrame(t),t=requestAnimationFrame(()=>{e&&n.width===e.width&&n.height===e.height&&n.zoom===e.zoom&&n.scroll===e.scroll||(null==I.current||I.current(n),e=n)})}},[]);return(0,f.useEffect)(()=>{const n=new is(Object.assign({},null!=t?t:{},{container:e.current}));return(void 0===(null==t?void 0:t.autoLoad)||null!=t&&t.autoLoad)&&n.load(),n.on("load",()=>{null==t||null==t.onLoad||t.onLoad(n)}),n.on("play",()=>{m(!0)}),n.on("pause",()=>{m(!1)}),n.on("error",e=>{null==t||null==t.onError||t.onError(e)}),n.on("playing",e=>{g&&!Yi(e,b,v)&&(null==t||null==t.onSeek||t.onSeek(e)),x(e)}),n.on("seek",e=>{Yi(e,b,v)||(null==t||null==t.onSeek||t.onSeek(e),x(e))}),n.on("zoom",d),n.on("frameDrawn",M),n.on("muted",R),n.on("durationChanged",y),n.on("volumeChanged",h),n.on("rateChanged",e=>{null==t||null==t.onRateChange||t.onRateChange(e),k(e)}),n.on("layersUpdated",e=>{const t=[],n=new Map;for(const i of e.values())t.push(i),n.set(i.name,i.isVisible);N(t),_(n)}),os&&n.on("buffering",p),r.current=n,()=>{var e;null==(e=r.current)||e.destroy()}},[]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{var e;if(!r.current)return;const t=null!=(e=r.current.playing)&&e;g!==t&&(g?r.current.play():r.current.pause())});return null==t||null==t.onPlaying||t.onPlaying(g),()=>cancelAnimationFrame(e)},[g]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{r.current&&r.current.zoom!==c&&(r.current.zoom=c)});return()=>cancelAnimationFrame(e)},[c]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{r.current&&r.current.volume!==u&&(r.current.volume=u)});return()=>cancelAnimationFrame(e)},[u]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{r.current&&r.current.rate!==C&&(r.current.rate=C)});return()=>cancelAnimationFrame(e)},[C]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{r.current&&r.current.amp!==w&&(r.current.amp=w)});return()=>cancelAnimationFrame(e)},[w]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{r.current&&r.current.muted!==P&&(r.current.muted=P)});return()=>cancelAnimationFrame(e)},[P]),(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>{var e;null==(e=r.current)||e.updateLabelVisibility(l)});return()=>cancelAnimationFrame(e)},[l]),{waveform:r,zoom:c,setZoom:d,volume:u,setVolume:h,playing:g,setPlaying:m,duration:v,currentTime:b,setCurrentTime:x,amp:w,setAmp:S,rate:C,setRate:k,muted:P,setMuted:R,layers:j,layerVisibility:T}})(o,{src:e._value,autoLoad:!1,waveColor:"rgba(150,150,150,0.8)",gridColor:s?"rgba(150,150,150,0.8)":"rgba(150,150,150,0.9)",gridWidth:1,backgroundColor:s?"rgba(150,150,150,0.8)":"rgba(255,255,255,0.8)",autoCenter:!0,zoomToCursor:!0,height:e.height&&!isNaN(Number(e.height))?Number(e.height):96,waveHeight:e.waveheight&&!isNaN(Number(e.waveheight))?Number(e.waveheight):32,splitChannels:e.splitchannels,decoderType:e.decoder,playerType:e.player,volume:e.defaultvolume?Number(e.defaultvolume):1,amp:e.defaultscale?Number(e.defaultscale):1,zoom:e.defaultzoom?Number(e.defaultzoom):1,showLabels:e.annotationStore.store.settings.showLabels,rate:e.defaultspeed?Number(e.defaultspeed):1,muted:"true"===e.muted,buffering:e.isBuffering,onBuffering:e.handleBuffering,onLoad:t=>{if(as){const n=t.getLayer("spectrogram");n&&n.setVisibility(e.spectrogram)}e.onLoad(t)},onPlaying:e.onPlaying,onSeek:e.onSeek,onRateChange:e.onRateChange,onError:e.onError,regions:{createable:!e.readonly},timeline:{backgroundColor:s?"rgb(38, 37, 34)":"rgba(255,255,255,0.8)"},experimental:{backgroundCompute:!0,denoize:!0},onFrameChanged:t=>{e.setWFFrame(t)}}),{waveform:r}=a,l=(0,Se.A)(a,ss);return rs(r),(0,f.useEffect)(()=>{var t,n,i,o,s,a;const l=Fn("Audio","Audio Segmentation");null==(t=r.current)||t.load();return null==(n=r.current)||n.on("beforeRegionsDraw",t=>{var n;const i=e.getRegionColor(),o=null==(n=e.activeState)?void 0:n.selectedValues();i&&o&&(t.regionDrawableTarget(),t.setDrawingColor(i),t.setLabels(o))}),null==(i=r.current)||i.on("afterRegionsDraw",e=>{e.resetDrawableTarget(),e.resetDrawingColor(),e.resetLabels()}),null==(o=r.current)||o.on("regionSelected",(t,n)=>{const i=e.annotation,o=n.metaKey||n.ctrlKey;o&&(t.selected||t.isRegion)||e.annotation.regionStore.unselectAll();const s=e.regs.find(e=>e.id===t.id),a=e._ws.regions.findRegion(t.id);if(i.isLinkingMode&&s)return i.addLinkedRegion(s),i.stopLinkingMode(),i.regionStore.unselectAll(),void t.handleSelected(!1);s&&e.annotation.regionStore.toggleSelection(s,t.selected),a&&a.handleSelected(t.selected),o||e._ws.regions.regions.forEach(e=>{e.id!==t.id&&e.handleSelected(!1)})}),null==(s=r.current)||s.on("regionCreated",t=>{e.addRegion(t)}),null==(a=r.current)||a.on("regionUpdatedEnd",t=>{e.updateRegion(t)}),l.addNamed("region:delete",()=>{var e;null==(e=r.current)||e.regions.clearSegments(!1)}),l.addNamed("segment:delete",()=>{var e;null==(e=r.current)||e.regions.clearSegments(!1)}),l.addNamed("region:delete-all",()=>{var e;null==(e=r.current)||e.regions.clearSegments()}),()=>{l.unbindAll()}},[]),(0,ae.jsxs)("div",{className:(0,Nn.cn)("audio-tag").toClassName(),children:[t,(0,ae.jsx)("div",{ref:t=>{o.current=t,e.stageRef.current=t}}),(0,ae.jsx)(Ci,{position:l.currentTime,playing:ls&&e.isBuffering?e.wasPlayingBeforeBuffering:l.playing,buffering:e.isBuffering,volume:l.volume,speed:l.rate,zoom:l.zoom,duration:l.duration,onPlay:()=>{ls&&e.isBuffering?e.triggerSyncPlay(!0):l.setPlaying(!0)},onPause:()=>{ls&&e.isBuffering?e.triggerSyncPause(!0):l.setPlaying(!1)},allowFullscreen:!1,onVolumeChange:e=>l.setVolume(e),onStepBackward:()=>{var e,t;null==(e=r.current)||e.seekBackward(.1),null==(t=r.current)||t.syncCursor()},onStepForward:()=>{var e,t;null==(e=r.current)||e.seekForward(.1),null==(t=r.current)||t.syncCursor()},onPositionChange:e=>{var t,n;null==(t=r.current)||t.seek(e),null==(n=r.current)||n.syncCursor()},onSpeedChange:e=>l.setRate(e),onZoom:e=>l.setZoom(e),amp:l.amp,onAmpChange:e=>l.setAmp(e),mediaType:"audio",toggleVisibility:(e,t)=>{if(r.current){var n;const i=null==(n=r.current)?void 0:n.getLayer(e);i&&i.setVisibility(t)}},layerVisibility:l.layerVisibility})]})}),ds=(0,b.PA)(({item:e})=>{var t;const[n,i]=bn("ls:audio-tag:settings",{playpauseHotkey:"audio:playpause",stepBackHotkey:"audio:step-backward",stepForwardHotkey:"audio:step-forward",loopRegion:!1,autoPlayNewSegments:!0},{decoder:xn,encoder:wn});const o=(0,f.useCallback)((e,t)=>{i(n=>Object.assign({},n,{[e]:t}))},[]),s=(0,f.useMemo)(()=>({position:0,length:0,regions:[],step:10,playing:!1,visibleWidth:0,seekOffset:0,data:void 0,settings:n,changeSetting:o}),[n]);return(0,ae.jsx)(Cn,{value:s,children:(0,ae.jsx)(cs,{item:e,children:null==(t=e.errors)?void 0:t.map((e,t)=>(0,ae.jsx)(ve,{error:e},`err-${t}`))})})});we.addTag("audio",yn,ds),we.addTag("audioplus",yn,ds),we.addObjectType(yn);var us=n(40067);const hs=(0,b.PA)(class extends f.Component{render(){const{item:e}=this.props,t=(n=Math.ceil(e.stageWidth/e.gridsize),i=Math.ceil(e.stageHeight/e.gridsize),o=e.gridsize,[...Array(n)].map((e,t)=>[...Array(i)].map((e,n)=>({col:t,row:n,x:t*o,y:n*o,fill:"#fff"}))).reduce((e,t)=>[...e,...t]));var n,i,o;return(0,ae.jsx)(us.Wd,{opacity:.15,name:"ruler",children:Object.values(t).map((t,n)=>(0,ae.jsx)(us.rw,{x:t.x,y:t.y,width:e.gridsize,height:e.gridsize,stroke:e.gridcolor,strokeWidth:1},n))})}}),gs=(0,f.createContext)({expanded:!1}),ms=gs.Provider,ps=Fn("SegmentationToolbar","Segmentation Tools"),fs={plus:"+",minus:"-"},vs=({active:e=!1,disabled:t=!1,smart:n=!1,extra:i=null,tool:o=null,controlsOnHover:s=!1,extraShortcuts:a={},ariaLabel:r,controls:l,icon:c,label:d,shortcut:u,onClick:h})=>{var g,m;let p=u;const v=null!=(g=null==o?void 0:o.dynamic)&&g,{expanded:y,alignment:b}=(0,f.useContext)(gs),[x,w]=(0,f.useState)(!1),S=(0,f.useMemo)(()=>{const e=ps.lookupKey(u);if(!(0,E.isDefined)(e))return null;const t=e.split(",").map(e=>e.trim());return(0,ae.jsx)("div",{className:(0,Nn.cn)("tool").elem("shortcut").toClassName(),children:t.map((e,t)=>{const n=e.split("+");return(0,ae.jsx)(f.Fragment,{children:n.map(e=>{var t;return(0,ae.jsx)("kbd",{className:(0,Nn.cn)("tool").elem("key").toClassName(),children:null!=(t=fs[e])?t:e},e)})},`${n.join("-")}-${t}`)})})},[u]);(0,f.useEffect)(()=>{const e=()=>{p&&ps.hasKeyByName(p)&&ps.removeNamed(p)};return e(),p=u,u&&!ps.hasKeyByName(u)&&ps.addNamed(u,()=>{var e;null!=o&&o.disabled||null!=o&&null!=(e=o.annotation)&&e.isDrawing||(null!=o&&o.unselectRegionOnToolChange&&o.annotation.unselectAreas(),null==h||h())}),()=>{e()}},[u,null==o?void 0:o.annotation]),(0,f.useEffect)(()=>(e&&Object.entries(a).forEach(([e,[t,n]])=>{ps.hasKeyByName(e)||ps.overwriteNamed(e,n)}),()=>{Object.keys(a).forEach(e=>{ps.hasKeyByName(e)&&ps.removeNamed(e)})}),[a,e]);const C=(0,f.useMemo)(()=>n&&i?(0,ae.jsx)("div",{className:(0,Nn.cn)("tool").elem("extra").toClassName(),children:i}):null,[n,i]),k=!1===v&&(null==l?void 0:l.length)&&(e||s&&x),P=null==o||null==(m=o.annotation)?void 0:m.isDrawing,R=t||P;return(0,ae.jsxs)("button",{type:"button","aria-label":r,className:(0,Nn.cn)("tool").mod({active:e,disabled:R,alignment:b,expanded:y&&!v,smart:v||n}).toClassName(),onClick:e=>{if(!t&&!P){var n;if(e.preventDefault(),null!=o&&o.unselectRegionOnToolChange)null==o||null==(n=o.annotation)||null==n.unselectAreas||n.unselectAreas();null==h||h(e)}},onMouseEnter:()=>{w(!0)},onMouseLeave:()=>{w(!1)},children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("tool").elem("icon").toClassName(),children:c}),!1===v&&!1===s&&(y?(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("tool").elem("label").toClassName(),children:[C,d,S]})}):((0,E.isDefined)(d)||(0,E.isDefined)(S))&&!k&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tool").elem("tooltip").mod({controlled:!(!n||!i)}).toClassName(),children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("tool").elem("tooltip-body").toClassName(),children:[C,d,S]})})),k&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tool").elem("controls").toClassName(),onClickCapture:e=>e.stopPropagation(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("tool").elem("controls-body").toClassName(),children:l})})]})};var ys=n(10750),bs=n.n(ys);const xs=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{ariaLabel:bs()((0,u.Pw)(e).name),active:e.selected,icon:e.iconClass,label:e.viewTooltip,shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,tool:e,onClick:()=>{e.manager.selectTool(e,!0)}})),ws=u.gK.model("BaseTool",{smart:!1,unselectRegionOnToolChange:!1,removeDuplicatesNamed:u.gK.maybeNull(u.gK.string)}).volatile(()=>({dynamic:!1,index:1,canInteractWithRegions:!0})).views(e=>({get toolName(){return(0,u.Pw)(e).name},get isSeparated(){return e.control.isSeparated},get viewClass(){return()=>e.shouldRenderView?(0,ae.jsx)(xs,{item:e}):null},get viewTooltip(){return null},get controls(){return null},get shouldRenderView(){return(e.isSeparated||e.smartEnabled)&&e.iconClass},get iconClass(){if(e.iconComponent){const t=e.iconComponent;return(0,ae.jsx)(t,{})}return null},get iconComponent(){return null},get smartEnabled(){var t,n;return null!=(t=null==(n=e.control)?void 0:n.smartEnabled)&&t}})).actions(e=>({afterCreate(){var t;if(e.smart&&null!=(t=e.control)&&t.smart){const t=(0,u._$)(e),n=(0,u.Pw)(e),i=Object.assign({},(0,u.dV)(e),{smart:!1,default:!1}),o=Object.assign({},t),s=n.create(i,o);s.makeDynamic(),(0,u._$)(e).manager.addTool(`${n.name}-smart`,s,e.control.removeDuplicatesNamed)}},makeDynamic(){e.dynamic=!0}})),Ss={X:3,Y:3},Cs={width:30,height:30},ks={radius:30},Ps={length:30},Rs={length:30},js=ws;function Ns(e){return{x:e.x+e.width/2*Math.cos(e.rotation)+e.height/2*Math.sin(-e.rotation),y:e.y+e.height/2*Math.cos(e.rotation)+e.width/2*Math.sin(e.rotation)}}function Ts(e,t){return function(e,t,n){const i=n.x+(e.x-n.x)*Math.cos(t)-(e.y-n.y)*Math.sin(t),o=n.y+(e.x-n.x)*Math.sin(t)+(e.y-n.y)*Math.cos(t);return Object.assign({},e,{rotation:e.rotation+t,x:i,y:o})}(e,t,Ns(e))}class _s extends bt.A.Transformer{constructor(e){super(e),this.isMouseOver=!1,this.isMouseDown=!1,this.initialRotationDelta=0,this.origin=void 0,this.handleMouseDown=e=>{const t=this.getStage(),n=null==t?void 0:t.getPointerPosition();if(!t||!n)return;const i=this._getNodeRect(),o=Ns(i),s=n.x-o.x,a=n.y-o.y,r=Math.PI/2-Math.atan2(-a,s);t.content.style.cursor=`url(${kn.nad}) 16 16, pointer`,this.isMouseDown=!0,this._movingAnchorName=e.target.name().split(" ")[0],this.initialRotationDelta=r-i.rotation,this.origin=o,window&&(window.addEventListener("mousemove",this.handleMouseMove),window.addEventListener("touchmove",this.handleMouseMove),window.addEventListener("mouseup",this.handleMouseUp,!0),window.addEventListener("touchend",this.handleMouseUp,!0)),this._fire("transformstart",{evt:e,target:this.getNode()}),this._nodes.forEach(t=>{t._fire("transformstart",{evt:e,target:t})})},this.handleMouseUp=e=>{this.isMouseDown=!1,this.origin=void 0,this.isMouseOver||(this.getStage().content.style.cursor=""),window&&(window.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("touchmove",this.handleMouseMove),window.removeEventListener("mouseup",this.handleMouseUp,!0),window.removeEventListener("touchend",this.handleMouseUp,!0));const t=this.getNode();this._fire("transformend",{evt:e,target:t}),t&&this._nodes.forEach(t=>{t._fire("transformend",{evt:e,target:t})}),this._movingAnchorName=""},this.handleMouseMove=e=>{const t=this.getStage();if(!this.isMouseDown||!this.origin||!t)return;t.setPointersPositions(e);const n=t.getPointerPosition(),i=this._getNodeRect();if(!n)return;const o=n.x-this.origin.x,s=n.y-this.origin.y,a=Math.PI/2-Math.atan2(-s,o)-this.initialRotationDelta,r=bt.A.getAngle(this.rotationSnapTolerance()),l=function(e,t,n){let i=t;for(let o=0;o<e.length;o++){const s=bt.A.getAngle(e[o]),a=Math.abs(s-t)%(2*Math.PI);Math.min(a,2*Math.PI-a)<n&&(i=s)}return i}(this.rotationSnaps(),a,r),c=Ts(i,l-i.rotation);this._fitNodesInto(c,e)},e.rotateEnabled&&this.createRotateButton()}createRotateButton(){const e=this.refreshRotationList();for(const t in e){const n=new bt.A.Circle({radius:20,name:`rotate-${t}`,dragDistance:0,draggable:!0,x:e[t].x,y:e[t].y});this.add(n),n.moveToBottom(),n.on("mousedown touchstart",this.handleMouseDown),n.on("mouseover",()=>{this.isMouseDown||(this.getStage().content.style.cursor=`url(${kn.nad}) 16 16, pointer`),this.isMouseOver=!0}),n.on("mouseout",()=>{this.isMouseOver=!1,this.isMouseDown||(this.getStage().content.style.cursor="")}),n.on("dragstart",e=>{this.findOne(`.${this._movingAnchorName}`).stopDrag(),e.cancelBubble=!0}),n.on("dragend",e=>{e.cancelBubble=!0})}}refreshRotationList(){return{"top-left":{x:0,y:0},"top-right":{x:this.getWidth(),y:0},"bottom-left":{x:0,y:this.getHeight()},"bottom-right":{x:this.getWidth(),y:this.getHeight()}}}get _outerBack(){var e;return null==(e=this.getStage())?void 0:e.findOne(this.attrs.backSelector)}setNodes(e=[]){return super.setNodes(e),this._outerBack&&this._proxyDrag(this._outerBack),this}detach(){var e;null==(e=this._outerBack)||e.off(".tr-konva"),super.detach()}update(){this.refreshRotationList();const{x:e,y:t,width:n,height:i}=this._getNodeRect(),o=this.rotation(),s=this._outerBack,a=this.refreshRotationList();for(const e in a){const t=this.findOne(`.rotate-${e}`);t&&t.setAttrs({x:a[e].x,y:a[e].y}).getLayer().batchDraw()}if(super.update(),s){const a=this.getAbsoluteScale(),r=s.getAbsoluteScale(),l={x:a.x/r.x,y:a.y/r.y};s.setAttrs({x:(e-this.getStage().getAttr("x"))*l.x,y:(t-this.getStage().getAttr("y"))*l.y,width:n*l.x,height:i*l.y,rotation:o}).getLayer().batchDraw()}}}bt.A.LSTransformer=_s;class As extends bt.A.Transformer{get _outerBack(){var e;return null==(e=this.getStage())?void 0:e.findOne(this.attrs.backSelector)}setNodes(e=[]){return super.setNodes(e),this._outerBack&&this._proxyDrag(this._outerBack),this}detach(){var e;null==(e=this._outerBack)||e.off(".tr-konva"),super.detach()}update(){const{x:e,y:t,width:n,height:i}=this._getNodeRect(),o=this.rotation(),s=this._outerBack;if(super.update(),s){const a=this.getAbsoluteScale(),r=s.getAbsoluteScale(),l={x:a.x/r.x,y:a.y/r.y};s.setAttrs({x:(e-this.getStage().getAttr("x"))*l.x,y:(t-this.getStage().getAttr("y"))*l.y,width:n*l.x,height:i*l.y,rotation:o}).getLayer().batchDraw()}}}bt.A.LSTransformerOld=As;class Is extends f.Component{constructor(...e){super(...e),this.checkNode=()=>{if(!this.transformer)return;const e=this.transformer.getStage(),{item:{selectedRegions:t}}=this.props;if(null==t||!t.length)return this.transformer.detach(),void this.transformer.getLayer().batchDraw();if(t.find(e=>!e.supportsTransform))return;const n=[];t.forEach(t=>{const i=e.findOne(e=>e.hasName(t.id)&&e.parent);if(!i)return;if(i.hasName("_transformable")&&n.push(i),!i.find)return;const o=i.find(e=>e.hasName("_transformable"),!0);n.push(...o)});const i=this.transformer.nodes();(null==n?void 0:n.length)===(null==i?void 0:i.length)&&!n.find((e,t)=>e!==i[t])||(n.length?this.transformer.nodes(n):this.transformer.nodes([]),this.transformer.getLayer().batchDraw())},this.constrainSizes=(e,t)=>{const n=void 0!==t.rotation?t.rotation:e.rotation,i=n!==e.rotation,o=this.getStageAbsoluteDimensions();if(t.width<Ss&&(t.width=Ss),t.height<Ss&&(t.height=Ss),n||i){const{x:i,y:s,width:a,height:r}=t,l=Ct({x:0,y:0,width:a,height:r},{x:i,y:s},n),c=this.fitBBoxToScaledStage(l,o);return["x","y","width","height"].some(e=>Math.abs(c[e]-l[e])>.001)?e:t}return this.fitBBoxToScaledStage(t,o)},this.dragBoundFunc=e=>{const{item:t}=this.props;return t.fixForZoomWrapper(e,e=>{if(!this.transformer||!t)return;let{x:n,y:i}=e;const{width:o,height:s}=this.draggingAreaBBox,{stageHeight:a,stageWidth:r}=t;return n<0&&(n=0),i<0&&(i=0),n+o>r&&(n=r-o),i+s>a&&(i=a-s),{x:n,y:i}})},this.applyRegionsTransform=()=>{if(!this.transformer)return;const{item:e}=this.props,{selectedRegions:t}=e;t.forEach(e=>{null==e.applyTransform||e.applyTransform({},null)})}}componentDidMount(){setTimeout(this.checkNode)}componentDidUpdate(){setTimeout(this.checkNode)}get freezeKey(){return`ImageTransformer_${this.props.item.id}`}freeze(){const{item:e}=this.props,{freezeKey:t}=this;e.annotation.history.freeze(t)}unfreeze(){const{item:e}=this.props,{freezeKey:t}=this;e.annotation.history.unfreeze(t)}fitBBoxToScaledStage(e,t){let{x:n,y:i,width:o,height:s}=e;const[a,r]=[e.x-t.x,e.y-t.y];return a<0?(n=(0,Ne.VS)(Ne.pG)?t.x:0,o+=a):a+e.width>t.width&&(o=t.width-a),r<0?(i=(0,Ne.VS)(Ne.pG)?t.y:0,s+=r):r+e.height>t.height&&(s=t.height-r),Object.assign({},e,{x:n,y:i,width:o,height:s})}getStageAbsoluteDimensions(){const e=this.transformer.getStage(),{stageWidth:t,stageHeight:n}=this.props.item;let[i,o]=[t*e.scaleX(),n*e.scaleY()];(0,Ne.VS)(Ne.pG)&&this.props.item.isSideways&&([i,o]=[o,i]);const[s,a]=[e.x(),e.y()];return{width:i,height:o,x:s,y:a}}renderLSTransformer(){return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)("LSTransformer",{ref:e=>{this.transformer=e,this.transformer&&this.transformer.rotateEnabled(!1)},resizeEnabled:!0,ignoreStroke:!0,keepRatio:!0!==this.props.singleNodeMode,useSingleNodeRotation:this.props.useSingleNodeRotation,rotateEnabled:this.props.rotateEnabled,borderDash:[3,1],boundBoxFunc:this.constrainSizes,anchorSize:8,flipEnabled:!0,zoomedIn:this.props.item.zoomScale>1,onDragStart:e=>{const{item:{selectedRegionsBBox:t}}=this.props;this.freeze(),this.transformer&&e.target===e.currentTarget&&t&&(this.draggingAreaBBox={x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top})},dragBoundFunc:this.dragBoundFunc,onDragEnd:()=>{this.applyRegionsTransform(),this.unfreeze(),setTimeout(this.checkNode)},onTransformEnd:()=>{this.applyRegionsTransform(),setTimeout(this.checkNode)},backSelector:this.props.draggableBackgroundSelector})})}renderOldLSTransformer(){return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)("LSTransformerOld",{ref:e=>{this.transformer=e},resizeEnabled:!0,ignoreStroke:!0,keepRatio:!0!==this.props.singleNodeMode,useSingleNodeRotation:this.props.useSingleNodeRotation,rotateEnabled:this.props.rotateEnabled,borderDash:[3,1],boundBoxFunc:this.constrainSizes,anchorSize:8,flipEnabled:!0,zoomedIn:this.props.item.zoomScale>1,onDragStart:e=>{const{item:{selectedRegionsBBox:t}}=this.props;this.freeze(),this.transformer&&e.target===e.currentTarget&&t&&(this.draggingAreaBBox={x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top})},dragBoundFunc:this.dragBoundFunc,onDragEnd:()=>{this.applyRegionsTransform(),this.unfreeze(),setTimeout(this.checkNode)},onTransformEnd:()=>{this.applyRegionsTransform(),setTimeout(this.checkNode)},backSelector:this.props.draggableBackgroundSelector})})}render(){return this.props.supportsTransform?(0,Ne.VS)(Ne.id)?this.renderLSTransformer():this.renderOldLSTransformer():null}}const Ms=({item:e,style:t,className:n,children:i})=>{const o=e.getProps&&e.getProps(),s=(0,Nn.cn)("object").toClassName();return(0,ae.jsx)("div",Object.assign({className:[s,n].join(" "),"data-needs-update":e._needsUpdate,style:t},o,{children:i}))},Es=((0,b.PA)(Ms),(0,b.PA)(Ms)),Ks={block:"block--h6e1z",divider:"divider--ucpOT",button:"button--Pugmq",wrapperComponent:"wrapperComponent--lGC5u",wrapper:"wrapper--HIxIc",loading:"loading--NbjdV","image-element":"image-element--YwHyO",image_position:"image_position--Wpu4V",image_position__top:"image_position__top--RQG6L",image_position__middle:"image_position__middle--Emb4G",image_position__center:"image_position__center--sjYuo",image_position__bottom:"image_position__bottom--Yhn9p",image_position__left:"image_position__left--zPURN",image_position__right:"image_position__right--F6wzt",container:"container--_mzc9",frame:"frame--nbBeT",frame_height:"frame_height--CVer_",filler:"filler--R3muM",overlay:"overlay--Ppw7x",withGallery:"withGallery--xrArp",withPagination:"withPagination--AmhTt",gallery:"gallery--IxYdb",active:"active--RZ3Re",pagination:"pagination--_qwcS"};var Ds=n(18094);const Os={required:(e,t)=>({modelName:e,field:t,error:"ERR_REQUIRED"}),unknownTag:(e,t,n)=>({modelName:e,field:t,value:n,error:"ERR_UNKNOWN_TAG"}),tagNotFound:(e,t,n)=>({modelName:e,field:t,value:n,error:"ERR_TAG_NOT_FOUND"}),tagUnsupported:(e,t,n,i)=>({modelName:e,field:t,value:n,validType:i,error:"ERR_TAG_UNSUPPORTED"}),parentTagUnexpected:(e,t,n,i)=>({modelName:e,field:t,value:n,validType:i,error:"ERR_PARENT_TAG_UNEXPECTED"}),badAttributeValueType:(e,t,n,i)=>({modelName:e,field:t,value:n,validType:i,error:"ERR_BAD_TYPE"}),internalError:e=>({error:"ERR_INTERNAL",value:String(e).substr(0,1e3),field:String(e.code),modelName:""}),generalError:e=>({error:"ERR_GENERAL",value:String(e).substr(0,1e3),field:String(e.code),modelName:""}),loadingError:(e,t,n,i=Ds.A.ERR_LOADING_HTTP)=>(console.log("ERR",e,e.code),{error:"ERR_GENERAL",value:i({attr:n,error:String(e),url:t}),field:n,modelName:""})},Ls=(e,t=null,n=["view"],i)=>{if(!e.children)return[];const o="pagedview"===e.type?e.children.slice(0,1):e.children;for(const e of o){var s;const o=[...n,...null!=t&&t.type?[null==t?void 0:t.type]:[]],a=Object.assign({},e,{parent:null!=(s=null==t?void 0:t.id)?s:null,parentTypes:o});delete a.children,i.push(a),Array.isArray(e.children)&&Ls(e,e,o,i)}return i},zs=(e,t)=>{const{name:n}=t.properties;return n&&!n.optionalValues&&void 0===e.name?Os.required(t.name,"name"):null},Bs=(e,t,n)=>{const{controlledTags:i}=t.properties;if(!e.toname)return null;const o=e.toname.split(",");for(const e of o){const o=n.find(t=>t.name===e);if(void 0===o)return Os.tagNotFound(t.name,"toname",e);if(i&&i.validate(o.tagName).length)return Os.tagUnsupported(t.name,"toname",o.tagName,i)}return null},Fs=(e,t)=>{var n;const i=null==(n=t.properties.parentTypes)?void 0:n.value;return!i||e.parentTypes.find(e=>i.find(t=>e===t.toLowerCase()))?null:Os.parentTagUnexpected(t.name,"parent",e.tagName,t.properties.parentTypes)},Hs=(e,t,n)=>{const i=[],o=Object.keys(t.properties);for(const s of o){if(!{}.hasOwnProperty.call(e,s))continue;if(n.includes(s))continue;const o=e[s],a=t.properties[s.toLowerCase()];0!==a.validate(o,a).length&&i.push(Os.badAttributeValueType(t.name,s,o,a))}return i},Vs=e=>{const t=[];return e.perregion&&e.peritem&&t.push(Os.generalError("Attribute <b>perItem</b> is incompatible with attribute <b>perRegion</b>. They define two different modes. However <b>perRegion</b> works fine even with multi-item mode of object tags.")),t};var $s=n(25673);const Ws=(0,b.WQ)("store")((0,b.PA)(({store:e,tools:t,expanded:n})=>{const[i,o]=(0,f.useState)(null),s=(()=>{const[e,t]=(0,f.useState)({width:window.innerWidth,height:window.innerWidth});return(0,f.useEffect)(()=>{const e=()=>{t({width:window.innerWidth,height:window.innerWidth})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),e})(),a=(0,f.useMemo)(()=>{if(!(0,E.isDefined)(i))return"right";const e=i.getBoundingClientRect();return e.left<200?"right":s.width-e.right<200?"left":"right"},[i,s]),r=t.filter(e=>!e.dynamic).reduce((e,t)=>{var n;const i=null!=(n=e[t.group])?n:[];return i.push(t),e[t.group]=i,e},{}),l=t.filter(e=>e.dynamic);return(0,ae.jsx)(ms,{value:{expanded:n,alignment:a},children:(0,ae.jsxs)("div",{ref:e=>o(e),className:(0,Nn.cn)("toolbar").mod({alignment:a,expanded:n}).toClassName(),children:[Object.entries(r).map(([e,t],n)=>{const i=t.filter(e=>e.viewClass);return i.length?(0,ae.jsx)("div",{className:(0,Nn.cn)("toolbar").elem("group").toClassName(),children:i.sort((e,t)=>e.index-t.index).map((e,t)=>{const n=e.viewClass;return(0,ae.jsx)(n,{},`${e.toolName}-${t}`)})},`toolset-${e}-${n}`):null}),e.autoAnnotation&&(0,ae.jsx)(Us,{tools:l})]})})})),Us=(0,b.PA)(({tools:e})=>{const[t,n]=(0,f.useState)(Math.max(e.findIndex(e=>e.selected),0)),i=(0,f.useMemo)(()=>e[t],[t]),o=e.some(e=>e.selected);return e.length>0&&(0,ae.jsx)("div",{className:(0,Nn.cn)("toolbar").elem("group").toClassName(),children:(0,ae.jsx)(vs,{smart:!0,label:"Auto-Detect",active:o,icon:i.iconClass,shortcut:"tool:auto-detect",extra:e.length>1?(0,ae.jsx)("div",{className:(0,Nn.cn)("toolbar").elem("smart").toClassName(),children:e.map((e,t)=>{const i=e.viewClass;return(0,ae.jsx)("div",{onClickCapture:i=>{i.preventDefault(),n(t),e.manager.selectTool(e,!0)},children:(0,ae.jsx)(i,{})},`${t}`)})}):null,controls:i.controls,onClick:i=>{var s;let a=t+1;if(null!=i&&null!=(s=i.target)&&s.closest(`.${(0,Nn.cn)("tool").elem("extra")}`))return;o?a>=e.length&&(a=0):a=0;const r=e[a];n(a),r.manager.selectTool(r,!0)}})})}),Gs=(0,f.createContext)({suggestion:!1}),Ys=Gs.Provider;var Xs=n(21015);const qs=(0,f.forwardRef)(({size:e="medium",pageSizeOptions:t=[1,25,50,100],currentPage:n,pageSize:i,totalPages:o,outline:s=!0,align:a="right",noPadding:r=!1,pageSizeSelectable:l=!0,hotkey:c,disabled:d,onChange:u},h)=>{const[g,m]=(0,f.useState)(!1),p=(0,f.useMemo)(()=>t.map((e,t)=>({value:e,label:`${e} per page`})),[t]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("pagination").mod({size:e,outline:s,align:a,noPadding:r,disabled:d}).toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("pagination").elem("navigation").toClassName(),children:[(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Zs,{mod:["arrow-left","arrow-left-double"],onClick:()=>null==u?void 0:u(1),disabled:1===n||d}),(0,ae.jsx)("div",{className:(0,Nn.cn)("pagination").elem("divider").toClassName()})]}),(0,ae.jsx)(Zs,{mod:["arrow-left"],onClick:()=>null==u?void 0:u(n-1),hotkey:null==c?void 0:c.prev,disabled:1===n||d}),(0,ae.jsx)("div",{className:(0,Nn.cn)("pagination").elem("input").toClassName(),children:g?(0,ae.jsx)("input",{type:"text",autoFocus:!0,defaultValue:n,pattern:"[0-9]",onKeyDown:e=>{const t=Number.parseFloat(e.currentTarget.value);"Escape"===e.code?m(!1):"Enter"===e.code?(t<=o&&t>=1&&(null==u||u(t)),m(!1)):null!==e.code.match(/[0-9]/)||(e=>null!==e.code.match(/arrow/i)||e.shiftKey&&null!==e.code.match(/arrow/i)||e.metaKey||e.ctrlKey||"Backspace"===e.code)(e)||(e.preventDefault(),e.stopPropagation())},onBlur:e=>{const t=Number.parseFloat(e.currentTarget.value);t<=o&&t>=1&&(null==u||u(t)),m(!1)}}):(0,ae.jsxs)("div",{className:(0,Nn.cn)("pagination").elem("page-indicator").toClassName(),onClick:()=>{m(!0)},children:[n," ",(0,ae.jsxs)("span",{children:["of ",o]}),(0,ae.jsx)("div",{onClick:()=>{}})]})}),(0,ae.jsx)(Zs,{mod:["arrow-right"],onClick:()=>null==u?void 0:u(n+1),disabled:n===o||d,hotkey:null==c?void 0:c.next}),(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("pagination").elem("divider").toClassName()}),(0,ae.jsx)(Zs,{mod:["arrow-right","arrow-right-double"],onClick:()=>null==u?void 0:u(o),disabled:n===o||d})]})]}),l&&(0,ae.jsx)("div",{className:(0,Nn.cn)("pagination").elem("page-size").toClassName(),children:(0,ae.jsx)(Pn.l6P,{value:i,onChange:e=>{null==u||u(1,e.currentTarget.value)},options:p})})]})}),Zs=({mod:e,disabled:t,hotkey:n,onClick:i})=>{const o=Object.fromEntries(e.map(e=>[e,!0])),s=(0,f.useCallback)(()=>{t||i()},[t,i]);return o.disabled=!0===t,(0,ae.jsx)($n,{binging:n,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("pagination").elem("btn").mod(o).toClassName(),onClick:s})})},Js=100,Qs=100,ea="edge",ta="center",na=(0,b.PA)((0,f.forwardRef)(({imageEntity:e,imageTransform:t,updateImageSize:n,usedValue:i,size:o,overlay:s},a)=>{const r=(0,f.useMemo)(()=>({width:1===o.width?"100%":o.width,height:1===o.height?"auto":o.height}),[o]),l=(0,f.useCallback)(t=>{n(t),e.setImageLoaded(!0)},[n,e]),c=(0,f.useCallback)(()=>{e.setError(!0)},[e]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("image").toClassName(),style:r,children:[s,(0,ae.jsx)(ia,{downloading:e.downloading,progress:e.progress,error:e.error,src:e.src,usedValue:i}),e.downloaded?(0,ae.jsx)(sa,{alt:"image",ref:a,src:e.currentSrc,onLoad:l,onError:c,isLoaded:e.imageLoaded,imageTransform:t}):null]})})),ia=(0,b.PA)(({downloading:e,progress:t,error:n,src:i,usedValue:o})=>e?(0,ae.jsxs)("div",{className:(0,Nn.cn)("image-progress").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("image-progress").elem("message").toClassName(),children:"Downloading image"}),(0,ae.jsx)("progress",{className:(0,Nn.cn)("image-progress").elem("bar").toClassName(),value:t,min:"0",max:1,step:1e-4})]}):n?(0,ae.jsx)(aa,{src:i,value:o}):null),oa={crossOrigin:"anonymous"},sa=(0,b.PA)((0,f.forwardRef)(({src:e,onLoad:t,onError:n,imageTransform:i,isLoaded:o},s)=>{const a=(0,f.useMemo)(()=>{const e=Object.assign({},i,{clip:"rect(1px, 1px, 1px, 1px)"});return Object.assign({},e,{maxWidth:"unset",visibility:o?"visible":"hidden"})},[i,o]);return(0,ae.jsx)("img",Object.assign({},oa,{ref:s,alt:"image",src:e,onLoad:t,onError:n,style:a}))})),aa=({src:e,value:t})=>{const n=(0,f.useMemo)(()=>Ds.A.ERR_LOADING_HTTP({url:e,error:"",attr:t}),[e]);return(0,ae.jsx)(ve,{error:n})},ra=["item"];bt.A.showWarnings=!1;const la=Fn("Image"),ca={crossOrigin:"anonymous"},da=e=>{const t=[],n=[],i=[];for(const o of e)switch(o.type){case"brushregion":t.push(o);break;case"bitmaskregion":i.push(o);break;default:n.push(o)}return{brushRegions:t,bitmaskRegions:i,vectorRegions:[],shapeRegions:n}},ua=(0,f.memo)(({region:e,showSelected:t=!1})=>(0,Xs.q3)(()=>st.renderItem(e,e.annotation,!0))),ha=(0,f.memo)(({regions:e,name:t,useLayers:n,showSelected:i=!1,smoothing:o=!0})=>{const s=e.map(e=>(0,ae.jsx)(ua,{region:e,showSelected:i},`region-${e.id}`));return!1===n?s:(0,ae.jsx)(us.Wd,{name:t,imageSmoothingEnabled:o,children:s})}),ga=(0,f.memo)(({regions:e,useLayers:t=!0,chunkSize:n=15,suggestion:i=!1,showSelected:o=!1,smoothing:s=!0})=>(0,ae.jsx)(Ys,{value:{suggestion:i},children:(n?(0,E.chunks)(e,n):e).map((e,n)=>(0,ae.jsx)(ha,{name:`chunk-${n}`,regions:e,useLayers:t,showSelected:o,smoothing:s},`chunk-${n}`))})),ma=(0,b.PA)(({item:e})=>{const{drawingRegion:t}=e;if(!t)return null;if(e.multiImage&&e.currentImage!==t.item_index)return null;const n="brushregion"===t.type,i=t&&n?f.Fragment:us.Wd;return(0,ae.jsx)(i,{imageSmoothingEnabled:e.smoothingEnabled,children:t?(0,ae.jsx)(ua,{region:t},"drawing"):t})}),pa="#40A9FF",fa="white",va=[3,3],ya=(0,b.PA)(({item:e,selectionArea:t})=>{const{selectionBorders:n}=t,i=n?[{x:n.left,y:n.top},{x:n.right,y:n.top},{x:n.left,y:n.bottom},{x:n.right,y:n.bottom}]:[],o=6/e.stageScale;return(0,ae.jsxs)(ae.Fragment,{children:[n&&(0,ae.jsx)(us.rw,{name:"regions_selection",x:n.left,y:n.top,width:n.right-n.left,height:n.bottom-n.top,stroke:pa,strokeWidth:1,strokeScaleEnabled:!1,listening:!1}),i.map((e,t)=>(0,ae.jsx)(us.rw,{x:e.x-o/2,y:e.y-o/2,width:o,height:o,fill:pa,stroke:fa,strokeWidth:2,strokeScaleEnabled:!1,listening:!1},t))]})}),ba=(0,b.PA)(({item:e})=>{const{x:t,y:n,width:i,height:o}=e.onCanvasRect,s={x:t,y:n,width:i,height:o,listening:!1,strokeWidth:1};return(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(us.rw,Object.assign({},s,{stroke:pa,dash:va,strokeScaleEnabled:!1})),(0,ae.jsx)(us.rw,Object.assign({},s,{stroke:fa,dash:va,dashOffset:va[0],strokeScaleEnabled:!1}))]})}),xa="transformer_back",wa=(0,b.PA)(({item:e})=>{const{selectedRegionsBBox:t}=e,n=1===e.selectedRegions.length,i=(0,f.useRef)({x:0,y:0});return(0,ae.jsx)(us.Wd,{children:t&&!n&&(0,ae.jsx)(us.rw,{id:xa,fill:"rgba(0,0,0,0)",draggable:!0,onClick:()=>{e.annotation.unselectAreas()},onMouseOver:t=>{e.annotation.isLinkingMode||(t.target.getStage().container().style.cursor=w.A.POINTER_CURSOR)},onMouseOut:e=>{e.target.getStage().container().style.cursor=w.A.DEFAULT_CURSOR},onDragStart:t=>{i.current={x:e.canvasToInternalX(t.target.getAttr("x")),y:e.canvasToInternalY(t.target.getAttr("y"))}},dragBoundFunc:t=>{let{x:n,y:o}=t;const{top:s,left:a,right:r,bottom:l}=e.selectedRegionsBBox,{stageHeight:c,stageWidth:d}=e,u=i.current.x-a,h=i.current.y-s;n-=u,o-=h;const g={x:n,y:o,width:r-a,height:l-s},m=kt(g,d,c);return m.width!==g.width&&(n+=(m.width-g.width)*(m.x!==g.x?-1:1)),m.height!==g.height&&(o+=(m.height-g.height)*(m.y!==g.y?-1:1)),n+=u,o+=h,{x:n,y:o}}})})}),Sa=((0,b.PA)(({item:e,selectedRegions:t})=>{if(!t)return null;const{brushRegions:n=[],shapeRegions:i=[]}=da(t);return(0,ae.jsxs)(ae.Fragment,{children:[(0,Ne.VS)(Ne.q$)?null:(0,ae.jsx)(wa,{item:e}),n.length>0&&(0,ae.jsx)(ga,{name:"brushes",regions:n,useLayers:!1,showSelected:!0,chankSize:0},"brushes"),i.length>0&&(0,ae.jsx)(ga,{name:"shapes",regions:i,showSelected:!0,chankSize:0},"shapes")]})}),(0,b.PA)(({item:e,selectionArea:t})=>{var n,i,o,s;const[a,r]=(0,f.useState)(!1),[l,c]=(0,f.useState)(!1),d="ZoomPanTool"===(null==(n=e.getToolsManager().findSelectedTool())?void 0:n.fullName),u=e=>r(4===e.buttons),h=e=>c(e.shiftKey);(0,f.useEffect)(()=>(window.addEventListener("keydown",h),window.addEventListener("keyup",h),window.addEventListener("mousedown",u),window.addEventListener("mouseup",u),()=>{window.removeEventListener("keydown",h),window.removeEventListener("keyup",h),window.removeEventListener("mousedown",u),window.removeEventListener("mouseup",u)}),[]);const g=e.zoomScale>1&&(l||d||a);let m=!0,p=!0,v=!0;return null==(i=e.selectedRegions)||i.forEach(e=>{m=m&&!0===e.supportsTransform,p=p&&!0===e.canRotate,v=v&&!0}),m=m&&(e.selectedRegions.length>1||(e.useTransformer||(null==(o=e.selectedShape)?void 0:o.preferTransformer))&&(null==(s=e.selectedShape)?void 0:s.useTransformer)),(0,ae.jsxs)(us.Wd,{scaleX:1,scaleY:1,children:[t.isActive?(0,ae.jsx)(ba,{item:t}):!m&&e.selectedRegions.length>1?(0,ae.jsx)(ya,{item:e,selectionArea:t}):null,(0,ae.jsx)(Is,{item:e,rotateEnabled:p,supportsTransform:!g&&m,supportsScale:v,selectedShapes:e.selectedRegions,singleNodeMode:1===e.selectedRegions.length,useSingleNodeRotation:1===e.selectedRegions.length&&p,draggableBackgroundSelector:`#${xa}`})]})})),Ca=(0,b.PA)(e=>{let{item:t}=e;(0,Se.A)(e,ra);const{selectionArea:n}=t;return(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(us.Wd,{name:"selection-regions-layer"}),(0,ae.jsx)(Sa,{item:t,selectionArea:n})]})}),ka=(0,f.memo)((0,f.forwardRef)(({width:e,height:t},n)=>{const[i,o]=(0,f.useState)([50,0,50,t]),[s,a]=(0,f.useState)([0,100,e,100]),[r,l]=(0,f.useState)(100),[c,d]=(0,f.useState)(50),[u,h]=(0,f.useState)(!1),g=[3,3],m=!1;return n&&(n.current={updatePointer(n,i){n!==r&&(l(n),o([n,0,n,t])),i!==c&&(d(i),a([0,i,e,i]))},updateVisibility(e){h(e)}}),(0,ae.jsxs)(us.Wd,{name:"crosshair",listening:!1,opacity:u?.6:0,children:[(0,ae.jsxs)(us.YJ,{children:[(0,ae.jsx)(us.N1,{name:"v-white",points:s,stroke:"#fff",strokeWidth:1,strokeScaleEnabled:m}),(0,ae.jsx)(us.N1,{name:"v-black",points:s,stroke:"#000",strokeWidth:1,dash:g,strokeScaleEnabled:m})]}),(0,ae.jsxs)(us.YJ,{children:[(0,ae.jsx)(us.N1,{name:"h-white",points:i,stroke:"#fff",strokeWidth:1,strokeScaleEnabled:m}),(0,ae.jsx)(us.N1,{name:"h-black",points:i,stroke:"#000",strokeWidth:1,dash:g,strokeScaleEnabled:m})]})]})})),Pa=(0,b.PA)(({item:e})=>{var t;const n=e.zoomScale>20,{naturalWidth:i,naturalHeight:o}=null!=(t=e.currentImageEntity)?t:{},{stageWidth:s,stageHeight:a}=e,r=e.stageZoom,{verticalPoints:l,horizontalPoints:c}=(0,f.useMemo)(()=>{const e=[],t=[];for(let t=0;t<=s;t+=r)e.push(t,0,t,a,t,0);for(let e=0;e<=a;e+=r)t.push(0,e,s,e,0,e);return{verticalPoints:e,horizontalPoints:t}},[s,a]);return(0,ae.jsxs)(us.Wd,{listening:!1,visible:n,children:[(0,ae.jsx)(us.N1,{points:l,stroke:"white",strokeWidth:1,strokeScaleEnabled:!1,perfectDrawEnabled:!1,opacity:.2,listening:!1,visible:n}),(0,ae.jsx)(us.N1,{points:c,stroke:"white",strokeWidth:1,strokeScaleEnabled:!1,perfectDrawEnabled:!1,opacity:.2,listening:!1,visible:n})]})}),Ra=(0,b.PA)(({item:e})=>(0,ae.jsx)("canvas",{className:Ks.overlay,ref:t=>{e.setOverlayRef(t)},style:e.imageTransform})),ja=(0,b.PA)(class extends f.Component{constructor(e){super(e),this.canvasX=void 0,this.canvasY=void 0,this.lastOffsetWidth=-1,this.lastOffsetHeight=-1,this.state={imgStyle:{},pointer:[0,0]},this.imageRef=(0,f.createRef)(),this.crosshairRef=(0,f.createRef)(),this.handleDeferredMouseDown=null,this.deferredClickTimeout=[],this.skipNextMouseDown=!1,this.skipNextClick=!1,this.skipNextMouseUp=!1,this.mouseDownPoint=null,this.mouseDown=!1,this.handleOnClick=e=>{var t,n;const{item:i}=this.props;var o;(0,Ne.VS)(Ne.x0)&&(null==(o=this.handleDeferredMouseDown)||o.call(this,!0));if(this.skipNextClick)return void(this.skipNextClick=!1);const s=e.evt||e,{offsetX:a,offsetY:r}=s;if((0,Ne.VS)(Ne.q$)&&(!this.mouseDownPoint||Math.abs(this.mouseDownPoint.x-a)>.01||Math.abs(this.mouseDownPoint.y-r)>.01))return void(this.mouseDownPoint=null);const l=/bitmask|vector/i,c=(i.selectedRegions.some(e=>null!==e.type.match(l)),i.getToolsManager().findSelectedTool()),d=(t=null!==(null==c||null==(n=c.toolName)||null==n.match?void 0:n.match(l)),i.regs.find(e=>{var t;return!e.selected&&"drawing"!==(null==c?void 0:c.mode)&&(null!=(t=null==e.isHovered?void 0:e.isHovered())&&t)}));return d&&!s.defaultPrevented?(null==c||c.disable(),d.onClickRegion(e),void(null==c||c.enable())):i.event("click",s,a,r)},this.resetDeferredClickTimeout=()=>{this.deferredClickTimeout.length>0&&(this.deferredClickTimeout=this.deferredClickTimeout.filter(e=>(clearTimeout(e),!1)))},this.handleDeferredClick=(e,t,n=!1)=>{this.handleDeferredMouseDown=i=>{i&&n&&t(),e(),this.handleDeferredMouseDown=null},this.resetDeferredClickTimeout(),this.deferredClickTimeout.push(setTimeout(()=>{var e;null==(e=this.handleDeferredMouseDown)||e.call(this,!1)},this.props.item.annotation.isDrawing?0:100))},this.handleMouseDown=e=>{var t,n;this.mouseDown=!0;const{item:i}=this.props,o="ZoomPanTool"===(null==(t=i.getToolsManager().findSelectedTool())?void 0:t.fullName),s="MoveTool"===(null==(n=i.getToolsManager().findSelectedTool())?void 0:n.fullName);this.skipNextMouseDown=this.skipNextMouseUp=this.skipNextClick=!1,(0,Ne.VS)(Ne.q$)&&(this.mouseDownPoint={x:e.evt.offsetX,y:e.evt.offsetY}),i.updateSkipInteractions(e);const a=e.target.getParent();if(i.annotation.isReadOnly()&&!o)return;if(a&&"Transformer"===a.className)return;const r=()=>{1===e.evt.button&&e.evt.preventDefault();if(i.getSkipInteractions()||e.target===i.stageRef||(0,E.findClosestParent)(e.target,e=>{var t;if("Layer"===e.nodeType&&!s&&"bitmask"===(null==(t=e.attrs)?void 0:t.name))return!0;if("Group"===e.nodeType){var n,i;if("ruler"===(null==e||null==(n=e.attrs)?void 0:n.name))return!0;if(!s&&"segmentation"===(null==e||null==(i=e.attrs)?void 0:i.name))return!0}return!1})){window.addEventListener("mousemove",this.handleGlobalMouseMove),window.addEventListener("mouseup",this.handleGlobalMouseUp);const{offsetX:t,offsetY:n}=e.evt,{left:o,top:s}=i.containerRef.getBoundingClientRect();return this.canvasX=o,this.canvasY=s,this.skipNextMouseDown?(this.skipNextMouseDown=!1,!0):(i.event("mousedown",e,t,n),!0)}},l=i.getToolsManager().findSelectedTool(),c=[void 0,"EllipseTool","EllipseTool-dynamic","RectangleTool","RectangleTool-dynamic","PolygonTool","PolygonTool-dynamic","Rectangle3PointTool","Rectangle3PointTool-dynamic"].includes(null==l?void 0:l.fullName);if((0,Ne.VS)(Ne.x0)&&c){const t=e.target===i.stageRef,n=i.annotation.selectedRegions.length>0,o=t&&n,s=()=>{i.annotation.unselectAll(),this.skipNextMouseDown=!0,this.skipNextMouseUp=!0,this.skipNextClick=!0};return void this.handleDeferredClick(r,s,o)}const d=r();return d||!0},this.handleGlobalMouseUp=e=>{if(window.removeEventListener("mousemove",this.handleGlobalMouseMove),window.removeEventListener("mouseup",this.handleGlobalMouseUp),e.target&&"CANVAS"===e.target.tagName)return;const{item:t}=this.props,{clientX:n,clientY:i}=e;return t.freezeHistory(),this.triggerMouseUp(e,n-this.canvasX,i-this.canvasY)},this.handleGlobalMouseMove=e=>{if(e.target&&"CANVAS"===e.target.tagName)return;const{item:t}=this.props,{clientX:n,clientY:i}=e;return t.event("mousemove",e,n-this.canvasX,i-this.canvasY)},this.handleMouseUp=e=>{this.mouseDown=!1;const{item:t}=this.props;return(0,Ne.VS)(Ne.x0)&&this.resetDeferredClickTimeout(),t.freezeHistory(),this.triggerMouseUp(e,e.evt.offsetX,e.evt.offsetY)},this.triggerMouseUp=(e,t,n)=>{if(this.skipNextMouseUp)return void(this.skipNextMouseUp=!1);const{item:i}=this.props;return i.event("mouseup",e,t,n)},this.handleMouseMove=e=>{const{item:t}=this.props;t.freezeHistory(),this.updateCrosshair(e);const n=e.evt&&4===e.evt.buttons,i=e.evt&&1===e.evt.buttons,o=i&&e.evt.shiftKey;var s;(0,Ne.VS)(Ne.x0)&&i&&(this.resetDeferredClickTimeout(),null==(s=this.handleDeferredMouseDown)||s.call(this,!1));if((n||o)&&t.zoomScale>1){t.setSkipInteractions(!0),e.evt.preventDefault();const n={x:t.zoomingPositionX+e.evt.movementX,y:t.zoomingPositionY+e.evt.movementY};t.setZoomPosition(n.x,n.y)}else t.event("mousemove",e,e.evt.offsetX,e.evt.offsetY);if(!e.evt.ctrlKey&&!e.evt.shiftKey&&!this.mouseDown){const e=/bitmask/,n=t.getToolsManager().findSelectedTool();if(t.regs.some(e=>e.isDrawing))return;if(!t.regs.some(t=>null!==t.type.match(e)))return;if(t.regs.some(e=>null==e.isTransforming?void 0:e.isTransforming()))return;requestAnimationFrame(()=>{null==n||n.enable();for(const e of t.regs)e.setHighlight(!1),e.updateCursor(!1);for(const o of t.regs){var i;if(null===o.type.match(e))continue;if(null!=(i=!o.selected&&!o.isDrawing&&(null==o.isHovered?void 0:o.isHovered()))&&i){null==n||n.disable(),o.updateCursor(!0);break}}})}},this.updateCrosshair=e=>{if(this.crosshairRef.current){const{x:t,y:n}=e.currentTarget.getPointerPosition();this.crosshairRef.current.updatePointer(...this.props.item.fixZoomedCoords([t,n]))}},this.handleError=()=>{const{item:e,store:t}=this.props,n=t.annotationStore,i=(0,u._$)(t).messages.ERR_LOADING_HTTP({attr:e.value,error:"",url:e.currentSrc});n.addErrors([Os.generalError(i)])},this.updateGridSize=e=>{const{item:t}=this.props;t.freezeHistory(),t.setGridSize(e)},this.handleZoom=e=>{var t,n;if(null!=(t=e.evt)&&t.ctrlKey||null!=(n=e.evt)&&n.metaKey){e.evt.preventDefault();const{item:t}=this.props,n=t.stageRef;t.handleZoom(e.evt.deltaY,n.getPointerPosition(),e.evt.ctrlKey)}else if(e.evt){const{item:t}=this.props,n=Math.round(t.stageWidth*t.zoomScale)-t.stageWidth,i=Math.round(t.stageHeight*t.zoomScale)-t.stageHeight,o={x:Math.min(0,Math.ceil(t.zoomingPositionX-e.evt.deltaX)),y:Math.min(0,Math.ceil(t.zoomingPositionY-e.evt.deltaY))},s=0!==o.x&&o.x>-n&&1!==t.zoomScale,a=0!==o.y&&o.y>-i&&1!==t.zoomScale,r=Math.abs(e.evt.deltaX)>Math.abs(e.evt.deltaY),l=Math.abs(e.evt.deltaY)>Math.abs(e.evt.deltaX);s&&r&&e.evt.preventDefault(),a&&l&&e.evt.preventDefault(),t.setZoomPosition(o.x,o.y)}},this.onResize=M(()=>{requestAnimationFrame(()=>{var e;if(null==this||null==(e=this.props)||null==(e=e.item)||!e.containerRef)return;const{offsetWidth:t,offsetHeight:n}=this.props.item.containerRef;this.props.item.naturalWidth<=1||this.lastOffsetWidth===t&&this.lastOffsetHeight===n||(this.props.item.onResize(t,n,!0),this.lastOffsetWidth=t,this.lastOffsetHeight=n)})},16),this.attachObserver=e=>{this.resizeObserver&&this.detachObserver(),e&&(this.resizeObserver=new _(this.onResize),this.resizeObserver.observe(e))},this.detachObserver=()=>{this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},"boolean"==typeof e.item.smoothingEnabled&&e.store.settings.setSmoothing(e.item.smoothingEnabled)}renderRulers(){const{item:e}=this.props,t="white";return(0,ae.jsxs)(us.YJ,{name:"ruler",onClick:e=>{e.cancelBubble=!1},children:[(0,ae.jsx)(us.N1,{x:0,y:e.cursorPositionY,points:[0,0,e.stageWidth,0],strokeWidth:1,stroke:t,tension:0,dash:[4,4],closed:!0}),(0,ae.jsx)(us.N1,{x:e.cursorPositionX,y:0,points:[0,0,0,e.stageHeight],strokeWidth:1,stroke:t,tension:0,dash:[1.5],closed:!0})]})}componentDidMount(){const{item:e}=this.props;window.addEventListener("resize",this.onResize),this.attachObserver(e.containerRef),this.updateReadyStatus(),la.addDescription("shift","Pan image")}componentWillUnmount(){this.detachObserver(),window.removeEventListener("resize",this.onResize),la.removeDescription("shift")}componentDidUpdate(){this.onResize(),this.updateReadyStatus()}updateReadyStatus(){const{item:e}=this.props,{imageRef:t}=this;e&&(0,u._n)(e)&&t.current&&e.isReady!==t.current.complete&&e.setReady(t.current.complete)}renderTools(){const{item:e,store:t}=this.props;if(t.annotationStore.viewingAll)return null;const n=e.getToolsManager().allTools();return(0,ae.jsx)(Ws,{tools:n})}render(){const{item:e,store:t}=this.props;if(!(0,u._n)(e))return null;if(!t.task||!e.currentSrc)return null;const n={},i=Ks.container,o=!!e.isMultiItem;!1===(0,u.Zn)(e).settings.fullscreen&&(n.maxWidth=e.maxwidth,n.maxHeight=e.maxheight,n.width=e.width,n.height=e.height),!t.settings.enableSmoothing&&e.zoomScale>1&&(n.imageRendering="pixelated");const s=[Ks.image_position,Ks[`image_position__${"center"===e.verticalalignment?"middle":e.verticalalignment}`],Ks[`image_position__${e.horizontalalignment}`]],a=[Ks.wrapperComponent,e.images.length>1?Ks.withGallery:Ks.wrapper];o&&a.push(Ks.withPagination);const[r,l]=(0,Ne.VS)(Ne.F2)?[!0,!1]:[e.hasTools,e.stageWidth<=1],c=e.imageIsLoaded||!(0,Ne.VS)(Ne.F2),d=t.annotationStore.viewingAll;return(0,ae.jsxs)(Es,{item:e,className:a.join(" "),children:[o?(0,ae.jsx)("div",{className:Ks.pagination,title:d?"Pagination is not supported in View All Annotations":void 0,children:(0,ae.jsx)(qs,{size:"small",outline:!1,align:"left",noPadding:!0,hotkey:{prev:"image:prev",next:"image:next"},currentPage:e.currentImage+1,totalPages:e.parsedValueList.length,onChange:t=>e.setCurrentImage(t-1),pageSizeSelectable:!1,disabled:d})}):null,(0,ae.jsxs)("div",{ref:t=>{e.setContainerRef(t),this.attachObserver(t)},className:i,style:n,children:[(0,ae.jsx)("div",{ref:e=>{this.filler=e},className:Ks.filler,style:{width:"100%",marginTop:e.fillerHeight}}),(0,Ne.VS)(Ne.F2)?(0,ae.jsx)(na,{ref:t=>{e.setImageRef(t),this.imageRef.current=t},usedValue:e.usedValue,imageEntity:e.currentImageEntity,imageTransform:e.imageTransform,updateImageSize:e.updateImageSize,size:e.canvasSize,overlay:(0,ae.jsx)(Ra,{item:e})}):(0,ae.jsxs)("div",{className:[Ks.frame,...s].join(" "),style:e.canvasSize,children:[(0,ae.jsx)("img",{ref:t=>{e.setImageRef(t),this.imageRef.current=t},loading:(0,Ne.VS)(Ne.H)&&!e.lazyoff?"lazy":"false",style:e.imageTransform,src:e.currentSrc,onLoad:t=>{e.updateImageSize(t),e.currentImageEntity.setImageLoaded(!0)},onError:this.handleError,crossOrigin:e.imageCrossOrigin,alt:"LS"}),(0,ae.jsx)(Ra,{item:e})]}),l||!r?(0,ae.jsx)("div",{className:Ks.loading,children:(0,ae.jsx)($s.A,{})}):c?(0,ae.jsx)(Na,{item:e,crosshairRef:this.crosshairRef,onClick:this.handleOnClick,imagePositionClassnames:s,state:this.state,onMouseEnter:()=>{this.crosshairRef.current&&this.crosshairRef.current.updateVisibility(!0)},onMouseLeave:t=>{this.crosshairRef.current&&this.crosshairRef.current.updateVisibility(!1);const{width:n,height:i}=e.canvasSize,{offsetX:o,offsetY:s}=t.evt,a=Object.assign({},t);o<=0?t.offsetX=0:o>=n&&(t.offsetX=n),s<=0?t.offsetY=0:s>=i&&(t.offsetY=i),this.handleMouseMove(a)},onDragMove:this.updateCrosshair,onMouseDown:this.handleMouseDown,onMouseMove:this.handleMouseMove,onMouseUp:this.handleMouseUp,onWheel:e.zoom?this.handleZoom:()=>{}}):null]}),r&&c&&this.renderTools(),e.images.length>1&&(0,ae.jsx)("div",{className:Ks.gallery,children:e.images.map((t,n)=>(0,f.createElement)("img",Object.assign({},ca,{alt:"",key:t,src:t,className:n===e.currentImage&&Ks.active,height:"60",onClick:()=>e.setCurrentImage(n)})))})]})}}),Na=(0,b.PA)(({item:e,imagePositionClassnames:t,state:n,onClick:i,onMouseEnter:o,onMouseLeave:s,onDragMove:a,onMouseDown:r,onMouseMove:l,onMouseUp:c,onWheel:d,crosshairRef:u})=>{const{store:h}=e;let g,m;return(0,Ne.VS)(Ne.pG)?(g={width:e.containerWidth,height:e.containerHeight},m={x:e.zoomingPositionX+e.alignmentOffset.x,y:e.zoomingPositionY+e.alignmentOffset.y}):(g=Object.assign({},e.canvasSize),m={x:e.zoomingPositionX,y:e.zoomingPositionY}),(0,ae.jsx)(us.BI,{ref:t=>{e.setStageRef(t)},className:[Ks["image-element"],...t].join(" "),width:g.width,height:g.height,scaleX:e.zoomScale,scaleY:e.zoomScale,x:m.x,y:m.y,offsetX:e.stageTranslate.x,offsetY:e.stageTranslate.y,rotation:e.rotation,onClick:i,onMouseEnter:o,onMouseLeave:s,onDragMove:a,onMouseDown:r,onMouseMove:l,onMouseUp:c,onWheel:d,children:(0,ae.jsx)(Aa,{item:e,store:h,state:n,crosshairRef:u})})}),Ta=(0,b.PA)(({item:e})=>{const t=e.currentImageEntity,n=(0,f.useRef)(),[i,o]=(0,f.useState)(null);(0,f.useEffect)(()=>{if(null!=t&&t.downloaded&&t.currentSrc){const e=new window.Image;e.crossOrigin="anonymous",e.src=t.currentSrc,e.width=t.naturalWidth,e.height=t.naturalHeight,e.onload=()=>{o(e)}}else o(null)},[null==t?void 0:t.downloaded,null==t?void 0:t.currentSrc]);const{width:s,height:a}=(0,f.useMemo)(()=>({width:t.naturalWidth,height:t.naturalHeight}),[t.naturalWidth,t.naturalHeight,e.stageWidth,e.stageHeight]),r=Nt(t.brightnessGrade),l=t.contrastGrade-100;return(0,f.useEffect)(()=>{const e=n.current;var t;e&&i&&(e.cache({pixelRatio:1}),e.filters([bt.A.Filters.Brighten,bt.A.Filters.Contrast]),e.brightness(r),e.contrast(l),null==(t=e.getLayer())||t.batchDraw())},[i,r,l]),i?(0,ae.jsx)(us.Wd,{imageSmoothingEnabled:e.smoothingEnabled,scale:{x:e.stageZoom,y:e.stageZoom},children:(0,ae.jsx)(us._V,{ref:n,image:i,width:s,height:a,listening:!1})}):null}),_a=(0,b.PA)(({item:e,tool:t})=>{const[[n,i],o]=(0,f.useState)([0,0]),[s,a]=(0,f.useState)(!1);(0,f.useEffect)(()=>{if(!e.stageRef)return;const t=e.stageRef,n=e=>{const{x:n,y:i}=t.getPointerPosition(),{x:s,y:a}=t.position(),{x:r,y:l}=t.scale();o([(n-s)/r,(i-a)/l])},i=()=>{a(!0)},s=()=>{a(!1)};return t.on("mousemove",n),t.on("mouseenter",i),t.on("mouseleave",s),()=>{t.off("mousemove",n),t.off("mouseenter",i),t.off("mouseleave",s)}},[e.stageRef]);const r=(0,f.useMemo)(()=>t.strokeWidth*e.stageZoom,[t.strokeWidth,e.stageZoom]);return s?(0,ae.jsx)(us.Wd,{listening:!1,children:t.strokeWidth<=2?(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(us.rw,{x:n-r/2,y:i-r/2,width:r,height:r,stroke:"black",strokeWidth:3,strokeScaleEnabled:!1}),(0,ae.jsx)(us.rw,{x:n-r/2,y:i-r/2,width:r,height:r,stroke:"white",strokeWidth:1,strokeScaleEnabled:!1})]}):(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(us.jl,{x:n,y:i,radius:r,stroke:"black",strokeWidth:3,strokeScaleEnabled:!1}),(0,ae.jsx)(us.jl,{x:n,y:i,radius:r,stroke:"white",strokeWidth:1,strokeScaleEnabled:!1})]})}):null}),Aa=(0,b.PA)(({item:e,store:t,state:n,crosshairRef:i})=>{if(!(0,u._n)(e))return null;if(!t.task||!e.currentSrc)return null;const o=[...e.regs].sort(e=>e.highlighted||e.selected?1:-1),s=!!e.isMultiItem,a=[Ks.wrapperComponent,e.images.length>1?Ks.withGallery:Ks.wrapper],r=e.getToolsManager().findSelectedTool();s&&a.push(Ks.withPagination);const{brushRegions:l,shapeRegions:c,bitmaskRegions:d}=da(o),{brushRegions:h,shapeRegions:g,bitmaskRegions:m}=da(e.suggestions),p=Object.entries({brush:l,shape:c,bitmask:d,suggestedBrush:h,suggestedBismask:m,suggestedShape:g});return(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Ta,{item:e}),e.grid&&e.sizeUpdated&&(0,ae.jsx)(hs,{item:e}),(0,Ne.VS)(Ne.q$)?(0,ae.jsx)(wa,{item:e}):null,p.map(([t,n])=>{const i=null===t.match(/brush/i),o=null!==t.match("suggested");return n.length>0?(0,ae.jsx)(ga,{name:t,regions:n,useLayers:i,suggestion:o,smoothing:e.smoothingEnabled},t):(0,ae.jsx)(f.Fragment,{},t)}),(0,ae.jsx)(Ca,{item:e,isPanning:n.isPanning}),(0,ae.jsx)(ma,{item:e}),!1===e.smoothingEnabled&&(0,ae.jsx)(Pa,{item:e}),e.crosshair&&(0,ae.jsx)(ka,{ref:i,width:(0,Ne.VS)(Ne.pG)?e.containerWidth:e.stageWidth,height:(0,Ne.VS)(Ne.pG)?e.containerHeight:e.stageHeight}),r&&r.toolName.match(/bitmask/i)&&(0,ae.jsx)(_a,{item:e,tool:r})]})});var Ia=n(78438);const Ma=[4,4,0,0],Ea=({x:e,y:t,text:n,score:i,showLabels:o,rotation:s=0,zoomScale:a=1,color:r,maxWidth:l,onClickLabel:c,onMouseEnterLabel:d,onMouseLeaveLabel:u,adjacent:h=!1,isTexting:g=!1})=>{var m;const p=20,v=1/a,[y,b]=(0,f.useState)(),x=i?34:0,S=Math.max(0,l*a-25-x),C=!!S,{suggestion:k}=null!=(m=(0,f.useContext)(Gs))?m:{},P=(0,f.useMemo)(()=>{if(!o||!y||!l)return null;return(n?y.measureSize(n).width:0)>S?S:null},[y,n,l,v]),R=(0,f.useCallback)((e,t)=>{const n=h&&C?Ma:4,i=l?Math.min(t.width()+25,C?l*a:20):t.width()+25,o=t.height();if(e.beginPath(),n){let t=0,s=0,a=0,r=0;"number"==typeof n?t=s=a=r=Math.min(n,i/2,o/2):(t=Math.min(n[0],i/2,o/2),s=Math.min(n[1],i/2,o/2),r=Math.min(n[2],i/2,o/2),a=Math.min(n[3],i/2,o/2)),e.moveTo(t,0),e.lineTo(i-s,0),e.arc(i-s,s,s,3*Math.PI/2,0,!1),e.lineTo(i,o-r),e.arc(i-r,o-r,r,0,Math.PI/2,!1),e.lineTo(a,o),e.arc(a,o-a,a,Math.PI/2,Math.PI,!1),e.lineTo(0,t),e.arc(t,t,t,Math.PI,3*Math.PI/2,!1)}else e.rect(0,0,i,o);e.closePath(),e.fillStrokeShape(t)},[h,C,l]);return o?(0,ae.jsxs)(us.YJ,{strokeScaleEnabled:!1,x:e,y:t,rotation:s,children:[!!i&&(0,ae.jsxs)(us.JU,{y:-20*v,scaleX:v,scaleY:v,onClick:()=>!1,children:[(0,ae.jsx)(us.vw,{fill:en.Colors.getScaleGradient(i),cornerRadius:2}),(0,ae.jsx)(us.EY,{text:i.toFixed(2),fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif",fontSize:13,fill:"white",padding:0,lineHeight:1/13*p})]}),(0,ae.jsxs)(us.JU,{x:20*v+x*v,y:-20*v,scaleX:v,scaleY:v,onClick:c,onMouseEnter:c?d:null,onMouseLeave:c?u:null,listening:!k,children:[(0,ae.jsx)(us.vw,{fill:r,cornerRadius:4,sceneFunc:R,offsetX:20}),(0,ae.jsx)(us.EY,{ref:b,text:n,fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif",fontSize:13,lineHeight:1/13*p,height:p,width:P,wrap:"none",ellipsis:"true",fill:w.A.SHOW_LABEL_FILL,padding:0})]}),(0,ae.jsx)(us.wA,{x:2*v+x*v,y:2*v-p*v,scaleX:v,scaleY:v,fill:w.A.SHOW_LABEL_FILL,data:g?"M13,1v2H6C4.11,3,3.17,3,2.59,3.59C2,4.17,2,5.11,2,7v2c0,1.89,0,2.83,0.59,3.41C3.17,13,4.11,13,6,13h7v2h1V1H13z M6,9.5C5.17,9.5,4.5,8.83,4.5,8S5.17,6.5,6,6.5S7.5,7.17,7.5,8S6.83,9.5,6,9.5z M11,9.5c-0.83,0-1.5-0.67-1.5-1.5s0.67-1.5,1.5-1.5s1.5,0.67,1.5,1.5S11.83,9.5,11,9.5z":"M13.47,2.52c-0.27-0.27-0.71-0.27-1.59-0.27h-0.64c-1.51,0-2.26,0-2.95,0.29C7.61,2.82,7.07,3.35,6,4.43L3.65,6.78c-0.93,0.93-1.4,1.4-1.4,1.97c0,0.58,0.46,1.04,1.39,1.97l1.63,1.63c0.93,0.93,1.39,1.39,1.97,1.39s1.04-0.46,1.97-1.39L11.57,10c1.07-1.07,1.61-1.61,1.89-2.29c0.28-0.68,0.28-1.44,0.28-2.96V4.11C13.74,3.23,13.74,2.8,13.47,2.52z M10.5,6.9c-0.77,0-1.4-0.63-1.4-1.4s0.63-1.39,1.4-1.39s1.39,0.63,1.39,1.4S11.27,6.9,10.5,6.9z"})]}):null},Ka=(0,b.PA)(({item:e,color:t,strokewidth:n})=>{if(!e.parent)return null;const i=!!e.texting,o=e.getLabelText(","),s=e.parent,a=e.parent.zoomScale||1;return(0,ae.jsx)(Ea,{x:s.internalToCanvasX(e.x-e.radiusX)-n/2/a,y:s.internalToCanvasY(e.y-e.radiusY)-n/2/a,isTexting:i,text:o,score:e.score,showLabels:(0,u.Zn)(e).settings.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})}),Da=(0,b.PA)(({item:e,color:t,strokewidth:n})=>{if(!e.parent)return null;const i=!!e.texting,o=e.getLabelText(","),s=e.parent,a=e.parent.zoomScale||1;return(0,ae.jsx)(Ea,{x:s.internalToCanvasX(e.x)-n/2/a,y:s.internalToCanvasY(e.y)-n/2/a,isTexting:i,text:o,score:e.score,showLabels:(0,u.Zn)(e).settings.showLabels,zoomScale:e.parent.zoomScale,rotation:e.rotation,color:t,maxWidth:s.internalToCanvasX(e.width)+n,adjacent:!0,onClickLabel:e.onClickLabel})}),Oa=(0,b.PA)(({item:e,color:t})=>{var n;if(!e.parent)return null;const i=!!e.texting,o=e.getLabelText(","),s=e.bboxCoordsCanvas;if(!s)return null;const a=(0,u.Zn)(e).settings;return(0,ae.jsxs)(f.Fragment,{children:[a.showLabels&&(0,ae.jsx)(us.rw,{x:s.left,y:s.top,fillEnabled:!1,width:s.right-s.left,height:s.bottom-s.top,stroke:null==(n=e.style)?void 0:n.strokecolor,strokeWidth:1,strokeScaleEnabled:!1,shadowBlur:0}),(0,ae.jsx)(Ea,{x:s.left,y:s.top+2/e.parent.zoomScale,isTexting:i,text:o,score:e.score,showLabels:a.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})]})}),La=(0,b.PA)(({item:e,color:t})=>{var n;if(!e.parent)return null;const i=(0,u.Zn)(e).settings;if(!i.showLabels)return null;const o=!!e.texting,s=e.getLabelText(","),a=e.bboxCoordsCanvas;return a?(0,ae.jsxs)(us.YJ,{name:"region-label",children:[(0,ae.jsx)(us.rw,{x:a.left,y:a.top,fillEnabled:!1,width:a.right-a.left,height:a.bottom-a.top,stroke:null==(n=e.style)?void 0:n.strokecolor,strokeWidth:1,strokeScaleEnabled:!1,shadowBlur:0}),(0,ae.jsx)(Ea,{x:a.left,y:a.top+2/e.parent.zoomScale,isTexting:o,text:s,score:e.score,showLabels:i.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})]}):null}),za=(0,b.PA)(({item:e,color:t})=>{if(!e.parent)return null;const n=!!e.texting,i=e.getLabelText(",");return(0,ae.jsx)(Ea,{x:e.canvasX+(e.canvasWidth+2)/e.parent.zoomScale,y:e.canvasY+(e.canvasWidth+2)/e.parent.zoomScale,isTexting:n,text:i,score:e.score,showLabels:(0,u.Zn)(e).settings.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})}),Ba=(0,b.PA)(({reg:e,box:t,color:n,scale:i,strokeWidth:o,adjacent:s=!1})=>{const a=!!e.texting,r=e.getLabelText(",");return(0,ae.jsx)(Ea,{x:t.x,y:t.y,rotation:t.rotation,isTexting:a,text:r,score:e.score,showLabels:e.store.settings.showLabels,zoomScale:i,color:n,maxWidth:t.width+o,adjacent:s,onClickLabel:e.onClickRegion})}),Fa=((0,b.PA)(({region:e,color:t,strokeWidth:n=1,viewRect:i,pageRotationDeg:o=0,zoomScale:s=1})=>{var a,r;if(null==e||!e.store)return null;const l=e.getLabelText(",")||(null==e?void 0:e.ocrtext)||(null==e?void 0:e.noLabelView)||"",c=null==(a=e.store.settings)?void 0:a.showLabels,d=Boolean(e.texting||e.ocrtext),u=(((null!=(r=e.rotation)?r:0)+(null!=o?o:0))%360+360)%360,h="number"==typeof n?n:0,g=null!=i?i:{x:0,y:0,width:0,height:0},m=Math.max(1,g.width);return(0,ae.jsx)(Ea,{x:g.x-h/2/s,y:g.y-h/2/s,isTexting:d,text:l,score:e.score,showLabels:c,zoomScale:s,rotation:u,color:t,maxWidth:m+h,adjacent:!0,onClickLabel:e.onClickRegion})}),u.gK.model({}).views(e=>({get bboxCoords(){return console.warn("KonvaRegionMixin needs to implement bboxCoords getter in regions"),null},get bboxCoordsCanvas(){const t=e.bboxCoords;return e.parent?{left:e.parent.internalToCanvasX(t.left),top:e.parent.internalToCanvasY(t.top),right:e.parent.internalToCanvasX(t.right),bottom:e.parent.internalToCanvasY(t.bottom)}:null},get inViewPort(){return!(0,Ne.VS)(Ne.pG)||!!e&&!!e.bboxCoordsCanvas&&!!e.object&&e.bboxCoordsCanvas.right>=e.object.viewPortBBoxCoords.left&&e.bboxCoordsCanvas.bottom>=e.object.viewPortBBoxCoords.top&&e.bboxCoordsCanvas.left<=e.object.viewPortBBoxCoords.right&&e.bboxCoordsCanvas.top<=e.object.viewPortBBoxCoords.bottom},get control(){var t;return null==(t=e.results.find(e=>e.from_name.tools))?void 0:t.from_name},get canRotate(){var t;return(null==(t=e.control)?void 0:t.canrotate)&&e.supportsRotate},get supportsTransform(){return!e.isReadOnly()&&(this._supportsTransform&&!this.hidden)}})).actions(e=>{const t={deleteRegion:e.deleteRegion};return{updateCursor(t=!1){var n,i;const o=null==(n=e.parent)?void 0:n.stageRef;if(!o)return;const s=o.container().style;if(t)return void(e.annotation.isLinkingMode?s.cursor=w.A.LINKING_MODE_CURSOR:"brushregion"!==e.type&&(s.cursor=w.A.POINTER_CURSOR));const a=null==(i=e.parent)?void 0:i.getToolsManager().findSelectedTool();a&&a.updateCursor?a.updateCursor():s.cursor=w.A.DEFAULT_CURSOR},checkSizes(){const{naturalWidth:t,naturalHeight:n,stageWidth:i,stageHeight:o}=e.parent;i>1&&o>1&&(null==e.updateImageSize||e.updateImageSize(i/t,o/n,i,o))},selectRegion(){e.scrollToRegion()},scrollToRegion(){var t;const n=e.object.zoomScale>1,i=null==(t=e.shapeRef)||null==(t=t.parent)||null==(t=t.canvas)?void 0:t._canvas;let o=i;for(;o&&!o.scrollTop&&!o.className.includes("main-content");)o=o.parentElement;if(!o)return;const s=o.getBoundingClientRect(),a=i.getBoundingClientRect(),r=n?{top:0,bottom:a.height}:e.bboxCoordsCanvas,l=r.bottom-r.top,c=r.top-(s.top-a.top),d=i.clientHeight-r.bottom-(a.bottom-s.bottom)-36,u=n&&i.clientHeight>o.clientHeight;if(!(c<0&&d<0))if(c<0&&-c/l>.4){if(n&&(a.bottom-s.top)/o.clientHeight>.4)return;o.scrollBy({top:u?-d:c,left:0,behavior:"smooth"})}else if(d<0&&-d/l>.4){if(n&&(s.bottom-a.top)/o.clientHeight>.4)return;o.scrollBy({top:u?c:-d,left:0,behavior:"smooth"})}},onClickRegion(t){const n=e.annotation,i=(null==t?void 0:t.evt)||t,o=(null==i?void 0:i.ctrlKey)||(null==i?void 0:i.metaKey);t&&(t.cancelBubble=!0);if(2===i.detail)return void e.onDoubleClickRegion();!n.isReadOnly()&&n.isLinkingMode?(n.addLinkedRegion(e),n.stopLinkingMode(),n.regionStore.unselectAll()):e._selectArea(o)},onDoubleClickRegion(){e.requestPerRegionFocus(),e.annotation.selectAreas([e])},deleteRegion(){var n;const i=null==(n=e.parent)?void 0:n.getToolsManager().findSelectedTool();null==i||null==i.enable||i.enable(),t.deleteRegion()}}}));var Ha=n(80622);const Va=["item"],$a=(e,t)=>{const n=(0,b.PA)(e);return(0,b.PA)(e=>{let{item:i}=e,o=(0,Se.A)(e,Va);const s=(null==t?void 0:t.renderHidden)||!i.hidden,a=null==t?void 0:t.shouldNotUsePortal,r=a?f.Fragment:Ha.ZL,l=a?{}:{selector:".selection-regions-layer",enabled:i.inSelection},c=!!i.annotation,d=(0,f.useCallback)(e=>{(0,u._n)(i)&&i.setShapeRef(e)},[i]);return c&&(0,u._n)(i)&&s?(0,ae.jsx)(r,Object.assign({},l,{children:(0,ae.jsx)(n,Object.assign({item:i},o,{setShapeRef:d}))})):null})},Wa=(0,b.PA)(({item:e,useLayer:t})=>{const n=(e=>{const{shapeRef:t,bboxCoordsCanvas:n}=e;let i,o,s,a;if((0,E.isDefined)(n))[i,o,s,a]=[n.right-n.left,n.bottom-n.top,n.left,n.top];else{if(!(0,E.isDefined)(t))return null;var r,l;[i,o]=[null!=(r=null==t?void 0:t.width())?r:0,null!=(l=null==t?void 0:t.height())?l:0],[s,a]=[e.x+i/2-32,e.x+i/2-32]}return{x:s+i/2-32,y:a+o+10}})(e),[i,o]=(0,f.useState)(!1),s=1/e.parent.zoomScale;if(n){const a={width:64,height:32},r=t?{x:0,y:0,scaleX:1,scaleY:1}:{x:n.x,y:n.y,scaleX:s,scaleY:s},l=t?{x:n.x,y:n.y,scaleX:s,scaleY:s}:{},c=(0,ae.jsxs)(us.YJ,Object.assign({},a,r,{opacity:e.highlighted||i?1:.5,onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1),children:[(0,ae.jsx)(us.rw,{x:0,y:0,width:64,height:32,fill:"#000",cornerRadius:16}),(0,ae.jsx)(Ua,{onClick:()=>e.annotation.rejectSuggestion(e.id),fill:"#DD0000",iconColor:"#fff",icon:kn.kLH}),(0,ae.jsx)(Ua,{x:32,onClick:()=>e.annotation.acceptSuggestion(e.id),fill:"#98C84E",iconColor:"#fff",icon:kn.iWP})]}));return t?(0,ae.jsx)(us.Wd,Object.assign({},a,l,{children:c})):c}return null}),Ua=({x:e=0,fill:t,iconColor:n,onClick:i,icon:o})=>{const[s,a]=(0,f.useState)(new window.Image),r=(0,ft.A)(null!=n?n:"#fff"),[l,c]=(0,f.useState)(!1);(0,f.useEffect)(()=>{const e=new window.Image;e.onload=()=>{a(e)},e.width=12,e.height=12,e.src=o},[o]);const d=(0,f.useCallback)(e=>{if(e){const[t,n,i,o]=r.rgba();e.cache(),e.setAttrs({red:t,green:n,blue:i,alpha:o})}},[]);return(0,ae.jsxs)(us.YJ,{x:e,width:32,height:32,onClick:i,onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1),children:[(0,ae.jsx)(us.jl,{x:16,y:16,radius:14,opacity:l?1:.2,fill:l?t:"#fff"}),(0,ae.jsx)(us._V,{ref:e=>d(e),x:8,y:8,width:16,height:16,image:s,filters:[bt.A.Filters.RGB]})]})},Ga=(0,b.PA)(({item:e,children:t})=>{var n;const{suggestion:i}=null!=(n=(0,f.useContext)(Gs))?n:{};return(0,ae.jsxs)(f.Fragment,{children:[t,i&&(0,ae.jsx)(Wa,{item:e,useLayer:"brushregion"===e.type})]})}),Ya={shadowColor:"red",shadowBlur:1,shadowOffsetY:2,shadowOffsetX:2,shadowOpacity:1},Xa=u.gK.model("Points",{id:u.gK.optional(u.gK.identifier,I),type:u.gK.optional(u.gK.enumeration(["add","eraser"]),"add"),points:u.gK.array(u.gK.number),relativePoints:u.gK.array(u.gK.number),strokeWidth:u.gK.optional(u.gK.number,25),relativeStrokeWidth:u.gK.optional(u.gK.number,25),eraserSize:u.gK.optional(u.gK.number,25)}).views(e=>({get store(){return(0,u.Zn)(e)},get parent(){return(0,u.p7)(e,2)?(0,u.PA)(e,2):null},get stage(){var t;return null==(t=e.parent)?void 0:t.parent},get compositeOperation(){return"add"===e.type?"source-over":"destination-out"}})).actions(e=>({updateImageSize(t,n,i,o){e.points=e.relativePoints.map((e,t)=>e*(!(t%2)?i:o)/100),e.strokeWidth=e.relativeStrokeWidth*i/100},setType(t){e.type=t},addPoint(t,n){t/=e.parent.scaleX,n/=e.parent.scaleY,e.points.push(t),e.points.push(n)},setPoints(t){e.points=t.map((t,n)=>t/(n%2==0?e.parent.scaleX:e.parent.scaleY)),e.relativePoints=t.map((t,n)=>t/(n%2==0?e.stage.stageWidth:e.stage.stageHeight)*100),e.relativeStrokeWidth=e.strokeWidth/e.stage.stageWidth*100},rescale(t,n,i){const o=i/t;return e.points.map(e=>e*o)},scaledStrokeWidth:(t,n,i)=>i/t*e.strokeWidth})),qa=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"brushregion",object:u.gK.late(()=>u.gK.reference(_d)),coordstype:u.gK.optional(u.gK.enumeration(["px","perc"]),"perc"),rle:u.gK.frozen(),maskDataURL:u.gK.frozen(),touches:u.gK.array(Xa),currentTouch:u.gK.maybeNull(u.gK.reference(Xa))}).volatile(()=>({tension:0,opacity:.6,scaleX:1,scaleY:1,mode:"brush",needsUpdate:1,hideable:!0,layerRef:void 0,imageData:null})).views(e=>({get parent(){return(0,u._n)(e)?e.object:null},get colorParts(){const t=e.style||e.tag||w.l;return(0,pt.colorToRGBAArray)(t.strokecolor)},get strokeColor(){return(0,pt.rgbArrayToHex)(e.colorParts)},get touchesLength(){return e.touches.length},get bboxCoordsCanvas(){if(!e.imageData){const r={x:[],y:[]};for(let l=0;l in(null!=(t=null==(n=e.touches)||null==(n=n[0])?void 0:n.points)?t:[]);l+=2){var t,n,i,o,s,a;const c=(null!=(i=null==(o=e.touches)||null==(o=o[0])?void 0:o.points)?i:[])[l],d=(null!=(s=null==(a=e.touches)||null==(a=a[0])?void 0:a.points)?s:[])[l+1];r.x.push(c),r.y.push(d)}return{left:Math.min(...r.x),top:Math.min(...r.y),right:Math.max(...r.x),bottom:Math.max(...r.y)}}const r=K.getImageDataBBox(e.imageData.data,e.imageData.width,e.imageData.height);if(!r)return null;const{stageScale:l=1,zoomingPositionX:c=0,zoomingPositionY:d=0}=e.parent||{};return r.x=r.x/l-c/l,r.y=r.y/l-d/l,r.width=r.width/l,r.height=r.height/l,{left:r.x,top:r.y,right:r.x+r.width,bottom:r.y+r.height}},get bboxCoords(){const t=e.bboxCoordsCanvas;return t?{left:e.parent.canvasToInternalX(t.left),top:e.parent.canvasToInternalY(t.top),right:e.parent.canvasToInternalX(t.right),bottom:e.parent.canvasToInternalY(t.bottom)}:null}})).actions(e=>{let t,n,i,o=-1,s=-1;return{afterCreate(){e.updateMaskImage()},updateMaskImage(){e.maskDataURL&&(i||(i=new window.Image),i.src=e.maskDataURL)},getMaskImage:()=>i,setLayerRef(t){t&&(t.canvas._canvas.style.opacity=e.opacity,e.layerRef=t)},cacheImageData(){if(e.layerRef){const t=e.layerRef.toCanvas().getContext("2d");e.imageData=t.getImageData(0,0,e.layerRef.canvas.width,e.layerRef.canvas.height)}else e.imageData=null},prepareCoords:([t,n])=>e.parent.zoomOriginalCoords([t,n]),preDraw(i,a){if(!e.layerRef)return;const r=e.layerRef.canvas.context;if(r.save(),(0,Ne.VS)(Ne.pG)&&(r.beginPath(),r.rect(e.parent.alignmentOffset.x,e.parent.alignmentOffset.y,e.parent.stageWidth*e.parent.stageScale,e.parent.stageHeight*e.parent.stageScale),r.clip()),r.beginPath(),n.length/2>3)r.moveTo(...e.prepareCoords([o,s]));else if(0===n.length)r.moveTo(...e.prepareCoords([i,a]));else{r.moveTo(...e.prepareCoords([n[0],n[1]]));for(let t=0;t<n.length/2;t++)r.lineTo(...e.prepareCoords([n[2*t],n[2*t+1]]))}r.lineTo(...e.prepareCoords([i,a])),r.lineCap="round",r.lineJoin="round",r.lineWidth=t.strokeWidth*e.scaleX*e.parent.stageScale,r.strokeStyle=e.strokeColor,r.globalCompositeOperation=t.compositeOperation,r.stroke(),r.restore(),o=i,s=a},beginPath:({type:i,strokeWidth:o,opacity:s=e.opacity})=>(e.object.annotation.pauseAutosave(),t=Xa.create({id:I(),type:i,strokeWidth:o,opacity:s}),n=[],t),addPoint(t,i){e.preDraw(t,i),n.push(t),n.push(i)},endPath(){const{annotation:i}=e.object;i.startAutosave(),2===n.length&&(n.push(n[0]),n.push(n[1])),e.touches.push(t),e.currentTouch=t,t.setPoints(n),o=s=-1,t=null,n=[],e.notifyDrawingFinished(),i.autosave&&setTimeout(()=>i.autosave())},endUpdatedMaskDataURL(t){const{annotation:n}=e.object;n.startAutosave(),e.maskDataURL=t,e.updateMaskImage(),e.notifyDrawingFinished(),n.autosave&&setTimeout(()=>n.autosave())},convertPointsToMask(){},setScale(t,n){e.scaleX=t,e.scaleY=n},updateImageSize(t,n,i,o){e.parent.stageWidth>1&&e.parent.stageHeight>1&&(e.touches.forEach(e=>e.updateImageSize(t,n,i,o)),e.needsUpdate=e.needsUpdate+1)},addState(t){e.states.push(t)},convertToImage(){if(e.touches.length){const t=e.object,n=Ia.A.Region2RLE(e,t,{color:e.strokeColor});e.touches=[],e.rle=Array.from(n)}},serialize(t){const n=e.object,i={format:"rle"};if(null!=t&&t.fast)i.rle=e.rle,e.touches.length&&(i.touches=e.touches),e.maskDataURL&&(i.maskDataURL=e.maskDataURL);else{const t=Ia.A.Region2RLE(e,n);if(!t||!t.length)return null;i.rle=Array.from(t)}return e.parent.createSerializedResult(e,i)}}}),Za=u.gK.compose("BrushRegionModel",Ze,Ge,mt,Fa,Ae,qa),Ja=(0,b.PA)(({item:e,setShapeRef:t,pointsList:n})=>{const i=(0,f.useCallback)((e,{points:t,strokeWidth:n,strokeColor:i,compositeOperation:o})=>{e.save(),e.beginPath(),e.moveTo(t[0],t[1]);for(let n=0;n<t.length/2;n++)e.lineTo(t[2*n],t[2*n+1]);e.lineCap="round",e.lineJoin="round",e.lineWidth=n,e.strokeStyle=i,e.globalCompositeOperation=o,e.stroke(),e.restore()}),o=(0,f.useCallback)(t=>{n.forEach(n=>{i(t,{points:n.points,strokeWidth:n.strokeWidth,strokeColor:e.strokeColor,compositeOperation:n.compositeOperation})})},[n,n.length,e.strokeColor]),s=(0,f.useCallback)((e,t)=>{n.forEach(n=>{i(e,{points:n.points,strokeWidth:n.strokeWidth,strokeColor:"eraser"===n.type?"#ffffff":t.colorKey,compositeOperation:"source-over"})})},[n,n.length]);return(0,ae.jsx)(us.yp,{ref:e=>t(e),sceneFunc:o,hitFunc:s})}),Qa=$a(({item:e,setShapeRef:t})=>{var n,i,o,s,a,r,l,c,d,h,g,m;const[p,v]=(0,f.useState)(),{suggestion:y}=null!=(n=(0,f.useContext)(Gs))?n:{};(0,f.useEffect)(()=>{(async()=>{if(!e.rle&&!e.maskDataURL)return;if(!e.parent||e.parent.naturalWidth<=1||e.parent.naturalHeight<=1)return;let t;e.maskDataURL?t=await Ia.A.maskDataURL2Image(e.maskDataURL,{color:e.strokeColor}):e.rle&&(t=Ia.A.RLE2Region(e,{color:e.strokeColor})),t&&(t.onload=()=>{v(t),e.setReady(!0)})})()},[e.rle,e.maskDataURL,e.maskBoundsMinX,e.maskBoundsMinY,e.maskBoundsMaxX,e.maskBoundsMaxY,e.parent,null==(i=e.parent)?void 0:i.naturalWidth,null==(o=e.parent)?void 0:o.naturalHeight,e.strokeColor,e.opacity]);const b=(0,f.useMemo)(()=>{let t;return(n,i)=>{if(p){if(!t){n.drawImage(p,0,0,e.parent.stageWidth,e.parent.stageHeight),t=(0,Ne.VS)(Ne.pG)?n.getImageData(e.parent.alignmentOffset.x,e.parent.alignmentOffset.y,e.parent.stageWidth,e.parent.stageHeight):n.getImageData(0,0,e.parent.stageWidth,e.parent.stageHeight);const o=(0,pt.colorToRGBAArray)(i.colorKey);for(let e=t.data.length/4-1;e>=0;e--)if(t.data[4*e+3]>0)for(let n=0;n<3;n++)t.data[4*e+n]=o[n]}n.putImageData(t,0,0)}}},[p,null==(s=e.parent)?void 0:s.stageWidth,null==(a=e.parent)?void 0:a.stageHeight]),{store:x}=e,w=(0,f.useRef)(new window.Image),S=(0,f.useRef)(),C=(0,f.useRef)({});C.current.highlighted=e.highlighted,C.current.highlight=C.current.highlighted?Ya:{shadowOpacity:0};const k=(0,f.useMemo)(()=>{let t=!1;return async()=>{var n;const{highlighted:i}=C.current,o=S.current;if((null==(n=e.parent)?void 0:n.drawingRegion)===e||!o||t)return;let s;i&&(s=o.findOne(".highlight"),s.hide()),o.draw();const a=o.canvas.toDataURL();e.cacheImageData(),i&&(s.show(),o.draw()),w.current.src=a,t=!0}},[e.touches.length,e.strokeColor,null==(r=e.parent)?void 0:r.stageScale,null==(l=x.annotationStore.selected)?void 0:l.id,null==(c=e.parent)?void 0:c.zoomingPositionX,null==(d=e.parent)?void 0:d.zoomingPositionY,null==(h=e.parent)?void 0:h.stageWidth,null==(g=e.parent)?void 0:g.stageHeight,e.maskDataURL,e.rle,p]),P=(0,f.useCallback)(t=>{(0,u._n)(e)&&e.setLayerRef(t)},[e]);if(!e.parent)return null;const R=null==(m=e.parent)?void 0:m.stageRef,j=(0,Ne.VS)(Ne.pG)?{scaleX:1/e.parent.zoomScale,scaleY:1/e.parent.zoomScale,x:-(e.parent.zoomingPositionX+e.parent.alignmentOffset.x)/e.parent.zoomScale,y:-(e.parent.zoomingPositionY+e.parent.alignmentOffset.y)/e.parent.zoomScale,width:e.containerWidth,height:e.containerHeight}:{scaleX:1/e.parent.stageScale,scaleY:1/e.parent.stageScale,x:-e.parent.zoomingPositionX/e.parent.stageScale,y:-e.parent.zoomingPositionY/e.parent.stageScale,width:e.parent.canvasSize.width,height:e.parent.canvasSize.height},N=(0,Ne.VS)(Ne.pG)?{x:0,y:0,width:e.parent.stageWidth,height:e.parent.stageHeight}:null;return(0,ae.jsxs)(Ga,{item:e,children:[(0,ae.jsx)(us.Wd,{id:e.cleanId,ref:e=>{P(e),S.current=e},onDraw:()=>{setTimeout(k)},clearBeforeDraw:!e.isDrawing,visible:!e.hidden,clip:N,children:(0,ae.jsxs)(us.YJ,{attrMy:e.needsUpdate,name:"segmentation",onMouseDown:e=>{x.annotationStore.selected.isLinkingMode&&(e.cancelBubble=!0)},onMouseOver:()=>{x.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{x.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{if(!e.parent.getSkipInteractions())if(x.annotationStore.selected.isLinkingMode)e.onClickRegion(t);else{if(!(0,Ne.VS)(Ne.pG)){const t=e.parent.getToolsManager().findSelectedTool(),n=t&&"MoveTool"===(0,u.Pw)(t).name;if(t&&!n)return}x.annotationStore.selected.isLinkingMode&&(R.container().style.cursor="default"),e.setHighlight(!1),e.onClickRegion(t)}},listening:!y,children:[(0,ae.jsx)(us._V,{image:p,hitFunc:b,width:e.parent.stageWidth,height:e.parent.stageHeight}),(0,ae.jsx)(us.YJ,{children:(0,ae.jsx)(Ja,{store:x,item:e,pointsList:e.touches,setShapeRef:t})}),(0,ae.jsx)(us._V,Object.assign({name:"highlight",image:w.current,sceneFunc:C.current.highlighted?null:()=>{},hitFunc:()=>{}},C.current.highlight,j,{listening:!1}))]})}),(0,ae.jsx)(us.Wd,{id:`${e.cleanId}_labels`,ref:t=>{t&&(t.canvas._canvas.style.opacity=e.opacity)},children:(0,ae.jsx)(us.YJ,{children:(0,ae.jsx)(La,{item:e,color:e.strokeColor})})})]})},{renderHidden:!0,shouldNotUsePortal:!0});we.addTag("brushregion",Za,Qa),we.addRegionType(Za,"image",e=>e.rle||e.touches||e.maskDataURL);const er={defaultOpacity:w.l.opacity,defaultFillColor:w.l.fillcolor,defaultStrokeColor:w.l.strokecolor,defaultStrokeColorHighlighted:w.A.HIGHLIGHTED_STROKE_COLOR,defaultStrokeWidth:w.l.strokewidth,defaultStrokeWidthHighlighted:w.A.HIGHLIGHTED_STROKE_WIDTH,defaultSuggestionWidth:w.A.SUGGESTION_STROKE_WIDTH},tr=(e,t={})=>{var n,i;const{suggestion:o}=null!=(n=(0,f.useContext)(Gs))?n:{},[s,a]=(0,f.useState)(e.highlighted),[r,l]=(0,f.useState)(null!=(i=e.fill)?i:t.useStrokeAsFill||t.includeFill),c=(0,f.useMemo)(()=>(({region:e,highlighted:t=!1,shouldFill:n=!1,useStrokeAsFill:i=!1,sameStrokeWidthForSelected:o=!1,suggestion:s=!1,defaultOpacity:a=w.l.opacity,defaultFillColor:r=w.l.fillcolor,defaultStrokeColor:l=w.l.strokecolor,defaultStrokeColorHighlighted:c=w.A.HIGHLIGHTED_STROKE_COLOR,defaultStrokeWidth:d=w.l.strokewidth,defaultStrokeWidthHighlighted:u=w.A.HIGHLIGHTED_STROKE_WIDTH,defaultSuggestionWidth:h=w.A.SUGGESTION_STROKE_WIDTH})=>{var g,m,p;const f=e.style||e.tag,v=e.inSelection||t,y=null==f?void 0:f.fillopacity,b=(0,E.isDefined)(y)?y:null==f?void 0:f.opacity,x=n?(0,ft.A)(null!=(g=i?null==f?void 0:f.strokecolor:null==f?void 0:f.fillcolor)?g:r).darken(.3).alpha(+(null!=(m=null!=b?b:a)?m:.5)).css():null;var S;return{strokeColor:v?c:(0,ft.A)(null!=(p=null==f?void 0:f.strokecolor)?p:l).css(),fillColor:x,strokeWidth:s?h:v&&!o?u:+(null!=(S=null==f?void 0:f.strokewidth)?S:d)}})(Object.assign({},er,null!=t?t:{},{highlighted:s,shouldFill:r,region:e,suggestion:o})),[e,o,t,s,r]);return(0,f.useEffect)(()=>{const t=["highlighted","fill"].map(t=>{try{return(0,d.lB)(e,t,({newValue:e})=>{switch(t){case"highlighted":return a(e);case"fill":return l(e)}},!0)}catch(e){return()=>{}}});return()=>{t.forEach(e=>e())}},[e]),c};function nr(e,t,n={x:e.left,y:e.top},i=1){if(!e)return e;const o=t*Math.PI/180,s=Math.cos(o),a=Math.sin(o),r=[{x:e.left-n.x,y:e.top-n.y},{x:e.right-n.x,y:e.top-n.y},{x:e.left-n.x,y:e.bottom-n.y},{x:e.right-n.x,y:e.bottom-n.y}].map(e=>({x:e.x*s-e.y*a/i,y:e.x*a*i+e.y*s})),[l,c]=(0,E.minMax)(r.map(e=>e.x)),[d,u]=(0,E.minMax)(r.map(e=>e.y));return{left:l+n.x,right:c+n.x,top:d+n.y,bottom:u+n.y}}const ir=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"ellipseregion",object:u.gK.late(()=>u.gK.reference(_d)),x:u.gK.number,y:u.gK.number,radiusX:u.gK.number,radiusY:u.gK.number,rotation:0}).volatile(()=>({startX:0,startY:0,scaleX:1,scaleY:1,opacity:u.gK.number,fill:!0,fillColor:w.A.FILL_COLOR,fillOpacity:.2,strokeColor:w.A.STROKE_COLOR,strokeWidth:w.A.STROKE_WIDTH,_supportsTransform:!0,hideable:!0,editableFields:[{property:"x",label:"X"},{property:"y",label:"Y"},{property:"radiusX",label:"Rx"},{property:"radiusY",label:"Ry"},{property:"rotation",label:"icon:angle"}]})).volatile(()=>({useTransformer:!0,preferTransformer:!0,supportsRotate:!0,supportsScale:!0})).views(e=>({get store(){return(0,u.Zn)(e)},get bboxCoords(){const t={left:e.x-e.radiusX,top:e.y-e.radiusY,right:e.x+e.radiusX,bottom:e.y+e.radiusY};return 0===e.rotation?t:nr(t,e.rotation,{x:e.x,y:e.y},e.parent.whRatio)},get canvasX(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasX(e.x)},get canvasY(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasY(e.y)},get canvasRadiusX(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasX(e.radiusX)},get canvasRadiusY(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasY(e.radiusY)}})).actions(e=>({afterCreate(){e.startX=e.x,e.startY=e.y},coordsInside(t,n){const i=e.radiusX,o=e.radiusY;let s=t-e.x,a=n-e.y;const r=e.rotation;return s=s*Math.cos(Math.unit(r,"deg"))-a*Math.sin(Math.unit(r,"deg")),a=s*Math.sin(Math.unit(r,"deg"))+a*Math.cos(Math.unit(r,"deg")),Math.abs(s)<i&&(a**2<o**2*(1-s**2/i**2)||void 0)},setPositionInternal(t,n,i,o,s){e.x=t,e.y=n,e.radiusX=i,e.radiusY=o,e.rotation=(s+360)%360},setPosition(t,n,i,o,s){e.setPositionInternal(e.parent.canvasToInternalX(t),e.parent.canvasToInternalY(n),e.parent.canvasToInternalX(i),e.parent.canvasToInternalY(o),s)},setScale(t,n){e.scaleX=t,e.scaleY=n},setFill(t){e.fill=t},updateImageSize(){},serialize(){const t={x:e.x,y:e.y,radiusX:e.radiusX,radiusY:e.radiusY,rotation:e.rotation};return e.parent.createSerializedResult(e,t)}})),or=u.gK.compose("EllipseRegionModel",Ze,mt,Ge,Fa,nn,ir),sr=$a(({item:e,setShapeRef:t})=>{var n,i;const{store:o}=e,s=tr(e),a=null==(n=e.parent)?void 0:n.stageRef,{suggestion:r}=null!=(i=(0,f.useContext)(Gs))?i:{};return e.parent&&e.inViewPort?(0,ae.jsxs)(f.Fragment,{children:[(0,ae.jsx)(us.Pp,{x:e.canvasX,y:e.canvasY,ref:e=>t(e),radiusX:e.canvasRadiusX,radiusY:e.canvasRadiusY,fill:s.fillColor,stroke:s.strokeColor,strokeWidth:s.strokeWidth,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,shadowBlur:0,scaleX:e.scaleX,scaleY:e.scaleY,opacity:1,rotation:e.rotation,name:`${e.id} _transformable`,onTransform:({target:e})=>{e.setAttr("skewX",0),e.setAttr("skewY",0)},onTransformEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y"),n.getAttr("radiusX")*n.getAttr("scaleX"),n.getAttr("radiusY")*n.getAttr("scaleY"),n.getAttr("rotation")),n.setAttr("scaleX",1),n.setAttr("scaleY",1),e.notifyDrawingFinished()},onDragStart:t=>{e.parent.getSkipInteractions()?t.currentTarget.stopDrag(t.evt):e.annotation.history.freeze(e.id)},onDragEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y"),n.getAttr("radiusX"),n.getAttr("radiusY"),n.getAttr("rotation")),e.setScale(n.getAttr("scaleX"),n.getAttr("scaleY")),e.annotation.history.unfreeze(e.id),e.notifyDrawingFinished()},dragBoundFunc:Pt(e,{x:e.x-e.bboxCoords.left,y:e.y-e.bboxCoords.top}),onMouseOver:()=>{o.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{o.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||(o.annotationStore.selected.isLinkingMode&&(a.container().style.cursor=w.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t))},draggable:!e.isReadOnly(),listening:!r}),(0,ae.jsx)(Ka,{item:e,color:s.strokeColor,strokewidth:s.strokeWidth})]}):null});we.addTag("ellipseregion",or,sr),we.addRegionType(or,"image");const ar=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"keypointregion",object:u.gK.late(()=>u.gK.reference(_d)),x:u.gK.number,y:u.gK.number,width:u.gK.number,negative:!1}).volatile(()=>({hideable:!0,_supportsTransform:!0,useTransformer:!1,supportsRotate:!1,supportsScale:!1,editableFields:[{property:"x",label:"X"},{property:"y",label:"Y"}]})).views(e=>({get store(){return(0,u.Zn)(e)},get bboxCoords(){return{left:e.x-e.width,top:e.y-e.width,right:e.x+e.width,bottom:e.y+e.width}},get canvasX(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasX(e.x)},get canvasY(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasY(e.y)},get canvasWidth(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasX(e.width)}})).actions(e=>({setPosition(t,n){var i;const o=null==(i=e.control)?void 0:i.getSnappedPoint({x:e.parent.canvasToInternalX(t),y:e.parent.canvasToInternalY(n)});e.x=o.x,e.y=o.y},updateImageSize(){},serialize(){const t={x:e.x,y:e.y,width:e.width},n=e.parent.createSerializedResult(e,t);return e.dynamic&&(n.is_positive=!e.negative,n.value.labels=e.labels),n}})),rr=u.gK.compose("KeyPointRegionModel",Ze,mt,Ge,Fa,nn,ar),lr=$a(({item:e,setShapeRef:t})=>{var n,i,o,s;const{store:a}=e,{suggestion:r}=null!=(n=(0,f.useContext)(Gs))?n:{},l=tr(e,{includeFill:!0,defaultFillColor:"#000",defaultStrokeColor:"#fff",defaultOpacity:(null!=(i=e.style)?i:e.tag)?.6:1,sameStrokeWidthForSelected:!0}),c={opacity:1,fill:l.fillColor,stroke:l.strokeColor,strokeWidth:Math.max(1,l.strokeWidth),strokeScaleEnabled:!1,shadowBlur:0},d=null==(o=e.parent)?void 0:o.stageRef;return e.parent&&e.inViewPort?(0,ae.jsxs)(f.Fragment,{children:[(0,ae.jsx)(us.jl,Object.assign({x:e.canvasX,y:e.canvasY,ref:e=>t(e),radius:Math.max(e.canvasWidth,2)/(null==(s=e.parent)?void 0:s.zoomScale),perfectDrawEnabled:!1,name:`${e.id} _transformable`,onDragStart:t=>{e.parent.getSkipInteractions()?t.currentTarget.stopDrag(t.evt):e.annotation.history.freeze(e.id)},onDragEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y")),n.setAttr("x",e.canvasX),n.setAttr("y",e.canvasY),e.annotation.history.unfreeze(e.id),e.notifyDrawingFinished()},dragBoundFunc:Pt(e),transformsEnabled:"position",onTransformEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y")),n.setAttr("scaleX",1),n.setAttr("scaleY",1)},onMouseOver:()=>{a.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{a.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||(a.annotationStore.selected.isLinkingMode&&(d.container().style.cursor=w.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t))}},c,{draggable:!e.isReadOnly(),listening:!r})),(0,ae.jsx)(za,{item:e,color:l.strokeColor})]}):null});we.addTag("keypointregion",rr,lr),we.addRegionType(rr,"image",e=>"x"in e&&"y"in e&&"width"in e&&!("height"in e));const cr=u.gK.model("PolygonPoint",{id:u.gK.optional(u.gK.identifier,I),x:u.gK.number,y:u.gK.number,index:u.gK.number,style:"circle",size:"small"}).volatile(()=>({selected:!1})).views(e=>({get parent(){return(0,u.p7)(e,2)?(0,u.PA)(e,2):null},get stage(){var t;return null==(t=e.parent)?void 0:t.parent},get canvasX(){var t;return null==(t=e.stage)?void 0:t.internalToCanvasX(e.x)},get canvasY(){var t;return null==(t=e.stage)?void 0:t.internalToCanvasY(e.y)}})).actions(e=>({movePoint(t,n){const i=e.stage.canvasToInternalX(t),o=e.stage.canvasToInternalY(n);e.x=e.x+i,e.y=e.y+o},_setPos(t,n){e.x=t,e.y=n},_movePoint(t,n){var i;const o=null==(i=e.parent.control)?void 0:i.getSnappedPoint({x:e.stage.canvasToInternalX(t),y:e.stage.canvasToInternalY(n)});e._setPos(o.x,o.y)},closeStartPoint(){e.annotation.isReadOnly()||e.parent.closed||e.parent.mouseOverStartPoint&&e.parent.closePoly()},handleMouseOverStartPoint(t){var n;t.cancelBubble=!0;const i=null==(n=e.stage)?void 0:n.stageRef;if(!i)return;if(i.container().style.cursor="crosshair",e.parent.closed||e.parent.points.length<3)return;const o=t.target;"rectangle"===e.style&&(o.setX(o.x()-o.width()/2),o.setY(o.y()-o.height()/2));const s={small:2,medium:3,large:4}[e.size];o.scale({x:s/e.stage.zoomScale,y:s/e.stage.zoomScale}),e.parent.setMouseOverStartPoint(!0)},handleMouseOutStartPoint(t){var n;const i=t.target,o=null==(n=e.stage)?void 0:n.stageRef;o&&(o.container().style.cursor="default","rectangle"===e.style&&(i.setX(i.x()+i.width()/2),i.setY(i.y()+i.height()/2)),i.scale({x:1/e.stage.zoomScale,y:1/e.stage.zoomScale}),e.parent.setMouseOverStartPoint(!1))},getSkipInteractions:()=>e.parent.control.obj.getSkipInteractions()})),dr=u.gK.compose("PolygonPoint",Te,cr),ur=(0,b.PA)(({item:e,name:t})=>{if(!e.parent)return;const[n,i]=(0,f.useState)(!0),o=tr(e.parent),s={small:1,medium:2,large:3},a={small:4,medium:8,large:12}[e.size],r=0===e.index?{hitStrokeWidth:12,fill:o.strokeColor||e.primary,onMouseOver:e.handleMouseOverStartPoint,onMouseOut:e.handleMouseOutStartPoint}:null,l={onDragMove:t=>{if(e.getSkipInteractions())return!1;if(t.target!==t.currentTarget)return;const n=t.target;let{x:i,y:o}=n.attrs;i<0&&(i=0),o<0&&(o=0),i>e.stage.stageWidth&&(i=e.stage.stageWidth),o>e.stage.stageHeight&&(o=e.stage.stageHeight),e._movePoint(i,o),n.setAttr("x",e.canvasX),n.setAttr("y",e.canvasY)},onDragStart:()=>{if(e.getSkipInteractions())return i(!1),!1;e.annotation.history.freeze()},onDragEnd:t=>{i(!0),e.annotation.history.unfreeze(),t.cancelBubble=!0},onMouseOver:t=>{var n;t.cancelBubble=!0;const i=null==(n=e.stage)?void 0:n.stageRef;i&&(i.container().style.cursor="crosshair")},onMouseOut:()=>{var t;const n=null==(t=e.stage)?void 0:t.stageRef;n&&(n.container().style.cursor="default")},onTransformEnd(e){if(e.target!==e.currentTarget)return;const t=e.target;t.setAttr("x",0),t.setAttr("y",0),t.setAttr("scaleX",1),t.setAttr("scaleY",1)}},c=e.selected?"green":"white";return"circle"===e.style?(0,ae.jsx)(us.jl,Object.assign({name:t,x:e.canvasX,y:e.canvasY,radius:a,fill:c,stroke:"black",strokeWidth:s[e.size],dragOnTop:!1,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,scaleX:1/(e.stage.zoomScale||1),scaleY:1/(e.stage.zoomScale||1),onDblClick:()=>{e.parent.deletePoint(e)},onClick:t=>{if(t.evt.altKey)return e.parent.deletePoint(e);e.parent.isDrawing&&1===e.parent.points.length||(t.evt.preventDefault(),t.cancelBubble=!0,e.parent.mouseOverStartPoint?(e.closeStartPoint(),e.parent.notifyDrawingFinished()):e.parent.setSelectedPoint(e))}},l,r,{draggable:!e.parent.isReadOnly()&&n}),t):(0,ae.jsx)(us.rw,Object.assign({name:t,x:e.x-a/2,y:e.y-a/2,width:a,height:a,fill:c,stroke:"black",strokeWidth:s[e.size],strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,dragOnTop:!1},l,r,{draggable:!e.parent.isReadOnly()}),t)});var hr=n(67695);const gr=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"polygonregion",object:u.gK.late(()=>u.gK.reference(_d)),points:u.gK.array(u.gK.union(dr,u.gK.array(u.gK.number)),[]),closed:!0}).volatile(()=>({mouseOverStartPoint:!1,selectedPoint:null,hideable:!0,_supportsTransform:!0,useTransformer:!0,preferTransformer:!1,supportsRotate:!1,supportsScale:!0})).views(e=>({get store(){return(0,u.Zn)(e)},get bboxCoords(){var t;if(null==(t=e.points)||!t.length||!(0,u._n)(e))return{};return e.points.reduce((e,t)=>({left:Math.min(e.left,t.x),top:Math.min(e.top,t.y),right:Math.max(e.right,t.x),bottom:Math.max(e.bottom,t.y)}),{left:e.points[0].x,top:e.points[0].y,right:e.points[0].x,bottom:e.points[0].y})},get flattenedPoints(){return this.points.map(e=>[e.canvasX,e.canvasY]).reduce((e,t)=>e.concat(t),[])}})).actions(e=>({afterCreate(){e.points.length&&(e.points[0].id||(e.points=e.points.map(([t,n],i)=>({id:I(),x:t,y:n,size:e.pointSize,style:e.pointStyle,index:i}))),e.checkSizes())},setMouseOverStartPoint(t){e.mouseOverStartPoint=t},setSelectedPoint(t){e.selectedPoint&&(e.selectedPoint.selected=!1),t.selected=!0,e.selectedPoint=t},handleMouseMove({e:t,flattenedPoints:n}){const{offsetX:i,offsetY:o}=t.evt,[s,a]=e.parent.fixZoomedCoords([i,o]),[r,l]=pr({flattenedPoints:n,cursorX:s,cursorY:a});!function({point:e,group:t,layer:n,zoom:i}){const o=fr({layer:n})||function({point:e,group:t,layer:n,zoom:i}){const o=new bt.A.Circle({name:"hoverAnchor",x:e[0],y:e[1],stroke:hr.wL.primary,fill:hr.wL[0],scaleX:1/(i||1),scaleY:1/(i||1),strokeWidth:2,radius:5});return t.add(o),n.draw(),o}({point:e,group:t,layer:n,zoom:i});o.to({x:e[0],y:e[1],duration:0})}({point:[r,l],group:t.currentTarget,layer:t.currentTarget.getLayer(),zoom:e.parent.zoomScale})},handleMouseLeave({e}){vr({layer:e.currentTarget.getLayer()})},handleLineClick({e:t,flattenedPoints:n,insertIdx:i}){if(!e.closed||!e.selected)return;t.cancelBubble=!0,vr({layer:t.currentTarget.getLayer()});const{offsetX:o,offsetY:s}=t.evt,[a,r]=e.parent.fixZoomedCoords([o,s]),l=pr({flattenedPoints:n,cursorX:a,cursorY:r});e.insertPoint(i,l[0],l[1])},deletePoint(t){const n=e.points.length<=3&&t.parent.closed,i=1===e.points.length,o=e.selectedPoint===t;n||i||(o&&(e.selectedPoint=null),(0,u.zr)(t))},addPoint(t,n){var i;if(e.closed)return;const o=null==(i=e.control)?void 0:i.getSnappedPoint({x:t,y:n});e._addPoint(o.x,o.y)},setPoints(t){e.points.forEach((e,n)=>{e.x=t[2*n],e.y=t[2*n+1]})},insertPoint(t,n,i){var o;const s=null==(o=e.control)?void 0:o.getSnappedPoint({x:e.parent.canvasToInternalX(n),y:e.parent.canvasToInternalY(i)}),a=e.points[t-1]&&e.parent.isSamePixel(s,e.points[t-1]),r=e.points[t]&&e.parent.isSamePixel(s,e.points[t]);if(a||r)return;const l={id:I(),x:s.x,y:s.y,size:e.pointSize,style:e.pointStyle,index:e.points.length};return e.points.splice(t,0,l),e.points[t]},_addPoint(t,n){const i=e.points[0];e.parent.isSamePixel(i,{x:t,y:n})?e.closePoly():e.points.push({id:I(),x:t,y:n,size:e.pointSize,style:e.pointStyle,index:e.points.length})},closePoly(){e.closed||e.points.length<3||(e.closed=!0)},canClose(t,n){if(e.points.length<2)return!1;const i=e.points[0],o=t,s=n;return(i.x-o)**2+(i.y-s)**2<50},destroyRegion(){(0,u.Yo)(e.points),(0,u.zr)(e.points)},afterUnselectRegion(){e.selectedPoint&&(e.selectedPoint.selected=!1)},setScale(t,n){e.scaleX=t,e.scaleY=n},updateImageSize(){},serialize(){const t={points:e.points.map(e=>[e.x,e.y]),closed:e.closed};return e.parent.createSerializedResult(e,t)}})),mr=u.gK.compose("PolygonRegionModel",Ze,mt,Ge,Fa,gr);function pr({flattenedPoints:e,cursorX:t,cursorY:n}){const[i,o,s,a]=e;return[t-(a-o)*(s*o-i*a+t*(a-o)-n*(s-i))/((a-o)*(a-o)+(s-i)*(s-i)),((s-i)*(s*o-i*a)+(s-i)*(a-o)*t+(a-o)*(a-o)*n)/((a-o)*(a-o)+(s-i)*(s-i))]}function fr({layer:e}){return e.findOne(".hoverAnchor")}function vr({layer:e}){const t=fr({layer:e});t&&(t.destroy(),e.draw())}const yr=(0,f.memo)((0,b.PA)(({item:e,colors:t,dragProps:n,draggable:i})=>{const{flattenedPoints:o}=e,s="poly";return(0,ae.jsx)(us.YJ,{name:s,children:(0,ae.jsx)(us.N1,Object.assign({name:"_transformable",lineJoin:"round",lineCap:"square",stroke:t.strokeColor,strokeWidth:t.strokeWidth,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,points:o,fill:t.fillColor,closed:!0},n,{onTransformEnd:t=>{if(t.target!==t.currentTarget)return;const n=t.target,i=[n.getAttr("x",0),n.getAttr("y",0)],o=[n.getAttr("scaleX",1),n.getAttr("scaleY",1)],s=n.getAttr("points");e.setPoints(s.reduce((t,n,a)=>{if(a%2==0){var r;const l=null==(r=e.control)?void 0:r.getSnappedPoint({x:e.parent.canvasToInternalX(n*o[0]+i[0]),y:e.parent.canvasToInternalY(s[a+1]*o[1]+i[1])});t.push(l.x,l.y)}return t},[])),n.setAttr("x",0),n.setAttr("y",0),n.setAttr("scaleX",1),n.setAttr("scaleY",1)},draggable:i}))},s)})),br=(0,b.PA)(({name:e,item:t,idx:n,p1:i,p2:o,closed:s,regionStyles:a})=>{const r=n+1,l=[i.canvasX,i.canvasY,o.canvasX,o.canvasY],c=s?{stroke:"transparent",strokeWidth:a.strokeWidth,strokeScaleEnabled:!1}:{stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeScaleEnabled:!1};return(0,ae.jsx)(us.YJ,{name:e,onClick:e=>t.handleLineClick({e,flattenedPoints:l,insertIdx:r}),onMouseMove:e=>{t.closed&&t.selected&&!t.isReadOnly()&&t.handleMouseMove({e,flattenedPoints:l})},onMouseLeave:e=>t.handleMouseLeave({e}),children:(0,ae.jsx)(us.N1,Object.assign({lineJoin:"round",opacity:1,points:l,hitStrokeWidth:20,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1},c))},e)}),xr=(0,f.memo)((0,b.PA)(({item:e,regionStyles:t})=>{const{points:n,closed:i}=e,o="borders";return!e.closed||!e.parent.useTransformer&&e.selected?(0,ae.jsx)(us.YJ,{name:o,children:n.map((o,s)=>{const a=s,r=s===n.length-1?0:s+1;return i||0!==r?(0,ae.jsx)(br,{name:`border_${a}_${r}`,item:e,idx:a,p1:n[s],p2:n[r],closed:i,regionStyles:t},`border_${a}_${r}`):null})},o):null})),wr=$a(({item:e,setShapeRef:t})=>{var n,i,o,s;const{store:a}=e,{suggestion:r}=null!=(n=(0,f.useContext)(Gs))?n:{},l=tr(e,{useStrokeAsFill:!0});const c=(0,f.useMemo)(()=>{let t=!1;return{onDragStart:n=>{n.target===n.currentTarget&&(e.parent.getSkipInteractions()?n.currentTarget.stopDrag(n.evt):(t=!0,e.annotation.setDragMode(!0),e.annotation.history.freeze(e.id)))},dragBoundFunc:Pt(e,{x:-e.bboxCoords.left,y:-e.bboxCoords.top}),onDragEnd:n=>{if(!t)return;const i=n.target;if(n.target===n.currentTarget){var o,s,a,r,l;e.annotation.setDragMode(!1);const t=null==(o=e.control)?void 0:o.getSnappedPoint({x:null==(s=e.parent)?void 0:s.canvasToInternalX(i.getAttr("x")),y:null==(a=e.parent)?void 0:a.canvasToInternalY(i.getAttr("y"))});t.x=null==(r=e.parent)?void 0:r.internalToCanvasX(t.x),t.y=null==(l=e.parent)?void 0:l.internalToCanvasY(t.y),e.points.forEach(e=>e.movePoint(t.x,t.y)),e.annotation.history.unfreeze(e.id)}i.setAttr("x",0),i.setAttr("y",0),t=!1}}},[e.bboxCoords.left,e.bboxCoords.top]);if((0,f.useEffect)(()=>{e.closed||e.control.tools.Polygon.resumeUnfinishedRegion(e)},[e.closed]),!e.parent)return null;if(!e.inViewPort)return null;const d=null==(i=e.parent)?void 0:i.stageRef;return(0,ae.jsxs)(us.YJ,Object.assign({name:e.id,ref:e=>t(e),onMouseOver:()=>{a.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{a.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||e.isDrawing||(t.cancelBubble=!0,e.closed&&(a.annotationStore.selected.isLinkingMode&&(d.container().style.cursor=w.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t)))}},c,{draggable:!(e.isReadOnly()||e.inSelection&&1!==(null==(o=e.parent)||null==(o=o.selectedRegions)?void 0:o.length)),listening:!r,children:[(0,ae.jsx)(Oa,{item:e,color:l.strokeColor}),e.mouseOverStartPoint,e.points&&e.closed?(0,ae.jsx)(yr,{item:e,colors:l,dragProps:c,draggable:!e.isReadOnly()&&e.inSelection&&(null==(s=e.parent)||null==(s=s.selectedRegions)?void 0:s.length)>1}):null,e.points&&!e.isReadOnly()?(0,ae.jsx)(xr,{item:e,regionStyles:l}):null,e.points&&!e.isReadOnly()?function(t){const n="anchors";return!e.closed||!e.parent.useTransformer&&e.selected?(0,ae.jsx)(us.YJ,{name:n,children:t.map((n,i)=>function({points:t,idx:n}){const i=`anchor_${t.length}_${n}`,o=t[n];if(!e.closed||e.closed&&e.selected)return(0,ae.jsx)(ur,{item:o,name:i},i)}({points:t,idx:i}))},n):null}(e.points):null]}),e.id?e.id:I(5))});function Sr(e){if(e.length<=1)return e;const t=[],n=new Set(e);let i=e[0];for(t.push(i),n.delete(i);n.size>0;){let e=!1;for(const o of n){if(o.from.id===i.to.id){t.push(o),n.delete(o),i=o,e=!0;break}const s={from:o.to,to:o.from};t.unshift(s),n.delete(o),i=s,e=!0;break}if(!e)for(const o of n)if(o.from.id===i.to.id||o.to.id===i.to.id||o.from.id===i.from.id||o.to.id===i.from.id){if(o.from.id===i.to.id)t.push(o);else if(o.to.id===i.to.id){const e={from:o.to,to:o.from};t.push(e)}else if(o.to.id===i.from.id)t.unshift(o);else if(o.from.id===i.from.id){const e={from:o.to,to:o.from};t.unshift(e)}n.delete(o),i=t[t.length-1],e=!0;break}if(!e)break}return t}we.addTag("polygonregion",mr,wr),we.addRegionType(mr,"image",e=>!!e.points);const Cr=({segments:e,allowClose:t=!1,isPathClosed:n=!1,stroke:i="#3b82f6",fill:o="rgba(239, 68, 68, 0.3)",strokeWidth:s=2,opacity:a=1,transform:r={zoom:1,offsetX:0,offsetY:0},fitScale:l=1,onClick:c,onMouseEnter:d,onMouseLeave:u,onMouseDown:h,onMouseMove:g,onMouseUp:m})=>{if(0===e.length)return null;const p=(0,f.useRef)({});r.zoom;if(e.some(t=>{const n=e.map(e=>e.from.id),i=new Set(n);return n.length!==i.size}))return(0,ae.jsx)(ae.Fragment,{children:e.map((e,t)=>{const{from:n,to:o}=e;let s=`M ${n.x} ${n.y}`;if(n.isBezier&&n.controlPoint2&&o.isBezier&&o.controlPoint1)s+=` C ${n.controlPoint2.x} ${n.controlPoint2.y}, ${o.controlPoint1.x} ${o.controlPoint1.y}, ${o.x} ${o.y}`;else if(n.isBezier&&n.controlPoint2){const e=o.x-n.x,t=o.y-n.y,i=o.x-.3*e,a=o.y-.3*t;s+=` C ${n.controlPoint2.x} ${n.controlPoint2.y}, ${i} ${a}, ${o.x} ${o.y}`}else if(o.isBezier&&o.controlPoint1){const e=o.x-n.x,t=o.y-n.y;s+=` C ${n.x+.3*e} ${n.y+.3*t}, ${o.controlPoint1.x} ${o.controlPoint1.y}, ${o.x} ${o.y}`}else s+=` L ${o.x} ${o.y}`;return(0,ae.jsx)(us.wA,{data:s,stroke:i,strokeWidth:2,strokeScaleEnabled:!1,fill:void 0,hitStrokeWidth:20,onClick:c,onMouseEnter:d,onMouseLeave:u,onMouseDown:h,onMouseMove:g,onMouseUp:m},`segment-${t}`)})});const v=function(e){if(0===e.length)return[];const t=[],n=new Set;for(let i=0;i<e.length;i++){if(n.has(i))continue;const o=[],s=new Set;o.push(e[i]),s.add(e[i].from.id),s.add(e[i].to.id),n.add(i);let a=!0;for(;a;){a=!1;for(let t=0;t<e.length;t++){if(n.has(t))continue;const i=e[t];(s.has(i.from.id)||s.has(i.to.id))&&(o.push(i),s.add(i.from.id),s.add(i.to.id),n.add(t),a=!0)}}const r=Sr(o);t.push(r)}return t}(e);return(0,ae.jsx)(ae.Fragment,{children:v.map((e,r)=>{const l=function(e,t,n){if(0===e.length)return"";let i="";const o=e[0];i+=`M ${o.from.x} ${o.from.y}`;for(let t=0;t<e.length;t++){const n=e[t],{from:o,to:s}=n;if(o.isBezier&&o.controlPoint2&&s.isBezier&&s.controlPoint1)i+=` C ${o.controlPoint2.x} ${o.controlPoint2.y}, ${s.controlPoint1.x} ${s.controlPoint1.y}, ${s.x} ${s.y}`;else if(o.isBezier&&o.controlPoint2){const e=s.x-o.x,t=s.y-o.y,n=s.x-.3*e,a=s.y-.3*t;i+=` C ${o.controlPoint2.x} ${o.controlPoint2.y}, ${n} ${a}, ${s.x} ${s.y}`}else if(s.isBezier&&s.controlPoint1){const e=s.x-o.x,t=s.y-o.y;i+=` C ${o.x+.3*e} ${o.y+.3*t}, ${s.controlPoint1.x} ${s.controlPoint1.y}, ${s.x} ${s.y}`}else i+=` L ${s.x} ${s.y}`}return t&&n&&e.length>0&&(i+=" Z"),i}(e,t,n),v=t&&n&&o?(0,ft.A)(o).alpha(a).css():void 0;return t&&n&&v?(0,ae.jsxs)(f.Fragment,{children:[(0,ae.jsx)(us.wA,{data:l,stroke:i,strokeWidth:s,strokeScaleEnabled:!1,fill:v,hitStrokeWidth:20,onClick:c,onMouseDown:h,onMouseMove:g,onMouseUp:m},`path-${r}`),(0,ae.jsx)(us.yp,{sceneFunc:(e,t)=>{},hitFunc:(e,t)=>{const n=new Path2D(l);e.fill(n),e.fillShape(t)},onClick:c,onMouseEnter:e=>{var t,n,i;console.log("ðŸ”µ Shape onMouseEnter fired - fill area hovered",{target:null==(t=e.target)?void 0:t.getClassName(),currentTarget:null==(n=e.currentTarget)?void 0:n.getClassName(),pointerPos:null==(i=e.target)||null==(i=i.getStage())?void 0:i.getPointerPosition(),pathData:`${l.substring(0,50)}...`}),p.current[r]&&(clearTimeout(p.current[r]),p.current[r]=null),null==d||d(e)},onMouseLeave:e=>{var t,n,i;console.log("ðŸ”´ Shape onMouseLeave fired - left fill area",{target:null==(t=e.target)?void 0:t.getClassName(),currentTarget:null==(n=e.currentTarget)?void 0:n.getClassName(),pointerPos:null==(i=e.target)||null==(i=i.getStage())?void 0:i.getPointerPosition(),relatedTarget:e.evt.relatedTarget}),p.current[r]=setTimeout(()=>{p.current[r]=null,null==u||u(e)},50)},onMouseDown:h,onMouseMove:g,onMouseUp:m,listening:!0},`fill-shape-${r}`)]},`path-group-${r}`):(0,ae.jsx)(us.wA,{data:l,stroke:i,strokeWidth:s,strokeScaleEnabled:!1,fill:v,hitStrokeWidth:20,onClick:c,onMouseEnter:d,onMouseLeave:u,onMouseDown:h,onMouseMove:g,onMouseUp:m},`path-${r}`)})})},kr={zoom:1,offsetX:0,offsetY:0},Pr=1,Rr={rotation:0,scaleX:1,scaleY:1,centerX:0,centerY:0},jr="#3b82f6",Nr="rgba(239, 68, 68, 0.3)",Tr="#ffffff",_r="#3b82f6",Ar="#ffffff",Ir=2,Mr=6,Er=10,Kr=8,Dr=Math.PI/180,Or=0,Lr=1,zr=1,Br=1.6,Fr=.8,Hr=45,Vr="#3b82f6",$r=1,Wr="#ffffff",Ur="#3b82f6",Gr=2,Yr=.9,Xr={STROKE_WIDTH:2,DASH:[4,4],OPACITY:.6,CLOSING_INDICATOR_STROKE:"#10b981",CLOSING_INDICATOR_STROKE_WIDTH:3,CLOSING_INDICATOR_DASH:[6,6],CLOSING_INDICATOR_OPACITY:.8,CLOSE_RADIUS:15,BEZIER_CONTROL_MULTIPLIER:.3},qr=(e,t,n)=>{const i=t.x,o=t.y,s=n.x,a=n.y,r=e.x,l=e.y,c=s-i,d=a-o,u=c*c+d*d;let h,g,m=-1;return 0!==u&&(m=((r-i)*c+(l-o)*d)/u),m<0?(h=i,g=o):m>1?(h=s,g=a):(h=i+m*c,g=o+m*d),{x:h,y:g}},Zr=(e,t,n,i,o)=>{let s=t,a=Number.POSITIVE_INFINITY;for(let r=0;r<=200;r++){const l=r/200,c=(1-l)**3*t.x+3*(1-l)**2*l*n.x+3*(1-l)*l**2*i.x+l**3*o.x,d=(1-l)**3*t.y+3*(1-l)**2*l*n.y+3*(1-l)*l**2*i.y+l**3*o.y,u=Math.sqrt((e.x-c)**2+(e.y-d)**2);u<a&&(a=u,s={x:c,y:d})}return s},Jr=()=>(0,A.Ak)(),Qr=e=>{let t;return e.map((e,n)=>{if((e=>Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])(e)){const i={id:Jr(),prevPointId:n>0?t:void 0,x:e[0],y:e[1],isBezier:!1,disconnected:!1,isBranching:!1};return t=i.id,i}if((e=>"object"==typeof e&&null!==e&&"x"in e&&"y"in e)(e)){const i=Object.assign({},e,{id:e.id||Jr(),prevPointId:e.prevPointId||(n>0?t:void 0)});return t=i.id,i}throw new Error(`Invalid point format at index ${n}: ${JSON.stringify(e)}`)})},el=(e,t,n)=>{e.x,e.y;if(!t.isBezier&&!n.isBezier)return tl(e,t,n);let i=t;for(let o=1;o<=20;o++){const s=nl(t,n,o/20);if(tl(e,i,s))return!0;i=s}return!1},tl=(e,t,n)=>{const i=e.x,o=e.y,s=t.x,a=t.y,r=n.x,l=n.y;if(a>l)return tl(e,n,t);if(o<a||o>l||a===l)return!1;return s+(o-a)*(r-s)/(l-a)>i},nl=(e,t,n)=>{let i,o;if(e.isBezier&&e.controlPoint2&&t.isBezier&&t.controlPoint1)i=e.controlPoint2,o=t.controlPoint1;else if(e.isBezier&&e.controlPoint2){const n=t.x-e.x,s=t.y-e.y;i=e.controlPoint2,o={x:t.x-.3*n,y:t.y-.3*s}}else{if(!t.isBezier||!t.controlPoint1)return{x:e.x+n*(t.x-e.x),y:e.y+n*(t.y-e.y)};{const n=t.x-e.x,s=t.y-e.y;i={x:e.x+.3*n,y:e.y+.3*s},o=t.controlPoint1}}const s=1-n,a=n*n,r=s*s,l=r*s,c=a*n;return{x:l*e.x+3*r*n*i.x+3*s*a*o.x+c*t.x,y:l*e.y+3*r*n*i.y+3*s*a*o.y+c*t.y}};let il=function(e){return e.POLYGON="polygon",e.POLYLINE="polyline",e}({}),ol=function(e){return e.SIMPLE="simple",e.REGULAR="regular",e}({}),sl=function(e){return e.MAIN="main",e}({}),al=function(e){return e.REGULAR="regular",e.BEZIER="bezier",e.GHOST="ghost",e}({});function rl(e,t,n){if(!e.allowClose||e.initialPoints.length<2)return!1;if(!(()=>{if(e.initialPoints.length>2)return!0;return!!e.initialPoints.some(e=>e.isBezier)})())return!1;const i=e.minPoints;if(i&&e.initialPoints.length<i)return!1;const o=e.initialPoints.length-1;if(0!==t&&t!==o||0!==n&&n!==o)return!1;const s=e.initialPoints[0],a=e.initialPoints[e.initialPoints.length-1];if(s.prevPointId===a.id)return!0;const r=[...e.initialPoints];return r[0]=Object.assign({},r[0],{prevPointId:r[r.length-1].id}),null==e.onPointsChange||e.onPointsChange(r),e.setIsPathClosed(!0),!0}function ll(e,t){var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(!i)return!1;const o=dl(i,t.transform,t.fitScale,t.x,t.y);if(s=o,a=t.width,r=t.height,!(s.x>=0&&s.y>=0&&s.x<=a&&s.y<=r))return!1;var s,a,r;const l=ul(o,t.pixelSnapping);if(t.allowClose&&!t.isPathClosed&&t.initialPoints.length>0){if(hl(o,t.initialPoints[0])<=15/(t.transform.zoom*t.fitScale))return function(e){return rl(e,0,e.initialPoints.length-1)}(t)}if(!t.isPathClosed&&null!=t.canAddMorePoints&&t.canAddMorePoints()){const e={x:l.x,y:l.y,type:al.REGULAR};return t.activePointId?e.prevPointId=t.activePointId:!t.skeletonEnabled&&t.initialPoints.length>0&&(e.prevPointId=t.initialPoints[t.initialPoints.length-1].id),function(e,t){return!!e.pointCreationManager&&(t.type===al.BEZIER?e.pointCreationManager.createBezierPointAt(t.x,t.y,t.controlPoint1,t.controlPoint2,t.prevPointId,t.isDisconnected):e.pointCreationManager.createRegularPointAt(t.x,t.y,t.prevPointId))}(t,e)}return!1}function cl(e,t){var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(!i)return!1;const o=dl(i,t.transform,t.fitScale,t.x,t.y);let s=-1,a=Number.POSITIVE_INFINITY;for(let e=0;e<t.initialPoints.length;e++){const n=hl(o,t.initialPoints[e]);n<=Er/(t.transform.zoom*t.fitScale)&&n<a&&(a=n,s=e)}if(-1!==s){const e=t.initialPoints[s];if(e.isBezier&&e.disconnected){const e=t.initialPoints.map((e,t)=>{if(t===s){if(e.controlPoint1&&e.controlPoint2){const t=e.controlPoint2.x-e.x,n=e.controlPoint2.y-e.y;return Object.assign({},e,{disconnected:!1,controlPoint1:{x:e.x-t,y:e.y-n},controlPoint2:{x:e.x+t,y:e.y+n}})}return e}return e});return null==t.onPointsChange||t.onPointsChange(e),!0}const n=[...t.initialPoints],i=n[s];if(!i.isBezier){if(!t.allowBezier)return!1;const e=t.initialPoints.find(e=>e.id===i.prevPointId),o=t.initialPoints.find(e=>e.prevPointId===i.id);if(e&&o){const a=o.x-e.x,r=o.y-e.y,l=Math.sqrt(a*a+r*r),c=30,d=80,u=.3*l,h=Math.max(c,Math.min(d,u)),g={x:i.x-a/l*h,y:i.y-r/l*h},m={x:i.x+a/l*h,y:i.y+r/l*h},p=ul(g,t.pixelSnapping),f=ul(m,t.pixelSnapping);return n[s]=Object.assign({},i,{isBezier:!0,controlPoint1:p,controlPoint2:f,disconnected:!1}),null==t.onPointsChange||t.onPointsChange(n),null==t.onPointEdited||t.onPointEdited(n[s],s),t.setVisibleControlPoints(new Set([s])),!0}if(e||o){const a=e||o;if(!a)return!1;const r=a.x-i.x,l=a.y-i.y,c=Math.sqrt(r*r+l*l),d=Math.max(30,Math.min(60,.4*c)),u={x:i.x-r/c*d,y:i.y-l/c*d},h={x:i.x+r/c*d,y:i.y+l/c*d},g=ul(u,t.pixelSnapping),m=ul(h,t.pixelSnapping);return n[s]=Object.assign({},i,{isBezier:!0,controlPoint1:g,controlPoint2:m,disconnected:!1}),null==t.onPointsChange||t.onPointsChange(n),null==t.onPointEdited||t.onPointEdited(n[s],s),t.setVisibleControlPoints(new Set([s])),!0}return console.warn("ðŸ” Shift-click: Cannot convert point - missing neighboring points. This should not happen in normal operation."),!1}if(!i.disconnected)return n[s]=Object.assign({},i,{isBezier:!1,controlPoint1:void 0,controlPoint2:void 0,disconnected:!1}),null==t.onPointsChange||t.onPointsChange(n),null==t.onPointEdited||t.onPointEdited(n[s],s),!0;if(i.controlPoint1&&i.controlPoint2){const e=i.controlPoint2.x-i.x,o=i.controlPoint2.y-i.y,a={x:i.x-e,y:i.y-o},r={x:i.x+e,y:i.y+o},l=ul(a,t.pixelSnapping),c=ul(r,t.pixelSnapping);return n[s]=Object.assign({},i,{disconnected:!1,controlPoint1:l,controlPoint2:c}),null==t.onPointsChange||t.onPointsChange(n),null==t.onPointEdited||t.onPointEdited(n[s],s),!0}}return!1}function dl(e,t,n,i,o){const s=t.zoom*n;return{x:(e.x-i-t.offsetX)/s,y:(e.y-o-t.offsetY)/s}}function ul(e,t=!1){return t?{x:Math.round(e.x),y:Math.round(e.y)}:e}function hl(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}function gl(e,t,n){return hl(e,t)<=n}function ml(e,t,n,i){if(t.length<2)return null;let o={x:0,y:0},s=Number.POSITIVE_INFINITY,a=0;const r=new Map;for(const e of t)r.set(e.id,e);for(let n=0;n<t.length;n++){const i=t[n];if(!i.prevPointId)continue;const l=r.get(i.prevPointId);if(!l)continue;let c;if(l.isBezier&&l.controlPoint2&&i.isBezier&&i.controlPoint1)c=Zr(e,l,l.controlPoint2,i.controlPoint1,i);else if(l.isBezier&&l.controlPoint2){const t=i.x-l.x,n=i.y-l.y,o=i.x-.3*t,s=i.y-.3*n;c=Zr(e,l,l.controlPoint2,{x:o,y:s},i)}else if(i.isBezier&&i.controlPoint1){const t=i.x-l.x,n=i.y-l.y,o=l.x+.3*t,s=l.y+.3*n;c=Zr(e,l,{x:o,y:s},i.controlPoint1,i)}else c=qr(e,l,i);const d=hl(e,c);d<s&&(s=d,o=c,a=n)}if(n&&i&&(()=>{if(t.length>2)return!0;return!!t.some(e=>e.isBezier)})()){const n=t[t.length-1],i=t[0];let r;if(n.isBezier&&n.controlPoint2&&i.isBezier&&i.controlPoint1)r=Zr(e,n,n.controlPoint2,i.controlPoint1,i);else if(n.isBezier&&n.controlPoint2){const t=i.x-n.x,o=i.y-n.y,s=i.x-.3*t,a=i.y-.3*o;r=Zr(e,n,n.controlPoint2,{x:s,y:a},i)}else if(i.isBezier&&i.controlPoint1){const t=i.x-n.x,o=i.y-n.y,s=n.x+.3*t,a=n.y+.3*o;r=Zr(e,n,{x:s,y:a},i.controlPoint1,i)}else r=qr(e,n,i);const l=hl(e,r);l<s&&(s=l,o=r,a=t.length)}return s<=50?{point:o,segmentIndex:a}:null}function pl(e){if(null!==e.newPointDragIndex&&e.cursorPosition){const t=e.newPointDragIndex,n=[...e.initialPoints],i=n[t];if(i&&i.isBezier&&e.cursorPosition){const o=e.cursorPosition.x-i.x,s=e.cursorPosition.y-i.y,a=Math.sqrt(o*o+s*s),r=o/a,l=s/a,c={x:i.x+r*a,y:i.y+l*a},d={x:i.x-r*a,y:i.y-l*a},u=ul(c,e.pixelSnapping),h=ul(d,e.pixelSnapping);n[t]=Object.assign({},i,{controlPoint1:{x:u.x,y:u.y},controlPoint2:{x:h.x,y:h.y}}),null==e.onPointsChange||e.onPointsChange(n),null==e.onPointEdited||e.onPointEdited(n[t],t)}}}const fl=({initialPoints:e,cursorPositionRef:t,draggedControlPoint:n,draggedPointIndex:i=null,isDraggingNewBezier:o=!1,isPathClosed:s,allowClose:a,transform:r,fitScale:l,maxPoints:c,minPoints:d,skeletonEnabled:u,selectedPointIndex:h=null,lastAddedPointId:g,activePointId:m=null,stroke:p=jr,pixelSnapping:f=!1,drawingDisabled:v=!1,isShiftKeyHeld:y=!1,transformMode:b=!1,effectiveSelectedPointsSize:x=0})=>{const w=(()=>{if(m){const t=e.find(e=>e.id===m);if(t)return t}if(null!=h&&h>=0&&h<e.length)return e[h];if(g){const t=e.find(e=>e.id===g);if(t)return t}if(e.length>0){return e[e.length-1]}return null})();return(0,ae.jsxs)(ae.Fragment,{children:[w&&(0,ae.jsx)(us.yp,{stroke:p,strokeWidth:Xr.STROKE_WIDTH,strokeScaleEnabled:!1,lineCap:"round",lineJoin:"round",dash:Xr.DASH,opacity:Xr.OPACITY,sceneFunc:(u,g)=>{const m=t.current;if(!m||n||null!==i||o||s||void 0!==c&&e.length>=c)return;const p=r.zoom*l;if(m&&e.length>0){const t=Mr/p;for(let n=0;n<e.length;n++){const i=e[n];if(i.isBezier){if(i.controlPoint1){if(Math.sqrt((m.x-i.controlPoint1.x)**2+(m.y-i.controlPoint1.y)**2)<=t)return}if(i.controlPoint2){if(Math.sqrt((m.x-i.controlPoint2.x)**2+(m.y-i.controlPoint2.y)**2)<=t)return}}}}if(m&&e.length>0){const t=Er/p;for(let n=0;n<e.length;n++){const i=e[n];if(Math.sqrt((m.x-i.x)**2+(m.y-i.y)**2)<=t){if(n===e.length-1)continue;if(0===n&&a&&!s)continue;return}}}if(m&&e.length>=2){const t=Kr/p,n=ml(m,e,a,s);if(n&&hl(m,n.point)<=t)return}if((y||b||x>1)&&null===h)return;if((()=>{if(!a||!w)return null;if(!(e.length>2||e.some(e=>e.isBezier))||d&&e.length<d)return null;const t=e[0],n=e[e.length-1],i=Xr.CLOSE_RADIUS/(r.zoom*l),o=w.id===t.id,s=w.id===n.id;if(!o&&!s)return null;const c=Math.sqrt((m.x-t.x)**2+(m.y-t.y)**2),u=Math.sqrt((m.x-n.x)**2+(m.y-n.y)**2);return o&&u<=i?{point:n,index:e.length-1}:s&&c<=i?{point:t,index:0}:null})())return;u.beginPath(),u.moveTo(w.x,w.y);const v=(S=m,f?{x:Math.round(S.x),y:Math.round(S.y)}:S);var S;if(w.isBezier&&w.controlPoint1&&w.controlPoint2){const e=v.x-w.x,t=v.y-w.y,n=v.x-e*Xr.BEZIER_CONTROL_MULTIPLIER,i=v.y-t*Xr.BEZIER_CONTROL_MULTIPLIER;u.bezierCurveTo(w.controlPoint2.x,w.controlPoint2.y,n,i,v.x,v.y)}else u.lineTo(v.x,v.y);u.strokeShape(g)}}),w&&(0,ae.jsx)(us.yp,{stroke:Xr.CLOSING_INDICATOR_STROKE,strokeWidth:Xr.CLOSING_INDICATOR_STROKE_WIDTH,strokeScaleEnabled:!1,lineCap:"round",lineJoin:"round",dash:Xr.CLOSING_INDICATOR_DASH,opacity:Xr.CLOSING_INDICATOR_OPACITY,sceneFunc:(n,i)=>{const o=t.current;if(!o||s||v&&!a)return;const c=(()=>{if(!a)return null;if(!(e.length>2||e.some(e=>e.isBezier))||d&&e.length<d)return null;const t=e[0],n=e[e.length-1],i=Xr.CLOSE_RADIUS/(r.zoom*l),s=w.id===t.id,c=w.id===n.id;if(!s&&!c)return null;const u=Math.sqrt((o.x-t.x)**2+(o.y-t.y)**2),h=Math.sqrt((o.x-n.x)**2+(o.y-n.y)**2);return s&&h<=i?{point:n,index:e.length-1}:c&&u<=i?{point:t,index:0}:null})();if(!c)return;n.beginPath(),n.moveTo(w.x,w.y);const u=c.point;if(w.isBezier&&w.controlPoint2&&u.isBezier&&u.controlPoint1)n.bezierCurveTo(w.controlPoint2.x,w.controlPoint2.y,u.controlPoint1.x,u.controlPoint1.y,u.x,u.y);else if(w.isBezier&&w.controlPoint2){const e=u.x-w.x,t=u.y-w.y,i=u.x-e*Xr.BEZIER_CONTROL_MULTIPLIER,o=u.y-t*Xr.BEZIER_CONTROL_MULTIPLIER;n.bezierCurveTo(w.controlPoint2.x,w.controlPoint2.y,i,o,u.x,u.y)}else if(u.isBezier&&u.controlPoint1){const e=u.x-w.x,t=u.y-w.y,i=w.x+e*Xr.BEZIER_CONTROL_MULTIPLIER,o=w.y+t*Xr.BEZIER_CONTROL_MULTIPLIER;n.bezierCurveTo(i,o,u.controlPoint1.x,u.controlPoint1.y,u.x,u.y)}else n.lineTo(u.x,u.y);n.strokeShape(i)}})]})},vl=({initialPoints:e,selectedPointIndex:t,selectedPoints:n,transform:i,fitScale:o,pointRefs:s,selected:a=!0,disabled:r=!1,transformMode:l=!1,pointRadius:c,pointFill:d="#ffffff",pointStroke:u="#3b82f6",pointStrokeSelected:h="#ffffff",pointStrokeWidth:g=2,pointStyle:m="circle",activePointId:p=null,maxPoints:f,onPointClick:v})=>{const y=1===e.length,b=!r&&!l&&(a||y),x=!r&&!l;return(0,ae.jsx)(ae.Fragment,{children:e.map((r,l)=>{var w,S;const C=i.zoom*o,k=null!=(w=null==c?void 0:c.enabled)?w:6,P=null!=(S=null==c?void 0:c.disabled)?S:4,R=a?k:P,j=void 0!==f&&e.length>=f,N=n.size>1,T=t===l||n.has(l)||a&&!j&&!N&&null!==p&&r.id===p,_=R*(T?1.3:1)/C,A=v?e=>{b&&(!y||e.evt.altKey||e.evt.shiftKey||e.evt.ctrlKey||e.evt.metaKey?(e.evt.stopImmediatePropagation(),e.evt.stopPropagation(),e.evt.preventDefault(),e.cancelBubble=!0,v(e,l)):v(e,l))}:void 0,I=(e,t)=>{const n=Er/C;e.beginPath(),e.arc(0,0,n,0,2*Math.PI),e.fillStrokeShape(t)};if("rectangle"===m){const e=2*_;return(0,ae.jsxs)(ae.Fragment,{children:[a&&T&&(0,ae.jsx)(us.rw,{x:r.x-e/2,y:r.y-e/2,width:e,height:e,fill:"transparent",stroke:h,strokeScaleEnabled:!1,strokeWidth:g+5,listening:!1,name:`point-outline-${l}`},`point-outline-${l}-${r.x}-${r.y}`),(0,ae.jsx)(us.rw,{ref:e=>{s.current[l]=e},x:r.x-e/2,y:r.y-e/2,width:e,height:e,fill:d,stroke:u,strokeScaleEnabled:!1,strokeWidth:g,listening:x,name:`point-${l}`,hitFunc:I,onClick:A},`point-${l}-${r.x}-${r.y}`)]})}return(0,ae.jsxs)(ae.Fragment,{children:[a&&T&&(0,ae.jsx)(us.jl,{x:r.x,y:r.y,radius:_,fill:"transparent",stroke:h,strokeScaleEnabled:!1,strokeWidth:g+5,listening:!1,name:`point-outline-${l}`},`point-outline-${l}-${r.x}-${r.y}`),(0,ae.jsx)(us.jl,{ref:e=>{s.current[l]=e},x:r.x,y:r.y,radius:_,fill:d,stroke:u,strokeScaleEnabled:!1,strokeWidth:g,listening:x,name:`point-${l}`,hitFunc:I,onClick:A},`point-${l}-${r.x}-${r.y}`)]})})})};const yl=({initialPoints:e,selectedPointIndex:t,isDraggingNewBezier:n,draggedControlPoint:i,visibleControlPoints:o,transform:s,fitScale:a})=>(0,ae.jsx)(ae.Fragment,{children:e.map((e,r)=>{var l,c,d,u;if(!e.isBezier)return null;if(!(t===r||n&&(null==i?void 0:i.pointIndex)===r||o.has(r)||e.isBezier))return null;const h=4/(s.zoom*a);return(0,ae.jsxs)(f.Fragment,{children:[e.controlPoint1&&(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)(us.N1,{points:[e.x,e.y,e.controlPoint1.x,e.controlPoint1.y],stroke:Vr,strokeWidth:$r,strokeScaleEnabled:!1})}),e.controlPoint2&&(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)(us.N1,{points:[e.x,e.y,e.controlPoint2.x,e.controlPoint2.y],stroke:Vr,strokeWidth:$r,opacity:Yr,strokeScaleEnabled:!1})}),e.controlPoint1&&(0,ae.jsx)(us.rw,{x:e.controlPoint1.x,y:e.controlPoint1.y,width:h*Br,height:h*Br,offsetX:h*Fr,offsetY:h*Fr,rotation:Hr,fill:Wr,stroke:Ur,strokeWidth:Gr,strokeScaleEnabled:!1,listening:!0}),e.controlPoint2&&(0,ae.jsx)(us.rw,{x:e.controlPoint2.x,y:e.controlPoint2.y,width:h*Br,height:h*Br,offsetX:h*Fr,offsetY:h*Fr,rotation:Hr,fill:Wr,stroke:Ur,strokeWidth:Gr,strokeScaleEnabled:!1,listening:!0})]},`control-group-${r}-${e.x.toFixed(2)}-${e.y.toFixed(2)}-${(null==(l=e.controlPoint1)?void 0:l.x.toFixed(2))||"null"}-${(null==(c=e.controlPoint1)?void 0:c.y.toFixed(2))||"null"}-${(null==(d=e.controlPoint2)?void 0:d.x.toFixed(2))||"null"}-${(null==(u=e.controlPoint2)?void 0:u.y.toFixed(2))||"null"}`)})}),bl=(0,f.forwardRef)(({ghostPoint:e,transform:t,fitScale:n,isShiftKeyHeld:i,maxPoints:o,initialPointsLength:s,isDragging:a=!1},r)=>{if(!e)return null;if(void 0!==o&&s>=o)return null;const l=6/(t.zoom*n),c=(0,f.useRef)(null);(0,f.useImperativeHandle)(r,()=>({updatePosition:(e,t)=>{if(c.current){c.current.setPosition({x:e,y:t});const n=c.current.getStage();n&&n.batchDraw()}}})),(0,f.useEffect)(()=>{if(c.current&&e){c.current.setPosition({x:e.x,y:e.y});const t=c.current.getStage();t&&t.batchDraw()}},[null==e?void 0:e.x,null==e?void 0:e.y]);const d=Math.round(100*e.x)/100,u=Math.round(100*e.y)/100;return(0,ae.jsx)(us.jl,{ref:c,x:e.x,y:e.y,radius:l,fill:"#87CEEB",stroke:"white",strokeWidth:2,strokeScaleEnabled:!1,listening:!1},`ghost-point-${d}-${u}-${e.prevPointId}-${e.nextPointId}`)}),xl=(e,t,n,i,o,s,a)=>{if(e<0||e>=t.length)return;if(t[e].isBezier)Sl(e,t,n,i,o),s&&a&&s(new Set(Array.from(a).filter(t=>t!==e)));else{if(0===e||e===t.length-1)return;wl(e,t,n,i,o),s&&a&&s(new Set(Array.from(a).concat([e])))}},wl=(e,t,n,i,o)=>{if(null==e||0===e||e===t.length-1)return;const s=t.map((i,s)=>{if(s===e){const e=t[s-1],a=t[s+1],r=a.x-e.x,l=a.y-e.y,c=Math.sqrt(r*r+l*l),d=.3*c,u={x:i.x-r/c*d,y:i.y-l/c*d},h={x:i.x+r/c*d,y:i.y+l/c*d},g=Object.assign({},i,{isBezier:!0,controlPoint1:u,controlPoint2:h,disconnected:!1});return null==n||n(g,s,!0),null==o||o(t),g}return i});null==i||i(s)},Sl=(e,t,n,i,o)=>{if(null==e)return;const s=t.map((i,s)=>{if(s===e){const e={id:i.id,prevPointId:i.prevPointId,x:i.x,y:i.y};return null==n||n(e,s,!1),null==o||o(t),e}return i});null==i||i(s)},Cl=(e,t,n,i,o,s,a,r,l,c)=>{if(e<0||e>=t.length)return;const d=t[e],u=[...t];u.splice(e,1);for(let t=0;t<u.length;t++){const n=u[t];if(n.prevPointId===d.id){let i=d.prevPointId;0===e?i=void 0:d.prevPointId||(i=void 0),u[t]=Object.assign({},n,{prevPointId:i})}}if(n===e&&(i(null),null==s||s(null)),c===d.id)if(u.length>0){const e=u[u.length-1];null==l||l(e.id)}else null==l||l(null);o(t=>{const n=new Set(t);n.delete(e);const i=new Set;for(const t of Array.from(n))t>e?i.add(t-1):i.add(t);return i}),null==a||a(d,e),null==r||r(u)};class kl{constructor(){this.state={selectedInstances:new Map,activeInstanceId:null,isTransforming:!1,transformerState:null},this.instances=new Map,this.listeners=new Set}static getInstance(){return kl.instance||(kl.instance=new kl),kl.instance}registerInstance(e){this.instances.set(e.id,e)}unregisterInstance(e){this.instances.delete(e),this.state.selectedInstances.delete(e),this.state.activeInstanceId===e&&(this.state.activeInstanceId=null),this.notifyListeners()}selectPoints(e,t){0===t.size?(this.state.selectedInstances.delete(e),this.state.activeInstanceId===e&&(this.state.activeInstanceId=null)):(this.state.selectedInstances.set(e,new Set(t)),this.state.activeInstanceId=e),this.notifyListeners();const n=this.instances.get(e);n&&(n.setSelectedPoints(t),n.setSelectedPointIndex(1===t.size?Array.from(t)[0]:null),null==n.onPointSelected||n.onPointSelected(1===t.size?Array.from(t)[0]:null))}canInstanceHaveSelection(e){return!0}getActiveInstanceId(){return this.state.activeInstanceId}clearSelection(){for(const[e,t]of this.instances)t.setSelectedPoints(new Set),t.setSelectedPointIndex(null),null==t.onPointSelected||t.onPointSelected(null);this.state.selectedInstances.clear(),this.state.activeInstanceId=null,this.notifyListeners()}getGlobalSelection(){return Object.assign({},this.state)}getSelectedPoints(){const e=[];for(const[t,n]of this.state.selectedInstances){const i=this.instances.get(t);if(i){const o=i.getPoints();for(const i of n)i<o.length&&e.push({instanceId:t,pointIndex:i,point:o[i]})}}return e}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}notifyListeners(){const e=this.getGlobalSelection();for(const t of this.listeners)t(e)}hasSelection(){return this.state.selectedInstances.size>0}getSelectionCount(){let e=0;for(const t of this.state.selectedInstances.values())e+=t.size;return e}isInstanceSelected(e){return this.state.selectedInstances.has(e)}getInstanceSelection(e){return this.state.selectedInstances.get(e)}}function Pl(e,t){const n=function(e){const t=new Set,n=new Set;return e.forEach(e=>{e.prevPointId&&n.add(e.prevPointId)}),e.forEach((e,i)=>{e.prevPointId&&n.has(e.id)||t.add(i)}),t}(t);return n.has(e)}function Rl(e,t,n){return(0===e||e===t.initialPoints.length-1)&&t.allowClose&&!t.isPathClosed&&!n.evt.shiftKey}function jl(e){const t=e.skeletonEnabled&&e.activePointId?e.initialPoints.find(t=>t.id===e.activePointId):e.initialPoints[e.initialPoints.length-1];if(!t)return!1;const n=e.initialPoints[0],i=e.initialPoints[e.initialPoints.length-1],o=t.id===n.id,s=t.id===i.id;return o||s}function Nl(e,t){if(!t.allowClose||t.isPathClosed)return!1;if(!(t.initialPoints.length>2||t.initialPoints.some(e=>e.isBezier)))return!1;if(t.minPoints&&t.initialPoints.length<t.minPoints)return!1;const n=t.initialPoints[0],i=t.initialPoints[t.initialPoints.length-1],o=15/(t.transform.zoom*t.fitScale),s=t.skeletonEnabled&&t.activePointId?t.initialPoints.find(e=>e.id===t.activePointId):t.initialPoints[t.initialPoints.length-1];if(!s)return!1;const a=s.id===n.id,r=s.id===i.id;if(!a&&!r)return!1;const l=Math.sqrt((e.x-n.x)**2+(e.y-n.y)**2),c=Math.sqrt((e.x-i.x)**2+(e.y-i.y)**2);return!!(a&&c<=o)||!!(r&&l<=o)}function Tl(e,t){var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(!i)return!1;const o=dl(i,t.transform,t.fitScale,t.x,t.y),s=t.transform.zoom*t.fitScale,a=Er/s,r=kl.getInstance();if(!r.canInstanceHaveSelection(t.instanceId||"unknown"))return!1;for(let n=0;n<t.initialPoints.length;n++){const i=t.initialPoints[n];if(gl(o,i,a)){if(Rl(n,t,e)&&jl(t)){return rl(t,n,0===n?t.initialPoints.length-1:0)}if(!t.isPathClosed&&Nl(o,t)&&!e.evt.ctrlKey&&!e.evt.metaKey)return!1;if(t.activePointId&&i.id===t.activePointId&&t.selected&&!t.transformMode){var l,c;const i=e.evt.ctrlKey||e.evt.metaKey||e.evt.shiftKey||e.evt.altKey,o=!0===t.isDrawingMode,s=null!=(l=null==(c=t.selectedPoints)?void 0:c.has(n))&&l;return!(i||!o||!s)&&(null==t.onFinish||t.onFinish(e),!0)}if(e.evt.ctrlKey||e.evt.metaKey){if(!t.skeletonEnabled&&!Pl(n,t.initialPoints))return!1;const e=t.selectedPoints,i=new Set(e);return i.add(n),r.selectPoints(t.instanceId||"unknown",i),!0}return(t.skeletonEnabled||!(!t.skeletonEnabled&&!Pl(n,t.initialPoints)))&&(r.selectPoints(t.instanceId||"unknown",new Set([n])),null==t.setActivePointId||t.setActivePointId(i.id),!0)}}return!1}function _l(e,t){var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(!i)return!1;const o=dl(i,t.transform,t.fitScale,t.x,t.y),s=t.transform.zoom*t.fitScale,a=Er/s,r=kl.getInstance();if(!r.canInstanceHaveSelection(t.instanceId||"unknown"))return!1;for(let e=0;e<t.initialPoints.length;e++)if(t.selectedPoints.has(e)){if(gl(o,t.initialPoints[e],a)){const n=new Set(t.selectedPoints);if(n.delete(e),r.selectPoints(t.instanceId||"unknown",n),n.size<=1&&t.skeletonEnabled&&t.initialPoints.length>0){const e=t.initialPoints[t.initialPoints.length-1];null==t.setLastAddedPointId||t.setLastAddedPointId(e.id),null==t.setActivePointId||t.setActivePointId(e.id)}return!0}}return!1}function Al(e,t){return{x:Math.max(0,Math.min(t.width,e.x)),y:Math.max(0,Math.min(t.height,e.y))}}function Il(e,t){if(0===e.length)return e;const n=function(e){if(0===e.length)return{left:0,top:0,right:0,bottom:0};let t=e[0].x,n=e[0].y,i=e[0].x,o=e[0].y;e[0].controlPoint1&&(t=Math.min(t,e[0].controlPoint1.x),n=Math.min(n,e[0].controlPoint1.y),i=Math.max(i,e[0].controlPoint1.x),o=Math.max(o,e[0].controlPoint1.y)),e[0].controlPoint2&&(t=Math.min(t,e[0].controlPoint2.x),n=Math.min(n,e[0].controlPoint2.y),i=Math.max(i,e[0].controlPoint2.x),o=Math.max(o,e[0].controlPoint2.y));for(let s=1;s<e.length;s++){const a=e[s];t=Math.min(t,a.x),n=Math.min(n,a.y),i=Math.max(i,a.x),o=Math.max(o,a.y),a.controlPoint1&&(t=Math.min(t,a.controlPoint1.x),n=Math.min(n,a.controlPoint1.y),i=Math.max(i,a.controlPoint1.x),o=Math.max(o,a.controlPoint1.y)),a.controlPoint2&&(t=Math.min(t,a.controlPoint2.x),n=Math.min(n,a.controlPoint2.y),i=Math.max(i,a.controlPoint2.x),o=Math.max(o,a.controlPoint2.y))}return{left:t,top:n,right:i,bottom:o}}(e.map(e=>({x:e.x,y:e.y})));let i=0,o=0;if(n.left<0&&(i=-n.left),n.right>t.width&&(i=t.width-n.right),n.top<0&&(o=-n.top),n.bottom>t.height&&(o=t.height-n.bottom),0===i&&0===o)return e;return e.map(e=>{const t=Object.assign({},e,{x:e.x+i,y:e.y+o});return e.controlPoint1&&(t.controlPoint1={x:e.controlPoint1.x+i,y:e.controlPoint1.y+o}),e.controlPoint2&&(t.controlPoint2={x:e.controlPoint2.x+i,y:e.controlPoint2.y+o}),t})}function Ml(e,t){return n=>{var i;if(e.disabled)return;t.current=!1;let o=!1;if(!0===n.evt.shiftKey&&e.cursorPosition&&e.initialPoints.length>=2){const t=e.transform.zoom*e.fitScale,i=Er/t;let r=!1;for(let t=0;t<e.initialPoints.length;t++){const n=e.initialPoints[t];if(Math.sqrt((e.cursorPosition.x-n.x)**2+(e.cursorPosition.y-n.y)**2)<=i){r=!0;break}}if(!r){const t=ml(e.cursorPosition,e.initialPoints,e.allowClose,e.isPathClosed);if(t){let i,r;if(e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY},t.segmentIndex===e.initialPoints.length){const t=e.initialPoints[e.initialPoints.length-1],n=e.initialPoints[0];i=t.id,r=n.id}else{var s,a;i=(null==(s=e.initialPoints[t.segmentIndex-1])?void 0:s.id)||"",r=(null==(a=e.initialPoints[t.segmentIndex])?void 0:a.id)||""}e.setGhostPointDragInfo({ghostPoint:{x:t.point.x,y:t.point.y,prevPointId:i,nextPointId:r},isDragging:!1,dragDistance:0}),e.disableInternalPointAddition||(o=!0)}}}if(e.selectedPoints.size>1&&!n.evt.shiftKey){var r;const i=null==(r=n.target.getStage())?void 0:r.getPointerPosition();if(i){const o=dl(i,e.transform,e.fitScale,e.x,e.y),s=e.transform.zoom*e.fitScale,a=Er/s;for(let i=0;i<e.initialPoints.length;i++){const s=e.initialPoints[i];if(Math.sqrt((o.x-s.x)**2+(o.y-s.y)**2)<=a)return n.evt.ctrlKey||n.evt.metaKey?void(t.current=!0):void 0}}return}if(e.isDrawingMode&&!e.isPathClosed&&e.selectedPoints.size<=1){if(n.evt.shiftKey)return e.isDragging.current=!0,e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY},void(document.body.style.cursor="grabbing");e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY},n.evt.shiftKey||(e.setIsDraggingNewBezier(!1),e.setNewPointDragIndex(null))}const l=null==(i=n.target.getStage())?void 0:i.getPointerPosition();if(l){const i=dl(l,e.transform,e.fitScale,e.x,e.y),o=e.transform.zoom*e.fitScale,s=Er/o;for(let o=0;o<e.initialPoints.length;o++){const a=e.initialPoints[o];if(Math.sqrt((i.x-a.x)**2+(i.y-a.y)**2)<=s)return n.evt.ctrlKey||n.evt.metaKey?void(t.current=!0):(e.setDraggedPointIndex(o),void(e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY,originalX:a.x,originalY:a.y,originalControlPoint1:a.isBezier?a.controlPoint1:void 0,originalControlPoint2:a.isBezier?a.controlPoint2:void 0}))}for(let t=0;t<e.initialPoints.length;t++){const o=e.initialPoints[t];if(o.isBezier){if(o.controlPoint1){if(Math.sqrt((i.x-o.controlPoint1.x)**2+(i.y-o.controlPoint1.y)**2)<=s)return e.setDraggedControlPoint({pointIndex:t,controlIndex:1}),e.isDragging.current=!0,null==e.handleTransformStart||e.handleTransformStart(),void(e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY,originalX:o.controlPoint1.x,originalY:o.controlPoint1.y})}if(o.controlPoint2){if(Math.sqrt((i.x-o.controlPoint2.x)**2+(i.y-o.controlPoint2.y)**2)<=s)return e.setDraggedControlPoint({pointIndex:t,controlIndex:2}),e.isDragging.current=!0,null==e.handleTransformStart||e.handleTransformStart(),void(e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY,originalX:o.controlPoint2.x,originalY:o.controlPoint2.y})}}}}if(n.evt.ctrlKey||n.evt.metaKey||!Tl(n,e)){if(1===n.evt.button||n.evt.shiftKey)return e.isDragging.current=!0,e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY},void(document.body.style.cursor="grabbing");if(t.current=!1,!n.evt.ctrlKey&&!n.evt.metaKey){if(kl.getInstance().selectPoints(e.instanceId||"unknown",new Set),e.skeletonEnabled&&e.initialPoints.length>0){const t=e.initialPoints[e.initialPoints.length-1];null==e.setLastAddedPointId||e.setLastAddedPointId(t.id)}}}}}function El(e,t){return n=>{var i,o,s,a,r,l;const c=null!==e.draggedPointIndex||null!==e.draggedControlPoint;if(e.disabled&&c)return e.setDraggedPointIndex(null),void e.setDraggedControlPoint(null);const d=null==(i=n.target.getStage())?void 0:i.getPointerPosition();if(!d)return;dl(d,e.transform,e.fitScale,e.x,e.y);if(!(!e.disableInternalPointAddition&&n.evt.shiftKey&&e.cursorPosition&&e.initialPoints.length>=2)||e.isDragging.current||e.isDraggingNewBezier||null!=(o=e.ghostPointDragInfo)&&o.isDragging)e.disableInternalPointAddition||n.evt.shiftKey||e.setGhostPoint(null);else{const t=e.transform.zoom*e.fitScale,n=Er/t;let i=!1;for(let t=0;t<e.initialPoints.length;t++){const o=e.initialPoints[t];if(Math.sqrt((e.cursorPosition.x-o.x)**2+(e.cursorPosition.y-o.y)**2)<=n){i=!0;break}}if(i)e.setGhostPoint(null);else{const t=ml(e.cursorPosition,e.initialPoints,e.allowClose,e.isPathClosed);if(t){const n=ul(t.point,e.pixelSnapping);if(t.segmentIndex===e.initialPoints.length){const t=e.initialPoints[e.initialPoints.length-1],i=e.initialPoints[0],o={x:n.x,y:n.y,prevPointId:t.id,nextPointId:i.id};e.setGhostPoint(o)}else{const i=e.initialPoints[t.segmentIndex],o=null!=i&&i.prevPointId?e.initialPoints.find(e=>e.id===i.prevPointId):null;if(i&&o){const t={x:n.x,y:n.y,prevPointId:o.id,nextPointId:i.id};e.setGhostPoint(t)}}}else e.setGhostPoint(null)}}if(e.isDragging.current&&e.lastPos.current&&null===e.draggedPointIndex&&null===e.draggedControlPoint)e.lastPos.current={x:n.evt.clientX,y:n.evt.clientY};else{if(null!=(s=e.ghostPointDragInfo)&&s.isDragging&&e.isDraggingNewBezier){var u,h;const t=dl(d,e.transform,e.fitScale,e.x,e.y);if(null!==e.newPointDragIndex&&e.cursorPosition){const t=e.newPointDragIndex,n=[...e.initialPoints],i=n[t];var g,m,p,f;if(i&&i.isBezier&&e.cursorPosition)n[t]=Object.assign({},i,{controlPoint1:{x:null==(g=e.cursorPosition)?void 0:g.x,y:null==(m=e.cursorPosition)?void 0:m.y},controlPoint2:{x:i.x-((null==(p=e.cursorPosition)?void 0:p.x)-i.x),y:i.y-((null==(f=e.cursorPosition)?void 0:f.y)-i.y)}}),null==e.onPointsChange||e.onPointsChange(n),null==e.onPointEdited||e.onPointEdited(n[t],t)}return void e.setGhostPointDragInfo(Object.assign({},e.ghostPointDragInfo,{dragDistance:Math.sqrt((t.x-(null==(u=e.ghostPointDragInfo)?void 0:u.ghostPoint.x))**2+(t.y-(null==(h=e.ghostPointDragInfo)?void 0:h.ghostPoint.y))**2)}))}if(null!==e.draggedPointIndex&&e.lastPos.current){var v,y,b,x;if(e.selectedPoints.size>1)return;const t=5,i=Math.abs(n.evt.clientX-(null==(v=e.lastPos.current)?void 0:v.x)),o=Math.abs(n.evt.clientY-(null==(y=e.lastPos.current)?void 0:y.y));if(!e.isDragging.current&&(i>t||o>t)&&(e.isDragging.current=!0,null==e.handleTransformStart||e.handleTransformStart()),!e.isDragging.current)return;const s=dl(d,e.transform,e.fitScale,e.x,e.y),a=[...e.initialPoints],r=a[e.draggedPointIndex],l=(null==(b=e.lastPos.current)?void 0:b.originalX)||r.x,c=(null==(x=e.lastPos.current)?void 0:x.originalY)||r.y,u=s.x-l,h=s.y-c,g=Il([ul(s,e.pixelSnapping)],{width:e.width,height:e.height})[0];if(a[e.draggedPointIndex]=Object.assign({},r,{x:g.x,y:g.y}),r.isBezier){var w,S;const t=a[e.draggedPointIndex];if(null!=(w=e.lastPos.current)&&w.originalControlPoint1){const n=ul({x:e.lastPos.current.originalControlPoint1.x+u,y:e.lastPos.current.originalControlPoint1.y+h},e.pixelSnapping);t.controlPoint1={x:n.x,y:n.y}}if(null!=(S=e.lastPos.current)&&S.originalControlPoint2){const n=ul({x:e.lastPos.current.originalControlPoint2.x+u,y:e.lastPos.current.originalControlPoint2.y+h},e.pixelSnapping);t.controlPoint2={x:n.x,y:n.y}}const n=Il([t],{width:e.width,height:e.height})[0];t.x=n.x,t.y=n.y}return null==e.onPointsChange||e.onPointsChange(a),void(null==e.onPointRepositioned||e.onPointRepositioned(a[e.draggedPointIndex],e.draggedPointIndex))}if(e.draggedControlPoint&&!e.isDraggingNewBezier){if(e.selectedPoints.size>1)return;const t=dl(d,e.transform,e.fitScale,e.x,e.y),{pointIndex:i,controlIndex:o}=e.draggedControlPoint,s=[...e.initialPoints],a=s[i];if(a.isBezier){const r=ul(t,e.pixelSnapping);if(n.evt.altKey&&(a.disconnected=!0),1===o&&a.controlPoint1){const n=Object.assign({},a,{controlPoint1:{x:r.x,y:r.y}});if(!a.disconnected&&a.controlPoint2){const i=t.x-a.x,o=t.y-a.y,s=ul({x:a.x-i,y:a.y-o},e.pixelSnapping);n.controlPoint2={x:s.x,y:s.y}}s[i]=n}else if(2===o&&a.controlPoint2){const n=Object.assign({},a,{controlPoint2:{x:r.x,y:r.y}});if(!a.disconnected&&a.controlPoint1){const i=t.x-a.x,o=t.y-a.y,s=ul({x:a.x-i,y:a.y-o},e.pixelSnapping);n.controlPoint1={x:s.x,y:s.y}}s[i]=n}null==e.onPointsChange||e.onPointsChange(s),null==e.onPointEdited||e.onPointEdited(a,i)}return}if(e.isDrawingMode&&!e.isPathClosed&&e.selectedPoints.size<=1&&e.lastPos.current&&!n.evt.shiftKey&&e.allowBezier&&(null==(a=e.pointCreationManager)||!a.isCreating())){const i=Math.sqrt((n.evt.clientX-e.lastPos.current.x)**2+(n.evt.clientY-e.lastPos.current.y)**2);if(e.isDraggingNewBezier)pl(e);else if(i>15){const i=n.target.getStage(),o=null==i?void 0:i.getPointerPosition();o&&function(e,t,n){if(!e.allowBezier)return!1;const i=dl(t,e.transform,e.fitScale,e.x,e.y),o=e.initialPoints.length,s=function(e,t,n,i,o,s=!1){return!!e.pointCreationManager&&e.pointCreationManager.createBezierPointAt(t,n,i,o,void 0,s)}(e,i.x,i.y);!!s&&(e.setNewPointDragIndex(o),e.setIsDraggingNewBezier(!0),n.current=!0)}(e,o,t)}}if(e.ghostPointDragInfo&&!e.ghostPointDragInfo.isDragging&&n.evt.shiftKey&&e.allowBezier){const n=dl(d,e.transform,e.fitScale,e.x,e.y),i=Math.sqrt((n.x-e.ghostPointDragInfo.ghostPoint.x)**2+(n.y-e.ghostPointDragInfo.ghostPoint.y)**2);if(i>5){if(!e.disableInternalPointAddition){const i=e.ghostPointDragInfo.ghostPoint,o=e.initialPoints.find(e=>e.id===i.prevPointId),s=e.initialPoints.find(e=>e.id===i.nextPointId);if(o&&s){var C;const a=ul(n,e.pixelSnapping),r={x:a.x,y:a.y},l={x:i.x-(a.x-i.x),y:i.y-(a.y-i.y)},c=(null==(C=e.pointCreationManager)?void 0:C.insertPointBetween(i.x,i.y,o.id,s.id,al.BEZIER,r,l))||{success:!1};c.success&&void 0!==c.newPointIndex&&(e.setNewPointDragIndex(c.newPointIndex),e.setIsDraggingNewBezier(!0),t.current=!0)}}e.setGhostPointDragInfo(Object.assign({},e.ghostPointDragInfo,{isDragging:!0,dragDistance:i})),e.setGhostPoint(null)}}else if(null!=(r=e.ghostPointDragInfo)&&r.isDragging&&e.isDraggingNewBezier){if(!e.disableInternalPointAddition){dl(d,e.transform,e.fitScale,e.x,e.y);pl(e)}const t=dl(d,e.transform,e.fitScale,e.x,e.y);e.setGhostPointDragInfo(Object.assign({},e.ghostPointDragInfo,{dragDistance:Math.sqrt((t.x-e.ghostPointDragInfo.ghostPoint.x)**2+(t.y-e.ghostPointDragInfo.ghostPoint.y)**2)}))}else if(null!=(l=e.ghostPointDragInfo)&&l.isDragging&&!e.isDraggingNewBezier){const t=dl(d,e.transform,e.fitScale,e.x,e.y),n=Math.sqrt((t.x-e.ghostPointDragInfo.ghostPoint.x)**2+(t.y-e.ghostPointDragInfo.ghostPoint.y)**2);e.setGhostPointDragInfo(Object.assign({},e.ghostPointDragInfo,{dragDistance:n}))}}}}function Kl(e){return t=>{var n,i;const o=null==(n=e.ghostPointDragInfo)?void 0:n.isDragging,s=null!==e.newPointDragIndex;if(o&&s&&null!==e.newPointDragIndex&&e.setVisibleControlPoints(new Set([e.newPointDragIndex])),null!==e.draggedPointIndex&&!e.isDragging.current){const n=e.draggedPointIndex;if(Rl(n,e,t)&&jl(e)){const i=n,o=0===n?e.initialPoints.length-1:0;rl(e,i,o)||Ll(n,e,t)}else Ll(n,e,t)}if((e.isDragging.current||null!==e.draggedPointIndex||null!==e.draggedControlPoint)&&(null==e.handleTransformEnd||e.handleTransformEnd(t)),e.isDragging.current=!1,e.setDraggedPointIndex(null),e.setDraggedControlPoint(null),e.setNewPointDragIndex(null),e.setIsDraggingNewBezier(!1),document.body.style.cursor="default",e.lastPos.current&&(null==e.notifyTransformationComplete||e.notifyTransformationComplete(),e.lastPos.current=null),!e.disableInternalPointAddition&&o&&null!=(i=e.ghostPointDragInfo)&&i.ghostPoint){const{ghostPoint:t,dragDistance:n}=e.ghostPointDragInfo;if(s)null!==e.newPointDragIndex&&e.setVisibleControlPoints(new Set([e.newPointDragIndex]));else if(n>5){const i={x:t.x,y:t.y,segmentIndex:e.initialPoints.findIndex(e=>e.id===t.nextPointId)},o=function(e,t,n){return!!e.pointCreationManager&&e.pointCreationManager.createPointFromGhostDrag(t,n)}(e,i,n);var a;if(o)void 0!==(null==(a=e.lastCallbackTime)?void 0:a.current)&&(e.lastCallbackTime.current=Date.now())}}e.ghostPointDragInfo&&e.setGhostPointDragInfo(null)}}function Dl(e,t){return n=>{var i,o,s;if(n.evt.shiftKey&&!n.evt.altKey&&cl(n,e))return;if(n.evt.shiftKey&&!n.evt.altKey&&(e.cursorPosition&&!e.isDraggingNewBezier&&(null==(s=e.ghostPointDragInfo)||!s.isDragging)&&!e.isDragging.current)){const t=e.ghostPoint;if(t){if(Math.sqrt((e.cursorPosition.x-t.x)**2+(e.cursorPosition.y-t.y)**2)<=15/(e.transform.zoom*e.fitScale)){if(e.disableInternalPointAddition&&e.onGhostPointClick)return void e.onGhostPointClick({x:t.x,y:t.y,prevPointId:t.prevPointId,nextPointId:t.nextPointId});if(!e.disableInternalPointAddition){const n=function(e,t,n,i,o,s=al.REGULAR,a,r){return e.pointCreationManager?e.pointCreationManager.insertPointBetween(t,n,i,o,s,a,r):{success:!1}}(e,t.x,t.y,t.prevPointId,t.nextPointId);if(n.success)return void e.setGhostPoint(null)}}}}if(n.evt.altKey&&!n.evt.shiftKey){var a;const t=null==(a=n.target.getStage())?void 0:a.getPointerPosition();if(t){const i=dl(t,e.transform,e.fitScale,e.x,e.y),o=e.transform.zoom*e.fitScale,s=Er/o;for(let t=0;t<e.initialPoints.length;t++){const o=e.initialPoints[t];if(Math.sqrt((i.x-o.x)**2+(i.y-o.y)**2)<=s)return Cl(t,e.initialPoints,e.selectedPointIndex,e.setSelectedPointIndex,e.setVisibleControlPoints,e.onPointSelected,e.onPointRemoved,e.onPointsChange,e.setLastAddedPointId,e.lastAddedPointId),n.evt.stopPropagation(),n.evt.preventDefault(),void(n.cancelBubble=!0)}const a=15/o,r=ml(i,e.initialPoints,e.allowClose,e.isPathClosed);if(r&&hl(i,r.point)<=a)if(e.isPathClosed&&e.allowClose){if(function(e,t){if(!e.allowClose||e.initialPoints.length<3)return!1;if(!e.isPathClosed)return!1;const n=e.initialPoints[0],i=e.initialPoints[e.initialPoints.length-1];if(void 0===t){const t=[...e.initialPoints];return t[0]=Object.assign({},n,{prevPointId:void 0}),null==e.onPointsChange||e.onPointsChange(t),e.setIsPathClosed(!1),!0}let o=[...e.initialPoints];if(t===e.initialPoints.length)o[0]=Object.assign({},n,{prevPointId:void 0});else{if(!(t>=0&&t<e.initialPoints.length))return!1;{const n=o[t];if(0===t&&n.prevPointId===i.id?o[0]=Object.assign({},n,{prevPointId:void 0}):o[t]=Object.assign({},n,{prevPointId:void 0}),0!==t||n.prevPointId!==i.id){const n=t,i=[...o.slice(n),...o.slice(0,n)];o=i.map((e,t)=>0===t?Object.assign({},e,{prevPointId:void 0}):Object.assign({},e,{prevPointId:i[t-1].id}));const s=o[o.length-1];null==e.setActivePointId||e.setActivePointId(s.id),null==e.setLastAddedPointId||e.setLastAddedPointId(s.id)}else{const t=o[o.length-1];null==e.setActivePointId||e.setActivePointId(t.id),null==e.setLastAddedPointId||e.setLastAddedPointId(t.id)}}}return null==e.onPointsChange||e.onPointsChange(o),e.setIsPathClosed(!1),!0}(e,r.segmentIndex))return n.evt.stopPropagation(),n.evt.preventDefault(),void(n.cancelBubble=!0)}else{const t=r.segmentIndex;if(t>=0&&t<e.initialPoints.length){if(e.initialPoints[t].prevPointId){const i=e.initialPoints.map((e,n)=>n===t?Object.assign({},e,{prevPointId:void 0}):e);return null==e.onPointsChange||e.onPointsChange(i),n.evt.stopPropagation(),n.evt.preventDefault(),void(n.cancelBubble=!0)}}}}}if(t.current)return void(t.current=!1);if(Tl(n,e))return;const r=null==(i=n.target.getStage())?void 0:i.getPointerPosition();if(r){const t=dl(r,e.transform,e.fitScale,e.x,e.y),n=e.transform.zoom*e.fitScale,i=Er/n;for(let n=0;n<e.initialPoints.length;n++){const o=e.initialPoints[n];if(Math.sqrt((t.x-o.x)**2+(t.y-o.y)**2)<=i)return}}!e.disableInternalPointAddition&&e.isDrawingMode&&!e.isPathClosed&&e.selectedPoints.size<=1&&(null==(o=e.pointCreationManager)||!o.isCreating())&&ll(n,e)||t.current&&(t.current=!1)}}function Ol(e){const t=new Set,n=new Set;return e.forEach(e=>{e.prevPointId&&n.add(e.prevPointId)}),e.forEach((e,i)=>{e.prevPointId&&n.has(e.id)||t.add(i)}),t}function Ll(e,t,n){if(!t.transformMode&&t.activePointId&&e<t.initialPoints.length&&!(n.evt.ctrlKey||n.evt.shiftKey||n.evt.metaKey||n.evt.altKey)){if(t.initialPoints[e].id===t.activePointId){var i,o;const s=!0===t.isDrawingMode,a=null!=(i=null==(o=t.selectedPoints)?void 0:o.has(e))&&i;if(s&&a)return void(null==t.onFinish||t.onFinish(n))}}if(!t.skeletonEnabled){if(!Ol(t.initialPoints).has(e))return}if(kl.getInstance().selectPoints(t.instanceId||"unknown",new Set([e])),e>=0&&e<t.initialPoints.length){const n=t.initialPoints[e];(t.skeletonEnabled||Ol(t.initialPoints).has(e))&&(null==t.setActivePointId||t.setActivePointId(n.id))}}kl.instance=null;class zl{constructor(){this.state={isCreating:!1,startX:0,startY:0,currentPointIndex:null,isBezier:!1,hasCreatedPoint:!1},this.props=null}setProps(e){this.props=e}startPoint(e,t){if(!this.props||this.state.isCreating)return!1;if(this.props.selectedPoints&&this.props.selectedPoints.size>1)return!1;if(this.props.canAddMorePoints&&!this.props.canAddMorePoints())return!1;const n=ul({x:e,y:t},this.props.pixelSnapping);if(this.props.width&&this.props.height&&(n.x<0||n.x>this.props.width||n.y<0||n.y>this.props.height))return!1;if(this.props.initialPoints.length>0&&this.props.transform&&void 0!==this.props.fitScale){const e=this.props.transform.zoom*this.props.fitScale,t=Er/e;for(const e of this.props.initialPoints){if(hl(n,e)<=t)return!1}}return this.state={isCreating:!0,startX:n.x,startY:n.y,currentPointIndex:null,isBezier:!1,hasCreatedPoint:!1},!0}updatePoint(e,t){if(!this.props||!this.state.isCreating)return!1;if(this.props.selectedPoints&&this.props.selectedPoints.size>1)return!1;const n=ul({x:e,y:t},this.props.pixelSnapping);if(this.props.width&&this.props.height&&(n.x<0||n.x>this.props.width||n.y<0||n.y>this.props.height))return!1;const i=Math.sqrt((n.x-this.state.startX)**2+(n.y-this.state.startY)**2);if(!this.state.hasCreatedPoint&&null===this.state.currentPointIndex&&i>5&&this.props.allowBezier){const e=this.createBezierPoint(this.state.startX,this.state.startY);null!==e&&(this.state.currentPointIndex=e,this.state.isBezier=!0,this.state.hasCreatedPoint=!0)}return null!==this.state.currentPointIndex&&this.state.isBezier&&this.updateBezierControlPoints(n.x,n.y),!0}commitPoint(e,t){if(!this.props||!this.state.isCreating)return!1;if(this.props.selectedPoints&&this.props.selectedPoints.size>1)return!1;let n,i,o=e,s=t,a=!1;this.props.isShiftKeyHeld&&this.props.ghostPoint&&(o=this.props.ghostPoint.x,s=this.props.ghostPoint.y,a=!0,n=this.props.ghostPoint.prevPointId,i=this.props.ghostPoint.nextPointId);const r=ul({x:o,y:s},this.props.pixelSnapping);if(this.props.width&&this.props.height&&(r.x<0||r.x>this.props.width||r.y<0||r.y>this.props.height))return!1;if(a&&n&&i){this.state={isCreating:!1,startX:0,startY:0,currentPointIndex:null,isBezier:!1,hasCreatedPoint:!1},this.props.setNewPointDragIndex&&this.props.setNewPointDragIndex(null),this.props.setIsDraggingNewBezier&&this.props.setIsDraggingNewBezier(!1);const e=this.insertPointBetween(r.x,r.y,n,i,al.REGULAR);return e.success&&this.props.setGhostPoint&&this.props.setGhostPoint(null),e.success}return this.state.hasCreatedPoint?null!==this.state.currentPointIndex&&this.state.isBezier&&(this.updateBezierControlPoints(r.x,r.y),this.props.setVisibleControlPoints&&null!==this.state.currentPointIndex&&this.props.setVisibleControlPoints(new Set([this.state.currentPointIndex]))):this.createRegularPoint(r.x,r.y),this.state={isCreating:!1,startX:0,startY:0,currentPointIndex:null,isBezier:!1,hasCreatedPoint:!1},this.props.setNewPointDragIndex&&this.props.setNewPointDragIndex(null),this.props.setIsDraggingNewBezier&&this.props.setIsDraggingNewBezier(!1),!0}createRegularPointAt(e,t,n){if(!this.props)return!1;if(this.props.canAddMorePoints&&!this.props.canAddMorePoints())return!1;const i=ul({x:e,y:t},this.props.pixelSnapping);if(this.props.width&&this.props.height&&(i.x<0||i.x>this.props.width||i.y<0||i.y>this.props.height))return!1;return null!==this.createRegularPoint(i.x,i.y,n)}createBezierPointAt(e,t,n,i,o,s=!1){if(!this.props||!this.props.allowBezier)return!1;if(this.props.canAddMorePoints&&!this.props.canAddMorePoints())return!1;const a=ul({x:e,y:t},this.props.pixelSnapping);if(this.props.width&&this.props.height&&(a.x<0||a.x>this.props.width||a.y<0||a.y>this.props.height))return!1;return null!==this.createBezierPointWithControls(a.x,a.y,n,i,o,s)}insertPointBetween(e,t,n,i,o=al.REGULAR,s,a){if(!this.props)return{success:!1};if(this.props.canAddMorePoints&&!this.props.canAddMorePoints())return{success:!1};const r=ul({x:e,y:t},this.props.pixelSnapping);return this.props.width&&this.props.height&&(r.x<0||r.x>this.props.width||r.y<0||r.y>this.props.height)?{success:!1}:o!==al.BEZIER||this.props.allowBezier?this.insertPointBetweenUtil(r.x,r.y,n,i,o,s,a):{success:!1}}createPointFromGhostDrag(e,t){if(!this.props)return!1;if(this.props.canAddMorePoints&&!this.props.canAddMorePoints())return!1;const n=e.segmentIndex,i=this.props.initialPoints[n],o=n>0?this.props.initialPoints[n-1]:null;if(!i||!o)return!1;const s={x:e.x-.5*t,y:e.y-.5*t},a={x:e.x+.5*t,y:e.y+.5*t};return this.insertPointBetween(e.x,e.y,o.id,i.id,al.BEZIER,s,a).success}createRegularPoint(e,t,n){var i,o,s,a,r,l,c,d;if(!this.props)return null;let u=n;u||(this.props.activePointId?u=this.props.activePointId:this.props.skeletonEnabled&&this.props.lastAddedPointId?u=this.props.lastAddedPointId:this.props.initialPoints.length>0&&(u=this.props.initialPoints[this.props.initialPoints.length-1].id));const h={x:e,y:t,id:Jr(),prevPointId:u,isBezier:!1},g=this.props.initialPoints.length,m=[...this.props.initialPoints,h];return null==(i=(o=this.props).onPointAdded)||i.call(o,h,g),null==(s=(a=this.props).setLastAddedPointId)||s.call(a,h.id),null==(r=(l=this.props).setActivePointId)||r.call(l,h.id),null==(c=(d=this.props).onPointsChange)||c.call(d,m),g}createBezierPoint(e,t){var n,i,o,s,a,r,l,c;if(!this.props||!this.props.allowBezier)return null;let d;this.props.activePointId?d=this.props.activePointId:this.props.skeletonEnabled&&this.props.lastAddedPointId?d=this.props.lastAddedPointId:this.props.initialPoints.length>0&&(d=this.props.initialPoints[this.props.initialPoints.length-1].id);const u={x:e+20,y:t+20},h=ul({x:e-20,y:t-20},this.props.pixelSnapping),g=ul(u,this.props.pixelSnapping),m={x:e,y:t,id:Jr(),prevPointId:d,isBezier:!0,controlPoint1:h,controlPoint2:g,disconnected:!1},p=this.props.initialPoints.length,f=[...this.props.initialPoints,m];return null==(n=(i=this.props).onPointAdded)||n.call(i,m,p),null==(o=(s=this.props).setLastAddedPointId)||o.call(s,m.id),null==(a=(r=this.props).setActivePointId)||a.call(r,m.id),null==(l=(c=this.props).onPointsChange)||l.call(c,f),this.props.setNewPointDragIndex&&this.props.setNewPointDragIndex(p),this.props.setIsDraggingNewBezier&&this.props.setIsDraggingNewBezier(!0),p}createBezierPointWithControls(e,t,n,i,o,s=!1){var a,r,l,c,d,u,h,g;if(!this.props||!this.props.allowBezier)return null;let m=o;m||(this.props.activePointId?m=this.props.activePointId:this.props.skeletonEnabled&&this.props.lastAddedPointId?m=this.props.lastAddedPointId:this.props.initialPoints.length>0&&(m=this.props.initialPoints[this.props.initialPoints.length-1].id));const p=i||{x:e+20,y:t+20},f=ul(n||{x:e-20,y:t-20},this.props.pixelSnapping),v=ul(p,this.props.pixelSnapping),y={x:e,y:t,id:Jr(),prevPointId:m,isBezier:!0,controlPoint1:f,controlPoint2:v,disconnected:s},b=this.props.initialPoints.length,x=[...this.props.initialPoints,y];return null==(a=(r=this.props).onPointAdded)||a.call(r,y,b),null==(l=(c=this.props).setLastAddedPointId)||l.call(c,y.id),null==(d=(u=this.props).setActivePointId)||d.call(u,y.id),null==(h=(g=this.props).onPointsChange)||h.call(g,x),this.props.setVisibleControlPoints&&this.props.setVisibleControlPoints(new Set([b])),b}insertPointBetweenUtil(e,t,n,i,o=al.REGULAR,s,a){var r,l,c,d,u,h;if(!this.props)return{success:!1};const g={};if(o===al.BEZIER){g.isBezier=!0;const n=a||{x:e+20,y:t+20},i=ul(s||{x:e-20,y:t-20},this.props.pixelSnapping),o=ul(n,this.props.pixelSnapping);g.controlPoint1=i,g.controlPoint2=o}const m=Object.assign({x:e,y:t,id:Jr(),prevPointId:n},g),p=this.insertPointBetweenHelper(this.props.initialPoints,n,i,m),f=p.findIndex(n=>n.x===e&&n.y===t&&n.isBezier===(o===al.BEZIER));var v,y;-1!==f&&(null==(v=(y=this.props).onPointAdded)||v.call(y,m,f));return null==(r=(l=this.props).onPointsChange)||r.call(l,p),null==(c=(d=this.props).setActivePointId)||c.call(d,m.id),null==(u=(h=this.props).setVisibleControlPoints)||u.call(h,new Set),{success:!0,newPointIndex:f}}insertPointBetweenHelper(e,t,n,i){const o=[...e],s=o.findIndex(e=>e.id===n);return-1===s?e:(i.prevPointId=t,o[s]=Object.assign({},o[s],{prevPointId:i.id}),o.splice(s,0,i),o)}updateBezierControlPoints(e,t){if(!this.props||null===this.state.currentPointIndex)return;const n=[...this.props.initialPoints],i=n[this.state.currentPointIndex];if(i&&i.isBezier){var o,s,a,r;const l=e-i.x,c=t-i.y,d=Math.sqrt(l*l+c*c),u=l/d,h=c/d,g={x:i.x+u*d,y:i.y+h*d},m={x:i.x-u*d,y:i.y-h*d},p=ul(g,this.props.pixelSnapping),f=ul(m,this.props.pixelSnapping);n[this.state.currentPointIndex]=Object.assign({},i,{controlPoint1:{x:p.x,y:p.y},controlPoint2:{x:f.x,y:f.y}}),null==(o=(s=this.props).onPointsChange)||o.call(s,n),null==(a=(r=this.props).onPointEdited)||a.call(r,n[this.state.currentPointIndex],this.state.currentPointIndex)}}isCreating(){return this.state.isCreating}reset(){this.state={isCreating:!1,startX:0,startY:0,currentPointIndex:null,isBezier:!1,hasCreatedPoint:!1}}}function Bl(e,t,n,i){let o=Math.min(e.x,i.x),s=Math.max(e.x,i.x),a=Math.min(e.y,i.y),r=Math.max(e.y,i.y);const l=3*(t.x-e.x),c=3*(n.x-t.x)-l,d=i.x-e.x-l-c,u=3*(t.y-e.y),h=3*(n.y-t.y)-u,g=i.y-e.y-u-h,m=Fl(c,2*l,d);for(const a of m)if(a>=0&&a<=1){const r=e.x+a*(3*(t.x-e.x)+a*(3*(n.x-2*t.x+e.x)+a*(i.x-3*n.x+3*t.x-e.x)));o=Math.min(o,r),s=Math.max(s,r)}const p=Fl(h,2*u,g);for(const o of p)if(o>=0&&o<=1){const s=e.y+o*(3*(t.y-e.y)+o*(3*(n.y-2*t.y+e.y)+o*(i.y-3*n.y+3*t.y-e.y)));a=Math.min(a,s),r=Math.max(r,s)}return{left:o,top:a,right:s,bottom:r}}function Fl(e,t,n){if(Math.abs(e)<1e-10)return Math.abs(t)<1e-10?[]:[-n/t];const i=t*t-4*e*n;if(i<0)return[];const o=Math.sqrt(i),s=[],a=(-t+o)/(2*e);a>=0&&a<=1&&s.push(a);const r=(-t-o)/(2*e);return r>=0&&r<=1&&s.push(r),s}function Hl(e){if(0===e.length)return{left:0,top:0,right:0,bottom:0};let t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(let s=0;s<e.length;s++){const a=e[s],r=e[(s+1)%e.length];if(t=Math.min(t,a.x),n=Math.min(n,a.y),i=Math.max(i,a.x),o=Math.max(o,a.y),a.isBezier&&a.controlPoint1&&a.controlPoint2){const e=Bl({x:a.x,y:a.y},{x:a.controlPoint1.x,y:a.controlPoint1.y},{x:a.controlPoint2.x,y:a.controlPoint2.y},{x:r.x,y:r.y});t=Math.min(t,e.left),n=Math.min(n,e.top),i=Math.max(i,e.right),o=Math.max(o,e.bottom)}}return{left:t,top:n,right:i,bottom:o}}function Vl(e){const t=new Set,n=new Set;return e.forEach(e=>{e.prevPointId&&n.add(e.prevPointId)}),e.forEach((e,i)=>{e.prevPointId&&n.has(e.id)||t.add(i)}),t}const $l=(0,f.forwardRef)((e,t)=>{const n=(0,f.useMemo)(()=>`konva-vector-${Math.random().toString(36).substr(2,9)}`,[]),i=(0,f.useRef)(!1),{initialPoints:o=[],onPointsChange:s,onPointAdded:a,onPointRemoved:r,onPointEdited:l,onPointRepositioned:c,onPointConverted:d,onPathShapeChanged:u,onPathClosedChange:h,onTransformationComplete:g,onPointSelected:m,onFinish:p,onGhostPointClick:v,scaleX:y,scaleY:b,x,y:w,imageSmoothingEnabled:S=!1,transform:C=kr,fitScale:k=Pr,width:P,height:R,onMouseDown:j,onMouseMove:N,onMouseUp:T,onClick:_,onDblClick:A,onTransformStart:I,onTransformEnd:M,onMouseEnter:E,onMouseLeave:K,allowClose:D=!1,closed:O,allowBezier:L=!0,minPoints:z,maxPoints:B,skeletonEnabled:F=!1,format:H=ol.REGULAR,stroke:V=jr,fill:$=Nr,pixelSnapping:W=!1,selected:U=!0,disabled:G=!1,transformMode:Y=!1,isMultiRegionSelected:X=!1,disableInternalPointAddition:q=!1,disableGhostLine:Z=!1,pointRadius:J,pointFill:Q=Tr,pointStroke:ee=_r,pointStrokeSelected:te=Ar,pointStrokeWidth:ne=Ir,pointStyle:ie="circle"}=e,[oe,se]=(0,f.useState)(()=>Qr(o)),re=(0,f.useRef)(oe),le=(0,f.useRef)(null);(0,f.useEffect)(()=>{re.current=oe},[oe]);const ce=(0,f.useRef)(!1),de=(0,f.useRef)(oe),ue=(0,f.useRef)(null),he=(0,f.useCallback)((e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++){const i=e[n],o=t[n];if(i.x!==o.x||i.y!==o.y||i.isBezier!==o.isBezier||i.disconnected!==o.disconnected||i.isBranching!==o.isBranching)return!1;if(i.isBezier){if(!!i.controlPoint1!=!!o.controlPoint1)return!1;if(!!i.controlPoint2!=!!o.controlPoint2)return!1;if(i.controlPoint1&&o.controlPoint1&&(i.controlPoint1.x!==o.controlPoint1.x||i.controlPoint1.y!==o.controlPoint1.y))return!1;if(i.controlPoint2&&o.controlPoint2&&(i.controlPoint2.x!==o.controlPoint2.x||i.controlPoint2.y!==o.controlPoint2.y))return!1}}return!0},[]);(0,f.useEffect)(()=>{if(ce.current)return;const e=Qr(o);ue.current&&he(ue.current,e)?ue.current=null:he(de.current,e)||(de.current=e,se(e))},[o,he]),(0,f.useEffect)(()=>{if(oe.length>0){const e=oe[oe.length-1];be(e.id),Xe&&oe.find(e=>e.id===Xe)||qe(e.id)}},[oe.length,F]);const[ge,me]=(0,f.useState)(null),[pe,fe]=(0,f.useState)(new Set),ve=(0,f.useMemo)(()=>Y&&oe.length>0?new Set(Array.from({length:oe.length},(e,t)=>t)):pe,[Y,oe.length,pe]),[ye,be]=(0,f.useState)(null),xe=((0,f.useRef)(null),(0,f.useRef)(null)),we=(0,f.useRef)({});(0,f.useRef)({}),(0,f.useRef)(Rr);(0,f.useEffect)(()=>{const e=e=>{e.shiftKey&&(Pe(!0),Ke(!0),setTimeout(()=>{ft.current&&ft.current(!0)},0))},t=e=>{e.shiftKey||(Pe(!1),Ke(!1),Oe(null))};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[]);const[Se,Ce]=(0,f.useState)(null),[ke,Pe]=(0,f.useState)(!1),[Re,je]=(0,f.useState)(null),[Ne,Te]=(0,f.useState)(!1),_e=(0,f.useRef)(null),Ae=(0,f.useRef)([]),Ie=(0,f.useRef)(!1),Me=(0,f.useRef)(0),[Ee,Ke]=(0,f.useState)(!1),[De,Oe]=(0,f.useState)(null);(0,f.useEffect)(()=>{(G||!U||void 0!==B&&oe.length>=B)&&Oe(null)},[G,U,B,oe.length]);const[Le,ze]=(0,f.useState)(null),[Be,Fe]=(0,f.useState)(!1),[He,Ve]=(0,f.useState)(null),$e=(0,f.useRef)(null),We=(0,f.useRef)(null),Ue=(0,f.useRef)(0),[Ge,Ye]=(0,f.useState)(new Set),[Xe,qe]=(0,f.useState)(null),[Ze,Je]=(0,f.useState)(!1),Qe=(0,f.useRef)(!1),et=(0,f.useRef)(null),tt=(0,f.useRef)(null),nt=(0,f.useRef)(!1),it=(0,f.useRef)(!1),ot=(0,f.useCallback)(()=>{it.current||(it.current=!0,null==I||I())},[I]),st=(0,f.useCallback)(e=>{it.current&&(it.current=!1,null==M||M(e))},[M]),at=(0,f.useRef)(null),rt=(0,f.useCallback)(()=>{if(!X||!et.current||!at.current)return;const e=et.current,t=e.x(),n=e.y(),i=e.scaleX(),o=e.scaleY(),a=e.rotation(),r=at.current,l=t-r.x,c=n-r.y,d=i/r.scaleX,u=o/r.scaleY,h=a-r.rotation,g=P||0,m=R||0;let p=l,f=c;const v=d,y=u;if(g>0&&m>0){const e=oe.map(e=>e.x),t=oe.map(e=>e.y),n=Math.min(...e)*d+l,i=Math.max(...e)*d+l,o=Math.min(...t)*u+c,s=Math.max(...t)*u+c;n<0&&(p=l-n),i>g&&(p=l-(i-g)),o<0&&(f=c-o),s>m&&(f=c-(s-m))}const b=h*(Math.PI/180),x=Math.cos(b),w=Math.sin(b),S=oe.map(e=>{const t=e.x*v,n=e.y*y,i=t*x-n*w,o=t*w+n*x,s=ul({x:Math.max(0,Math.min(g,i+p)),y:Math.max(0,Math.min(m,o+f))},W),a=Object.assign({},e,{x:s.x,y:s.y});if(e.isBezier){if(e.controlPoint1){const t=e.controlPoint1.x*v,n=e.controlPoint1.y*y,i=t*x-n*w,o=t*w+n*x,s={x:Math.max(0,Math.min(g,i+p)),y:Math.max(0,Math.min(m,o+f))};a.controlPoint1=ul(s,W)}if(e.controlPoint2){const t=e.controlPoint2.x*v,n=e.controlPoint2.y*y,i=t*x-n*w,o=t*w+n*x,s={x:Math.max(0,Math.min(g,i+p)),y:Math.max(0,Math.min(m,o+f))};a.controlPoint2=ul(s,W)}}return a});null==s||s(S),e.x(0),e.y(0),e.scaleX(1),e.scaleY(1),e.rotation(0),at.current={x:0,y:0,scaleX:1,scaleY:1,rotation:0};const C=e.getStage();if(C){const e=C.findOne("Transformer");if(e){const t=e.nodes(),n=t.length>1;setTimeout(()=>{e.nodes([]),C.batchDraw(),setTimeout(()=>{e.nodes(t),C.batchDraw()},0)},n?50:0)}}},[X,oe,P,R,s]);(0,f.useEffect)(()=>{if(X&&et.current&&!at.current){const e=et.current;at.current={x:e.x(),y:e.y(),scaleX:e.scaleX(),scaleY:e.scaleY(),rotation:e.rotation()}}else X||(at.current=null)},[X]);const lt=(0,f.useMemo)(()=>new zl,[]),ct=(0,f.useMemo)(()=>kl.getInstance(),[]),dt=(0,f.useMemo)(()=>{if(!D||oe.length<2)return!1;const e=oe[0],t=oe[oe.length-1];return e.prevPointId===t.id},[D,oe]),ut=D&&void 0!==O?O:dt;(0,f.useEffect)(()=>{if(D&&oe.length>=2){oe[0],oe[oe.length-1]}},[D,oe,dt,ut]);const ht=(0,f.useCallback)(e=>{D&&(null==h||h(e))},[D,h]),gt=(0,f.useRef)(!1),[mt,pt]=(0,f.useState)(0),ft=(0,f.useRef)(null),vt=(0,f.useRef)(null),yt=(0,f.useRef)(!1),bt=(0,f.useRef)({initialPoints:oe,effectiveSelectedPoints:ve,allowClose:D,finalIsPathClosed:ut,pixelSnapping:W,isDraggingNewBezier:Be,ghostPointDragInfo:He,draggedPointIndex:Se,draggedControlPoint:Re,isDraggingShape:Ne,instanceId:n,transform:C,fitScale:k,x,y:w,width:P,height:R,skeletonEnabled:F,activePointId:Xe,lastAddedPointId:ye,selected:U,disabled:G,onFinish:p,isShiftKeyHeld:ke});bt.current={initialPoints:oe,effectiveSelectedPoints:ve,allowClose:D,finalIsPathClosed:ut,pixelSnapping:W,isDraggingNewBezier:Be,ghostPointDragInfo:He,draggedPointIndex:Se,draggedControlPoint:Re,isDraggingShape:Ne,instanceId:n,transform:C,fitScale:k,x,y:w,width:P,height:R,skeletonEnabled:F,activePointId:Xe,lastAddedPointId:ye,selected:U,disabled:G,onFinish:p,isShiftKeyHeld:ke};const xt=(()=>{if(G||!U||ke||ve.size>zr||Y)return!0;if($e.current&&oe.length>0){const e=C.zoom*k,t=Mr/e;for(let e=0;e<oe.length;e++){const n=oe[e];if(n.isBezier){if(n.controlPoint1){if(Math.sqrt(($e.current.x-n.controlPoint1.x)**2+($e.current.y-n.controlPoint1.y)**2)<=t)return!0}if(n.controlPoint2){if(Math.sqrt(($e.current.x-n.controlPoint2.x)**2+($e.current.y-n.controlPoint2.y)**2)<=t)return!0}}}}if($e.current&&oe.length>0){const e=C.zoom*k,t=Er/e;for(let e=0;e<oe.length;e++){const n=oe[e];if(Math.sqrt(($e.current.x-n.x)**2+($e.current.y-n.y)**2)<=t){if(pe.size===zr&&pe.has(e))continue;if(e===oe.length-Lr)continue;if(e===Or&&D&&!ut)continue;return!0}}}if($e.current&&oe.length>=2){const e=C.zoom*k,t=Kr/e,n=ml($e.current,oe,D,ut);if(n&&hl($e.current,n.point)<=t)return!0}return!1})();(0,f.useEffect)(()=>{D&&void 0!==O||null==h||h(ut)},[ut,O,D,h]),(0,f.useEffect)(()=>{xt||Ye(new Set)},[xt]),(0,f.useEffect)(()=>{const e=xe.current;if(!e)return;const t=e.getStage();if(!t)return;const i=()=>{const e=t.getPointerPosition();if(e){const n=dl(e,C,k,x,w);return $e.current=n,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()}),!0}return!1},o=i(),s=ct.getActiveInstanceId()===n,a=pe.size>0||ve.size>0,r=ct.isInstanceSelected(n),l=!G&&U&&(s||a||r);if(!o&&oe.length>0&&!$e.current&&l){const e=oe[oe.length-1];$e.current={x:e.x+50,y:e.y+50},We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()})}else!l&&$e.current&&($e.current=null);const c=setTimeout(()=>{$e.current||i()},0),d=e=>{var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(i){const e=dl(i,C,k,x,w);$e.current=e,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()}),t.off("mousemove",d)}};return t.on("mousemove",d),()=>{clearTimeout(c),t.off("mousemove",d)}},[oe.length,C,k,x,w,U,n,pe.size,ve.size]);const wt=(0,f.useCallback)(()=>oe,[oe]),St=(0,f.useCallback)(e=>{ce.current=!0,de.current=e,re.current=e,se(e),ce.current=!1,ue.current=e,null==s||s(e)},[s]);(0,f.useEffect)(()=>{le.current=St},[St]);(0,f.useCallback)(e=>{re.current=e},[]),(0,f.useCallback)(()=>re.current,[]);const Ct=(0,f.useCallback)(e=>{fe(e)},[]),kt=(0,f.useCallback)(e=>{me(e)},[]),Pt=(0,f.useCallback)(()=>C,[C]),Rt=(0,f.useCallback)(()=>k,[k]),jt=(0,f.useCallback)(()=>({width:P,height:R}),[P,R]),Nt=(0,f.useCallback)(e=>{!i.current&&m&&m(e)},[m]);(0,f.useEffect)(()=>{const e={id:n,getPoints:wt,updatePoints:St,setSelectedPoints:Ct,setSelectedPointIndex:kt,onPointSelected:Nt,onTransformationComplete:g,getTransform:Pt,getFitScale:Rt,getBounds:jt};return ct.registerInstance(e),()=>{ct.unregisterInstance(n)}},[n,ct,wt,St,Ct,kt,Nt,g,Pt,Rt,jt]),(0,f.useEffect)(()=>{!G&&U||(me(null),fe(new Set),Ye(new Set),je(null),Oe(null),Ve(null),Fe(!1),ze(null),Ye(new Set))},[U]);const Tt=(0,f.useRef)(null),_t=()=>{const e=It();if(H===ol.SIMPLE);else{const t=e.map(e=>{const t=[];return e.isBezier&&(e.controlPoint1&&t.push({x:e.controlPoint1.x,y:e.controlPoint1.y}),e.controlPoint2&&t.push({x:e.controlPoint2.x,y:e.controlPoint2.y})),{x:e.x,y:e.y,bezier:e.isBezier||!1,controlPoints:t}}),n=void 0!==z&&e.length<z,i={type:D?il.POLYGON:il.POLYLINE,isClosed:ut,points:t,incomplete:n};null==g||g(i)}},At=()=>void 0===B||oe.length<B;(0,f.useEffect)(()=>{lt.setProps({initialPoints:oe,allowBezier:L,pixelSnapping:W,width:P,height:R,transform:C,fitScale:k,onPointsChange:s,onPointAdded:a,onPointEdited:l,canAddMorePoints:At,skeletonEnabled:F,lastAddedPointId:ye,activePointId:Xe,setLastAddedPointId:be,setActivePointId:qe,setVisibleControlPoints:Ye,setNewPointDragIndex:ze,setIsDraggingNewBezier:Fe,ghostPoint:De,selectedPoints:ve,isShiftKeyHeld:ke,setGhostPoint:Oe})},[lt,oe,ve,L,W,P,R,C,k,s,a,l,At,F,ye,Xe,be,qe,Ye,ze,Fe,De,ke,Oe]);const It=()=>[...oe],Mt=()=>{const e=[],t=It();if(F){const n=new Map;for(const e of t)n.set(e.id,e);for(const i of t)if(i.prevPointId){const t=n.get(i.prevPointId);t&&e.push({from:t,to:i})}const i=new Set;e.forEach(e=>{i.add(e.from.id),i.add(e.to.id)});const o=t.filter(e=>!i.has(e.id));if(o.length>0&&Xe){const t=n.get(Xe);if(t)for(const n of o)e.push({from:t,to:n})}}else{const n=new Map;for(const e of t)n.set(e.id,e);for(const i of t)if(i.prevPointId){const t=n.get(i.prevPointId);t&&e.push({from:t,to:i})}}return e},Et=e=>e<oe.length?{pathType:sl.MAIN,pathIndex:e,point:oe[e]}:null,Kt=e=>{const t=Et(e);if(!t)return;if(t.point.isBezier)xl(t.pathIndex,oe,d,s,u,Ye,Ge),Ye(t=>{const n=new Set(t);return n.delete(e),n});else{if(!L)return;if(0===t.pathIndex||t.pathIndex===oe.length-1)return;xl(t.pathIndex,oe,d,s,u,Ye,Ge),Ye(t=>{const n=new Set(t);return n.add(e),n})}_t()};(0,f.useImperativeHandle)(t,()=>({convertPoint:Kt,close:()=>{if(!D||oe.length<2)return!1;if(!(()=>{if(oe.length>2)return!0;return!!oe.some(e=>e.isBezier)})())return!1;if(z&&oe.length<z)return!1;if(ut)return!0;const e=oe[0],t=oe[oe.length-1],n=[...oe];return n[0]=Object.assign({},e,{prevPointId:t.id}),null==s||s(n),ht(!0),!0},selectPointsByIds:e=>{if(!ct.canInstanceHaveSelection(n))return;const t=new Set;let o=null;for(let n=0;n<oe.length;n++)e.includes(oe[n].id)&&(t.add(n),null===o&&(F||Vl(oe).has(n))&&(o=n));i.current=!0,ct.selectPoints(n,t),!F&&null!==o&&oe[o]?Vl(oe).has(o)&&qe(oe[o].id):F&&null!==o&&oe[o]&&qe(oe[o].id),setTimeout(()=>{i.current=!1},0)},clearSelection:()=>{i.current=!0,ct.selectPoints(n,new Set),setTimeout(()=>{i.current=!1},0)},getSelectedPointIds:()=>{const e=[];return pe.forEach(t=>{t<oe.length&&e.push(oe[t].id)}),e},exportShape:()=>{const e=oe.map(e=>{const t=[];return e.isBezier&&(e.controlPoint1&&t.push({x:e.controlPoint1.x,y:e.controlPoint1.y}),e.controlPoint2&&t.push({x:e.controlPoint2.x,y:e.controlPoint2.y})),{x:e.x,y:e.y,bezier:e.isBezier||!1,controlPoints:t}}),t=void 0!==z&&oe.length<z;return{type:D?il.POLYGON:il.POLYLINE,isClosed:ut,points:e,incomplete:t}},exportSimpleShape:()=>{const e=oe.map(e=>[e.x,e.y]);const t=void 0!==z&&oe.length<z;return{type:D?il.POLYGON:il.POLYLINE,isClosed:ut,points:e,incomplete:t}},startPoint:(e,t)=>!G&&lt.startPoint(e,t),updatePoint:(e,t)=>{G||lt.updatePoint(e,t)},commitPoint:(e,t)=>{G||lt.commitPoint(e,t)},translatePoints:(e,t,n)=>{const i=n?oe.filter(e=>n.includes(e.id)):oe,o=oe.map(n=>{if(i.some(e=>e.id===n.id)){const i=Object.assign({},n);return i.x+=e,i.y+=t,i.isBezier&&(i.controlPoint1&&(i.controlPoint1=Object.assign({},i.controlPoint1,{x:i.controlPoint1.x+e,y:i.controlPoint1.y+t})),i.controlPoint2&&(i.controlPoint2=Object.assign({},i.controlPoint2,{x:i.controlPoint2.x+e,y:i.controlPoint2.y+t}))),i}return n});null==s||s(o)},rotatePoints:(e,t,n,i)=>{const o=i?oe.filter(e=>i.includes(e.id)):oe;let a=t,r=n;if(!i){const e=Hl(oe);a=(e.left+e.right)/2,r=(e.top+e.bottom)/2}const l=e*Dr,c=Math.cos(l),d=Math.sin(l),u=oe.map(e=>{if(o.some(t=>t.id===e.id)){const t=Object.assign({},e),n=t.x-a,i=t.y-r;if(t.x=a+n*c-i*d,t.y=r+n*d+i*c,t.isBezier){if(t.controlPoint1){const e=t.controlPoint1.x-a,n=t.controlPoint1.y-r;t.controlPoint1=Object.assign({},t.controlPoint1,{x:a+e*c-n*d,y:r+e*d+n*c})}if(t.controlPoint2){const e=t.controlPoint2.x-a,n=t.controlPoint2.y-r;t.controlPoint2=Object.assign({},t.controlPoint2,{x:a+e*c-n*d,y:r+e*d+n*c})}}return t}return e});null==s||s(u)},scalePoints:(e,t,n,i,o)=>{const a=o?oe.filter(e=>o.includes(e.id)):oe;let r=n,l=i;if(!o){const e=Hl(oe);r=(e.left+e.right)/2,l=(e.top+e.bottom)/2}const c=oe.map(n=>{if(a.some(e=>e.id===n.id)){const i=Object.assign({},n),o=i.x-r,s=i.y-l;if(i.x=r+o*e,i.y=l+s*t,i.isBezier){if(i.controlPoint1){const n=i.controlPoint1.x-r,o=i.controlPoint1.y-l;i.controlPoint1=Object.assign({},i.controlPoint1,{x:r+n*e,y:l+o*t})}if(i.controlPoint2){const n=i.controlPoint2.x-r,o=i.controlPoint2.y-l;i.controlPoint2=Object.assign({},i.controlPoint2,{x:r+n*e,y:l+o*t})}}return i}return n});null==s||s(c)},transformPoints:(e,t)=>{const n=t?oe.filter(e=>t.includes(e.id)):oe;let i=e.centerX,o=e.centerY;if(!t&&(void 0!==e.rotation||void 0!==e.scaleX||void 0!==e.scaleY)){const e=Hl(oe);i=(e.left+e.right)/2,o=(e.top+e.bottom)/2}const a=oe.map(t=>{if(n.some(e=>e.id===t.id)){const n=Object.assign({},t);if(void 0!==e.dx&&(n.x+=e.dx,n.y+=e.dy||0),(void 0!==e.rotation||void 0!==e.scaleX||void 0!==e.scaleY)&&void 0!==i&&void 0!==o){let t=n.x,s=n.y;if(void 0!==e.scaleX||void 0!==e.scaleY){const n=e.scaleX||1,a=e.scaleY||1;t=i+(t-i)*n,s=o+(s-o)*a}if(void 0!==e.rotation){const n=e.rotation*Dr,a=Math.cos(n),r=Math.sin(n),l=t-i,c=s-o;t=i+l*a-c*r,s=o+l*r+c*a}n.x=t,n.y=s}if(n.isBezier){if(n.controlPoint1){const t=Object.assign({},n.controlPoint1);if(void 0!==e.dx&&(t.x+=e.dx,t.y+=e.dy||0),(void 0!==e.rotation||void 0!==e.scaleX||void 0!==e.scaleY)&&void 0!==i&&void 0!==o){let n=t.x,s=t.y;if(void 0!==e.scaleX||void 0!==e.scaleY){const t=e.scaleX||1,a=e.scaleY||1;n=i+(n-i)*t,s=o+(s-o)*a}if(void 0!==e.rotation){const t=e.rotation*Dr,a=Math.cos(t),r=Math.sin(t),l=n-i,c=s-o;n=i+l*a-c*r,s=o+l*r+c*a}t.x=n,t.y=s}n.controlPoint1=t}if(n.controlPoint2){const t=Object.assign({},n.controlPoint2);if(void 0!==e.dx&&(t.x+=e.dx,t.y+=e.dy||0),(void 0!==e.rotation||void 0!==e.scaleX||void 0!==e.scaleY)&&void 0!==i&&void 0!==o){let n=t.x,s=t.y;if(void 0!==e.scaleX||void 0!==e.scaleY){const t=e.scaleX||1,a=e.scaleY||1;n=i+(n-i)*t,s=o+(s-o)*a}if(void 0!==e.rotation){const t=e.rotation*Dr,a=Math.cos(t),r=Math.sin(t),l=n-i,c=s-o;n=i+l*a-c*r,s=o+l*r+c*a}t.x=n,t.y=s}n.controlPoint2=t}}return n}return t});null==s||s(a)},getShapeBoundingBox:()=>Hl(oe),isPointOverShape:(e,t,n=10)=>{const i={x:(e-C.offsetX)/(k*C.zoom),y:(t-C.offsetY)/(k*C.zoom)};if(0===oe.length)return!1;for(const e of oe){if(hl(i,e)<=n/(k*C.zoom))return!0}if(1===oe.length)return!1;if(ut&&oe.length>=3&&((e,t)=>{if(t.length<3)return!1;let n=!1;e.x,e.y;const i=new Map;for(const e of t)i.set(e.id,e);for(let o=0;o<t.length;o++){const s=t[o],a=s.prevPointId?i.get(s.prevPointId):null;a&&(el(e,a,s)&&(n=!n))}return n})(i,oe))return!0;const o=ml(i,oe,D,ut);if(o){return hl(i,o.point)<=n/(k*C.zoom)}return!1},commitMultiRegionTransform:rt,deletePointsByIds:e=>{if(!e||0===e.length)return;const t=e.map(e=>oe.findIndex(t=>t.id===e)).filter(e=>e>=0).sort((e,t)=>t-e);if(0===t.length)return;const i=new Set(e);let o=[...oe],a=ge,l=ye;for(const e of t){if(e<0||e>=o.length)continue;const t=o[e],n=[...o];n.splice(e,1);for(let s=0;s<n.length;s++){const a=n[s];if(a.prevPointId===t.id){let r=t.prevPointId;if(0===e)r=void 0;else if(t.prevPointId){if(i.has(t.prevPointId)){let e=t.prevPointId;for(;e&&i.has(e);){const t=o.findIndex(t=>t.id===e);if(!(t>=0&&t<o.length)){e=void 0;break}e=o[t].prevPointId}r=e}}else r=void 0;n[s]=Object.assign({},a,{prevPointId:r})}}if(a===e?(a=null,null==m||m(null)):null!==a&&a>e&&(a-=1),l===t.id)if(n.length>0){l=n[n.length-1].id}else l=null;Ye(t=>{const n=new Set(t);n.delete(e);const i=new Set;for(const t of Array.from(n))t>e?i.add(t-1):i.add(t);return i}),null==r||r(t,e),o=n}me(a),be(l),ct.selectPoints(n,new Set),null==s||s(o)}})),(0,f.useEffect)(()=>{if(!X&&et.current){const e=et.current,t=e.x(),n=e.y();0===t&&0===n||!at.current||(rt(),st())}},[X,rt,st]),(0,f.useEffect)(()=>()=>{tt.current&&(clearTimeout(tt.current),tt.current=null)},[]),(0,f.useEffect)(()=>{if(yt.current)return()=>{};const e=xe.current;if(!e){const e=setTimeout(()=>{yt.current||pt(e=>e+1)},100);return()=>{clearTimeout(e)}}const t=e.getStage();if(!t){const e=setTimeout(()=>{yt.current||pt(e=>e+1)},100);return()=>{clearTimeout(e)}}yt.current=!0;const n=(e,t)=>{const n=xe.current;if(!n)return;const i=n.getStage();if(!i)return;const o=t||i.getPointerPosition();if(!o)return;const{transform:s,fitScale:a,x:r,y:l,width:c,height:d,initialPoints:u,allowClose:h,finalIsPathClosed:g,pixelSnapping:m,isDraggingNewBezier:p,ghostPointDragInfo:f,selected:v,disabled:y,isShiftKeyHeld:b}=bt.current;if(y||!v||gt.current||p||null!=f&&f.isDragging)return;const x=dl(o,s,a,r,l);if(x.x>=0&&x.x<=c&&x.y>=0&&x.y<=d){const t=void 0!==e?e:null!=b&&b;if(u.length>=2&&t){const e=s.zoom*a,t=Er/e;let n=!1;for(let e=0;e<u.length;e++){const i=u[e];if(Math.sqrt((x.x-i.x)**2+(x.y-i.y)**2)<=t){n=!0;break}}if(n)Oe(null);else{const e=ml(x,u,h,g);if(e){const t=ul(e.point,m);let n;if(e.segmentIndex===u.length){const e=u[u.length-1],i=u[0];n={x:t.x,y:t.y,prevPointId:e.id,nextPointId:i.id}}else{const i=u[e.segmentIndex],o=null!=i&&i.prevPointId?u.find(e=>e.id===i.prevPointId):null;if(!i||!o)return void Oe(null);n={x:t.x,y:t.y,prevPointId:o.id,nextPointId:i.id}}Oe(Object.assign({},n)),vt.current&&vt.current.updatePosition(n.x,n.y)}else Oe(null)}}else Oe(null)}else Oe(null)};if(ft.current=n,!q){const e=e=>{const i=t.getPointerPosition();if(!i)return;const{transform:o,fitScale:s,x:a,y:r,width:l,height:c,initialPoints:d,allowClose:u,finalIsPathClosed:h,pixelSnapping:g,isDraggingNewBezier:m,ghostPointDragInfo:p,selected:f}=bt.current;e.evt.shiftKey!==ke&&Pe(e.evt.shiftKey);const v=dl(i,o,s,a,r),y=e.target,b=xe.current;let x=y;for(;x&&x!==b&&x.getParent();)x=x.getParent();const w=x===b,S=y===t||y.getParent()===t;if(!w&&!S)return $e.current=null,Oe(null),We.current&&cancelAnimationFrame(We.current),void(We.current=requestAnimationFrame(()=>{t.batchDraw()}));$e.current=v,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()}),n(e.evt.shiftKey,i)},i=e=>{var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(i){const{transform:e,fitScale:n,x:o,y:s}=bt.current,a=dl(i,e,n,o,s);$e.current=a,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()})}},o=()=>{$e.current=null,Oe(null)};t.on("mousemove",e),t.on("mouseenter",i),t.on("mouseleave",o);const s=()=>{const e=t.getPointerPosition();if(e){const{transform:n,fitScale:i,x:o,y:s}=bt.current,a=dl(e,n,i,o,s);$e.current=a,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()})}};s();const a=setTimeout(()=>{s()},0);return()=>{clearTimeout(a),We.current&&cancelAnimationFrame(We.current),t.off("mousemove",e),t.off("mouseenter",i),t.off("mouseleave",o)}}const i=t=>{var n;const{initialPoints:i,effectiveSelectedPoints:o,instanceId:s,transform:a,fitScale:r,x:l,y:c,skeletonEnabled:d,activePointId:u,lastAddedPointId:h,allowClose:g,finalIsPathClosed:m,selected:p,disabled:f,onFinish:v}=bt.current;if(f)return;const y=t.target;let b=y;for(;b&&b!==e;)b=b.getParent();if(b!==e)return;const x=null==(n=t.target.getStage())?void 0:n.getPointerPosition();if(!x)return;const w=dl(x,a,r,l,c),S=y.name();if(S&&S.startsWith("point-")){const e=S.match(/^point-(\d+)$/);if(e){const n=Number.parseInt(e[1],10);if(n>=0&&n<i.length){const e=i[n];return t.evt.ctrlKey||t.evt.metaKey?void t.evt.stopPropagation():(t.evt.stopPropagation(),Ce(n),void(Tt.current={x:t.evt.clientX,y:t.evt.clientY,originalX:e.x,originalY:e.y,originalControlPoint1:e.isBezier?e.controlPoint1:void 0,originalControlPoint2:e.isBezier?e.controlPoint2:void 0}))}}}if(S&&S.startsWith("control-point-")){const e=S.match(/^control-point-(\d+)-(\d+)$/);if(e){const n=Number.parseInt(e[1],10),o=Number.parseInt(e[2],10);if(n>=0&&n<i.length){const e=i[n];if(e.isBezier&&o>=1&&o<=2){const i=1===o?e.controlPoint1:e.controlPoint2;if(i)return je({pointIndex:n,controlIndex:o}),gt.current=!0,ot(),void(Tt.current={x:t.evt.clientX,y:t.evt.clientY,originalX:i.x,originalY:i.y})}}}}const C=a.zoom*r,k=Er/C;for(let e=0;e<i.length;e++){const n=i[e];if(Math.sqrt((w.x-n.x)**2+(w.y-n.y)**2)<=k){if(t.evt.ctrlKey||t.evt.metaKey){t.evt.stopPropagation();const e=Object.assign({},t,{target:t.target,evt:t.evt});if(_l(e,{instanceId:s,initialPoints:i,transform:a,fitScale:r,x:l,y:c,selectedPoints:o,setSelectedPoints:fe,skeletonEnabled:d,setActivePointId:qe,setLastAddedPointId:be,lastAddedPointId:h,activePointId:u}))return;if(Tl(e,{instanceId:s,initialPoints:i,transform:a,fitScale:r,x:l,y:c,selectedPoints:o,setSelectedPoints:fe,setSelectedPointIndex:me,skeletonEnabled:d,setActivePointId:qe,setLastAddedPointId:be,lastAddedPointId:h,activePointId:u,allowClose:g,isPathClosed:m,selected:p,onFinish:v}))return}else t.evt.stopPropagation(),Ce(e),Tt.current={x:t.evt.clientX,y:t.evt.clientY,originalX:n.x,originalY:n.y,originalControlPoint1:n.isBezier?n.controlPoint1:void 0,originalControlPoint2:n.isBezier?n.controlPoint2:void 0};return}}for(let e=0;e<i.length;e++){const n=i[e];if(n.isBezier){if(n.controlPoint1){if(Math.sqrt((w.x-n.controlPoint1.x)**2+(w.y-n.controlPoint1.y)**2)<=k)return je({pointIndex:e,controlIndex:1}),gt.current=!0,ot(),void(Tt.current={x:t.evt.clientX,y:t.evt.clientY,originalX:n.controlPoint1.x,originalY:n.controlPoint1.y})}if(n.controlPoint2){if(Math.sqrt((w.x-n.controlPoint2.x)**2+(w.y-n.controlPoint2.y)**2)<=k)return je({pointIndex:e,controlIndex:2}),gt.current=!0,ot(),void(Tt.current={x:t.evt.clientX,y:t.evt.clientY,originalX:n.controlPoint2.x,originalY:n.controlPoint2.y})}}}},o=n=>{var i;const{initialPoints:o,allowClose:a,finalIsPathClosed:r,pixelSnapping:d,isDraggingNewBezier:u,ghostPointDragInfo:h,draggedPointIndex:g,draggedControlPoint:m,isDraggingShape:p,effectiveSelectedPoints:f,transform:v,fitScale:y,x:b,y:x,width:w,height:S,disabled:C}=bt.current;if(C&&(null!==g||null!==m||p))return Ce(null),je(null),void Te(!1);const k=null==(i=n.target.getStage())?void 0:i.getPointerPosition();if(!k)return;n.evt.shiftKey!==ke&&Pe(n.evt.shiftKey);const P=dl(k,v,y,b,x),R=n.target;let j=R;for(;j&&j!==e&&j.getParent();)j=j.getParent();const N=j===e,T=R===t||R.getParent()===t,_=null!==g||null!==m;if(p&&_e.current&&!C&&!X){const e=P.x-_e.current.imageX,t=P.y-_e.current.imageY;Me.current=Math.sqrt(e*e+t*t);const n=Il(o.map((n,i)=>{const o=Ae.current[i];if(!o)return n;const s=o.x+e,a=o.y+t,r=Object.assign({},n,{x:s,y:a});if(n.isBezier){if(o.controlPoint1){const n=o.controlPoint1.x+e,i=o.controlPoint1.y+t;r.controlPoint1={x:n,y:i}}if(o.controlPoint2){const n=o.controlPoint2.x+e,i=o.controlPoint2.y+t;r.controlPoint2={x:n,y:i}}}return r}),{width:w,height:S});return void(null==s||s(n))}if(!_&&!N&&!T)return $e.current=null,Oe(null),We.current&&cancelAnimationFrame(We.current),void(We.current=requestAnimationFrame(()=>{t.batchDraw()}));if($e.current=P,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()}),ft.current&&ft.current(n.evt.shiftKey,k),P.x>=0&&P.x<=w&&P.y>=0&&P.y<=S){if(!(n.evt.shiftKey&&P&&o.length>=2)||gt.current||u||null!=h&&h.isDragging||!U||C)n.evt.shiftKey||Oe(null);else{const e=v.zoom*y,t=Er/e;let n=!1;for(let e=0;e<o.length;e++){const i=o[e];if(Math.sqrt((P.x-i.x)**2+(P.y-i.y)**2)<=t){n=!0;break}}if(n)Oe(null);else{const e=ml(P,o,a,r);if(e){const t=ul(e.point,d);if(e.segmentIndex===o.length){const e=o[o.length-1],n=o[0],i={x:t.x,y:t.y,prevPointId:e.id,nextPointId:n.id};Oe(i)}else{const n=o[e.segmentIndex],i=null!=n&&n.prevPointId?o.find(e=>e.id===n.prevPointId):null;if(n&&i){const e={x:t.x,y:t.y,prevPointId:i.id,nextPointId:n.id};Oe(e)}}}else Oe(null)}}if(null!==g&&Tt.current&&!C){var A,I;const e=5,t=Math.abs(n.evt.clientX-Tt.current.x),i=Math.abs(n.evt.clientY-Tt.current.y);if(!gt.current&&(t>e||i>e)&&(gt.current=!0,ot()),!gt.current)return;const a=[...o],r=a[g],l=null!=(A=Tt.current.originalX)?A:r.x,u=null!=(I=Tt.current.originalY)?I:r.y,h=Il([ul(P,d)],{width:w,height:S})[0];if(a[g]=Object.assign({},r,{x:h.x,y:h.y}),r.isBezier){const e=a[g];if(e.controlPoint1&&Tt.current.originalControlPoint1){const t=h.x-l,n=h.y-u,i={x:Tt.current.originalControlPoint1.x+t,y:Tt.current.originalControlPoint1.y+n};e.controlPoint1=ul(i,d)}if(e.controlPoint2&&Tt.current.originalControlPoint2){const t=h.x-l,n=h.y-u,i={x:Tt.current.originalControlPoint2.x+t,y:Tt.current.originalControlPoint2.y+n};e.controlPoint2=ul(i,d)}const t=Il([e],{width:w,height:S})[0];a[g]=t}null==s||s(a),null==c||c(a[g],g)}if(m&&Tt.current&&!C){const e=[...o],t=e[m.pointIndex];if(t.isBezier){const n=Al(ul(P,d),{width:w,height:S});1===m.controlIndex?t.controlPoint1=n:2===m.controlIndex&&(t.controlPoint2=n),e[m.pointIndex]=t,null==s||s(e),null==l||l(t,m.pointIndex)}}}else Oe(null)},a=e=>{const{isDraggingShape:t,draggedPointIndex:n,initialPoints:i,effectiveSelectedPoints:o,instanceId:s,skeletonEnabled:a,activePointId:r,disabled:l,onFinish:c,pixelSnapping:d,width:u,height:h}=bt.current;if(!l){if(t){const t=5,n=Me.current>t;if(Te(!1),st(e),d&&re.current.length>0){const e=re.current,t=e[0],n=ul({x:t.x,y:t.y},d),i=[],o=new Map;for(let s=0;s<e.length;s++){const a=e[s];if(0===s){const e=Object.assign({},a,{x:n.x,y:n.y});a.isBezier&&(a.controlPoint1&&(e.controlPoint1=ul(a.controlPoint1,d)),a.controlPoint2&&(e.controlPoint2=ul(a.controlPoint2,d))),i.push(e),o.set(s,{x:n.x,y:n.y})}else{let r=ul({x:a.x,y:a.y},d),l=!1;for(let i=0;i<s;i++){const s=o.get(i);if(s){const o=Math.sqrt((r.x-s.x)**2+(r.y-s.y)**2),c=Math.sqrt((a.x-e[i].x)**2+(a.y-e[i].y)**2);if(o<.1&&c>.1){l=!0;const e=a.x-t.x,i=a.y-t.y;r={x:n.x+e,y:n.y+i};break}}}const c=Object.assign({},a,{x:r.x,y:r.y});a.isBezier&&(a.controlPoint1&&(c.controlPoint1=ul(a.controlPoint1,d)),a.controlPoint2&&(c.controlPoint2=ul(a.controlPoint2,d))),i.push(c),o.set(s,{x:r.x,y:r.y})}}const s=Il(i,{width:u,height:h});le.current&&le.current(s)}return _e.current=null,Ae.current=[],n&&(Ie.current=!0,e.evt.stopPropagation(),e.evt.preventDefault()),void(Me.current=0)}null===n||gt.current||(Ll(n,{instanceId:s,initialPoints:i,selectedPoints:o,setSelectedPoints:fe,skeletonEnabled:a,setActivePointId:qe,activePointId:r,onFinish:c},e),null==m||m(n)),gt.current=!1,st(e),Ce(null),je(null)}},r=e=>{var n;const i=null==(n=e.target.getStage())?void 0:n.getPointerPosition();if(i){const{transform:e,fitScale:n,x:o,y:s}=bt.current,a=dl(i,e,n,o,s);$e.current=a,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()})}},d=()=>{$e.current=null,Oe(null)};if(q){t.on("mousedown",i),t.on("mousemove",o),t.on("mouseup",a),t.on("mouseenter",r),t.on("mouseleave",d);const e=()=>{const e=t.getPointerPosition();if(e){const{transform:n,fitScale:i,x:o,y:s}=bt.current,a=dl(e,n,i,o,s);$e.current=a,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()})}};e();const n=setTimeout(()=>{e()},0);return()=>{clearTimeout(n),yt.current=!1,t.off("mousedown",i),t.off("mousemove",o),t.off("mouseup",a),t.off("mouseenter",r),t.off("mouseleave",d)}}t.on("mousemove",o),t.on("mouseup",a),t.on("mouseenter",r),t.on("mouseleave",d);const u=()=>{const e=t.getPointerPosition();if(e){const{transform:n,fitScale:i,x:o,y:s}=bt.current,a=dl(e,n,i,o,s);$e.current=a,We.current&&cancelAnimationFrame(We.current),We.current=requestAnimationFrame(()=>{t.batchDraw()})}};u();const h=setTimeout(()=>{u()},0);return()=>{clearTimeout(h),yt.current=!1,We.current&&cancelAnimationFrame(We.current),t.off("mousemove",o),t.off("mouseup",a),t.off("mouseenter",r),t.off("mouseleave",d)}},[q,mt]),(0,f.useEffect)(()=>{const e=e=>{"Shift"===e.key&&Ke(!0)},t=e=>{"Shift"===e.key&&Ke(!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[]);const Dt=(0,f.useCallback)((e,t,n)=>{if(G){if(t){var i,o,s;const n=Object.assign({},e,{evt:Object.assign({},e.evt,{defaultPrevented:!1,stopImmediatePropagation:(null==(i=e.evt.stopImmediatePropagation)?void 0:i.bind(e.evt))||(()=>{}),stopPropagation:(null==(o=e.evt.stopPropagation)?void 0:o.bind(e.evt))||(()=>{}),preventDefault:(null==(s=e.evt.preventDefault)?void 0:s.bind(e.evt))||(()=>{})})});t(n)}}else if(tt.current){if(clearTimeout(tt.current),tt.current=null,nt.current=!0,n){var a,r,l;n(Object.assign({},e,{evt:Object.assign({},e.evt,{defaultPrevented:!1,stopImmediatePropagation:(null==(a=e.evt.stopImmediatePropagation)?void 0:a.bind(e.evt))||(()=>{}),stopPropagation:(null==(r=e.evt.stopPropagation)?void 0:r.bind(e.evt))||(()=>{}),preventDefault:(null==(l=e.evt.preventDefault)?void 0:l.bind(e.evt))||(()=>{})})}))}setTimeout(()=>{nt.current=!1},100)}else tt.current=setTimeout(()=>{if(tt.current=null,t){var n,i,o;const s=Object.assign({},e,{evt:Object.assign({},e.evt,{defaultPrevented:!1,stopImmediatePropagation:(null==(n=e.evt.stopImmediatePropagation)?void 0:n.bind(e.evt))||(()=>{}),stopPropagation:(null==(i=e.evt.stopPropagation)?void 0:i.bind(e.evt))||(()=>{}),preventDefault:(null==(o=e.evt.preventDefault)?void 0:o.bind(e.evt))||(()=>{})})});t(s)}},150)},[U,G]),Ot=function(e){const t={current:!1};return{handleLayerMouseDown:Ml(e,t),handleLayerClick:Dl(e,t),handleLayerMouseMove:El(e,t),handleLayerMouseUp:Kl(e)}}({instanceId:n,initialPoints:oe,width:P,height:R,pixelSnapping:W,selectedPoints:ve,selectedPointIndex:ge,setSelectedPointIndex:me,setSelectedPoints:fe,setDraggedPointIndex:Ce,setDraggedControlPoint:je,setIsDisconnectedMode:Ke,setGhostPoint:Oe,setNewPointDragIndex:ze,setIsDraggingNewBezier:Fe,setGhostPointDragInfo:Ve,setVisibleControlPoints:Ye,setIsPathClosed:ht,isDragging:gt,lastPos:Tt,lastCallbackTime:Ue,isDrawingMode:!xt,allowClose:D,allowBezier:L,isPathClosed:ut,transform:C,fitScale:k,x,y:w,ghostPoint:De,ghostPointDragInfo:He,draggedPointIndex:Se,draggedControlPoint:Re,isDraggingNewBezier:Be,newPointDragIndex:Le,visibleControlPoints:Ge,isDisconnectedMode:Ee,onPointsChange:s,onPointAdded:a,onPointRemoved:r,onPointEdited:l,onPointRepositioned:c,onPointConverted:d,onPathShapeChanged:u,onPointSelected:m,onFinish:p,onGhostPointClick:v,onMouseDown:j,onMouseMove:N,onMouseUp:T,onClick:_,notifyTransformationComplete:_t,canAddMorePoints:At,maxPoints:B,minPoints:z,skeletonEnabled:F,getAllPoints:It,getPointInfo:Et,updatePointByGlobalIndex:(e,t)=>{if(e>=0&&e<oe.length){const n=[...oe];return n[e]=t,se(n),void(null==s||s(n))}},lastAddedPointId:ye,setLastAddedPointId:be,activePointId:Xe,setActivePointId:qe,isTransforming:Ze,selected:U,disabled:G,transformMode:Y,disableInternalPointAddition:q,handleTransformStart:ot,handleTransformEnd:st,pointCreationManager:lt});return(0,ae.jsxs)(us.YJ,{ref:xe,scaleX:y,scaleY:b,x,y:w,imageSmoothingEnabled:S,onMouseDown:U&&!G?Ot.handleLayerMouseDown:void 0,onMouseMove:U&&!G?Ot.handleLayerMouseMove:void 0,onMouseUp:U&&!G?Ot.handleLayerMouseUp:void 0,onClick:!U||Y?void 0:e=>{if(Y)return e.evt.stopPropagation(),e.evt.preventDefault(),e.evt.stopImmediatePropagation(),void(e.cancelBubble=!0);if(G)Dt(e,_,A);else{if(Ie.current)return e.evt.stopPropagation(),e.evt.preventDefault(),e.cancelBubble=!0,void(Ie.current=!1);if(Qe.current)Qe.current=!1;else{if(0===oe.length&&!xt&&!q){var t;const n=null==(t=e.target.getStage())?void 0:t.getPointerPosition();if(n){const e={x:(n.x-x-C.offsetX)/(y*C.zoom*k),y:(n.y-w-C.offsetY)/(b*C.zoom*k)};if(e.x>=0&&e.x<=P&&e.y>=0&&e.y<=R){const t={id:`point-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,x:e.x,y:e.y,isBezier:!1},n=[...oe,t];return null==s||s(n),null==a||a(t,n.length-1),be(t.id),void qe(t.id)}}}Ot.handleLayerClick(e)}}},onDblClick:G?void 0:e=>{nt.current||null==A||A(e)},children:[U&&!G&&!q&&(0,ae.jsx)(us.yp,{sceneFunc:(e,t)=>{e.beginPath(),e.rect(0,0,P,R),e.fillShape(t)},fill:"rgba(255,255,255,0.001)"}),X?(0,ae.jsxs)(us.YJ,{name:"_transformable",ref:et,draggable:!G,onTransformEnd:e=>{G||e.target===e.currentTarget&&et.current&&at.current&&(rt(),st(e))},children:[(0,ae.jsx)(Cr,{segments:Mt(),allowClose:D,isPathClosed:ut,stroke:V,fill:$,strokeWidth:e.strokeWidth,opacity:e.opacity,transform:C,fitScale:k,onClick:e=>{if(Y)return e.evt.stopPropagation(),e.evt.preventDefault(),e.evt.stopImmediatePropagation(),void(e.cancelBubble=!0);if(G)Ie.current||e.evt.shiftKey||Dt(e,_,A);else if(!e.evt.altKey||e.evt.shiftKey||!U){if(Ie.current)return e.evt.stopPropagation(),e.evt.preventDefault(),e.cancelBubble=!0,void(Ie.current=!1);if($e.current&&ye){const t=oe.find(e=>e.id===ye);if(t){const n=C.zoom*k,i=Er/n;if(Math.sqrt(($e.current.x-t.x)**2+($e.current.y-t.y)**2)<=i){const t=oe.findIndex(e=>e.id===ye);if(-1!==t&&ve.has(t)&&U&&!Y){return e.evt.ctrlKey||e.evt.metaKey||e.evt.shiftKey||e.evt.altKey?void 0:(e.evt.preventDefault(),void(null==p||p(e)))}}}}Ie.current||e.evt.shiftKey||(e.evt.stopPropagation(),e.evt.preventDefault(),e.cancelBubble=!0,Dt(e,_,A))}},onMouseDown:e=>{var t;if(G)return;if(X)return;if(null!==Se||null!==Re)return;const n=null==(t=e.target.getStage())?void 0:t.getPointerPosition();if(!n)return;const i=dl(n,C,k,x,w),o=C.zoom*k,s=Er/o;for(let e=0;e<oe.length;e++){const t=oe[e];if(Math.sqrt((i.x-t.x)**2+(i.y-t.y)**2)<=s)return}for(let e=0;e<oe.length;e++){const t=oe[e];if(t.isBezier){if(t.controlPoint1){if(Math.sqrt((i.x-t.controlPoint1.x)**2+(i.y-t.controlPoint1.y)**2)<=s)return}if(t.controlPoint2){if(Math.sqrt((i.x-t.controlPoint2.x)**2+(i.y-t.controlPoint2.y)**2)<=s)return}}}Te(!0),ot(),Me.current=0,_e.current={x:e.evt.clientX,y:e.evt.clientY,imageX:i.x,imageY:i.y},Ae.current=oe.map(e=>({x:e.x,y:e.y,controlPoint1:e.controlPoint1?{x:e.controlPoint1.x,y:e.controlPoint1.y}:void 0,controlPoint2:e.controlPoint2?{x:e.controlPoint2.x,y:e.controlPoint2.y}:void 0}))},onMouseEnter:E,onMouseLeave:K},`vector-shape-${oe.length}-${oe.map(e=>e.id).join("-")}`),U&&!G&&!Z&&(0,ae.jsx)(fl,{initialPoints:oe,cursorPositionRef:$e,draggedControlPoint:Re,draggedPointIndex:Se,isDraggingNewBezier:Be,isPathClosed:ut,allowClose:D,transform:C,fitScale:k,maxPoints:B,minPoints:z,skeletonEnabled:F,selectedPointIndex:ge,lastAddedPointId:ye,activePointId:Xe,stroke:V,pixelSnapping:W,drawingDisabled:xt,isShiftKeyHeld:ke,transformMode:Y,effectiveSelectedPointsSize:ve.size}),U&&!G&&(0,ae.jsx)(yl,{initialPoints:It(),selectedPointIndex:ge,isDraggingNewBezier:Be,draggedControlPoint:Re,visibleControlPoints:Ge,transform:C,fitScale:k},`control-points-${oe.length}-${oe.map((e,t)=>{var n,i,o,s;return`${t}-${e.x.toFixed(1)}-${e.y.toFixed(1)}-${(null==(n=e.controlPoint1)||null==(n=n.x)?void 0:n.toFixed(1))||"null"}-${(null==(i=e.controlPoint1)||null==(i=i.y)?void 0:i.toFixed(1))||"null"}-${(null==(o=e.controlPoint2)||null==(o=o.x)?void 0:o.toFixed(1))||"null"}-${(null==(s=e.controlPoint2)||null==(s=s.y)?void 0:s.toFixed(1))||"null"}`}).join("-")}`),(0,ae.jsx)(vl,{initialPoints:It(),selectedPointIndex:ge,selectedPoints:ve,transform:C,fitScale:k,pointRefs:we,selected:U,disabled:G,transformMode:Y,pointRadius:J,pointFill:Q,pointStroke:ee,pointStrokeSelected:te,pointStrokeWidth:ne,pointStyle:ie,activePointId:Xe,maxPoints:B,onPointClick:(e,i)=>{if(G||Y)return e.evt.stopPropagation(),e.evt.preventDefault(),e.evt.stopImmediatePropagation(),void(e.cancelBubble=!0);if(1===oe.length&&!e.evt.altKey&&!e.evt.shiftKey&&!e.evt.ctrlKey&&!e.evt.metaKey&&!Y)return ct.selectPoints(n,new Set([i])),(!F&&Vl(oe).has(i)&&oe[i]||F&&oe[i])&&qe(oe[i].id),Qe.current=!0,void Dt(e,_,A);if(!G&&!U){if(!ct.canInstanceHaveSelection(n))return;if(Rl(i,{initialPoints:oe,allowClose:D,isPathClosed:ut,skeletonEnabled:F,activePointId:Xe},e)&&jl({initialPoints:oe,skeletonEnabled:F,activePointId:Xe})){var o;if(null==t||null==(o=t.current)?void 0:o.close())return}if(!Y&&(e.evt.ctrlKey||e.evt.metaKey)&&!e.evt.altKey&&!e.evt.shiftKey){const t=Array.from({length:oe.length},(e,t)=>t);return ct.selectPoints(n,new Set(t)),Qe.current=!0,void e.evt.stopImmediatePropagation()}if(U){var s;const t=ye&&(null==(s=oe[i])?void 0:s.id)===ye,n=ve.has(i);if(t&&n&&!xt&&!Y){return e.evt.ctrlKey||e.evt.metaKey||e.evt.shiftKey||e.evt.altKey?void 0:(null==p||p(e),Qe.current=!0,void e.evt.stopImmediatePropagation())}}if(!Y)if(e.evt.ctrlKey||e.evt.metaKey){const e=new Set(pe);e.add(i),ct.selectPoints(n,e),(!F&&Vl(oe).has(i)&&oe[i]||F&&oe[i])&&qe(oe[i].id)}else ct.selectPoints(n,new Set([i])),(!F&&Vl(oe).has(i)&&oe[i]||F&&oe[i])&&qe(oe[i].id);return Qe.current=!0,e.evt.stopImmediatePropagation(),e.evt.stopPropagation(),e.evt.preventDefault(),void(e.cancelBubble=!0)}}})]}):(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Cr,{segments:Mt(),allowClose:D,isPathClosed:ut,stroke:V,fill:$,strokeWidth:e.strokeWidth,opacity:e.opacity,transform:C,fitScale:k,onClick:e=>{if(Y)return e.evt.stopPropagation(),e.evt.preventDefault(),e.evt.stopImmediatePropagation(),void(e.cancelBubble=!0);if(G)Ie.current||e.evt.shiftKey||Dt(e,_,A);else if(!e.evt.altKey||e.evt.shiftKey||!U){if(Ie.current)return e.evt.stopPropagation(),e.evt.preventDefault(),e.cancelBubble=!0,void(Ie.current=!1);if($e.current&&ye){const t=oe.find(e=>e.id===ye);if(t){const n=C.zoom*k,i=Er/n;if(Math.sqrt(($e.current.x-t.x)**2+($e.current.y-t.y)**2)<=i){const t=oe.findIndex(e=>e.id===ye);if(-1!==t&&ve.has(t)&&U&&!Y){return e.evt.ctrlKey||e.evt.metaKey||e.evt.shiftKey||e.evt.altKey?void 0:(e.evt.preventDefault(),void(null==p||p(e)))}}}}Ie.current||e.evt.shiftKey||(e.evt.stopPropagation(),e.evt.preventDefault(),e.cancelBubble=!0,Dt(e,_,A))}},onMouseDown:e=>{var t;if(G)return;if(X)return;if(null!==Se||null!==Re)return;const n=null==(t=e.target.getStage())?void 0:t.getPointerPosition();if(!n)return;const i=dl(n,C,k,x,w),o=C.zoom*k,s=Er/o;for(let e=0;e<oe.length;e++){const t=oe[e];if(Math.sqrt((i.x-t.x)**2+(i.y-t.y)**2)<=s)return}for(let e=0;e<oe.length;e++){const t=oe[e];if(t.isBezier){if(t.controlPoint1){if(Math.sqrt((i.x-t.controlPoint1.x)**2+(i.y-t.controlPoint1.y)**2)<=s)return}if(t.controlPoint2){if(Math.sqrt((i.x-t.controlPoint2.x)**2+(i.y-t.controlPoint2.y)**2)<=s)return}}}Te(!0),ot(),Me.current=0,_e.current={x:e.evt.clientX,y:e.evt.clientY,imageX:i.x,imageY:i.y},Ae.current=oe.map(e=>({x:e.x,y:e.y,controlPoint1:e.controlPoint1?{x:e.controlPoint1.x,y:e.controlPoint1.y}:void 0,controlPoint2:e.controlPoint2?{x:e.controlPoint2.x,y:e.controlPoint2.y}:void 0}))},onMouseEnter:E,onMouseLeave:K},`vector-shape-${oe.length}-${oe.map(e=>e.id).join("-")}`),U&&!G&&!Z&&(0,ae.jsx)(fl,{initialPoints:oe,cursorPositionRef:$e,draggedControlPoint:Re,draggedPointIndex:Se,isDraggingNewBezier:Be,isPathClosed:ut,allowClose:D,transform:C,fitScale:k,maxPoints:B,minPoints:z,skeletonEnabled:F,selectedPointIndex:ge,lastAddedPointId:ye,activePointId:Xe,stroke:V,pixelSnapping:W,drawingDisabled:xt,isShiftKeyHeld:ke,transformMode:Y,effectiveSelectedPointsSize:ve.size}),U&&!G&&(0,ae.jsx)(yl,{initialPoints:It(),selectedPointIndex:ge,isDraggingNewBezier:Be,draggedControlPoint:Re,visibleControlPoints:Ge,transform:C,fitScale:k},`control-points-${oe.length}-${oe.map((e,t)=>{var n,i,o,s;return`${t}-${e.x.toFixed(1)}-${e.y.toFixed(1)}-${(null==(n=e.controlPoint1)||null==(n=n.x)?void 0:n.toFixed(1))||"null"}-${(null==(i=e.controlPoint1)||null==(i=i.y)?void 0:i.toFixed(1))||"null"}-${(null==(o=e.controlPoint2)||null==(o=o.x)?void 0:o.toFixed(1))||"null"}-${(null==(s=e.controlPoint2)||null==(s=s.y)?void 0:s.toFixed(1))||"null"}`}).join("-")}`),(0,ae.jsx)(vl,{initialPoints:It(),selectedPointIndex:ge,selectedPoints:ve,transform:C,fitScale:k,pointRefs:we,selected:U,disabled:G,transformMode:Y,pointRadius:J,pointFill:Q,pointStroke:ee,pointStrokeSelected:te,pointStrokeWidth:ne,pointStyle:ie,activePointId:Xe,maxPoints:B,onPointClick:(e,t)=>{if(e.evt.altKey&&!e.evt.shiftKey&&U)return Cl(t,oe,ge,me,Ye,m,r,s,be,ye),Qe.current=!0,e.evt.stopPropagation(),e.evt.preventDefault(),void(e.cancelBubble=!0);if(e.evt.shiftKey&&!e.evt.altKey&&U&&!G&&cl(e,{initialPoints:oe,transform:C,fitScale:k,x,y:w,allowBezier:L,pixelSnapping:W,onPointsChange:s,onPointEdited:l,setVisibleControlPoints:Ye}))Qe.current=!0;else{if(U&&!G&&(e.evt.ctrlKey||e.evt.metaKey)&&!e.evt.altKey&&!e.evt.shiftKey){if(!ct.canInstanceHaveSelection(n))return;if(ve.has(t)){const i=new Set(ve);return i.delete(t),ct.selectPoints(n,i),Qe.current=!0,void e.evt.stopImmediatePropagation()}const i=new Set(ve);return i.add(t),ct.selectPoints(n,i),(!F&&Vl(oe).has(t)&&oe[t]||F&&oe[t])&&qe(oe[t].id),Qe.current=!0,void e.evt.stopImmediatePropagation()}if(!G){if(!U){if(!ct.canInstanceHaveSelection(n))return;if(Rl(t,{initialPoints:oe,allowClose:D,isPathClosed:ut,skeletonEnabled:F,activePointId:Xe},e)&&jl({initialPoints:oe,skeletonEnabled:F,activePointId:Xe}))return;ct.selectPoints(n,new Set([t])),(!F&&Vl(oe).has(t)&&oe[t]||F&&oe[t])&&qe(oe[t].id),Qe.current=!0;return 1!==oe.length||e.evt.altKey||e.evt.shiftKey||e.evt.ctrlKey||e.evt.metaKey?(e.evt.stopPropagation(),e.evt.preventDefault(),void(e.cancelBubble=!0)):void Dt(e,_,A)}if(U&&!G&&!Y){if(!ct.canInstanceHaveSelection(n))return;ct.selectPoints(n,new Set([t])),(!F&&Vl(oe).has(t)&&oe[t]||F&&oe[t])&&qe(oe[t].id),Qe.current=!0;return 1!==oe.length||e.evt.altKey||e.evt.shiftKey||e.evt.ctrlKey||e.evt.metaKey?(e.evt.stopImmediatePropagation(),e.evt.stopPropagation(),e.evt.preventDefault(),void(e.cancelBubble=!0)):void Dt(e,_,A)}Qe.current=!0}}},onPointDragStart:Ot.handlePointDragStart,onPointDragMove:Ot.handlePointDragMove,onPointDragEnd:Ot.handlePointDragEnd,onPointConvert:Ot.handlePointConvert,onControlPointDragStart:Ot.handleControlPointDragStart,onControlPointDragMove:Ot.handleControlPointDragMove,onControlPointDragEnd:Ot.handleControlPointDragEnd,onControlPointConvert:Ot.handleControlPointConvert,onSegmentClick:Ot.handleSegmentClick,visibleControlPoints:Ge,allowBezier:L,isTransforming:Ze},`vector-points-${oe.length}-${oe.map((e,t)=>{var n,i,o,s;return`${t}-${e.x.toFixed(1)}-${e.y.toFixed(1)}-${(null==(n=e.controlPoint1)||null==(n=n.x)?void 0:n.toFixed(1))||"null"}-${(null==(i=e.controlPoint1)||null==(i=i.y)?void 0:i.toFixed(1))||"null"}-${(null==(o=e.controlPoint2)||null==(o=o.x)?void 0:o.toFixed(1))||"null"}-${(null==(s=e.controlPoint2)||null==(s=s.y)?void 0:s.toFixed(1))||"null"}`}).join("-")}`)]}),(0,ae.jsx)(bl,{ref:vt,ghostPoint:De,transform:C,fitScale:k,isShiftKeyHeld:ke,maxPoints:B,initialPointsLength:oe.length,isDragging:gt.current})]})}),Wl=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"vectorregion",object:u.gK.late(()=>u.gK.reference(_d)),vertices:u.gK.array(u.gK.frozen()),closed:!1,isPolygon:!1,readonly:u.gK.optional(u.gK.boolean,!1),converted:!1,transformMode:!1}).volatile(()=>({mouseOverStartPoint:!1,selectedPoint:null,hideable:!0,_supportsTransform:!0,useTransformer:!1,preferTransformer:!1,supportsRotate:!0,supportsScale:!0,isDrawing:!1,vectorRef:null,groupRef:null})).views(e=>({get store(){return(0,u.Zn)(e)},get x(){return e.bboxCoords.left},get y(){return e.bboxCoords.top},get bbox(){var t,n,i;if(null==(t=e.vertices)||!t.length||!(0,u._n)(e))return{};const o=null!=(n=null==(i=e.vectorRef)?void 0:i.getShapeBoundingBox())?n:{};return void 0===o.left||void 0===o.top?{}:o},get bboxCoords(){const t=e.bbox;return t?{left:e.parent.imageToInternalX(t.left),top:e.parent.imageToInternalY(t.top),right:e.parent.imageToInternalX(t.right),bottom:e.parent.imageToInternalY(t.bottom)}:null},get closable(){var t,n;return null!=(t=null==(n=e.control)?void 0:n.closable)&&t},get minPoints(){var t;const n=null==(t=e.control)?void 0:t.minpoints;return n?Number.parseInt(n):void 0},get maxPoints(){var t;const n=null==(t=e.control)?void 0:t.maxpoints;return n?Number.parseInt(n):void 0},get incomplete(){if(e.atMaxLength)return!1;const t=!0===e.closable&&!1===e.closed,n=e.minPoints&&e.vertices.length<e.minPoints;return t||n},get finished(){return e.closable?!e.incomplete:!!e.atMaxLength},get atMaxLength(){return e.maxPoints&&e.vertices.length===e.maxPoints},get pointEnabledSize(){var t;const n=null==(t=e.control)?void 0:t.pointsizeenabled;return n?Number.parseInt(n):5},get pointDisabledSize(){var t;const n=null==(t=e.control)?void 0:t.pointsizedisabled;return n?Number.parseInt(n):3},get pointRadiusFromSize(){var t,n;switch(null!=(t=null==(n=e.control)?void 0:n.pointsize)?t:"small"){case"small":return{enabled:4,disabled:3};case"medium":default:return{enabled:6,disabled:4};case"large":return{enabled:8,disabled:6}}},get pointStyle(){var t,n;return null!=(t=null==(n=e.control)?void 0:n.pointstyle)?t:"circle"},get disabled(){var t,n;const i=null==(t=e.parent)?void 0:t.getToolsManager().findSelectedTool();return null!=(n=null==i?void 0:i.disabled)&&n||e.isReadOnly()||!e.selected&&!e.isDrawing}})).actions(e=>({afterCreate(){e.vertices.length&&(e.converted||(e.vertices=e.relativeToImageCoords(),e.converted=!0,e.checkSizes()))},setMouseOverStartPoint(t){e.mouseOverStartPoint=t},setDrawing(t){e.isDrawing=t},closePoly(){e.closable&&e.vectorRef.close()},onSelection(t){if("reset"===t)return void e.vectorRef.clearSelection();const n=e.parent,i=n.selectionArea.bbox;if(!i)return;const o=n.internalToImageX(i.left),s=n.internalToImageX(i.right),a=n.internalToImageY(i.top),r=n.internalToImageY(i.bottom),l=e.vertices.filter(e=>{const t=o<=e.x&&e.x<=s,n=a<=e.y&&e.y<=r;return t&&n}).map(e=>e.id),c=e.vectorRef;null==c||c.selectPointsByIds(l)},_selectArea(t=!1,n=!1){const i=e.annotation;if(n||e.setTransformMode(!1),i)if(t)i.toggleRegionSelection(e);else{!e.selected?i.selectArea(e):i.unselectAll()}},setHighlight(t){e._highlighted=t},isReadOnly(){var t;return e.readonly||(null==(t=e.annotation)?void 0:t.isReadOnly())},isHovered(){var t;if(!e.vectorRef||null==(t=e.parent)||!t.stageRef)return!1;const n=e.parent.stageRef.getPointerPosition();if(!n)return!1;if("function"==typeof e.vectorRef.isPointOverShape){return e.vectorRef.isPointOverShape(n.x,n.y)}return!1},relativeToImageCoords(){const t=e.parent;return e.vertices.map(e=>Object.assign({},e,{x:t.internalToImageX(e.x),y:t.internalToImageY(e.y)},e.isBezier?{controlPoint1:{x:t.internalToImageX(e.controlPoint1.x),y:t.internalToImageY(e.controlPoint1.y)},controlPoint2:{x:t.internalToImageX(e.controlPoint2.x),y:t.internalToImageY(e.controlPoint2.y)}}:{}))},imageToRelativeCoords(){const t=e.parent;return e.vertices.map(e=>Object.assign({},e,{x:t.imageToInternalX(e.x),y:t.imageToInternalY(e.y)},e.isBezier?{controlPoint1:{x:t.imageToInternalX(e.controlPoint1.x),y:t.imageToInternalY(e.controlPoint1.y)},controlPoint2:{x:t.imageToInternalX(e.controlPoint2.x),y:t.imageToInternalY(e.controlPoint2.y)}}:{}))},isTransforming(){if(!e.vectorRef||!e.selected)return!1;try{const t=e.vectorRef.getSelectedPointIds();return t.length>1}catch(e){return!1}},segGroupRef(t){e.groupRef=t},serialize(){const t={vertices:e.imageToRelativeCoords(),closed:e.closed};return e.parent.createSerializedResult(e,t)},updateImageSize(t,n,i,o){"px"===e.coordstype&&e.vertices.forEach(e=>{const t=i*(e.relativeX||0)/Js,n=o*(e.relativeY||0)/Qs;null==e._setPos||e._setPos(t,n)}),e.annotation&&!e.annotation.sentUserGenerate&&"perc"===e.coordstype&&e.vertices.forEach(t=>{const n=i*t.x/Js,s=o*t.y/Qs;e.coordstype="px",null==t._setPos||t._setPos(n,s)})},updatePointsFromKonvaVector(t){e.vertices.replace(t)},onPathClosedChange(t){e.closed=t},setKonvaVectorRef(t){e.vectorRef=t},selectRegion(t=!1){t||e.setTransformMode(!1),e.scrollToRegion()},addPoint(t,n){if(e.locked||e.isReadOnly())return null;const i=e.parent.currentImageEntity,o=t/100*i.naturalWidth,s=n/100*i.naturalHeight;if(!e.vectorRef)return;if(e.closed)return;if(e.vectorRef.startPoint(o,s)){return e.vectorRef.commitPoint(o,s)}return null},startPoint(t,n){e.locked||e.isReadOnly()||e.vectorRef.startPoint(t,n)},updatePoint(t,n){e.locked||e.isReadOnly()||e.vectorRef.updatePoint(t,n)},commitPoint(t,n){var i;e.locked||e.isReadOnly()||null==(i=e.vectorRef)||i.commitPoint(t,n)},handleFinish(){const t=e.parent.getToolsManager().findSelectedTool();if(t.currentArea)null==t||t.commitDrawingRegion();else{var n;const t=null==(n=e.parent)?void 0:n.annotation;null==t||t.toggleRegionSelection(e)}null==t||null==t.complete||t.complete()},toggleTransformMode(){e.setTransformMode(!e.transformMode)},setTransformMode(t){e.transformMode=t},applyTransform(t,n){e.vectorRef&&("function"==typeof e.vectorRef.commitMultiRegionTransform?e.vectorRef.commitMultiRegionTransform():console.error("ðŸ“Š commitMultiRegionTransform method not available"))},deleteRegion(){var t,n;if(!((null==(t=e.object)||null==(t=t.selectedRegions)?void 0:t.length)>1)&&e.vectorRef&&"function"==typeof e.vectorRef.getSelectedPointIds){const t=e.vectorRef.getSelectedPointIds(),n=e.vertices.length;if(t.length>0&&t.length<n&&"function"==typeof e.vectorRef.deletePointsByIds)return void e.vectorRef.deletePointsByIds(t)}const i=null==(n=e.parent)?void 0:n.getToolsManager().findSelectedTool();null==i||null==i.enable||i.enable(),e.annotation.isReadOnly()||e.isReadOnly()||(e.selected&&e.annotation.unselectAll(!0),e.destroyRegion&&e.destroyRegion(),e.annotation.deleteRegion(e))}})),Ul=u.gK.compose("VectorRegionModel",Ze,mt,Ge,Fa,Wl),Gl=(0,b.PA)(({item:e,suggestion:t})=>{var n,i,o,s,a,r,l,c,d,u,h,g,m,p,f,v,y,b,x,S;const{store:C}=e,k=tr(e,{useStrokeAsFill:!0}),P=null==(n=e.parent)?void 0:n.stageRef,R=null!=(i=null==(o=e.parent)?void 0:o.currentImageEntity)?i:{},j=null!=(s=null==R?void 0:R.naturalWidth)?s:0,N=null!=(a=null==R?void 0:R.naturalHeight)?a:0,{x:T,y:_}=null!=(r=null==(l=e.parent)?void 0:l.layerZoomScalePosition)?r:{x:0,y:0},A=e.disabled||t||C.annotationStore.selected.isLinkingMode,I=!A,M=e.locked||e.isReadOnly()||(null==(c=e.parent)?void 0:c.getSkipInteractions());if(null==(d=e.parent)||!d.stageWidth||null==(u=e.parent)||!u.stageHeight)return null;const E=null==(h=e.parent)||null==(h=h.getToolsManager())?void 0:h.findSelectedTool(),K="MoveTool"===(null==E?void 0:E.fullName);return(0,ae.jsx)(Ga,{item:e,children:(0,ae.jsxs)(us.YJ,{ref:t=>e.segGroupRef(t),name:e.id,visible:!e.hidden,children:[(0,ae.jsx)($l,{ref:t=>e.setKonvaVectorRef(t),initialPoints:Array.from(e.vertices),isMultiRegionSelected:(null==(g=e.object)||null==(g=g.selectedRegions)?void 0:g.length)>1,disableGhostLine:K,onFinish:t=>{A||(t.evt.stopPropagation(),t.evt.preventDefault(),e.handleFinish())},onTransformStart:()=>{e.parent.annotation.history.freeze()},onTransformEnd:t=>{e.parent.annotation.history.unfreeze()},onPointsChange:t=>{e.updatePointsFromKonvaVector(t)},onPathClosedChange:t=>{e.onPathClosedChange(t)},onGhostPointClick:t=>{if(e.isDrawing&&e.vectorRef){e.vectorRef.startPoint(t.x,t.y)&&e.vectorRef.commitPoint(t.x,t.y)}},onClick:t=>{if(t.evt.defaultPrevented)return;if(e.isReadOnly())return;if(e.parent.getSkipInteractions())return;if(e.isDrawing)return;if(t.evt.altKey||t.evt.ctrlKey||t.evt.shiftKey||t.evt.metaKey)return;t.cancelBubble=!0;const n=e.parent.getToolsManager().findSelectedTool();null!=n&&n.currentArea&&n.currentArea!==e&&n.complete&&n.complete(),C.annotationStore.selected.isLinkingMode&&(P.container().style.cursor=w.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t)},onMouseEnter:()=>{C.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseLeave:()=>{C.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},closed:e.closed,width:j,height:N,scaleX:e.parent.stageZoom,scaleY:e.parent.stageZoom,x:0,y:0,transformMode:e.selected&&e.transformMode&&!M,transform:{zoom:e.parent.stageZoom,offsetX:T,offsetY:_},fitScale:e.parent.zoomScale,allowClose:null!=(m=null==(p=e.control)?void 0:p.closable)&&m,allowBezier:null!=(f=null==(v=e.control)?void 0:v.curves)&&f,minPoints:e.minPoints,maxPoints:e.maxPoints,skeletonEnabled:null!=(y=null==(b=e.control)?void 0:b.skeleton)&&y,stroke:e.selected?"#ff0000":k.strokeColor,fill:k.fillColor,strokeWidth:k.strokeWidth,opacity:Number.parseFloat((null==(x=e.control)?void 0:x.opacity)||"1"),pixelSnapping:"pixel"===(null==(S=e.control)?void 0:S.snap),selected:I,disabled:M,pointRadius:e.pointRadiusFromSize,pointFill:e.selected?"#ffffff":"#f8fafc",pointStroke:e.selected?"#ff0000":k.strokeColor,pointStrokeSelected:"#ff6b35",pointStrokeWidth:e.selected?2:1,pointStyle:e.pointStyle,disableInternalPointAddition:!0}),e.vertices.length>0&&(0,ae.jsx)(Oa,{item:e,color:k.strokeColor,strokewidth:k.strokeWidth})]})})});we.addTag("vectorregion",Ul,Gl),we.addRegionType(Ul,"image",e=>!!e.vertices);const Yl=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"rectangleregion",object:u.gK.late(()=>u.gK.reference(_d)),x:u.gK.number,y:u.gK.number,width:u.gK.number,height:u.gK.number,rotation:0,rotationAtCreation:0}).volatile(()=>({startX:0,startY:0,scaleX:1,scaleY:1,opacity:1,fill:!0,fillColor:"#ff8800",fillOpacity:.2,strokeColor:w.A.STROKE_COLOR,strokeWidth:w.A.STROKE_WIDTH,_supportsTransform:!0,hideable:!0,editableFields:[{property:"x",label:"X"},{property:"y",label:"Y"},{property:"width",label:"W"},{property:"height",label:"H"},{property:"rotation",label:"icon:angle"}]})).volatile(()=>({useTransformer:!0,preferTransformer:!0,supportsRotate:!0,supportsScale:!0})).views(e=>({get store(){return(0,u.Zn)(e)},get parent(){return(0,u._n)(e)?e.object:null},get bboxCoords(){const t={left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height};return 0!==e.rotation&&e.parent?nr(t,e.rotation,{x:e.x,y:e.y},e.parent.whRatio):t},get canvasX(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasX(e.x)},get canvasY(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasY(e.y)},get canvasWidth(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasX(e.width)},get canvasHeight(){var t;return null==(t=e.parent)?void 0:t.internalToCanvasY(e.height)}})).actions(e=>({afterCreate(){e.startX=e.x,e.startY=e.y},getDistanceBetweenPoints(e,t){const{x:n,y:i}=e,{x:o,y:s}=t,a=n-o,r=i-s;return Math.sqrt(a**2+r**2)},getHeightOnPerpendicular(e,t,n){const i=t.x-e.x,o=t.y-e.y;return Math.abs(o*n.x-i*n.y+t.x*e.y-t.y*e.x)/Math.sqrt(o*o+i*i)},isAboveTheLine:(e,t,n)=>(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)<0,draw(t,n,i){const o=e.height,s=e.parent.internalToCanvasX(t),a=e.parent.internalToCanvasY(n);if(1===i.length){const t=e.getDistanceBetweenPoints({x:s,y:a},{x:e.canvasX,y:e.canvasY});e.width=e.parent.canvasToInternalX(t),e.rotation=e.rotationAtCreation=Math.atan2(a-e.canvasY,s-e.canvasX)*(180/Math.PI)}else if(2===i.length){const t=i.map(({x:t,y:n})=>({x:e.parent.internalToCanvasX(t),y:e.parent.internalToCanvasY(n)})),{y:n,x:o}=i[0],{y:r,x:l}=i[1];e.isAboveTheLine(t[0],t[1],{x:s,y:a})?(e.x=l,e.y=r,e.rotation=e.rotationAtCreation+180):(e.x=o,e.y=n,e.rotation=e.rotationAtCreation);const c=e.getHeightOnPerpendicular(t[0],t[1],{x:s,y:a});e.height=e.parent.canvasToInternalY(c)}e.setPosition(e.parent.internalToCanvasX(e.x),e.parent.internalToCanvasY(e.y),e.parent.internalToCanvasX(e.width),e.parent.internalToCanvasY(e.height),e.rotation);const r=null==e?void 0:e.bboxCoords;((null==r?void 0:r.left)<0||(null==r?void 0:r.top)<0||(null==r?void 0:r.right)>Js||(null==r?void 0:r.bottom)>Qs)&&(e.height=o)},coordsInside(t,n){const i=e.x,o=e.y,s=e.width*(e.scaleX||1),a=e.height*(e.scaleY||1);return t>i&&t<i+s&&n>o&&n<o+a},setPositionInternal(t,n,i,o,s){e.x=t,e.y=n,e.width=i,e.height=o,e.rotation=(s+360)%360},beforeSetPosition(t,n,i,o,s){if(o<0){let a;const r=Math.abs(s-e.rotation)%360;a=r>90&&r<270?e.flipBack({x:t,y:n,width:i,height:o,rotation:s},!0):e.flipBack({x:t,y:n,width:i,height:o,rotation:s}),[t,n,i,o,s]=[a.x,a.y,a.width,a.height,a.rotation]}return[t,n,i,o,s]},setPosition(t,n,i,o,s){var a;[t,n,i,o,s]=e.beforeSetPosition(t,n,i,o,s);const r=e.parent.canvasToInternalX(t),l=e.parent.canvasToInternalY(n),c=e.parent.canvasToInternalX(i),d=e.parent.canvasToInternalY(o);if("pixel"===(null==(a=e.control)?void 0:a.snap)){var u,h,g,m;const t=e.control.getSnappedPoint({x:r,y:l}),n=e.control.getSnappedPoint({x:r+c,y:l+d});let i=n.x-t.x,o=n.y-t.y;const a=null!=(u=null==(h=e.parent)||null==(h=h.zoomedPixelSize)?void 0:h.x)?u:1,p=null!=(g=null==(m=e.parent)||null==(m=m.zoomedPixelSize)?void 0:m.y)?g:1;i<a&&(i=a),o<p&&(o=p),e.setPositionInternal(t.x,t.y,i,o,s)}else e.setPositionInternal(r,l,c,d,s)},setScale(t,n){e.scaleX=t,e.scaleY=n},addState(t){e.states.push(t)},setFill(t){e.fill=t},updateImageSize(){},flipBack(e,t=!1){let{x:n,y:i,width:o,height:s,rotation:a}=e;const r=a*Math.PI/180,l=new bt.A.Transform;let c;l.rotate(r),t?(c={x:o,y:0},a=(a+180)%360):c={x:0,y:s};const d=l.point(c);return{x:n+d.x,y:i+d.y,width:o,height:-s,rotation:a}},serialize(){const t={x:e.x,y:e.y,width:e.width,height:e.height,rotation:e.rotation};return e.parent.createSerializedResult(e,t)}})),Xl=u.gK.compose("RectRegionModel",Ze,Ge,mt,Fa,nn,Yl),ql=$a(({item:e,setShapeRef:t})=>{var n,i,o;const{store:s}=e,{suggestion:a}=null!=(n=(0,f.useContext)(Gs))?n:{},r=tr(e,{suggestion:a}),l=null==(i=e.parent)?void 0:i.stageRef,c={};return e.parent&&e.inViewPort?(a||e.isReadOnly()||(c.onTransform=({target:e})=>{e.setAttr("skewX",0),e.setAttr("skewY",0)},c.onTransformEnd=t=>{var n;const i=t.target,o=i.getAttr("scaleY")<0;e.setPosition(i.getAttr("x"),i.getAttr("y"),i.getAttr("width")*i.getAttr("scaleX"),i.getAttr("height")*i.getAttr("scaleY"),i.getAttr("rotation")),i.setAttr("scaleX",1),i.setAttr("scaleY",1),"pixel"===(null==(n=e.control)?void 0:n.snap)&&i.position({x:e.canvasX,y:e.canvasY,width:e.canvasWidth,height:e.canvasHeight}),o&&i.setAttr("rotation",e.rotation),e.notifyDrawingFinished()},c.onDragStart=t=>{e.parent.getSkipInteractions()?t.currentTarget.stopDrag(t.evt):e.annotation.history.freeze(e.id)},c.onDragEnd=t=>{var n;const i=t.target;e.setPosition(i.getAttr("x"),i.getAttr("y"),i.getAttr("width"),i.getAttr("height"),i.getAttr("rotation")),e.setScale(i.getAttr("scaleX"),i.getAttr("scaleY")),"pixel"===(null==(n=e.control)?void 0:n.snap)&&i.position({x:e.canvasX,y:e.canvasY,width:e.canvasWidth,height:e.canvasHeight}),e.annotation.history.unfreeze(e.id),e.notifyDrawingFinished()},c.dragBoundFunc=Pt(e,{x:e.x-e.bboxCoords.left,y:e.y-e.bboxCoords.top})),(0,ae.jsxs)(Ga,{item:e,children:[(0,ae.jsx)(us.rw,Object.assign({x:e.canvasX,y:e.canvasY,ref:e=>t(e),width:e.canvasWidth,height:e.canvasHeight,fill:r.fillColor,stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,shadowBlur:0,dash:a?[10,10]:null,scaleX:e.scaleX,scaleY:e.scaleY,opacity:1,rotation:e.rotation,draggable:!e.isReadOnly(),name:`${e.id} _transformable`},c,{onMouseOver:()=>{s.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{s.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||(s.annotationStore.selected.isLinkingMode&&(l.container().style.cursor=w.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t))},listening:!(a||null!=(o=e.annotation)&&o.isDrawing)})),(0,ae.jsx)(Da,{item:e,color:r.strokeColor,strokewidth:r.strokeWidth})]})):null});we.addTag("rectangleregion",Xl,ql),we.addRegionType(Xl,"image");const Zl=u.gK.model({selected:u.gK.optional(u.gK.boolean,!1),group:u.gK.optional(u.gK.string,"default"),shortcut:u.gK.optional(u.gK.maybeNull(u.gK.string),null),disabled:!1}).views(e=>({get obj(){var t,n;if(He.ff.isActive(Ne.cE)){var i;const t=null==(i=e.manager)?void 0:i.root;var o;if(null!=t&&t.annotationStore.selected)return t.annotationStore.selected.names.get(null==(o=e.manager)?void 0:o.name)}return null!=(t=null==(n=e.manager)?void 0:n.obj)?t:(0,u._$)(e).object},get manager(){return(0,u._$)(e).manager},get control(){if(He.ff.isActive(Ne.cE)){var t;const n=(0,u._$)(e).control,{name:i}=n,o=null==(t=e.manager)?void 0:t.root;return null!=o&&o.annotationStore.selected?o.annotationStore.selected.names.get(i):n}return(0,u._$)(e).control},get viewClass(){return()=>null},get fullName(){return e.toolName+(e.dynamic?"-dynamic":"")},get getActiveShape(){const t=e.obj;return t.regs[t.regs.length-1]},get getSelectedShape(){var t;return null==(t=e.control)||null==(t=t.annotation)?void 0:t.highlightedNode},get extraShortcuts(){return{}},get shouldPreserveSelectedState(){if(!He.ff.isActive(Ne.cE)&&!e.obj||!e.control)return!1;return(0,u.Zn)(He.ff.isActive(Ne.cE)?e.control:e.obj).settings.preserveSelectedTool},get isPreserved(){var t;return window.localStorage.getItem(`selected-tool:${null==(t=e.obj)?void 0:t.name}`)===e.fullName}})).actions(e=>({setSelected(t,n){if(e.selected=t,e.afterUpdateSelected(),!n&&t&&e.obj){const t=`selected-tool:${e.obj.name}`;e.shouldPreserveSelectedState&&window.localStorage.setItem(t,e.fullName)}},afterUpdateSelected(){},event(t,n,i){const o=`${t}Ev`;void 0!==e[o]&&e[o].call(e,n,i)},shouldSkipInteractions(t){var n;const i=t.evt&&(t.evt.metaKey||t.evt.ctrlKey),o=null==(n=e.control)||null==(n=n.annotation)?void 0:n.hasSelection;return!!i&&!o},disable(){e.disabled=!0},enable(){e.disabled=!1}})),Jl=u.gK.compose(Zl,Te);var Ql=n(97331),ec=n.n(Ql);const tc=u.gK.model("DrawingTool",{default:!0,mode:u.gK.optional(u.gK.enumeration(["drawing","viewing"]),"viewing"),unselectRegionOnToolChange:!0,isDrawingTool:!0}).volatile(()=>({currentArea:null})).views(e=>({createRegionOptions:e=>Object.assign({},e,{coordstype:"px"}),get tagTypes(){return console.error("Drawing tool model needs to implement tagTypes getter in views"),{}},isIncorrectControl:()=>e.tagTypes.stateTypes===e.control.type&&!e.control.isSelected,isIncorrectLabel:()=>!e.obj.checkLabels(),get isDrawing(){return"drawing"===e.mode},get getActiveShape(){return e.currentArea},getCurrentArea:()=>e.currentArea,current:()=>e.currentArea,canStart:()=>!e.isDrawing&&!e.annotation.isReadOnly(),get defaultDimensions(){return console.warn("Drawing tool model needs to implement defaultDimentions getter in views"),{}},get MIN_SIZE(){return{X:Ss.X/e.obj.stageScale/e.obj.stageWidth*Js,Y:Ss.Y/e.obj.stageScale/e.obj.stageHeight*Qs}},isAllowedInteraction:t=>!((0,Ne.VS)(Ne.cE)&&!e.annotation.editable)&&("segmentation"!==e.group||!(t.offsetX>e.obj.canvasSize.width)&&!(t.offsetY>e.obj.canvasSize.height))})).actions(e=>{let t={ts:0,x:0,y:0};return{event(n,i,[o,s,a,r]){if(i.button>0||i.shiftKey)return;let l=`${n}Ev`;if(void 0!==e[l]&&e[l].call(e,i,[o,s],[a,r]),"click"===n){const n=i.timeStamp;n-t.ts<300&&e.comparePointsWithThreshold(t,{x:o,y:s})&&(l=`dbl${l}`,void 0!==e[l]&&e[l].call(e,i,[o,s],[a,r])),t={ts:n,x:o,y:s}}},comparePointsWithThreshold(t,n,i={x:e.MIN_SIZE.X,y:e.MIN_SIZE.Y}){if(t&&n)return"number"==typeof i&&(i={x:i,y:i}),Math.abs(t.x-n.x)<i.x&&Math.abs(t.y-n.y)<i.y}}}).actions(e=>({createDrawingRegion(t){const n=e.control,i=n.getResultValue();return e.currentArea=e.obj.createDrawingRegion(t,i,n,!1),e.currentArea.setDrawing(!0),e.applyActiveStates(e.currentArea),e.annotation.setIsDrawing(!0),e.currentArea},resumeUnfinishedRegion(t){e.currentArea=t,e.currentArea.setDrawing(!0),e.annotation.regionStore.selection._updateResultsFromRegions([e.currentArea]),e.mode="drawing",e.annotation.setIsDrawing(!0),e.annotation.regionStore.selection.drawingSelect(e.currentArea),null==e.listenForClose||e.listenForClose(),e.manager.findSelectedTool()!==e&&e.manager.selectTool(e,!0)},commitDrawingRegion(){const{currentArea:t,control:n,obj:i}=e;if(!t)return;const o=t.toJSON(),s=Object.keys(t.serialize().value).reduce((e,t)=>(e[t]=o[t],e),{coordstype:"px",dynamic:e.dynamic,converted:!0}),[a,...r]=t.results,l=e.annotation.createResult(s,a.value.toJSON(),n,i);return r.forEach(e=>l.addResult(e.toJSON())),t.setDrawing(!1),e.deleteRegion(),l.notifyDrawingFinished(),l},createRegion(t,n=!1){const i=e.control,o=i.getResultValue(),s=e.obj.activeStates().filter(e=>e!==i);return He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.currentArea=e.annotation.createResult(t,o,i,e.obj,n,s):(e.currentArea=e.annotation.createResult(t,o,i,e.obj,n),e.applyActiveStates(e.currentArea)),e.currentArea},deleteRegion(){e.currentArea=null,e.obj.deleteDrawingRegion()},applyActiveStates(t){e.obj.activeStates().forEach(e=>{t.setValue(e)})},beforeCommitDrawing:()=>!0,canStartDrawing:()=>!e.disabled&&!e.isIncorrectControl()&&!e.isIncorrectLabel()&&e.canStart()&&!e.annotation.isDrawing,startDrawing(t,n){e.annotation.history.freeze(),e.mode="drawing",e.currentArea=e.createDrawingRegion(e.createRegionOptions({x:t,y:n}))},finishDrawing(){e.beforeCommitDrawing()?e._finishDrawing():(e.deleteRegion(),e.control.type===e.tagTypes.stateTypes&&e.annotation.unselectAll(!0),e._resetState())},_finishDrawing(){e.commitDrawingRegion(),e._resetState()},_resetState(){e.annotation.setIsDrawing(!1),e.annotation.history.unfreeze(),e.mode="viewing"}})),nc=tc.named("TwoPointsDrawingTool").views(e=>({get defaultDimensions(){return{width:e.MIN_SIZE.X,height:e.MIN_SIZE.Y}}})).actions(e=>{const t=1,n=2;let i=0,o=0,s=null,a={x:0,y:0};const r={finishDrawing:e.finishDrawing};return{updateDraw:ec()((t,n)=>{0!==i&&e.draw(t,n)},48),draw(t,n){const i=e.getCurrentArea();if(!i)return;const o=i.type.includes("ellipse");let{x1:s,y1:a,x2:r,y2:l}=o?{x1:i.startX,y1:i.startY,x2:t,y2:n}:en.Image.reverseCoordinates({x:i.startX,y:i.startY},{x:t,y:n});s=Math.max(0,s),a=Math.max(0,a),r=Math.min(100,r),l=Math.min(100,l);let[c,d]=[r-s,l-a].map(Math.abs);o&&(c=Math.min(c,Math.min(s,100-s)),d=Math.min(d,Math.min(a,100-a))),i.setPositionInternal(s,a,c,d,i.rotation)},finishDrawing(e,t){s=null,r.finishDrawing(e,t),i=0,o=0},mousedownEv(n,[a,r]){e.canStartDrawing()&&e.isAllowedInteraction(n)&&(s={x:a,y:r},0===i&&(o=t))},mousemoveEv(a,[r,l]){0!==i||!s||e.comparePointsWithThreshold(s,{x:r,y:l})||(i=o,![t,n].includes(i)||(e.startDrawing(s.x,s.y),e.isDrawing))?e.isDrawing&&[t,n].includes(i)&&e.updateDraw(r,l):i=0},mouseupEv(n,[o,s]){i===t&&(a={x:o,y:s},e.isDrawing&&(e.draw(o,s),e.finishDrawing(o,s)))},clickEv(t,[r,l]){e.canStartDrawing()&&e.isAllowedInteraction(t)&&(s&&a&&!e.comparePointsWithThreshold(s,a)||(0===i?o=n:e.isDrawing&&i===n&&(e.draw(r,l),e.finishDrawing(r,l),i=0)))},dblclickEv(t,[n,o]){if(!e.canStartDrawing())return;if(!e.isAllowedInteraction(t))return;const s=e.obj.canvasToInternalX(e.defaultDimensions.width),a=e.obj.canvasToInternalY(e.defaultDimensions.height);if(0===i){if(e.startDrawing(n,o),!e.isDrawing)return;n+=s,o+=a,e.draw(n,o),e.finishDrawing(n,o)}}}}),ic=tc.named("MultipleClicksMixin").views(()=>({canStart(){return!this.current()}})).actions(e=>{let t={x:0,y:0},n=0,i={x:-1,y:-1},o=0;let s=0;const a={canStartDrawing:e.canStartDrawing};return{canStartDrawing:()=>a.canStartDrawing()&&!e.annotation.regionStore.hasSelection,nextPoint(t,i){const o=e.getCurrentArea(),s=e.obj;o&&s&&s.multiImage&&o.item_index!==s.currentImage||(e.getCurrentArea().addPoint(t,i),n++)},listenForClose(){console.error("MultipleClicksMixin model needs to implement listenForClose method in actions")},closeCurrent(){console.error("MultipleClicksMixin model needs to implement closeCurrent method in actions")},finishDrawing(){e.isDrawing&&(e.annotation.regionStore.selection.drawingUnselect(),n=0,e.closeCurrent(),setTimeout(()=>{e._finishDrawing()}))},cleanupUncloseableShape(){e.deleteRegion(),e.control.type===e.tagTypes.stateTypes&&e.annotation.unselectAll(!0),e._resetState()},mousedownEv(t,[n,s]){e.isAllowedInteraction(t)&&(i={x:n,y:s},o=1)},mouseupEv(t,[n,s]){1===o&&e.comparePointsWithThreshold(i,{x:n,y:s})&&(e._clickEv(t,[n,s]),o=2),i={x:-1,y:-1}},clickEv(t,[n,s]){2!==o&&e._clickEv(t,[n,s]),o=3,i={x:-1,y:-1}},_clickEv(i,[o,a]){if(e.isAllowedInteraction(i))if(e.current())1===n&&e.comparePointsWithThreshold(t,{x:o,y:a})&&i.timeStamp-s<350?e.drawDefault():e.comparePointsWithThreshold(t,{x:o,y:a})?n>2&&e.finishDrawing():e.nextPoint(o,a);else{if(!e.canStartDrawing())return;t={x:o,y:a},n=1,s=i.timeStamp,e.startDrawing(o,a),e.listenForClose()}},drawDefault(){const{x:n,y:i}=t,o=e.obj.canvasToInternalX(e.defaultDimensions.length),s=e.obj.canvasToInternalY(e.defaultDimensions.length);e.nextPoint(n+o,i),e.nextPoint(n+o/2,i+Math.sin(Math.PI/3)*s),e.finishDrawing()}}}),oc=tc.named("ThreePointsDrawingTool").views(e=>({canStart(){return!this.current()},get defaultDimensions(){return{width:e.MIN_SIZE.X,height:e.MIN_SIZE.Y}}})).actions(e=>{let t=[],n=0;let i=0,o=null;const s={finishDrawing:e.finishDrawing};return{canStartDrawing:()=>!e.isIncorrectControl(),updateDraw:(n,o)=>{var s;0===i?null==(s=e.getCurrentArea())||s.draw(n,o,t):4===i&&e.draw(n,o)},nextPoint(n,i){t.push({x:n,y:i}),e.getCurrentArea().draw(n,i,t)},draw(t,n){const i=e.getCurrentArea();if(!i)return;let{x1:o,y1:s,x2:a,y2:r}=en.Image.reverseCoordinates({x:i.startX,y:i.startY},{x:t,y:n});o=Math.max(0,o),s=Math.max(0,s),a=Math.min(100,a),r=Math.min(100,r),i.setPositionInternal(o,s,a-o,r-s,i.rotation)},finishDrawing(n,a){e.isDrawing&&(t=[],o=null,i=0,s.finishDrawing(n,a),setTimeout(()=>{e._finishDrawing()}))},mousemoveEv(t,[s,a]){e.isDrawing&&(1===n&&(i=4),4===i&&o?(e.startDrawing(o.x,o.y),e.updateDraw(s,a)):0===i&&e.updateDraw(s,a))},mousedownEv(t,[i,s]){e.canStartDrawing()&&!e.annotation.isDrawing&&e.isAllowedInteraction(t)&&(n=1,o={x:i,y:s},e.mode="drawing")},mouseupEv(t,[o,s]){e.canStartDrawing()&&e.isDrawing&&(4===i&&(e.draw(o,s),e.finishDrawing(o,s)),n=2)},clickEv(t,[o,s]){e.canStartDrawing()&&e.isAllowedInteraction(t)&&(0===i&&e._clickEv(t,[o,s]),n=3)},_clickEv(n,[i,o]){t.length>=2?e.finishDrawing(i,o):0===t.length?(t=[{x:i,y:o}],e.startDrawing(i,o)):e.nextPoint(i,o)},dblclickEv(t,[o,s]){if(n=5,!e.canStartDrawing())return;if(!e.isAllowedInteraction(t))return;const a=e.obj.canvasToInternalX(e.defaultDimensions.width),r=e.obj.canvasToInternalY(e.defaultDimensions.height);if(0===i){if(e.startDrawing(o,s),!e.isDrawing)return;o+=a,s+=r,e.draw(o,s),e.finishDrawing(o,s)}}}});var sc=n(18229),ac=n(51366),rc=n(20963),lc=n(15311);const cc=["node"],dc=Object.assign({LabelModel:{name:"",icon:()=>null},RichTextRegionModel:{name:"HTML",icon:kn.hfJ,getContent:e=>(0,ae.jsx)("span",{style:{color:"#5a5a5a"},children:e.text}),fullContent:e=>(0,ae.jsxs)("div",{children:[(0,ae.jsx)("div",{children:e.start}),(0,ae.jsx)("div",{children:e.startOffset}),(0,ae.jsx)("div",{children:JSON.stringify(e.globalOffsets,null,2)})]})},ParagraphsRegionModel:{name:"Paragraphs",icon:kn.hfJ,getContent:e=>(0,ae.jsx)("span",{style:{color:"#5a5a5a"},children:e.text})},AudioRegionModel:{name:"Audio",icon:sc.A},TimeSeriesRegionModel:{name:"TimeSeries",icon:ac.A},TextAreaRegionModel:{name:"Input",icon:rc.A,getContent:e=>(0,ae.jsx)("span",{style:{color:"#5a5a5a"},children:e._value})},RectRegionModel:{name:"Rect",icon:kn.x1y,altIcon:kn.kT6},Rect3PointRegionModel:{name:"Rect3Point",icon:kn.WxS,altIcon:kn.x$C},VideoRectangleRegionModel:{name:"Video Rect",icon:kn.x1y,altIcon:kn.kT6,getContent:e=>{var t;return(0,ae.jsxs)("span",{style:{color:"#5a5a5a"},children:["from ",null==(t=e.sequence[0])?void 0:t.frame," frame"]})}},PolygonRegionModel:{name:"Polygon",icon:kn.aqQ,altIcon:kn.jhL},VectorRegionModel:{name:"Vector",icon:kn.aqQ,altIcon:kn.jhL},EllipseRegionModel:{name:"Ellipse",icon:kn.cu2,altIcon:kn.FBt},KeyPointRegionModel:{name:"KeyPoint",icon:kn.OxY,altIcon:kn.pFx},BrushRegionModel:{name:"Brush",icon:kn._3l,altIcon:kn.HkR},BitmaskRegionModel:{name:"Brush",icon:kn._3l,altIcon:kn.HkR},ChoicesModel:{name:"Classification",icon:lc.A},TextAreaModel:{name:"Input",icon:rc.A},TimelineRegionModel:{name:"Timeline Span",icon:kn.hpC}},Object.fromEntries(we.customTags.filter(e=>e.region).map(e=>[e.region.name,e.region.nodeView]))),uc=(0,b.PA)(e=>{let{node:t}=e,n=(0,Se.A)(e,cc);const i=hc(t);if(!i||!(i in dc))return console.error(`No ${i} in NodeView`),null;const{icon:o}=dc[i];return(0,ae.jsx)(o,Object.assign({},n))}),hc=e=>e.$treenode?(0,u.Pw)(e).name:null,gc=({size:e})=>(0,ae.jsx)("span",{style:{display:"block",width:e,height:e,background:"rgba(0, 0, 0, 0.25)",borderRadius:"100%"}}),mc=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{label:"Brush",ariaLabel:"brush-tool",active:e.selected,shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,icon:e.iconClass,tool:e,onClick:()=>{e.selected||e.manager.selectTool(e,!0)},controls:e.controls})),pc=u.gK.model("BrushTool",{strokeWidth:u.gK.optional(u.gK.number,15),group:"segmentation",shortcut:"tool:brush",smart:!0,unselectRegionOnToolChange:!1}).volatile(()=>({canInteractWithRegions:!1})).views(e=>({get viewClass(){return()=>(0,ae.jsx)(mc,{item:e})},get iconComponent(){return e.dynamic?dc.BrushRegionModel.altIcon:dc.BrushRegionModel.icon},get tagTypes(){return{stateTypes:"brushlabels",controlTagTypes:["brushlabels","brush"]}},get controls(){return[(0,ae.jsx)(Xn,{value:e.strokeWidth,min:1,max:50,reverse:!0,align:"vertical",minIcon:(0,ae.jsx)(gc,{size:8}),maxIcon:(0,ae.jsx)(gc,{size:16}),onChange:t=>{e.setStroke(t)}},"brush-size")]},get extraShortcuts(){return{"tool:decrease-tool":["Decrease size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth-5,1,50))}],"tool:increase-tool":["Increase size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth+5,1,50))}]}}})).actions(e=>{let t,n;return{commitDrawingRegion(){const{currentArea:t,control:n,obj:i}=e,o=t.toJSON(),s={coordstype:"px",touches:o.touches,dynamic:o.dynamic},a=e.annotation.createResult(s,t.results[0].value.toJSON(),n,i);return t.setDrawing(!1),e.applyActiveStates(a),e.deleteRegion(),a.notifyDrawingFinished(),a},setStroke(t){e.strokeWidth=t,e.updateCursor()},afterUpdateSelected(){e.updateCursor()},addPoint(e,n){t.addPoint(Math.floor(e),Math.floor(n))},mouseupEv(i,o,[s,a]){"drawing"===e.mode&&(e.addPoint(s,a),e.mode="viewing",t.setDrawing(!1),t.endPath(),n?setTimeout(()=>{const t=e.commitDrawingRegion();e.obj.annotation.selectArea(t),e.annotation.history.unfreeze(),e.obj.annotation.setIsDrawing(!1)}):(e.annotation.history.unfreeze(),e.obj.annotation.setIsDrawing(!1)))},mousemoveEv(t,n,[i,o]){e.isAllowedInteraction(t)&&"drawing"===e.mode&&(0,E.findClosestParent)(t.target,t=>t===e.obj.stageRef.content,e=>e.parentElement)&&e.addPoint(i,o)},mousedownEv(i,o,[s,a]){if(!e.isAllowedInteraction(i))return;if(!(0,E.findClosestParent)(i.target,t=>t===e.obj.stageRef.content,e=>e.parentElement))return;const r=e.control,l=e.obj;if(t=e.getSelectedShape,!(l&&t&&l.multiImage&&l.currentImage!==t.item_index))if(t&&"brushregion"===t.type)e.annotation.history.freeze(),e.mode="drawing",t.setDrawing(!0),e.obj.annotation.setIsDrawing(!0),n=!1,t.beginPath({type:"add",strokeWidth:e.strokeWidth||r.strokeWidth}),e.addPoint(s,a);else{if(!e.canStartDrawing())return;if(e.tagTypes.stateTypes===e.control.type&&!e.control.isSelected)return;e.annotation.history.freeze(),e.mode="drawing",n=!0,e.obj.annotation.setIsDrawing(!0),t=e.createDrawingRegion({touches:[],coordstype:"px"}),t.beginPath({type:"add",strokeWidth:e.strokeWidth||r.strokeWidth}),e.addPoint(s,a)}}}}),fc=u.gK.model("BrushCursorMixin").views(e=>({get cursorStyleRule(){const t=e.strokeWidth;return Ia.A.createBrushSizeCircleCursor(t)}})).actions(e=>({updateCursor(){var t;if(!e.selected||null==(t=e.obj)||!t.stageRef)return;e.obj.stageRef.container().style.cursor=e.cursorStyleRule}})),vc=u.gK.compose(pc.name,Jl,js,tc,fc,pc),yc=({size:e})=>(0,ae.jsx)("span",{style:{display:"block",width:e,height:e,background:"rgba(0, 0, 0, 0.25)",borderRadius:"100%"}}),bc=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{label:"Bitmask",ariaLabel:"bitmask-tool",active:e.selected,shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,icon:e.iconClass,tool:e,onClick:()=>{e.selected||e.manager.selectTool(e,!0)},controls:e.controls})),xc=u.gK.model("BitmaskTool",{strokeWidth:u.gK.optional(u.gK.number,15),group:"segmentation",shortcut:"tool:brush",smart:!0,unselectRegionOnToolChange:!1}).volatile(()=>({canInteractWithRegions:!1})).views(e=>({get viewClass(){return()=>(0,ae.jsx)(bc,{item:e})},get iconComponent(){return e.dynamic?dc.BitmaskRegionModel.altIcon:dc.BitmaskRegionModel.icon},get tagTypes(){return{stateTypes:"bitmasklabels",controlTagTypes:["bitmasklabels","bitmask"]}},get controls(){return[(0,ae.jsx)(Xn,{value:e.strokeWidth,min:1,max:50,reverse:!0,align:"vertical",minIcon:(0,ae.jsx)(yc,{size:8}),maxIcon:(0,ae.jsx)(yc,{size:16}),onChange:t=>{e.setStroke(t)}},"brush-size")]},get extraShortcuts(){return{"tool:decrease-tool":["Decrease size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth-5,1,50))}],"tool:increase-tool":["Increase size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth+5,1,50))}]}}})).actions(e=>{let t,n;return{commitDrawingRegion(){const{currentArea:t,control:n,obj:i}=e,o={imageDataURL:t.getImageDataURL()},s=e.annotation.createResult(o,t.results[0].value.toJSON(),n,i);t.setDrawing(!1),e.applyActiveStates(s);try{e.deleteRegion()}catch(e){}return s.notifyDrawingFinished(),s},setStroke(t){e.strokeWidth=t,e.updateCursor()},afterUpdateSelected(){e.updateCursor()},addPoint(n,i){t.addPoint(n,i,e.strokeWidth||e.control.strokeWidth)},mouseupEv(i,o,[s,a]){if("drawing"===e.mode)if(e.addPoint(s,a),e.mode="viewing",t.setDrawing(!1),t.endPath(),n){const t=e.commitDrawingRegion();e.obj.annotation.selectArea(t),e.annotation.history.unfreeze(),e.obj.annotation.setIsDrawing(!1)}else e.annotation.history.unfreeze(),e.obj.annotation.setIsDrawing(!1)},mousemoveEv(t,n,[i,o]){e.isAllowedInteraction(t)&&"drawing"===e.mode&&(0,E.findClosestParent)(t.target,t=>t===e.obj.stageRef.content,e=>e.parentElement)&&e.addPoint(i,o)},mousedownEv(i,o,[s,a]){if(!e.isAllowedInteraction(i))return;if(!(0,E.findClosestParent)(i.target,t=>t===e.obj.stageRef.content,e=>e.parentElement))return;const r=e.control,l=e.obj;if(!(l.regs.some(e=>e.highlighted)||(t=e.getSelectedShape,l&&t&&l.multiImage&&l.currentImage!==t.item_index))){if(t&&"bitmaskregion"===t.type)e.annotation.history.freeze(),e.mode="drawing",n=!1,t.setDrawing(!0),e.obj.annotation.setIsDrawing(!0);else{if(!e.canStartDrawing())return;if(e.tagTypes.stateTypes===e.control.type&&!e.control.isSelected)return;e.annotation.history.freeze(),e.mode="drawing",n=!0,e.obj.annotation.setIsDrawing(!0),t=e.createDrawingRegion({imageDataURL:null})}t.beginPath({type:"add",strokeWidth:e.strokeWidth||r.strokeWidth,x:s,y:a})}}}}),wc=u.gK.model("BitmaskCursorMixin").views(e=>({get cursorStyleRule(){e.strokeWidth;return"crosshair"}})).actions(e=>({updateCursor(){var t;if(!e.selected||null==(t=e.obj)||!t.stageRef)return;e.obj.stageRef.container().style.cursor=e.cursorStyleRule}})),Sc=u.gK.compose(xc.name,Jl,js,tc,wc,xc),Cc=({size:e})=>(0,ae.jsx)("span",{style:{display:"block",width:e,height:e,background:"rgba(0, 0, 0, 0.25)",borderRadius:"100%"}}),kc=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{label:"Eraser",ariaLabel:"eraser",shortcut:"tool:eraser",active:e.selected,extraShortcuts:e.extraShortcuts,tool:e,disabled:!e.getSelectedShape,onClick:()=>{e.selected||e.manager.selectTool(e,!0)},icon:e.iconClass,controls:e.controls})),Pc=u.gK.model("EraserTool",{strokeWidth:u.gK.optional(u.gK.number,10),group:"segmentation",unselectRegionOnToolChange:!1}).volatile(()=>({index:9999,canInteractWithRegions:!1})).views(e=>({get viewClass(){return()=>(0,ae.jsx)(kc,{item:e})},get iconComponent(){return kn.IIu},get controls(){return[(0,ae.jsx)(Xn,{value:e.strokeWidth,min:1,max:50,reverse:!0,align:"vertical",minIcon:(0,ae.jsx)(Cc,{size:8}),maxIcon:(0,ae.jsx)(Cc,{size:16}),onChange:t=>{e.setStroke(t)}},"eraser-size")]},get extraShortcuts(){return{"tool:decrease-tool":["Decrease size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth-5,1,50))}],"tool:increase-tool":["Increase size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth+5,1,50))}]}}})).actions(e=>{let t;return{afterUpdateSelected(){e.updateCursor()},addPoint(e,n){t.addPoint(Math.floor(e),Math.floor(n))},setStroke(t){e.strokeWidth=t,e.updateCursor()},mouseupEv(){"drawing"===e.mode&&(e.mode="viewing",t.endPath())},mousemoveEv(n,i,[o,s]){var a;"drawing"===e.mode&&(0,E.findClosestParent)(n.target,t=>t===e.obj.stageRef.content,e=>e.parentElement)&&"brushregion"===(null==(a=t)?void 0:a.type)&&e.addPoint(o,s)},mousedownEv(n,i,[o,s]){e.isAllowedInteraction(n)&&(0,E.findClosestParent)(n.target,t=>t===e.obj.stageRef.content,e=>e.parentElement)&&(t=e.getSelectedShape,t&&t&&"brushregion"===t.type&&(e.mode="drawing",t.beginPath({type:"eraser",opacity:1,strokeWidth:e.strokeWidth}),e.addPoint(o,s)))}}}),Rc=u.gK.compose(Pc.name,Jl,js,tc,fc,Pc),jc=({size:e})=>(0,ae.jsx)("span",{style:{display:"block",width:e,height:e,background:"rgba(0, 0, 0, 0.25)",borderRadius:"100%"}}),Nc=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{label:"Eraser",ariaLabel:"eraser",shortcut:"tool:eraser",active:e.selected,extraShortcuts:e.extraShortcuts,tool:e,disabled:!e.getSelectedShape,onClick:()=>{e.selected||e.manager.selectTool(e,!0)},icon:e.iconClass,controls:e.controls})),Tc=u.gK.model("BitmaskEraserTool",{strokeWidth:u.gK.optional(u.gK.number,10),group:"segmentation",unselectRegionOnToolChange:!1}).volatile(()=>({index:9999,canInteractWithRegions:!1})).views(e=>({get viewClass(){return()=>(0,ae.jsx)(Nc,{item:e})},get iconComponent(){return kn.IIu},get controls(){return[(0,ae.jsx)(Xn,{value:e.strokeWidth,min:1,max:50,reverse:!0,align:"vertical",minIcon:(0,ae.jsx)(jc,{size:8}),maxIcon:(0,ae.jsx)(jc,{size:16}),onChange:t=>{e.setStroke(t)}},"eraser-size")]},get extraShortcuts(){return{"tool:decrease-tool":["Decrease size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth-5,1,50))}],"tool:increase-tool":["Increase size",()=>{e.setStroke((0,E.clamp)(e.strokeWidth+5,1,50))}]}}})).actions(e=>{let t;return{afterUpdateSelected(){e.updateCursor()},addPoint(n,i){t.addPoint(n,i,e.strokeWidth,{erase:!0})},setStroke(t){e.strokeWidth=t,e.updateCursor()},mouseupEv(){"drawing"===e.mode&&(e.mode="viewing",t.endPath())},mousemoveEv(n,i,[o,s]){var a;"drawing"===e.mode&&(0,E.findClosestParent)(n.target,t=>t===e.obj.stageRef.content,e=>e.parentElement)&&"bitmaskregion"===(null==(a=t)?void 0:a.type)&&e.addPoint(o,s)},mousedownEv(n,i,[o,s]){e.isAllowedInteraction(n)&&(0,E.findClosestParent)(n.target,t=>t===e.obj.stageRef.content,e=>e.parentElement)&&(t=e.getSelectedShape,t&&t&&"bitmaskregion"===t.type&&(e.mode="drawing",t.beginPath({type:"eraser",opacity:1,strokeWidth:e.strokeWidth,x:o,y:s}),e.addPoint(o,s)))}}}),_c=u.gK.compose(Tc.name,Jl,js,tc,wc,Tc),Ac=u.gK.model("KeyPointTool",{default:u.gK.optional(u.gK.boolean,!0),group:"segmentation",shortcut:"tool:key-point",smart:!0}).views(()=>({get tagTypes(){return{stateTypes:"keypointlabels",controlTagTypes:["keypointlabels","keypoint"]}},get viewTooltip(){return"Key Point"},get iconComponent(){return self.dynamic?dc.KeyPointRegionModel.altIcon:dc.KeyPointRegionModel.icon}})).actions(e=>({clickEv(t,[n,i]){var o;if(!e.canStartDrawing())return;if(!e.isAllowedInteraction(t))return;const s=e.control;if("keypointlabels"===s.type&&!s.isSelected)return;if(e.annotation.isReadOnly())return;const a=e.createRegion(Object.assign({},null==(o=e.control)?void 0:o.getSnappedPoint({x:n,y:i}),{width:e.obj.canvasToInternalX(Number(s.strokewidth)),dynamic:e.dynamic,negative:e.dynamic&&t.altKey}));a.setDrawing(!1),a.notifyDrawingFinished()}})),Ic=u.gK.compose(Ac.name,Jl,js,tc,Ac),Mc=u.gK.model("PolygonTool",{group:"segmentation",shortcut:"tool:polygon"}).views(e=>{const t={createRegionOptions:e.createRegionOptions,isIncorrectControl:e.isIncorrectControl,isIncorrectLabel:e.isIncorrectLabel};return{get getActivePolygon(){const t=e.currentArea;return t&&!(0,u._n)(t)||t&&t.closed||void 0===t||t&&"polygonregion"!==t.type?null:t},get tagTypes(){return{stateTypes:"polygonlabels",controlTagTypes:["polygonlabels","polygon"]}},get viewTooltip(){return"Polygon region"},get iconComponent(){return e.dynamic?dc.PolygonRegionModel.altIcon:dc.PolygonRegionModel.icon},get defaultDimensions(){return Ps},createRegionOptions:({x:e,y:n})=>t.createRegionOptions({points:[[e,n]],width:10,closed:!1}),isIncorrectControl:()=>t.isIncorrectControl()&&null===e.current(),isIncorrectLabel:()=>!e.current()&&t.isIncorrectLabel(),canStart:()=>null===e.current(),current:()=>e.getActivePolygon}}).actions(e=>{let t,n;return{handleToolSwitch(t){var n;if(e.stopListening(),null!=(n=e.getCurrentArea())&&n.isDrawing&&"ZoomPanTool"!==t.toolName){var i,o;const t=null==(i=e.getCurrentArea())?void 0:i.toJSON();(null==t||null==(o=t.points)?void 0:o.length)>2?e.finishDrawing():e.cleanupUncloseableShape()}},listenForClose(){n=!1,t=(0,d.lB)(e.getCurrentArea(),"closed",()=>{var t;null!=(t=e.getCurrentArea())&&t.closed&&!n&&e.finishDrawing()},!0)},stopListening(){t&&t()},closeCurrent(){e.stopListening(),n||(n=!0,e.getCurrentArea().closePoly())},startDrawing(t,n){var i;const o=null==(i=e.control)?void 0:i.getSnappedPoint({x:t,y:n});e.mode="drawing",e.currentArea=e.createRegion(e.createRegionOptions({x:o.x,y:o.y}),!0),e.setDrawing(!0),He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)||e.applyActiveStates(e.currentArea)},_finishDrawing(){const{currentArea:t,control:n}=e;e.currentArea.notifyDrawingFinished(),e.setDrawing(!1),e.currentArea=null,e.mode="viewing",e.annotation.afterCreateResult(t,n)},setDrawing(t){var n;null==(n=e.currentArea)||n.setDrawing(t),e.annotation.setIsDrawing(t)},deleteRegion(){const{currentArea:t}=e;e.setDrawing(!1),e.currentArea=null,t&&t.deleteRegion()}}}),Ec=u.gK.compose(Mc.name,Jl,js,ic,Mc),Kc=u.gK.model("VectorTool",{group:"segmentation",shortcut:"tool:vector"}).views(e=>{const t={createRegionOptions:e.createRegionOptions,isIncorrectControl:e.isIncorrectControl,isIncorrectLabel:e.isIncorrectLabel};return{get getActiveVector(){const t=e.currentArea;return t&&!(0,u._n)(t)||t&&t.closed||void 0===t||t&&"vectorregion"!==t.type?null:t},get tagTypes(){return{stateTypes:"vectorlabels",controlTagTypes:["vectorlabels","vector"]}},get viewTooltip(){return"Vector region"},get iconComponent(){return e.dynamic?dc.VectorRegionModel.altIcon:dc.VectorRegionModel.icon},get defaultDimensions(){return Rs},createRegionOptions:()=>t.createRegionOptions({vertices:[],converted:!0,closed:!1,transformMode:!1}),isIncorrectControl:()=>t.isIncorrectControl()&&null===e.current(),isIncorrectLabel:()=>!e.current()&&t.isIncorrectLabel(),canStart(){const t=e.current();return null===t||t&&t.closed},current(){var t;if(e.currentArea)return e.getActiveVector;const n=e.obj;let i=[];if(null!=n&&n.regs&&n.regs.length>0?i=Array.from(n.regs):null!=(t=e.annotation)&&t.regions&&e.annotation.regions.length>0&&(i=Array.from(e.annotation.regions)),i.length>0){var o,s;const t=null==(o=e.annotation)||null==(o=o.regionStore)||null==(o=o.selection)?void 0:o.highlighted;if(t&&"vectorregion"===t.type&&!t.closed&&(0,u._n)(t))return t;const n=((null==(s=e.annotation)?void 0:s.selectedRegions)||[]).filter(e=>"vectorregion"===e.type&&!e.closed&&(0,u._n)(e));if(1===n.length)return n[0];const a=i.find(e=>"vectorregion"===e.type&&e.isDrawing&&!e.closed&&(0,u._n)(e));if(a)return a}return e.getActiveVector},getCurrentArea(){const t=e.current();return t||e.currentArea}}}).actions(e=>{const t=e.canStartDrawing,n=(e.startDrawing,e._finishDrawing,e.deleteRegion,e.event,[]);let i=!1,o=null,s={ts:0,x:0,y:0};return{event(t,n,[i,o,a,r]){if(n.button>0)return;let l=`${t}Ev`;if(void 0!==e[l]&&e[l].call(e,n,[i,o],[a,r]),"click"===t){const t=n.timeStamp;t-s.ts<300&&e.comparePointsWithThreshold(s,{x:i,y:o})&&(l=`dbl${l}`,void 0!==e[l]&&e[l].call(e,n,[i,o],[a,r])),s={ts:t,x:i,y:o}}},canStartDrawing(){if(t())return!0;const n=e.current();return!(!n||!n.isDrawing&&n.closed)&&(!e.disabled&&!e.isIncorrectControl()&&!e.isIncorrectLabel()&&e.canStart()&&!e.annotation.isDrawing)},handleToolSwitch(t){var n;if(e.stopListening(),null!=(n=e.getCurrentArea())&&n.isDrawing&&"ZoomPanTool"!==t.toolName){var i,o;const t=null==(i=e.getCurrentArea())?void 0:i.toJSON();(null==t||null==(o=t.vertices)?void 0:o.length)>2?e.finishDrawing():e.cleanupUncloseableShape()}},listenForClose(){const{currentArea:t}=e;t&&t.closable&&(n.push((0,d.lB)(t,"closed",({newValue:t})=>t.storedValue&&e.finishDrawing(),!0)),n.push((0,d.lB)(t,"finished",({newValue:t})=>t.storedValue&&e.finishDrawing(),!0)))},stopListening(){for(const e of n)e()},realCoordsFromCursor(t,n){const i=e.obj.currentImageEntity;return{x:t/100*i.naturalWidth,y:n/100*i.naturalHeight}},startDrawing(t,n){if(!e.canStartDrawing())return;const{x:i,y:s}=e.realCoordsFromCursor(t,n);o={x:i,y:s};let a=e.getCurrentArea();if(!a){const t=e.obj;if(t&&t.regs){const n=t.regs.find(e=>"vectorregion"===e.type&&e.isDrawing&&!e.closed&&(0,u._n)(e));n&&(a=n,e.currentArea=a)}}const r=a&&(0,u._n)(a)?a:null;e.annotation.history.freeze(),r?(e.currentArea=r,r.isDrawing||r.setDrawing(!0)):e.currentArea=e.createRegion(e.createRegionOptions(),!0),e.mode="drawing",e.setDrawing(!0),e.applyActiveStates(e.currentArea),e.listenForClose(),r&&0!==r.vertices.length||setTimeout(()=>{e.currentArea.startPoint(i,s)})},mousedownEv(t,[n,o]){"drawing"!==e.mode&&(i=!0,e.startDrawing(n,o))},mousemoveEv(t,[n,o]){if(!e.isDrawing)return;const{x:s,y:a}=e.realCoordsFromCursor(n,o);var r;i&&e.checkDistance(s,a)&&(null==(r=e.currentArea)||null==r.updatePoint||r.updatePoint(s,a))},mouseupEv(t,[n,o]){if(!e.isDrawing)return;const{x:s,y:a}=e.realCoordsFromCursor(n,o);i=!1,setTimeout(()=>{var t;null==(t=e.currentArea)||null==t.commitPoint||t.commitPoint(s,a),e.annotation.history.unfreeze(),e.finishDrawing()})},checkDistance(e,t){const n=e-o.x,i=t-o.y;return Math.abs(n)>=5||Math.abs(i)>=5},_finishDrawing(){var t;const{currentArea:n,control:o}=e;null!==n&&(i=!1,null==(t=e.currentArea)||t.notifyDrawingFinished(),e.setDrawing(!1),e.mode="viewing",e.currentArea=null,e.stopListening(),n.incomplete||e.annotation.afterCreateResult(n,o))},setDrawing(t){var n;null==(n=e.currentArea)||n.setDrawing(t),e.annotation.setIsDrawing(t)},deleteRegion(){const{currentArea:t}=e;e.setDrawing(!1),e.currentArea=null,e.stopListening(),t&&t.deleteRegion()},addPoint(t,n){const{x:i,y:o}=e.realCoordsFromCursor(t,n);let s=e.getCurrentArea();if(!s){const t=e.obj;if(t&&t.regs){const n=t.regs.find(e=>"vectorregion"===e.type&&e.isDrawing&&!e.closed&&(0,u._n)(e));n&&(s=n,e.currentArea=s)}}s&&s.addPoint(i,o)},finishDrawing(){var t;null!=(t=e.currentArea)&&t.finished&&e._finishDrawing()},complete(){e._finishDrawing()},cleanupUncloseableShape(){var t;null!=(t=e.currentArea)&&t.incomplete&&e.deleteRegion()}}}),Dc=u.gK.compose(Kc.name,Jl,js,ic,Kc),Oc=u.gK.model("BaseNTool",{group:"segmentation",smart:!0,shortcut:"tool:rect"}).views(e=>{const t={createRegionOptions:e.createRegionOptions,isIncorrectControl:e.isIncorrectControl,isIncorrectLabel:e.isIncorrectLabel};return{get getActivePolygon(){const t=e.currentArea;return t&&t.closed||void 0===t||t&&"rectangleregion"!==t.type?null:t},get tagTypes(){return{stateTypes:"rectanglelabels",controlTagTypes:["rectanglelabels","rectangle"]}},get defaultDimensions(){return Cs},createRegionOptions:({x:n,y:i})=>t.createRegionOptions({x:n,y:i,height:e.obj.canvasToInternalY(1),width:e.obj.canvasToInternalX(1)}),isIncorrectControl:()=>t.isIncorrectControl()&&null===e.current(),isIncorrectLabel:()=>!e.current()&&t.isIncorrectLabel(),canStart:()=>null===e.current()&&!e.annotation.isReadOnly(),current:()=>e.getActivePolygon}}).actions(e=>{const t={commitDrawingRegion:e.commitDrawingRegion};return{beforeCommitDrawing(){const t=e.getActiveShape;return t.width>e.MIN_SIZE.X&&t.height>e.MIN_SIZE.Y},commitDrawingRegion(){const{currentArea:n,control:i,obj:o}=e;if(n){if("pixel"===(null==i?void 0:i.snap)){const e=n.parent.internalToCanvasX(n.x),t=n.parent.internalToCanvasY(n.y),i=n.parent.internalToCanvasX(n.width),o=n.parent.internalToCanvasY(n.height);n.setPosition(e,t,i,o,n.rotation)}return t.commitDrawingRegion()}}}}),Lc=u.gK.model("RectangleTool",{shortcut:"tool:rect"}).views(e=>({get viewTooltip(){return"Rectangle"},get iconComponent(){return e.dynamic?dc.RectRegionModel.altIcon:dc.RectRegionModel.icon}})),zc=u.gK.model("Rectangle3PointTool",{shortcut:"tool:rect-3point"}).views(e=>({get viewTooltip(){return"3 Point Rectangle"},get iconComponent(){return e.dynamic?dc.Rect3PointRegionModel.altIcon:dc.Rect3PointRegionModel.icon}})),Bc=u.gK.compose(Lc.name,Jl,js,nc,Oc,Lc,Te),Fc=u.gK.compose(zc.name,Jl,js,oc,Oc,zc,Te),Hc=u.gK.model("EllipseTool",{group:"segmentation",shortcut:"tool:ellipse"}).views(e=>{const t={createRegionOptions:e.createRegionOptions};return{get tagTypes(){return{stateTypes:"ellipselabels",controlTagTypes:["ellipselabels","ellipse"]}},get viewTooltip(){return"Ellipse region"},get iconComponent(){return e.dynamic?dc.EllipseRegionModel.altIcon:dc.EllipseRegionModel.icon},get defaultDimensions(){const{radius:e}=ks;return{width:e,height:e}},createRegionOptions:({x:e,y:n})=>t.createRegionOptions({x:e,y:n,radiusX:1,radiusY:1})}}).actions(e=>({beforeCommitDrawing(){const t=e.getActiveShape;return t.radiusX>e.MIN_SIZE.X&&t.radiusY>e.MIN_SIZE.Y}})),Vc=u.gK.compose(Hc.name,Jl,js,nc,Hc),$c=Fn("SegmentationToolbar","Segmentation Tools"),Wc={plus:"+",minus:"-"},Uc=e=>{const t=$c.lookupKey(e);if(!(0,E.isDefined)(t))return null;const n=t.split(",").map(e=>e.trim());return(0,ae.jsx)("div",{className:(0,Nn.cn)("flyoutmenu").elem("shortcut").toClassName(),children:n.map((e,t)=>{const n=e.split("+");return(0,ae.jsx)(f.Fragment,{children:n.map(e=>{var t;return(0,ae.jsx)("kbd",{className:(0,Nn.cn)("flyoutmenu").elem("key").toClassName(),children:null!=(t=Wc[e])?t:e},e)})},`${n.join("-")}-${t}`)})})},Gc=({items:e,icon:t})=>{const[n,i]=(0,f.useState)(!1);return(0,f.useEffect)(()=>{const t=()=>{e.forEach(e=>{const t=e.shortcut;t&&$c.hasKeyByName(t)&&$c.removeNamed(t)})};return t(),e.forEach(e=>{const t=e.shortcut;t&&!$c.hasKeyByName(t)&&$c.addNamed(t,()=>{console.log("clicked"),null==e||null==e.onClick||e.onClick(),i(!1)})}),()=>{t()}},[e]),(0,f.useEffect)(()=>{const e=()=>{n&&i(!1)};return window.addEventListener("click",e),()=>{window.removeEventListener("click",e)}}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("flyoutmenu").mix(n?"hovered":"").toClassName(),onClick:e=>{e.stopPropagation(),i(!n)},children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("flyoutmenu").elem("icon").mix(n?"isClicked":"").toClassName(),title:"Zoom presets (click to see options)",children:t}),(0,ae.jsx)("div",{className:(0,Nn.cn)("tooltips").toClassName(),children:e.map((e,t)=>(0,ae.jsx)("div",{className:(0,Nn.cn)("tooltips").elem("tooltip").toClassName(),onClick:t=>{t.stopPropagation(),null==e||null==e.onClick||e.onClick(),i(!1)},children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("tooltips").elem("tooltip-body").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("tooltips").elem("label").toClassName(),children:e.label}),Uc(e.shortcut)]})},t))})]})},Yc=(0,b.PA)(({item:e})=>(0,ae.jsxs)(f.Fragment,{children:[(0,ae.jsx)(vs,{active:e.selected,icon:(0,ae.jsx)(kn.ZbW,{}),ariaLabel:"pan",label:"Pan Image",shortcut:"tool:pan-image",onClick:()=>{const t=e.selected;e.manager.selectTool(e,!t)}}),(0,ae.jsx)(vs,{icon:(0,ae.jsx)(kn.mc3,{}),ariaLabel:"zoom-in",label:"Zoom In",shortcut:"tool:zoom-in",onClick:()=>{e.handleZoom(1)}}),(0,ae.jsx)(Gc,{icon:(0,ae.jsx)(kn.u79,{}),items:[{label:"Zoom to fit",shortcut:"tool:zoom-to-fit",onClick:()=>{e.sizeToFit()}},{label:"Zoom to actual size",shortcut:"tool:zoom-to-actual",onClick:()=>{e.sizeToOriginal()}}]}),(0,ae.jsx)(vs,{icon:(0,ae.jsx)(kn.Nin,{}),ariaLabel:"zoom-out",label:"Zoom Out",shortcut:"tool:zoom-out",onClick:()=>{e.handleZoom(-1)}})]})),Xc=u.gK.model("ZoomPanTool",{group:"control"}).volatile(()=>({canInteractWithRegions:!1})).views(e=>({get viewClass(){return()=>(0,ae.jsx)(Yc,{item:e})},get stageContainer(){return e.obj.stageRef.container()}})).actions(e=>({shouldSkipInteractions:()=>!0,mouseupEv(){e.mode="viewing",e.stageContainer.style.cursor="grab"},updateCursor(){var t;e.selected&&null!=(t=e.obj)&&t.stageRef&&(e.stageContainer.style.cursor="grab")},afterUpdateSelected(){e.updateCursor()},handleDrag(t){const n=e.obj,i=n.zoomingPositionX+t.movementX,o=n.zoomingPositionY+t.movementY;n.setZoomPosition(i,o)},mousemoveEv(t){e.obj.zoomScale<=1||"moving"===e.mode&&(e.handleDrag(t),e.stageContainer.style.cursor="grabbing")},mousedownEv(t){2!==t.button&&(e.mode="moving",e.stageContainer.style.cursor="grabbing")},handleZoom(t){e.obj.handleZoom(t)},sizeToFit(){e.obj.sizeToFit()},sizeToAuto(){e.obj.sizeToAuto()},sizeToOriginal(){e.obj.sizeToOriginal()}})),qc=u.gK.compose(Xc.name,Jl,js,Xc),Zc=(0,b.PA)(({item:e})=>(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(vs,{active:e.selected,icon:(0,ae.jsx)(kn.CwI,{}),ariaLabel:"rotate-left",label:"Rotate Left",shortcut:"tool:rotate-left",onClick:()=>{e.rotate(-90)}}),(0,ae.jsx)(vs,{active:e.selected,icon:(0,ae.jsx)(kn.$V1,{}),ariaLabel:"rotate-right",label:"Rotate Right",shortcut:"tool:rotate-right",onClick:()=>{e.rotate(90)}})]})),Jc=u.gK.model("RotateTool",{group:"control"}).views(e=>({get viewClass(){return()=>(0,ae.jsx)(Zc,{item:e})}})).actions(e=>({rotate(t){e.obj.rotate(t)}})),Qc=u.gK.compose(Jc.name,Jl,js,Jc),ed=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{active:e.selected,ariaLabel:"brightness",label:"Brightness",controlsOnHover:!0,controls:[(0,ae.jsx)(Xn,{align:"vertical",reverse:!0,continuous:!0,minIcon:(0,ae.jsx)(kn.Xdc,{style:{width:22,height:22,opacity:.2}}),maxIcon:(0,ae.jsx)(kn.Xdc,{style:{width:22,height:22,opacity:.8}}),value:e.brightness,max:w.A.BRIGHTNESS_MAX,onChange:t=>{e.setStroke(t)}},"brightness")],icon:(0,ae.jsx)(kn.Xdc,{})})),td=u.gK.model({brightness:u.gK.optional(u.gK.number,w.A.BRIGHTNESS_VALUE)}).views(e=>({get viewClass(){return()=>(0,ae.jsx)(ed,{item:e})}})).actions(e=>({setStroke(t){e.brightness=t,e.obj.setBrightnessGrade(t)}})),nd=u.gK.compose(td.name,Jl,js,td),id=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{active:e.selected,ariaLabel:"contrast",label:"Contrast",controlsOnHover:!0,controls:[(0,ae.jsx)(Xn,{align:"vertical",reverse:!0,continuous:!0,minIcon:(0,ae.jsx)(kn.cZy,{style:{width:22,height:22,opacity:.2}}),maxIcon:(0,ae.jsx)(kn.cZy,{style:{width:22,height:22,opacity:.8}}),value:e.contrast,max:w.A.CONTRAST_MAX,onChange:t=>{e.setStroke(t)}},"contrast")],icon:(0,ae.jsx)(kn.cZy,{})})),od=u.gK.model("ContrastTool",{contrast:u.gK.optional(u.gK.number,w.A.CONTRAST_VALUE)}).views(e=>({get viewClass(){return()=>(0,ae.jsx)(id,{item:e})}})).actions(e=>({setStroke(t){e.contrast=t,e.obj.setContrastGrade(t)}})),sd=u.gK.compose(od.name,Jl,js,od),ad=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{label:"Magic Wand",ariaLabel:"magicwand",shortcut:"tool:magic-wand",active:e.selected,icon:e.iconClass,tool:e,onClick:()=>{e.selected||e.manager.selectTool(e,!0)}})),rd=u.gK.model("MagicWandTool",{group:"segmentation",shortcut:"tool:magic-wand",smart:!0,unselectRegionOnToolChange:!1}).volatile(()=>({canInteractWithRegions:!1,currentThreshold:null,mask:null,anchorScreenX:null,anchorScreenY:null,anchorImgX:null,anchorImgY:null,overlay:null,overlayCtx:null,overlayOrigStyle:null,transformedData:null,transformedCanvas:null,currentRegion:null,isFirstWand:!0,cachedRegionId:null,cachedLabel:null,cachedNaturalCanvas:null,naturalWidth:null,naturalHeight:null,imageDisplayedInBrowserWidth:null,imageDisplayedInBrowserHeight:null,viewportWidth:null,viewportHeight:null,zoomScale:null,zoomingPositionX:null,zoomingPositionY:null,negativezoom:null,rotation:null,timeTravellerListener:null})).views(e=>({get viewClass(){return()=>(0,ae.jsx)(ad,{item:e})},get tagTypes(){return{stateTypes:"brushlabels",controlTagTypes:["brushlabels","magicwand"]}},get iconComponent(){return kn.fCL},get defaultthreshold(){return Number.parseInt(e.control.defaultthreshold,10)},get opacity(){return Number.parseFloat(e.control.opacity)},get fillcolor(){const t=(0,ft.A)(w.l.fillcolor).hex();let n=t;const i=e.obj.states();if(!i.length)return n;const o=i.find(e=>void 0!==e.selectedColor);return n=o?o.selectedColor:t,(0,ft.A)(n).hex()},get selectedLabel(){const t=e.obj.states();if(!t.length)return null;return t.find(e=>typeof e.isSelected).selectedValues()[0]},get blurradius(){return Number.parseInt(e.control.blurradius,10)},get existingRegion(){return e.getSelectedShape&&e.getSelectedShape.type&&e.getSelectedShape.maskDataURL?e.getSelectedShape:null},shouldInvalidateCache:()=>e.existingRegion&&e.existingRegion.id!==e.cachedRegionId})).actions(e=>({mousedownEv(t){e.timeTravellerListener||(e.timeTravellerListener=e.annotation.history.onUpdate(()=>{e.invalidateCache()})),e.annotation.history.freeze(),e.mode="drawing",e.currentThreshold=e.defaultthreshold,e.currentRegion=null;const n=e.obj,i=n.imageRef;if(e.naturalWidth=i.naturalWidth,e.naturalHeight=i.naturalHeight,e.imageDisplayedInBrowserWidth=i.width,e.imageDisplayedInBrowserHeight=i.height,e.viewportWidth=Math.round(n.canvasSize.width),e.viewportHeight=Math.round(n.canvasSize.height),e.zoomScale=n.zoomScale,e.zoomingPositionX=n.zoomingPositionX,e.zoomingPositionY=n.zoomingPositionY,e.negativezoom=e.zoomScale<1,e.rotation=n.rotation,e.rotation||n.crosshair){let t;throw e.mode="viewing",e.annotation.history.unfreeze(),t=e.rotation?"The Magic Wand is not supported on rotated images":"The Magic Wand is not supported if the crosshair is turned on",alert(t),t}window.addEventListener("keydown",e.keydownEv,!0),[e.anchorImgX,e.anchorImgY,e.anchorScreenX,e.anchorScreenY]=e.getEventCoords(t),e.initCache(),e.initCanvas(),e.initCurrentRegion()},mousemoveEv(t){if("drawing"!==e.mode)return;const[n,i,o,s]=e.getEventCoords(t);e.threshold(o,s,e.fillcolor,e.opacity)},mouseupEv:(0,u.L3)(function*(){"viewing"!==e.mode&&(e.mode="viewing",window.removeEventListener("keydown",e.keydownEv,!0),yield e.setupFinalMask())}),keydownEv(t){const{key:n}=t;"Escape"===n&&(t.preventDefault(),t.stopPropagation(),e.mode="viewing",window.removeEventListener("keydown",e.keydownEv,!0),e.overlayCtx.clearRect(0,0,e.overlay.width,e.overlay.height))},getEventCoords:e=>[e.offsetX,e.offsetY,e.screenX,e.screenY],initCache(){e.isFirstWand=null===e.existingRegion||e.existingRegion.id!==e.cachedRegionId,e.isFirstWand?(e.cachedNaturalCanvas=document.createElement("canvas"),e.cachedNaturalCanvas.width=e.naturalWidth,e.cachedNaturalCanvas.height=e.naturalHeight,e.cachedLabel=e.selectedLabel):e.shouldInvalidateCache()&&e.invalidateCache()},invalidateCache(){e.cachedNaturalCanvas=document.createElement("canvas"),e.cachedNaturalCanvas.width=e.naturalWidth,e.cachedNaturalCanvas.height=e.naturalHeight,e.isFirstWand=!0,e.cachedRegionId=null,e.cachedLabel=e.selectedLabel},initCanvas(){const t=e.obj,n=t.imageRef;[e.transformedData,e.transformedCanvas]=Rt(n,e.naturalWidth,e.naturalHeight,e.imageDisplayedInBrowserWidth,e.imageDisplayedInBrowserHeight,e.viewportWidth,e.viewportHeight,e.zoomScale,e.zoomingPositionX,e.zoomingPositionY,e.negativezoom,e.rotation),e.overlay=t.overlayRef,e.overlayOrigStyle=e.overlay.style,e.overlay.style="",e.overlay.width=e.transformedCanvas.width,e.overlay.height=e.transformedCanvas.height,e.overlayCtx=e.overlay.getContext("2d"),e.mask=yt(e.transformedData,e.overlayCtx,e.transformedCanvas.width,e.transformedCanvas.height,e.anchorImgX,e.anchorImgY,e.currentThreshold,e.fillcolor,e.opacity,e.blurradius,!0)},initCurrentRegion(){if(e.isFirstWand){const t={id:I(),strokewidth:1,object:e.obj,points:[],fillcolor:e.fillcolor,strokecolor:e.fillcolor,opacity:e.opacity};e.currentRegion=e.createDrawingRegion(t)}else e.currentRegion=e.existingRegion},threshold(t,n){if(t!==e.anchorScreenX||n!==e.anchorScreenY){const i=Math.abs(t-e.anchorScreenX),o=Math.abs(n-e.anchorScreenY),s=Math.sqrt(i*i+o*o),a=Math.abs(i),r=Math.abs(o);let l=a>r?i/a:o/r;l=l<0?l/5:l/3;const c=Math.min(Math.max(e.defaultthreshold+Math.floor(l*s),1),255);c!==e.currentThreshold&&(e.currentThreshold=c,e.mask=yt(e.transformedData,e.overlayCtx,e.transformedCanvas.width,e.transformedCanvas.height,e.anchorImgX,e.anchorImgY,e.currentThreshold,e.fillcolor,e.opacity,e.blurradius,!0))}},setupFinalMask:(0,u.L3)(function*(){const t=e.mask;let n,i;e.negativezoom?(n=Math.min(e.viewportWidth,e.imageDisplayedInBrowserWidth),i=Math.min(e.viewportHeight,e.imageDisplayedInBrowserHeight)):(n=e.viewportWidth,i=e.viewportHeight);const o=Ia.A.mask2DataURL(t.data,n,i,"#FFFFFF"),s=document.createElement("img");s.src=o,yield s.decode();const a=e.copyTransformedMaskToNaturalSize(s);e.finalMaskToRegion(a)}),copyTransformedMaskToNaturalSize(t){const n=e.cachedNaturalCanvas.getContext("2d"),[i,o]=jt(e.naturalWidth,e.naturalHeight,e.imageDisplayedInBrowserWidth,e.imageDisplayedInBrowserHeight,e.zoomingPositionX,e.zoomingPositionY),s=Math.ceil(e.transformedCanvas.width/e.imageDisplayedInBrowserWidth*e.naturalWidth),a=Math.ceil(e.transformedCanvas.height/e.imageDisplayedInBrowserHeight*e.naturalHeight),r=e.transformedCanvas.width,l=e.transformedCanvas.height,c=i,d=o,u=s,h=a;n.drawImage(t,0,0,r,l,c,d,u,h);return e.cachedNaturalCanvas.toDataURL()},finalMaskToRegion(t){if(e.isFirstWand){const n=e.commitDrawingRegion(t);e.cachedRegionId=n.id,e.obj.annotation.selectArea(n)}else e.currentRegion.endUpdatedMaskDataURL(t);e.annotation.history.unfreeze(),e.annotation.setIsDrawing(!1),e.overlay.style=e.origStyle,setTimeout(()=>{e.overlayCtx.clearRect(0,0,e.overlay.width,e.overlay.height)})},commitDrawingRegion(t){const n={maskDataURL:t,coordstype:"px",dynamic:!1},i=e.annotation.createResult(n,e.currentRegion.results[0].value.toJSON(),e.control,e.obj);return e.applyActiveStates(i),e.deleteRegion(),i.notifyDrawingFinished(),i}})),ld=u.gK.compose(rd.name,Jl,js,tc,rd),cd=(0,b.PA)(({item:e})=>(0,ae.jsx)(vs,{ariaLabel:"move-tool",active:e.selected,icon:(0,ae.jsx)(kn.v0T,{}),label:"Move",shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,onClick:()=>{e.manager.selectTool(e,!e.selected)}})),dd=u.gK.model("SelectionTool",{shortcut:"tool:move",group:"control"}).views(e=>({get viewClass(){return()=>(0,ae.jsx)(cd,{item:e})},get useTransformer(){return!0}})).actions(e=>{let t=!1;return{shouldSkipInteractions:()=>!1,notifyRegions(t,n,i){for(const o of e.obj.regs)null==o||null==o.onSelection||o.onSelection(t,n,i)},mousedownEv(n,[i,o]){t=!0,e.obj.setSelectionStart({x:i,y:o}),e.notifyRegions("start",i,o)},mousemoveEv(n,[i,o]){t&&(e.obj.setSelectionEnd({x:i,y:o}),e.notifyRegions("move",i,o))},mouseupEv(n,[i,o]){if(!t)return;e.obj.setSelectionEnd({x:i,y:o});const{regionsInSelectionArea:s}=e.obj;e.notifyRegions("end",i,o),e.obj.resetSelection(),n.ctrlKey||n.metaKey?e.annotation.extendSelectionWith(s):e.annotation.selectAreas(s),t=!1},clickEv(n){(0,Ne.VS)(Ne.q$)&&(t=!1,e.obj.resetSelection(),n.ctrlKey||n.metaKey||(e.annotation.unselectAreas(),e.notifyRegions("reset")))}}}),ud=u.gK.compose("MoveTool",Jl,js,Te,dd),hd=new Map;let gd=null;class md{static getInstance({name:e}={}){if(!e)return;if(hd.has(e))return hd.get(e);const t=new md({name:e});return hd.set(e,t),t}static allInstances(){return Array.from(hd.values())}static setRoot(e){gd=e}static removeAllTools(){hd.forEach(e=>e.removeAllTools()),hd.clear()}constructor({name:e}={}){this.name=e,this.tools={},this._default_tool=null,this._prefix=I()}get preservedTool(){return window.localStorage.getItem(`selected-tool:${this.name}`)}get root(){return gd}get obj(){var e;return He.ff.isActive(Ne.cE)?null==(e=gd.annotationStore.selected)?void 0:e.names.get(this.name):gd.annotationStore.names.get(this.name)}addTool(e,t,n=null,i=I()){var o,s;if(t.smart&&null!=(o=t.control)&&o.smartonly)return;const a=null!=(s=t.toolName)?s:e,r=`${null!=i?i:this._prefix}#${a}`;if(n&&e===n){const e=new RegExp(`^.*?#${a}.*$`);if(Object.keys(this.tools).some(t=>e.test(t)))return void console.log(`Ignoring duplicate tool ${a} because it matches removeDuplicatesNamed ${n}`)}if(this.tools[r]=t,t.default&&!this._default_tool&&(this._default_tool=t),this.preservedTool&&t.shouldPreserveSelectedState&&t.fullName===this.preservedTool&&t.setSelected)return this.unselectAll(),void this.selectTool(t,!0,!0);this._default_tool&&!this.hasSelected&&this.selectTool(this._default_tool,!0,!0)}unselectAll(){var e;Object.values(this.tools).forEach(e=>{void 0!==e.selected&&e.setSelected(!1)});const t=null==(e=this.obj)?void 0:e.stageRef;t&&(t.container().style.cursor="default")}selectTool(e,t,n=!1){const i=this.findSelectedTool(),o=null==e?void 0:e.group;if(i&&"segmentation"===o){const t=e.control.type.replace(/labels$/,""),n=e.obj.activeStates().filter(e=>{const n=e.type.replace(/labels$/,"");return"labels"!==e.type&&n!==t});n.forEach(e=>e.unselectAll())}if(null==i||null==i.handleToolSwitch||i.handleToolSwitch(e),null==i||null==i.complete||i.complete(),t)this.unselectAll(),null==e.setSelected||e.setSelected(!0,n);else{const e=this.findDrawingTool();this.selectTool(null!=e?e:this._default_tool,!0)}}selectDefault(){const e=this.findSelectedTool();this._default_tool&&!0===(null==e?void 0:e.dynamic)&&(this.unselectAll(),this._default_tool.setSelected(!0))}allTools(){return Object.values(this.tools)}addToolsFromControl(e){if(e.tools){const t=e.tools;Object.keys(t).forEach(n=>{this.addTool(n,t[n],e.removeDuplicatesNamed,e.name||e.id)})}}findSelectedTool(){return Object.values(this.tools).find(e=>e.selected)}findDrawingTool(){return Object.values(this.tools).find(e=>e.isDrawing)}event(e,t,...n){const i=this.findSelectedTool();i&&i.event(e,t,n)}reload({name:e}={}){hd.delete(this.name),hd.set(e,this),this.removeAllTools(),this.name=e}removeAllTools(){Object.values(this.tools).forEach(e=>(0,u.zr)(e)),this.tools={},this._default_tool=null}get hasSelected(){return Object.values(this.tools).some(e=>e.selected)}}window.ToolManager=md;const pd=md,fd=u.gK.union({dispatcher(e){if(!e)return u.gK.null;const t=e.object.name||e.object,n=window.Htx.annotationStore.names.get(t),i=we.getAvailableAreas(n.type,e);return u.gK.union(...i,u.gK.null)}});const vd=new class{constructor(){this.fileCache=new Map,this.errorCache=new Map}download(e,t){var n=this;if(!e)throw new Error("No URL provided for download");return new Promise((i,o)=>{if(this.fileCache.has(e))return void i(this.fileCache.get(e));if(this.errorCache.has(e))return void o(this.errorCache.get(e));const s=new XMLHttpRequest;s.responseType="blob",s.addEventListener("load",async function(){if(4===s.readyState&&200===s.status){var t;const a=n.createDataURL(s.response);if(n.fileCache.set(e,a),null!=(t=s.getResponseHeader("content-type"))&&t.match(/image/))try{await n.cacheImage(a)}catch(e){return void o(e)}i(a)}}),s.addEventListener("progress",e=>{const{total:n,loaded:i}=e;null==t||t(n,i,i/n)}),s.addEventListener("error",()=>{const t=new Error("Network error");o(t),this.errorCache.set(e,t)}),s.open("GET",e),s.send()})}isPreloaded(e){return this.fileCache.has(e)}isError(e){return this.errorCache.has(e)}getPreloadedURL(e){return this.fileCache.get(e)}getError(e){return this.errorCache.get(e)}createDataURL(e){return URL.createObjectURL(e)}cacheImage(e){return new Promise((t,n)=>{const i=new Image;i.onload=()=>{t()},i.onerror=()=>{n()},i.src=e})}},yd=u.gK.model("ImageEntity",{id:u.gK.identifier,src:u.gK.string,index:u.gK.number,rotation:u.gK.optional(u.gK.number,0),naturalWidth:u.gK.optional(u.gK.integer,1),naturalHeight:u.gK.optional(u.gK.integer,1),stageWidth:u.gK.optional(u.gK.number,1),stageHeight:u.gK.optional(u.gK.number,1),zoomScale:u.gK.optional(u.gK.number,1),zoomingPositionX:u.gK.optional(u.gK.number,0),zoomingPositionY:u.gK.optional(u.gK.number,0),brightnessGrade:u.gK.optional(u.gK.number,100),contrastGrade:u.gK.optional(u.gK.number,100)}).volatile(()=>({stageRatio:1,containerWidth:1,containerHeight:1,stageZoom:1,stageZoomX:1,stageZoomY:1,currentZoom:1,downloaded:!1,downloading:!1,error:!1,progress:0,currentSrc:void 0,imageLoaded:!1,_retryAttempted:!1,_originalUrl:void 0,_hasCacheRef:!1})).views(e=>({get parent(){return(0,u.PA)(e,2)},get imageCrossOrigin(){var t,n;return null!=(t=null==(n=e.parent)?void 0:n.imageCrossOrigin)?t:"anonymous"}})).actions(e=>({preload(){if(e.ensurePreloaded()||!e.src)return;e._originalUrl=e.src;const t=e.imageCrossOrigin,n=He.oF.get(e.src);if(n)e.markAsLoaded(n.blobUrl,{addCacheRef:!0});else{var i;if(He.oF.isLoading(e.src))return e.setDownloading(!0),void(null==(i=He.oF.getPendingLoad(e.src))||i.then(t=>{e.markAsLoaded(t.blobUrl,{addCacheRef:!0})}).catch(()=>{e.markAsFailed()}));e.setDownloading(!0),He.oF.load(e.src,t,t=>{e.setProgress(t)}).then(t=>{e.markAsLoaded(t.blobUrl,{addCacheRef:!0})}).catch(()=>{if((0,Ne.VS)(Ne.JZ)){const n=new Image;t&&(n.crossOrigin=t),n.onload=()=>{e.markAsLoaded(e.src)},n.onerror=()=>{e.markAsFailed()},n.src=e.src}else vd.download(e.src,(t,n,i)=>{e.setProgress(i)}).then(t=>{e.markAsLoaded(t)}).catch(()=>{e.markAsFailed()})})}},ensurePreloaded(){const t=He.oF.get(e.src);return t?(e.markAsLoaded(t.blobUrl,{addCacheRef:!0}),!0):(0,Ne.VS)(Ne.JZ)?void 0!==e.currentSrc:vd.isError(e.src)?(e.markAsFailed(),!0):!!vd.isPreloaded(e.src)&&(e.markAsLoaded(vd.getPreloadedURL(e.src)),!0)},releaseImage(){e.src&&e._hasCacheRef&&(He.oF.releaseRef(e.src),e._hasCacheRef=!1)},setImageLoaded(t){e.imageLoaded=t},setProgress(t){e.progress=(0,E.clamp)(t,0,100)},setDownloading(t){e.downloading=t},setDownloaded(t){e.downloaded=t},setCurrentSrc(t){e.currentSrc=t},setError(t=!0){if(t&&(e.setImageLoaded(!1),!e._retryAttempted&&e._originalUrl)){e._retryAttempted=!0,e.error=!1,He.oF.forceRemove(e.src),e.setDownloading(!0),e.setDownloaded(!1),e.setCurrentSrc(void 0);const t=e.imageCrossOrigin;return void He.oF.load(e.src,t,t=>{e.setProgress(t)}).then(t=>{e.markAsLoaded(t.blobUrl,{addCacheRef:!0})}).catch(()=>{e.markAsFailed()})}e.error=t},markAsLoaded(t,{addCacheRef:n=!1}={}){n&&!e._hasCacheRef&&(He.oF.addRef(e.src),e._hasCacheRef=!0),e.setCurrentSrc(t),e.setDownloaded(!0),e.setProgress(1),e.setDownloading(!1)},markAsFailed(){e.setError(!0),e.setDownloading(!1)}})).actions(e=>({setRotation(t){e.rotation=t},setNaturalWidth(t){e.naturalWidth=t},setNaturalHeight(t){e.naturalHeight=t},setStageWidth(t){e.stageWidth=t},setStageHeight(t){e.stageHeight=t},setStageRatio(t){e.stageRatio=t},setContainerWidth(t){e.containerWidth=t},setContainerHeight(t){e.containerHeight=t},setStageZoom(t){e.stageZoom=t},setStageZoomX(t){e.stageZoomX=t},setStageZoomY(t){e.stageZoomY=t},setCurrentZoom(t){e.currentZoom=t},setZoomScale(t){e.zoomScale=t},setZoomingPositionX(t){e.zoomingPositionX=t},setZoomingPositionY(t){e.zoomingPositionY=t},setBrightnessGrade(t){e.brightnessGrade=t},setContrastGrade(t){e.contrastGrade=t}})).actions(e=>({afterCreate(){(0,u.LF)(e,()=>{e.releaseImage()})}})),bd=u.gK.model({currentImageEntity:u.gK.maybeNull(u.gK.reference(yd)),imageEntities:u.gK.optional(u.gK.array(yd),[])}).actions(e=>({beforeDestroy(){e.currentImageEntity=null}})).views(e=>({get maxItemIndex(){return e.imageEntities.length-1},get imageIsLoaded(){const t=e.currentImageEntity;return!t.downloading&&!t.error&&t.downloaded&&t.imageLoaded},get rotation(){var t;if((0,u._n)(e))return null==(t=e.currentImageEntity)?void 0:t.rotation},set rotation(t){var n;null==(n=e.currentImageEntity)||n.setRotation(t)},get naturalWidth(){var t;return null==(t=e.currentImageEntity)?void 0:t.naturalWidth},set naturalWidth(t){var n;null==(n=e.currentImageEntity)||n.setNaturalWidth(t)},get naturalHeight(){var t;return null==(t=e.currentImageEntity)?void 0:t.naturalHeight},set naturalHeight(t){var n;null==(n=e.currentImageEntity)||n.setNaturalHeight(t)},get stageWidth(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageWidth},set stageWidth(t){var n;null==(n=e.currentImageEntity)||n.setStageWidth(t)},get stageHeight(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageHeight},set stageHeight(t){var n;null==(n=e.currentImageEntity)||n.setStageHeight(t)},get stageRatio(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageRatio},set stageRatio(t){var n;null==(n=e.currentImageEntity)||n.setStageRatio(t)},get containerWidth(){var t;return null==(t=e.currentImageEntity)?void 0:t.containerWidth},set containerWidth(t){var n;null==(n=e.currentImageEntity)||n.setContainerWidth(t)},get containerHeight(){var t;return null==(t=e.currentImageEntity)?void 0:t.containerHeight},set containerHeight(t){var n;null==(n=e.currentImageEntity)||n.setContainerHeight(t)},get stageZoom(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageZoom},set stageZoom(t){var n;null==(n=e.currentImageEntity)||n.setStageZoom(t)},get stageZoomX(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageZoomX},set stageZoomX(t){var n;null==(n=e.currentImageEntity)||n.setStageZoomX(t)},get stageZoomY(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageZoomY},set stageZoomY(t){var n;null==(n=e.currentImageEntity)||n.setStageZoomY(t)},get currentZoom(){var t;return null==(t=e.currentImageEntity)?void 0:t.currentZoom},set currentZoom(t){var n;null==(n=e.currentImageEntity)||n.setCurrentZoom(t)},get zoomScale(){var t;if((0,u._n)(e))return null==(t=e.currentImageEntity)?void 0:t.zoomScale},set zoomScale(t){var n;null==(n=e.currentImageEntity)||n.setZoomScale(t)},get zoomingPositionX(){var t;if((0,u._n)(e))return null==(t=e.currentImageEntity)?void 0:t.zoomingPositionX},set zoomingPositionX(t){var n;null==(n=e.currentImageEntity)||n.setZoomingPositionX(t)},get zoomingPositionY(){var t;return(0,u._n)(e)?null==(t=e.currentImageEntity)?void 0:t.zoomingPositionY:null},set zoomingPositionY(t){var n;null==(n=e.currentImageEntity)||n.setZoomingPositionY(t)},get brightnessGrade(){var t;return null==(t=e.currentImageEntity)?void 0:t.brightnessGrade},set brightnessGrade(t){var n;null==(n=e.currentImageEntity)||n.setBrightnessGrade(t)},get contrastGrade(){var t;return null==(t=e.currentImageEntity)?void 0:t.contrastGrade},set contrastGrade(t){var n;null==(n=e.currentImageEntity)||n.setContrastGrade(t)},findImageEntity:t=>(t=null!=t?t:0,e.imageEntities.find(e=>e.index===t))})),xd=u.gK.model({x:u.gK.number,y:u.gK.number}),wd=u.gK.model({start:u.gK.maybeNull(xd),end:u.gK.maybeNull(xd)}).views(e=>({get obj(){return(0,u.PA)(e)},get annotation(){return e.obj.annotation},get highlightedNodeExists(){return!!e.annotation.highlightedNode},get isActive(){return e.start&&e.end},get x(){return Math.min(e.start.x*e.scale,e.end.x*e.scale)},get y(){return Math.min(e.start.y*e.scale,e.end.y*e.scale)},get width(){return Math.abs(e.end.x*e.scale-e.start.x*e.scale)},get height(){return Math.abs(e.end.y*e.scale-e.start.y*e.scale)},get scale(){return e.obj.zoomScale},get bbox(){const{start:t,end:n}=e;return e.isActive?{left:Math.min(t.x,n.x),top:Math.min(t.y,n.y),right:Math.max(t.x,n.x),bottom:Math.max(t.y,n.y)}:null},get onCanvasBbox(){if(!e.isActive)return null;const{start:t,end:n}=e;return{left:e.obj.internalToCanvasX(Math.min(t.x,n.x)),top:e.obj.internalToCanvasY(Math.min(t.y,n.y)),right:e.obj.internalToCanvasX(Math.max(t.x,n.x)),bottom:e.obj.internalToCanvasY(Math.max(t.y,n.y))}},get onCanvasRect(){if(!e.isActive)return null;const t=e.onCanvasBbox;return{x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top}},includesBbox(t){if(!e.isActive||!t)return!1;const n=e.bbox.left<=t.left,i=e.bbox.top<=t.top,o=e.bbox.right>=t.right,s=e.bbox.bottom>=t.bottom;return n&&i&&o&&s},intersectsBbox(t){if(!e.isActive||!t)return!1;const n=(e.bbox.left+e.bbox.right)/2,i=(e.bbox.top+e.bbox.bottom)/2,o=e.bbox.right-e.bbox.left,s=e.bbox.bottom-e.bbox.top,a=(t.left+t.right)/2,r=(t.top+t.bottom)/2,l=t.right-t.left,c=t.bottom-t.top;return 2*Math.abs(n-a)<o+l&&2*Math.abs(i-r)<s+c},get selectionBorders(){if(e.isActive||!e.obj.selectedRegions.length)return null;const t={left:Js,top:Qs,right:0,bottom:0},n=e.obj.selectedRegions.reduce((e,t)=>t.bboxCoords?{left:Math.min(e.left,t.bboxCoords.left),top:Math.min(e.top,t.bboxCoords.top),right:Math.max(e.right,t.bboxCoords.right),bottom:Math.max(e.bottom,t.bboxCoords.bottom)}:e,t);return{left:e.obj.internalToCanvasX(n.left),top:e.obj.internalToCanvasY(n.top),right:e.obj.internalToCanvasX(n.right),bottom:e.obj.internalToCanvasY(n.bottom)}}})).actions(e=>({setStart(t){e.start=t},setEnd(t){e.end=t}})),Sd=u.gK.model({valuelist:u.gK.maybeNull(u.gK.string)}).extend(e=>{if(!0!==e.isObjectTag)throw new Error("The MultiItemObjectBase mixin should be used only for object-tags");return{}}).views(e=>({get isMultiItem(){return(0,E.isDefined)(e.valuelist)},get maxItemIndex(){throw new Error("MultiItemMixin needs to implement maxItemIndex getter in views")},get currentItemIndex(){throw new Error("MultiItemMixin needs to implement currentItemIndex getter in views")},get regs(){return e.isMultiItem?e.allRegs.filter(t=>{var n;return(null!=(n=t.item_index)?n:0)===e.currentItemIndex}):e.allRegs}})),Cd=u.gK.model({value:u.gK.maybeNull(u.gK.string),valuelist:u.gK.maybeNull(u.gK.string),resize:u.gK.maybeNull(u.gK.number),width:u.gK.optional(u.gK.string,"100%"),height:u.gK.maybeNull(u.gK.string),maxwidth:u.gK.optional(u.gK.string,"100%"),maxheight:u.gK.optional(u.gK.string,"calc(100vh - 194px)"),smoothing:u.gK.maybeNull(u.gK.boolean),grid:u.gK.optional(u.gK.boolean,!1),gridsize:u.gK.optional(u.gK.string,"30"),gridcolor:u.gK.optional(Ce.color,"#EEEEF4"),zoom:u.gK.optional(u.gK.boolean,!0),negativezoom:u.gK.optional(u.gK.boolean,!1),zoomby:u.gK.optional(u.gK.string,"1.1"),showlabels:u.gK.optional(u.gK.boolean,!1),zoomcontrol:u.gK.optional(u.gK.boolean,!0),brightnesscontrol:u.gK.optional(u.gK.boolean,!1),contrastcontrol:u.gK.optional(u.gK.boolean,!1),rotatecontrol:u.gK.optional(u.gK.boolean,!1),crosshair:u.gK.optional(u.gK.boolean,!1),selectioncontrol:u.gK.optional(u.gK.boolean,!0),lazyoff:u.gK.optional(u.gK.boolean,!1),horizontalalignment:u.gK.optional(u.gK.enumeration(["left","center","right"]),"left"),verticalalignment:u.gK.optional(u.gK.enumeration(["top","center","bottom"]),"top"),defaultzoom:u.gK.optional(u.gK.enumeration(["auto","original","fit"]),"fit"),crossorigin:u.gK.optional(u.gK.enumeration(["none","anonymous","use-credentials"]),"none")}),kd="rectanglelabels",Pd="brushlabels",Rd="bitmasklabels",jd="ellipselabels",Nd=u.gK.model({type:"image",sizeUpdated:u.gK.optional(u.gK.boolean,!1),cursorPositionX:u.gK.optional(u.gK.number,0),cursorPositionY:u.gK.optional(u.gK.number,0),brushControl:u.gK.optional(u.gK.string,"brush"),brushStrokeWidth:u.gK.optional(u.gK.number,15),mode:u.gK.optional(u.gK.enumeration(["drawing","viewing","brush","eraser"]),"viewing"),regions:u.gK.array(u.gK.union(Za,Xl,or,mr,Ul,rr),[]),drawingRegion:u.gK.optional(fd,null),selectionArea:u.gK.optional(wd,{start:null,end:null})}).volatile(()=>({currentImage:void 0,supportSuggestions:!0})).views(e=>({get store(){return(0,u.Zn)(e)},get multiImage(){return!!e.isMultiItem},get currentItemIndex(){return e.currentImage},get parsedValue(){return Oe(e.value,e.store.task.dataObj)},get parsedValueList(){return Oe(e.valuelist,e.store.task.dataObj)},get currentSrc(){return e.currentImageEntity.src},get usedValue(){return e.multiImage?e.valuelist:e.value},get images(){const t=e.parsedValue;return t?Array.isArray(t)?t:[t]:[]},get hasStates(){const t=e.states();return t&&t.length>0},get selectedRegions(){return e.regs.filter(e=>e.inSelection)},get selectedRegionsBBox(){let t;return e.selectedRegions.forEach(e=>{const n=e.bboxCoords;n&&(t=t?{left:Math.min(null==n?void 0:n.left,t.left),top:Math.min(null==n?void 0:n.top,t.top),right:Math.max(null==n?void 0:n.right,t.right),bottom:Math.max(null==n?void 0:n.bottom,t.bottom)}:n)}),t},get regionsInSelectionArea(){return e.regs.filter(e=>e.isInSelectionArea)},get selectedShape(){return e.regs.find(e=>e.selected)},get suggestions(){var t;return(null==(t=e.annotation)?void 0:t.regionStore.suggestions.filter(t=>t.object===e))||[]},get useTransformer(){var t;return!0===(null==(t=e.getToolsManager().findSelectedTool())?void 0:t.useTransformer)},get stageTranslate(){const{stageWidth:t,stageHeight:n}=e;return{0:{x:0,y:0},90:{x:0,y:n},180:{x:t,y:n},270:{x:t,y:0}}[e.rotation]},get stageScale(){return e.zoomScale},get layerZoomScalePosition(){return{scaleX:e.zoomScale,scaleY:e.zoomScale,x:e.zoomingPositionX+e.alignmentOffset.x,y:e.zoomingPositionY+e.alignmentOffset.y}},get hasTools(){var t;return!(null==(t=e.getToolsManager().allTools())||!t.length)},get imageCrossOrigin(){const t=e.crossorigin.toLowerCase();return t&&"none"!==t?t:"anonymous"},get fillerHeight(){const{naturalWidth:t,naturalHeight:n}=e;return e.isSideways?t/n*100+"%":n/t*100+"%"},get zoomedPixelSize(){const{naturalWidth:t,naturalHeight:n}=e;return{x:100/t,y:100/n}},isSamePixel({x:t,y:n},{x:i,y:o}){const s=e.zoomedPixelSize.x,a=e.zoomedPixelSize.y;return Math.abs(t-i)<s/2&&Math.abs(n-o)<a/2},snapPointToPixel({x:t,y:n},i=ea){const o=e.zoomedPixelSize.x,s=e.zoomedPixelSize.y;switch(i){case ea:return{x:Math.round(t/o)*o,y:Math.round(n/s)*s};case ta:return{x:Math.floor(t/o)*o+o/2,y:Math.floor(n/s)*s+s/2}}},createSerializedResult(t,n){var i;const o=null!=(i=t.item_index)?i:0,s=e.findImageEntity(o),a={original_width:s.naturalWidth,original_height:s.naturalHeight,image_rotation:s.rotation};e.multiImage&&(0,E.isDefined)(o)&&(a.item_index=o);return!s.imageLoaded&&(0,E.isDefined)(t._rawResult)?structuredClone(t._rawResult):Object.assign({},a,{value:n})},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t&&t.filter(e=>e.isSelected&&e.type.includes("labels"))},controlButton(){const t=e.states();if(!t||0===t.length)return;let n=t[0];return t.forEach(e=>{e.type!==kd&&e.type!==Pd&&e.type!==Rd&&e.type!==jd||(n=e)}),n},get controlButtonType(){const t=e.controlButton();return(0,u.Pw)(t).name},get isSideways(){return(e.rotation+360)%180==90},get stageComponentSize(){return e.isSideways?{width:e.stageHeight,height:e.stageWidth}:{width:e.stageWidth,height:e.stageHeight}},get canvasSize(){return e.isSideways?{width:(0,Ne.VS)(Ne.aT)?e.naturalHeight*e.stageZoomX:Math.round(e.naturalHeight*e.stageZoomX),height:(0,Ne.VS)(Ne.aT)?e.naturalWidth*e.stageZoomY:Math.round(e.naturalWidth*e.stageZoomY)}:{width:(0,Ne.VS)(Ne.aT)?e.naturalWidth*e.stageZoomX:Math.round(e.naturalWidth*e.stageZoomX),height:(0,Ne.VS)(Ne.aT)?e.naturalHeight*e.stageZoomY:Math.round(e.naturalHeight*e.stageZoomY)}},get alignmentOffset(){const t={x:0,y:0};if((0,Ne.VS)(Ne.pG)){switch(e.horizontalalignment){case"center":t.x=(e.containerWidth-e.canvasSize.width)/2;break;case"right":t.x=e.containerWidth-e.canvasSize.width}switch(e.verticalalignment){case"center":t.y=(e.containerHeight-e.canvasSize.height)/2;break;case"bottom":t.y=e.containerHeight-e.canvasSize.height}}return t},get zoomBy(){return Number.parseFloat(e.zoomby)},get isDrawing(){return!!e.drawingRegion},get imageTransform(){const t={width:e.stageWidth*e.zoomScale+"px",height:e.stageHeight*e.zoomScale+"px",transformOrigin:"left top",transform:"translate3d(0,0,0)",filter:`brightness(${e.brightnessGrade}%) contrast(${e.contrastGrade}%)`},n=[];if(1!==e.zoomScale){const{zoomingPositionX:t=0,zoomingPositionY:i=0}=e;n.push(`translate3d(${t}px,${i}px, 0)`)}if(e.rotation){const t={90:"0, -100%",180:"-100%, -100%",270:"-100%, 0"};n.push(`rotate(${e.rotation}deg)`),n.push(`translate(${t[e.rotation]||"0, 0"})`)}return(null==n?void 0:n.length)>0&&(t.transform=n.join(" ")),t},get maxScale(){return e.isSideways?Math.min(e.containerWidth/e.naturalHeight,e.containerHeight/e.naturalWidth):Math.min(e.containerWidth/e.naturalWidth,e.containerHeight/e.naturalHeight)},get coverScale(){return e.isSideways?Math.max(e.containerWidth/e.naturalHeight,e.containerHeight/e.naturalWidth):Math.max(e.containerWidth/e.naturalWidth,e.containerHeight/e.naturalHeight)},get viewPortBBoxCoords(){let t=e.canvasSize.width/e.zoomScale,n=e.canvasSize.height/e.zoomScale;const i=-e.zoomingPositionX/e.zoomScale,o=-e.zoomingPositionY/e.zoomScale,s=[i,o,e.stageComponentSize.width-(i+t),e.stageComponentSize.height-(o+n)];if(e.isSideways&&([t,n]=[n,t]),e.rotation){const t=e.rotation/90%4;for(let e=0;e<t;e++)s.push(s.shift())}const a=s[0],r=s[1];return{left:a,top:r,right:a+t,bottom:r+n,width:t,height:n}}})).volatile(e=>({manager:null})).actions(e=>{const t=pd.getInstance({name:e.name}),n={manager:t,control:e,object:e};return{afterAttach:function(){He.ff.isActive(Ne.cE)&&!e.annotation||(e.selectioncontrol&&t.addTool("MoveTool",ud.create({},n),"MoveTool"),e.zoomcontrol&&t.addTool("ZoomPanTool",qc.create({},n),"ZoomPanTool"),e.brightnesscontrol&&t.addTool("BrightnessTool",nd.create({},n),"BrightnessTool"),e.contrastcontrol&&t.addTool("ContrastTool",sd.create({},n),"ContrastTool"),e.rotatecontrol&&t.addTool("RotateTool",Qc.create({},n),"RotateTool"),function(){if(!e.store.task)return;e.imageEntities.clear();const t=e.multiImage?e.parsedValueList:e.parsedValue,n=e.annotation?`@${e.annotation.id}`:"";Array.isArray(t)?t.forEach((t,i)=>{e.imageEntities.push({id:`${e.name}#${i}${n}`,src:t,index:i})}):e.imageEntities.push({id:`${e.name}#0${n}`,src:t,index:0}),e.setCurrentImage(0)}())},getToolsManager:function(){return t},afterResultCreated:function(t){t&&(t.classification||e.multiImage&&(null==t.setItemIndex||t.setItemIndex(e.currentImage)))}}}).extend(e=>{let t=!1;return{views:{getSkipInteractions(){var n;if((0,Ne.VS)(Ne.pG)){if(t)return!0;if(e.annotation.isLinkingMode)return!1;const n=e.getToolsManager().findSelectedTool();return!(null==n?void 0:n.canInteractWithRegions)}const i="ZoomPanTool"===(null==(n=e.getToolsManager().findSelectedTool())?void 0:n.toolName);return t||i},get smoothingEnabled(){var t;const n=null==(t=e.annotation)?void 0:t.names;if(!n)return e.smoothing;return!Array.from(n.values()).some(({type:e})=>e.includes("bitmask"))&&e.smoothing}},actions:{setSkipInteractions(e){t=e},updateSkipInteractions(t){const n=e.getToolsManager().findSelectedTool();if(null!=n&&n.shouldSkipInteractions)return e.setSkipInteractions(n.shouldSkipInteractions(t));e.setSkipInteractions(t.evt&&(t.evt.metaKey||t.evt.ctrlKey))}}}}).actions(e=>({freezeHistory(){},afterRegionSelected(t){e.multiImage&&e.setCurrentImage(t.item_index)},createDrawingRegion(t,n,i,o){const s={from_name:e.annotation.names.get(i.name),to_name:e,type:i.resultType,value:n},a=Object.assign({id:I(),object:e},t,{results:[s],dynamic:o,item_index:e.currentImage});return e.drawingRegion=a,e.drawingRegion},deleteDrawingRegion(){const{drawingRegion:t}=e;t&&(e.drawingRegion=null,(0,u.zr)(t))},setSelectionStart(t){e.selectionArea.setStart(t)},setSelectionEnd(t){e.selectionArea.setEnd(t)},resetSelection(){e.selectionArea.setStart(null),e.selectionArea.setEnd(null)},updateBrushControl(t){e.brushControl=t},updateBrushStrokeWidth(t){e.brushStrokeWidth=t},setBrightnessGrade(t){e.brightnessGrade=t},setContrastGrade(t){e.contrastGrade=t},setGridSize(t){e.gridsize=String(t)},setCurrentItem(t=0){e.setCurrentImage(t)},setCurrentImage(t=0){(t=null!=t?t:0)!==e.currentImage&&(e.currentImage=t,e.currentImageEntity=e.findImageEntity(t),(0,Ne.VS)(Ne.F2)&&e.preloadImages())},preloadImages(){if(e.currentImageEntity.setImageLoaded(!1),e.currentImageEntity.preload(),e.multiImage){const[t,n]=[e.currentImage,e.imageEntities.length],i=(0,E.clamp)(t-3,0,t),o=(0,E.clamp)(t+1+3,t,n-1);[...e.imageEntities.slice(i,t),...e.imageEntities.slice(t+1,o)].forEach(e=>{e.preload()})}},setPointerPosition({x:t,y:n}){e.freezeHistory(),e.cursorPositionX=t,e.cursorPositionY=n},setZoom(t){t=(0,E.clamp)(t,1,Number.POSITIVE_INFINITY),e.currentZoom=t;const n=e.maxScale,i=e.coverScale;if(n>1?t<n?(e.stageZoom=t,e.zoomScale=1):(e.stageZoom=n,e.zoomScale=t/n):t>n?(e.stageZoom=n,e.zoomScale=t):(e.stageZoom=t,e.zoomScale=1),e.zoomScale>1){const t=Math.min(n*e.zoomScale,i);e.containerWidth/e.naturalWidth>e.containerHeight/e.naturalHeight?(e.stageZoomX=t,e.stageZoomY=e.stageZoom):(e.stageZoomX=e.stageZoom,e.stageZoomY=t)}else e.stageZoomX=e.stageZoom,e.stageZoomY=e.stageZoom},updateImageAfterZoom(){const{stageWidth:t,stageHeight:n}=e;e._recalculateImageParams(),t===e.stageWidth&&n===e.stageHeight||e._updateRegionsSizes({width:e.stageWidth,height:e.stageHeight,naturalWidth:e.naturalWidth,naturalHeight:e.naturalHeight})},setZoomPosition(t,n){const[i,o]=(0,Ne.VS)(Ne.aT)?[e.canvasSize.width,e.canvasSize.height]:[e.containerWidth,e.containerHeight],[s,a]=[i-e.stageComponentSize.width*e.zoomScale,o-e.stageComponentSize.height*e.zoomScale];e.zoomingPositionX=(0,E.clamp)(t,s,0),e.zoomingPositionY=(0,E.clamp)(n,a,0)},resetZoomPositionToCenter(){const{stageComponentSize:t,zoomScale:n}=e,{width:i,height:o}=t,[s,a]=(0,Ne.VS)(Ne.aT)?[e.canvasSize.width,e.canvasSize.height]:[e.containerWidth,e.containerHeight];e.setZoomPosition((s-i*n)/2,(a-o*n)/2)},sizeToFit(){const{maxScale:t}=e;e.defaultzoom="fit",e.setZoom(t),e.updateImageAfterZoom(),e.resetZoomPositionToCenter()},sizeToOriginal(){const{maxScale:t}=e;e.defaultzoom="original",e.setZoom(t>1?1:1/t),e.updateImageAfterZoom(),e.resetZoomPositionToCenter()},sizeToAuto(){e.defaultzoom="auto",e.setZoom(1),e.updateImageAfterZoom(),e.resetZoomPositionToCenter()},getInertialZoom(t){const n=t*((0,u.Zn)(e).settings.invertedZoom?1:-1),i=Math.exp(.009*n),o=Math.max(.7,Math.min(1.3,i));return(0,E.clamp)(e.currentZoom*o,.1,100)},handleZoom(t,n={x:e.canvasSize.width/2,y:e.canvasSize.height/2},i=!1){if(t){const o=i?e.getInertialZoom(t):t>0?e.currentZoom*e.zoomBy:e.currentZoom/e.zoomBy;if(!0!==e.negativezoom&&o<=1)return e.setZoom(1),e.setZoomPosition(0,0),void e.updateImageAfterZoom();if(o<=1)return e.setZoom(o),e.setZoomPosition(0,0),void e.updateImageAfterZoom();let s=e.zoomScale;const a={x:(n.x-e.zoomingPositionX)/s,y:(n.y-e.zoomingPositionY)/s};e.setZoom(o),s=e.zoomScale;const r={x:-(a.x-n.x/s)*s,y:-(a.y-n.y/s)*s};e.setZoomPosition(r.x,r.y),e.updateImageAfterZoom()}},setMode(t){e.mode=t},setImageRef(t){e.imageRef=t},setContainerRef(t){e.containerRef=t},setStageRef(t){e.stageRef=t;const n=e.getToolsManager().findSelectedTool();null==n||null==n.updateCursor||n.updateCursor()},setOverlayRef(t){e.overlayRef=t},setSelected(){},rotate(t=-90){e.rotation=(e.rotation+t+360)%360;let n=1/e.stageRatio;e.isSideways?e.stageRatio=e.naturalWidth/e.naturalHeight:e.stageRatio=1,n*=e.stageRatio,e.setZoom(e.currentZoom),-90===t&&this.setZoomPosition(e.zoomingPositionY*n,e.stageComponentSize.height-e.zoomingPositionX*n-e.stageComponentSize.height*e.zoomScale),90===t&&this.setZoomPosition(e.stageComponentSize.width-e.zoomingPositionY*n-e.stageComponentSize.width*e.zoomScale,e.zoomingPositionX*n),e.updateImageAfterZoom()},_recalculateImageParams(){e.stageWidth=(0,Ne.VS)(Ne.aT)?e.naturalWidth*e.stageZoom:Math.round(e.naturalWidth*e.stageZoom),e.stageHeight=(0,Ne.VS)(Ne.aT)?e.naturalHeight*e.stageZoom:Math.round(e.naturalHeight*e.stageZoom)},_updateImageSize({width:t,height:n,userResize:i}){if(void 0!==e.naturalWidth){if(t>1&&n>1){const i=e.canvasSize.width,o=e.canvasSize.height,s=e.stageZoom,a=e.zoomScale;e.containerWidth=t,e.containerHeight=n,e.setZoom(e.currentZoom),e._recalculateImageParams();const r=e.stageZoom/s*(e.zoomScale/a);e.setZoomPosition(e.zoomingPositionX*r+(e.canvasSize.width/2-i/2*r),e.zoomingPositionY*r+(e.canvasSize.height/2-o/2*r))}e.sizeUpdated=!0,e._updateRegionsSizes({width:e.stageWidth,height:e.stageHeight,naturalWidth:e.naturalWidth,naturalHeight:e.naturalHeight,userResize:i})}},_updateRegionsSizes({width:t,height:n,naturalWidth:i,naturalHeight:o,userResize:s}){var a,r;const l=null==(a=e.annotation)||null==(a=a.history)||null==(a=a.history)?void 0:a.length;e.annotation.history.freeze(),e.regions.forEach(e=>{null==e.updateImageSize||e.updateImageSize(t/i,n/o,t,n,s)}),e.regs.forEach(e=>{null==e.updateImageSize||e.updateImageSize(t/i,n/o,t,n,s)}),null==(r=e.drawingRegion)||r.updateImageSize(t/i,n/o,t,n,s),setTimeout(e.annotation.history.unfreeze,0),l<=1&&setTimeout(()=>{var t;return null==(t=e.annotation)?void 0:t.reinitHistory(!1)},0)},updateImageSize(t){var n;const{naturalWidth:i,naturalHeight:o}=null!=(n=e.imageRef)?n:t.target,{offsetWidth:s,offsetHeight:a}=e.containerRef;e.naturalWidth=i,e.naturalHeight=o,e._updateImageSize({width:s,height:a}),e.setReady(!0),"fit"===e.defaultzoom?e.sizeToFit():e.sizeToAuto(),setTimeout(()=>{var t;return null==(t=e.annotation)?void 0:t.reinitHistory(!1)},0)},checkLabels(){const t=e.activeStates()||[];return 0!==e.getAvailableStates().length||0===t.length},addShape(t){e.regions.push(t),e.annotation.addRegion(t),e.setSelected(t.id),t.selectRegion()},onResize(t,n,i){e._updateImageSize({width:t,height:n,userResize:i})},event(t,n,i,o){const[s,a]=e.fixZoomedCoords([i,o]),r=e.canvasToInternalX(s),l=e.canvasToInternalY(a);e.getToolsManager().event(t,n.evt||n,r,l,s,a)}})),Td=u.gK.model().actions(e=>({fixZoomedCoords([t,n]){if(!e.stageRef)return[t,n];const i=e.stageRef.getAbsoluteTransform().copy().invert().point({x:t,y:n});return[i.x,i.y]},zoomOriginalCoords([t,n]){const i=e.stageRef.getAbsoluteTransform().point({x:t,y:n});return[i.x,i.y]},fixForZoom(e){return t=>this.fixForZoomWrapper(t,e)},fixForZoomWrapper(t,n){const i=void 0===t.x,[o,s]=e.fixZoomedCoords(i?t:[t.x,t.y]),a=n(i?[o,s]:{x:o,y:s}),r=e.zoomOriginalCoords(i?a:[a.x,a.y]);return i?r:{x:r[0],y:r[1]}}})).views(e=>({get whRatio(){return e.stageWidth/e.stageHeight},canvasToInternalX:t=>t/e.stageWidth*Js,canvasToInternalY:t=>t/e.stageHeight*Qs,internalToCanvasX:t=>t/Js*e.stageWidth,internalToCanvasY:t=>t/Qs*e.stageHeight,internalToImageX(t){const{naturalWidth:n}=e.currentImageEntity;return t/Js*n},internalToImageY(t){const{naturalHeight:n}=e.currentImageEntity;return t/Qs*n},imageToInternalX(t){const{naturalWidth:n}=e.currentImageEntity;return t/n*Js},imageToInternalY(t){const{naturalHeight:n}=e.currentImageEntity;return t/n*Qs}})),_d=u.gK.compose("ImageModel",Cd,gn,...(0,Ne.VS)(Ne.gF)?[Sd]:[],Te,Ie,bd,Nd,Td),Ad=(0,b.WQ)("store")(ja);we.addTag("image",_d,Ad),we.addObjectType(_d);var Id=n(7976),Md=n.n(Id);const Ed=u.gK.model().views(()=>({})).actions(e=>({updateSpansColor(t,n){e._spans&&e._spans.forEach(e=>{t&&(e.style.backgroundColor=t),n&&(e.style.backgroundColor=en.Colors.rgbaChangeAlpha(e.style.backgroundColor,n))})},updateAppearenceFromState(){const t=e.getLabelColor();e.updateSpansColor(t,e.selected?.8:.3),e.applyCSSClass(e._lastSpan)},createSpans(){const t=e.getLabelColor(),n=(0,fe.highlightRange)(e,"htx-highlight",{backgroundColor:t}),i=n[n.length-1];if(i)return e.applyCSSClass(i),e._lastSpan=i,e._spans=n,n},getLabelColor(){let t=e.parent.highlightcolor||(e.style||e.tag||w.l).fillcolor;return t&&(t=en.Colors.convertToRGBA(t,.3)),t},applyCSSClass(t){if(!t)return;const n=["htx-highlight","htx-highlight-last"],i=(0,u.Zn)(e).settings;if(e.parent.showlabels||null!=i&&i.showLabels){var o;const i=null==(o=e.labeling)?void 0:o.mainValue,s=en.HTML.labelWithCSS(t,{index:e.region_index,labels:i,score:e.score});n.push(s)}else n.push("htx-no-label");t.className=n.filter(Boolean).join(" ")},addEventsToSpans(t){const n=t=>(t.onmouseover=n=>{e.hidden||(e.annotation.isLinkingMode?(e.toggleHighlight(),t.style.cursor=w.A.LINKING_MODE_CURSOR,n.stopPropagation()):t.style.cursor=w.A.POINTER_CURSOR)},t.onmouseout=()=>{e.hidden||e.setHighlight(!1)},t.onmousedown=function(t){e.hidden||e.parent._currentSpan!==this&&(t.stopPropagation(),e.parent._currentSpan=this)},t.onclick=function(){e.hidden||e.parent._currentSpan===this&&(t.style.cursor=w.A.POINTER_CURSOR,e.onClickRegion())},!1);t&&t.forEach(e=>n(e))},selectRegion(){e.updateSpansColor(null,.8);const t=e._spans[0];t&&(t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView({block:"center",behavior:"smooth"}))},afterUnselectRegion(){e.updateSpansColor(null,.3)},setHighlight(t){if(e._highlighted=t,e._spans){const t=e._spans.length,n=e._spans[0],i=e._spans[t-1],o=e._spans.slice(1,t-1),s=(e,t,{top:n=!0,bottom:i=!0,right:o=!0,left:s=!0}={})=>{o&&(e.style.borderRight=t),s&&(e.style.borderLeft=t),n&&(e.style.borderTop=t),i&&(e.style.borderBottom=t)};if(e.highlighted&&!e.hidden){const e=w.A.HIGHLIGHTED_CSS_BORDER;s(n,e,{right:!1}),s(i,e,{left:!1}),o.length&&o.forEach(t=>s(t,e,{left:!1,right:!1}))}else{const e="0px";s(n,e),s(i,e),o.length&&o.forEach(t=>s(t,e,{left:!1,right:!1}))}}},toggleHidden(t){e.hidden=!e.hidden,e.setHighlight(e.highlighted),e.hidden?(e.updateSpansColor("transparent",0),e._spans&&e._spans.forEach(e=>{e.style.cursor=w.A.DEFAULT_CURSOR})):e.updateAppearenceFromState(),null==t||t.stopPropagation()},find:t=>e._spans&&e._spans.indexOf(t)>=0?e:void 0})),Kd=u.gK.model("LabelMixin"),Dd=u.gK.model().volatile(()=>({isSeparated:!1})).views(e=>({get tiedChildren(){return st.filterChildrenOfType(e,e._child)},get selectedLabels(){return e.tiedChildren.filter(e=>!0===e.selected)},getSelectedColor(){const t=e.tiedChildren.find(e=>!0===e.selected);return t&&t.background},get selectedColor(){const t=e.tiedChildren.find(e=>!0===e.selected);return t&&t.background},get isSelected(){return e.selectedLabels.length>0},get holdsState(){return e.selectedLabels.length>0},selectedValues:()=>e.selectedLabels.map(e=>e.alias?e.alias:e.value).filter(e=>(0,E.isDefined)(e)),getResultValue:()=>({[e.valueType]:e.selectedValues()}),get selectedAliases(){return e.selectedLabels.filter(e=>e.alias).map(e=>e.alias)},getSelectedString:(t=" ")=>e.selectedValues().join(t),findLabel:t=>e.tiedChildren.find(e=>e.alias===t&&(0,E.isDefined)(t)||e.value===t||!(0,E.isDefined)(e.value)&&!(0,E.isDefined)(t)),get emptyLabel(){return e.allowempty?e.findLabel(null):null}})).actions(e=>({unselectAll(){e.tiedChildren.forEach(e=>e.setSelected(!1))},checkMaxUsages:()=>e.tiedChildren.filter(e=>!e.canBeUsed()),selectFirstVisible(){const t=e.tiedChildren.find(e=>e.visible);return t&&t.toggleSelected(),t},updateFromResult(t){e.unselectAll();const n=Array.isArray(t)?t.length?t:[null]:[t];if(n.length)n.map(t=>e.findLabel(t)).forEach(e=>null==e?void 0:e.setSelected(!0));else if(e.allowempty){var i;null==(i=e.findLabel(null))||i.setSelected(!0)}}})),Od=u.gK.model({}).views(()=>({get defaultChildType(){console.error("DynamicChildrenMixin needs to implement defaultChildType getter in views")}})).actions(e=>{const t=(n,i,o)=>{if((!He.ff.isActive(Ne.cE)||!i.annotationStore.initialized)&&n&&n.length)for(const a of n){var s;const n=null!=(s=a.id)?s:I();o.children.push(Object.assign({type:e.defaultChildType},a,{id:n,children:[]}));const r=o.children[o.children.length-1];null==r.updateValue||r.updateValue(i),t(a.children,i,r)}},n=(e,t)=>{null==e||e.forEach(e=>{n(e.children,t),null==e.updateValue||e.updateValue(t)})};return{updateWithDynamicChildren(n,i){var o;const s=(0,u.Zn)(e);e.children=null!=(o=e.children)?o:[],(0,u.Ze)(s),t(n,i,e),(0,u.yQ)(s)},updateValue(t){He.ff.isActive(Ne.cE)?e.updateDynamicChildren(t):setTimeout(()=>{e.updateDynamicChildren(t)})},updateDynamicChildren(t){if(!0!==e.locked){var n;const i=Oe(e.value,null==(n=t.task)?void 0:n.dataObj);if(!i)return;e.updateWithDynamicChildren(i,t),e.annotation&&(e.annotation.setupHotKeys(),null==e.needsUpdate||e.needsUpdate())}},generateDynamicChildren(t,i){if(e.children){const o=e.children,s=o.length,a=s-t.length,r=o.slice(a,s);n(r,i)}}}}),Ld=u.gK.compose(Fe,Od),zd=u.gK.model(Object.assign({},(0,Ne.VS)(Ne.cE)?{id:u.gK.identifier,name:u.gK.string}:{name:u.gK.identifier},{smart:!0,smartonly:!1,isControlTag:!0})).volatile(()=>({snapMode:ea})).views(e=>({get resultType(){return e.type},get valueType(){return e.type},get toNameTag(){return e.annotation.names.get(e.toname)},selectedValues(){throw new Error("Control tag needs to implement selectedValues method in views")},get result(){return e.annotation.results.find(t=>t.from_name===e)},getSnappedPoint:t=>"pixel"===e.snap?e.toNameTag.snapPointToPixel(t,e.snapMode):t,get smartEnabled(){var t,n,i;const o=null!=(t=e.smart)&&t;return null!=(n=null==(i=(0,u.Zn)(e))?void 0:i.autoAnnotation)&&n&&o||e.smartonly||!1}})),Bd=u.gK.compose(zd,un),Fd=["className","style","color","empty","hidden","selected","margins","onClick","children","hotkey"],Hd=f.forwardRef((e,t)=>{let{className:n,style:i,color:o,empty:s=!1,hidden:a=!1,selected:r=!1,margins:l=!1,onClick:c,children:d,hotkey:u}=e,h=(0,Se.A)(e,Fd);const g=(0,f.useMemo)(()=>{if(!o)return null;const e=(0,ft.A)(o).alpha(.15);return Object.assign({},null!=i?i:{},(t={color:o,background:e})?Object.entries(t).reduce((e,[t,n])=>(e[`--${t}`]=n,e),{}):null);var t},[o]);return(0,ae.jsxs)("span",Object.assign({ref:t,className:(0,Nn.cn)("label").mod({empty:s,hidden:a,selected:r,clickable:!!c,margins:l}).mix(n).toClassName(),style:g,onClick:c},h,{children:[(0,ae.jsx)("span",{className:(0,Nn.cn)("label").elem("text").toClassName(),children:d}),u?(0,ae.jsx)("span",{className:(0,Nn.cn)("label").elem("hotkey").toClassName(),children:u}):null]}))}),Vd=u.gK.model("AnnotationMixin",{parentTypes:je.tagsTypes([])}).views(e=>({get parent(){return je.getParentTagOfTypeString(e,e.parentTypes)}})),$d=u.gK.model({value:u.gK.maybeNull(u.gK.string),selected:u.gK.optional(u.gK.boolean,!1),maxusages:u.gK.maybeNull(u.gK.string),alias:u.gK.maybeNull(u.gK.string),hint:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string),showalias:u.gK.optional(u.gK.boolean,!1),aliasstyle:u.gK.optional(u.gK.string,"opacity: 0.6"),size:u.gK.optional(u.gK.string,"medium"),background:u.gK.optional(Ce.color,w.A.LABEL_BACKGROUND),selectedcolor:u.gK.optional(Ce.color,"#ffffff"),granularity:u.gK.maybeNull(u.gK.enumeration(["symbol","word","sentence","paragraph"])),groupcancontain:u.gK.maybeNull(u.gK.string),html:u.gK.maybeNull(u.gK.string)}),Wd=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"label",visible:u.gK.optional(u.gK.boolean,!0),_value:u.gK.optional(u.gK.string,""),parentTypes:u.gK.late(()=>je.tagsTypes(["Labels","EllipseLabels","RectangleLabels","PolygonLabels","KeyPointLabels","BrushLabels","HyperTextLabels","TimelineLabels","TimeSeriesLabels","ParagraphLabels","BitmaskLabels","VectorLabels",...we.customTags.map(e=>e.tag).filter(e=>e.endsWith("Labels"))]))}).volatile(e=>({initiallySelected:e.selected,isEmpty:!1})).views(e=>({get maxUsages(){var t;return Number(e.maxusages||(null==(t=e.parent)?void 0:t.maxusages))},usedAlready:()=>e.annotation.regionStore.regions.reduce((t,n)=>t+n.hasLabel(e.value),0),canBeUsed:(t=1)=>!e.maxUsages||e.usedAlready()+t<=e.maxUsages})).actions(e=>({setEmpty(){e.isEmpty=!0},toggleSelected(){let t=[];e.annotation.selectedDrawingRegions.length>0?t=e.annotation.selectedDrawingRegions.filter(t=>{var n,i;return(null==(n=t.parent)?void 0:n.name)===(null==(i=e.parent)?void 0:i.toname)}):e.annotation.selectedRegions.length>0&&(t=e.annotation.selectedRegions.filter(t=>{var n,i;return(null==(n=t.parent)?void 0:n.name)===(null==(i=e.parent)?void 0:i.toname)}));const n=t.filter(e=>!e.isReadOnly());if(e.annotation.isReadOnly())return;if(t.length>0&&0===n.length)return;if(n.length&&!e.selected&&!e.canBeUsed(n.filter(e=>e.results).length))return void dn.warning(`You can't use ${e.value} more than ${e.maxUsages} time(s)`);const i=e.parent,o=n.filter(t=>!(1===i.selectedLabels.length&&e.selected&&1===t.labelings.length&&(null==i||!i.allowempty||e.isEmpty))&&(!!e.selected||("labels"===i.type||(!!i.type.includes(t.type.replace(/region$/,""))||!!i.type.includes(t.results[0].type)))));if(!(t.length>0&&0===o.length)){if(!i.selectedLabels.length&&!e.selected){var s,a,r;const t=pd.getInstance({name:e.parent.toname}),n=Object.values((null==(s=e.parent)?void 0:s.tools)||{})[0],i=t.findSelectedTool(),o=!(!n||!i)&&(0,u.Pw)(i).name===(0,u.Pw)(n).name,l=!!i&&(null==n||null==(a=n.control)?void 0:a.name)===(null==i||null==(r=i.control)?void 0:r.name);!n||!(i&&(!o||!l))&&i||t.selectTool(n,!0)}if(e.isEmpty){const t=e.selected;i.unselectAll(),e.setSelected(!t)}else i.shouldBeUnselected||e.setSelected(!e.selected),i.shouldBeUnselected&&(e.selected?i.unselectAll():(i.unselectAll(),e.setSelected(!e.selected)));var l;if(i.allowempty&&!e.isEmpty)if(o.length)i.findLabel().setSelected(!(null!=(l=i.selectedValues())&&l.length));else e.selected&&i.findLabel().setSelected(!1);o.forEach(t=>{t&&(t.setValue(e.parent),t.notifyDrawingFinished(),null==t.updateSpans||t.updateSpans())})}},setVisible(t){e.visible=t},setSelected(t){e.selected=t},onHotKey:()=>e.onLabelInteract(),onClick:()=>(e.onLabelInteract(),!1),onLabelInteract:()=>e.toggleSelected(),_updateBackgroundColor(t){e.background===w.A.LABEL_BACKGROUND&&(e.background=Md().make_color({seed:t})[0])},afterCreate(){e._updateBackgroundColor(e._value||e.value)},updateValue(t){e._value=Oe(e.value,t.task.dataObj)||w.A.EMPTY_LABEL}})),Ud=u.gK.compose("LabelModel",Vd,$d,Fe,Wd,Te),Gd=(0,b.WQ)("store")((0,b.PA)(({item:e,store:t})=>{const n=(t.settings.enableTooltips||t.settings.enableLabelTooltips)&&t.settings.enableHotkeys&&e.hotkey,i=(0,ae.jsxs)(Hd,{color:e.background,margins:!0,empty:e.isEmpty,hotkey:n,hidden:!e.visible,selected:e.selected,onClick:e.onClick,children:[e.html?(0,ae.jsx)("div",{title:e._value,dangerouslySetInnerHTML:{__html:(0,fe.sanitizeHtml)(e.html)}}):e._value,!0===e.showalias&&e.alias&&(0,ae.jsxs)("span",{style:en.styleToProp(e.aliasstyle),children:["Â ",e.alias]})]});return e.hint?(0,ae.jsx)(Pn.m_M,{title:e.hint,children:i}):i}));we.addTag("label",Ud,Gd);const Yd=u.gK.model({toname:u.gK.maybeNull(u.gK.string),choice:u.gK.optional(u.gK.enumeration(["single","multiple"]),"single"),maxusages:u.gK.maybeNull(u.gK.string),showinline:u.gK.optional(u.gK.boolean,!0),groupdepth:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.2"),fillcolor:u.gK.optional(Ce.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(Ce.color,"#f48a42"),fillopacity:u.gK.maybeNull(Ce.range()),allowempty:u.gK.optional(u.gK.boolean,!1),value:u.gK.optional(u.gK.string,"")}),Xd=u.gK.model({pid:u.gK.optional(u.gK.string,I),type:"labels",children:je.unionArray(["label","header","view","text","hypertext","richtext"]),visible:u.gK.optional(u.gK.boolean,!0)}),qd=Kd.views(e=>({get shouldBeUnselected(){return"single"===e.choice},get defaultChildType(){return"label"},get isLabeling(){return!0}})).actions(e=>({afterCreate(){if(e.allowempty){let t=e.findLabel(null);if(!t){const n={value:null,type:"label",background:w.l.fillcolor};e.children?e.children.unshift(n):e.children=(0,u.wg)([n]),t=e.children[0]}t.setEmpty()}}})),Zd=u.gK.compose("LabelsModel",Bd,Xd,Yd,Te,Ld,qd,Dd.props({_child:"LabelModel"})),Jd=(0,b.PA)(({item:e})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("labels").mod({hidden:!e.visible,inline:e.showinline}).toClassName(),children:st.renderChildren(e,e.annotation)}));we.addTag("labels",Zd,Jd);const Qd=u.gK.model("ParagraphLabelsModel",{pid:u.gK.optional(u.gK.string,I),type:"paragraphlabels",children:je.unionArray(["label","header","view","hypertext"])}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0},get serializableValue(){const t={};return t.paragraphlabels=e.selectedValues(),t}})),eu=Kd.props({_type:"paragraphlabels"}),tu=u.gK.compose(Bd,Zd,Qd,eu,Dd.props({_child:"LabelModel"})),nu=u.gK.compose("ParagraphLabelsModel",tu),iu=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("paragraphlabels",nu,iu);var ou=n(45626),su=n(72523),au=function(e){return e[e.inertial=0]="inertial",e[e.instant=1]="instant",e}(au||{});const ru=500,lu=u.gK.model({leadTime:0}).volatile(()=>({leadTimeLogic:au.inertial,lastRecordedTime:0,debouncedTime:0})).actions(e=>({_countTimeInertial(){const t=Date.now();e.debouncedTime<t?e.leadTime+=ru:e.leadTime+=ru-(e.debouncedTime-t),e.debouncedTime=t+ru},_countTimeInstant(){const t=Date.now();e.debouncedTime<t?(e.leadTime+=ru,e.lastRecordedTime=t+ru):t>e.lastRecordedTime&&(e.leadTime+=t-e.lastRecordedTime,e.lastRecordedTime=t),e.debouncedTime=t+ru}})).actions(e=>({countTime(){e.leadTimeLogic===au.inertial?e._countTimeInertial():e.leadTimeLogic===au.instant&&e._countTimeInstant()},resetLeadTimeCounters(){e.lastRecordedTime=0,e.debouncedTime=0}})),cu=u.gK.model({peritem:u.gK.optional(u.gK.boolean,!1)}).extend(e=>{if(!0!==e.isClassificationTag)throw new Error("The PerItemMixin mixin should be used only for classification control-tags");return{}}).views(e=>({get _perItemResult(){return e.annotation.results.find(t=>t.from_name===e&&t.area.item_index===e.toNameTag.currentItemIndex)}})).actions(e=>({_validatePerItem(){const t=e.toNameTag;return e.annotation.regions.every(n=>{const i=n.results.find(t=>t.from_name===e);if(null==i||!i.hasValue)return!0;const o=i.mainValue;return!!e.validateValue(o)||(t.setCurrentItem(n.item_index),!1)})},createPerItemResult(){e.createPerObjectResult({item_index:e.toNameTag.currentItemIndex})}})),du=cu;function uu(e,t){for(;e;){if(e[t])return e[t];if(!(0,u.p7)(e,2))break;e=(0,u.PA)(e,2)}return null}const hu=u.gK.model({required:u.gK.optional(u.gK.boolean,!1),requiredmessage:u.gK.maybeNull(u.gK.string)}).actions(e=>{const t={validate:e.validate};return{validate(){if(!t.validate())return!1;if(!e.required)return!0;if(e.perregion){const t=e.toNameTag;for(const s of t.allRegs){const t=s.results.find(t=>t.from_name===e);if("region-selected"===e.visiblewhen&&e.whentagname){var n;const t=null==(n=s.labeling)||null==(n=n.from_name)?void 0:n.name;if(t&&t!==e.whentagname)continue}if(s.role){var i,o;const t=null!=(i=null==(o=uu(e,"whenrole"))?void 0:o.split(","))?i:null;if(t&&!t.includes(s.role))continue}if((!e.whenlabelvalue||s.hasLabel(e.whenlabelvalue))&&(null==t||!t.hasValue))return e.annotation.selectArea(s),e.requiredModal(),!1}}else if((0,Ne.VS)(Ne.gF)&&e.peritem){const t=e.toNameTag,n=t.maxItemIndex,i=e.annotation.regions.reduce((t,n)=>{const i=n.results.find(t=>t.from_name===e);return null!=i&&i.hasValue&&t.add(n.item_index),t},new Set);for(let o=0;o<=n;o++)if(!i.has(o))return t.setCurrentItem(o),e.requiredModal(),!1}else{var s;if(!e.holdsState&&!1!==e.isVisible&&!1!==(null==(s=(0,u.PA)(e,2))?void 0:s.isVisible))return e.requiredModal(),!1}return!0}}}),gu=hu,mu="lsf-mark",pu="lsf-selected",fu="lsf-highlighted",vu="lsf-relation",yu=["onChange","onDelete","isEditable","isDeleteable","text","ignoreShortcuts","onlyEdit"];class bu extends f.Component{constructor(...e){super(...e),this.state={editing:!1,height:0,value:this.props.text},this.inputClassName="text-color-neutral-content bg-neutral-surface border border-neutral-border px-base py-tight rounded-md w-full focus-visible:outline focus-visible:outline-2 focus-visible:outline-primary-focus-outline leading-body-small min-h-10 hover:border-neutral-border-bold transition-colors transition-background-color duration-150 ease-out",this.textRef=f.createRef(),this.inputRef=f.createRef(),this.handleGlobalClick=e=>{var t;const n=null==e?void 0:e.target,i=null==n||null==(t=n.dataset)?void 0:t.shortcut;!this.state.editing||this.props.ignoreShortcuts&&i||n===this.inputRef.current||this.setEditing(!1)},this.startEditing=()=>{var e,t,n;const i=(null==(e=this.textRef.current)?void 0:e.parentNode.offsetHeight)||0;this.setState({editing:!0,height:i}),null==(t=(n=this.props).onStartEditing)||t.call(n),setTimeout(this.focus)},this.focus=()=>{const e=this.inputRef.current;e&&(e.selectionStart=this.state.value.length)},this.setEditing=e=>{this.setState({editing:e})},this.setValue=e=>{this.setState({value:e})},this.cancel=()=>{this.setValue(this.props.text),this.setEditing(!1)},this.save=()=>{this.props.onChange(this.state.value),this.setEditing(!1)},this.updateHeight=ec()(()=>{var e,t;const n=null!=(e=null==(t=this.inputRef.current)?void 0:t.scrollHeight)?e:0,i=n+2;n&&i!==this.state.height&&this.setState({height:i})},100)}static getDerivedStateFromProps(e,t){return e.text!==t.prevPropsText?{value:e.text,prevPropsText:e.text}:null}componentDidMount(){window.addEventListener("click",this.handleGlobalClick,{capture:!0})}componentWillUnmount(){window.removeEventListener("click",this.handleGlobalClick,{capture:!0})}renderEdit(){const{className:e="",rows:t=1,onlyEdit:n,name:i,onFocus:o,onChange:s,onDelete:a,isEditable:r,isDeleteable:l,ignoreShortcuts:c}=this.props,{height:d,value:u}=this.state,h={name:i,className:`flex ${this.inputClassName}`,style:d?{height:d,borderWidth:1}:null,autoFocus:!0,ref:this.inputRef,value:u,"data-testid":"htx-textbox-input",onBlur:()=>{s(this.state.value)},onFocus:o,onChange:e=>{this.setValue(e.target.value),this.updateHeight()},onKeyDown:e=>{const{key:n,shiftKey:i}=e;"Enter"===n?(1===+t||i)&&(e.preventDefault(),e.stopPropagation(),this.save()):"Escape"===n?this.cancel():"Tab"===n&&this.setEditing(!1)}};return this.updateHeight(),(0,ae.jsxs)("div",{className:(0,Nn.cn)("textarea").elem("region").toClassName(),"data-testid":"htx-textbox-edit",children:[t>1?(0,ae.jsx)("textarea",Object.assign({},h)):(0,ae.jsx)("input",Object.assign({},h)),!n&&(0,ae.jsx)(Pn.m_M,{title:"Save: [shift+enter]",children:(0,ae.jsx)(Pn.$nd,{type:"text",variant:"primary",look:"outlined",size:"small",className:"absolute right-tight top-tighter",icon:(0,ae.jsx)(kn.iWP,{}),"aria-label":"Save","data-testid":"htx-textbox-save",onClick:this.save})})]})}renderView(){const e=this.props,{onChange:t,onDelete:n,isEditable:i,isDeleteable:o,text:s}=e,a=(0,Se.A)(e,yu);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("textarea").elem("region").toClassName(),"data-testid":"htx-textbox-view",children:[(0,ae.jsx)("div",{className:this.inputClassName,id:a.id,name:a.name,"data-testid":"htx-textbox-content",children:(0,ae.jsx)(Pn.o5u,{ref:this.textRef,size:"small",children:s.split("\n").map((e,t,n)=>{const i=t===n.length-1;return(0,ae.jsxs)(f.Fragment,{children:[e,!i&&(0,ae.jsx)("br",{})]},t)})})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("textarea").elem("actions").toClassName(),"data-testid":"htx-textbox-actions",children:[i&&t&&(0,ae.jsx)(Pn.$nd,{variant:"neutral",look:"outlined",size:"small",tooltip:"Edit",tooltipTheme:"Dark",leading:(0,ae.jsx)(kn.r9C,{}),"aria-label":"Edit Region","data-testid":"htx-textbox-edit-button",onClick:this.startEditing}),o&&n&&(0,ae.jsx)(Pn.$nd,{type:"text",variant:"negative",look:"outlined",size:"small",tooltip:"Delete",tooltipTheme:"Dark",leading:(0,ae.jsx)(kn.HVA,{}),"aria-label":"Delete Region","data-testid":"htx-textbox-delete-button",onClick:n})]})]})}render(){return(this.state.editing||this.props.onlyEdit)&&this.props.isEditable?this.renderEdit():this.renderView()}}const xu=u.gK.model("TextAreaRegionModel",{id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"textarearegion",_value:u.gK.string}).volatile(()=>({classification:!0,perRegionTags:[],results:[],selected:!1})).views(e=>({get parent(){return(0,u.k2)(e,Ku)},getRegionElement:()=>document.querySelector(`#TextAreaRegion-${e.id}`),getOneColor:()=>null})).actions(e=>({setValue(t){e._value!==t&&e.parent.validateText(t)&&(e._value=t,e.parent.onChange())},deleteRegion(){e.parent.remove(e)},selectRegion(){e.selected=!0},afterUnselectRegion(){e.selected=!1}})),wu=u.gK.compose("TextAreaRegionModel",Ze,Ge,xu),Su=(0,b.PA)(({item:e,onFocus:t})=>{var n;const i=[mu],o={onFocus:n=>t(n,e)},{parent:s}=e,{relationMode:a}=e.annotation,r=s.isEditable&&!e.isReadOnly(),l=s.isDeleteable&&!e.isReadOnly();a&&i.push(vu),e.selected?i.push(pu):e.highlighted&&i.push(fu),(r||s.transcription)&&(o.onChange=t=>{e.setValue(t),e.parent.updateLeadTime()},o.onInput=()=>{e.parent.countTime()}),o.onDelete=e.deleteRegion;let c={};s.perregion||(c={onMouseOver:()=>{a&&e.setHighlight(!0)},onMouseOut:()=>{a&&e.setHighlight(!1)}});const d=`${null!=(n=null==s?void 0:s.name)?n:""}:${e.id}`;return(0,ae.jsx)("div",Object.assign({},c,{className:(0,Nn.cn)("row").toString(),"data-testid":"textarea-region",children:(0,ae.jsx)(bu,Object.assign({isEditable:r,isDeleteable:l,onlyEdit:s.transcription,id:`TextAreaRegion-${e.id}`,name:d,className:i.join(" "),rows:s.rows,text:e._value},o,{ignoreShortcuts:!0}))}))});we.addTag("textarearegion",wu,Su);const Cu=u.gK.model("ClassificationBase",{isClassificationTag:!0}).extend(e=>{if(!0!==e.isControlTag)throw new Error("The ClassificationBase mixin should be used only for ControlTags");const t=["toname"].filter(t=>!e.$treenode.type.propertyNames.includes(t));for(const e of t)throw new Error(`The property "${e}" should be defined for ClassificationBase mixin model needs`);return{}}).volatile(()=>({elementRef:f.createRef()})).views(e=>({selectedValues(){throw new Error("ClassificationBase mixin model needs to implement selectedValues method in views")},get result(){return e.perregion?e._perRegionResult:e.peritem?e._perItemResult:e.annotation.results.find(t=>t.from_name===e)},getRegionElement:()=>e.elementRef.current,get isIndependent(){return e.isClassificationTag&&!e.perregion&&!e.peritem&&!e.value}})).actions(e=>({validate:()=>e.perregion?e._validatePerRegion():e.peritem&&(0,Ne.VS)(Ne.gF)?e._validatePerItem():e._validatePerObject(),validateValue:e=>!0,_validatePerObject:()=>e.validateValue(e.selectedValues()),createPerObjectResult(t={}){e.annotation.createResult(t,{[e.valueType]:e.selectedValues()},e,e.toname)},updateResult(){e.result?(e.result.area.updateOriginOnEdit(),e.result.area.setValue(e)):e.perregion?null==e.createPerRegionResult||e.createPerRegionResult():e.peritem?e.createPerItemResult():e.createPerObjectResult()}}));var ku=n(76363);const Pu="input--GGvVi",{TextArea:Ru}=ou.A,ju=(0,f.forwardRef)(({idx:e,value:t,readOnly:n,onChange:i,onDelete:o,onFocus:s,validate:a,control:r,collapsed:l,canDelete:c=!0},d)=>{const u=Number.parseInt(r.rows)>1,[h,g]=(0,f.useState)(null!=t?t:"");(0,f.useEffect)(()=>{t!==h&&g(t)},[t]);const m=(0,f.useMemo)(()=>{var e;return l?null!=(e=(null!=t?t:"").split(/\n/)[0])?e:"":h},[t,l,h]),p=(0,f.useCallback)(e=>{g(e.target.value)},[]),v=(0,f.useCallback)(n=>{t===n.target.value||l||(a&&!a(n.target.value)?g(t):null==i||i(e,n.target.value))},[e,t,i,a,l]),y={className:`ant-input ${Pu} ${(0,Nn.cn)("textarea-tag").elem("input").toClassName()}`,value:m,autoSize:u?{minRows:1}:null,onChange:p,readOnly:n||l,onFocus:s};return y.onBlur=v,y.onKeyDown=e=>{var t;("Enter"===e.key&&!e.shiftKey||"Escape"===e.key)&&(e.preventDefault(),e.stopPropagation(),null==(t=e.target)||null==t.blur||t.blur())},(0,ae.jsxs)("div",{className:(0,Nn.cn)("textarea-tag").elem("item").toClassName(),"data-testid":"textarea-region-item",children:[u?(0,ae.jsx)(Ru,Object.assign({},y,{ref:d,"data-testid":"textarea-region-textarea"})):(0,ae.jsx)(ou.A,Object.assign({},y,{ref:d,"data-testid":"textarea-region-input"})),c&&!l&&!n&&(0,ae.jsx)(ku.A,{className:(0,Nn.cn)("textarea-tag").elem("action").toClassName(),size:"small",look:"string","aria-label":"Delete Region","data-testid":"textarea-region-delete",leading:(0,ae.jsx)(kn.Eau,{}),onClick:()=>{o(e)}})]})}),Nu=(0,b.PA)(({item:e,control:t,firstResultInputRef:n,onFocus:i,collapsed:o,canDelete:s=!0})=>{const a=e.mainValue,r=!e.isReadOnly()&&e.from_name.editable&&!e.area.isReadOnly(),l=(0,f.useCallback)((t,n)=>{if(e.from_name.isReadOnly())return;const i=a.toJSON();i.splice(t,1,n),e.setValue(i)},[a]),c=(0,f.useCallback)(t=>{if(!e.from_name.isDeleteable)return;const n=a.toJSON();n.splice(t,1),e.setValue(n)},[a]);return a.map((a,d)=>(0,ae.jsx)(ju,{idx:d,value:a,readOnly:!r,onChange:l,onDelete:c,control:t,ref:0===d?n:null,onFocus:i,collapsed:o,validate:e.from_name.validateText,canDelete:e.from_name.isDeleteable&&s},d))}),Tu=(0,b.PA)(({item:e,area:t,collapsed:n,setCollapsed:i,outliner:o,color:s,canDelete:a=!0})=>{var r,l;const c=Number.parseInt(e.rows),d=c>1,h=e.perRegionArea===t,g=t.isCompleted&&t.perRegionFocusTarget===e&&t.perRegionFocusRequest,m=h?e._value:"",p=t.results.find(t=>t.from_name===e),v=(0,f.useCallback)(()=>{n&&(i(!1),t.isSelected||t.annotation.selectArea(t))},[n]),y=(0,f.useCallback)(()=>{p?(e.addTextToResult(e._value,p),e.setValue("")):(e.addText(e._value),e.setValue(""))},[e,p]),b=(0,f.useRef)(),x=(0,f.useRef)(),w=(0,f.useRef)(0),S=(0,f.useMemo)(()=>s?{"--border-color":s}:{},[s]);(0,f.useEffect)(()=>{var e;h&&g&&w.current<t.perRegionFocusRequest&&(null==(e=b.current||x.current)||e.focus({cursor:"end"}),w.current=t.perRegionFocusRequest)},[h,g]),(0,f.useEffect)(()=>{n&&e._value&&y()},[n]);const C={ref:b,value:m,rows:e.rows,className:`is-search ${(0,Nn.cn)("textarea-tag").elem("input").toClassName()}`,label:e.label,placeholder:e.placeholder,autoSize:d?{minRows:1}:null,onChange:t=>{if(n)return;const{value:i}=t.target;e.setValue(i)},onFocus:e=>{e.stopPropagation(),e.preventDefault(),t.isSelected||t.annotation.selectArea(t)}};d&&(C.onKeyDown=t=>{var n;("Enter"!==t.key||t.shiftKey)&&"Escape"!==t.key||e.annotation.isReadOnly()||(t.preventDefault(),t.stopPropagation(),e.allowsubmit&&e._value?y():null==(n=t.target)||null==n.blur||n.blur())}),e.annotation.isReadOnly()&&(C.disabled=!0);!e.annotation.isReadOnly()&&(r=e.showsubmitbutton);const k=(!p||!(null!=p&&null!=(l=p.mainValue)&&l.length)||e.maxsubmissions&&p.mainValue.length<Number.parseInt(e.maxsubmissions))&&!t.isReadOnly();return(0,u._n)(e)&&(0,u._n)(t)?(p||k)&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("textarea-tag").mod({mode:e.mode,outliner:o}).toClassName(),style:S,"data-testid":"textarea-region-view",children:[p?(0,ae.jsx)(Nu,{control:e,item:p,collapsed:n,firstResultInputRef:x,onFocus:v,canDelete:a}):null,k&&(0,ae.jsx)(su.A,{className:(0,Nn.cn)("textarea-tag").elem("form").toClassName(),"data-testid":"textarea-region-form",onFinish:()=>(e.allowsubmit&&e._value&&!e.annotation.isReadOnly()&&y(),!1),onClick:e=>{e.stopPropagation()},children:d?(0,ae.jsx)(Ru,Object.assign({},C,{"data-testid":"textarea-region-input",onClick:e=>{e.stopPropagation()}})):(0,ae.jsx)(ou.A,Object.assign({},C,{"data-testid":"textarea-region-input",onClick:e=>{e.stopPropagation()}}))})]}):null});we.addPerRegionView("textarea",dt.REGION_LIST,Tu);const _u=u.gK.model({visiblewhen:u.gK.maybeNull(u.gK.string),whentagname:u.gK.maybeNull(u.gK.string),whenchoicevalue:u.gK.maybeNull(u.gK.string),whenlabelvalue:u.gK.maybeNull(u.gK.string),whenrole:u.gK.maybeNull(u.gK.string)}).views(e=>({get isVisible(){var t;if(!1===(null==(t=(0,u.PA)(e,2))?void 0:t.isVisible))return!1;if(e.visiblewhen){const t={"region-selected":({tagName:t,labelValue:n,roleValue:i})=>{var o;const s=e.annotation.highlightedNode;return!(!s||t&&(null==(o=s.labeling)?void 0:o.from_name.name)!==t)&&(n?n.split(",").some(e=>s.hasLabel(e)):!i||i.split(",").some(e=>{var t;return(null==(t=s.chatmessage)?void 0:t.role)===e}))},"choice-selected":({tagName:t,choiceValue:n})=>{if(!t){for(const t of e.annotation.names.values())if("choices"===t.type&&t.selectedValues&&t.selectedValues().length)return!0;return!1}const i=e.annotation.names.get(t);return!!(null!=i&&i.hasChoiceSelection||null!=n&&n.length)&&(!1!==i.isVisible&&i.hasChoiceSelection(null==n?void 0:n.split(","),i.selectedValues()))},"no-region-selected":()=>!e.annotation.highlightedNode,"choice-unselected":e=>!t["choice-selected"](e)};if(Object.keys(t).includes(e.visiblewhen)){return!1!==t[e.visiblewhen]({tagName:e.whentagname,choiceValue:e.whenchoicevalue,labelValue:e.whenlabelvalue,roleValue:e.whenrole})}}else if(e.whenchoicevalue){for(const t of e.annotation.names.values()){const n=null==t||null==t.selectedValues?void 0:t.selectedValues();if(null!=n&&n.length)for(const t of n)if(t===e.whenchoicevalue)return!0}return!1}return!0}})),Au=_u,{TextArea:Iu}=ou.A,Mu=u.gK.model({toname:u.gK.maybeNull(u.gK.string),allowsubmit:u.gK.optional(u.gK.boolean,!0),label:u.gK.optional(u.gK.string,""),value:u.gK.maybeNull(u.gK.string),rows:u.gK.optional(u.gK.string,"1"),showsubmitbutton:u.gK.maybeNull(u.gK.boolean),placeholder:u.gK.maybeNull(u.gK.string),maxsubmissions:u.gK.maybeNull(u.gK.string),editable:u.gK.optional(u.gK.boolean,!1),transcription:!1,skipduplicates:u.gK.optional(u.gK.boolean,!1)}),Eu=u.gK.model({type:"textarea",regions:u.gK.array(wu),_value:u.gK.optional(u.gK.string,""),children:je.unionArray(["shortcut"])}).volatile(()=>({focusable:!0,textareaRef:(0,f.createRef)()})).views(e=>({get isEditable(){return e.editable&&e.annotation.editable},get isDeleteable(){return!e.isReadOnly()},get valueType(){return"text"},get holdsState(){return e.regions.length>0},get submissionsNum(){return e.regions.length},get showSubmit(){if(e.maxsubmissions){const t=Number.parseInt(e.maxsubmissions);return e.submissionsNum<t}return!0},get serializableValue(){return e.regions.length?{text:e.selectedValues()}:null},selectedValues:()=>e.regions.map(e=>e._value),hasResult(t){if(!e.result)return!1;let n=e.result.mainValue;const i=t.toLowerCase();return Array.isArray(n)||(n=[n]),n.some(e=>e.toLowerCase()===i)}})).actions(()=>(0,Ne.VS)(Ne.y8)?{}:{countTime:()=>{}}).actions(e=>{let t=null,n=null;const i=(t,n)=>!!(t&&n&&(0,u._n)(n))&&(!(e===n&&!e.showSubmit)&&!!t.parentElement);return{getSerializableValue(){const t=e.regions.map(e=>e._value);if(0!==t.length)return{text:t}},needsUpdate(){var t;e.updateFromResult(null==(t=e.result)?void 0:t.mainValue)},requiredModal(){dn.warning(e.requiredmessage||`Input for the textarea "${e.name}" is required.`)},uniqueModal(){dn.warning("There is already an entry with that text. Please enter unique text.")},setResult(t){const n=Array.isArray(t)?t:[t];for(const t of n)e.createRegion(t)},updateFromResult(t){e.regions=[],t&&e.setResult(t)},setValue(t){e._value=t},remove(t){const n=e.regions.indexOf(t);n<0||(e.regions.splice(n,1),(0,u.zr)(t),e.onChange(t))},createRegion(t,n,i){const o=wu.create({pid:n,leadTime:i,_value:t});return e.regions.push(o),o},onChange(t){var n;e.updateResult();const i=null!=t?t:null==(n=e.result)?void 0:n.area;null==i||i.notifyDrawingFinished()},validateText:t=>!e.skipduplicates||!e.hasResult(t)||(e.uniqueModal(),!1),addText(t,n){e.validateText(t)&&(e.createRegion(t,n,e.leadTime),e.onChange(),e.updateLeadTime())},updateLeadTime(){var t,n;if(!(0,Ne.VS)(Ne.y8))return;const i=e.result;i&&(i.setMetaValue("lead_time",(null!=(t=null==(n=i.meta)?void 0:n.lead_time)?t:0)+e.leadTime/1e3),e.leadTime=0,e.resetLeadTimeCounters())},addTextToResult(t,n){if(!e.validateText(t))return;const i=n.mainValue.toJSON();i.push(t),n.setValue(i)},beforeSend(){var t;null!=(t=e._value)&&t.length&&e.showSubmit&&(e.addText(e._value),e._value="")},submitChanges(){e.beforeSend()},deleteText(e){(0,u.zr)(e)},onShortcut(o){if(!i(t,n)){var s,a;const o=(null==(s=e.textareaRef.current)?void 0:s.input)||(null==(a=e.textareaRef.current)||null==(a=a.resizableTextArea)?void 0:a.textArea);if(!i(o,e))return;t=o,n=e}t.setRangeText(o,t.selectionStart,t.selectionEnd,"end"),n.setValue(t.value)},setLastFocusedElement(i,o=e){t=i,n=o},returnFocus(){var e;null==(e=t)||null==e.focus||e.focus()}}}),Ku=u.gK.compose("TextAreaModel",Bd,Cu,Mu,...(0,Ne.VS)(Ne.y8)?[lu]:[],Fe,gu,ut,...(0,Ne.VS)(Ne.gF)?[du]:[],Te,Ye,Eu,Au),Du=(0,b.PA)(({item:e})=>{var t,n,i,o,s;const a=Number.parseInt(e.rows),r=(0,f.useCallback)((t,n)=>{e.setLastFocusedElement(t.target,n)},[e]),l=(e,t,n)=>1===e?t:n,c={name:e.name,value:e._value,rows:e.rows,className:"is-search",label:e.label,placeholder:e.placeholder,disabled:e.isReadOnly(),readOnly:e.isReadOnly(),onChange:t=>{if(e.annotation.isReadOnly())return;const{value:n}=t.target;e.setValue(n)},onFocus:r,ref:e.textareaRef,onKeyPress:e.countTime,onKeyDown:e.countTime,onKeyUp:e.countTime,onMouseDown:e.countTime,onMouseUp:e.countTime,onMouseMove:t=>(t.button||t.buttons)&&e.countTime()};a>1&&(c.onKeyDown=t=>{"Enter"===t.key&&t.shiftKey&&e.allowsubmit&&e._value&&!e.annotation.isReadOnly()?(t.preventDefault(),t.stopPropagation(),e.addText(e._value),e.setValue("")):e.countTime()});const d=e.perRegionVisible()?{}:{display:"none"},u=!e.isReadOnly()&&(null!=(t=e.showsubmitbutton)?t:1!==a),h={},g=(0,Nn.cn)("text-area").toClassName();return u&&(h.marginBottom=0),d.marginTop="4px",e.displaymode===dt.TAG?(0,ae.jsxs)("div",{className:g,style:d,ref:e.elementRef,"data-testid":"textarea-control",children:[st.renderChildren(e,e.annotation),e.showSubmit&&(0,ae.jsx)(su.A,{onFinish:()=>(e.allowsubmit&&e._value&&!e.annotation.isReadOnly()&&(e.addText(e._value),e.setValue("")),!1),"data-testid":"textarea-form",children:(0,ae.jsxs)(su.A.Item,{style:h,children:[1===a?(0,ae.jsx)(ou.A,Object.assign({},c,{"aria-label":"TextArea Input","data-testid":"textarea-input"})):(0,ae.jsx)(Iu,Object.assign({},c,{"aria-label":"TextArea Input","data-testid":"textarea-input"})),u&&(0,ae.jsxs)("div",{className:"flex items-center justify-between gap-tight w-full mb-tighter","data-testid":"textarea-submit-section",children:[(0,ae.jsxs)("div",{className:"flex items-center gap-base","aria-live":"polite","aria-atomic":"true","data-testid":"textarea-counts",children:[(0,ae.jsxs)(Pn.o5u,{size:"small",className:"text-neutral-content-subtler","data-testid":"textarea-character-count",children:[null!=(n=null==(i=e._value)?void 0:i.length)?n:0," ",l(null!=(o=null==(s=e._value)?void 0:s.length)?o:0,"character","characters")]}),(e.submissionsNum>0||e.maxsubmissions)&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Pn.o5u,{size:"small",className:"text-neutral-content-subtler","aria-hidden":"true",children:"â€¢"}),(0,ae.jsxs)(Pn.o5u,{size:"small",className:"text-neutral-content-subtler","data-testid":"textarea-submission-count",children:[e.submissionsNum,e.maxsubmissions&&` / ${e.maxsubmissions}`," ",l(e.submissionsNum,"submission","submissions")]})]})]}),(0,ae.jsxs)("div",{className:"flex items-center gap-base",children:[a>1&&(0,ae.jsx)(Pn.o5u,{size:"small",className:"text-neutral-content-subtler italic","data-testid":"textarea-instruction",children:"Press Shift + Enter to Add"}),(0,ae.jsx)(su.A.Item,{children:(0,ae.jsx)(Pn.$nd,{size:"small",variant:"primary",look:"outlined",leading:(0,ae.jsx)(kn.uID,{}),className:"w-20 px-tight",htmlType:"submit","data-testid":"textarea-add-button",children:"Add"})})]})]})]})}),e.regions.length>0&&(0,ae.jsx)("div",{style:{marginBottom:"1em"},"data-testid":"textarea-regions",children:e.regions.map(e=>(0,ae.jsx)(Su,{item:e,onFocus:r},e.id))})]}):null});we.addTag("textarea",Ku,Du);var Ou=n(55343),Lu=n(83419);var zu=n(94714),Bu=n(42197);const Fu=(e=!1)=>{const[t,n]=(0,f.useState)(e),[i,o,s]=(0,f.useMemo)(()=>[n.bind(null,!0),n.bind(null,!1),()=>n(e=>!e)],[]);return[t,i,o,s]};var Hu=n(84392);const Vu=e=>{let t=0,n=e.length;for(;n--;){t++;const i=e[n].children;i&&(t+=Vu(i))}return t},$u=(e,t)=>({label:"",depth:t,path:e,isOpen:!0});let Wu={};const Uu=({items:e,rowComponent:t,flatten:n,rowHeight:i,maxHeightPercentage:o,minWidth:s,maxWidth:a,transformationCallback:r,defaultExpanded:l,isEditable:c})=>{var d;const u=document.body.clientHeight,[h,g]=(0,f.useState)(),[m,p]=(0,f.useState)({}),[v,y]=(0,f.useState)(0),[b,x]=(0,f.useState)(s),w=(0,f.useRef)(),S=(0,f.useRef)(),C=null==(d=S.current)?void 0:d.firstChild;C&&(C.style.overflowX="hidden");const k=()=>{y((()=>{var e;w.current.resetAfterIndex(0);const t=null==(e=w.current)||null==(e=e._outerRef.firstChild)?void 0:e.offsetHeight,n=.01*o*u;return t>n?n:t})())},P=t=>{const n=l?{[t]:2!==m[t]?2:1}:{[t]:1!==m[t]?1:2};p(Object.assign({},m,n)),g(N({items:e,toggleItem:n})),y(.01*o*u),Wu={},w.current.resetAfterIndex(0)},R=t=>{c&&(g(N(t?{items:e,addInsideId:t}:{items:e})),k())},j=({data:e,index:t,rowStyle:n,rowComponent:o})=>{const s=e(t),r=(0,f.useCallback)(e=>{const n=`${t}`,o=(null==C?void 0:C.offsetWidth)-(null==C?void 0:C.clientWidth)||0,s=e.scrollWidth+o+5,r=e.scrollHeight;b<s?a<s?(Wu[n]=r,x(a)):(Wu[n]=i,x(s)):Wu[n]=i,k()},[b]);return(0,ae.jsx)(o,{isEditable:c,item:s,style:n,dimensionCallback:r,maxWidth:a})},N=({items:e,depth:t,toggleItem:i,addInsideId:o})=>{const s=[];for(let a=0;a<e.length;a++){const{children:c,label:d}=e[a],u=t||0,h=`${d}-${u}`,g=o===h,f=i&&i[h]||m[h]||g||(l?1:2),v=r({node:e[a],nestingLevel:u,isFiltering:n,isLeaf:!c,childCount:c&&Vu(c),isOpen:1===f});g&&p(Object.assign({},m,{[h]:1})),c&&1===f||g||n?(s.push(Object.assign({},v)),g&&s.push(...N({items:[$u(e[a].path,u+1)],depth:u+1})),c&&s.push(...N({items:c,depth:u+1,toggleItem:i,addInsideId:o}))):s.push(Object.assign({},v))}return s};return(0,f.useEffect)(()=>{g(N({items:e}))},[e]),(0,f.useEffect)(()=>{0===(null==h?void 0:h.length)&&k()},[h]),(0,ae.jsx)("div",{ref:S,children:(0,ae.jsx)(Hu._m,{ref:w,height:v+4,itemCount:(null==h?void 0:h.length)||0,itemSize:e=>Wu[`${e}`]||i,width:b,itemData:e=>({row:h&&h[e],toggle:P,addInside:R}),children:({data:e,index:n,style:i})=>(0,ae.jsx)(j,{data:e,rowStyle:i,index:n,rowComponent:t})})})},Gu={taxonomy:"taxonomy--sbNxo",taxonomy_open:"taxonomy_open--InD7j",taxonomy__selected:"taxonomy__selected--VOtIN",taxonomy__dropdown:"taxonomy__dropdown--Qi8yg",taxonomy__search:"taxonomy__search--qkTHD",taxonomy__item:"taxonomy__item--I4JB1",taxonomy__measure:"taxonomy__measure--ialoK",taxonomy__item_user:"taxonomy__item_user--JBwBu",taxonomy__item_session:"taxonomy__item_session--jWm5B",taxonomy__grouping:"taxonomy__grouping--iZK7b",taxonomy__extra:"taxonomy__extra--GgvBt",taxonomy__extra_actions:"taxonomy__extra_actions--tQuLD",taxonomy__extra_count:"taxonomy__extra_count--MtR7B",taxonomy__action:"taxonomy__action--rpruy",taxonomy__add__container:"taxonomy__add__container--rbs2W",taxonomy__add:"taxonomy__add--dOQt_",taxonomy__newitem:"taxonomy__newitem--amueo",taxonomy__collapsable:"taxonomy__collapsable--hc4oZ"},Yu=["title","wrapper","children"],Xu=f.createContext([[],()=>{}]),qu=f.createContext({}),Zu=({onAddLabel:e,onFinish:t,path:n})=>{const i=(0,f.useRef)(null),o=o=>{if(!i.current)return;const s=i.current.value,a="key"in o&&"Escape"===o.key,r="key"in o&&"Enter"===o.key,l="blur"===o.type;a&&o.stopPropagation(),r&&!s||((l||r)&&s&&e([...n,s]),(l||r||a)&&(i.current.value="",null==t||t()))};return(0,f.useEffect)(()=>{var e;return null==(e=i.current)?void 0:e.focus()},[]),(0,ae.jsx)("div",{className:Gu.taxonomy__newitem,children:(0,ae.jsx)("input",{name:"taxonomy__add",onKeyDownCapture:o,onBlur:o,ref:i})})},Ju=({isEditable:e,flatItems:t})=>{const[n,i]=(0,f.useContext)(Xu),{showFullPath:o,pathSeparator:s=" / "}=(0,f.useContext)(qu),a=n.map(e=>e.map(e=>{var n;const i=null==(n=t.find(t=>t.path[t.path.length-1]===e))?void 0:n.label;return null!=i?i:e}));return(0,ae.jsx)("div",{className:["htx-taxonomy-selected",Gu.taxonomy__selected].join(" "),children:a.map((t,a)=>(0,ae.jsxs)("div",{children:[(0,ae.jsx)("span",{children:o?t.join(s):t[t.length-1]}),e?(0,ae.jsx)("input",{type:"button",onClick:()=>i(n[a],!1),value:"Ã—"}):null]},t.join("|")))})};const Qu=e=>{let{title:t,wrapper:n,children:i}=e,o=(0,Se.A)(e,Yu);const s=n?(0,ae.jsx)(n,{children:i}):i;return t?(0,ae.jsx)(Pn.m_M,Object.assign({title:t},o,{children:s})):s},eh=({style:e,item:t,dimensionCallback:n,maxWidth:i,isEditable:o})=>{var s;const{row:{id:a,isOpen:r,childCount:l,isFiltering:c,name:d,path:u,padding:h,isLeaf:g,hint:m},toggle:p,addInside:v}=t,[y,b]=(0,f.useContext)(Xu),{leafsOnly:x,maxUsages:w,maxUsagesReached:S,onAddLabel:C,onDeleteLabel:k}=(0,f.useContext)(qu),P=y.some(e=>(0,E.isArraysEqual)(e,u)),R=y.some(e=>function(e,t){return!(e.length<=t.length)&&t.every((t,n)=>e[n]===t)}(e,u)),j=x&&!g,N=S&&!P,T=j||N||!o,_=g?{display:"none"}:{transform:r?"rotate(180deg)":"rotate(90deg)"},A=j?"Only leaf nodes allowed":N?`Maximum ${w} items already selected`:void 0,I=(0,f.useCallback)(e=>{e&&(e.indeterminate=!P&&R)},[P,R]),M=(0,f.useCallback)(()=>{null==k||k(u),v()},[t,k]),K="session"===t.row.origin?Gu.taxonomy__item_session:"user"===t.row.origin?Gu.taxonomy__item_user:"",D=""===d&&C,O=(0,f.useRef)();null==(s=O.current)||s.parentElement.offsetWidth;return(0,f.useEffect)(()=>{const e=null==O?void 0:O.current;e&&(e.toggle=p,n(e))},[]),(0,ae.jsx)("div",{ref:O,style:Object.assign({paddingLeft:h,maxWidth:i},e,{width:"fit-content"}),children:D?(0,ae.jsx)(Zu,{onAddLabel:C,onFinish:()=>v(),path:u},""):(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsxs)("div",{className:Gu.taxonomy__measure,children:[(0,ae.jsx)("label",{children:d}),!c&&(0,ae.jsx)("div",{className:Gu.taxonomy__extra,children:(0,ae.jsx)("span",{className:Gu.taxonomy__extra_count,children:l})})]}),(0,ae.jsx)(Qu,{title:m,children:(0,ae.jsxs)("div",{className:[Gu.taxonomy__item,K].join(" "),children:[(0,ae.jsx)("div",{className:Gu.taxonomy__grouping,onClick:()=>p(a),children:(0,ae.jsx)(kn.Vh6,{stroke:"#09f",style:_})}),(0,ae.jsx)("input",{className:"item",id:a,name:a,type:"checkbox",disabled:T,checked:P,ref:I,onChange:e=>{o&&b(u,e.currentTarget.checked)}}),(0,ae.jsx)("label",{htmlFor:a,onClick:o?()=>j&&p(a):void 0,title:A,className:T?Gu.taxonomy__collapsable:void 0,children:d}),!c&&(0,ae.jsxs)("div",{className:Gu.taxonomy__extra,children:[(0,ae.jsx)("span",{className:Gu.taxonomy__extra_count,children:l}),o&&C&&(0,ae.jsx)("div",{className:Gu.taxonomy__extra_actions,children:(0,ae.jsx)(zu.A,{destroyPopupOnHide:!0,trigger:["click"],overlay:(0,ae.jsxs)(Bu.A,{children:[(0,ae.jsx)(Bu.A.Item,{className:Gu.taxonomy__action,onClick:()=>{v(a)},children:"Add Inside"},"add-inside"),"session"===t.row.origin&&(0,ae.jsx)(Bu.A.Item,{className:Gu.taxonomy__action,onClick:M,children:"Delete"},"delete")]}),children:(0,ae.jsx)("div",{children:"..."})})})]})]})})]})})},th=({show:e,flatten:t,items:n,dropdownRef:i,isEditable:o})=>{const s=(0,f.useRef)(null),[a,r]=(0,f.useState)(""),{onAddLabel:l,minWidth:c,maxWidth:d}=(0,f.useContext)(qu),[u,h,g]=Fu(!1),m=a?((e,t)=>{const n=[],i=[];let o=-1;for(let a=e.length;a--;){const r=e[a];if(r.depth===o){var s;const e=Object.assign({},r,{children:null!=(s=i[o])?s:[]});i[o]=[],o?(i[o-1]||(i[o-1]=[]),i[o-1].unshift(e)):n.unshift(e),o--;continue}if(t(r)){const e=Object.assign({},r,{children:[]});0===r.depth?n.unshift(e):(o=r.depth-1,i[o]||(i[o]=[]),i[o].unshift(e))}}return n})(t,e=>e.label.toLocaleLowerCase().includes(a)):n;(0,f.useEffect)(()=>{const t=s.current;e&&t&&(t.value="",t.focus(),r(""))},[e]);return(0,ae.jsxs)("div",{className:Gu.taxonomy__dropdown,ref:i,style:{display:e?"block":"none"},children:[(0,ae.jsx)("input",{autoComplete:"off",className:Gu.taxonomy__search,name:"taxonomy__search",placeholder:"Search...",onInput:e=>r(e.currentTarget.value.toLocaleLowerCase()),ref:s}),(0,ae.jsx)(Uu,{items:m,isEditable:o,rowComponent:eh,flatten:""!==a,rowHeight:30,defaultExpanded:!1,maxHeightPercentage:50,minWidth:Number(c)||200,maxWidth:Number(d)||600,transformationCallback:({node:{children:e,depth:t,label:n,origin:i,path:o,hint:s},nestingLevel:a,isFiltering:r,isOpen:l,childCount:c})=>({childCount:c,id:`${n}-${t}`,isFiltering:r,isLeaf:!(null!=e&&e.length),isOpen:l,isOpenByDefault:!0,name:n,nestingLevel:a,origin:i,padding:10*a+10,path:o,hint:s})}),l&&""===a&&(0,ae.jsx)("div",{className:Gu.taxonomy__add__container,children:u?(0,ae.jsx)(Zu,{path:[],onAddLabel:l,onFinish:g}):o?(0,ae.jsx)("div",{className:Gu.taxonomy__add,children:(0,ae.jsx)(Pn.$nd,{size:"small",variant:"neutral",look:"string",type:"button",onClick:h,"aria-label":"Add new label",children:"Add"})}):null})]})},nh=({items:e,selected:t,onChange:n,onAddLabel:i,onDeleteLabel:o,options:s={},isEditable:a=!0})=>{const r=(0,f.useRef)(null),l=(0,f.useRef)(null),[c,d]=(0,f.useState)(!1),u=(0,f.useCallback)(()=>d(!1),[]),h=(0,f.useCallback)(e=>{var t;const n=Gu.taxonomy__action;[e.target,e.target.parentNode].some(e=>{var t;return null==e||null==(t=e.classList)?void 0:t.contains(n)})||null!=(t=l.current)&&t.contains(e.target)||u()},[]),g=c?Gu.taxonomy_open:"",m=(0,f.useMemo)(()=>{const t=[],n=e=>{var i;t.push(e),null==(i=e.children)||i.forEach(n)};return e.forEach(n),t},[e]),[p,v]=(0,f.useState)(t),y=(0,f.useMemo)(()=>[p,(e,t)=>{const i=t?[...p,e]:p.filter(t=>!(0,E.isArraysEqual)(t,e));(!1!==s.canRemoveItems||i.length)&&(v(i),n&&n(null,i))}],[p]),b=(0,f.useMemo)(()=>{const e=!!s.maxUsages&&p.length>=s.maxUsages;return Object.assign({},s,{maxUsagesReached:e,onAddLabel:i,onDeleteLabel:o})},[s,s.maxUsages,s.maxUsages?p:0]),x=(0,f.useCallback)(e=>{var t,n,i;const o=null==(t=l.current)?void 0:t.querySelectorAll(".item"),s=null==(n=l.current)?void 0:n.querySelector("input"),a=document.activeElement||void 0,r=o&&o.length>0,c=o&&a?Array.from(o).findIndex(e=>e.id===a.id):-1,h=(e,t)=>r&&o[e+t].focus(),g=e=>{["text","checkbox"].includes(e.target.type)&&e.preventDefault()};switch(e.key){case"Escape":u(),e.stopPropagation();break;case"ArrowDown":g(e),e.shiftKey&&(d(!0),s&&s.focus()),c>=0&&h(c,1),s===a&&h(0,0);break;case"ArrowUp":g(e),c>0?h(c,-1):0===c&&s&&s.focus();break;case"ArrowRight":c>=0&&(null==(i=a.parentNode)||null==(i=i.parentNode)||i.toggle(a.id)),s&&s.focus()}},[]);return(0,f.useEffect)(()=>{v(t)},[t]),(0,f.useEffect)(()=>(document.body.addEventListener("click",h,!0),document.body.addEventListener("keydown",x),()=>{document.body.removeEventListener("click",h),document.body.removeEventListener("keydown",x)}),[]),(0,ae.jsx)(Xu.Provider,{value:y,children:(0,ae.jsxs)(qu.Provider,{value:b,children:[(0,ae.jsx)(Ju,{isEditable:a,flatItems:m}),(0,ae.jsxs)("div",{className:["htx-taxonomy",Gu.taxonomy,g].join(" "),ref:l,children:[(0,ae.jsxs)("span",{onClick:()=>d(e=>!e),children:[s.placeholder||"Click to add...",(0,ae.jsx)(kn.Vh6,{stroke:"#09f"})]}),(0,ae.jsx)(th,{show:c,isEditable:a,items:e,flatten:m,dropdownRef:r})]})]})})},ih=u.gK.model(Object.assign({},(0,Ne.VS)(Ne.cE)?{id:u.gK.identifier}:{},{selected:u.gK.optional(u.gK.boolean,!1),alias:u.gK.maybeNull(u.gK.string),value:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string),style:u.gK.maybeNull(u.gK.string),html:u.gK.maybeNull(u.gK.string),color:u.gK.maybeNull(u.gK.string),hint:u.gK.maybeNull(u.gK.string)})),oh=u.gK.model({type:"choice",visible:u.gK.optional(u.gK.boolean,!0),_value:u.gK.optional(u.gK.string,""),children:je.unionArray(["choice"]),parentTypes:je.tagsTypes(["Choices","Taxonomy"]),readonly:u.gK.optional(u.gK.boolean,!1)}).views(e=>({get isCheckbox(){var t;const n=null==(t=e.parent)?void 0:t.choice;return"multiple"===n||"single"===n},get isSelect(){var t;return"select"===(null==(t=e.parent)?void 0:t.layout)},canBeUsed:()=>!0,get isLeaf(){var t;return!e.nestedResults||!(null!=(t=e.children)&&t.length)},get sel(){return e.isLeaf?e._sel:e.children.every(e=>!0===e.sel)},get indeterminate(){return!e.isLeaf&&(!e.sel&&e.children.some(e=>!0===e.sel))},get parentChoice(){return je.getParentTagOfTypeString(e,"choice")},get isSkipped(){return!e.nestedResults&&!!e.parentChoice},get nestedResults(){var t;return!1!==(null==(t=e.parent)?void 0:t.allownested)},get _resultValue(){var t;return null!=(t=e.alias)?t:e._value},get resultValue(){if(e.nestedResults){const t=[];let n=e;for(;n;)t.unshift(n._resultValue),n=n.parentChoice;return t}return e._resultValue},isReadOnly(){var t;return e.readonly||(null==(t=e.parent)?void 0:t.isReadOnly())},get isIndependent(){return!0}})).volatile(()=>({_sel:!1})).actions(e=>({toggleSelected(){var t,n;if(null!=(t=e.parent)&&t.readonly||null!=(n=e.annotation)&&n.isReadOnly())return;const i=e.parent,o=e.sel;i.shouldBeUnselected&&(null==i.resetSelected||i.resetSelected()),e.setSelected(!o),null==i.updateResult||i.updateResult()},setVisible(t){e.visible=t},setSelected(t){e._sel=t,e.isLeaf||e.children.forEach(e=>{e.setSelected(t)})}})).actions(e=>{var t;return"choices"===(null==(t=e.parent)?void 0:t.type)?{onHotKey:()=>e.toggleSelected()}:{}}),sh=u.gK.compose("ChoiceModel",Vd,ih,Fe,oh,Te),ah=(0,b.WQ)("store")((0,b.PA)(({item:e,store:t})=>{var n;let i={};e.style&&(i=st.cssConverter(e.style));const o=(t.settings.enableTooltips||t.settings.enableLabelTooltips)&&t.settings.enableHotkeys&&e.hotkey,s=(0,f.useCallback)(t=>{e.isReadOnly()||(e.toggleSelected(),t.nativeEvent.target.blur())},[]),[a,r]=(0,f.useState)(!1),l=(0,f.useCallback)(()=>r(e=>!e),[]),c=(d=e.isCheckbox?Ou.A:Lu.Ay,u=e._value,e=>(0,ae.jsx)(d,Object.assign({},e,{name:u})));var d,u;return(0,ae.jsxs)("div",{className:(0,Nn.cn)("choice").mod({layout:e.parent.layout,leaf:e.isLeaf,notLeaf:!e.isLeaf,hidden:!e.visible}).toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("choice").elem("item").mod({notLeaf:!e.isLeaf}).toClassName(),style:i,children:[(0,ae.jsx)(c,{className:(0,Nn.cn)("choice").elem("checkbox").mod({notLeaf:!e.isLeaf}).toClassName(),checked:e.sel,indeterminate:!e.sel&&e.indeterminate,disabled:e.isReadOnly(),onChange:s,children:(0,ae.jsxs)(Qu,{title:e.hint,wrapper:"span",children:[e.html?(0,ae.jsx)("span",{dangerouslySetInnerHTML:{__html:(0,fe.sanitizeHtml)(e.html)}}):e._value,o&&(0,ae.jsxs)(Tn,{children:["[",e.hotkey,"]"]})]})}),!e.isLeaf&&(0,ae.jsx)(ku.A,{className:(0,Nn.cn)("choice").elem("toggle").mod({collapsed:a}).toClassName(),type:"text",onClick:l,children:(0,ae.jsx)(Pn.Vh6,{})})]}),e.nestedResults&&null!=(n=e.children)&&n.length?(0,ae.jsx)("div",{className:(0,Nn.cn)("choice").elem("children").mod({collapsed:a}).toClassName(),children:st.renderChildren(e,e.annotation)}):null]})}));we.addTag("choice",sh,ah);const rh=u.gK.model().views(e=>({findSelectedChoice(t){var n,i;let o;return e.findLabel?o=e.findLabel(t):e.findItemByValueOrAlias&&(o=e.findItemByValueOrAlias(t)),(null==(n=o)?void 0:n.alias)||(null==(i=o)?void 0:i.value)},selectedChoicesMatch(t,n){const i=e.findSelectedChoice(t),o=e.findSelectedChoice(n);return(0,E.isDefined)(i)&&(0,E.isDefined)(o)&&i===o},hasChoiceSelectionSimple(t){if(null!=t&&t.length){const n=e.selectedValues().map(e=>Array.isArray(e)?e.at(-1):e);return t.some(e=>n.includes(e))}return e.isSelected},hasChoiceSelection(t,n=[]){if(null!=t&&t.length){if(e.findLabel&&"taxonomy"!==e.type)return t.map(t=>e.findLabel(t)).some(e=>e&&e.sel);if(n.length){const i=t=>{if(e.findItemByValueOrAlias){const n=e.findItemByValueOrAlias(t);t=(null==n?void 0:n.alias)||(null==n?void 0:n.value)||t}return n.map(e=>Array.isArray(e)?e.at(-1):e).includes(t)};return t.some(i)}return!1}return e.isSelected}})),lh=u.gK.model({toname:u.gK.maybeNull(u.gK.string),showinline:u.gK.maybeNull(u.gK.boolean),choice:u.gK.optional(u.gK.enumeration(["single","single-radio","multiple"]),"single"),layout:u.gK.optional(u.gK.enumeration(["select","inline","vertical"]),"vertical"),value:u.gK.optional(u.gK.string,""),allownested:u.gK.optional(u.gK.boolean,!1)}),ch=u.gK.model({pid:u.gK.optional(u.gK.string,I),visible:u.gK.optional(u.gK.boolean,!0),type:"choices",children:je.unionArray(["choice","view","header","hypertext"])}).views(e=>({get shouldBeUnselected(){return"single"===e.choice||"single-radio"===e.choice},states:()=>e.annotation.toNames.get(e.name),get serializableValue(){const t=e.selectedValues();return t&&t.length?{choices:t}:null},get preselectedValues(){return e.tiedChildren.filter(e=>!0===e.selected&&!e.isSkipped).map(e=>e.resultValue)},get selectedLabels(){return e.tiedChildren.filter(e=>!0===e.sel&&!e.isSkipped)},selectedValues:()=>e.selectedLabels.map(e=>e.resultValue),get defaultChildType(){return"choice"}})).actions(e=>({afterCreate(){!0===e.showinline&&(e.layout="inline"),!1===e.showinline&&(e.layout="vertical")},needsUpdate(){e.result?e.setResult(e.result.mainValue):e.setResult([])},requiredModal(){dn.warning(e.requiredmessage||`Checkbox "${e.name}" is required.`)},unselectAll(){},updateFromResult(t){e.setResult(Array.isArray(t)?t:[t])},resetSelected(){e.selectedLabels.forEach(e=>e.setSelected(!1))},setResult(t){e.tiedChildren.forEach(e=>{let n=!1;e.isSkipped||(n=null==t||null==t.some?void 0:t.some(t=>Array.isArray(t)&&Array.isArray(e.resultValue)?t.length===e.resultValue.length&&(null==t.every?void 0:t.every((t,n)=>{var i;return t===(null==(i=e.resultValue)?void 0:i[n])})):t===e.resultValue)),e.setSelected(n)})}})).actions(e=>{const t={validate:e.validate};return{validate(){if(!t.validate()||"multiple"!==e.choice&&e.checkResultLength()>1)return!1},checkResultLength:()=>e.children.filter(e=>e._sel).length,beforeSend(){"multiple"!==e.choice&&e.checkResultLength()>1&&dn.warning(`The number of options selected (${e.checkResultLength()}) exceed the maximum allowed (1). To proceed, first unselect excess options for:\r\n â€¢ Choices (${e.name})`)}}}),dh=u.gK.compose("ChoicesModel",Bd,Cu,Dd.props({_child:"ChoiceModel"}),gu,ut,...(0,Ne.VS)(Ne.gF)?[du]:[],Ye,rh,Au,Ld,Te,lh,ch),uh=(0,b.PA)(({item:e})=>{const t=(0,f.useMemo)(()=>e.tiedChildren.map(e=>({value:e._value,label:(0,ae.jsx)(Pn.m_M,{title:e.hint,children:(0,ae.jsx)("span",{"data-testid":"choiceOptionText",className:"w-full",children:e._value})})})),[e.tiedChildren]);return(0,ae.jsx)(Pn.l6P,{style:{width:"100%"},value:e.selectedLabels.map(e=>e._value),multiple:"multiple"===e.choice,disabled:e.isReadOnly(),onChange:t=>{if(Array.isArray(t))e.resetSelected(),t.forEach(t=>e.findLabel(t).setSelected(!0)),e.updateResult();else{const n=e.findLabel(t);n&&n.toggleSelected()}},options:t})}),hh=(0,b.PA)(({item:e})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("choices").mod({hidden:!e.isVisible||!e.perRegionVisible(),layout:e.layout}).toClassName(),ref:e.elementRef,children:"select"===e.layout?(0,ae.jsx)(uh,{item:e}):st.renderChildren(e,e.annotation)}));we.addTag("choices",dh,hh);var gh=n(37881),mh=n(99811);const ph=u.gK.model({toname:u.gK.maybeNull(u.gK.string),maxrating:u.gK.optional(u.gK.string,"5"),icon:u.gK.optional(u.gK.string,"star"),size:u.gK.optional(u.gK.string,"medium"),defaultvalue:u.gK.optional(u.gK.string,"0"),hotkey:u.gK.maybeNull(u.gK.string)}),fh=u.gK.model({pid:u.gK.optional(u.gK.string,I),type:"rating",rating:u.gK.maybeNull(u.gK.number)}).views(e=>({selectedValues:()=>e.rating,get serializableValue(){const t=e.selectedValues();return t?{rating:t}:null},get holdsState(){return e.rating>0}})).actions(e=>({getSelectedString:()=>`${e.rating} star`,needsUpdate(){e.result?e.rating=e.result.mainValue:e.rating=null},unselectAll(){},setRating(t){e.rating=t,e.updateResult()},updateFromResult(t){e.rating=t},requiredModal(){dn.warning(e.requiredmessage||`Rating "${e.name}" is required.`)},increaseValue(){e.rating>=Number(e.maxrating)?e.setRating(0):e.rating>0?e.setRating(e.rating+1):e.setRating(1)},onHotKey:()=>e.increaseValue()})),vh=u.gK.compose("RatingModel",Bd,Cu,gu,Ye,ut,...(0,Ne.VS)(Ne.gF)?[du]:[],Te,ph,fh),yh=(0,b.WQ)("store")((0,b.PA)(({item:e,store:t})=>{let n;"small"===e.size?n=15:"medium"===e.size?n=25:"large"===e.size&&(n=40);const i=e.perRegionVisible()?{}:{display:"none"};return(0,ae.jsxs)("div",{style:i,onKeyDownCapture:e=>{if(e.ctrlKey||e.metaKey||e.altKey||e.shiftKey){const t=document.activeElement;e.currentTarget.contains(t)&&t.blur()}},ref:e.elementRef,children:[(0,ae.jsx)(gh.A,{character:(0,ae.jsx)(mh.A,{style:{fontSize:n}}),value:e.rating,count:Number(e.maxrating),defaultValue:Number(e.defaultvalue),onChange:e.setRating,disabled:e.isReadOnly()}),t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,ae.jsxs)("sup",{style:{fontSize:"9px"},children:["[",e.hotkey,"]"]})]})}));we.addTag("rating",vh,yh);const bh=u.gK.model("ParagraphsRegionModel",{type:"textrange",object:u.gK.late(()=>u.gK.reference(Th)),startOffset:u.gK.integer,start:u.gK.string,endOffset:u.gK.integer,end:u.gK.string,states:u.gK.maybeNull(u.gK.array(u.gK.union(nu,Ku,dh,vh)))}).volatile(()=>({text:"",hideable:!0})).views(e=>({get parent(){return(0,u._n)(e)?e.object:null},getRegionElement(){var t;return null==(t=e._spans)?void 0:t[0]}})).actions(e=>({beforeDestroy(){en.HTML.removeSpans(e._spans)},setText(t){e.text=t},fixOffsets(t,n){e.startOffset=t,e.endOffset=n},serialize(){const{start:t,end:n}=e,i={value:{start:t,end:n,startOffset:e.startOffset,endOffset:e.endOffset}};return"yes"===e.object.savetextresult&&(i.value.text=e.text),i}})),xh=u.gK.compose("ParagraphsRegionModel",Ze,mt,Ge,bh,Ed);we.addRegionType(xh,"paragraphs");const wh={paragraphs:"paragraphs--LTeUi",phrase:"phrase--qv9_O",numbered:"numbered--a9bkk",name:"name--PZvdb",text:"text--Ou0FP",dialoguename:"dialoguename--Z1bwn",dialoguetext:"dialoguetext--fQTLz",scroll_container:"scroll_container--zjNwB",wrapper_header:"wrapper_header--EZcmN",wrapper_header__buttons:"wrapper_header__buttons--V_YdW",container:"container--mYuCT",withAudio:"withAudio--toh21",collapsed:"collapsed--JuuM7",authorFilter:"authorFilter--koQOu",authorFilter__showall:"authorFilter__showall--iRWAc",authorFilter__placeholder:"authorFilter__placeholder--OnkZm",authorFilter__search:"authorFilter__search--CKZQK",authorFilter__search__input:"authorFilter__search__input--Z6sUA",authorFilter__select:"authorFilter__select--_OLb1",authorFilter__select__item:"authorFilter__select__item--q_yG2",audio:"audio--Fq_ZD",phraseContainer:"phraseContainer--HLfsx",play:"play--q_72j",selectAllBtn:"selectAllBtn--ANhij",selectAllBtnWrapper:"selectAllBtnWrapper--KFUXX",selectAllLabel:"selectAllLabel--AM3M8",newUI:"newUI--hohwV",withSelectAllButton:"withSelectAllButton--NiKNq",titleWrapper:"titleWrapper--guGg3",time:"time--JzGDH",wrapperText:"wrapperText--Rj0j9",readingLine:"readingLine--UoCCW"},Sh=["playing"],Ch=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING),kh=u.gK.model("ParagraphsModel",{value:u.gK.maybeNull(u.gK.string),valuetype:u.gK.optional(u.gK.enumeration(["json","url"]),()=>window.LS_SECURE_MODE?"url":"json"),audiourl:u.gK.maybeNull(u.gK.string),showplayer:!1,highlightcolor:u.gK.maybeNull(u.gK.string),showlabels:u.gK.optional(u.gK.boolean,!1),layout:u.gK.optional(u.gK.enumeration(["none","dialogue"]),"none"),savetextresult:u.gK.optional(u.gK.enumeration(["none","no","yes"]),()=>window.LS_SECURE_MODE?"no":"yes"),namekey:u.gK.optional(u.gK.string,"author"),textkey:u.gK.optional(u.gK.string,"text"),contextscroll:u.gK.optional(u.gK.boolean,!1)}),Ph=u.gK.model("ParagraphsModel",{type:"paragraphs",_update:u.gK.optional(u.gK.number,1)}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0},get store(){return(0,u.Zn)(e)},get audio(){if(!e.audiourl)return null;if("$"===e.audiourl[0]){const t=(0,u.Zn)(e),n=e.audiourl.substr(1);return t.task.dataObj[n]}return e.audiourl},layoutStyles(t){if("dialogue"===e.layout){const n=t[e.namekey],i=Md().make_color({seed:n})[0];return(0,Ne.VS)(Ne.LG)?{phrase:{"--highlight-color":i,"--background-color":"#FFF"},name:{color:i},inactive:{phrase:{"--highlight-color":en.Colors.convertToRGBA(i,.4),"--background-color":"#FAFAFA"},name:{color:en.Colors.convertToRGBA(i,.9)}}}:{phrase:{backgroundColor:en.Colors.convertToRGBA(i,.25)}}}return{}},get layoutClasses(){return"dialogue"===e.layout?{phrase:wh.phrase,name:wh.dialoguename,text:wh.dialoguetext}:{phrase:wh.phrase,name:wh.name,text:wh.text}},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t&&t.filter(e=>e.isSelected&&"paragraphlabels"===e._type)},isVisibleForAuthorFilter:t=>!(0,Ne.VS)(Ne.fw)||(!e.filterByAuthor.length||e.filterByAuthor.includes(t[e.namekey]))})),Rh=u.gK.model().volatile(()=>({_value:null,filterByAuthor:[],searchAuthor:"",playingId:-1,playing:!1,audioRef:(0,f.createRef)(),audioDuration:null,audioFrameHandler:null,_viewRef:null})).views(e=>({regionIndicesByTime(t){var n;const i=[];return null==(n=e._value)||n.forEach(({start:e,duration:n,end:o},s)=>void 0!==e&&(!(e>t)&&void((void 0===n&&void 0===o||(null!=o?o:e+n)>t)&&i.push(s)))),i},get regionsStartEnd(){var t;return e.audioDuration?null==(t=e._value)?void 0:t.map(t=>{var n,i;if(void 0===t.start)return{};const o=(0,E.clamp)(null!=(n=t.start)?n:0,0,e.audioDuration),s=t.duration?o+t.duration:null!=(i=t.end)?i:e.audioDuration;return{start:o,end:(0,E.clamp)(s,o,e.audioDuration)}}):[]},get regionsValues(){return Object.values(e.regionsStartEnd)}})).actions(e=>({triggerSync(t,n){const i=e.audioRef.current;i&&e.syncSend(Object.assign({playing:!i.paused,time:i.currentTime},n),t)},triggerSyncBuffering(t){var n;if(null==(n=e.audioRef)||!n.current)return;if(!Ch)return;const i=e.wasPlayingBeforeBuffering;e.triggerSync("buffering",{buffering:t,playing:i})},registerSyncHandlers(){e.syncHandlers.set("pause",Ch?e.handleSyncPause:e.stopNow),e.syncHandlers.set("play",e.handleSyncPlay),e.syncHandlers.set("seek",e.handleSyncPlay),e.syncHandlers.set("speed",e.handleSyncSpeed),Ch&&e.syncHandlers.set("buffering",e.handleSyncBuffering)},handleSyncBuffering(t){var n;let{playing:i}=t,o=(0,Se.A)(t,Sh);const s=e.audioRef.current;s.currentTime=o.time,e.isBuffering=null==(n=e.syncManager)?void 0:n.isBuffering,o.buffering&&(e.wasPlayingBeforeBuffering=i,null==s||s.pause(),e.playing=!1),e.isBuffering||o.buffering||i&&(null==s||s.play(),e.playing=!0,e.trackPlayingId())},handleSyncPlay({time:t,playing:n},i){var o;const s=e.audioRef.current;if(!s)return;const a=null==(o=e.syncManager)?void 0:o.isBuffering;if(s.currentTime=t,!Ch||!a&&(0,E.isDefined)(n)){const t=Ch?!e.wasPlayingBeforeBuffering:s.paused;t&&n?e.play():!Ch||t||n?e.trackPlayingId():e.stopNow()}["play","pause"].indexOf(i)>-1&&(e.wasPlayingBeforeBuffering=n)},handleSyncPause({playing:t},n){var i;"pause"===n&&(e.wasPlayingBeforeBuffering=!1);const o=null==(i=e.syncManager)?void 0:i.isBuffering;(!Ch||!o&&(0,E.isDefined)(t))&&e.stopNow()},handleSyncSpeed({speed:t}){const n=e.audioRef.current;n&&(n.playbackRate=t)},syncMuted(t){const n=e.audioRef.current;n&&(n.muted=t)}})).actions(e=>({handleAudioLoaded(t){const n=t.target;e.audioDuration=n.duration},reset(){e.playingId=-1,e.audioFrameHandler&&(cancelAnimationFrame(e.audioFrameHandler),e.audioFrameHandler=null)},stopNow(){const t=e.audioRef.current;t&&(t.paused||(t.pause(),e.playing=!1,e.triggerSync("pause",Ch?{playing:!1}:void 0)))},stopAtTheEnd(){var t;const n=e.audioRef.current;if(!n)return;if(n.paused)return;const{end:i}=null!=(t=e.regionsStartEnd[e.playingId])?t:{};n.currentTime<i?e.audioFrameHandler=requestAnimationFrame(e.stopAtTheEnd):(e.stopNow(),e.reset())},trackPlayingId(){Ch?(e.audioFrameHandler&&cancelAnimationFrame(e.audioFrameHandler),e.audioFrameHandler=requestAnimationFrame(e._trackPlayingId)):e._trackPlayingId()},_trackPlayingId(){e.audioFrameHandler&&cancelAnimationFrame(e.audioFrameHandler);const t=e.audioRef.current,n=null==t?void 0:t.currentTime,i=null==t?void 0:t.duration;if(!(0,E.isDefined)(n)||!(0,E.isDefined)(i)||n>=i)return void e.reset();const o=e.regionsValues;e.playingId=o.findIndex(({start:e,end:t})=>n>=e&&n<t);(Ch?e.playing&&!e.isBuffering:!t.paused)&&(e.audioFrameHandler=requestAnimationFrame(e._trackPlayingId))},playAny(){var t;const n=null==(t=e.audioRef)?void 0:t.current;if(!(0,E.isDefined)(n))return;n.paused&&(n.play(),e.triggerSync("play",Ch?{playing:!0}:void 0)),e.playing=!0,e.trackPlayingId()},play(t){var n,i;if(e.wasPlayingBeforeBuffering=!0,!(0,E.isDefined)(t))return void e.playAny();const{start:o,end:s}=null!=(n=e.regionsStartEnd[t])?n:{},a=null==(i=e.audioRef)?void 0:i.current;if(!(0,E.isDefined)(a)||!(0,E.isDefined)(o)||!(0,E.isDefined)(s))return;const r=!a.paused,l=e.playingId;if(r&&l===t)return e.wasPlayingBeforeBuffering=!1,void e.stopNow();t!==l&&(a.currentTime=o),a.play(),e.playing=!0,e.playingId=t,e.triggerSync("play",Ch?{playing:!0}:void 0),e.trackPlayingId()},handleBuffering(t){var n,i,o,s,a,r;if(!Ch)return;if((null==(n=e.syncManager)?void 0:n.isBufferingOrigin(e.name))===t)return;const l=!(null==(i=e.syncManager)?void 0:i.isBuffering)&&t,c=1===(null==(o=e.syncManager)?void 0:o.bufferingOrigins.size)&&(null==(s=e.syncManager)?void 0:s.isBufferingOrigin(e.name))&&!t,d=null==(a=e.audioRef)?void 0:a.current;c&&e.wasPlayingBeforeBuffering&&(null==d||d.play()),e.triggerSyncBuffering(t),e.isBuffering=null==(r=e.syncManager)?void 0:r.isBuffering,l&&(null==d||d.pause()),c&&e.wasPlayingBeforeBuffering&&e.trackPlayingId()}})).actions(e=>({setAuthorSearch(t){e.searchAuthor=t},setAuthorFilter(t){e.filterByAuthor=t},seekToPhrase(t){var n;if(!(0,E.isDefined)(t)||!e._value||t<0||t>=e._value.length)return;const i=e._value[t];if(e.playingId===t)return;const o=null==(n=e.audioRef)?void 0:n.current;o&&!o.paused&&void 0!==i.start?e.play(t):(e.playingId=t,void 0!==i.start&&(e.syncSend?e.syncSend({time:i.start,playing:!1},"seek"):o&&(o.currentTime=i.start)))},setViewRef(t){e._viewRef=t},selectPhraseText(t){var n;null==(n=e._viewRef)||null==n.selectText||n.selectText(t)},selectAndAnnotatePhrase(t){var n;e.selectPhraseText(t),null==(n=e._viewRef)||null==n.createAnnotationForPhrase||n.createAnnotationForPhrase(t)},selectAllAndAnnotateCurrentPhrase(){if(!e._value||0===e._value.length)return;const t=Math.max(0,e.playingId);e.selectAndAnnotatePhrase(t)},goToNextPhrase(){if(!e._value||0===e._value.length)return;const t=((e.playingId>=0?e.playingId:-1)+1)%e._value.length;e.seekToPhrase(t)},goToPreviousPhrase(){if(!e._value||0===e._value.length)return;const t=(Math.max(0,e.playingId)-1+e._value.length)%e._value.length;e.seekToPhrase(t)}})),jh=u.gK.model().actions(e=>({needsUpdate(){e._update=e._update+1},updateValue(t){const n=Oe(e.value,t.task.dataObj);if("url"===e.valuetype){const i=n;if(!(0,E.isValidObjectURL)(i,!0)){const o=[];return i?(o.push(`URL (${i}) is not valid.`),o.push('You should not put data directly into your task if you use valuetype="url".')):o.push(`URL is empty, check ${n} in data JSON.`),window.LS_SECURE_MODE&&o.unshift('In SECURE MODE valuetype set to "url" by default.'),t.annotationStore.addErrors([Os.generalError(o.join("\n"))]),void e.setRemoteValue("")}fetch(i).then(e=>{if(!e.ok)throw new Error(`${e.status} ${e.statusText}`);return e.json()}).then(e.setRemoteValue).catch(n=>{const o=Ds.A.ERR_LOADING_HTTP({attr:e.value,error:String(n),url:i});t.annotationStore.addErrors([Os.generalError(o)]),e.setRemoteValue("")})}else e.setRemoteValue(n)},setRemoteValue(t){const n=[];if(Array.isArray(t)?(e.namekey in t[0]||n.push(`"${e.namekey}" field not found in task data; check your <b>nameKey</b> parameter`),e.textkey in t[0]||n.push(`"${e.textkey}" field not found in task data; check your <b>textKey</b> parameter`)):n.push("Provided data is not an array"),n.length){const t=[`Task data (provided as <b>${e.value}</b>) has wrong format.<br/>`,"It should be an array of objects with fields,",'defined by <b>nameKey</b> ("author" by default)','and <b>textKey</b> ("text" by default)'].join(" ");return void e.store.annotationStore.addErrors([Os.generalError(`${t}<ul>${n.map(e=>`<li>${e}</li>`).join("")}</ul>`)])}const i=(0,Ne.VS)(Ne.LG)&&e.contextscroll?t.sort((e,t)=>{if(!e.start)return 1;if(!t.start)return-1;const n=e.end?e.end:e.start+e.duration||0,i=t.end?t.end:t.start+t.duration||0;return e.start===t.start?n-i:e.start-t.start}):t;e._value=i,e.needsUpdate()},createRegion(t){const n=xh.create(Object.assign({pid:t.id},t));return n._range=t._range,e.regions.push(n),e.annotation.addRegion(n),n},addRegions(t){const n=[],i=e.getAvailableStates();if(0===i.length)return;const[o,...s]=i,a={[o.valueType]:o.selectedValues()};for(const i of t){const t=He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult(i,a,o,e,!1,s):e.annotation.createResult(i,a,o,e,!1);t.setText(i.text),t.notifyDrawingFinished(),t._range=i._range,n.push(t)}return n},addRegion(t){if((0,Ne.VS)(Ne.Gd))return e.addRegions([t])[0];const n=e.getAvailableStates();if(0===n.length)return;const[i,...o]=n,s={[i.valueType]:i.selectedValues()},a=He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult(t,s,i,e,!1,o):e.annotation.createResult(t,s,i,e,!1);return a.setText(t.text),a.notifyDrawingFinished(),a._range=t._range,a}})),Nh=[Ze,kh,Ue,gn,Te,Ph,Rh,jh].filter(Boolean),Th=u.gK.compose("ParagraphsModel",...Nh),_h=(e,t)=>{const n=(0,f.useRef)(null),i=(0,f.useRef)(null),o=(0,f.useCallback)(()=>{n.current&&(clearTimeout(n.current),n.current=null);const s=e.current;if(!s)return;const a=null!==i.current&&Date.now()-i.current<100;var r;s.networkState===s.NETWORK_LOADING||a?(t(!0),i.current=null!=(r=i.current)?r:Date.now(),n.current=window.setTimeout(o,16)):t(!1)},[e,t]);return(0,f.useEffect)(()=>()=>{n.current&&clearTimeout(n.current)},[]),o},Ah=({name:e,selected:t})=>{const n={border:`2px solid ${en.Colors.convertToRGBA(Md().make_color({seed:e})[0])}`};return"all"===e?(0,ae.jsx)(ae.Fragment,{children:"Show all authors"}):(0,ae.jsx)("span",{className:[wh.authorFilter__select__item,t&&wh.authorFilter__select__item_selected].join(" "),style:n,children:e})},Ih=(0,b.PA)(({item:e,onChange:t})=>{const n=(0,f.useMemo)(()=>(0,ae.jsx)("span",{className:wh.authorFilter__placeholder,children:"Show all authors"}),[]),i="all",o=(0,f.useMemo)(()=>{const t=e._value.reduce((t,n)=>t.includes(n[e.namekey])?t:[...t,n[e.namekey]],[]).sort().map(e=>({value:e,label:(0,ae.jsx)(Ah,{name:e})}));return[{value:i,label:(0,ae.jsx)(Ah,{name:i}),children:t}]},[e._value,e.namekey,i]),s=(0,f.useCallback)(n=>{var i;const o=null!=(i=null==n?void 0:n.value)?i:n;!o||null!=o&&o.includes("all")?e.setAuthorFilter([]):o&&e.setAuthorFilter(o),null==t||t()},[e.setAuthorFilter]);return(0,ae.jsx)("div",{className:wh.authorFilter,children:(0,ae.jsx)(Pn.l6P,{placeholder:n,options:o,onChange:s,size:"compact",multiple:!0,searchable:!0})})});var Mh=n(52345),Eh=n(53567);const Kh=e=>{if(isNaN(e))return"";const t=Math.floor(e/3600),n=Math.floor(e%3600/60),i=Math.round(e%60);return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(i).padStart(2,"0")}`},Dh=(0,b.PA)(({item:e,playingId:t,activeRef:n,setIsInViewPort:i,hasSelectedLabels:o})=>{const[s,a]=(0,f.useState)(null),[r,l]=(0,f.useState)(0),[c,d]=(0,f.useState)(null),h=e.layoutClasses,g=!!e.audio;let m;const p=(0,f.useRef)([]),v=(0,f.useCallback)(t=>{var n;if(!t)return{start:0,end:0,duration:0};const i=null!=(n=t.start)?n:0;let o;o=void 0!==t.end?t.end:void 0!==t.duration?i+t.duration:0!==i?e.audioDuration||i:0;return{start:i,end:o,duration:o-i}},[e.audioDuration]),y=(0,f.useCallback)((t,n,i,o=!0)=>{if(!t||!(0,Ne.VS)(Ne.LG)||!e.contextscroll)return;const s=t.animate([{top:`${n}%`},{top:"100%"}],{easing:"linear",duration:1e3*i});o?s.play():s.pause(),a(s)},[s,a]),b=(0,f.useCallback)(i=>{var o;if(!(0,Ne.VS)(Ne.LG)||!e.contextscroll)return;const s=e._value[t],{start:a,end:l,duration:c}=v(s),u=l-r.time,h=100-100*u/c;h>0&&h<100?y(null==(o=n.current)?void 0:o.querySelector(".reading-line"),h,u,r.playing):d(i)},[r,t,v]),x=(0,f.useCallback)(n=>{if(m&&m.disconnect(),null!==n){const o=e._value[t],{duration:s}=v(o);!isNaN(s)&&s>0&&y(n,0,s,e.playing),m=new IntersectionObserver(e=>{i(e[0].isIntersecting)},{rootMargin:"0px"}),m.observe(n)}},[t,v]);if((0,f.useEffect)(()=>{var t;if((0,Ne.VS)(Ne.LG)&&e.contextscroll)return null==(t=e.syncHandlers)||t.set("seek",t=>{e.handleSyncPlay(t),l(t),i(!0)}),()=>{var e;null==(e=m)||e.disconnect()}},[]),(0,f.useEffect)(()=>{b(!0)},[r]),(0,f.useEffect)(()=>{c&&b(!1)},[t]),(0,f.useEffect)(()=>{(0,Ne.VS)(Ne.LG)&&e.contextscroll&&(e.playing?null==s||s.play():null==s||s.pause())},[e.playing]),(0,f.useEffect)(()=>{if((0,Ne.VS)(Ne.Gs)&&p.current[t]){const e=p.current[t];null==e||null==e.focus||e.focus()}},[t]),!e._value)return null;return e._value.map((s,a)=>{const r=t===a,l=r&&e.playing,c=(0,Ne.VS)(Ne.LG)&&!r?e.layoutStyles(s).inactive:e.layoutStyles(s),d=[h.phrase];(0,Ne.VS)(Ne.LG)&&d.push(wh.newUI),(0,Ne.VS)(Ne.Gs)&&d.push(wh.withSelectAllButton);const m=e.isVisibleForAuthorFilter(s);g&&d.push(wh.withAudio),m||d.push(wh.collapsed),(0,u.Zn)(e).settings.showLineNumbers&&d.push(wh.numbered),(0,Ne.VS)(Ne.Gs)&&r&&d.push(wh.activePhrase);const f=(0,Ne.VS)(Ne.Gs)?()=>e.seekToPhrase(a):void 0;return(0,ae.jsxs)("div",{className:wh.phraseContainer,children:[m&&!isNaN(s.start)&&(0,ae.jsx)(Pn.$nd,{look:"string",className:(0,Ne.VS)(Ne.LG)?wh.playNewUi:wh.play,"aria-label":l?"pause":"play",disabled:!g,icon:l?(0,Ne.VS)(Ne.LG)?(0,ae.jsx)(kn._Zj,{}):(0,ae.jsx)(Mh.A,{}):(0,Ne.VS)(Ne.LG)?(0,ae.jsx)(kn.AYg,{}):(0,ae.jsx)(Eh.A,{}),onClick:t=>{t.stopPropagation(),i(!0),g&&e.play(a)}}),(0,ae.jsxs)("div",{ref:e=>{p.current[a]=e,r&&n&&(n.current=e)},tabIndex:a,"data-testid":`phrase:${a}`,className:d.join(" "),style:null==c?void 0:c.phrase,onClick:f,children:[(0,Ne.VS)(Ne.Gs)&&(0,ae.jsx)(Pn.m_M,{title:o?"Label whole utterance":"Select a label first to enable labeling",placement:"top",children:(0,ae.jsx)("span",{className:wh.selectAllBtnWrapper,children:(0,ae.jsx)(Pn.$nd,{size:"small",look:"outlined",variant:"neutral",disabled:!o,className:wh.selectAllBtn,"aria-label":o?"Label whole utterance":"Label whole utterance (disabled)",onClick:t=>{o&&(null==e.selectAndAnnotatePhrase||e.selectAndAnnotatePhrase(a))},children:(0,ae.jsx)(kn.vEY,{})})})}),(0,Ne.VS)(Ne.LG)?(0,ae.jsxs)("span",{className:wh.titleWrapper,"data-skip-node":"true",children:[(0,ae.jsx)("span",{className:null==h?void 0:h.name,style:null==c?void 0:c.name,children:s[e.namekey]}),(0,ae.jsx)("span",{className:wh.time,children:(e=>{const t=e._value[a],{start:n,end:i}=v(t);return`${Kh(n)} - ${Kh(i)}`})(e)})]}):(0,ae.jsx)("span",{className:null==h?void 0:h.name,"data-skip-node":"true",style:null==c?void 0:c.name,children:s[e.namekey]}),(0,Ne.VS)(Ne.LG)?(0,ae.jsxs)("span",{className:wh.wrapperText,children:[r&&(0,ae.jsx)("span",{ref:x,className:`${wh.readingLine} reading-line`,"data-skip-node":"true"}),(0,ae.jsx)("span",{className:`${null==h?void 0:h.text}`,children:s[e.textkey]})]}):(0,ae.jsx)("span",{className:`${null==h?void 0:h.text}`,children:s[e.textkey]})]},`${e.name}-${a}`)]})})});var Oh=n(17872);const Lh={crossOrigin:"anonymous"},zh=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING),Bh=({item:e})=>(0,Ne.VS)(Ne.Gs)?(Vn("phrases:next-phrase",()=>{var t;null==(t=e._viewRef)||t.handleNextPhrase()}),Vn("phrases:previous-phrase",()=>{var t;null==(t=e._viewRef)||t.handlePreviousPhrase()}),Vn("phrases:select_all_annotate",()=>{e.selectAllAndAnnotateCurrentPhrase()}),Vn("phrases:next-region",()=>{var t;null==(t=e._viewRef)||t.handleNextRegion()}),Vn("phrases:previous-region",()=>{var t;null==(t=e._viewRef)||t.handlePreviousRegion()}),null):null,Fh=(0,b.PA)(({item:e})=>{const t=zh&&e.isBuffering,n=_h(e.audioRef,e.handleBuffering),i=(0,f.useCallback)(t=>{t&&(t=Qi(t)),e.audioRef instanceof Function?e.audioRef(t):e.audioRef&&(e.audioRef.current=t)},[e]);return(0,ae.jsxs)(ae.Fragment,{children:[t&&(0,ae.jsx)("div",{className:"lsf-timeline-controls__buffering","aria-label":"Buffering Media Source"}),(0,ae.jsx)("audio",Object.assign({},Lh,{controls:e.showplayer&&!e.syncedAudio,className:wh.audio,src:e.audio,ref:i,onLoadedMetadata:e.handleAudioLoaded,onEnded:e.reset,onError:e.handleError},zh?{onCanPlay:n,onWaiting:n}:{}))]})});class Hh extends f.Component{constructor(e){super(e),this._regionSpanSelector=".htx-highlight",this.mainContentSelector=`.${(0,Nn.cn)("main-content").toClassName()}`,this.mainViewAnnotationSelector=`.${(0,Nn.cn)("main-view").elem("annotation").toClassName()}`,this._selectRegions=e=>{const{item:t}=this.props,n=this.myRef.current,i=window.getSelection(),o=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT),s=[];for(;o.nextNode();){const e=o.currentNode;if("SPAN"===e.nodeName&&e.matches(this._regionSpanSelector)&&Qt(e)){const t=this._determineRegion(e);s.push(t)}}s.length&&(e?t.annotation.extendSelectionWith(s):t.annotation.selectAreas(s),i.removeAllRanges())},this.createAnnotationForPhrase=e=>{var t;const n=this.props.item,i=n._value;if(!i||e<0||e>=i.length)return;const o=n.layoutClasses,s=null==(t=this.myRef.current)?void 0:t.getElementsByClassName(o.text);if(!s)return;const a=s[e];if(!a)return;const r=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1),l=r.nextNode();if(!l)return;let c,d=l;for(;c=r.nextNode();)d=c;const u=document.createRange();u.setStart(l,0),u.setEnd(d,d.textContent.length);const h=window.getSelection();h.removeAllRanges(),h.addRange(u);const g=this.captureDocumentSelectionFromRange(u);g.length>0&&this.createAnnotationFromRanges(g)},this._handleScrollContainerHeight=()=>{requestAnimationFrame(()=>{var e,t;const n=this.myRef.current,i=document.querySelector(this.mainContentSelector),o=i.getBoundingClientRect(),s=document.documentElement.clientHeight-o.top,a=document.querySelector(this.mainViewAnnotationSelector),r=Math.floor(s<o.height?s:(null==i?void 0:i.offsetHeight)||0)-(((null==a?void 0:a.offsetHeight)||(null==(e=i.firstChild)?void 0:e.offsetHeight)||0)-((null==n?void 0:n.offsetHeight)||0))-(Number.parseInt(null==(t=window.getComputedStyle(i))?void 0:t.getPropertyValue("padding-bottom"))||0);n&&(this.myRef.current.style.maxHeight=`${r<100?100:r}px`)})},this._resizeObserver=new ResizeObserver(this._handleScrollContainerHeight),this.selectText=e=>{var t;const n=this.props.item,i=n._value,o=n.layoutClasses,s=null==(t=this.myRef.current)?void 0:t.getElementsByClassName(o.text);if(!i||e<0||e>=i.length||!s)return;const a=s[e];if(!a)return;const r=document.createRange();r.selectNodeContents(a);const l=window.getSelection();l.removeAllRanges(),l.addRange(r)},this.onScroll=()=>{this.state.inViewPort&&!this.isProgrammaticScroll&&this.setState({inViewPort:!1})},this.selectRegionsForPhrase=e=>{if(!(0,Ne.VS)(Ne.Gs))return;const t=this.props.item;if(!t||!t.annotation||!t.annotation.results)return;t.annotation.unselectAreas();const n=this.getRegionsForPhrase(e);n.length>0&&this.selectRegion(n[0])},this.handleNextPhrase=()=>{const e=this.props.item;e&&(e.goToNextPhrase(),this.selectRegionsForPhrase(e.playingId))},this.handlePreviousPhrase=()=>{const e=this.props.item;e&&(e.goToPreviousPhrase(),this.selectRegionsForPhrase(e.playingId))},this.handleSelectAllAndAnnotate=()=>{const e=this.props.item;e&&e.selectAllAndAnnotateCurrentPhrase()},this.getRegionsForPhrase=e=>{var t;if(!(0,Ne.VS)(Ne.Gs))return[];const n=this.props.item;if(!n||!n.annotation)return[];return((null==(t=n.annotation.regionStore)?void 0:t.regions)||n.annotation.regions).filter(t=>{const n=Number.parseInt(t.start,10),i=Number.parseInt(t.end,10);return!isNaN(n)&&!isNaN(i)&&n<=e&&i>=e})},this.selectRegion=e=>{if(!(0,Ne.VS)(Ne.Gs))return!1;return this.props.item.annotation.selectArea(e),!0},this.handleNextRegion=()=>{if(!(0,Ne.VS)(Ne.Gs))return;const e=this.props.item;if(!e||"number"!=typeof e.playingId||e.playingId<0)return;const t=this.getRegionsForPhrase(e.playingId);if(0===t.length)return;const n=e.annotation.selectedRegions||[];let i=-1;n.length>0&&(i=t.findIndex(e=>n.includes(e)));const o=(i+1)%t.length;e.annotation.unselectAll(),this.selectRegion(t[o])},this.handlePreviousRegion=()=>{if(!(0,Ne.VS)(Ne.Gs))return;const e=this.props.item;if(!e||"number"!=typeof e.playingId||e.playingId<0)return;const t=this.getRegionsForPhrase(e.playingId);if(0===t.length)return;const n=e.annotation.selectedRegions||[];let i=-1;n.length>0&&(i=t.findIndex(e=>n.includes(e)));const o=i<=0?t.length-1:i-1;e.annotation.unselectAll(),this.selectRegion(t[o])},this.myRef=f.createRef(),this.activeRef=f.createRef(),this.lastPlayingId=-1,this.scrollTimeout=[],this.isPlaying=!1,this.isProgrammaticScroll=!1,this.state={canScroll:!0,inViewPort:!0}}performProgrammaticScroll(e){this.isProgrammaticScroll=!0,this.myRef.current.scrollTo({top:Math.max(0,e),behavior:"smooth"}),setTimeout(()=>{this.isProgrammaticScroll=!1},Hh.SCROLL_FLAG_TIMEOUT)}shouldScroll(){return(0,Ne.VS)(Ne.LG)&&this.props.item.contextscroll&&this.props.item.playingId>=0&&this.lastPlayingId!==this.props.item.playingId&&this.state.canScroll&&this.state.inViewPort}getContainerPadding(){var e;return Number.parseInt(null==(e=window.getComputedStyle(this.myRef.current))?void 0:e.getPropertyValue("padding-top"))||0}calculatePhraseScrollPosition(e){const t=this.myRef.current,n=t.querySelector(`[data-testid="phrase:${e}"]`);if(!n)return 0;const i=n.getBoundingClientRect(),o=t.getBoundingClientRect();return i.top-o.top+t.scrollTop}handleTallPhraseScroll(e,t){var n,i,o;const s=this.getContainerPadding(),a=(null==(n=this.activeRef.current)?void 0:n.offsetTop)-s,r=Math.ceil((null==(i=this.activeRef.current)?void 0:i.offsetHeight)/(null==(o=this.myRef.current)?void 0:o.offsetHeight))+1;for(let n=0;n<r;n++)this.scrollTimeout.push(setTimeout(()=>{const t=a+e*(n*(1/r));this.state.inViewPort&&this.state.canScroll&&this.performProgrammaticScroll(t)},t/r*n*1e3))}handleNormalPhraseScroll(){if(this.state.inViewPort)if(this.props.item.playingId<=0)this.performProgrammaticScroll(this.getContainerPadding());else{const e=this.calculatePhraseScrollPosition(this.props.item.playingId);this.performProgrammaticScroll(e)}}getSelectionText(e){return e.toString()}getPhraseElement(e){const t=this.props.item.layoutClasses;for(;e&&(!e.classList||!e.classList.contains(t.text));)e=e.parentNode;return e}get phraseElements(){return[...this.myRef.current.getElementsByClassName(this.props.item.layoutClasses.text)]}getOffsetInPhraseElement(e,t,n=!0){const i=this.getPhraseElement(e),o=document.createRange();o.setStart(i,0),o.setEnd(e,t);const s=o.toString().length,a=this.phraseElements.indexOf(i);let r=i;return n&&s===r.textContent.length?[0,r,a+1,a]:n||0!==s?[s,r,a,a]:(r=this.phraseElements[a-1],[r.textContent.length,r,a-1,a])}removeSurroundingNewlines(e){return e.replace(/^\n+/,"").replace(/\n+$/,"")}captureDocumentSelection(){const e=this.props.item,t=e.layoutClasses,n=[...this.myRef.current.getElementsByClassName(t.name)];let i;n.forEach(e=>{e.style.visibility="hidden"});const o=[],s=window.getSelection();if(s.isCollapsed)return n.forEach(e=>{e.style.visibility="unset"}),[];for(i=0;i<s.rangeCount;i++){const t=s.getRangeAt(i);if(t.endContainer.nodeType!==Node.TEXT_NODE){let e=this.getPhraseElement(t.endContainer.lastChild);for(;e&&e.nodeType!==Node.TEXT_NODE;)e=e.firstChild;if(!e)continue;t.setEnd(e,0)}if(!t.collapsed&&!/^\s*$/.test(t.toString()))try{(0,fe.splitBoundaries)(t);const[n,,i,a]=this.getOffsetInPhraseElement(t.startContainer,t.startOffset),[r,,l,c]=this.getOffsetInPhraseElement(t.endContainer,t.endOffset,!1),d=Math.min(l,c);if((0,Ne.VS)(Ne.Gd)){const c=e._value.reduce((t,n,i)=>(e.isVisibleForAuthorFilter(n)&&a<=i&&d>=i&&t.push(i),t),[]);if(c.length!==d-a+1){const e=this.phraseElements;let d=a;for(let u=0;u<c.length;u++){const h=c[u];if(u===c.length-1||c[u+1]!==h+1){let g,m;const p=t.cloneRange();if(d===a)d=i,g=n;else{g=0;const t=e[d].ownerDocument.createTreeWalker(e[d],NodeFilter.SHOW_ALL);for(;t.firstChild(););p.setStart(t.currentNode,g)}if(h===l)m=r;else{const t=document.createRange();t.selectNode(e[h]),m=t.toString().length;const n=e[h].ownerDocument.createTreeWalker(e[h],NodeFilter.SHOW_ALL);for(;n.lastChild(););p.setEnd(n.currentNode,n.currentNode.length)}s.removeAllRanges(),s.addRange(p);const f=this.removeSurroundingNewlines(s.toString());f&&o.push({startOffset:g,start:String(d),endOffset:m,end:String(h),_range:p,text:f}),c.length-1>u&&(d=c[u+1])}}}else o.push({startOffset:n,start:String(i),endOffset:r,end:String(l),_range:t,text:this.removeSurroundingNewlines(s.toString())})}else o.push({startOffset:n,start:String(i),endOffset:r,end:String(l),_range:t,text:this.removeSurroundingNewlines(s.toString())})}catch(e){console.error("Can not get selection",e)}}return n.forEach(e=>{e.style.visibility="unset"}),s.removeAllRanges(),o}_determineRegion(e){if((0,fe.matchesSelector)(e,this._regionSpanSelector)){const t="SPAN"===e.tagName?e:e.closest(this._regionSpanSelector),{item:n}=this.props;return n.regs.find(e=>e.find(t))}}_disposeTimeout(){this.scrollTimeout.length>0&&(this.scrollTimeout.forEach(e=>clearTimeout(e)),this.scrollTimeout=[])}captureDocumentSelectionFromRange(e){const t=window.getSelection();t.removeAllRanges(),t.addRange(e);return this.captureDocumentSelection()}isDuplicateRegion(e,t,n){if(!(0,Ne.VS)(Ne.Gs))return!1;const i=Number.parseInt(e.start,10),o=Number.parseInt(e.end,10),s=e.startOffset||0,a=e.endOffset||0;return this.props.item.regs.filter(e=>{var n;const r=Number.parseInt(e.start,10),l=Number.parseInt(e.end,10),c=e.startOffset||0,d=e.endOffset||0;if(r!==i||l!==o||c!==s||d!==a)return!1;const u=null==(n=e.results)?void 0:n.find(e=>{var t;return null==(t=e.from_name)?void 0:t.isLabeling}),h=(null==u?void 0:u.mainValue)||[];return t.length===h.length&&t.every(e=>h.includes(e))}).length>0}createAnnotationFromRanges(e){const t=this.props.item;if(e&&e.length>0){const n=t.activeStates&&t.activeStates();if(n&&n.length>0){const t=n[0],i=t.selectedValues()||[];for(const n of e)if(this.isDuplicateRegion(n,i,t))return}}t._currentSpan=null;let n=null;const i=t.activeStates&&t.activeStates();if(i&&0!==i.length||console.warn("No label selected. Annotation will not be created."),(0,Ne.VS)(Ne.Gd)){const i=t.addRegions(e);if(i&&i.length>0){n=i[0];for(const e of i){const t=e.createSpans();e.addEventsToSpans(t)}}}else if(n=t.addRegion(e[0]),n){const e=n.createSpans();n.addEventsToSpans(e)}}onMouseUp(e){const t=this.props.item,n=t.activeStates();if(!n||0===n.length||e.ctrlKey||e.metaKey)return this._selectRegions(e.ctrlKey||e.metaKey);if(t.annotation.isReadOnly())return;const i=this.captureDocumentSelection();if(0===i.length)return;t._currentSpan=null;let o=null;if((0,Ne.VS)(Ne.Gd)){const e=t.addRegions(i);e&&e.length>0&&(o=e[0]);for(const t of e){const e=t.createSpans();t.addEventsToSpans(e)}}else if(o=t.addRegion(i[0]),o){const e=o.createSpans();o.addEventsToSpans(e)}}_getResultText(e,t,n,i){const o=this.phraseElements;return e===t?o[e].innerText.slice(n,i):[o[e].innerText.slice(n),o.slice(e+1,t).map(e=>e.innerText),o[t].innerText.slice(0,i)].flat().join("")}_handleUpdate(){const e=this.myRef.current,{item:t}=this.props;if(t._value&&(t.regs.forEach((n,i)=>{var o;if(null==(o=n._spans)||null==(o=o[0])||!o.isConnected)try{const o=e.children,s=document.createRange(),a=o[n.start].getElementsByClassName(t.layoutClasses.text)[0],r=o[n.end].getElementsByClassName(t.layoutClasses.text)[0];let{startOffset:l,endOffset:c}=n;if(s.setStart(...(0,fe.findNodeAt)(a,l)),s.setEnd(...(0,fe.findNodeAt)(r,c)),n.text&&s.toString().replace(/\s+/g,"")!==n.text.replace(/\s+/g,"")){if(console.info("Restore broken position",i,s.toString(),"->",n.text,n),t.regs.slice(0,i).some(e=>n.start===e.end)&&n.start===n.end){const e=a.textContent.match(new RegExp(n.text.replace(/\s+/g,"\\s+")));e||console.warn("Can't find the text",n);const{index:t=0}=e||{};n.endOffset-n.startOffset!==n.text.length&&console.warn("Text length differs from region length; possible regions overlap"),l=t,c=l+n.text.length,s.setStart(...(0,fe.findNodeAt)(a,l)),s.setEnd(...(0,fe.findNodeAt)(r,c)),n.fixOffsets(l,c)}}else!n.text&&s.toString()&&n.setText(this._getResultText(+n.start,+n.end,l,c));(0,fe.splitBoundaries)(s),n._range=s;const d=n.createSpans();n.addEventsToSpans(d)}catch(e){console.log(e,n)}}),Array.from(this.myRef.current.getElementsByTagName("a")).forEach(e=>{e.addEventListener("click",e=>(e.preventDefault(),!1))}),this.shouldScroll())){var n;const t=this.props.item._value[this.props.item.playingId],i=(null==(n=this.activeRef.current)?void 0:n.offsetHeight)||0,o=t.duration||t.end-t.start,s=e.offsetHeight;this._disposeTimeout(),i>s?this.handleTallPhraseScroll(i,o):this.handleNormalPhraseScroll(),this.lastPlayingId=this.props.item.playingId}}componentDidUpdate(){this._handleUpdate()}componentDidMount(){(0,Ne.VS)(Ne.LG)&&this.props.item.contextscroll&&this._resizeObserver.observe(document.querySelector(this.mainContentSelector)),this._handleUpdate();const{item:e}=this.props;!e.audio&&e._value&&e._value.length>0&&-1===e.playingId&&e.seekToPhrase(0),(0,Ne.VS)(Ne.Gs)&&e.setViewRef(this)}componentWillUnmount(){var e,t;const n=document.querySelector(this.mainContentSelector);n&&(null==(e=this._resizeObserver)||e.unobserve(n)),null==(t=this._resizeObserver)||t.disconnect(),(0,Ne.VS)(Ne.Gs)&&this.props.item.setViewRef(null)}get hasSelectedLabels(){if(!(0,Ne.VS)(Ne.Gs))return!1;try{const{item:e}=this.props,t=e.activeStates&&e.activeStates();return!!(t&&t.length>0)}catch(e){return console.warn("Error checking selected labels:",e),!1}}setIsInViewPort(e){this.setState({inViewPort:e})}renderWrapperHeader(){const{item:e}=this.props;return(0,ae.jsxs)("div",{className:wh.wrapper_header,children:[(0,Ne.VS)(Ne.fw)&&(0,ae.jsx)(Ih,{item:e,onChange:()=>{this.setState({canScroll:!this.state.canScroll})}}),e.contextscroll&&(0,ae.jsxs)("div",{className:wh.wrapper_header__buttons,children:[(0,ae.jsx)(Pn.lMk,{"data-testid":"auto-scroll-toggle",checked:this.state.canScroll,onChange:()=>{this.setState({canScroll:!this.state.canScroll})},label:"Auto-scroll"}),(0,ae.jsx)(Pn.m_M,{alignment:"top-left",title:"Automatically sync transcript scrolling with audio playback",children:(0,ae.jsx)(kn.Lwz,{})})]})]})}render(){const{item:e}=this.props,t=!!e.audio,n=(0,Ne.VS)(Ne.LG)&&this.props.item.contextscroll;return!e.playing&&(0,Ne.VS)(Ne.LG)&&this._disposeTimeout(),(0,Ne.VS)(Ne.fw)&&!e._value?null:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Bh,{item:e}),(0,ae.jsxs)(Es,{item:e,className:(0,Oh.T)((0,Nn.cn)("paragraphs").toClassName(),wh.paragraphs),children:[t&&(0,ae.jsx)(Fh,{item:e}),(0,Ne.VS)(Ne.LG)?this.renderWrapperHeader():(0,Ne.VS)(Ne.fw)&&(0,ae.jsx)(Ih,{item:e}),(0,ae.jsx)("div",{ref:this.myRef,"data-testid":"phrases-wrapper","data-update":e._update,className:n?wh.scroll_container:wh.container,onMouseUp:this.onMouseUp.bind(this),onScroll:this.onScroll.bind(this),children:(0,ae.jsx)(Dh,Object.assign({setIsInViewPort:this.setIsInViewPort.bind(this),item:e,playingId:e.playingId,hasSelectedLabels:this.hasSelectedLabels},(0,Ne.VS)(Ne.LG)?{activeRef:this.activeRef}:{}))})]})]})}}Hh.SCROLL_FLAG_TIMEOUT=100;const Vh=(0,b.WQ)("store")((0,b.PA)(Hh));we.addTag("paragraphs",Th,Vh),we.addObjectType(Th);const $h=u.gK.model({type:"pdf",value:u.gK.maybeNull(u.gK.string),_url:u.gK.maybeNull(u.gK.string)}).actions(e=>({updateValue(t){e._url=Oe(e.value,t.task.dataObj)}})),Wh=u.gK.compose("PdfModel",gn,Fe,Te,$h),Uh=(0,b.WQ)("store")((0,b.PA)(({item:e})=>e._url?(0,ae.jsx)("embed",{src:e._url,style:{width:"100%",height:"600px",border:"none"},type:"application/pdf"}):null));we.models.pdf||(we.addTag("pdf",Wh,Uh),we.addObjectType(Wh));var Gh=n(6847);const Yh="htx-highlight",Xh="htx-no-label",qh=u.gK.model().volatile(()=>({_spans:null})).views(e=>({get _hasSpans(){return!!e._spans&&e._spans.every(e=>e.isConnected)},get identifier(){return`${e.id.split("#")[0]}-${e.ouid}`},get className(){return`${Yh}-${e.identifier}`},get classNames(){var t;const n=[Yh,e.className];return(null!=(t=e.parent.showlabels)?t:e.store.settings.showLabels)||n.push(Xh),e.selected&&n.push(Zh.active),(0,E.isDefined)(e.parent.showlabels)&&n.push("htx-manual-label"),n},generateStyles:(e,t,n=!1)=>`\n        .${e} {\n          background-color: ${t.background} !important;\n          border: 1px dashed transparent;\n        }\n        .${e}.${Zh.active}:not(.${Zh.hidden}) {\n          color: ${t.activeText} !important;\n          background-color: ${n?t.resizeBackground:t.activeBackground} !important;\n        }\n      `,get styles(){return this.generateStyles(e.className,e.getColors())},get resizeStyles(){return this.generateStyles(e.className,e.getColors(),!0)}})).actions(e=>({applyHighlight(t=!1){var n;e._hasSpans||(e._spans=e.parent.createSpansByGlobalOffsets(e.globalOffsets),null==(n=e._spans)||n.forEach(t=>t.className=e.classNames.join(" ")),e.updateSpans(),t||e.parent.setStyles({[e.identifier]:e.styles}))},updateHighlightedText({force:t=!1}={}){e.text&&!t||(e.text=e.parent.getTextFromGlobalOffsets(e.globalOffsets))},updateSpans(){var t;if(e._hasSpans||null!=(t=e._spans)&&t.length){const t=e._spans[0],n=e._spans.at(-1),i=e.globalOffsets;en.Selection.applySpanStyles(n,{index:e.region_index,label:e.getLabels()}),t.setAttribute("data-start",i.start),n.setAttribute("data-end",i.end)}},clearSpans(){e._spans=null},removeHighlight(){var t,n;e.globalOffsets&&(null==(n=e.parent)||n.removeSpansInGlobalOffsets(e._spans,e.globalOffsets));null==(t=e.parent)||t.removeStyles([e.identifier]),e._spans=null},updateAppearenceFromState(){var t,n;if(null==(t=e._spans)||!t.length)return;const i=(0,u.Zn)(e).settings,o=e._spans[e._spans.length-1];var s;o&&(null!=(s=e.parent)&&s.showlabels||null!=i&&i.showLabels?o.classList.remove("htx-no-label"):o.classList.add("htx-no-label"));if(null!=(n=e.parent)&&n.canResizeSpans){const t=e._spans[0].getAttribute("data-start"),n=e._spans.at(-1).getAttribute("data-end"),i=e.globalOffsets;!(0,E.isDefined)(t)||+t===i.start&&+n===i.end?(null==e.parent.setStyles||e.parent.setStyles({[e.identifier]:e.styles}),e.updateSpans()):(e.removeHighlight(),e.applyHighlight())}else null==e.parent.setStyles||e.parent.setStyles({[e.identifier]:e.styles}),e.updateSpans()},attachHandles(){const t=[Zh.leftHandle,Zh.rightHandle],n=e._spans[0],i=e._spans.at(-1);t.forEach((e,t)=>{const o=document.createElement("area");o.classList.add(e),0===t?n.prepend(o):i.append(o)})},detachHandles(){var t;null==(t=e._spans)||t.forEach(e=>e.querySelectorAll("area").forEach(e=>e.remove()))},selectRegion(){var t,n;e.annotation.setHighlightedNode(e),e.addClass(Zh.active);const i=null==(t=e._spans)?void 0:t[0];i&&(null!=(n=e.parent)&&n.canResizeSpans&&e.attachHandles(),i.scrollIntoViewIfNeeded?i.scrollIntoViewIfNeeded():i.scrollIntoView({block:"center",behavior:"smooth"}))},afterUnselectRegion(){var t;e.removeClass(Zh.active),null!=(t=e.parent)&&t.canResizeSpans&&e.detachHandles()},beforeDestroy(){var t;null==(t=e.parent)||t.removeStyles([e.identifier])},setHighlight(t){e._spans&&(e._highlighted=t,e.highlighted?e.addClass(Zh.highlighted):e.removeClass(Zh.highlighted))},getLabels(){var t,n;return[e.region_index,(null!=(t=null==(n=e.labeling)?void 0:n.selectedLabels)?t:[]).map(e=>e.value).join(",")].filter(Boolean).join(":")},getColors(){const t=e.parent.highlightcolor||(e.style||e.tag||w.l).fillcolor,n=en.Colors.convertToRGBA(null!=t?t:w.A.LABEL_BACKGROUND,.3),i=en.Colors.convertToRGBA(null!=t?t:w.A.LABEL_BACKGROUND,.8);return{background:n,activeBackground:i,resizeBackground:en.Colors.convertToRGBA(null!=t?t:w.A.LABEL_BACKGROUND,1.6-1),activeText:en.Colors.contrastColor(i)}},find:t=>e._spans&&e._spans.indexOf(t)>=0?e:void 0,addClass(t){if(!t||!e._spans)return;const n=[].concat(t);e._spans.forEach(e=>e.classList.add(...n))},removeClass(t){if(!t||!e._spans)return;const n=[].concat(t);e._spans.forEach(e=>e.classList.remove(...n))},toggleHidden(t){e.hidden=!e.hidden,e.hidden?e.addClass("__hidden"):e.removeClass("__hidden"),null==t||t.stopPropagation()}})),Zh={active:"__active",highlighted:"__highlighted",collapsed:"__collapsed",hidden:"__hidden",rightHandle:"__resize_right",leftHandle:"__resize_left",noLabel:Xh};class Jh{constructor(e,t,n,i,o){this.node=void 0,this.start=void 0,this.end=void 0,this.content=void 0,this.path=void 0,this.node=e,this.start=t,this.end=n,this.content=i,this.path=o}getContent(e,t){return this.content.slice(Math.max(e-this.start,0),Math.min(t-this.start,this.end))}get text(){return this.content.join("")}getText(e,t){return this.getContent(e,t).join("")}createSubtext(e,t){e=Math.max(this.start,e),t=Math.min(this.end,t);const{node:n}=this,i=n.cloneNode(),o=this.getContent(e,t);return i.textContent&&(i.textContent=[...i.textContent].slice(e-this.start,t-this.start).join("")),new Jh(i,e,t,o)}wrapWithSpan(){const{node:e,start:t,end:n}=this,i=e.ownerDocument,o=e.parentNode,s=i.createTextNode(""),a=i.createElement("span");null==o||o.replaceChild(s,e),a.appendChild(e),null==o||o.replaceChild(a,s);const r=new eg(a,t,n);return r.children.push(this),r}createSpanElements(e,t){const{node:n}=this,i=n.ownerDocument,o=n.parentNode,s=i.createDocumentFragment(),a=i.createTextNode(""),r=[];e>this.start&&r.push(this.createSubtext(this.start,e));const l=this.createSubtext(e,t).wrapWithSpan();return r.push(l),t<this.end&&r.push(this.createSubtext(t,this.end)),r.forEach(e=>{s.appendChild(e.node)}),o.replaceChild(a,n),o.replaceChild(s,a),r}removeNode(){const{node:e}=this;e.parentNode.removeChild(e)}mergeWith(e){this.node.data+=e.map(e=>e.node.data).join(""),this.end=e[e.length-1].end,this.content.push(...e.flatMap(e=>e.content))}}class Qh{constructor(e,t=e){this.start=void 0,this.end=void 0,this.children=[],this.start=e,this.end=t}findTextElement(e,t="start"){const n=this.children.find(n=>n.start<=e&&n.end>=e&&n[t]!==e);return n instanceof eg?n.findTextElement(e,t):n instanceof Jh?n:void 0}findElementByNode(e){for(const t of this.children){if(t.node===e)return t;if(t instanceof eg){const n=t.findElementByNode(e);if(n)return n}}}getText(e,t){const n=[];return this.children.forEach(i=>{i.end>e&&i.start<t&&n.push(i.getText(e,t))}),n.join("")}wrapElementsWithSpan(e){const t=e[0],n=e[e.length-1],{node:i}=t,o=i.ownerDocument,s=i.parentNode,a=o.createTextNode(""),r=o.createElement("span");s.replaceChild(a,t.node),e.forEach(e=>{r.appendChild(e.node)}),s.replaceChild(r,a);const l=new eg(r,t.start,n.end);return l.children.push(...e),l}createSpans(e,t){const n=[],i=[];let o=[];for(const s of this.children){const a=s instanceof Jh;if(s.start>=e&&s.end<=t)o.push(s);else{if(o.length){const e=this.wrapElementsWithSpan(o);i.push(e),n.push(e.node),o=[]}if(e>=s.start&&e<s.end||t>s.start&&t<=s.end)if(a){const o=s.createSpanElements(e,t);i.push(...o),n.push(...o.filter(e=>e instanceof eg).map(e=>e.node))}else i.push(s),n.push(...s.createSpans(e,t));else i.push(s)}}if(o.length){const e=this.wrapElementsWithSpan(o);i.push(e),n.push(e.node)}return this.children=i,n}removeSpans(e){for(let t=this.children.length-1;t>=0;t--){const n=this.children[t];n instanceof eg&&(e.includes(n.node)?(n.removeNode(),this.children.splice(t,1,...n.children)):n.removeSpans(e))}let t=[];const n=[],i=()=>{if(t.length>0){const e=t[0];if(t.length>1){const n=t.slice(1);e.mergeWith(n),n.forEach(e=>e.removeNode())}n.push(e),t=[]}};for(const e of this.children)e instanceof Jh&&(0===t.length||t[t.length-1].node.nextSibling===e.node)?t.push(e):(i(),n.push(e));i(),this.children=n}}class eg extends Qh{constructor(e,t,n){super(t,n),this.node=void 0,this.node=e}removeNode(){const{node:e}=this,t=e.ownerDocument,n=e.parentNode,i=t.createDocumentFragment();for(;e.firstChild;)i.appendChild(e.firstChild);n.replaceChild(i,e)}}class tg extends Qh{constructor(e,t){super(e),this.path=void 0,this.content=[],this.path=t}addTextNode(e,t,n,i,o){this.content=i,this.children.push(new Jh(e,t,n,i,o)),this.end=n}getRelativeOffsetByGlobal(e){return this.content.slice(0,e-this.start).map(e=>""===e?" ":e).join("").length}getGlobalOffsetByRelative(e){let t=e;const n=0===e?0:1+this.content.findIndex(e=>(""===e?t--:t-=e.length,t<=0));return this.start+n}}class ng{constructor(e,t,n){this.node=void 0,this.start=void 0,this.path=void 0,this.node=e,this.start=t,this.path=n}getText(){return""}}class ig{constructor(){this.elements=[],this.endPos=void 0,this.displayedText="",this.displayedTextPos=0,this.endPos=0}createDynamicBlock(e){const{endPos:t}=this,n=new tg(t,e);return this.elements.push(n),n}setDisplayedText(e){this.displayedText=e}addStaticElement(e,t){this.elements.push(new ng(e,this.endPos,t.toString()))}addExtraText(e){let t=this.elements.length-1;for(;!(this.elements[t]instanceof tg)&&t>-1;)--t;this.elements.splice(t+1,0,function(e){return e.replace(/[\n\r]/g,"\\n")}(e))}findProjectionOnDisplayedText(e){const{displayedText:t}=this;let n=this.displayedTextPos;const i=[];for(;"\n"===t[n]||"\r"===t[n];)n++;let o=n;for(const n of e){const e=t.substring(o,o+n.length);e===n||" "===e&&"\n"===n?(i.push(e),o+=n.length):i.push("")}return{fromIdx:n,toIdx:o,content:i.flatMap(e=>e?[...e]:e)}}addTextElement(e,t){const{displayedText:n}=this,i=e.textContent;let o=n.indexOf(i,this.displayedTextPos),s=[...i];const a=s.length;let r=i.length;if(-1===o||o-this.displayedTextPos>1){const{fromIdx:e,toIdx:t,content:n}=this.findProjectionOnDisplayedText(i);o=e,r=t-e,s=n}o!==this.displayedTextPos&&(this.addExtraText(this.displayedText.substring(this.displayedTextPos,o)),this.displayedTextPos=o);this.createDynamicBlock(t.toString()).addTextNode(e,this.endPos,this.endPos+a,s,t.toString()),this.endPos+=a,this.displayedTextPos+=r}addBR(){this.endPos+=1}findTextElement(e,t="start"){var n;return null==(n=this.findTextBlock(e,t))?void 0:n.findTextElement(e,t)}findElementByPath(e){for(const t of this.elements)if("string"!=typeof t&&t.path===e)return t}getNextElement(e){let t=this.elements.indexOf(e);for(;!(this.elements[t+1]instanceof ng||this.elements[t+1]instanceof tg);)if(t++,t>=this.elements.length-1)return;return this.elements[t+1]}getEndOf(e){if(e instanceof eg||e instanceof Jh)return e.end;const t=this.getNextElement(e);return t?t.start:this.endPos}findElementByNode(e){for(const t of this.elements)if(t instanceof ng){if(t.node===e)return t}else if(t instanceof tg){const n=t.findElementByNode(e);if(n)return n}}findTextBlock(e,t="start"){const n=this.elements.find(n=>n instanceof tg&&n.start<=e&&n.end>=e&&n[t]!==e);return(0,E.isDefined)(n),n}indexOfTextBlock(e,t="start"){return this.elements.findIndex(n=>n instanceof tg&&n.start<=e&&n.end>=e&&n[t]!==e)}getText(e,t){const n=this.indexOfTextBlock(e,"end"),i=this.indexOfTextBlock(t,"start");return this.elements.slice(n,i+1).map(n=>"string"!=typeof n?n.getText(e,t):n).join("")}collectBlocks(e,t){const n=this.indexOfTextBlock(e,"end"),i=Math.max(this.indexOfTextBlock(t,"start"),n);return this.elements.slice(n,i+1).filter(e=>e instanceof tg)}createSpans(e,t){t<e&&(t=e);const n=this.collectBlocks(e,t);return(0,E.flatten)(n.map(n=>n.createSpans(e,t)))}removeSpans(e,t,n){const i=this.collectBlocks(t,n);for(const t of i)t.removeSpans(e)}destroy(){this.elements=[]}}class og{constructor(){this.segments=[],this.counters=[]}get currentSegment(){return this.segments[this.segments.length-1]}get currentCounters(){return this.counters[this.counters.length-1]}getSegmentName(e){return e.nodeType===Node.TEXT_NODE?"text()":e.nodeName.toLowerCase()}into(e){const t=this.getSegmentName(e);this.segments.push([t,1]),this.counters.push({[t]:1})}next(e){const t=this.getSegmentName(e);this.currentCounters[t]||(this.currentCounters[t]=0),this.currentSegment[0]=t,this.currentSegment[1]=++this.currentCounters[t]}outOf(){this.segments.pop(),this.counters.pop()}toString(){return`/${this.segments.map(e=>`${e[0]}[${e[1]}]`).join("/")}`}}class sg{constructor(e){if(this.container=void 0,this.root=void 0,this.doc=void 0,this.view=void 0,this.domData=void 0,this.fragment=void 0,this.styleTags=void 0,this.walker=null,this.currentPath=new og,this.container=e,e instanceof HTMLIFrameElement){const e=this.container.contentDocument;this.root=e.body}else this.root=e;this.doc=this.root.ownerDocument,this.view=this.doc.defaultView,this.domData=new ig,this.fragment=document.createDocumentFragment(),this.styleTags={},this.initDataMap()}nextStep(e=!1){const t=this.walker,n=this.currentPath;let i;return!e&&(i=t.firstChild(),i)?(n.into(i),i):(i=t.nextSibling(),i?(n.next(i),i):(i=t.parentNode(),n.outOf(),i?this.nextStep(!0):i))}initDataMap(){const{doc:e,root:t,domData:n}=this,i=this.walker=e.createTreeWalker(t,NodeFilter.SHOW_ALL);let o;for(this.currentPath=new og,o=i.currentNode,n.setDisplayedText(this.collectText());o;){const e=o.nodeType===Node.TEXT_NODE,t="BR"===o.nodeName;e?n.addTextElement(o,this.currentPath):t?n.addBR():n.addStaticElement(o,this.currentPath),o=this.nextStep()}this.walker=null}collectText(){const{root:e,view:t}=this,n=t.getSelection(),i=new Range,o=[];if(!n)return"";for(let e=0;e<n.rangeCount;e++)o.push(n.getRangeAt(e));i.setStartBefore(e),i.setEndAfter(e),n.removeAllRanges(),n.addRange(i);const s=String(n);n.removeAllRanges();for(const e of o)n.addRange(e);if(document.activeElement){const e=document.activeElement;null==e.blur||e.blur(),null==e.focus||e.focus()}return s}createRange(e,t){const n=this.domData.findTextElement(e,"end"),i=this.domData.findTextElement(t,"start");if(n&&i){const{doc:o}=this,s=o.createRange();return s.setStart(n.node,e-n.start),s.setEnd(i.node,t-i.start),s}}relativeOffsetsToGlobalOffsets(e,t,n,i){let o=this.domData.findElementByPath(e),s=this.domData.findElementByPath(n);if(o&&s)return o instanceof tg||(o=this.domData.findTextBlock(o.start,"end")),s instanceof tg||(s=this.domData.findTextBlock(s.start,"end")),[o.getGlobalOffsetByRelative(t),s.getGlobalOffsetByRelative(i)]}globalOffsetsToRelativeOffsets(e,t){const n=this.domData.findTextBlock(e,"end"),i=this.domData.findTextBlock(t,"start");if(n&&i)return{start:n.path,startOffset:n.getRelativeOffsetByGlobal(e),end:i.path,endOffset:i.getRelativeOffsetByGlobal(t)}}rangeToGlobalOffset(e){const t=this.domData.findElementByNode(e.startContainer),n=this.domData.findElementByNode(e.endContainer);if(!t||!n)return;const i=this.domData.findTextBlock(t.start,"end"),o=this.domData.findTextBlock(n.start,"end");return[i.getGlobalOffsetByRelative(e.startOffset),o.getGlobalOffsetByRelative(e.endOffset)]}getText(e,t){return this.domData.getText(e,t)}createSpans(e,t){return this.domData.createSpans(e,t)}removeSpans(e,t,n){return this.domData.removeSpans(e,t,n)}setStyles(e){const{styleTags:t}=this;for(const[n,i]of Object.entries(e)){let e=t[n];e||(t[n]=e=this.doc.createElement("style"),e.id=`highlight-${n}`,this.doc.head.appendChild(e)),e.textContent=i}}removeStyles(e){const{styleTags:t}=this;Array.isArray(e)||(e=[e]);for(const n of e){const e=t[n];e&&(this.doc.head.removeChild(e),delete t[n])}}destroy(){this.removeStyles(Object.keys(this.styleTags)),this.domData.destroy(),this.domData=new ig}}const ag=()=>"Do not put text directly in task data if you use valueType=url.",rg=e=>`URL (${(0,E.escapeHtml)(e)}) is not valid.`,lg=()=>'In SECURE MODE valueType is set to "url" by default.',cg=u.gK.model("RichTextModel",{value:u.gK.maybeNull(u.gK.string),valuetype:u.gK.optional(u.gK.enumeration(["text","url"]),()=>window.LS_SECURE_MODE?"url":"text"),inline:!1,savetextresult:u.gK.optional(u.gK.enumeration(["none","no","yes"]),()=>window.LS_SECURE_MODE?"no":"none"),selectionenabled:u.gK.optional(u.gK.boolean,!0),clickablelinks:!1,highlightcolor:u.gK.maybeNull(Ce.color),showlabels:u.gK.maybeNull(u.gK.boolean),encoding:u.gK.optional(u.gK.enumeration(["none","base64","base64unicode"]),"none"),granularity:u.gK.optional(u.gK.enumeration(["symbol","word","sentence","paragraph"]),"symbol")}),dg=u.gK.model("RichTextModel",{type:"richtext",_value:u.gK.optional(u.gK.maybeNull(u.gK.string),null)}).views(e=>({get canResizeSpans(){return Gh.isActive(Gh.FF_ADJUSTABLE_SPANS)&&"text"===e.type&&!e.isReadOnly()},get hasStates(){const t=e.states();return t&&t.length>0},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t?t.filter(e=>e.isLabeling&&e.isSelected):null},get isLoaded(){var t;return e._isLoaded&&e._loadedForAnnotation===(null==(t=e.annotation)?void 0:t.id)},get isReady(){return e.isLoaded&&e._isReady},get styles(){return`\n      .htx-highlight {\n        cursor: pointer;\n        border: 1px dashed transparent;\n      }\n      .htx-highlight[data-index]::after,\n      .htx-highlight[data-label]::after {\n        padding: 2px 2px;\n        font-size: 9.5px;\n        font-weight: bold;\n        font-family: var(--font-mono);\n        vertical-align: super;\n        content: attr(data-label);\n        line-height: 0;\n      }\n      .htx-highlight[data-index]:not([data-label])::after {\n        content: attr(data-index);\n      }\n      .htx-highlight.${Zh.highlighted} {\n        position: relative;\n        cursor: ${w.A.LINKING_MODE_CURSOR};\n        border-color: rgb(0, 174, 255);\n      }\n      .htx-highlight.${Zh.hidden} {\n        border: none;\n        padding: 0;\n        background: transparent !important;\n        cursor: inherit;\n        // pointer-events: none;\n      }\n      .htx-highlight.${Zh.hidden}::before,\n      .htx-highlight.${Zh.hidden}::after,\n      .htx-highlight.${Zh.noLabel}::after {\n        display: none;\n      }\n      `},getIframeBodyNode(){var t;const n=e.mountNodeRef.current;return null==n||null==(t=n.contentDocument)?void 0:t.body},getRootNode(){var t;return null!=(t=e.getIframeBodyNode())?t:e.mountNodeRef.current}})).volatile(()=>({mountNodeRef:(0,f.createRef)(),_isReady:!1,_isLoaded:!1,_loadedForAnnotation:null})).actions(e=>{let t;return{setLoaded(t=!0){var n;t&&e.onLoaded(),e._isLoaded=t,e._loadedForAnnotation=null==(n=e.annotation)?void 0:n.id},onLoaded(){e.mountNodeRef.current&&(t=new sg(e.mountNodeRef.current))},onDispose(){e.regs.forEach(e=>{e.clearSpans()})},updateValue:(0,u.L3)(function*(t){const n=Oe(e.value,t.task.dataObj),i=yield e.resolveValue(n);if("url"===e.valuetype){const t=i;if(!(0,E.isValidObjectURL)(t,!0)){const n=[rg(t),ag()];return window.LS_SECURE_MODE&&n.unshift(lg()),e.annotationStore.addErrors([Os.generalError(n.join("<br/>\n"))]),void e.setRemoteValue("")}try{const n=yield fetch(t),{ok:i,status:o,statusText:s}=n;if(!i)throw new Error(`${o} ${s}`);e.setRemoteValue(yield n.text())}catch(n){const i=Ds.A.ERR_LOADING_HTTP({attr:e.value,error:String(n),url:t});e.annotationStore.addErrors([Os.generalError(i)]),e.setRemoteValue("")}}else e.setRemoteValue(i)}),setRemoteValue(t){e.loaded=!0,"base64"===e.encoding&&(t=atob(t)),"base64unicode"===e.encoding&&(t=en.Checkers.atobUnicode(t)),(0,Ne.VS)(Ne.pN)&&"text"===e.type?e._value=String(t):e._value=(0,fe.sanitizeHtml)(String(t)),e._regionsCache.forEach(({region:t,annotation:n})=>{t.setText(e._value.substring(t.startOffset,t.endOffset)),e.regions.push(t),n.addRegion(t)}),e._regionsCache=[]},afterCreate(){e._regionsCache=[],"text"===e.type&&(e.inline=!0),"none"===e.savetextresult&&("url"===e.valuetype?e.savetextresult="no":"text"===e.valuetype&&(e.savetextresult="yes"))},beforeDestroy(){var n,i;null==(n=t)||n.removeStyles(e.name),null==(i=t)||i.destroy(),t=null},needsUpdate(){if(!1===e.isLoaded)return;e.setReady(!1);const t={[e.name]:e.styles};e.regs.forEach(e=>{try{e.initRangeAndOffsets(),e.applyHighlight(!0),e.updateHighlightedText(),t[e.identifier]=e.styles}catch(e){console.error(e)}}),e.setStyles(t),e.setReady(!0)},setStyles(e){var n;null==(n=t)||n.setStyles(e)},removeStyles(e){var n;null==(n=t)||n.removeStyles(e)},globalOffsetsToRelativeOffsets:({start:e,end:n})=>t.globalOffsetsToRelativeOffsets(e,n),relativeOffsetsToGlobalOffsets:(e,n,i,o)=>t.relativeOffsetsToGlobalOffsets(e,n,i,o),rangeToGlobalOffset:e=>t.rangeToGlobalOffset(e),createSpansByGlobalOffsets:({start:e,end:n})=>t.createSpans(e,n),removeSpansInGlobalOffsets(e,{start:n,end:i}){var o;return null==(o=t)?void 0:o.removeSpans(e,n,i)},getTextFromGlobalOffsets:({start:e,end:n})=>t.getText(e,n),setHighlight(t){e.regs.forEach(e=>e.setHighlight(!1)),t&&t.annotation.isLinkingMode&&t.setHighlight(!0)},addRegion(t,n){var i;const o=e.getAvailableStates();if(0===o.length)return;const[s,...a]=o,r=null!=(i=null==n?void 0:n.value)?i:s.selectedValues(),l={[s.valueType]:r};let c;Gh.isActive(Gh.FF_MULTIPLE_LABELS_REGIONS)||(c=a.map(e=>function(e){const t=(0,u.dV)(e),n=(0,u.Pw)(e).create(Object.assign({},t,{id:I()}));return null==n.afterClone||n.afterClone(e),n}(e)));const d=Gh.isActive(Gh.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult(t,l,s,e,!1,a):e.annotation.createResult(t,l,s,e,!1),h=e.getRootNode();Gh.isActive(Gh.FF_MULTIPLE_LABELS_REGIONS)||c.forEach(e=>{d.setValue(e),(0,u.zr)(e)}),d._range=t._range;const[g,m]=Zt(t._range,h);return d.updateGlobalOffsets(g,m),t.isText?d.updateTextOffsets(g,m):d.updateXPathsFromGlobalOffsets(),d.applyHighlight(),d.notifyDrawingFinished(),d}}}),ug=u.gK.compose("RichTextModel",Fe,gn,Ze,Te,Ae,cg,dg);var hg=n(71161);class gg extends f.Component{constructor(...e){super(...e),this._regionSpanSelector=".htx-highlight",this._regionVisibleSpanSelector=".htx-highlight:not(.__hidden)",this.loadingRef=f.createRef(),this.doubleClickSelection=void 0,this._selectRegions=e=>{const{item:t}=this.props,n=t.mountNodeRef.current,i=window.getSelection(),o=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT),s=[];for(;o.nextNode();){const e=o.currentNode;if("SPAN"===e.nodeName&&e.matches(this._regionVisibleSpanSelector)&&i.containsNode(e)){const t=this._determineRegion(e);s.push(t)}}s.length&&(t.annotation.extendSelectionWith(s),e?t.annotation.extendSelectionWith(s):t.annotation.selectAreas(s),i.removeAllRanges())},this._setSelectionStyle=(e,t)=>{var n,i;const o=e.getColors(),s=[`background: ${o.resizeBackground};`,`color: ${o.activeText};`];this.selectionStyle||(this.selectionStyle=t.createElement("style"),t.head.appendChild(this.selectionStyle)),this.selectionStyle.innerText=[`::selection {${s.join(" ")}}`,`::-moz-selection {${s.join(" ")}}`,"body * { cursor: col-resize !important; }"].join("\n"),null==(n=(i=this.props.item).setStyles)||n.call(i,{[e.identifier]:e.resizeStyles})},this._removeSelectionStyle=e=>{var t,n;this.selectionStyle&&(this.selectionStyle.innerText=""),e&&(null==(t=(n=this.props.item).setStyles)||t.call(n,{[e.identifier]:e.styles}))},this._checkHandlesAndStartDragging=e=>{const{item:t}=this.props,n=e.target,i=this._determineRegion(n),o=[Zh.leftHandle,Zh.rightHandle],s=n.classList.contains(o[0])||n.classList.contains(o[1]);if(1===e.buttons&&null!=i&&i.selected&&s){var a,r;const e=t.mountNodeRef.current,s=null!=(a=null!=(r=null==e?void 0:e.contentDocument)?r:null==e?void 0:e.ownerDocument)?a:e;this.draggableRegion=i,this.dragBackwards=n.classList.contains(o[0]),this._setSelectionStyle(i,s)}else this.draggableRegion=void 0},this._hightlightRegion=(e,t)=>{const n=t._spans[0],i=t._spans.at(-1),o=window.getSelection();this.dragBackwards?(o.selectAllChildren(i),o.collapseToEnd(),o.extend(n,0)):(o.selectAllChildren(n),o.extend(i,i.childNodes.length-1))},this._checkDragAndAdjustRegion=e=>{const{item:t}=this.props;if(this._removeSelectionStyle(this.draggableRegion),t.initializedDrag){const n=this.draggableRegion,i=window.getSelection();if(i.isCollapsed)return!1;if(!n)return!1;let o=Ht(i.getRangeAt(0));if(!e.contains(o.startContainer)||!e.contains(o.endContainer))return i.removeAllRanges(),!1;n.detachHandles(),"symbol"!==t.granularity&&Ot(i),Bt(i,t.granularity),o=i.getRangeAt(0),i.removeAllRanges(),n._range=o;const[s,a]=Zt(o,e);return n.removeHighlight(),t.annotation.history.freeze("richtext:resize"),n.updateGlobalOffsets(s,a),"text"===t.type?n.updateTextOffsets(s,a):n.updateXPathsFromGlobalOffsets(),n.applyHighlight(),n.attachHandles(),n.notifyDrawingFinished(),n.updateHighlightedText({force:!0}),t.annotation.history.unfreeze("richtext:resize"),!0}return!1},this._onMouseDown=e=>{this.props.item.canResizeSpans&&(this._resetDragParams(),this._removeSelectionStyle(),this._checkHandlesAndStartDragging(e))},this._onMouseMove=e=>{if(this.draggableRegion){e.preventDefault();const{item:i}=this.props;if(i.initializedDrag){if(!this.currentSelection){var t,n;const e=i.mountNodeRef.current,o=null!=(t=null!=(n=null==e?void 0:e.contentDocument)?n:null==e?void 0:e.ownerDocument)?t:e;this.currentSelection=window.getSelection(),this._hightlightRegion(o,this.draggableRegion),document.addEventListener("mouseup",this._onMouseUpGlobal,{once:!0})}}else i.initializedDrag=!0}},this._onMouseUpGlobal=()=>{var e,t;const{item:n}=this.props,i=n.mountNodeRef.current,o=null!=(e=null==i||null==(t=i.contentDocument)?void 0:t.body)?e:i;this._checkDragAndAdjustRegion(o),this.draggableRegion&&this._resetDragParams()},this._onMouseUp=e=>{var t,n,i,o,s,a;const{item:r}=this.props;if(r.initializedDrag)return;const l=r.activeStates(),c=r.mountNodeRef.current,d=null!=(t=null==c||null==(n=c.contentDocument)?void 0:n.body)?t:c;if(!l||0===l.length||e.ctrlKey||e.metaKey)return this._selectRegions(e.ctrlKey||e.metaKey);if(!1===r.selectionenabled||r.annotation.isReadOnly())return;const u=null==(i=l[0])||null==(i=i.selectedLabels)?void 0:i[0],h=null==(o=l[0])||null==o.selectedValues?void 0:o.selectedValues();en.Selection.captureSelection(({selectionText:t,range:n})=>{if(!n||n.collapsed||!d.contains(n.startContainer)||!d.contains(n.endContainer))return;qt(n);const i=hg.fromRange(n,d);i&&(this.doubleClickSelection&&(Date.now()-this.doubleClickSelection.time>450||Math.abs(e.pageX-this.doubleClickSelection.x)>5||Math.abs(e.pageY-this.doubleClickSelection.y)>5)&&(this.doubleClickSelection=void 0),i._range=n,i.text=t,i.isText="text"===r.type,r.addRegion(i,this.doubleClickSelection))},{window:null!=(s=null==c?void 0:c.contentWindow)?s:window,granularity:null!=(a=null==u?void 0:u.granularity)?a:r.granularity,beforeCleanup:()=>{this.doubleClickSelection=void 0,this._selectionMode=!0}}),this.doubleClickSelection={time:Date.now(),value:null!=h&&h.length?h:void 0,x:e.pageX,y:e.pageY}},this._onRegionClick=e=>{if(this._selectionMode)return void(this._selectionMode=!1);if(!this.props.item.clickablelinks&&(0,fe.matchesSelector)(e.target,"a[href]"))return void e.preventDefault();const t=this._determineRegion(e.target);t&&(t&&t.onClickRegion(e),e.stopPropagation())},this._onRegionMouseOver=e=>{const t=this._determineRegion(e.target),{item:n}=this.props;n.setHighlight(t)},this.updateLoadingVisibility=()=>{const{item:e}=this.props,t=this.loadingRef.current;t&&(e&&(0,u._n)(e)&&e.isLoaded&&e.isReady?t.setAttribute("style","display: none"):t.removeAttribute("style"))},this._passHotkeys=e=>{const t="key code keyCode location ctrlKey shiftKey altKey metaKey".split(" "),n={};for(const i of t)n[i]=e[i];const i=new KeyboardEvent(e.type,n);document.dispatchEvent(i)},this.onIFrameLoad=()=>{const{item:e}=this.props,t=e.mountNodeRef.current,n=null==t?void 0:t.contentDocument,i=null==n?void 0:n.body,o=null==i?void 0:i.parentElement,s={click:[this._onRegionClick,!0],keydown:[this._passHotkeys,!1],keyup:[this._passHotkeys,!1],keypress:[this._passHotkeys,!1],mouseup:[this._onMouseUp,!1],mouseover:[this._onRegionMouseOver,!0]};if(!i)return;for(const e in s)i.addEventListener(e,...s[e]);const a=n.createElement("style");a.textContent="body a[href] { pointer-events: all; }",n.head.appendChild(a),i.scrollHeight&&(t.style.height=`${Math.max(i.scrollHeight,o.offsetHeight)}px`),this.markObjectAsLoaded()}}_resetDragParams(){const{item:e}=this.props;e.initializedDrag=!1,this.draggableRegion=void 0,this.currentSelection=void 0,this.dragBackwards=!1}_handleUpdate(e=!1){const{item:t}=this.props,n=t.getRootNode();if(t.inline||n&&"IFRAME"!==n.tagName&&n.childNodes.length&&!1!==t.isLoaded)if(e&&t.annotation){const{history:e,pauseAutosave:n,startAutosave:i}=t.annotation;n(),e.freeze("richtext:init"),t.needsUpdate(),e.setReplaceNextUndoState(!0),e.unfreeze("richtext:init"),i()}else t.needsUpdate()}_determineRegion(e){const t=this._regionVisibleSpanSelector;if((0,fe.matchesSelector)(e,t)){const n="SPAN"===e.tagName&&e.matches(t)?e:e.closest(t),{item:i}=this.props;return i.regs.find(e=>e.find(n))}}componentDidMount(){const{item:e}=this.props;e.inline||(this.dispose=(0,d.lB)(e,"_isReady",this.updateLoadingVisibility,!0))}componentWillUnmount(){var e;const{item:t}=this.props;t&&(0,u._n)(t)&&(null==(e=this.dispose)||e.call(this),t.setLoaded(!1),t.setReady(!1),t.onDispose())}markObjectAsLoaded(){const{item:e}=this.props;e&&(0,u._n)(e)&&(e.setLoaded(!0),this.updateLoadingVisibility(),setTimeout(()=>this._handleUpdate(!0)))}render(){const{item:e}=this.props;if(!(0,E.isDefined)(e._value))return null;let t=e._value||"";const n=this.props.store.settings,i="text"===e.type;if(i){const e=(0,Nn.cn)("richtext",{elem:"line"});t=(0,fe.htmlEscape)(t).split(/\n|\r/g).map(t=>`<span class="${e}">${t}</span>`).join("<br/>")}if(e.inline){const o={onClickCapture:this._onRegionClick,onMouseDown:this._onMouseDown,onMouseMove:this._onMouseMove,onMouseUp:this._onMouseUp,onMouseOverCapture:this._onRegionMouseOver};return(0,ae.jsx)(Es,{item:e,className:(0,Nn.cn)("richtext").toClassName(),children:(0,ae.jsx)("div",Object.assign({className:(0,Nn.cn)("richtext").elem("container").mod({canResizeSpans:Gh.isActive(Gh.FF_ADJUSTABLE_SPANS)}).mix("htx-richtext").toClassName(),ref:t=>{e.mountNodeRef.current=t,t&&this.markObjectAsLoaded()},"data-linenumbers":i&&n.showLineNumbers?"enabled":"disabled",dangerouslySetInnerHTML:{__html:t}},o),"root")})}return(0,ae.jsxs)(Es,{item:e,className:(0,Nn.cn)("richtext").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("richtext").elem("loading").toClassName(),ref:this.loadingRef,children:(0,ae.jsx)($s.A,{})}),(0,ae.jsx)("iframe",{className:(0,Nn.cn)("richtext").elem("iframe").mix("htx-richtext").toClassName(),referrerPolicy:"no-referrer",sandbox:"allow-same-origin allow-scripts allow-presentation",ref:t=>{e.setReady(!1),e.mountNodeRef.current=t},srcDoc:t,onLoad:this.onIFrameLoad},"root")]})}}const mg=(0,b.WQ)("store"),pg=mg((0,b.PA)(gg)),fg=({isText:e=!1}={})=>mg((0,b.PA)(t=>(0,ae.jsx)(pg,Object.assign({},t,{isText:e}))));we.addTag("text",ug,fg({isText:!0})),we.addTag("hypertext",ug,fg({isText:!1})),we.addObjectType(ug);var vg=n(80627);const yg=u.gK.model({type:"table",value:u.gK.maybeNull(u.gK.string),_value:u.gK.frozen([]),valuetype:u.gK.optional(u.gK.string,"json")}).views(e=>({get isJsonArrayOfObjects(){const t=e._value;return Array.isArray(t)&&t.length>0&&"object"==typeof t[0]&&null!==t[0]&&!Array.isArray(t[0])},get dataSource(){const{type:t}=Le(e.valuetype);if("json"===t){const t=e._value;return e.isJsonArrayOfObjects?t:Array.isArray(t)?t.map((e,t)=>{let n=e;return"object"==typeof n&&(n=JSON.stringify(n)),{type:String(t),value:n}}):Object.keys(t).sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())).map(e=>{let n=t[e];return"object"==typeof n&&(n=JSON.stringify(n)),{type:e,value:n}})}return e._value},get columns(){const{type:t}=Le(e.valuetype);if("json"===t){const t=e._value;if(e.isJsonArrayOfObjects){return Array.from(new Set(t.reduce((e,t)=>(t&&"object"==typeof t&&!Array.isArray(t)&&e.push(...Object.keys(t)),e),[]))).map(e=>({title:e,dataIndex:e}))}return[{title:"Name",dataIndex:"type"},{title:"Value",dataIndex:"value"}]}return e._value[0]?Object.keys(e._value[0]).map(e=>({title:e,dataIndex:e})):[{title:"Name",dataIndex:"type"},{title:"Value",dataIndex:"value"}]}})).actions(e=>({updateValue:(0,u.L3)(function*(t){const{type:n,options:i}=Le(e.valuetype);let o=Oe(e.value,t.task.dataObj);if(i.url)try{const e=yield fetch(o),{ok:t,status:n,statusText:i}=e;if(!t)throw new Error(`${n} ${i}`);o=yield e.text()}catch(t){const n=(0,u._$)(e).messages.ERR_LOADING_HTTP({attr:e.value,error:String(t),url:o});e.annotationStore.addErrors([Os.generalError(n)])}if("csv"===n)Ee().parse(o,{delimiter:i.separator,header:!i.headless,download:!1,complete:({data:t})=>{e._value=t}});else e._value="string"==typeof o?JSON.parse(o):o})})),bg=u.gK.compose("TableModel",gn,Fe,Te,yg),xg=(0,b.WQ)("store")((0,b.PA)(({item:e})=>(0,ae.jsx)(vg.A,{bordered:!0,dataSource:e.dataSource,columns:e.columns,pagination:{hideOnSinglePage:!0}})));we.addTag("table",bg,xg),we.addObjectType(bg);var wg=n(540);const Sg=()=>(window.screen&&window.screen.width||1440)*(window.devicePixelRatio||2),Cg=(e,t=1e6)=>{if(e.length<=t)return e;let n=0;const i=(e.length-1)/(t-1);return e.filter((e,t)=>!(t<n)&&(n+=i,!0))},kg=(e,t=1)=>{const n=(e.style||w.l).fillcolor;return en.Colors.convertToRGBA(n,t)},Pg=e=>!wg.f0J.sourceEvent||(e?wg.f0J.sourceEvent.type===e:["start","brush","end"].includes(wg.f0J.sourceEvent.type)),Rg=e=>new Date(e).toUTCString(),jg=u.gK.model({}).views(()=>({get persistentValuesKey(){return"labelStudio:storedValues"},get persistentValues(){return{}},get persistentFingerprint(){return{}}})).actions(e=>({afterCreate(){setTimeout(e.restoreValues)},beforeDestroy(){e.storeValues()},storeValues(){const t=e.persistentValuesKey,n=Object.assign({},e.persistentFingerprint,{values:e.persistentValues});localStorage.setItem(t,JSON.stringify(n))},restoreValues(){const t=JSON.parse(localStorage.getItem(e.persistentValuesKey)||"{}");if(!t)return;if(!Object.keys(e.persistentFingerprint).every(n=>t[n]===e.persistentFingerprint[n]))return;const n=t.values||{};for(const t of Object.keys(n))e[t]=n[t]}}));class Ng extends f.Component{constructor(...e){super(...e),this.ref=f.createRef(),this.gCreator=void 0,this.brushCreator=void 0,this.gBrushes=void 0,this.tracker=void 0,this.trackerX=0,this.trackerPoints=void 0,this.trackerTime=void 0,this.trackerValue=void 0,this.extent=[0,0],this.useOptimizedData=!1,this.optimizedSeries=null,this.zoomStep=10,this.line=void 0,this.lineSlice=void 0,this.height=+this.props.item.height,this.state={width:840},this.changeWidth=()=>{const e=this.ref.current.offsetWidth,{margin:t}=this.props.item;if(e){const n=e-t.left-t.right;this.setState({width:n})}},this.getRegion=(e,t)=>{const[n,i]=e.map(e=>+this.stick(e).time);return{start:n,end:t?n:i}},this.createBrushMovedHandler=e=>()=>{if(Pg("end")||!wg.f0J.selection)return;const{ranges:t}=this.props,{parent:n}=this.props.item,i=t.findIndex(t=>t.id===e);if(i<0)return void console.error(`REGION ${e} was not found`);const o=t[i],s=this.getRegion(wg.f0J.selection,o.instant);s.start===o.start&&s.end===o.end?(null==n||n.annotation.unselectAreas(),o.onClickRegion(wg.f0J.sourceEvent)):null==n||n.regionChanged(s,i)},this.newRegion=void 0,this.newRegionTimer=void 0,this.newBrushHandler=()=>{var e;const{ranges:t,item:{parent:n}}=this.props,i=null==n?void 0:n.activeStates(),o=null==i?void 0:i.length,s=null==n||null==(e=n.annotation)?void 0:e.isReadOnly();if(Pg("end"))return;if(!wg.f0J.selection){const e=wg.grR(wg.f0J.sourceEvent.target)[0],i=this.newRegion;i&&Math.abs(i.x-e)<4?(clearTimeout(this.newRegionTimer),s||null==n||n.regionChanged(i.range,t.length),this.newRegion=null,this.newRegionTimer=null):o&&(this.newRegion={range:this.getRegion([e,e]),x:e},this.newRegionTimer=setTimeout(()=>{this.newRegion=null,this.newRegionTimer=null},300));const a=this.x.invert(e),r=t.filter(e=>e.start<=a&&e.end>=a),l=r.findIndex(e=>e.selected)+1,c=r[l];return void(c?c.onClickRegion(wg.f0J.sourceEvent):(null==n||n.annotation.unselectAreas(),null==n||n.plotClickHandler(+a)))}const a=this.getRegion(wg.f0J.selection);this.brushCreator.move(this.gCreator,null);const r=wg.f0J.sourceEvent.ctrlKey||wg.f0J.sourceEvent.metaKey;if(r||!o||s){const e=t.filter(e=>e.start>=a.start&&e.end<=a.end);return void(r?null==n||n.annotation.extendSelectionWith(e):null==n||n.annotation.selectAreas(e))}null==n||n.addRegion(a.start,a.end)},this.updateTracker=(e,t=0)=>{const{width:n}=this.state;if(e<0||e>n)return;const{time:i,value:o}=this.stick(e);this.trackerX=i,this.tracker.attr("transform",`translate(${this.x(i)+.5},0)`),this.trackerTime.text(`${this.formatTime(i)}${0===t?"":` [${this.formatDuration(t)}]`}`);const{isChannelHiddenMap:s}=this.props.item;this.props.channels.forEach(e=>{const t=e.columnName,n=this.channels[t],i=o[t];n.trackerPoint.attr("cy",n.y(i)),null===i||null!=s&&s[n.id]?(n.trackerPoint.style("display","none"),n.trackerValue.style("display","none")):(n.trackerPoint.style("display",void 0),n.trackerValue.style("display",void 0),n.trackerValue.text(`${n.formatValue(i)} ${n.units}`))}),this.tracker.attr("text-anchor",e>n-100?"end":"start")},this.renderTracker=()=>{const e=this.updateTracker;this.tracker=this.main.append("g").style("pointer-events","none"),this.trackerValue=this.tracker.append("text").attr("font-size",10).attr("fill","#666"),this.trackerTime=this.tracker.append("text").attr("y",this.height-1).attr("font-size",10).attr("fill","#666"),this.trackerPoints=this.props.channels.map(e=>{const t=e.columnName,n=this.channels[t];return n.trackerValue=this.trackerValue.append("tspan").attr("fill",e.strokecolor).attr("x",0).attr("dy",10),n.trackerPoint=this.tracker.append("circle").attr("cx",0).attr("r",3).attr("stroke","red").attr("fill","none")}),this.tracker.append("line").attr("y1",this.height).attr("y2",0).attr("stroke","#666"),this.main.on("mousemove",function(){e(wg.grR(this)[0])})},this.renderPlayhead=()=>{var e;if(this.playhead)return;this.playhead=this.main.append("g").attr("class","playhead").attr("pointer-events","none").style("display","none");const t=(null==(e=this.props.item.parent)?void 0:e.cursorcolor)||"var(--color-neutral-inverted-surface)";this.playheadLine=this.playhead.append("line").attr("y1",6).attr("y2",this.height).attr("stroke",t).attr("stroke-width",2),this.playheadHandle=this.playhead.append("polygon").attr("points","-4,0 4,0 4,7 1,10 -1,10 -4,7").attr("fill",t)},this.updatePlayhead=e=>{if(!this.playhead)return;if(null===e||!Number.isFinite(e))return void this.playhead.style("display","none");const t=this.x.domain();if(e<t[0]||e>t[1])return void this.playhead.style("display","none");const n=this.x(e)+.5;this.playhead.attr("transform",`translate(${n},0)`).style("display","block")},this.renderXAxis=()=>{const{item:e}=this.props;if(!e.showaxis)return;const{width:t}=this.state,{margin:n}=e,i=this.height+n.top,o=-n.top;let s=this.main.select(".xaxis");s.size()||(s=this.main.append("g").attr("class","xaxis")),s.attr("transform",`translate(0,${o})`).call(wg.l78(this.x).ticks(t/80).tickSize(i+4)).call(e=>e.selectAll(".domain").remove()).call(e=>e.selectAll(".tick").attr("stroke-opacity",.2).selectAll(".bottom").data([0]).enter().append("line").attr("class","bottom").attr("stroke","currentColor").attr("y1",i+16).attr("y2",i+n.bottom))},this.renderYAxis=()=>{const{item:e}=this.props;if(!e.showaxis||!e.showyaxis)return;const{margin:t}=e;let n=this.main.select(".yaxis"),i=this.main.select(".yaxis2");n.size()||(n=this.main.append("g").attr("class","yaxis")),i.size()||(i=this.main.append("g").attr("class","yaxis2")),i.attr("transform",`translate(${this.state.width},0)`);const o=this.props.channels.filter(e=>e.showaxis&&e.showyaxis),s=o.length>0&&this.channels[o[0].columnName],a=o.length>1&&this.channels[o[1].columnName];s&&n.call(wg.V4s(s.y).tickFormat(s.formatValue).tickSize(3)).call(e=>e.select(".domain").remove()).call(e=>e.select(".title").remove()).call(e=>e.append("text").attr("class","title").attr("font-size",8).attr("x",-6).attr("y",0).attr("fill","currentColor").attr("text-anchor","end").text(s.units)),a&&i.call(wg.eH3(a.y).tickFormat(a.formatValue).tickSize(3)).call(e=>e.select(".domain").remove()).call(e=>e.select(".title").remove()).call(e=>e.append("text").attr("class","title").attr("font-size",8).attr("x",0).attr("y",0).attr("fill","currentColor").attr("text-anchor","start").text(a.units))},this.stick=e=>{const t=this.x.invert(e),n=this.allTimes;let i=wg.Jjl(n,t,0,n.length-1);return n[i]-t>t-n[i-1]&&i--,{time:n[i],value:this.allSeries[i]}},this.channels={}}renderBrushes(e,t=!1){const{width:n}=this.state,i=this.height,{item:o}=this.props,s=[[0,0],[n,i]],a=wg.n55().extent(s),r=this.x;t&&this.gBrushes.selectAll(".brush").remove();const l=this.gBrushes.selectAll(".brush").data(e,e=>e.id),c=this.createBrushMovedHandler,d=this.updateTracker,u=this.getRegion;l.enter().append("g").attr("class","brush").attr("id",e=>`brush_${o.id}_${e.id}`).each(function(e){const t=wg.Ltv(this),n=wg.n55().extent(s);n.on("brush",function(){if(Pg("brush"))return;const n=u(wg.f0J.selection,e.instant);a.move(t,[r(n.start),r(n.end)+.5*e.instant]),d(wg.grR(this)[0])}),n.on("end",c(e.id)),n(t),e.instant?t.selectAll(".handle").style("pointer-events","none"):t.selectAll(".selection").style("pointer-events","none"),t.selectAll(".overlay").style("pointer-events","none"),e.isReadOnly()&&t.selectAll(".handle").remove(),void 0!==e._brushRef&&e._brushRef.isConnected||(e._brushRef=t.select(".selection").node())}).merge(l).each(function(e){const t=wg.Ltv(this),n=t.selectAll(".selection");t.style("display",e.hidden?"none":"block");const i=kg(e);if(e.instant){n.attr("stroke-opacity",e.inSelection||e.highlighted?.6:.2).attr("fill-opacity",e.inSelection||e.highlighted?1:.6).attr("stroke-width",3).attr("stroke",i).attr("fill",i);const o=r(e.start);a.move(t,[o,o+1])}else n.attr("stroke-opacity",e.inSelection||e.highlighted?.8:.5).attr("fill-opacity",e.inSelection||e.highlighted?.6:.3).attr("stroke",i).attr("fill",i),a.move(t,[e.start,e.end].map(r))}),l.exit().remove()}renderBrushCreator(){this.gCreator?this.gCreator.selectAll("*").remove():this.gCreator=this.main.append("g").attr("class","new_brush");const e=this.updateTracker,t=this.gCreator,n=this.getRegion,i=this.x,o=this.brushCreator=wg.n55().extent([[0,0],[this.state.width,this.height]]).on("brush",function(){if(Pg("brush")||!wg.f0J.selection)return;const s=n(wg.f0J.selection);o.move(t,[i(s.start),i(s.end)]),e(wg.grR(this)[0],s.end-s.start)}).on("end",this.newBrushHandler).filter(()=>!wg.f0J.button);this.gCreator.call(this.brushCreator)}initZoom(){var e;const{data:t,item:n,time:i}=this.props,o=t[i],s=null==(e=n.parent)?void 0:e.throttledRangeUpdate();this.main.on("wheel",()=>{const e=wg.f0J;if(!e.ctrlKey&&!e.metaKey)return;e.preventDefault();const{range:t}=this.props,n=t.map(e=>wg.Jjl(o,e)),[i]=wg.grR(wg.f0J.target),a=this.x.range()[1],r=Math.min(.3,-e.deltaY/this.height);if(n[1]-n[0]<10&&r>0)return;const l=t[1]-t[0],c=[Math.max(+this.extent[0],+t[0]+l*r*i/a),Math.min(+this.extent[1],t[1]-l*r*(1-i/a))];s(c,r)})}componentDidMount(){if(!this.ref.current)return;const{range:e}=this.props;this.initializeComponent();for(const e of this.props.channels)this.initializeChannel(e);this.renderTracker(),this.renderPlayhead(),this.updatePlayhead(this.props.cursorTime),this.updateTracker(0),this.renderYAxis(),this.setRangeWithScaling(e),this.renderBrushCreator(),this.initZoom(),this.gBrushes=this.main.append("g").attr("class","brushes").attr("clip-path",`url("#${this.clipPathId}")`),this.renderBrushes(this.props.ranges),window.addEventListener("resize",this.changeWidth)}get formatTime(){var e;return null==(e=this.props.item.parent)?void 0:e.formatTime}get formatDuration(){var e;return null==(e=this.props.item.parent)?void 0:e.formatDuration}get slices(){var e;return null==(e=this.props.item.parent)?void 0:e.dataSlices}initializeComponent(){const e="Dark"===(0,Pn.j17)(),{item:t,time:n,channels:i}=this.props,{isDate:o,slicesCount:s}=t.parent,{margin:a}=t,r=this.height;this.clipPathId=`clip_${t.id}`,this.zoomStep=s;let{series:l}=this.props;l=l.filter(e=>i.some(t=>null!==e[t.columnName]));const c=l.map(e=>e[n]);this.allSeries=l,this.allTimes=c;const d=i.flatMap(e=>{const t=e.columnName;return l.map(e=>e[t])}),u=Sg()*this.zoomStep;this.useOptimizedData=l.length>u,this.useOptimizedData&&(this.optimizedSeries=Cg(l,u));const h=this.ref.current.offsetWidth,g=h?h-a.left-a.right:this.state.width;this.state.width=g,this.extent=wg.Xxv(c);const m=(o?wg.Pps():wg.m4Y()).domain(this.extent).range([0,g]),p=wg.m4Y().domain(wg.Xxv(d)).range([r-a.max,a.min]);this.x=m,this.y=p,this.plotX=m.copy(),this.plotY=p.copy(),this.main=wg.Ltv(this.ref.current).append("svg").attr("viewBox",[0,0,g+a.left+a.right,r+a.top+a.bottom]).style("display","block").append("g").attr("transform",`translate(${a.left},${a.top})`),this.defs=this.main.append("defs"),this.main.append("clipPath").attr("id",this.clipPathId).append("rect").attr("x",0).attr("y",0).attr("height",r).attr("width",g),1===i.length&&this.main.append("text").text(t.legend).attr("fill",e?"red":"black").attr("dx","1em").attr("dy","1em").attr("font-weight","bold").attr("font-size","1.4em").attr("dy","1em").attr("opacity",.1),this.pathContainer=this.main.append("g").attr("clip-path",`url("#${this.clipPathId}")`)}initializeChannel(e){const t=`marker_${e.id}`,n=e.columnName,{time:i,range:o}=this.props,{margin:s}=e,a=this.height,r=this.channels[n]={id:e.id,units:e.units};let{series:l}=this.props;this.optimizedSeries&&(r.useOptimizedData=this.useOptimizedData,l=this.optimizedSeries),l=l.filter(e=>null!==e[n]),this.optimizedSeries&&(r.optimizedSeries=l);const c=l.map(e=>e[n]);if(!c){const t=Object.keys(data).filter(e=>e!==i),o=`\`${n}\` not found in data. Available columns: ${t.join(", ")}. For headless csv you can use column index`;return void(0,u.Zn)(e).annotationStore.addErrors([Os.generalError(o)])}const d=wg.GPZ(e.displayformat);r.formatValue=d;const h=wg.m4Y().domain(wg.Xxv(c)).range([a-s.max,s.min]);r.x=this.x.copy(),r.plotX=this.x.copy(),r.y=h,r.plotY=h.copy(),r.line=wg.n8j().y(e=>r.plotY(e[n])).x(e=>r.plotX(e[i])),r.lineSlice=wg.n8j().defined(e=>e[i]>=o[0]&&e[i]<=o[1]).y(e=>r.y(e[n])).x(e=>r.x(e[i]));((e,t,n,i)=>{switch(t){case"circle":e.append("path").attr("d",wg.HRO().type(wg.hKN).size(2*n)).attr("transform",`translate(${n/2}, ${n/2})`).attr("stroke","none").attr("fill",i);break;case"square":e.append("path").attr("d",wg.HRO().type(wg.yDW).size(2*n)).attr("transform",`translate(${n/2}, ${n/2})`).attr("stroke","none").attr("fill",i);break;case"triangle":case"triangleUp":e.append("path").attr("d",wg.HRO().type(wg.ZKi).size(2*n)).attr("transform",`translate(${n/2}, ${n/2})`).attr("stroke","none").attr("fill",i);break;case"triangleDown":e.append("path").attr("d",wg.HRO().type(wg.ZKi).size(2*n)).attr("transform",`translate(${n/2}, ${n/2}) rotate(180 0 0)`).attr("stroke","none").attr("fill",i)}})(this.defs.append("marker").attr("id",t).attr("markerWidth",e.markersize).attr("markerHeight",e.markersize).attr("refX",e.markersize/2).attr("refY",e.markersize/2),e.markersymbol,e.markersize,e.markercolor),r.path=this.pathContainer.append("path").datum(l).attr("d",r.line),r.path2=this.pathContainer.append("path");for(const n of[r.path,r.path2])n.attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("stroke-width",e.strokewidth||1).attr("stroke",e.strokecolor||"steelblue").attr("marker-start",e.markersize>0?`url(#${t})`:"").attr("marker-mid",e.markersize>0?`url(#${t})`:"").attr("marker-end",e.markersize>0?`url(#${t})`:"")}componentWillUnmount(){window.removeEventListener("resize",this.changeWidth)}setRangeWithScaling(e){this.x.domain(e);const t=this.x.range(),n=this.plotX.domain().map(this.x),i=(n[1]-n[0])/(t[1]-t[0]),o=Math.max(0,Math.floor(this.zoomStep*(t[0]-n[0])/(n[1]-n[0]))),s=Math.max(0,Math.floor(this.zoomStep*(t[1]-n[0])/(n[1]-n[0]))),a=n[0]-t[0],{item:r}=this.props;if(r.timerange){const e=r.timerange.split(",").map(Number);this.x.domain(e)}for(const t of this.props.channels)this.setChannelRangeWithScaling(t,e,{left:o,right:s,translate:a,scale:i})}setChannelRangeWithScaling(e,t,{left:n,right:i,translate:o,scale:s}){var a;const r=e.columnName,l=this.channels[r];l.x.domain(t);let c=0,d=1;const u=l.y.range()[0],{item:h}=this.props,g=void 0===e.fixedscale?void 0===h.fixedscale?null==(a=h.parent)?void 0:a.fixedscale:h.fixedscale:e.fixedscale;if(e.timerange){const t=e.timerange.split(",").map(Number);l.x.domain(t)}if(!g){const{data:n,time:i}=this.props,o=n[r];let s=wg.Jjl(n[i],t[0]);const a=wg.Jjl(n[i],t[1]);let u=o[s],h=o[s];for(;s<a;s++)u>o[s]&&(u=o[s]),h<o[s]&&(h=o[s]);if(e.datarange){const t=e.datarange.split(",");""!==t[0]&&(u=new Number(t[0])),""!==t[1]&&(h=new Number(t[1]))}const[g,m]=wg.Xxv(o);d=(m-g)/(h-u),l.y.domain([u,h]),c=l.y(g)-l.y(u)}const m=s>this.zoomStep===l.useOptimizedData;l.optimizedSeries&&m&&(l.useOptimizedData=!l.useOptimizedData,l.useOptimizedData?(l.path.datum(l.optimizedSeries),l.path.attr("d",l.line)):l.path.attr("transform","")),l.useOptimizedData?(l.path.attr("transform",`translate(${o} ${c}) scale(${s} ${d})`),l.path.attr("transform-origin",`left ${u}`),l.path2.attr("d","")):l.optimizedSeries?(l.path.datum(this.slices[n]),l.path.attr("d",l.lineSlice),n!==i&&this.slices[i]?(l.path2.datum(this.slices[i]),l.path2.attr("d",l.lineSlice)):l.path2.attr("d","")):(l.path.attr("d",l.lineSlice),l.path2.attr("d","")),this.renderXAxis(),this.renderYAxis(),this.updateTracker(this.x(this.trackerX)),this.updatePlayhead(this.props.cursorTime)}componentDidUpdate(e,t){const{range:n}=this.props,{width:i}=this.state;let o=!1;if(i!==t.width){const{item:e,range:t}=this.props,{margin:n}=e,s=this.height,a=wg.Ltv(this.ref.current).selectAll("svg");a.attr("viewBox",[0,0,i+n.left+n.right,s+n.top+n.bottom]),this.x.range([0,i]),this.plotX.range([0,i]);for(const e of Object.values(this.channels))e.x.range([0,i]),e.plotX.range([0,i]),e.useOptimizedData&&e.path.attr("d",e.line);this.renderBrushCreator(),a.selectAll("clipPath rect").attr("width",i),this.setRangeWithScaling(t),this.renderBrushCreator(),o=!0}else{const e=this.x.domain();+e[0]===+n[0]&&+e[1]===+n[1]||this.setRangeWithScaling(n)}this.renderBrushes(this.props.ranges,o);const{isChannelHiddenMap:s,highlightedChannelId:a}=this.props.item;for(const e of Object.values(this.channels)){const t=a&&a!==e.id?.3:void 0,n=!(null==s||!s[e.id])?"none":void 0;e.path.style("opacity",t).style("display",n),e.path2.style("opacity",t).style("display",n)}(this.props.cursorTime!==e.cursorTime||i!==t.width||o)&&this.updatePlayhead(this.props.cursorTime),this.updateTracker(this.x(this.trackerX))}render(){return this.props.ranges.map(e=>{var t;return(0,E.fixMobxObserve)(e.start,e.end,e.selected,e.inSelection,e.highlighted,e.hidden,null==(t=e.style)?void 0:t.fillcolor)}),(0,E.fixMobxObserve)(this.props.range.map(Number),this.props.item.highlightedChannelId,this.props.item.isChannelHiddenMap,this.props.cursorTime),(0,ae.jsx)("div",{className:"htx-timeseries-channel",ref:this.ref})}}const Tg=(0,b.PA)(Ng);var _g=n(54357);const Ag="channelLegend--azMjV",Ig="hovering--ooSy6",Mg="channel--Zqgr7",Eg="hovered--EhZQC",Kg="channelMarker--TRv_u",Dg="hidden--d61yF",Og=(0,b.PA)(({item:e})=>{const{channels:t,highlightedChannelId:n,isChannelHiddenMap:i}=e;return(0,ae.jsx)("div",{className:(0,_g.A)(Ag,"flex justify-center gap-2 mb-2",{[Ig]:null!==n}),children:t.map(t=>{const o=!i[t.id],s=n===t.id;return(0,ae.jsxs)("div",{className:(0,_g.A)(Mg,"cursor-pointer select-none",{[Eg]:s}),onMouseEnter:()=>e.setHighlightedChannel(t.id),onMouseLeave:()=>e.clearHighlightedChannel(),onClick:n=>{n.preventDefault(),n.stopPropagation(),e.toggleChannelVisibility(t.id)},style:{"--marker-color":t.strokecolor},children:[(0,ae.jsx)("span",{className:(0,_g.A)(Kg,"mr-1",{[Dg]:!o})}),(0,ae.jsx)("span",{className:"channel-name",children:t.legend||t.columnName})]},t.id)})})}),Lg={grape:{base:"var(--color-accent-grape-base)"},blueberry:{base:"var(--color-accent-blueberry-base)"},kale:{base:"var(--color-accent-kale-base)"},kiwi:{base:"var(--color-accent-kiwi-base)"},mango:{base:"var(--color-accent-mango-base)"},canteloupe:{base:"var(--color-accent-canteloupe-base)"},persimmon:{base:"var(--color-accent-persimmon-base)"},plum:{base:"var(--color-accent-plum-base)"},fig:{base:"var(--color-accent-fig-base)"},sand:{bold:"var(--color-accent-sand-bold)"}},zg=["grape","mango","kale","persimmon","sand","kiwi","canteloupe","fig","plum","blueberry"],Bg=e=>{const t=zg[e%zg.length];return Lg[t]["sand"===t?"bold":"base"]},Fg=u.gK.model("MultiChannelModel",{id:u.gK.optional(u.gK.identifier,()=>Math.random().toString(36).slice(2)),type:"multichannel",children:je.unionArray(["channel"]),parentTypes:je.tagsTypes(["TimeSeries"]),height:u.gK.optional(u.gK.string,"200"),showaxis:u.gK.optional(u.gK.boolean,!0),showyaxis:u.gK.optional(u.gK.boolean,!0),fixedscale:u.gK.maybe(u.gK.boolean)}).volatile(e=>({isChannelHiddenMap:{},highlightedChannelId:null})).views(e=>({get channels(){return e.children.filter(e=>"channel"===e.type)},get margin(){var t,n;if(!e.showyaxis)return null==(t=e.parent)?void 0:t.margin;var i,o;return e.channels.filter(e=>e.showaxis&&e.showyaxis).length>1?Object.assign({},null==(i=e.parent)?void 0:i.margin,{right:null==(o=e.parent)?void 0:o.margin.left}):null==(n=e.parent)?void 0:n.margin}})).actions(e=>({afterCreate(){e.channels.forEach((e,t)=>{""===e.strokecolor&&(e.strokecolor=Bg(t)),""===e.markercolor&&(e.markercolor=Bg(t))})},toggleChannelVisibility(t){e.isChannelHiddenMap=Object.assign({},e.isChannelHiddenMap,{[t]:!e.isChannelHiddenMap[t]})},setHighlightedChannel(t){e.highlightedChannelId=t},clearHighlightedChannel(){e.highlightedChannelId=null}})),Hg=(0,b.PA)(({item:e})=>{var t,n,i,o,s,a,r;return null!=(t=e.parent)&&t.dataObj?(0,ae.jsxs)("div",{className:"htx-timeseries-multichannel",children:[(0,ae.jsx)("div",{className:"htx-timeseries-channel-legend-container",children:(0,ae.jsx)(Og,{item:e})}),(0,ae.jsx)(Tg,{time:null==(n=e.parent)?void 0:n.keyColumn,channels:e.channels,item:e,data:null==(i=e.parent)?void 0:i.dataObj,series:null==(o=e.parent)?void 0:o.dataHash,range:null==(s=e.parent)?void 0:s.brushRange,ranges:null==(a=e.parent)?void 0:a.regs,cursorTime:null==(r=e.parent)?void 0:r.cursorTime})]}):null}),Vg=u.gK.compose("MultiChannelModel",Vd,Fg);we.addTag("multichannel",Vg,Hg);const $g=u.gK.model({legend:"",units:"",displayformat:u.gK.optional(u.gK.string,".1f"),interpolation:u.gK.optional(u.gK.enumeration(Object.values({curvebasis:"curvebasis",curvebasisopen:"curveBasisOpen",curvebundle:"curveBundle",curvecardinal:"curveCardinal",curvecardinalopen:"curveCardinalOpen",curvecatmullrom:"curveCatmullRom",curvecatmullromopen:"curveCatmullRomOpen",curvelinear:"curveLinear",curvemonotonex:"curveMonotoneX",curvemonotoney:"curveMonotoneY",curvenatural:"curveNatural",curveradial:"curveRadial",curvestep:"curveStep",curvestepafter:"curveStepAfter",curvestepbefore:"curveStepBefore"})),"curveStep"),height:u.gK.optional(u.gK.string,"200"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(u.gK.string,""),markersize:u.gK.optional(u.gK.string,"0"),markercolor:u.gK.optional(u.gK.string,""),markersymbol:u.gK.optional(u.gK.string,"circle"),datarange:u.gK.maybe(u.gK.string),timerange:u.gK.maybe(u.gK.string),showaxis:u.gK.optional(u.gK.boolean,!0),showyaxis:u.gK.optional(u.gK.boolean,!0),fixedscale:u.gK.maybe(u.gK.boolean),column:u.gK.string}),Wg=u.gK.model("ChannelModel",Object.assign({},(0,Ne.VS)(Ne.cE)?{id:u.gK.identifier}:{id:u.gK.optional(u.gK.identifier,I)},{type:"channel",children:je.unionArray(["channel","view"]),parentTypes:je.tagsTypes(["TimeSeries"])})).views(e=>({get columnName(){let t=e.column;var n;/^\d+$/.test(t)&&(t=(null==(n=e.parent)?void 0:n.headers[t])||t);return t=t.toLowerCase(),t},get series(){var e;return null==(e=item.parent)?void 0:e.dataHash},get margin(){var t;return null==(t=e.parent)?void 0:t.margin}})),Ug=u.gK.compose("ChannelModel",Vd,Wg,$g),Gg=(0,b.PA)(({item:e})=>{var t,n,i,o,s,a,r;if(null==(t=e.parent)||!t.dataObj)return null;const l=(0,f.useMemo)(()=>[e],[e]);return(0,ae.jsx)(Tg,{time:null==(n=e.parent)?void 0:n.keyColumn,column:e.columnName,item:e,channels:l,data:null==(i=e.parent)?void 0:i.dataObj,series:null==(o=e.parent)?void 0:o.dataHash,range:null==(s=e.parent)?void 0:s.brushRange,ranges:null==(a=e.parent)?void 0:a.regs,cursorTime:null==(r=e.parent)?void 0:r.cursorTime})});we.addTag("channel",Ug,Gg);const Yg=u.gK.model({value:u.gK.string,valuetype:u.gK.optional(u.gK.enumeration(["url","json"]),"url"),timecolumn:"",sep:",",timeformat:"",timedisplayformat:"",durationdisplayformat:".0f",overviewchannels:"",overviewwidth:"25%",fixedscale:!1,multiaxis:u.gK.optional(u.gK.boolean,!1),hotkey:u.gK.maybeNull(u.gK.string),sync:u.gK.maybeNull(u.gK.string),cursorcolor:u.gK.optional(u.gK.string,"var(--color-neutral-inverted-surface)")}),Xg=u.gK.model("TimeSeriesBaseModel",{type:"timeseries",children:je.unionArray(["channel","timeseriesoverview","view","hypertext","multichannel"]),width:840,margin:u.gK.frozen({top:20,right:20,bottom:30,left:50,min:10,max:10}),brushRange:u.gK.array(u.gK.number),_needsUpdate:u.gK.optional(u.gK.number,0)}).volatile(()=>({data:null,valueLoaded:!1,zoomedRange:0,scale:1,headers:[],canvasWidth:0,seekTo:null,isPlaying:!1,playStartTime:null,playStartPosition:null,animationFrameId:null,playbackSpeed:1,cursorTime:null,suppressSync:!1})).views(e=>({get isNotReady(){return!(e.brushRange&&2===e.brushRange.length&&e.margin&&e.canvasWidth&&e.keysRange&&2===e.keysRange.length)},get regionsTimeRanges(){return(0,u._n)(e)?e.regs.map(e=>[e.start,e.end]):[]},get centerTime(){return e.brushRange&&2===e.brushRange.length?(e.brushRange[0]+e.brushRange[1])/2:null},get defaultOverviewWidth(){var t,n;return[0,Math.min(null!=(t=null==(n=e.overviewwidth.match(/(\d+)%$/))?void 0:n[1])?t:25,100)/100]},get store(){return(0,u.Zn)(e)},get isDate(){return Boolean(e.timeformat)||e.timedisplayformat&&/[a-zA-Z]/.test(e.timedisplayformat[0])},get keyColumn(){return(e.timecolumn||"#@$").toLowerCase()},get parseTimeFn(){return e.timeformat&&e.timecolumn?wg.GYh(e.timeformat):Number},get channelsMap(){const t={},n=[...e.children];let i;for(;i=n.shift();)"channel"===i.type?t[i.columnName]=i:n.push(...i.children);return t},get channels(){return Object.values(e.channelsMap)},parseTime(t){const n=(0,e.parseTimeFn)(t);return n instanceof Date?n.getTime():n},calculateInitialBrushRange(t){if(t.length<10)return[t[0],t[t.length-1]];const n=Math.round((t.length-1)*e.defaultOverviewWidth[0]),i=Math.round((t.length-1)*e.defaultOverviewWidth[1]);return i-n+1>=10?[t[n],t[i]]:e.expandRangeToMinimumPoints(t,[t[n],t[i]],10)},expandRangeToMinimumPoints(t,n,i){const o=Math.round((t.length-1)*e.defaultOverviewWidth[0]),s=Math.round((t.length-1)*e.defaultOverviewWidth[1]),a=i-(s-o+1);if(a<=0)return n;const r=Math.min(a,t.length-1-s),l=a-r,c=Math.max(0,o-l),d=Math.min(t.length-1,s+r);return[t[c],t[d]]},get dataObj(){if(!e.valueLoaded||!e.data)return null;let t=e.data;if(e.timecolumn){if(!e.timeformat&&isNaN(t[e.keyColumn][0])){const n=[`Looks like your <b>timeColumn</b> (${e.timecolumn}) contains non-numbers.`,"You have to use <b>timeFormat</b> parameter if your values are datetimes.",`First wrong values: ${t[e.keyColumn].slice(0,3).join(", ")}`,`<a href="${(0,u._$)(e).messages.URL_TAGS_DOCS}/timeseries.html#Parameters" target="_blank">Read Documentation</a> for details.`];throw new Error(n.join("<br/>"))}{let n=0,i=Number.NEGATIVE_INFINITY;const o=t[e.keyColumn].length,s=Array.from({length:o});let a=e.timeformat,r=!1;e.timeformat&&e.timeformat.includes("%f")&&(console.warn("TimeSeries: timeFormat contains %f (microseconds) which is not supported by D3. Converting microseconds to milliseconds and using %L instead. Consider updating your timeFormat to use %L and your data to use 3-digit milliseconds."),a=e.timeformat.replace("%f","%L"),r=!0);for(let l=0;l<o;l++){let o=t[e.keyColumn][l];if(e.timeformat){r&&"string"==typeof o&&(o=o.replace(/\.(\d{3})\d{3}$/,".$1")),"string"==typeof o&&o.includes(".")&&(o=o.replace(/\.(\d{0,3})\b/,(e,t)=>`.${t.padEnd(3,"0")}`));const t=(a?wg.GYh(a):wg.GYh(e.timeformat))(o);n=t instanceof Date?t.getTime():null===t?0:t}else n=o;if(s[l]=n,n<i){const n=[`seq: ${l-1}, value: ${t[e.keyColumn][l-1]}`,`seq: ${l}, value: ${o}`];throw new Error([`<b>timeColumn</b> (${e.timecolumn}) must be incremental and sequentially ordered.`,`First wrong values: ${n.join(", ")}`,`<br/><a href="${(0,u._$)(e).messages.URL_TAGS_DOCS}/timeseries.html" target="_blank">Read Documentation</a> for details.`].join("<br/>"))}i=n}if(s.slice(0,3).filter(e=>null===e||0===e||isNaN(e)).length>=2){const n=[`<b>timeColumn</b> (${e.timecolumn}) cannot be parsed.`,`First wrong values: ${t[e.keyColumn].slice(0,3).join(", ")}`];throw e.timeformat?(n.push(`Your <b>timeFormat</b>: ${e.timeformat}. It should be compatible with these values.`),e.timeformat.includes("%f")&&n.push("<b>Note:</b> %f (microseconds) is not supported by D3. Use %L (milliseconds) instead and convert your data to 3-digit milliseconds.")):n.push("You have to use <b>timeFormat</b> parameter if your values are datetimes."),n.push(`<br/><a href="${(0,u._$)(e).messages.URL_TAGS_DOCS}/timeseries.html#Parameters" target="_blank">Read Documentation</a> for details.`),new Error(n.join("<br/>"))}t=Object.assign({},t,{[e.keyColumn]:s})}}else{const n=Object.values(t)[0],i=Array.from({length:n.length},(e,t)=>t);t=Object.assign({},t,{[e.keyColumn]:i})}return t},get dataHash(){const t=e.dataObj,{keyColumn:n}=e;if(!t)return null;const i=Object.keys(t),o=[];for(const s of i)for(let i=0;i<t[s].length;i++)o[i]?o[i][s]=t[s][i]:o[i]={[s]:t[s][i]},e.timecolumn||(o[i][n]=i);return o},get slicesCount(){return 10},get dataSlices(){if(e.slices)return e.slices;const t=e.slicesCount,n=e.dataHash,i=Math.floor(n.length/t),o=[];for(let e=0;e<t-1;e++)o[e]=n.slice(i*e,i*e+i+1);return o.push(n.slice(i*(t-1))),e.slices=o,o},get keysRange(){var t;const n=null==(t=e.dataObj)?void 0:t[e.keyColumn];return null!=n&&n.length?[n[0],n[n.length-1]]:[]},get persistentValues(){return{brushRange:e.brushRange,initialRange:e.initialRange,scale:e.scale+1e-4}},get persistentFingerprint(){var t;return{task:null==(t=(0,u.Zn)(e).task)?void 0:t.id}},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t?t.filter(e=>e.isSelected&&"TimeSeriesLabelsModel"===(0,u.Pw)(e).name):null},formatTime(t){if(!e._format){const{timedisplayformat:t,isDate:n}=e;e._format="date"===t?Rg:t?n?wg.aLc(t):wg.GPZ(t):String}return e._format(t)},formatDuration(t){if(!e._formatDuration){const{durationdisplayformat:t,isDate:n}=e;e._formatDuration=t?n?wg.aLc(t):wg.GPZ(t):String}return e._formatDuration(t)}})).actions(e=>({afterCreate(){e.channels.forEach((e,t)=>{""===e.strokecolor&&(e.strokecolor=Bg(t)),""===e.markercolor&&(e.markercolor=Bg(t))})},setData(t){e.data=t,e.valueLoaded=!0},setColumnNames(t){e.headers=t},setZoomedRange(t){e.zoomedRange=t},setScale(t){e.scale=t},updateCanvasWidth(t){e.canvasWidth=t},updateView(){e._needsUpdate=e._needsUpdate+1},resetSeekTo(){e.seekTo=null},setSuppressSync(t){e.suppressSync=t},setCursorAndSeek(t){e.cursorTime=t,e.seekTo=t},setCursor(t){e.cursorTime=t},restartPlaybackFromTime(t){if(!e.isPlaying)return;e.animationFrameId&&(cancelAnimationFrame(e.animationFrameId),e.animationFrameId=null);const[n]=e.keysRange;let i;i=e.isDate?(t-n)/1e3:t-n,e.playStartPosition=i,e.playStartTime=performance.now(),e.playbackLoop()},scrollToRegion(t){const n=[...e.brushRange];if(t.start>=n[0]&&t.end<=n[1])return;const i=n[1]-n[0],o=t.end-t.start,s=1.5*o,a=(s-o)/2;if(i<s){const e=(s-i)/2;n[0]-=e,n[1]+=e}t.start<n[0]&&(n[1]-=n[0]-(t.start-a),n[0]=t.start-a),t.end>n[1]&&(n[0]+=t.end+a-n[1],n[1]=t.end+a),n[0]=Math.max(e.keysRange[0],n[0]),n[1]=Math.min(e.keysRange[1],n[1]),e.updateTR(n,e.scale+1e-4)},updateTR(t,n=1){null!==t&&(e.initialRange=t,e.brushRange=t,e.setZoomedRange(t[1]-t[0]),e.setScale(n),e.updateView(),e.emitSeekSync())},throttledRangeUpdate:()=>ec()(e.updateTR,100),addRegion(t,n){const i=e.getAvailableStates();if(0===i.length)return;const[o,...s]=i,a={[o.valueType]:o.selectedValues()};return He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult({start:t,end:n,instant:t===n},a,o,e,!1,s):e.annotation.createResult({start:t,end:n,instant:t===n},a,o,e,!1)},regionChanged(t,n){const i=e.regs[n];let o=!1;if(i)o=i.start!==t.start||i.end!==t.end,i.updateRegion(t.start,t.end);else{o=!0,e.addRegion(t.start,t.end).notifyDrawingFinished()}o&&e.updateView()},async preloadValue(t){const n=t.task.dataObj;if("url"!==e.valuetype)return void(e.value?e.setData(Oe(e.value,n)):e.setData(n));if(!e.value){const n=`Attribute <b>value</b> for <b>${e.name}</b> should be provided when <b>valuetype="url"</b>`;return void t.annotationStore.addErrors([Os.generalError(n)])}const i=Oe(e.value,n);if(!i||"string"!=typeof i){const n=`Cannot find url in <b>${o=e.value,o.substr(1)}</b> field of your task`;return void t.annotationStore.addErrors([Os.generalError(n)])}var o;let s,a="",r=!1;try{if(s=await fetch(i),!s.ok){if(400===s.status)return void t.annotationStore.addErrors([Os.loadingError(`${s.status} ${s.statusText}`,i,e.value,(0,u._$)(t).messages.ERR_LOADING_S3)]);throw new Error(`${s.status} ${s.statusText}`)}a=await s.text()}catch(n){let o=n;if(!s)try{s=await fetch(i,{mode:"no-cors"}),s.ok||0!==s.status||(r=!0)}catch(e){o=e}return void t.annotationStore.addErrors([Os.loadingError(o,i,e.value,r?(0,u._$)(t).messages.ERR_LOADING_CORS:void 0)])}try{let n=(e=>{if((0,E.isString)(e)&&"{"===e[0])try{return JSON.parse(e)}catch(e){}return!1})(a),i=[];if(!n){var l;let t=e.sep;if((null==(l=t)?void 0:l.length)>1){t={tab:"\t","\\t":"\t",space:" ",auto:"auto",comma:",",dot:"."}[t]||t[0]}[n,i]=((e,t="auto")=>{const n=e.split("\n");let i;if("auto"!==t&&!n[0].includes(t))throw new Error([`Cannot find provided separator "${t}".`,`Row 1: ${n[0]}`].join("\n"));if("auto"===t&&n.length>1){const e=n[1].trim().match(/[,;\s\t]/g);if(!e.length)throw new Error("No separators found");if(e.some(t=>t!==e[0])){const t=Array.from(new Set(e)).map(E.escapeHtml).map(e=>`"${e}"`).join(", ");throw new Error([`More than one possible separator found: ${t}`,'You can provide correct one with <Timeseries sep=",">'].join("\n"))}if(t=e[0],n[0].split(t).length!==n[1].split(t).length)throw new Error(["Different amount of elements in rows.",`Row 1: ${n[0]}`,`Row 2: ${n[1]}`,`Guessed separator: ${t}`,'You can provide correct one with <Timeseries sep=",">'].join("\n"))}const o=new RegExp(['"(?:""|[^"])*"',`[^"${t}]+`,`(?=${t}(?:${t}|$))`,`^(?=${t})`].join("|"),"g"),s=e=>e.trim().match(o);i=s(n[0]);const a=s(n[1]);i.every((e,t)=>isNaN(e)===isNaN(a[t]))?i=i.map((e,t)=>String(t)):(n.shift(),i=i.map(e=>e.toLowerCase()));const r={};for(const e of i)r[e]=[];if(i.length!==s(n[0]).length)throw new Error(["Column names count differs from data columns count.",`Columns: ${i.join(", ")};`,`Data: ${n[0]};`,`Separator: "${t}".`].join("\n"));let l,c;for(const e of n)if(e.trim())for(l=s(e),c=0;c<l.length;c++){const e=+l[c];r[i[c]].push(isNaN(e)?l[c]:e)}return[r,i]})(a,t)}if(!(0,u._n)(e))return;e.setData(n),e.setColumnNames(i),e.updateValue(t)}catch(e){const n=`Problems with parsing CSV: ${(null==e?void 0:e.message)||e}<br>URL: ${i}`;t.annotationStore.addErrors([Os.generalError(n)])}},async updateValue(t){var n;let i;try{e.dataObj||await e.preloadValue(t),i=e.dataObj}catch(e){return void t.annotationStore.addErrors([Os.generalError(e.message)])}if(!i)return;const o=i[e.keyColumn];if(!o){const n=[`<b>${e.keyColumn}</b> not found in data.`,'Use <b>valueType="url"</b> for data loading or column index for headless csv'].join(" ");return void t.annotationStore.addErrors([Os.generalError(n)])}if(null!=(n=e.brushRange)&&n.length)return;const s=e.calculateInitialBrushRange(o);e.updateTR(s)},onHotKey(){},_handleSeek(t){if(!(0,u._n)(e))return void console.warn("TimeSeries (seek): model instance is not alive. Skipping operation.");if("number"!=typeof t.time||isNaN(t.time))return;const[n]=e.keysRange;if(void 0===n)return;let i;i=e.isDate?n+1e3*t.time:n+t.time,e.isPlaying&&(e.animationFrameId&&(cancelAnimationFrame(e.animationFrameId),e.animationFrameId=null),e.playStartPosition=t.time,e.playStartTime=performance.now(),e.playbackLoop()),e._updateViewForTime(i)},_handlePlay(t){(0,u._n)(e)?"number"!=typeof t.time||isNaN(t.time)||(e.isPlaying=!0,e.playStartTime=performance.now(),e.playStartPosition=t.time,e.playbackSpeed=t.speed||1,e.animationFrameId&&cancelAnimationFrame(e.animationFrameId),e.playbackLoop()):console.warn("TimeSeries (play): model instance is not alive. Skipping operation.")},_handlePause(t){if(!(0,u._n)(e))return void console.warn("TimeSeries (pause): model instance is not alive. Skipping operation.");e.isPlaying=!1,e.playStartTime=null,e.playStartPosition=null,e.animationFrameId&&(cancelAnimationFrame(e.animationFrameId),e.animationFrameId=null);const[n]=e.keysRange;if(void 0===n||void 0===t.time)return;let i;i=e.isDate?n+1e3*t.time:n+t.time,e._updateViewForTime(i)},playbackLoop(){if(!(0,u._n)(e))return;if(!e.isPlaying||null===e.playStartTime||null===e.playStartPosition)return void(e.animationFrameId=null);const t=(performance.now()-e.playStartTime)/1e3,n=e.playStartPosition+t*e.playbackSpeed,[i,o]=e.keysRange;if(void 0===i||void 0===o)return void(e.isPlaying=!1);let s;return s=e.isDate?i+1e3*n:i+n,s>=o?(e.isPlaying=!1,e.playStartTime=null,e.playStartPosition=null,e.animationFrameId&&(cancelAnimationFrame(e.animationFrameId),e.animationFrameId=null),void e._updateViewForTime(o)):s<=i?(e.isPlaying=!1,e.playStartTime=null,e.playStartPosition=null,e.animationFrameId&&(cancelAnimationFrame(e.animationFrameId),e.animationFrameId=null),void e._updateViewForTime(i)):(e._updateViewForTime(s),void(e.animationFrameId=requestAnimationFrame(e.playbackLoop)))},_updateViewForTime(t){if(!(0,u._n)(e))return;if(null===t||!Number.isFinite(t))return;const[n,i]=e.keysRange;if(void 0===n||void 0===i||e.canvasWidth<=0)return;const o=Math.max(n,Math.min(i,t)),s=i-n;if(s<=0)return;const a=(o-n)/s*e.canvasWidth;let r=e.brushRange[1]-e.brushRange[0];if(r<=0&&(r=.1*s,r<=0))return;const l=r/s*e.canvasWidth;if(l<=0)return;let c=a-l/2,d=a+l/2;if(c<0){const t=d-c;c=0,d=Math.min(t,e.canvasWidth)}if(d>e.canvasWidth){const t=d-c;d=e.canvasWidth,c=Math.max(0,e.canvasWidth-t)}if(c=Math.max(0,c),d=Math.min(e.canvasWidth,d),c>=d){const t=Math.max(10,.1*e.canvasWidth);if(c=a-t/2,d=a+t/2,c<0&&(d-=c,c=0),d>e.canvasWidth&&(c-=d-e.canvasWidth,d=e.canvasWidth),c=Math.max(0,c),d=Math.min(e.canvasWidth,d),c>=d)return}let h=n+c/e.canvasWidth*s,g=n+d/e.canvasWidth*s;(!Number.isFinite(h)||!Number.isFinite(g)||h>=g)&&(h=o-r/2,g=o+r/2,h<n&&(g-=h-n,h=n),g>i&&(h-=g-i,g=i),h=Math.max(n,h),g=Math.min(i,g),!Number.isFinite(h)||!Number.isFinite(g)||h>=g)||Number.isFinite(h)&&Number.isFinite(g)&&(e.updateTR([h,g],e.scale),e.seekTo=o,e.cursorTime=o)},registerSyncHandlers(){(0,u._n)(e)&&(e.syncHandlers.set("seek",e._handleSeek),e.syncHandlers.set("play",e._handlePlay),e.syncHandlers.set("pause",e._handlePause))},emitSeekSync(){if(!(0,u._n)(e))return;if(e.suppressSync)return;const t=e.centerTime;if(null!==t&&e.sync&&!e.isPlaying){const[n]=e.keysRange;if(void 0===n)return;let i;i=e.isDate?(t-n)/1e3:t-n,e.syncSend({time:i,playing:e.isPlaying},"seek")}},plotClickHandler(t){if(!(0,u._n)(e)||!e.sync)return;if(e.isNotReady)return;const[n,i]=e.keysRange,o=Math.max(n,Math.min(t,i));let s;e.brushRange&&o>=e.brushRange[0]&&o<=e.brushRange[1]?e.setCursor(o):"function"==typeof e._updateViewForTime&&e._updateViewForTime(o),e.isPlaying&&e.restartPlaybackFromTime(o),s=e.isDate?(o-n)/1e3:o-n,e.syncSend({time:s,playing:e.isPlaying},"seek")}}));const qg=(0,b.PA)(({item:e,data:t,series:n})=>{const i=e.regs,[o,s,a]=function(){const[e,t]=f.useState(840),[n,i]=f.useState(null),o=f.useCallback(e=>{i(e)},[]);return f.useLayoutEffect(()=>{if(n){const e=()=>t(n.offsetWidth);return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}},[n]),[o,e,n]}(),r=60,{margin:l,keyColumn:c}=e,d=Math.max(s-l.left-l.right,0);let h=Object.keys(e.channelsMap);if(e.overviewchannels){const t=e.overviewchannels.toLowerCase().split(",").map(t=>/^\d+$/.test(t)?e.headers[t]:t).filter(e=>h.includes(e));t.length&&(h=t)}const g=f.useRef(),m=f.useRef(),p=f.useRef(),v=f.useRef(),y=f.useRef(),b=f.useRef(),x=(e.isDate?wg.w7C():wg.m4Y()).domain(wg.Xxv(t[c])).range([0,d]),w=f.useCallback(e.throttledRangeUpdate(),[]),S=[0,d>>2],C=f.useRef(S),k=10;let P;const R=wg.n55().extent([[0,0],[d,r]]).on("start",function(){const[t,n]=wg.f0J.selection;P=t===n?t:null,e.setSuppressSync(!0)}).on("brush",function(){if(wg.f0J.selection&&!Pg("brush")&&!Pg("wheel")){let[t,n]=wg.f0J.selection;const i=C.current,o=n-t;let s=+x.invert(t),a=+x.invert(n);if(i[0]===t&&i[1]===n);else if(i[0]!==t&&i[1]!==n&&Math.abs(o-k)<.001){const t=(s+a)/2;s=t-e.zoomedRange/2,a=t+e.zoomedRange/2}else o<k&&(i[0]!==t&&i[1]!==n&&(i[0]===n||i[1]===t?[i[0],i[1]]=[i[1],i[0]]:t===P?(n=Math.min(d,t+k),t=Math.max(0,n-k)):(t=Math.max(0,n-k),n=Math.min(d,t+k))),i[0]===t?(n=Math.min(d,t+k),t=Math.max(0,n-k)):i[1]===n&&(t=Math.max(0,n-k),n=Math.min(d,t+k)),s=+x.invert(t),a=+x.invert(n),y.current.call(R.move,[t,n]));C.current=[t,n],w([s,a])}}).on("end",function(){if(!wg.f0J.selection){const t=wg.grR(this)[0],n=e.brushRange.map(x),i=n[1]-n[0]>>1;let o=[t-i,t+i];o[0]<0&&(o=[0,2*i]),o[1]>d&&(o=[d-2*i,d]),y.current.call(R.move,o)}setTimeout(()=>e.setSuppressSync(!1),0)}),j=i=>{const o=e.channelsMap[i],s=o?o.strokecolor:"steelblue",a=wg.m4Y().domain([wg.jkA(t[i]),wg.T9B(t[i])]).range([r-l.max,l.min]);p.current.append("path").datum(Cg(n,Sg())).attr("class","channel").attr("fill","none").attr("stroke",s).attr("d",wg.n8j().y(e=>a(e[i])).defined(e=>e[c]).x(e=>x(e[c])))};return f.useEffect(()=>{if(!a)return;g.current=wg.Ltv(a).append("svg").attr("viewBox",[0,0,d+l.left+l.right,r+l.bottom]).style("display","block").append("g").attr("transform",`translate(${l.left},0)`),v.current=g.current.append("g").attr("transform","translate(0,60)"),p.current=g.current.append("g").attr("class","channels"),m.current=g.current.append("g").attr("class","regions"),y.current=g.current.append("g").call(R).call(R.move,S),y.current.select(".handle--w").style("transform","translate(-1px, 0)"),y.current.select(".handle--e").style("transform","translate(1px, 0)"),b.current=g.current.append("g").attr("class","overview-playhead").attr("pointer-events","none").style("display","none");const t=e.cursorcolor||"var(--color-neutral-inverted-surface)";b.current.append("line").attr("y1",5).attr("y2",r).attr("stroke",t).attr("stroke-width",2),b.current.append("polygon").attr("points","-4,0 4,0 4,7 1,10 -1,10 -4,7").attr("fill",t)},[a]),f.useEffect(()=>{if(a){wg.Ltv(a).selectAll("svg").attr("viewBox",[0,0,d+l.left+l.right,r+l.bottom]),p.current.selectAll("path").remove();for(const t of Object.keys(e.channelsMap))j(t);v.current.call(wg.l78(x).ticks(d/80).tickSizeOuter(0)),y.current.call(R).call(R.move,e.brushRange.map(x))}},[d,a]),f.useEffect(()=>{if(!y.current)return;const t=e.brushRange.map(x);if(t[1]-t[0]<k){const e=(t[1]+t[0])/2;t[0]=Math.max(0,e-5),t[1]=Math.min(d,e+5)}C.current=t,y.current.call(R.move,t)},[e.scale]),f.useEffect(()=>{a&&(e=>{const t=m.current.selectAll(".region").data(e);t.enter().append("rect").attr("class","region").merge(t).attr("y",0).attr("height",r).attr("x",e=>x(e.start)).attr("width",e=>Math.max(2,x(e.end)-x(e.start))).attr("fill",e=>kg(e,e.selected?.8:.3)).style("display",e=>e.hidden?"none":"block"),t.exit().remove()})(i)}),f.useEffect(()=>{if(null!==e.seekTo&&y.current&&(0,u._n)(e)){const t=e.seekTo,[n,i]=e.keysRange,o=(t-n)/(i-n)*d,s=e.brushRange.map(x),a=(s[1]-s[0])/2;let r=[o-a,o+a];r[0]<0&&(r=[0,2*a]),r[1]>d&&(r=[d-2*a,d]),y.current.call(R.move,r),e.resetSeekTo()}},[e.seekTo,d]),f.useEffect(()=>{if(!b.current)return;const t=e.cursorTime;if(null===t||!Number.isFinite(t))return void b.current.style("display","none");const n=x(t);Number.isFinite(n)?b.current.attr("transform",`translate(${n},0)`).style("display","block"):b.current.style("display","none")},[e.cursorTime,d]),e.regs.map(e=>{var t;return(0,E.fixMobxObserve)(e.start,e.end,e.selected,e.hidden,null==(t=e.style)?void 0:t.fillcolor)}),(0,ae.jsx)("div",{className:"htx-timeseries-overview",ref:o})}),Zg=u.gK.compose("TimeSeriesModel",Ue,gn,jg,Te,Yg,Xg),Jg=(0,b.WQ)("store")((0,b.PA)(({item:e})=>{var t;const n=f.createRef();return f.useEffect(()=>{var t;if(null!=e&&null!=(t=e.brushRange)&&t.length){e._nodeReference=n.current;const t=()=>{n.current&&e.updateCanvasWidth(n.current.offsetWidth)};return t(),window.addEventListener("resize",t),()=>{window.removeEventListener("resize",t)}}},[e,n]),null!=e&&null!=(t=e.brushRange)&&t.length&&e.data?(0,ae.jsx)("div",{ref:n,className:"htx-timeseries",children:(0,ae.jsxs)(Es,{item:e,children:[st.renderChildren(e,e.annotation),(0,ae.jsx)(qg,{data:e.dataObj,series:e.dataHash,item:e,range:e.brushRange})]})}):(0,ae.jsx)("div",{style:{textAlign:"center",height:100},children:(0,ae.jsx)(y.A,{size:"large",delay:300})})}));we.addTag("timeseries",Zg,Jg),we.addObjectType(Zg);const Qg=u.gK.model({id:u.gK.identifier,type:"pagedview",children:je.unionArray(["view","header","labels","label","table","taxonomy","choices","choice","collapse","datetime","number","rating","ranker","rectangle","ellipse","polygon","keypoint","brush","magicwand","rectanglelabels","ellipselabels","polygonlabels","vectorlabels","keypointlabels","brushlabels","bitmasklabels","hypertextlabels","timeserieslabels","text","audio","image","hypertext","richtext","timeseries","audioplus","list","dialog","textarea","pairwise","style","label","relations","filter","timeseries","timeserieslabels","pagedview","paragraphs","paragraphlabels","video","videorectangle"])}),em=u.gK.compose("PagedViewModel",Qg,Te),tm="view_page",nm=Fn("Repeater"),im=`.${(0,Nn.cn)("sidepanels").elem("content").toClassName()}`,om=[1,5,10,25,50,100],sm=()=>{const e=new URLSearchParams(window.location.search).get(tm);return e?Number.parseInt(e):1};let am=null;const rm=(e,t=null)=>{const n=new URLSearchParams(window.location.search),i=am&&t!==am;am=t,i?n.delete(tm):1!==e?n.set(tm,e.toString()):n.delete(tm),window.history.replaceState(void 0,void 0,`${window.location.pathname}?${n}`)},lm=(0,b.PA)(({item:e})=>{const[t,n]=(0,f.useState)(sm),[i,o]=(0,f.useState)(1),s=(0,f.useCallback)(t=>{var i;n(t),rm(t,null==(i=e.annotationStore)||null==(i=i.store)?void 0:i.task.id)},[]),a=Math.ceil(e.children.length/i);(0,f.useEffect)(()=>{o(((e,t)=>{const n=localStorage.getItem(`pages:${e}`);return n?Number.parseInt(n):null!=t?t:void 0})("repeater",1))},[]),(0,f.useEffect)(()=>{const t=e.annotation.lastSelectedRegion;if(t){const e=Number.parseFloat(t.object.name.split("_")[1])+1;s(Math.ceil(e/i))}},[e.annotation.lastSelectedRegion]),(0,f.useEffect)(()=>{var e;return null==(e=document.querySelector(im))||e.scrollTo(0,0),setTimeout(()=>{nm.addNamed("repeater:next-page",()=>{t<a&&s(t+1)}),nm.addNamed("repeater:previous-page",()=>{t>1&&s(t-1)})}),()=>{nm.removeNamed("repeater:next-page"),nm.removeNamed("repeater:previous-page")}},[t]),(0,f.useEffect)(()=>{var t;return rm(sm(),null==(t=e.annotationStore)||null==(t=t.store)?void 0:t.task.id),()=>{var t;rm(1,null==(t=e.annotationStore)||null==(t=t.store)?void 0:t.task.id)}},[]);const r=(0,f.useCallback)(()=>{const n=[];for(let o=0;o<i;o++)n.push(st.renderChildren(e.children[o+i*(t-1)],e.annotation));return n},[t,i]);return(0,ae.jsxs)("div",{children:[r(),(0,ae.jsx)(qs,{currentPage:t,totalPages:a,pageSize:i,pageSizeOptions:om,pageSizeSelectable:!1,size:"medium",onChange:(t,n=i)=>{e.annotation.unselectAll(),s(t),n!==i&&(((e,t)=>{localStorage.setItem(`pages:${e}`,t.toString())})("repeater",n),o(n))}})]})});we.addTag("pagedview",em,lm);const cm=f.createContext(),dm=["name","children","label","icon","to","className","href","danger","exact","forceReload","active","onClick"],um=(0,f.forwardRef)(({children:e,className:t,style:n,size:i,selectedKeys:o,closeDropdownOnItemClick:s,allowClickSelected:a},r)=>{const l=(0,Pn.BKH)(),c=(0,f.useMemo)(()=>new Set(null!=o?o:[]),[o]),d=(0,f.useCallback)(e=>{const t=(0,Nn.cn)("menu").elem("item").closest(e.target);l&&t&&!1!==s&&l.close()},[l]),u=(0,f.useMemo)(()=>!!l,[l]),h=(0,f.useMemo)(()=>({selected:c,allowClickSelected:a}),[c,a]);return(0,ae.jsx)(cm.Provider,{value:h,children:(0,ae.jsx)("ul",{ref:r,className:(0,Nn.cn)("menu").mod({size:i,collapsed:u}).mix(t).toClassName(),style:n,onClick:d,children:e})})});um.Item=e=>{let{name:t,children:n,label:i,icon:o,to:s,className:a,href:r,danger:l,exact:c=!1,forceReload:d=!1,active:u=!1,onClick:h}=e,g=(0,Se.A)(e,dm);const{selected:m,allowClickSelected:p}=f.useContext(cm),v=(0,Nn.cn)("menu",{elem:"item"}),y=(()=>{const e=window.location.pathname.replace(/\/$/,""),n=null!=s?s:r;return!!m.has(t)||(c?e===n:e.includes(n))})(),b=(0,f.useMemo)(()=>(0,ae.jsxs)(ae.Fragment,{children:[o&&(0,ae.jsx)("span",{className:v.elem("item-icon"),children:o}),null!=n?n:i]}),[n,i,o]),x=Object.assign({className:v.mod({active:y||u,look:l&&"danger",clickable:p}).mix(a),onClick:h},g);return d&&(x.onClick=()=>window.location.href=null!=s?s:r),(0,ae.jsx)("li",{children:r?(0,ae.jsx)("a",Object.assign({href:null!=r?r:"#"},x,{children:b})):(0,ae.jsx)("div",Object.assign({},x,{children:b}))})},um.Spacer=()=>(0,ae.jsx)("li",{className:(0,Nn.cn)("menu",{elem:"spacer"})}),um.Divider=()=>(0,ae.jsx)("li",{className:(0,Nn.cn)("menu",{elem:"divider"})}),um.Builder=(e,t)=>(null!=t?t:[]).map((t,n)=>{if("SPACER"===t)return(0,ae.jsx)(um.Spacer,{},n);if("DIVIDER"===t)return(0,ae.jsx)(um.Divider,{},n);const[i,o]=t,s=`${e}${i}`.replace(/([/]+)/g,"/");return(0,ae.jsx)(um.Item,{to:s,exact:!0,children:o},n)}),um.Group=({children:e,title:t,className:n,style:i})=>{const o=(0,Nn.cn)("menu-group");return(0,ae.jsxs)("li",{className:o.mix(n),style:i,children:[(0,ae.jsx)("div",{className:o.elem("title"),children:t}),(0,ae.jsx)("ul",{className:o.elem("list"),children:e})]})};const hm="videoConfig--EopjZ",gm="modal--saPZR",mm="toggle--T41WA",pm="scrollContent--auB8x",fm="sectionHeader--RA1eP",vm=({configModal:e,onSetModal:t,speed:n,onSpeedChange:i,loopTimelineRegion:o,onLoopTimelineRegionChange:s,minSpeed:a=.25})=>{const r=(0,f.useRef)(null),l=(0,f.useRef)(null),c=(0,f.useCallback)(n=>{e&&r.current&&l.current&&!r.current.contains(n.target)&&!l.current.contains(n.target)&&(null==t||t(!1))},[e,t]),d=(0,f.useCallback)(n=>{n.preventDefault(),n.stopPropagation(),null==t||t(!e)},[e,t]),u=(0,f.useCallback)(e=>{e.stopPropagation()},[]);(0,f.useEffect)(()=>(e?document.addEventListener("click",c):document.removeEventListener("click",c),()=>{document.removeEventListener("click",c)}),[e,c]),(0,f.useEffect)(()=>{if(e&&r.current&&l.current){const e=l.current.getBoundingClientRect(),t=r.current;t.style.opacity="0",t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px";requestAnimationFrame(()=>{if(!r.current||!l.current)return;const n=t.getBoundingClientRect(),i=window.innerHeight,o=window.innerWidth,s=10;let a=e.bottom+5,c=e.left;if(a+n.height>i-s){const t=e.top-n.height-5;a=t>s?t:i-n.height-s}a<s&&(a=s),c+n.width>o-s&&(c=o-n.width-s),c<s&&(c=s),t.style.top=`${a}px`,t.style.left=`${c}px`,t.style.opacity="1"})}else r.current&&(r.current.style.opacity="0")},[e]);const g=e=>{const t=Number.parseFloat(e.currentTarget.value);isNaN(t)||i(t)};return(0,ae.jsxs)("div",{className:hm,ref:l,onClick:u,children:[(0,ae.jsx)(ki,{look:e?"filled":void 0,onClick:d,"aria-label":"Video settings",children:(0,ae.jsx)(kn.sKi,{})}),e&&(()=>{const e=(0,ae.jsx)("div",{className:gm,ref:r,onClick:e=>e.stopPropagation(),style:{opacity:0,position:"fixed"},children:(0,ae.jsxs)("div",{className:pm,children:[(0,ae.jsx)("div",{className:fm,children:"Playback Settings"}),(0,ae.jsx)(Qn,{min:a,max:10,step:.05,value:n,description:"Playback speed",info:"Increase or decrease the playback speed",onChange:g}),(0,ae.jsx)("div",{className:mm,children:(0,ae.jsx)(Pn.lMk,{checked:o,onChange:e=>s(e.target.checked),label:"Loop Timeline Regions",labelProps:{size:"small"}})})]})});return"undefined"!=typeof document?(0,h.createPortal)(e,document.body):null})()]})},ym=e=>{const t=(0,f.useRef)(e);return(0,f.useEffect)(()=>{Object.assign(t.current,e)},[e]),t.current};var bm=n(17228),xm=n.n(bm);const wm=["position","length","seekOffset","seekVisible","onIndicatorMove","onSeek","minimap","step"],Sm=e=>{var t;let{position:n,length:i,seekOffset:o,seekVisible:s,onIndicatorMove:a,onSeek:r,minimap:l,step:c}=e;const d=(null!=(t=(0,Se.A)(e,wm).leftOffset)?t:150)/c,u=(0,f.useRef)(),h=(0,f.useRef)(),g=(0,f.useRef)(),m=s>0,p=(Math.ceil(s)-Math.floor(d)+1.5)/i*100+"%",v=i-(s-d),y=Math.min(o,v)/i*100+"%",b=n/i*100,x=(0,f.useCallback)(e=>{const t=g.current,n=u.current.getBoundingClientRect(),o=t.clientWidth,s=e.pageX,r=s-n.left-o/2,l=n.width,c=l-o,d=xm()(Math.ceil(i*(r/l)),0,c);null==a||a(d);const h=e=>{const t=xm()(r+(e.pageX-s),0,c)/l;null==a||a(Math.ceil(i*t))},m=()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",m)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",m)},[i]),w=(0,f.useCallback)(e=>{const t=h.current,n=u.current.getBoundingClientRect(),o=t.clientWidth,s=e.pageX,a=s-n.left-o/2,l=n.width,c=e=>{const n=l-t.clientWidth,o=xm()(a+(e.pageX-s),0,n)/l,c=Math.ceil(i*o);null==r||r(c)};c(e);const d=e=>{c(e)},g=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",g)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",g)},[i]),S=(0,f.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),e.target===g.current?x(e):w(e)},[x,w]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("seeker").toClassName(),ref:u,onMouseDown:S,children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("seeker").elem("track").toClassName()}),m&&(0,ae.jsx)("div",{className:(0,Nn.cn)("seeker").elem("indicator").toClassName(),ref:g,style:{left:y,width:p}}),(0,ae.jsx)("div",{className:(0,Nn.cn)("seeker").elem("position").toClassName(),ref:h,style:{left:`${b}%`}}),(0,ae.jsx)("div",{className:(0,Nn.cn)("seeker").elem("minimap").toClassName(),children:l})]})},Cm=16,km=(e,t)=>{const{width:n,height:i}=t[0].contentRect;return{width:n,height:i}},Pm=(e,t)=>{if(0===t.length)return{};const{width:n,height:i}=e[0].getBoundingClientRect();return{width:n,height:i}};function Rm(e,t={}){const n=Array.isArray(e)?e:[e],{extractSize:i=(1===n.length?km:Pm),debounceMs:o=Cm}=t,[s,a]=(0,f.useState)({}),r=(0,f.useRef)(null),l=(0,f.useRef)(null),c=(0,f.useRef)(null),d=(0,f.useRef)(null),u=(0,f.useCallback)(e=>{l.current&&clearTimeout(l.current),c.current&&cancelAnimationFrame(c.current),l.current=window.setTimeout(()=>{c.current=requestAnimationFrame(()=>{try{const t=i(d.current,e);a(e=>e===t?e:JSON.stringify(e)!==JSON.stringify(t)?t:e)}catch(e){console.warn("Error in resize observer callback: ",e)}c.current=null}),l.current=null},o)},[i,o]);return(0,f.useEffect)(()=>{const t=Array.isArray(e)?e:[e];if(0!==t.length)return r.current=new ResizeObserver(u),t.forEach(e=>{var t;null==(t=r.current)||t.observe(e)}),d.current=t,()=>{r.current&&(r.current.disconnect(),r.current=null),l.current&&(clearTimeout(l.current),l.current=null),c.current&&(cancelAnimationFrame(c.current),c.current=null)};a({})},[e,u]),null!=s?s:{}}const jm=(e,t,n=!1)=>{if(0===e.length)return[];const i=[],o=e[0].frame-1;for(let s=0,a=e.length;s<a;s++){const a=i[i.length-1],r=e[s],l=e[s-1],c=(r.frame-o-1)*t;a&&null!=a&&a.enabled?null!=l&&l.enabled&&(a.width=(r.frame-a.points[0].frame)*t,a.length=r.frame-a.start,a.enabled=r.enabled,a.points.push(r)):i.push({offset:c,width:0,length:0,enabled:r.enabled,start:r.frame,points:[r],locked:n})}return i},Nm=["points"],Tm=({idx:e,region:t,startOffset:n,renderable:i,onSelectRegion:o})=>{const{step:s,seekOffset:a,visibleWidth:r,length:l}=(0,f.useContext)(Sn),{label:c,color:d,visible:u,sequence:h,selected:g,timeline:m,locked:p}=t,v=(0,f.useMemo)(()=>Math.round(r/2),[r]),y=(0,f.useMemo)(()=>(0,E.clamp)(a-v,0,l),[a,v,l]),b=(0,f.useMemo)(()=>(0,E.clamp)(a+r+v,0,l),[a,r,v,l]),x=h[0],w=x?x.frame-1:0,S=x?w*s:n,C=(0,f.useMemo)(()=>({"--offset":`${n}px`,"--color":d,"--point-color":(0,ft.A)(d).alpha(1).css(),"--lifespan-color":(0,ft.A)(d).alpha(u?.4:1).css()}),[n,d,u]),k=(0,f.useMemo)(()=>i?jm(h,s,p).map(e=>(e.points=e.points.filter(({frame:e})=>e>=y&&e<=b),e)):[],[h,w,s,i,y,b,p]),P=(0,f.useCallback)((e,n)=>{e.stopPropagation(),null==o||o(e,t.id,n)},[t.id,o]),R=m?h.map(e=>e.frame):[];return(0,ae.jsxs)("div",{className:(0,Nn.cn)("keypoints").mod({selected:g,timeline:m}).toClassName(),style:C,"data-id":t.id,"data-start":R[0],"data-end":R[1],"data-locked":p||void 0,children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("keypoints").elem("label").toClassName(),onClick:P,children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("keypoints").elem("name").toClassName(),children:c}),(0,ae.jsx)("div",{className:(0,Nn.cn)("keypoints").elem("data").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("keypoints").elem("data-item").mod({faded:!0}).toClassName(),children:e})})]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("keypoints").elem("keypoints").toClassName(),onClick:e=>P(e,!0),children:(0,ae.jsx)(_m,{lifespans:k,step:s,visible:u,offset:S})})]})},_m=({lifespans:e,step:t,offset:n,visible:i})=>(0,ae.jsx)(ae.Fragment,{children:e.map((o,s)=>{const a=s+1===e.length,{points:r}=o,l=(0,Se.A)(o,Nm);return(0,ae.jsx)(Am,Object.assign({mainOffset:n,step:t,isLast:a,visible:i,points:r.map(({frame:e})=>e)},l),`${s}-${r.length}-${a}-${i}`)})}),Am=(0,f.memo)(({mainOffset:e,width:t,start:n,step:i,offset:o,enabled:s,visible:a,isLast:r,points:l,locked:c})=>{const d=e+o+i/2,u=r&&s?0:"auto",h=r&&s?"auto":t,g=(0,f.useMemo)(()=>({left:d,width:h,right:u}),[d,u,h]);return(0,ae.jsx)("div",{className:(0,Nn.cn)("keypoints").elem("lifespan").mod({hidden:!a,instant:!t}).toClassName(),style:g,children:l.map((e,t)=>{const o=(e-n)*i;return(0,ae.jsx)("div",{className:(0,Nn.cn)("keypoints").elem("point").mod({last:!!o,locked:c}).toClassName(),style:{left:o}},t)})})}),Im=["offset","position","length","step","regions","onScroll","onPositionChange","onResize","onSelectRegion"],Mm=(e,t)=>Math.floor(e/t),Em=(e,t)=>Mm(e,t)*t,Km=({regions:e,startOffset:t,scrollTop:n,disabled:i,onSelectRegion:o})=>{const s=(0,f.useMemo)(()=>{const t=xm()(Math.ceil(n/24)-1,0,e.length),i=xm()(t+(Math.ceil(6.875)-1),0,e.length);return[xm()(t-5,0,e.length),xm()(i+5,0,e.length)]},[n,e.length]);return(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("keypoints").toClassName(),style:{height:24*e.length},children:e.map((e,n)=>e.sequence.length>0||e.timeline?(0,ae.jsx)(Tm,{idx:e.index,region:e,startOffset:t,onSelectRegion:i?void 0:o,renderable:s[0]<=n&&n<=s[1]},e.id):null)})},Dm={View:e=>{var t;let{offset:n=0,position:i=1,length:o=1024,step:s,regions:a,onScroll:r,onPositionChange:l,onResize:c,onSelectRegion:d}=e,u=(0,Se.A)(e,Im);const h=null!=(t=u.leftOffset)?t:150,g=(0,f.useRef)(),m=(0,f.useRef)(0),p=(0,f.useRef)(i),[v,y]=(0,f.useState)(!0),[b,x]=(0,f.useState)(null),[w,S]=(0,f.useState)(n),C=(0,f.useRef)(w),[k,P]=(0,f.useState)(0),[R,j]=(0,f.useState)(!1);C.current=w;const N=(0,f.useMemo)(()=>o*s,[o,s]),{width:T}=Rm(g.current||[]),_=(0,f.useMemo)(()=>Mm(Em((null!=T?T:0)-h,s),s),[s,h,T]),A=ym({onPositionChange:l}),I=(0,f.useMemo)(()=>[`repeating-linear-gradient(90deg, var(--color-neutral-background) 1px, var(--color-neutral-background) ${s-1}px, rgba(255,255,255,0) ${s-1}px, rgba(255,255,255,0) ${s+1}px)`,"linear-gradient(0deg, var(--color-neutral-surface), rgba(255,255,255,0) 50%)"].join(", "),[s]),M=(0,f.useCallback)(({left:e,top:t})=>{if(o&&(x(null),(0,E.isDefined)(t)&&k!==t&&P(t),(0,E.isDefined)(e)&&w!==e)){S(e);const t=Mm(Em(e,s),s);null==r||r(xm()(t,1,o))}},[w,k,s,o]),K=(0,f.useCallback)(e=>{const t=Mm(Em(e,s),s);null==A.onPositionChange||A.onPositionChange(xm()(t+1,1,o))},[s,o,i]),D=(0,f.useCallback)(e=>{const t=g.current;if(Math.abs(e.deltaX)>Math.abs(e.deltaY)){const n=t.scrollWidth-t.clientWidth,i=xm()(w+1.25*e.deltaX,0,n);M({left:i})}else{const n=t.scrollHeight-t.clientHeight,i=xm()(k+1.25*e.deltaY,0,n);M({top:i})}},[g,w,k,M]),O=(0,f.useMemo)(()=>Em(w,s),[w,s,o]),L=(0,f.useMemo)(()=>k,[k]),z=(0,f.useCallback)(e=>{y(!1);const t=e.target,n=t.offsetLeft+O,i=e.pageX,o=g.current.scrollWidth-t.clientWidth;let a=0;const r=e=>{const t=Em(e.pageX-i,s),r=xm()(n+t,0,o);r!==a&&(a=r,K(r))},l=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l),y(!0)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",l)},[O,K,s]),B=(0,f.useCallback)(e=>{if(g.current){var t;const o=g.current.getBoundingClientRect().left,a=e.pageX-o-h,r=Mm(a+O,s)+1,l=e.target.closest("[data-id]");if(l&&(null==(t=l.dataset)||!t.locked)){var n,i;const[e,t]=[null==(n=l.dataset)?void 0:n.start,null==(i=l.dataset)?void 0:i.end];e===String(r)||t===String(r)?l.style.cursor="col-resize":"col-resize"===l.style.cursor&&(l.style.cursor="auto")}x(a>0?a:null)}},[O,s]),F=(0,f.useCallback)(()=>{b&&(K(b+O),x(null))},[b,O,s,K]),H=(0,f.useMemo)(()=>{const e=xm()(i,0,o)*s;return Em(e-O,s)+h},[i,O,s,o]),V=(0,f.useCallback)(e=>{var t;const n=g.current.getBoundingClientRect(),i=n.left,o=n.width-h,a=e.target.closest("[data-id]"),r=e.pageX-i>h,l=r&&(!a||"new"===(null==(t=a.dataset)?void 0:t.id));let c,d;const m=e=>e.pageX-i-h+O,p=m(e);let f=Mm(p,s)+1,v=!1;if(r&&K(p),l)c=null==u.onStartDrawing?void 0:u.onStartDrawing({frame:f}),d="new";else if(a&&r&&(c=null==u.onStartDrawing?void 0:u.onStartDrawing({region:a.dataset.id,frame:f}),c)){const{start:e,end:t}=c.ranges[0];d="edit",f===e?f=t:f===t&&(f=e),e===t&&(v=!0)}const b=e=>{const t=m(e),n=Mm(t,s)+1;if(t>=O&&t<=o+O&&(y(!1),j(!0),K(t)),c)if(v)c.setRange([n,n],{mode:d});else{const[e,t]=n>f?[f,n]:[n,f];c.setRange([e,t],{mode:d})}},x=()=>{y(!0),j(!1),null==u.onFinishDrawing||u.onFinishDrawing({mode:d}),document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",x)};document.addEventListener("mousemove",b),document.addEventListener("mouseup",x)},[O,K]);(0,f.useEffect)(()=>{g.current&&(g.current.scrollLeft=O,g.current.scrollTop=L)},[O,L]),(0,f.useEffect)(()=>{const e=g.current,t=t=>{const n=e.scrollTop,i=e.scrollHeight-e.clientHeight,o=Math.abs(t.deltaX)>Math.abs(t.deltaY),{deltaY:s}=t;!o&&(0===n&&s<0||n===i&&s>0)||t.preventDefault()};return e.addEventListener("wheel",t),()=>e.removeEventListener("wheel",t)},[]),(0,f.useEffect)(()=>{null==c||c(Mm(T||0,s))},[N,s,T]),(0,f.useEffect)(()=>{const e=g.current;if((0,E.isDefined)(e)){const t=xm()(n*s,0,e.scrollWidth-e.clientWidth);m.current=Em(t,s),S(t)}},[n,s,T]),(0,f.useEffect)(()=>{const e=g.current;if(!(0,E.isDefined)(e)||_<1)return;const t=Mm(Em(C.current,s),s)+1,n=t+_-1,o=Math.abs(i-p.current);if(p.current=i,1===o&&(i<t||i>n)){if(i<t){const n=xm()((t-1-_)*s,0,e.scrollWidth-e.clientWidth);m.current=Em(n,s),M({left:n})}else if(i>n){const t=xm()(n*s,0,e.scrollWidth-e.clientWidth);m.current=Em(t,s),M({left:t})}return}const a=Em(i-1,_),r=(i-1)*s-m.current;(r>(_-1)*s||r<0)&&(M({left:a*s}),m.current=a*s)},[i,_,s]);const $={"--view-height":u.height?`${u.height}px`:null,"--frame-size":`${s}px`,"--view-size":`${N}px`,"--offset":`${h}px`};return(0,ae.jsxs)("div",{className:(0,Nn.cn)("timeline-frames").toClassName(),style:$,children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("timeline-frames").elem("controls").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("indicator").toClassName(),onMouseDown:z,style:{left:xm()(H-s,h-s,N)}}),(0,E.isDefined)(b)&&v&&(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("hover").toClassName(),style:{left:Em(b,s),marginLeft:h},"data-frame":Mm(O+b,s)+1})]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("labels-bg").toClassName(),style:{width:h}}),(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("scroll").toClassName(),ref:g,onWheel:D,onMouseMove:B,onMouseLeave:()=>x(null),onClickCapture:F,onMouseDown:V,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("filler").toClassName(),children:(0,ae.jsx)(Km,{regions:a,scrollTop:L,startOffset:h,onSelectRegion:d,disabled:R})})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline-frames").elem("background").toClassName(),style:{backgroundImage:I}})]})},Minimap:()=>{const{regions:e,length:t}=(0,f.useContext)(Sn),n=(0,f.useRef)(),[i,o]=(0,f.useState)(0),s=(0,f.useMemo)(()=>e.map(({id:e,color:t,sequence:n,locked:o})=>({id:e,color:t,lifespans:jm(n,i,o)})),[i,e]),{width:a=0}=Rm(n.current||[]);return(0,f.useEffect)(()=>{(0,E.isDefined)(n.current)&&t>0&&o(a/t)},[t,a]),(0,ae.jsx)("div",{ref:n,className:(0,Nn.cn)("minimap").toClassName(),children:s.slice(0,5).map(({id:e,color:t,lifespans:n})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("minimap").elem("region").toClassName(),style:{"--color":t},children:n.map((t,o)=>{const s=o+1===n.length,a=t.start*i,r=s&&t.enabled?"100%":t.width;return(0,ae.jsx)("div",{className:(0,Nn.cn)("minimap").elem("connection").toClassName(),style:{left:a,width:r}},`${e}${o}`)})},e))})},Controls:({onAction:e})=>{const{position:t,regions:n,readonly:i}=(0,f.useContext)(Sn),o=n.some(({selected:e,timeline:t})=>e&&!t),s=(0,f.useMemo)(()=>{const e=n.find(e=>e.selected&&!e.timeline);return null==e?void 0:e.sequence.filter(({frame:e})=>e<=t).slice(-1)[0]},[n,t]),a=(null==s?void 0:s.frame)!==t,r=!1===(null==s?void 0:s.enabled),l=(0,f.useCallback)(n=>{a?null==e||e(n,"keypoint_add",{frame:t}):null==e||e(n,"keypoint_remove",{frame:s.frame})},[e,a,t,null==s?void 0:s.frame]),c=(0,f.useCallback)(t=>{r?null==e||e(t,"lifespan_add",{frame:s.frame}):null==e||e(t,"lifespan_remove",{frame:s.frame})},[e,r,null==s?void 0:s.frame]),d=(0,f.useMemo)(()=>a?(0,ae.jsx)(Pn.ShN,{}):(0,ae.jsx)(Pn.iwh,{}),[a,s]),u=(0,f.useMemo)(()=>r?(0,ae.jsx)(Pn.rf7,{}):(0,ae.jsx)(Pn.Ovv,{}),[s,r]);return(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(ki,{onClick:l,disabled:!o||i,tooltip:"Toggle Keypoint",children:d}),(0,ae.jsx)(ki,{onClick:c,disabled:!s||i,tooltip:"Toggle Interpolation",children:u})]})},settings:{stepSize:(e,t,n,i)=>((e,t,n)=>{const i=t.find(e=>e.selected);let o;return o=i?i.sequence.map(({frame:e})=>e):Array.from(t.reduce((e,{sequence:t})=>{const n=t.map(({frame:e})=>e);return new Set([...e,...n])},new Set)).sort((e,t)=>e-t),((e,t,n)=>{var i;const o=e.filter(e=>-1===n?e<t:e>t);return null!=(i=o[-1===n?o.length-1:0])?i:t})(o,e,n)})(t,n,i),fastTravelSize:()=>10,playpauseHotkey:"media:playpause",stepBackHotkey:"media:step-backward",stepForwardHotkey:"media:step-forward",stepAltBack:"video:keyframe-backward",stepAltForward:"video:keyframe-forward",leftOffset:150,skipToBeginning:"video:rewind",skipToEnd:"video:fastforward",hopBackward:"video:hop-backward",hopForward:"video:hop-forward"}},Om={frames:Dm},Lm=["regions","zoom","mode","length","position","framerate","altHopSize","hopSize","playing","buffering","fullscreen","disableView","defaultStepSize","allowSeek","allowFullscreen","allowViewCollapse","controlsOnTop","data","speed","className","formatPosition","readonly"],zm=(0,b.PA)(e=>{var t,n;let{regions:i,zoom:o=1,mode:s="frames",length:a=1024,position:r=1,framerate:l=24,altHopSize:c=1,hopSize:d=c,playing:u=!1,buffering:h=!1,fullscreen:g=!1,disableView:m=!1,defaultStepSize:p=10,allowSeek:v=!0,allowFullscreen:y=!0,allowViewCollapse:b=!0,controlsOnTop:x=!0,data:w,speed:S,className:C,formatPosition:k,readonly:P=!1}=e,R=(0,Se.A)(e,Lm);const j=Om[s],[N,T]=(0,f.useState)((0,E.clamp)(r,1,Number.POSITIVE_INFINITY)),[_,A]=(0,f.useState)(0),[I,M]=(0,f.useState)(0),[K,D]=((e,t,n={})=>{var i;const o=localStorage.getItem(e),s=o?null!=(i=null==n.fromString?void 0:n.fromString(o))?i:o:t,[a,r]=(0,f.useState)(s);return[a,t=>{var i;const o=null!=(i=null==n||null==n.toString?void 0:n.toString(t))?i:t.toString();localStorage.setItem(e,o),r(t)}]})("video-timeline",!1,{fromString:e=>"true"===e,toString:e=>String(e)}),O=(0,f.useRef)(()=>N),L=(0,f.useMemo)(()=>p*o,[o,p]),z=ym({onReady:R.onReady,onPlay:R.onPlay,onPause:R.onPause,onSeek:R.onSeek,onPositionChange:R.onPositionChange,onToggleVisibility:R.onToggleVisibility,onAddRegion:R.onAddRegion,onDeleteRegion:R.onDeleteRegion,onSelectRegion:R.onSelectRegion,onStartDrawing:R.onStartDrawing,onFinishDrawing:R.onFinishDrawing,onAction:R.onAction,onFullscreenToggle:R.onFullscreenToggle,onSpeedChange:R.onSpeedChange}),B=e=>{T(t=>{const n=(0,E.clamp)(e,1,a);return n!==t?(null==z.onPositionChange||z.onPositionChange(n),n):t})},F=(0,f.useMemo)(()=>({position:r,length:a,regions:i,step:L,data:w,playing:u,seekOffset:_,settings:j.settings,visibleWidth:I,readonly:P}),[r,_,I,a,i,L,u,j.settings,w,P]);(0,f.useEffect)(()=>{const e=O.current();r!==e&&T((0,E.clamp)(r,1,a))},[r,a]);const H=(0,ae.jsxs)("div",{className:(0,Nn.cn)("timeline").elem("topbar").toClassName(),children:[(0,ae.jsx)(Ci,{length:a,position:N,frameRate:l,playing:u,buffering:h,volume:R.volume,controls:R.controls,altHopSize:c,customControls:R.customControls,collapsed:K,onPlay:()=>null==z.onPlay?void 0:z.onPlay(),onPause:()=>null==z.onPause?void 0:z.onPause(),fullscreen:g,disableFrames:m,allowFullscreen:y,allowViewCollapse:b,onFullScreenToggle:e=>null==z.onFullscreenToggle?void 0:z.onFullscreenToggle(e),onVolumeChange:R.onVolumeChange,onStepBackward:(e,t)=>{var n;const o=null!=(n=null==t?void 0:t(a,N,i,-1))?n:N-d;B(o)},onStepForward:(e,t)=>{var n;const o=null!=(n=null==t?void 0:t(a,N,i,1))?n:N+d;B(o)},onRewind:e=>B((0,E.isDefined)(e)?N-e:0),onForward:e=>B((0,E.isDefined)(e)?N+e:a),onPositionChange:B,onToggleCollapsed:D,formatPosition:k,extraControls:j.Controls&&!m?(0,ae.jsx)(j.Controls,{onAction:(e,t,n)=>{null==z.onAction||z.onAction(e,t,n)}}):null,mediaType:"timeline"}),v&&(0,ae.jsx)(Sm,{length:a,step:L,leftOffset:null==(t=j.settings)?void 0:t.leftOffset,position:N,seekOffset:_,seekVisible:I,onIndicatorMove:A,onSeek:B,minimap:j.Minimap?(0,ae.jsx)(j.Minimap,{}):null})]});i.map(e=>(0,E.fixMobxObserve)(e.sequence));const V=!K&&!m&&(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline").elem("view").toClassName(),children:(0,ae.jsx)(j.View,{step:L,length:a,regions:i,playing:u,zoom:o,speed:S,volume:R.volume,controls:R.controls,height:R.height,position:N,offset:_,leftOffset:null==(n=j.settings)?void 0:n.leftOffset,onReady:e=>null==z.onReady?void 0:z.onReady(e),onScroll:A,onResize:M,onPositionChange:B,onPlay:()=>null==z.onPlay?void 0:z.onPlay(),onPause:()=>null==z.onPause?void 0:z.onPause(),onSeek:e=>null==z.onSeek?void 0:z.onSeek(e),onToggleVisibility:(e,t)=>null==z.onToggleVisibility?void 0:z.onToggleVisibility(e,t),onAddRegion:e=>null==z.onAddRegion?void 0:z.onAddRegion(e),onDeleteRegion:e=>null==z.onDeleteRegion?void 0:z.onDeleteRegion(e),onSelectRegion:(e,t,n)=>null==z.onSelectRegion?void 0:z.onSelectRegion(e,t,n),onStartDrawing:e=>null==z.onStartDrawing?void 0:z.onStartDrawing(e),onFinishDrawing:e=>null==z.onFinishDrawing?void 0:z.onFinishDrawing(e),onSpeedChange:e=>null==z.onSpeedChange?void 0:z.onSpeedChange(e),onZoom:R.onZoom})});return(0,ae.jsx)(Cn,{value:F,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("timeline").mix(C).toClassName(),children:x?(0,ae.jsxs)(ae.Fragment,{children:[H,V]}):(0,ae.jsxs)(ae.Fragment,{children:[V,H]})})})}),Bm=(0,f.forwardRef)((e,t)=>{const n=(0,f.useRef)(),i=(0,f.useRef)(null),o=e=>{t instanceof Function?t(e):t&&(t.current=e)};return(0,f.useEffect)(()=>{var t;const s=document.createElement("canvas");s.width=e.width,s.height=e.height,s.style.background="transparent",i.current=s,null==(t=n.current)||t.appendChild(s),o(i.current)},[]),(0,f.useEffect)(()=>{i.current&&(i.current.width=e.width,i.current.height=e.height)},[e.width,e.height]),(0,f.useEffect)(()=>()=>{const e=i.current,t=e.getContext("2d");null==t||t.clearRect(0,0,e.width,e.height),e.remove(),i.current=null,o(null)},[]),(0,ae.jsx)("div",{ref:n})}),Fm={mp4:"video/mp4",mp4v:"video/mp4",mpg4:"video/mp4",ogg:"video/ogg",ogv:"video/ogg",ogm:"video/ogg",ogx:"video/ogg",webm:"video/webm",avi:"video/avi",mov:"video/quicktime",qt:"video/quicktime"},Hm=(0,f.forwardRef)((e,t)=>{const n=(0,f.useRef)(null),i=(0,f.useRef)(null),o=(0,f.useRef)([]),s=(0,f.useCallback)(async t=>{let n=!1;return t&&(n=await(async e=>{var t;const n=document.createElement("video"),i=null!=(t=new URL(e,/^https?/.exec(e)?void 0:window.location.href).pathname.split(".").pop())?t:"";let o=Fm[i];o||(o=(await fetch(e,{method:"GET",headers:{Range:"bytes=0-0"}})).headers.get("content-type"));const s=!!(a=o)&&a.includes("octet-stream")||!!o&&""!==n.canPlayType(o);var a;const r=document.querySelector(".ant-modal");return s||r||dn.error("There has been an error rendering your video, please check the format is supported"),s})(t)),e.canPlayType&&e.canPlayType(n),n},[e.canPlayType]),a=(0,f.useCallback)(()=>{var t;const i=document.createElement("video");i.muted=!!e.muted,i.controls=!1,i.preload="auto",i.playbackRate=null!=(t=e.speed)?t:1,i.crossOrigin="anonymous",Object.assign(i.style,{top:"-9999px",width:0,height:0,position:"absolute"}),n.current=i},[]),r=(0,f.useCallback)(e=>{e&&(e=Qi(e)),t instanceof Function?t(e):t&&(t.current=e)},[]),l=()=>{const t=Object.entries(e).filter(([e])=>e.startsWith("on")).map(([e,t])=>[e.toLowerCase(),t]),i=[];t.forEach(([e,t])=>{var o;const s=e.replace(/^on/,"");null==(o=n.current)||o.addEventListener(s,t),i.push([s,t])}),o.current=i},c=()=>{var e;n.current&&((null!=(e=o.current)?e:[]).forEach(([e,t])=>{var i;null==(i=n.current)||i.removeEventListener(e,t)}),o.current=[])},d=()=>{var e,t,o;i&&n&&(null==(e=n.current)||e.pause(),null==(t=i.current)||t.setAttribute("src",""),null==(o=n.current)||o.load())},u=(0,f.useCallback)(()=>{var t,o,s;if(!n.current)return;null==(t=n.current)||t.pause(),i.current&&d();const a=document.createElement("source");a.setAttribute("src",null!=(o=e.src)?o:""),null==(s=n.current)||s.appendChild(a),i.current=a},[e.src]);return(0,f.useEffect)(()=>{c(),l()}),(0,f.useEffect)(()=>{var t;return a(),l(),s(null!=(t=e.src)?t:"").then(e=>{e&&n.current&&(u(),r(n.current),document.body.append(n.current))}),()=>{var e;c(),d(),r(null),null==(e=n.current)||e.remove(),n.current=null}},[]),(0,f.useEffect)(()=>{n.current&&void 0!==e.muted&&(n.current.muted=e.muted)},[e.muted]),null}),Vm=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING),$m=e=>(0,E.clamp)(e,.1,10),Wm=(e,t,n,i)=>Math.min(1,Math.min(e/n,t/i)),Um=.002,Gm=(0,f.memo)((0,f.forwardRef)((e,t)=>{var n,i,o,s,a;const r=(0,f.useRef)(),l=(0,f.useRef)(),c=(0,f.useRef)(),d=(0,f.useRef)(),u=(0,f.useRef)(),h=(0,f.useRef)(null),g=(0,f.useRef)(!1),m=(0,f.useMemo)(()=>{var t;return null!=(t=e.width)?t:600},[e.width]),p=(0,f.useMemo)(()=>{var t;return null!=(t=e.height)?t:600},[e.height]),v=null!=(n=e.framerate)?n:29.97,[y,b]=(0,f.useState)(!0),[x,w]=(0,f.useState)(0),[S,C]=(0,f.useState)(null!=(i=e.position)?i:1),[k,P]=(0,f.useState)(!1),[R,j]=(e=>{var t;if(Vm)return[!1,_i(null!=(t=e.onBuffering)?t:()=>{})];const[n,i]=(0,f.useState)(!1);return[n,i]})(e),[N,T]=(0,f.useState)(null!=(o=e.zoom)?o:1),[_,A]=(0,f.useState)(null!=(s=e.pan)?s:{x:0,y:0}),[I,M]=(0,f.useState)({width:0,height:0,ratio:1}),[K,D]=(0,f.useState)(1),[O,L]=(0,f.useState)(1),[z,B]=(0,f.useState)(1),F=Ti(e.buffering),H=(0,f.useMemo)(()=>{const e=[];return 1!==K&&e.push(`contrast(${K})`),1!==O&&e.push(`brightness(${O})`),1!==z&&e.push(`saturate(${z})`),e.join(" ")},[O,K,z]),V=(0,f.useCallback)(t=>{const{width:n,height:i}=I,o=n*N,s=i*N,a=(0,E.clamp)((o-m)/2,0,Number.POSITIVE_INFINITY),r=(0,E.clamp)((s-p)/2,0,Number.POSITIVE_INFINITY);return{x:e.allowPanOffscreen?t.x:(0,E.clamp)(t.x,-a,a),y:e.allowPanOffscreen?t.y:(0,E.clamp)(t.y,-r,r)}},[e.allowPanOffscreen,m,p,N]),$=(0,f.useCallback)(()=>{try{if(d.current&&u.current){const e=d.current,{width:t,height:n}=I;if(0===t&&0===n)return;const i=t*N,o=n*N,s=(m-i)/2+_.x,a=(p-o)/2+_.y;e.clearRect(0,0,m,p),e.filter=H,e.drawImage(u.current,0,0,t,n,s,a,i,o)}}catch(e){console.log("Error rendering video",e)}},[I,N,_,H,m,p]),W=(0,f.useCallback)((t=!1)=>{var n,i,o;if(!d.current)return;const s=null!=(n=null==(i=u.current)?void 0:i.currentTime)?n:0,a=(0,Ne.VS)(Ne.Tm)?Math.ceil(s*v):Math.round(s*v),r=(0,E.clamp)(a,1,x||1),l=null!=(o=e.onFrameChange)?o:()=>{};r===S&&!0!==t||(C(r),$(),l(r,x))},[v,S,$,e.onFrameChange,x]),U=(0,f.useCallback)(e=>{d.current&&(e||(g.current=!0),j(e))},[j]),G=_h(u,U),Y=(0,f.useCallback)(()=>{if(!u.current)return;if(!d.current)return;const e=u.current;e&&(k||W(!0),Vm?G():e.networkState===e.NETWORK_IDLE?(g.current=!0,j(!1)):j(!0))},[k,W]),X=(0,f.useCallback)(()=>{P(!0),Vm?G():j(!1),null==e.onPlay||e.onPlay()},[e.onPlay]),q=(0,f.useCallback)(()=>{P(!1),Vm?G():j(!1),null==e.onPause||e.onPause()},[e.onPause]),Z=(0,f.useCallback)(()=>{Vm||j(!1),Y()},[Y]),J=(0,f.useCallback)(()=>{Vm?G():j(!0)},[]),Q=(0,f.useCallback)(()=>{P(!1),Vm||j(!1),null==e.onSeeked||e.onSeeked(),null==e.onEnded||e.onEnded(),null==e.onPause||e.onPause()},[e.onEnded]),ee=(0,f.useCallback)(()=>{const t=u.current;null!=t&&t.error&&g.current?(g.current=!1,t.load()):t&&(null==e.onError||e.onError(t.error))},[e.onError]),te=()=>{W(),k?r.current=requestAnimationFrame(ne.current):cancelAnimationFrame(r.current)},ne=(0,f.useRef)(te);ne.current=te,(0,f.useEffect)(()=>{k||$()},[$,k]),(0,f.useEffect)(()=>(k&&(r.current=requestAnimationFrame(ne.current)),()=>{cancelAnimationFrame(r.current)}),[k]),(0,f.useEffect)(()=>{u.current&&e.speed&&(u.current.playbackRate=e.speed)},[e.speed]),(0,f.useEffect)(()=>{u.current&&e.position&&(u.current.currentTime=e.position/v)},[v,e.position]),(0,f.useEffect)(()=>{const t=requestAnimationFrame(()=>{Vm&&F.current||u.current&&e.currentTime&&(u.current.currentTime=e.currentTime)});return()=>cancelAnimationFrame(t)},[e.currentTime,F]),(0,f.useEffect)(()=>{u.current&&(e.playing&&!k?u.current.play():!1===e.playing&&k&&u.current.pause())},[k,e.playing]),(0,f.useEffect)(()=>{var t;e.allowInteractions&&(null==(t=l.current)||t.addEventListener("wheel",e=>{e.preventDefault()}))},[]),(0,f.useEffect)(()=>{(0,E.isDefined)(e.zoom)&&T($m(e.zoom))},[e.zoom]),(0,f.useEffect)(()=>{(0,E.isDefined)(e.pan)&&A(V(e.pan))},[e.pan,V]),(0,f.useEffect)(()=>{(0,E.isDefined)(e.brightness)&&L(e.brightness)},[e.brightness]),(0,f.useEffect)(()=>{(0,E.isDefined)(e.contrast)&&D(e.contrast)},[e.contrast]),(0,f.useEffect)(()=>{(0,E.isDefined)(e.saturation)&&B(e.saturation)},[e.saturation]),(0,f.useEffect)(()=>{$()},[H,N,_,m,p]),(0,f.useEffect)(()=>{let t;const n=new ResizeObserver(()=>{t&&cancelAnimationFrame(t),t=requestAnimationFrame(()=>{null==e.onResize||e.onResize(I)})});return n.observe(l.current),()=>{t&&cancelAnimationFrame(t),n.disconnect()}},[I]);const ie={currentFrame:S,length:x,playing:k,zoom:N,pan:_,videoDimensions:I,width:m,height:p,set currentTime(e){const t=u.current;t&&e!==this.currentTime&&(t.currentTime=e)},get currentTime(){var e,t;return null!=(e=null==(t=u.current)?void 0:t.currentTime)?e:0},get duration(){var e,t;return null!=(e=null==(t=u.current)?void 0:t.duration)?e:0},get volume(){var e,t;return null!=(e=null==(t=u.current)?void 0:t.volume)?e:1},set volume(e){const t=u.current;t&&(t.currentTime=e)},adjustPan:(e,t)=>V({x:e,y:t}),setZoom(e){T($m(e))},setPan(e,t){const n=this.adjustPan(e,t);A(n)},setContrast(e){D(e)},setBrightness(e){L(e)},setSaturation(e){B(e)},play(){var e;oe(),null==(e=u.current)||e.play()},pause(){var e;null==(e=u.current)||e.pause(),(0,Ne.VS)(Ne.Tm)&&(this.currentTime=(0,E.clamp)(this.frameSteppedTime(),0,this.duration||0))},seek(e){this.currentTime=(0,E.clamp)(e,0,this.duration),requestAnimationFrame(()=>$())},frameSteppedTime(e,t=!1){return(0,Ne.VS)(Ne.Tm)?Math.round((null!=e?e:this.currentTime)/Um)*Um+(t?Um:0):null!=e?e:this.currentTime},goToFrame(e){const t=((0,E.clamp)(e,1,x)-1)/v;this.currentTime=this.frameSteppedTime(t,!0)}};t instanceof Function?t(ie):t&&(t.current=ie);const{prepareLoop:oe}=(({loopFrameRange:e,selectedFrameRange:t,framerate:n,onRedrawRequest:i,videoRef:o,refSource:s})=>{const a=(0,f.useRef)(n);a.current=n;const r=(0,f.useRef)(s);r.current=s;const l=(0,f.useRef)(i);l.current=i;const c=(0,f.useRef)(null),d=(0,f.useRef)(null!=e&&e);d.current=null!=e&&e;const u=(0,f.useCallback)((e,{mediaTime:n})=>{const i=o.current;if(!i||i.paused)return;if(!t)return;const s=t.start,h=t.end,g=(0,Ne.VS)(Ne.Tm)?Math.ceil(n*a.current):Math.round(n*a.current);if(g<s)r.current.goToFrame(s);else if(g>=h)return d.current?(r.current.goToFrame(h),null==l.current||l.current(),void(c.current=i.requestVideoFrameCallback(()=>{r.current.goToFrame(s),null==l.current||l.current(),c.current=i.requestVideoFrameCallback(u)}))):(r.current.pause(),r.current.goToFrame(h),void(null==l.current||l.current()));c.current=i.requestVideoFrameCallback(u)},[t]),h=(0,f.useCallback)(()=>{const e=()=>{var e;c.current&&(null==(e=o.current)||e.cancelVideoFrameCallback(c.current),c.current=null)};e();const n=o.current;return n&&t&&(c.current=n.requestVideoFrameCallback(u)),e},[t]);return(0,f.useEffect)(()=>h(),[t]),{prepareLoop:(0,f.useCallback)(()=>{if(t&&o.current){const e=(t.start-1)/a.current,n=(t.end-1)/a.current;(o.current.currentTime<e||o.current.currentTime>=n)&&r.current.goToFrame(t.start),h()}},[t])}})({loopFrameRange:e.loopFrameRange,selectedFrameRange:e.selectedFrameRange,videoRef:u,refSource:ie,framerate:v,onRedrawRequest:()=>{W(!0)}});return(0,f.useEffect)(()=>{const{width:t,height:n}=I,i=Wm(m,p,t,n);if(I.ratio!==i){const t=Object.assign({},I,{ratio:i});M(t),e.zoom!==I.ratio&&(null==e.onResize||e.onResize(t))}},[N,m,p,I]),(0,f.useEffect)(()=>{let t,n,i=!1;const o=()=>{var s;if(!i)if(!1!==h.current){if(4===(null==(s=u.current)?void 0:s.readyState)){i=!0;const n=u.current;return void(t=setTimeout(()=>{const t=(0,Ne.VS)(Ne.Tm)?Math.round(n.duration*v):Math.ceil(n.duration*v),[i,o]=[n.videoWidth,n.videoHeight],s={width:i,height:o,ratio:Wm(m,p,i,o)};M(s),w(t),b(!1),W(!0),null==e.onLoad||e.onLoad(Object.assign({},ie,{videoDimensions:s,length:t}))},200))}n=setTimeout(o,10)}else b(!1)};return o(),()=>{n&&clearTimeout(n),t&&clearTimeout(t)}},[]),(0,f.useEffect)(()=>()=>{const e=d.current;e&&e.clearRect(0,0,e.canvas.width,e.canvas.height),d.current=void 0,c.current=void 0,u.current=void 0,l.current=void 0},[]),(0,ae.jsxs)("div",{ref:l,className:(0,Nn.cn)("video-canvas").toClassName(),children:[y&&(0,ae.jsx)("div",{className:(0,Nn.cn)("video-canvas").elem("loading").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("spinner").toClassName()})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("video-canvas").elem("view").toClassName(),onClick:e.onClick,style:{width:m,height:p},children:[(0,ae.jsx)(Bm,{ref:e=>{e&&c.current!==e&&(c.current=e,d.current=e.getContext("2d"))},width:m,height:p}),!Vm&&!y&&R&&(0,ae.jsx)("div",{className:(0,Nn.cn)("video-canvas").elem("buffering").toClassName(),"aria-label":"Buffering Media Source"})]}),(0,ae.jsx)(Hm,{ref:u,controls:!1,preload:"auto",src:e.src,speed:e.speed,muted:null!=(a=e.muted)&&a,canPlayType:e=>h.current=e,onPlay:X,onPause:q,onLoadedData:Y,onCanPlay:Y,onSeeked:t=>{Vm||Y(),null==e.onSeeked||e.onSeeked(t)},onSeeking:t=>{Vm||Y(),null==e.onSeeked||e.onSeeked(t)},onTimeUpdate:t=>{Vm||Y(),null==e.onTimeUpdate||e.onTimeUpdate(t)},onProgress:Y,onPlaying:Z,onWaiting:J,onEnded:Q,onError:ee})]})}));Gm.displayName="VideoCanvas";const Ym=e=>{"webkitRequestFullscreen"in e?e.webkitRequestFullscreen():e.requestFullscreen()},Xm=()=>{"webkitCancelFullScreen"in document?document.webkitCancelFullScreen():document.exitFullscreen()},qm=()=>{var e;return null!=(e=document.webkitCurrentFullScreenElement)?e:document.fullscreenElement},Zm=(e={},t)=>{const n=(0,f.useRef)(e);return(0,f.useEffect)(()=>{n.current=e},[e,...null!=t?t:[]]),(0,f.useEffect)(()=>{const e=()=>{qm()?null==n.current.onEnterFullscreen||n.current.onEnterFullscreen():null==n.current.onExitFullscreen||n.current.onExitFullscreen()},t="onwebkitfullscreenchange"in document?"webkitfullscreenchange":"fullscreenchange";return document.addEventListener(t,e),()=>{document.removeEventListener(t,e)}},[]),{getElement:qm,enter:Ym,exit:Xm,setHandlers(e={}){n.current=e}}},Jm=u.gK.model("TimeTraveller",{undoIdx:0,targetPath:"",skipNextUndoState:u.gK.optional(u.gK.boolean,!1),lastAdditionTime:u.gK.optional(u.gK.Date,new Date),createdIdx:0}).volatile(()=>({history:[],isFrozen:!1})).views(e=>({get canUndo(){return e.undoIdx>0},get canRedo(){return e.undoIdx<e.history.length-1},get hasChanges(){return e.history.length>1}})).actions(e=>{let t,n;const i=new Set,o=new Set;let s=!1,a=!1;function r(e=!0){i.forEach(t=>t(e))}return{freeze(t){o.add(t),e.isFrozen||(s=!1,e.isFrozen=!0)},safeUnfreeze(t){o.delete(t),e.isFrozen=o.size>0},unfreeze(t){e.safeUnfreeze(t),e.isFrozen||(s&&e.recordNow(),e.setReplaceNextUndoState(!1))},setSkipNextUndoState(t=!0){e.skipNextUndoState=t},setReplaceNextUndoState(e=!0){a=e},recordNow(){t&&e.addUndoState((0,u.dV)(t))},onUpdate:e=>(i.add(e),()=>{i.delete(e)}),addUndoState(t){e.isFrozen?s=!0:e.skipNextUndoState?e.skipNextUndoState=!1:(e.history=e.history.slice(0,e.undoIdx+!a).concat(t),e.undoIdx=e.history.length-1,a=!1,s=!1,e.lastAdditionTime=new Date)},reinit(n=!0){e.history=[(0,u.dV)(t)],e.undoIdx=0,e.createdIdx=0,r(n)},afterCreate(){if(t=e.targetPath?(0,u.o1)(e,e.targetPath):(0,u._$)(e).targetStore,!t)throw new Error("Failed to find target store for TimeTraveller. Please provide `targetPath` property, or a `targetStore` in the environment");n=(0,u.aQ)(t,e=>this.addUndoState(e)),0===e.history.length&&e.recordNow(),e.createdIdx=e.undoIdx},beforeDestroy(){n(),t=null,n=null,i.clear(),o.clear()},undo(){e.set(e.undoIdx-1)},redo(){e.set(e.undoIdx+1)},set(n){e.undoIdx=n,e.skipNextUndoState=!0,(0,u.Nh)(t,e.history[n]),r(),(0,Ne.VS)(Ne.$b)&&setTimeout(()=>{e.setSkipNextUndoState(!1)})},reset(){(0,u.Nh)(t,e.history[e.createdIdx]),r()}}}),Qm=u.gK.model("GlobalOffset",{start:u.gK.number,end:u.gK.number,calculated:!1}).views(e=>({get serialized(){return{start:e.start,end:e.end}}})),ep=u.gK.model("RichTextRegionModel",{type:"richtextregion",object:u.gK.late(()=>u.gK.reference(ug)),startOffset:u.gK.integer,endOffset:u.gK.integer,start:u.gK.string,end:u.gK.string,text:u.gK.maybeNull(u.gK.string),isText:u.gK.optional(u.gK.boolean,!1),globalOffsets:u.gK.maybeNull(Qm)}).volatile(()=>({hideable:!0})).views(e=>({get parent(){return(0,u.$Q)(()=>e.object)},getRegionElement(){var t;return null==(t=e._spans)?void 0:t[0]},get displayValue(){return e.text}})).actions(e=>({beforeDestroy(){try{e.removeHighlight()}catch(e){console.warn(e)}},applyAdditionalDataFromResult(t){var n,i;const o=null==t||null==(n=t.type)?void 0:n.endsWith("labels"),s=(0,E.isDefined)(null==t||null==(i=t.value)?void 0:i.text);o&&s&&(e.text=t.value.text)},serialize(){const t={value:{}};if(e.isText)Object.assign(t.value,{start:e.startOffset,end:e.endOffset});else try{const n=e.parent.globalOffsetsToRelativeOffsets(e.globalOffsets);Object.assign(t.value,Object.assign({},n,{globalOffsets:e.globalOffsets.serialized}))}catch(n){const{start:i,end:o,startOffset:s,endOffset:a}=e;Object.assign(t.value,{start:i,end:o,startOffset:s,endOffset:a}),e.globalOffsets&&Object.assign(t.value,{globalOffsets:e.globalOffsets.serialized})}return"yes"===e.object.savetextresult&&(0,E.isDefined)(e.text)&&(t.value.text=e.text),t},updateTextOffsets(t,n){Object.assign(e,{startOffset:t,endOffset:n})},updateGlobalOffsets(t,n){e.globalOffsets=Qm.create({start:t,end:n,calculated:!0})},updateXPathsFromGlobalOffsets(){const t=e.parent.globalOffsetsToRelativeOffsets(e.globalOffsets);t&&e._setXPaths(t)},initRangeAndOffsets(){var t;if(null!=(t=e.globalOffsets)&&t.calculated)return;if(e.isText){const{startOffset:t,endOffset:n}=e;return void(e.globalOffsets={start:t,end:n,calculated:!0})}const n=e.parent.relativeOffsetsToGlobalOffsets(e.start,e.startOffset,e.end,e.endOffset);if(n){const[t,i]=n;return void(e.globalOffsets={start:t,end:i,calculated:!0})}e.globalOffsets&&e.updateXPathsFromGlobalOffsets()},_setXPaths(t){e.start=t.start,e.end=t.end,e.startOffset=t.startOffset,e.endOffset=t.endOffset}})),tp=u.gK.compose("RichTextRegionModel",Ze,mt,Ge,ep,qh);we.addRegionType(tp,"text"),we.addRegionType(tp,"hypertext"),we.addRegionType(tp,"richtext");const np=["playing"],ip=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING),op=u.gK.model({value:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string),framerate:u.gK.optional(u.gK.string,"24"),height:u.gK.optional(u.gK.string,"600"),timelineheight:u.gK.maybeNull(u.gK.string),muted:!1,defaultplaybackspeed:u.gK.optional(u.gK.union(u.gK.string,u.gK.number),"1"),minplaybackspeed:u.gK.optional(u.gK.union(u.gK.string,u.gK.number),"0.25")}),sp=u.gK.model({type:"video",_value:u.gK.optional(u.gK.string,""),mergeLabelsAndResults:!0}).volatile(()=>({errors:[],speed:1,ref:f.createRef(),frame:1,length:1,drawingRegion:null,loopTimelineRegion:!1})).views(e=>({get store(){return(0,u.Zn)(e)},get currentFrame(){var t,n;return null!=(t=null==(n=e.ref.current)?void 0:n.position)?t:1},get timelineControl(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.find(e=>e.type.includes("timeline"))},get videoControl(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.find(e=>e.type.includes("video"))},states(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.filter(e=>e.type.endsWith("labels"))},activeStates(){const t=e.states();return t?t.filter(e=>!0===e.isSelected):null},get hasStates(){const t=e.states();return t&&t.length>0},get fullFrameRange(){return{start:1,end:e.length}},get timelineRegions(){return e.annotation.regionStore.selection.list.filter(e=>"timelineregion"===e.type)},get hasSelectedRange(){return e.timelineRegions.length>0},get selectedFrameRange(){const t=e.timelineRegions;if(0===t.length)return null;let n=t[0].ranges[0].start,i=t[0].ranges[0].end;return t.forEach(e=>{e.ranges.forEach(e=>{e.start<n&&(n=e.start),e.end>i&&(i=e.end)})}),{start:n,end:i}},get persistentValuesKey(){return"ls:video-tag:settings"},get persistentValues(){return{loopTimelineRegion:e.loopTimelineRegion}}})).actions(e=>({afterCreate(){var t,n;const i=Number(Oe(e.framerate,null==(t=e.store.task)?void 0:t.dataObj));!i||Number.isNaN(i)?e.framerate="24":e.framerate=String(i<1?1/i:i);const o=null==(n=e.store.task)?void 0:n.dataObj,s=Number(Oe(String(e.defaultplaybackspeed),o)),a=Number(Oe(String(e.minplaybackspeed),o));e.minplaybackspeed=!a||isNaN(a)||a<.05?.25:a,e.defaultplaybackspeed=!s||isNaN(s)||s<.05?1:Math.max(s,e.minplaybackspeed),e.speed=e.defaultplaybackspeed}})).actions(e=>({triggerSync(t,n){e.ref.current&&e.syncSend(Object.assign({playing:e.ref.current.playing,time:e.ref.current.frameSteppedTime()},n),t)},triggerSyncPlay(t=!1){ip&&e.isBuffering&&!t||(e.wasPlayingBeforeBuffering=!0,e.triggerSync("play",{playing:!0}))},triggerSyncPause(t=!1){ip&&e.isBuffering&&!t||(e.wasPlayingBeforeBuffering=!1,e.triggerSync("pause",{playing:!1}))},triggerSyncBuffering(t){if(!e.ref.current)return;const n=e.wasPlayingBeforeBuffering;e.triggerSync("buffering",{buffering:t,playing:n})},registerSyncHandlers(){for(const t of["play","pause","seek"])e.syncHandlers.set(t,e.handleSync);e.syncHandlers.set("speed",e.handleSyncSpeed),ip&&e.syncHandlers.set("buffering",e.handleSyncBuffering)},handleSyncBuffering(t){var n;let{playing:i}=t,o=(0,Se.A)(t,np);var s,a;(e.isBuffering=null==(n=e.syncManager)?void 0:n.isBuffering,o.buffering)&&(e.wasPlayingBeforeBuffering=i,null==(s=e.ref.current)||s.pause());e.isBuffering||o.buffering||i&&(null==(a=e.ref.current)||a.play());e.handleSync(o)},handleSync(t,n){var i;if(!e.ref.current)return;const o=e.ref.current,s=null==(i=e.syncManager)?void 0:i.isBuffering;(!ip||!s&&(0,E.isDefined)(t.playing))&&(t.playing?o.playing||o.play():o.playing&&o.pause()),["play","pause"].indexOf(n)>-1&&(e.wasPlayingBeforeBuffering=t.playing),t.speed&&(e.speed=t.speed),!(0,E.isDefined)(t.time)||ip&&o.currentTime===t.time||(o.currentTime=t.time)},handleSyncSpeed(t){(0,E.isDefined)(t.speed)&&(e.speed=t.speed)},handleSpeed(t){const n=Math.max(t,e.minplaybackspeed);e.speed=n,e.triggerSync("speed",{speed:n})},handleSeek(){e.triggerSync("seek",ip?{playing:e.wasPlayingBeforeBuffering}:{})},handleBuffering(t){var n,i,o,s,a;if(!ip)return;if((null==(n=e.syncManager)?void 0:n.isBufferingOrigin(e.name))===t)return;const r=!(null==(i=e.syncManager)?void 0:i.isBuffering)&&t;var l,c,d;1===(null==(o=e.syncManager)?void 0:o.bufferingOrigins.size)&&(null==(s=e.syncManager)?void 0:s.isBufferingOrigin(e.name))&&!t&&(e.wasPlayingBeforeBuffering&&(null==(l=e.ref.current)||l.play()));(e.triggerSyncBuffering(t),e.isBuffering=null==(a=e.syncManager)?void 0:a.isBuffering,r)&&(null!=(c=e.ref.current)&&c.playing&&(null==(d=e.ref.current)||d.pause()))},syncMuted(t){e.muted=t}})).actions(e=>({setLoopTimelineRegion(t){e.loopTimelineRegion=t},setLength(t){e.length=t},setOnlyFrame(t){e.frame!==t&&(e.frame=t)},setFrame(t){if(e.frame!==t&&e.framerate&&e.ref.current){if(e.frame=t,!e.ref.current)return;try{(0,Ne.VS)(Ne.Tm)?e.ref.current.goToFrame(t):e.ref.current.currentTime=t/e.framerate}catch(e){console.warn("Error seeking video:",e)}}},addVideoRegion(t){const n=e.videoControl;if(!n)return void console.error("No video control is found");const i=[Object.assign({frame:e.frame,enabled:!0,rotation:0},t)],o=e.activeStates(),s=He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult({sequence:i},{},n,e,!1,o):e.annotation.createResult({sequence:i},{},n,e,!1);if(!He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS))for(const t of e.activeStates())s.setValue(t);return s},addTimelineRegion(t){var n;const i=e.timelineControl;if(!i)return void console.error("No video timeline control is found");const o=null!=(n=t.frame)?n:e.frame,s={ranges:[{start:o,end:o}]};let a,r;if(He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)){r=e.activeStates().filter(e=>e!==i),a={[i.valueType]:i.selectedValues()}}else{var l;const t=null==(l=e.activeStates())?void 0:l[0];a={[t.valueType]:t.selectedValues()}}return He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)?e.annotation.createResult(s,a,i,e,!1,r):e.annotation.createResult(s,a,i,e,!1)},deleteRegion(t){var n;null==(n=e.findRegion(t))||n.deleteRegion()},findRegion:t=>e.regs.find(e=>e.cleanId===t),startDrawing({frame:t,region:n}){var i;if(e.annotation.isReadOnly())return null;if(n){var o;const i=e.annotation.regions.find(e=>e.cleanId===n),s=null==i||null==(o=i.ranges)?void 0:o[0];return s&&[s.start,s.end].includes(t)?i:null}const s=e.timelineControl;return null!=s&&null!=(i=s.selectedLabels)&&i.length||null!=s&&s.allowempty?(e.drawingRegion=e.addTimelineRegion({frame:t,enabled:!1}),e.drawingRegion):null},finishDrawing({mode:t}){e.drawingRegion=null,"edit"===t&&e.annotation.history.recordNow()}})),ap=u.gK.compose("VideoModel",Ue,op,Fe,gn,jg,Te,sp,Ae),rp=u.gK.model("TimelineRange",{start:u.gK.maybeNull(u.gK.integer),end:u.gK.maybeNull(u.gK.integer)});function lp(e){const{start:t,end:n}=e;return(0,E.isDefined)(t)?(0,E.isDefined)(n)?t===n?{frame:t,enabled:!1}:[{frame:t,enabled:!0},{frame:n,enabled:!1}]:{frame:t,enabled:!0}:(0,E.isDefined)(n)?{frame:n,enabled:!1}:[]}const cp=u.gK.model("TimelineRegionModel",{type:"timelineregion",object:u.gK.late(()=>u.gK.reference(ap)),ranges:u.gK.array(rp)}).volatile(()=>({hideable:!0,editableFields:[{property:"start",label:"Start frame"},{property:"end",label:"End frame"}]})).views(e=>({get parent(){return(0,u._n)(e)?e.object:null},get sequence(){return e.ranges.flatMap(lp)},getShape:()=>null})).actions(e=>({onSelectInOutliner(){e.object.setFrame(e.ranges[0].start)},serialize:()=>({value:{ranges:e.ranges}}),isInLifespan:e=>!0,setRange([t,n],{mode:i}={}){e.locked||("new"===i?e.parent.annotation.history.setReplaceNextUndoState():"edit"===i&&e.parent.annotation.history.setSkipNextUndoState(),e.ranges=[{start:t,end:n}])}})),dp=u.gK.compose("TimelineRegionModel",Ze,mt,Ge,nn,cp);we.addRegionType(dp,"video");const up=Fn("TimeSeries","Time Series Segmentation"),hp=u.gK.model("TimeSeriesRegionModel",{id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"timeseriesregion",object:u.gK.late(()=>u.gK.reference(Zg)),start:u.gK.union(u.gK.number,u.gK.string),end:u.gK.union(u.gK.number,u.gK.string),instant:!1}).volatile(()=>({hideable:!0})).views(e=>({get parent(){return e.object},getRegionElement:()=>e._brushRef})).actions(e=>({growRight(t){e.end=e.end+t},growLeft(t){e.start=e.start-t},shrinkRight(t){e.end=e.end-t},shrinkLeft(t){e.start=e.start+t},selectRegion(){const t=1e3,n=1e4;up.addNamed("ts:grow-left",()=>e.growLeft(t)),up.addNamed("ts:grow-right",()=>e.growRight(t)),up.addNamed("ts:shrink-left",()=>e.shrinkLeft(t)),up.addNamed("ts:shrink-right",()=>e.shrinkRight(t)),up.addNamed("ts:grow-left-large",()=>e.growLeft(n)),up.addNamed("ts:grow-right-large",()=>e.growRight(n)),up.addNamed("ts:shrink-left-large",()=>e.shrinkLeft(n)),up.addNamed("ts:shrink-right-large",()=>e.shrinkRight(n)),e.parent.scrollToRegion(e)},updateAppearenceFromState(){e.labelsState&&e.parent.updateView()},afterUnselectRegion(){["ts:grow-left","ts:grow-right","ts:shrink-left","ts:shrink-right","ts:grow-left-large","ts:grow-right-large","ts:shrink-left-large","ts:shrink-right-large"].forEach(e=>up.removeNamed(e)),e.parent.updateView()},updateRegion(t,n){e.start=t,e.end=n,e.notifyDrawingFinished()},afterCreate(){"string"==typeof e.start&&(e.start=e.parent.parseTime(e.start),e.end=e.parent.parseTime(e.end))},serialize(){const t=e.parent.timeformat?wg.aLc(e.parent.timeformat):Number;return{value:{start:t(e.start),end:t(e.end),instant:e.instant}}}})),gp=u.gK.compose("TimeSeriesRegionModel",Ze,mt,Ge,Te,hp);we.addTag("timeseriesregion",gp,()=>{}),we.addRegionType(gp,"timeseries");const mp=(e,t)=>Object.fromEntries(e.map(e=>[e,t[e]])),pp=u.gK.model("VideoRegionModel",{id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),object:u.gK.late(()=>u.gK.reference(ap)),sequence:u.gK.frozen([])}).preProcessSnapshot(e=>Object.assign({},e,{sequence:e.sequence||e.value.sequence})).volatile(()=>({hideable:!0})).views(e=>({get parent(){return e.object},getShape(){throw new Error("Method getShape be implemented on a shape level")},getVisibility:()=>!0})).actions(e=>({updateShape(){throw new Error("Method updateShape must be implemented on a shape level")},onSelectInOutliner(){e.object.setFrame(e.sequence[0].frame)},serialize(){var t,n;const{framerate:i,length:o}=e.object;return{value:{framesCount:o,duration:null!=(t=null==(n=e.object)||null==(n=n.ref)||null==(n=n.current)?void 0:n.duration)?t:0,sequence:e.sequence.map(e=>Object.assign({},e,{time:e.frame/i}))}}},toggleLifespan(t){const n=e.closestKeypoint(t,!0);if(n){const t=e.sequence.indexOf(n);e.sequence=[...e.sequence.slice(0,t),Object.assign({},n,{enabled:!n.enabled}),...e.sequence.slice(t+1)]}},addKeypoint(t){var n,i,o;const s=Array.from(e.sequence),a=e.closestKeypoint(t),r=Object.assign({},null!=(n=null!=(i=e.getShape(t))?i:a)?n:{x:0,y:0},{enabled:null==(o=null==a?void 0:a.enabled)||o,frame:t});s.push(r),s.sort((e,t)=>e.frame-t.frame),e.sequence=s,e.updateShape(Object.assign({},r),r.frame)},removeKeypoint(t){e.sequence=e.sequence.filter(e=>e.frame!==t)},isInLifespan(t){const n=e.closestKeypoint(t);if(n){const{enabled:e,frame:i}=n;return i===t&&!e||e}return!1},closestKeypoint(t,n=!1){const i=e.sequence;let o;const s=i.filter(({frame:e})=>e<=t);return o=s[s.length-1],o||!0===n||(o=i.find(({frame:e})=>e>=t)),o}})),fp=u.gK.compose("VideoRegionModel",Ze,mt,Te,Ge,pp);function vp(e){let t=e;for(;t>0;)t-=360;return(t-180)%360+180}const yp=(e,t,n,i)=>{const o=(n-e.frame)/(t.frame-e.frame);if("rotation"===i){const n=vp(t[i]-e[i]);return vp(e[i]+n*o)}return e[i]+(t[i]-e[i])*o},bp=u.gK.model("VideoRectangleRegionModel",{type:"videorectangleregion"}).volatile(()=>({props:["x","y","width","height","rotation"]})).views(e=>({getShape(t){let n,i;for(const o of e.sequence){if(o.frame===t)return mp(e.props,o);if(o.frame>t){i=o;break}n=o}return n?i?Object.fromEntries(e.props.map(e=>[e,yp(n,i,t,e)])):mp(e.props,n):null},getVisibility:()=>!0})).actions(e=>({updateShape(t,n){const i=Object.assign({},t,{frame:n,enabled:!0}),o=e.closestKeypoint(n),s=e.sequence.findIndex(e=>e.frame>=n);if(s<0)e.sequence=[...e.sequence,i];else{var a,r;const i=Object.assign({},null!=(a=e.sequence[s])?a:{},t,{enabled:null==(r=null==o?void 0:o.enabled)||r,frame:n});e.sequence=[...e.sequence.slice(0,s),i,...e.sequence.slice(s+(e.sequence[s].frame===n))]}}})),xp=u.gK.compose("VideoRectangleRegionModel",Ze,fp,mt,Ge,bp);we.addRegionType(xp,"video");const wp={begin:({ctx:e,x:t,y:n,brushSize:i=10,eraserMode:o=!1})=>(e.fillStyle=o?"white":"black",e.globalCompositeOperation=o?"destination-out":"source-over",1===i?e.fillRect(t,n,1,1):(e.beginPath(),e.arc(t+.5,n+.5,i,0,2*Math.PI),e.fill()),{x:t,y:n}),draw({ctx:e,x:t,y:n,brushSize:i=10,eraserMode:o=!1,lastPos:s}){return e.fillStyle=o?"white":"black",e.globalCompositeOperation=o?"destination-out":"source-over",this.drawLine(e,s.x,s.y,t,n,i),{x:t,y:n}},drawLine(e,t,n,i,o,s){const a=Math.abs(i-t),r=Math.abs(o-n),l=t<i?1:-1,c=n<o?1:-1;let d=a-r;for(;1===s?e.fillRect(t,n,1,1):(e.beginPath(),e.arc(t+.5,n+.5,s,0,2*Math.PI),e.fill()),t!==i||n!==o;){const e=2*d;e>-r&&(d-=r,t+=l),e<a&&(d+=a,n+=c)}}};var Sp=n(19716),Cp=n.n(Sp);const kp=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"bitmaskregion",object:u.gK.late(()=>u.gK.reference(_d)),imageDataURL:u.gK.maybeNull(u.gK.optional(u.gK.string,""))}).volatile(()=>({opacity:.6,needsUpdate:1,hideable:!0,layerRef:void 0,imageRef:void 0,lastPos:{x:0,y:0},offscreenCanvasRef:null,bitmaskCanvasRef:null,outline:[],bbox:null})).views(e=>({get parent(){return(0,u._n)(e)?e.object:null},get colorParts(){var t,n;const i=(null==(t=e.style)?void 0:t.strokecolor)||(null==(n=e.tag)?void 0:n.strokecolor)||(null==w.l?void 0:w.l.strokecolor);return i?(0,ft.A)(i).rgb():[]},get strokeColor(){return(0,ft.A)(e.colorParts).hex()},get bboxCoordsCanvas(){if(e.offscreenCanvasRef)return e.bbox},get bboxCoords(){const t=e.bbox;return t?{left:e.parent.canvasToInternalX(t.left),top:e.parent.canvasToInternalY(t.top),right:e.parent.canvasToInternalX(t.right),bottom:e.parent.canvasToInternalY(t.bottom)}:null},get dimensions(){var t,n,i,o;const s=e.parent;return{stageWidth:null!=(t=null==s?void 0:s.stageWidth)?t:0,stageHeight:null!=(n=null==s?void 0:s.stageHeight)?n:0,imageWidth:null!=(i=null==s?void 0:s.currentImageEntity.naturalWidth)?i:0,imageHeight:null!=(o=null==s?void 0:s.currentImageEntity.naturalHeight)?o:0}},getImageDataURL:()=>e.getImageSnapshotCanvas().toDataURL("image/png")})).actions(e=>{const t=[];return{afterCreate(){e.createCanvas(),e.restoreFromImageDataURL(),t.push((0,d.lB)(e,"strokeColor",()=>{e.composeMask()})),t.push((0,d.lB)(e,"imageDataURL",()=>{e.redraw()}))},beforeDestroy(){for(const e of t)e()},setOutline(t){e.outline=t},restoreFromImageDataURL(){e.imageDataURL&&async function(){const t=e.offscreenCanvasRef.getContext("2d"),n=e.bitmaskCanvasRef,i=new window.Image;i.src=e.imageDataURL;try{await i.decode(),t.canvas.width=i.naturalWidth,t.canvas.height=i.naturalHeight,n.width=i.naturalWidth,n.height=i.naturalHeight,t.drawImage(i,0,0),e.finalizeRegion()}catch(e){console.log(e)}}()},finalizeRegion(){e.composeMask(),e.generateOutline(),e.updateBBox()},updateImageURL(){e.setImageDataURL(e.getImageDataURL())},redraw(){e.bitmaskCanvasRef&&e.offscreenCanvasRef&&e.imageDataURL&&requestIdleCallback(()=>{const t=e.offscreenCanvasRef.getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height),e.restoreFromImageDataURL()})},setBBox(t){e.bbox=t},setImageDataURL(t){e.imageDataURL=t},generateOutline(){e.setOutline(function(e){if(!e.offscreenCanvasRef)return[];const t=e.offscreenCanvasRef.getContext("2d");if(!t)return[];const{width:n,height:i}=e.offscreenCanvasRef,o=t.getImageData(0,0,n,i).data,s=[];for(let e=0;e<i;e++){const t=[];for(let i=0;i<n;i++){const s=o[4*(e*n+i)+3];t.push(s>0?1:0)}s.push(t)}const a=Array.from({length:i},()=>Array(n).fill(!1)),r=[[1,0],[0,1],[-1,0],[0,-1]],l=(e,t,n,i)=>Math.abs(e-n)<=1&&Math.abs(t-i)<=1,c=(e,t)=>{if(0===s[t][e])return!1;for(let o=-1;o<=1;o++)for(let a=-1;a<=1;a++){if(0===a&&0===o)continue;const r=e+a,l=t+o;if(r<0||l<0||r>=n||l>=i||0===s[l][r])return!0}return!1},d=(e,t)=>{const o=[],s=new Set;let d=e,u=t,h=0,g=!1;for(let m=0;m<5e3;m++){o.push([d,u]),s.add(`${d},${u}`),a[u][d]=!0;let m=!1;for(let e=0;e<4;e++){const t=(h+e)%4,[o,a]=r[t],l=d+o,g=u+a;if(l>=0&&g>=0&&l<n&&g<i&&c(l,g)&&!s.has(`${l},${g}`)){d=l,u=g,h=t,m=!0;break}}if(!m||o.length>10&&l(d,u,e,t)){g=l(d,u,e,t)&&o.length>10;break}}return g?o:[]},u=[];for(let e=1;e<i-1;e++)for(let t=1;t<n-1;t++)if(c(t,e)&&!a[e][t]){const n=d(t,e);n.length>5&&u.push(n)}const h=e.parent.stageZoom;return u.map(e=>Cp()(e.map(([e,t])=>({x:e*h,y:t*h})),1.5,!0).flatMap(({x:e,y:t})=>[e,t]))}(e))},canvasSize(){if(!e.parent)return{width:0,height:0};const t=e.parent.currentImageEntity;return{width:t.naturalWidth*e.parent.stageZoom,height:t.naturalHeight*e.parent.stageZoom}},createCanvas(){const{width:t,height:n}={width:e.parent.currentImageEntity.naturalWidth,height:e.parent.currentImageEntity.naturalHeight};return e.bitmaskCanvasRef||(e.bitmaskCanvasRef=new OffscreenCanvas(t,n)),e.offscreenCanvasRef||(e.offscreenCanvasRef=new OffscreenCanvas(t,n)),e.offscreenCanvasRef},composeMask(){var t;const n=e.bitmaskCanvasRef.getContext("2d");e.isDrawing||n.clearRect(0,0,n.canvas.width,n.canvas.height),n.globalCompositeOperation="destination-atop",n.fillStyle=e.strokeColor,n.fillRect(0,0,n.canvas.width,n.canvas.height),n.drawImage(e.offscreenCanvasRef,0,0),null==(t=e.layerRef)||t.batchDraw()},updateBBox(){var t,n;e.setBBox(function(e,t){const n=e.getContext("2d");if(!n)return null;const{width:i,height:o}=e,s=n.getImageData(0,0,i,o).data;let a=i,r=o,l=-1,c=-1;for(let e=0;e<o;e++)for(let t=0;t<i;t++)s[4*(e*i+t)+3]>0&&(t<a&&(a=t),t>l&&(l=t),e<r&&(r=e),e>c&&(c=e));return l>=a&&c>=r?{left:a*t,top:r*t,right:(l+1)*t,bottom:(c+1)*t}:null}(e.offscreenCanvasRef,null!=(t=null==(n=e.parent)?void 0:n.stageZoom)?t:1))},setLayerRef(t){if(!t)return;const n=t.getParent();e.layerRef=n},setImageRef(t){t&&(e.imageRef=t)},setLastPos(t){e.lastPos=t},beginPath({type:t,strokeWidth:n,opacity:i=e.opacity,x:o=0,y:s=0}){e.object.annotation.pauseAutosave();const a=e.offscreenCanvasRef.getContext("2d");a.fillStyle="eraser"===t?"white":"black",a.globalCompositeOperation="eraser"===t?"destination-out":"source-over",e.setLastPos(wp.begin(Object.assign({ctx:a},e.positionToStage(o,s),{brushSize:n,color:e.strokeColor,eraserMode:"eraser"===t}))),e.composeMask()},addPoint(t,n,i,o={erase:!1}){e.setLastPos(wp.draw(Object.assign({ctx:e.offscreenCanvasRef.getContext("2d")},e.positionToStage(t,n),{brushSize:i,color:e.strokeColor,lastPos:e.lastPos,eraserMode:o.erase}))),(!e._lastComposeTime||Date.now()-e._lastComposeTime>16)&&(e.composeMask(),e._lastComposeTime=Date.now())},positionToStage:(t,n)=>({x:Math.floor(t/e.parent.stageZoom),y:Math.floor(n/e.parent.stageZoom)}),endPath(){const{annotation:t}=e.object;e.finalizeRegion(),e.updateImageURL(),t.startAutosave(),e.notifyDrawingFinished(),t.autosave&&setTimeout(()=>t.autosave())},updateImageSize(t,n,i,o){e.parent.stageWidth>1&&e.parent.stageHeight>1&&(e.finalizeRegion(),e.needsUpdate=e.needsUpdate+1)},getImageSnapshotCanvas(){const t=document.createElement("canvas");t.width=e.offscreenCanvasRef.width,t.height=e.offscreenCanvasRef.height;const n=t.getContext("2d");return n.globalCompositeOperation="destination-atop",n.fillStyle="black",n.fillRect(0,0,n.canvas.width,n.canvas.height),n.drawImage(e.offscreenCanvasRef,0,0),t},isHovered:()=>function(e){if(null==e||!e.layerRef||null==e||!e.offscreenCanvasRef||null==e||!e.imageRef)return!1;const t=e.layerRef.getStage(),n=null==t?void 0:t.getPointerPosition(),i=e.offscreenCanvasRef.getContext("2d");if(!n||!i)return!1;try{const t=e.imageRef.getAbsoluteTransform().copy().invert().point(n),{width:o,height:s}=e.offscreenCanvasRef,a=Math.floor(t.x/e.parent.stageZoom),r=Math.floor(t.y/e.parent.stageZoom);return!(a<0||r<0||a>=o||r>=s)&&i.getImageData(a,r,1,1).data[3]>0}catch(e){return console.warn("Error checking pixel transparency:",e),!1}}(e),serialize(t){const n={imageDataURL:e.imageDataURL};return e.parent.createSerializedResult(e,n)}}}),Pp=u.gK.compose("BitmaskRegionModel",Ze,Ge,mt,Fa,Ae,kp),Rp=$a(({item:e,setShapeRef:t})=>{var n,i,o,s,a,r,l;const c=null!=(n=null==(i=e.parent)?void 0:i.regs.filter(e=>e.highlighted))?n:[],d=e.highlighted||e.selected,u=null==(o=e.parent)?void 0:o.currentImageEntity,{width:h,height:g}=(0,f.useMemo)(()=>e.parent?e.canvasSize():{width:0,height:0},[null==(s=e.parent)?void 0:s.stageWidth,null==(a=e.parent)?void 0:a.stageHeight,null==u?void 0:u.naturalWidth,null==u?void 0:u.naturalHeight]);null==(r=e.parent)||r.stageRef;return(0,ae.jsx)(Ga,{item:e,children:(0,ae.jsxs)(us.YJ,{ref:e.setLayerRef,children:[(0,ae.jsxs)(us.YJ,{id:e.cleanId,name:"bitmask",visible:!e.hidden,listening:!1,opacity:e.opacity,children:[d&&c.length<2&&(0,ae.jsx)(us.rw,{fill:"black",x:0,y:0,width:h,height:g,listening:!1}),(0,ae.jsx)(us._V,{ref:e.setImageRef,image:e.bitmaskCanvasRef,width:h,height:g,listening:!1,imageSmoothingEnabled:null==(l=e.parent)?void 0:l.smoothing})]}),(0,ae.jsx)(us.YJ,{listening:!1,opacity:e.opacity,children:d&&c.length>1&&e.outline.map((t,n)=>(0,ae.jsx)(us.N1,{points:t,stroke:e.strokeColor,strokeWidth:4,closed:!0,lineJoin:"round",lineCap:"round",strokeScaleEnabled:!1,tension:.2,listening:!1},n))}),(0,ae.jsx)(us.YJ,{id:`${e.cleanId}_labels`,children:(0,ae.jsx)(La,{item:e,color:e.strokeColor})})]})})},{renderHidden:!0,shouldNotUsePortal:!0});we.addTag("bitmaskregion",Pp,Rp),we.addRegionType(Pp,"image",e=>"imageDataURL"in e);const jp=u.gK.compose("ClassificationArea",Ze,Ge,mt,u.gK.model({object:u.gK.late(()=>u.gK.reference(u.gK.union(...we.objectTypes()))),classification:!0}).views(e=>({get supportSuggestions(){return!1},get type(){return""}})).actions(()=>({serialize:()=>({})}))),Np=u.gK.union({dispatcher(e){if(e.$treenode)return e.$treenode.type;for(const t of we.customTags)if(t.region&&t.detector&&t.detector(e))return t.region;if(!e.points&&!e.shape&&!e.sequence&&!e.ranges&&!e.imageDataURL&&e.value&&Object.values(e.value).length<=1)return jp;const t=st.cleanUpId(e.object.name||e.object),n=window.Htx.annotationStore.names.get(t),i=we.getAvailableAreas(n.type,e);var o;return"video"===n.type?e.sequence||null!=(o=e.value)&&o.sequence?xp:dp:i.length?u.gK.union(...i,jp):jp}},sn,xh,dp,gp,Xl,tp,rr,or,mr,Ul,Za,Pp,xp,jp,...we.customTags.map(e=>e.region).filter(Boolean)),Tp=Np;var _p=n(87835),Ap=n.n(_p);const Ip=e=>e?e.map(e=>e.map(e=>({label:e,value:e}))):[],Mp={pathSeparator:"/",showFullPath:!0},Ep=u.gK.model("UserExtended",{id:u.gK.identifierNumber,firstName:u.gK.maybeNull(u.gK.string),lastName:u.gK.maybeNull(u.gK.string),username:u.gK.maybeNull(u.gK.string),email:u.gK.maybeNull(u.gK.string),lastActivity:u.gK.maybeNull(u.gK.string),avatar:u.gK.maybeNull(u.gK.string),initials:u.gK.maybeNull(u.gK.string),phone:u.gK.maybeNull(u.gK.string)}).preProcessSnapshot(e=>(0,E.camelizeKeys)(null!=e?e:{})).views(e=>({get displayName(){return e.firstName||e.lastName?[e.firstName,e.lastName].join(" ").trim():""}})),Kp=(u.gK.model("UserStore",{id:u.gK.maybeNull(u.gK.integer),pk:u.gK.maybeNull(u.gK.integer),firstName:u.gK.maybeNull(u.gK.string),lastName:u.gK.maybeNull(u.gK.string)}).views(e=>({get displayName(){return e.firstName||e.lastName?`${e.firstName} ${e.lastName}`:""}})),["id"]),Dp=u.gK.model({regionId:u.gK.maybe(u.gK.string),controlName:u.gK.maybe(u.gK.string)}).views(e=>({get comment(){return(0,u.PA)(e)},get annotation(){return e.comment.annotation},get region(){return e.annotation.regions.find(t=>t.cleanId===e.regionId)},get result(){return e.controlName&&e.region?e.region.results.find(t=>t.from_name.name===e.controlName):null},get overlayNode(){var t,n;const{result:i,region:o}=e;if(e.comment.isResolved||e.comment.isDeleted)return null;if(!o||o.hidden)return null;if(!((null!=(t=o.item_index)?t:0)===(null!=(n=o.object.currentItemIndex)?n:0)))return null;if(i){const e=i.from_name,t=e.isClassificationTag,n=!1!==e.isVisible,o=e.result;if(t&&n&&o===i)return i}return e.region},get targetKey(){const t=[e.regionId];return(0,E.isDefined)(e.controlName)&&t.push(e.controlName),t.join("-")}})).actions(e=>({serialize(){const t=e.toJSON();return(0,Se.A)(t,Kp)},setRegion(t){e.regionId=t.cleanId}})),Op=u.gK.model("CommentBase",{text:u.gK.string,regionRef:u.gK.optional(u.gK.maybeNull(Dp),null),classifications:u.gK.optional(u.gK.frozen({}),null)}).views(e=>({get commentsStore(){try{return je.getParentOfTypeString(e,"CommentStore")}catch(e){return null}},get annotation(){const t=(0,u._$)(e);if(null!=t&&t.annotationStore)return t.annotationStore.selected;const n=e.commentsStore;return null==n?void 0:n.annotation},get isHighlighted(){var t,n;const i=null==(t=e.commentsStore)||null==(t=t.highlightedComment)||null==(t=t.regionRef)?void 0:t.targetKey,o=null==(n=e.regionRef)?void 0:n.targetKey;return!!i&&i===o}})).actions(e=>({setText(t){e.text=t},unsetLink(){e.regionRef=null},setRegionLink(t){e.regionRef={regionId:t.cleanId}},setClassifications(t){e.classifications=t},setResultLink(t){e.regionRef={regionId:t.area.cleanId,controlName:t.from_name.name}},setHighlighted(t=!0){const n=e.commentsStore;n&&(t?n.setHighlightedComment(e):e.isHighlighted&&n.setHighlightedComment(void 0))}})),Lp=Op.named("Comment").props({id:u.gK.identifierNumber,text:u.gK.string,createdAt:u.gK.optional(u.gK.string,en.UDate.currentISODate()),updatedAt:u.gK.optional(u.gK.string,en.UDate.currentISODate()),resolvedAt:u.gK.optional(u.gK.maybeNull(u.gK.string),null),createdBy:u.gK.optional(u.gK.maybeNull(u.gK.safeReference(Ep)),null),isResolved:!1,isEditMode:u.gK.optional(u.gK.boolean,!1),isDeleted:u.gK.optional(u.gK.boolean,!1),isConfirmDelete:u.gK.optional(u.gK.boolean,!1),isUpdating:u.gK.optional(u.gK.boolean,!1)}).preProcessSnapshot(e=>(0,E.camelizeKeys)(null!=e?e:{})).volatile(e=>({_commentRef:(0,f.createRef)()})).views(e=>({get sdk(){return(0,u._$)(e).events},get isPersisted(){return e.id>0&&!e.isUpdating},get canResolveAny(){return(0,u.Zn)(e).interfaces.includes("comments:resolve-any")}})).actions(e=>{const t=(0,u.L3)(function*(){if(e.isPersisted&&!e.isDeleted){e.isResolved=!e.isResolved;try{yield e.sdk.invoke("comments:update",{id:e.id,is_resolved:e.isResolved})}catch(t){throw e.isResolved=!e.isResolved,t}}});const n=(0,u.L3)(function*(t,n=void 0){if(e.isPersisted&&!e.isDeleted){const i={id:e.id,text:t};void 0!==n&&(i.classifications=n),yield e.sdk.invoke("comments:update",i)}e.setEditMode(!1)}),i=(0,u.L3)(function*(t){if(e.isPersisted&&!e.isDeleted&&!e.isUpdating){e.isUpdating=!0;const[n]=yield e.sdk.invoke("comments:update",Object.assign({id:e.id},(0,E.snakeizeKeys)(t)));if(n.error)return void(e.isUpdating=!1);const i=(0,E.camelizeKeys)(n);(0,u.Nh)(e,i),e.isUpdating=!1}});return{toggleResolve:t,setEditMode:function(t){e.isEditMode=t},setDeleted:function(t){e.isDeleted=t},setConfirmMode:function(t){e.isConfirmDelete=t},updateComment:n,update:i,deleteComment:(0,u.L3)(function*(){e.isPersisted&&!e.isDeleted&&e.isConfirmDelete&&(yield e.sdk.invoke("comments:delete",{id:e.id})),e.setDeleted(!0),e.setConfirmMode(!1)}),setRegionLink:function(t){const n={regionId:t.cleanId};e.update({regionRef:n})},setResultLink:function(t){const n={regionId:t.area.cleanId,controlName:t.from_name.name};e.update({regionRef:n})},unsetLink:function(){e.update({regionRef:null})},scrollIntoView:()=>{const t=e._commentRef.current;t&&(t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView({block:"center",behavior:"smooth"}))}}}),zp=u.gK.model("CommentStore",{loading:u.gK.optional(u.gK.maybeNull(u.gK.string),"list"),comments:u.gK.optional(u.gK.array(Lp),[]),highlightedComment:u.gK.safeReference(Lp)}).volatile(()=>({addedCommentThisSession:!1,commentFormSubmit:()=>{},currentComment:{},inputRef:{},tooltipMessage:"",commentsKey:null})).views(e=>({get store(){return(0,u.PA)(e)},get task(){return(0,u.PA)(e).task},get annotationStore(){return(0,u.PA)(e).annotationStore},get annotation(){return e.annotationStore.selected},get annotationId(){var t;return isNaN(null==(t=e.annotation)?void 0:t.pk)?void 0:e.annotation.pk},get draftId(){var t;return null!=(t=e.annotation)&&t.draftId?e.annotation.draftId:null},get currentUser(){return(0,u.Zn)(e).user},get commentClassificationsItems(){return(e=>{if(!e)return[];const t=(new DOMParser).parseFromString(e,"application/xml"),n=[],i=(e,t=0,n=[])=>{const o=e.getAttribute("value")||"",s=[...n,o],a=[];return e.querySelectorAll(":scope > TaxonomyItem").forEach(e=>{a.push(i(e,t+1,s))}),{label:o,children:a.length?a:void 0,depth:t,path:s}},o=t.querySelector("Taxonomy");return o&&o.querySelectorAll(":scope > TaxonomyItem").forEach(e=>{n.push(i(e))}),n})((0,u.Zn)(e).commentClassificationConfig)},get sdk(){return(0,u._$)(e).events},get isListLoading(){return"list"===e.loading},get taskId(){var t;return null==(t=e.task)?void 0:t.id},get canPersist(){return(0,Ne.VS)(Ne.K3)?null!==e.taskId&&void 0!==e.taskId:null!==e.annotationId&&void 0!==e.annotationId},get isCommentable(){return!e.annotation||["annotation"].includes(e.annotation.type)},get queuedComments(){return e.comments.filter(e=>!e.isPersisted).sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())},get hasUnsaved(){return e.queuedComments.length>0},get commentInProgress(){if(e.annotation)return e.currentComment[e.annotation.id]},get overlayComments(){const t=new Set;return e.comments.filter(e=>{const{regionRef:n}=e;return!!n&&(!t.has(n.targetKey)&&(t.add(n.targetKey),!0))})},get isHighlighting(){return!!e.highlightedComment},get targetCommentsKey(){return e.annotationId?{annotation:e.annotationId}:e.draftId?{draft:e.draftId}:null},get isRelevantList(){return!(!e.commentsKey||!e.targetCommentsKey)&&(Object.keys(e.commentsKey).length===Object.keys(e.targetCommentsKey).length&&Object.keys(e.commentsKey).every(t=>e.commentsKey[t]===e.targetCommentsKey[t]))}})).actions(e=>{const t=(0,u.L3)(function*(t){if("addComment"===e.loading)return;"string"==typeof t&&(t={text:t}),e.setLoading("addComment");const n=-1*Date.now(),i=Object.assign({},(0,E.snakeizeKeys)(t),{id:n,task:e.taskId,created_by:e.currentUser.id,created_at:en.UDate.currentISODate()});let o=!1;const{annotation:s}=e;if(!(0,Ne.VS)(Ne.K3)||e.annotationId||e.draftId||(s.history.hasChanges&&!s.draftSaved?(s.saveDraftImmediately(),yield(0,d.z7)(()=>s.draftSaved)):(s.versions.draft=s.versions.result,s.setDraftSelected(),s.setDraftSaving(!0),yield e.store.submitDraft(e.annotation),s.onDraftSaved()),o=!0),e.annotationId&&(i.annotation=e.annotationId),e.draftId&&(i.draft=e.draftId),e.comments.unshift(i),e.setAddedCommentThisSession(!0),e.canPersist)try{const[t]=yield e.sdk.invoke("comments:create",i);t&&(e.replaceId(n,t),e.setCurrentComment(void 0),o&&e.listComments())}catch(t){throw e.removeCommentById(n),t}finally{e.setLoading(null)}else e.setLoading(null)}),n=(0,u.L3)(function*(){e.currentComment&&(yield t(e.currentComment))});const i=(0,u.L3)(function*({mounted:t={current:!0},suppressClearComments:n}={}){if(n||e.setComments([]),e.draftId||e.annotationId)try{t.current&&e.setLoading("list");const n=e.annotationId,i=e.targetCommentsKey,[o]=yield e.sdk.invoke("comments:list",{annotation:n,draft:e.draftId});t.current&&n===e.annotationId&&e.setComments(o,i)}catch(e){console.error(e)}finally{t.current&&e.setLoading(null)}});return{serialize:function({commentsFilter:t,queueComments:n}={commentsFilter:"all",queueComments:!1}){const i=(0,u.dV)("queued"===t?e.queuedComments:e.comments);return{comments:n?i.map(e=>Object.assign({id:e.id>0?-1*e.id:e.id},e)):i}},hasCache:function(e){localStorage.getItem(`commentStore.${e}`)},removeCache:function(e){localStorage.removeItem(`commentStore.${e}`)},toCache:function(t,n={commentsFilter:"all",queueComments:!0}){localStorage.setItem(`commentStore.${t}`,JSON.stringify(e.serialize(n)))},fromCache:function(t,{merge:n=!0,queueRestored:i=!1}={}){const o=localStorage.getItem(`commentStore.${t}`);if(o){const t=JSON.parse(o);if(Array.isArray(null==t?void 0:t.comments)){let o=[];i&&(o=t.comments.map(e=>e.id)),n&&(t.comments=Ap()([...t.comments,...(0,u.dV)(e.comments)],"id").sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())),o.length&&(t.comments=t.comments.map(e=>o.includes(e.id)?Object.assign({id:e.id>0?-1*e.id:e.id},e):e)),e.setComments(t.comments)}}},restoreCommentsFromCache:async function(t){e.fromCache(t,{merge:!0,queueRestored:!0})},setAddedCommentThisSession:function(t=!1){e.addedCommentThisSession=t},setCommentFormSubmit:function(t){e.commentFormSubmit=t},setInputRef:function(t){e.inputRef=t},setLoading:function(t=null){e.loading=t},setTooltipMessage:function(t){e.tooltipMessage=t},replaceId:function(t,n){const i=e.comments,o=i.findIndex(e=>e.id===t);if(o>-1){const e=(0,u.dV)(i[o]);i[o]=Object.assign({},e,{id:n.id||e.id})}},removeCommentById:function(t){const n=e.comments,i=n.findIndex(e=>e.id===t);i>-1&&n.splice(i,1)},persistQueuedComments:async function(){const t=e.queuedComments;if(e.canPersist&&t.length){!(0,Ne.VS)(Ne.K3)||e.annotationId||e.draftId||await e.store.submitDraft(e.annotation);try{e.setLoading("persistQueuedComments");for(const n of t){e.annotationId?n.annotation=e.annotationId:e.draftId?n.draft=e.draftId:n.task=e.taskId;const[t]=await e.sdk.invoke("comments:create",n);t&&e.replaceId(n.id,t)}}catch(e){console.error(e)}finally{e.setLoading(null)}}},setCurrentComment:function(t){e.currentComment=Object.assign({},e.currentComment,{[e.annotation.id]:t})},addCurrentComment:n,addComment:t,setComments:function(t,n=null){t&&(e.comments.replace(t),e.commentsKey=n)},listComments:i,setHighlightedComment:function(t){e.highlightedComment=t}}}),Bp=u.gK.union(sn,Za,Pp,or,gp,rr,mr,Ul,Xl,wu,tp,gp,dp,xh,xp,...we.customTags.map(e=>e.region).filter(Boolean));var Fp;const Hp=Fn("RegionStore"),Vp="outliner:sort",$p="outliner:sort-direction",Wp="outliner:group",Up="regionstore:view",Gp=u.gK.model({selected:u.gK.optional(u.gK.map(u.gK.safeReference(Bp)),{}),drawingSelected:u.gK.optional(u.gK.map(u.gK.safeReference(Bp)),{})}).views(e=>({get keys(){return Array.from(e.selected.keys())},get annotation(){return(0,u.PA)(e).annotation},get highlighted(){return 1===e.selected.size?e.selected.values().next().value:null},get size(){return e.selected.size},get list(){return Array.from(e.selected.values())},isSelected:t=>e.selected.has(t.id)})).actions(e=>{const t=M(()=>{e._updateResultsFromSelection()},0);return{beforeUnselect(e){e.perRegionTags.forEach(e=>null==e.submitChanges?void 0:e.submitChanges())},afterUnselect(e){null==e.afterUnselectRegion||e.afterUnselectRegion()},drawingSelect(t){e.drawingSelected.put(t)},drawingUnselect(){Array.from(e.drawingSelected.values()).forEach(t=>{e.drawingSelected.delete(t.id)})},select(n){var i;e.selected.put(n),n.selectRegion&&n.selectRegion(),e.highlighted?(e.highlighted.perRegionTags.forEach(e=>null==e.updateFromResult?void 0:e.updateFromResult(void 0)),e.highlighted.labelingTags.forEach(e=>null==e.updateFromResult?void 0:e.updateFromResult(void 0)),t()):t(),null==(i=n.object)||null==i.afterRegionSelected||i.afterRegionSelected(n)},_updateResultsFromSelection(){e._updateResultsFromRegions(e.selected.values())},_updateResultsFromRegions(t){const n={},i={};Array.from(t).map(e=>{e.results.forEach(e=>{const t=e.from_name.name,o=n[t];void 0!==o?n[t]=e.mergeMainValue(o):(i[t]=e.from_name,n[t]=e.mainValue)})}),e.annotation.unselectStates();for(const[e,t]of Object.entries(n)){const n=i[e];null==n.updateFromResult||n.updateFromResult(t)}},unselect(t){e.beforeUnselect(t),e.selected.delete(t.id),e.afterUnselect(t)},clear(){const t=[...e.selected.values()];for(const n of t)e.beforeUnselect(n);e.selected.clear();for(const n of t)e.afterUnselect(n)},highlight(t){e.clear(),e.select(t)}}}),Yp=u.gK.model("RegionStore",{sort:u.gK.optional(u.gK.enumeration(["date","score","mediaStartTime"]),()=>{var e;return null!=(e=window.localStorage.getItem(Vp))?e:"date"}),sortOrder:u.gK.optional(u.gK.enumeration(["asc","desc"]),()=>{var e;return null!=(e=window.localStorage.getItem($p))?e:"asc"}),group:u.gK.optional(u.gK.enumeration(["type","label","manual"]),()=>{var e;return null!=(e=window.localStorage.getItem(Wp))?e:"manual"}),filter:u.gK.maybeNull(u.gK.array(u.gK.safeReference(Bp)),null),view:u.gK.optional(u.gK.enumeration(["regions","labels"]),null!=(Fp=window.localStorage.getItem(Up))?Fp:"regions"),selection:u.gK.optional(Gp,{})}).views(e=>{let t;const n=n=>(i,o)=>{if(i.shiftKey){const i=((e,n)=>{const i=[];let o=0;return st.traverseTree({children:n},n=>{if(n.isArea)return n.item!==t&&n.item!==e&&1!==o||(n.item&&i.push(n.item),n.item===t&&++o,n.item===e&&++o),o>=2?Qe:void 0}),i})(o,n);return i.forEach(t=>{e.selection.select(t)}),void(t=null)}t=o,i.metaKey||i.ctrlKey?e.toggleSelection(o):e.selection.highlighted!==o?e.highlight(o):e.clearSelection()};return{get annotation(){return(0,u.PA)(e)},get classifications(){const t=Array.from(e.annotation.names.values()).filter(e=>(0,E.isDefined)(e)).filter(e=>"textarea"===e.type&&!e.perregion).map(e=>e.regions);return[].concat(...t)},get regions(){return Array.from(e.annotation.areas.values()).filter(e=>!e.classification)},get filteredRegions(){return e.filter||e.regions},get suggestions(){return Array.from(e.annotation.suggestions.values()).filter(e=>!e.classification)},get isAllHidden(){return!e.regions.find(e=>!e.hidden)},get sortedRegions(){return{date:t=>[...e.filteredRegions].sort(t?(e,t)=>t.ouid-e.ouid:(e,t)=>e.ouid-t.ouid),score:t=>[...e.filteredRegions].sort(t?(e,t)=>t.score-e.score:(e,t)=>e.score-t.score),mediaStartTime:t=>[...e.filteredRegions].sort((n,i)=>{const o=e.getRegionMediaTime(n),s=e.getRegionMediaTime(i);return null===o&&null===s?0:null===o?1:null===s?-1:t?s-o:o-s})}[e.sort]("desc"===e.sortOrder)},get regionIndexMap(){const t={};return e.sortedRegions.forEach((e,n)=>{t[e.id]=n+1}),t},getRegionMediaTime(e){var t,n;return"audioregion"!==e.type&&"timeseriesregion"!==e.type||"number"!=typeof e.start?"timelineregion"===e.type&&null!=(t=e.ranges)&&t[0]?e.ranges[0].start:"videorectangleregion"===e.type&&null!=(n=e.sequence)&&n[0]?e.sequence[0].frame:null:e.start},getRegionsTree:t=>null===e.group||"manual"===e.group?e.asTree(t):"label"===e.group?e.asLabelsTree(t):"type"===e.group?e.asTypeTree(t):void console.error(`Grouping by ${e.group} is not implemented`),asTree(t){const i=e.sortedRegions,o=[],s=new Map,a=n(o);return i.forEach((e,n)=>{const i=t(e,n,a);Object.assign(i,{item:e,children:[],isArea:!0}),s.set(e.cleanId,i)}),s.forEach(e=>{var t;const n=e.item.parentID,i=n?null!=(t=s.get(n))?t:s.get(n.replace(/#(.+)/i,"")):null;if(i)return i.children.push(e);o.push(e)}),o},asLabelsTree(t){const i={},o=[],s=n(o);let a=0;const r=(e,n,o)=>{var r;const l=((e,n)=>{const o=i[n];return o||(i[n]=Object.assign({},t(e,a,!0),{id:n,isGroup:!0,isNotLabel:!0,children:[]}))})(n,e),c=l.id,d=null==(r=(e=>{var t;return(null==(t=e.labeling)?void 0:t.selectedLabels)||e.emptyLabel&&[e.emptyLabel]})(o))||null==(r=r[0])?void 0:r.hotkey;(0,Ne.VS)(Ne.TU)&&(l.hotkey=d,l.pos=c.slice(0,c.indexOf("#"))),l.children.push(Object.assign({},t(o,a,!1,null,s,c),{item:o,isArea:!0}))},l=(e,t)=>{if(e)for(const n of e)r(`${n.value}#${n.id}`,n,t);else r("no-label",void 0,t)};for(const t of e.regions){var c;l(null==(c=t.labeling)?void 0:c.selectedLabels,t),a++}const d=Object.values(i);return(0,Ne.VS)(Ne.TU)&&d.sort((e,t)=>e.hotkey>t.hotkey?1:e.hotkey<t.hotkey?-1:0),o.push(...d),o},asTypeTree(t){const i={},o=[],s=n(o);let a=0;const r=e=>{const n=((e,n)=>{const o=i[n];if(o)return o;const s={type:"tool",value:n.replace("region",""),background:"#000"};return i[n]=Object.assign({},t(s,a,!0),{id:n,key:n,isArea:!1,children:[],isGroup:!0,entity:e})})(e,e.type);n.children.push(Object.assign({},t(e,a,!1,null,s),{item:e,isArea:!0}))};for(const t of e.regions)r(t),a++;return o.push(...Object.values(i)),o},get hasSelection(){return!!e.selection.size},isSelected:t=>e.selection.isSelected(t),get selectedIds(){return Array.from(e.selection.selected.values()).map(e=>e.id)},get persistantView(){var t;return null!=(t=window.localStorage.getItem(Up))?t:e.view}}}).actions(e=>({addRegion(t){e.regions.push(t),(0,u._$)(e).events.invoke("entityCreate",t)},toggleSortOrder(){"asc"===e.sortOrder?e.sortOrder="desc":e.sortOrder="asc"},setView(t){(0,Ne.VS)(Ne.TU)&&window.localStorage.setItem(Up,t),e.view=t},setSort(t){e.sort===t?e.toggleSortOrder():(e.sortOrder="asc",e.sort=t),window.localStorage.setItem(Vp,e.sort),window.localStorage.setItem($p,e.sortOrder),e.initHotkeys(),e.annotation.updateAppearenceFromState()},setGrouping(t){e.group=t,window.localStorage.setItem(Wp,e.group)},setFilteredRegions(t){if(e.regions.length===t.length)e.filter=null,e.regions.forEach(e=>e.filtered&&e.toggleFiltered());else{const n=t.map(e=>e.id);e.filter=t,e.regions.forEach(e=>{!e.hideable||e.hidden&&!e.filtered||(n.includes(e.id)?e.hidden&&e.toggleFiltered():e.hidden||e.toggleFiltered())})}e.annotation.updateAppearenceFromState()},deleteRegion(t){(0,u.Yo)(t);const n=e.filterByParentID(t.id);n&&n.forEach(e=>e.setParentID(t.parentID)),(0,u._$)(e).events.invoke("entityDelete",t),(0,u.zr)(t),e.initHotkeys()},findRegionID:t=>t?e.regions.find(e=>e.id===t):null,findRegion:t=>e.findRegionID(t),filterByParentID:t=>e.regions.filter(e=>e.parentID===t),normalizeRegionID:t=>t?(t.includes("#")||(t=`${t}#${e.annotation.id}`),t):"",afterCreate(){var t;(0,u.k4)(e,t=>{"add"!==t.op&&"delete"!==t.op||-1===t.path.indexOf("/regions/")||e.initHotkeys()}),e.view=null!=(t=window.localStorage.getItem(Up))?t:e.annotation.store.settings.displayLabelsByDefault?"labels":"regions"},initHotkeys(){Hp.unbindAll(),e.sortedRegions.forEach((t,n)=>{Hp.addKey("alt+shift+"+(n+1),()=>{e.unselectAll(),t.selectRegion()})}),Hp.addKey("alt+shift+$n",()=>{},"Select a region")},unselectAll(){e.annotation.unselectAll()},unhighlightAll(){e.regions.forEach(e=>e.setHighlight(!1))},selectNext(){const{regions:t}=e,n=e.regions.findIndex(e=>e.selected);if(n<0){const n=t[0];n&&e.annotation.selectArea(n)}else{const i=(0,E.isDefined)(t[n+1])?t[n+1]:t[0];i&&e.annotation.selectArea(i)}},toggleVisibility(){const t=!e.isAllHidden;e.regions.forEach(e=>{e.hidden!==t&&e.toggleHidden()})},selectRegionByID(t){const n=e.normalizeRegionID(t),i=e.findRegionID(n);i&&e.toggleSelection(i,!0)},setRegionVisible(t){const n=e.normalizeRegionID(t),i=e.findRegionID(n);i&&(e.regions.forEach(e=>{e.hidden||e.toggleHidden()}),i.toggleHidden())},setHiddenByTool(t,n){e.regions.forEach(e=>{e.hidden!==t&&e.type===n.type&&e.toggleHidden()})},setHiddenByLabel(t,n){e.regions.forEach(e=>{if(e.hidden!==t){const t=e.labeling;if(t){t.selectedLabels.includes(n)&&e.toggleHidden()}}})},highlight(t){e.selection.highlight(t)},clearSelection(){e.selection.clear()},selectRegionsByIds(t){e.regions.map(n=>{-1!==t.indexOf(n.id)&&e.toggleSelection(n,!0)})},toggleSelection(t,n){(0,E.isDefined)(n)||(n=!e.selection.isSelected(t)),n?e.selection.select(t):e.selection.unselect(t)}}));var Xp;const qp="relations:order",Zp=u.gK.model("Relation",{id:u.gK.optional(u.gK.identifier,I),node1:u.gK.reference(Tp),node2:u.gK.reference(Tp),direction:u.gK.optional(u.gK.enumeration(["left","right","bi"]),"right"),labels:u.gK.maybeNull(u.gK.array(u.gK.string))}).volatile(()=>({showMeta:!1,visible:!0})).views(e=>({get parent(){return(0,u.k2)(e,Jp)},get control(){return e.parent.control},get selectedValues(){var t;return null==(t=e.labels)?void 0:t.filter(t=>{var n;return null==(n=e.control)?void 0:n.values.includes(t)})},get hasRelations(){var t;return(null==(t=e.control)||null==(t=t.children)?void 0:t.length)>0},get shouldRender(){if(!(0,u._n)(e))return!1;const{node1:t,node2:n}=e,[i,o]=[t.item_index,n.item_index];return(!(0,E.isDefined)(i)||!t.object.multiImage||i===t.object.currentImage)&&(!(0,E.isDefined)(o)||!n.object.multiImage||o===n.object.currentImage)}})).actions(e=>({rotateDirection(){const t=["left","right","bi"];let n=t.findIndex(t=>t===e.direction);n+=1,n>=t.length&&(n=0),e.direction=t[n]},toggleHighlight(){e.node1===e.node2?e.node1.toggleHighlight():(e.node1.toggleHighlight(),e.node2.toggleHighlight())},toggleMeta(){e.showMeta=!e.showMeta},setSelfHighlight(t=!1){t?e.parent.setHighlight(e):e.parent.removeHighlight()},toggleVisibility(){e.visible=!e.visible},setRelations(t){e.labels=t}})),Jp=u.gK.model("RelationStore",{relations:u.gK.array(Zp),order:u.gK.optional(u.gK.enumeration(["asc","desc"]),null!=(Xp=window.localStorage.getItem(qp))?Xp:"asc")}).volatile(()=>({showConnections:!0,_highlighted:null,control:null})).views(e=>({get highlighted(){return e.relations.find(t=>t.id===e._highlighted)},get size(){return e.relations.length},get orderedRelations(){return e.relations?"asc"===e.order?e.relations.slice():e.relations.slice().reverse():[]},get isAllHidden(){return!e.relations.find(e=>!e.visible)},get values(){var t,n;return null!=(t=null==(n=e.control)?void 0:n.values)?t:[]}})).actions(e=>({afterAttach(){const t=(0,u.Zn)(e);let n=null;st.traverseTree(t.annotationStore.root,e=>{if("relations"===e.type)return n=e,Je}),e.setControl(n)},setControl(t){e.control=t},findRelations(t,n){const i=t.id||t,o=(null==n?void 0:n.id)||n;return o?e.relations.filter(e=>e.node1.id===i&&e.node2.id===o):e.relations.filter(e=>e.node1.id===i||e.node2.id===i)},nodesRelated:(t,n)=>e.findRelations(t,n).length>0,addRelation(t,n){if(e.nodesRelated(t,n))return;const i=Zp.create({node1:t,node2:n});return e.relations.push(i),i},deleteRelation(t){e.relations=e.relations.filter(e=>e.id!==t.id),(0,u.zr)(t)},deleteNodeRelation(t){const n=e.findRelations(t);n.length&&n.forEach(e.deleteRelation)},deleteAllRelations(){e.relations.forEach(e=>(0,u.zr)(e)),e.relations=[]},serialize:()=>e.relations.map(e=>{const t={from_id:e.node1.cleanId,to_id:e.node2.cleanId,type:"relation",direction:e.direction};return e.selectedValues&&(t.labels=e.selectedValues),t}),deserializeRelation(t,n,i,o){const s=e.addRelation(t,n);s&&(s.direction=i,s.labels=o)},toggleConnections(){e.showConnections=!e.showConnections},toggleOrder(){e.order="asc"===e.order?"desc":"asc",window.localStorage.setItem(qp,e.order)},toggleAllVisibility(){const t=!e.isAllHidden;e.relations.forEach(e=>{e.visible!==t&&e.toggleVisibility()})},setHighlight(t){e._highlighted=t.id},removeHighlight(){e._highlighted=null}})),Qp=Jp,ef=["text"],tf=["id","value","type"],nf=Fn("Annotations","Annotations"),of=He.ff.isActive(He.ff.FF_CUSTOM_TAGS)?e=>{if(Array.isArray(e.text)){return(0,Se.A)(e,ef)}return e}:e=>{const t=Object.assign({},e);return ct.properties.value.propertyNames.forEach(e=>{delete t[e]}),t},sf=u.gK.model("TrackedState",{areas:u.gK.map(Tp),relationStore:u.gK.optional(Qp,{})}),af=u.gK.union({dispatcher:e=>"number"==typeof e?u.gK.safeReference(Ep):e&&"object"==typeof e&&(e.firstName||e.email||e.username)?u.gK.frozen():u.gK.safeReference(Ep),cases:{frozen:u.gK.frozen(),reference:u.gK.safeReference(Ep)}}),rf=u.gK.model("AnnotationBase",Object.assign({id:u.gK.identifier,pk:u.gK.maybeNull(u.gK.string),selected:u.gK.optional(u.gK.boolean,!1),type:u.gK.enumeration(["annotation","prediction","history"]),createdDate:u.gK.optional(u.gK.string,en.UDate.currentISODate()),createdAgo:u.gK.maybeNull(u.gK.string),createdBy:u.gK.optional(u.gK.string,"Admin"),user:u.gK.optional(u.gK.maybeNull(af),null),score:u.gK.maybeNull(u.gK.number),parent_prediction:u.gK.maybeNull(u.gK.integer),parent_annotation:u.gK.maybeNull(u.gK.integer),last_annotation_history:u.gK.maybeNull(u.gK.integer),comment_count:u.gK.maybeNull(u.gK.integer),unresolved_comment_count:u.gK.maybeNull(u.gK.integer),loadedDate:u.gK.optional(u.gK.Date,()=>new Date),leadTime:u.gK.maybeNull(u.gK.number),draftSaved:u.gK.maybe(u.gK.string),userGenerate:u.gK.optional(u.gK.boolean,!0),sentUserGenerate:u.gK.optional(u.gK.boolean,!1),localUpdate:u.gK.optional(u.gK.boolean,!1),ground_truth:u.gK.optional(u.gK.boolean,!1),skipped:!1,trackedState:u.gK.optional(sf,{}),history:u.gK.optional(Jm,{targetPath:"../trackedState"}),dragMode:u.gK.optional(u.gK.boolean,!1),editable:u.gK.optional(u.gK.boolean,!0),readonly:u.gK.optional(u.gK.boolean,!1),suggestions:u.gK.map(Tp),regionStore:u.gK.optional(Yp,{regions:[]}),isDrawing:u.gK.optional(u.gK.boolean,!1),commentStore:u.gK.optional(zp,{comments:[]})},(0,Ne.VS)(Ne.cE)?{root:je.allModelsTypes()}:{})).views(e=>({get areas(){return e.trackedState.areas},get relationStore(){return e.trackedState.relationStore}})).preProcessSnapshot(e=>{var t,n,i,o,s,a,r;const l=null!=(t=null!=(n=e.user)?n:e.completed_by)?t:void 0;let c;const d=t=>{var n,i,o;const s=null==(n=t.children)?void 0:n.map(d),a=null==(i=t.imageEntities)?void 0:i.map(d);let r=t;return s&&(r=Object.assign({},r,{children:s})),a&&(r=Object.assign({},r,{imageEntities:a})),r.id&&(r=Object.assign({},r,{id:`${null!=(o=r.name)?o:r.id}@${e.id}`})),r};(0,Ne.VS)(Ne.cE)&&(c=d(e.root.toJSON()));return Object.assign({},e,(0,Ne.VS)(Ne.cE)?{root:c}:{},{user:l,editable:null!=(i=e.editable)?i:"annotation"===e.type,createdBy:(e=>{var t;if("prediction"===e.type){var n,i;return(null!=(n=null==(i=e.model_version)?void 0:i.trim())?n:"")||"Admin"}return null!=(t=e.createdBy)?t:"Admin"})(e),createdDate:(u=e,null!=(h=null!=(g=u.draft_created_at)?g:u.created_at)?h:u.createdDate),ground_truth:null!=(o=null!=(s=e.honeypot)?s:e.ground_truth)&&o,skipped:e.skipped||e.was_cancelled,acceptedState:null!=(a=null!=(r=e.accepted_state)?r:e.acceptedState)?a:null});var u,h,g}).views(e=>(0,Ne.VS)(Ne.cE)?{}:{get root(){return e.list.root},get names(){return e.list.names},get toNames(){return e.list.toNames}}).views(e=>({get store(){return(0,u.Zn)(e)},get list(){return(0,u.PA)(e,2)},get objects(){return Array.from(e.names.values()).filter(e=>e.isObjectTag)},get regions(){return Array.from(e.areas.values())},get lastSelectedRegion(){return e.selectedRegions[e.selectedRegions.length-1]},get results(){const t=[];return(0,u._n)(e)&&e.areas.forEach(e=>e.results.forEach(e=>t.push(e))),t},get serialized(){return e.areas.toJSON(),e.results.map(e=>e.serialize()).filter(Boolean).concat(e.relationStore.serialize())},get serializedSelection(){e.areas.toJSON();const t=[];return e.areas.forEach(e=>{e.inSelection&&e.results.forEach(e=>{t.push(e)})}),t.map(e=>e.serialize()).filter(Boolean)},get highlightedNode(){return e.regionStore.selection.highlighted},get hasSelection(){return e.regionStore.hasSelection},get selectionSize(){return e.regionStore.selection.size},get selectedRegions(){return Array.from(e.regionStore.selection.selected.values())},get selectedDrawingRegions(){return Array.from(e.regionStore.selection.drawingSelected.values())},get exists(){const t=e.userGenerate&&e.sentUserGenerate||(0,E.isDefined)(e.versions.result),n=(0,E.isDefined)(e.pk);return t&&n},get hasSuggestionsSupport(){return e.objects.some(e=>e.supportSuggestions)},get isNonEditableDraft(){if(!(!!e.user&&!!e.store.user))return!1;const t=null===e.pk,n=e.user.id!==e.store.user.id;return t&&n},isReadOnly:()=>e.isNonEditableDraft||e.readonly||!e.editable})).volatile(()=>({hidden:!1,draftId:0,draftSelected:!1,autosaveDelay:5e3,isDraftSaving:!1,isSuggestionsAccepting:!1,submissionStarted:0,versions:{},resultSnapshot:""})).volatile(()=>(0,Ne.VS)(Ne.cE)?{names:new Map,toNames:new Map,ids:new Map}:{}).views(e=>({get canBeReviewed(){var t,n,i;const o=e.store;return(0,Ne.VS)(Ne.I8)&&(null==(t=e.user)?void 0:t.email)&&(null==(n=o.user)?void 0:n.email)!==(null==(i=e.user)?void 0:i.email)&&(0,u._$)(e).events.hasEvent("acceptAnnotation")&&o.hasInterface("annotations:view-all")&&!e.skipped&&!isNaN(e.pk)}})).actions(e=>({reinitHistory(t=!0){var n;e.history.reinit(t),null==(n=e.autosave)||n.cancel(),"annotation"===e.type&&e.setInitialValues()},setEditable(t){e.editable=t},setReadonly(t){e.readonly=t},setIsDrawing(t){e.isDrawing=t},setUnresolvedCommentCount(t){e.unresolved_comment_count=t},setCommentCount(t){e.comment_count=t},setGroundTruth(t,n=!0){const i=(0,u.Zn)(e);if(i&&i!==e&&n){const t=i.annotationStore,n=t=>{e!==t&&t.setGroundTruth(!1,!1)};t.predictions.forEach(n),t.annotations.forEach(n)}e.ground_truth=t,n&&(0,u._$)(e).events.invoke("groundTruth",e.store,e,t)},sendUserGenerate(){e.sentUserGenerate=!0},setLocalUpdate(t){e.localUpdate=t},setDragMode(t){e.dragMode=t},updatePersonalKey(t){var n,i;e.pk=t,null==(n=(i=(0,u.Zn)(e)).addAnnotationToTaskHistory)||n.call(i,e.pk)},toggleVisibility(t){e.hidden=void 0===t?!e.hidden:!t},setHighlightedNode(){},selectArea(t){e.highlightedNode!==t&&e.regionStore.highlight(t)},toggleRegionSelection(t,n){e.regionStore.toggleSelection(t,n)},selectAreas(t){e.unselectAreas(),e.extendSelectionWith(t)},extendSelectionWith(t){for(const n of Array.isArray(t)?t:[t])e.regionStore.toggleSelection(n,!0)},unselectArea(t){e.highlightedNode===t&&e.regionStore.toggleSelection(t,!1)},unselectAreas(){e.selectionSize&&e.regionStore.clearSelection()},lockSelectedRegions(){for(const t of e.selectedRegions)t.setLocked(!t.locked)},hideSelectedRegions(){for(const t of e.selectedRegions)t.toggleHidden()},deleteSelectedRegions(){for(const t of e.selectedRegions)t.deleteRegion()},unselectStates(){e.names.forEach(e=>null==e.unselectAll?void 0:e.unselectAll())},unselectAll(t=!1){const n=t&&e.store.settings.continuousLabeling;e.unselectAreas(),n||e.unselectStates()},removeArea(e){(0,u.zr)(e)},deleteAllRegions({deleteReadOnly:t=!1}={}){let n=Array.from(e.areas.values());if(t){e.unselectAll(!0),e.setIsDrawing(!1),e.relationStore.deleteAllRelations();for(const e of n)null==e.destroyRegion||e.destroyRegion(),(0,u.zr)(e);e.updateObjects()}else{!1===t&&(n=n.filter(e=>!1===e.readonly));for(const e of n)e.deleteRegion();e.updateObjects()}},addRegion(t){e.regionStore.unselectAll(!0),e.isLinkingMode&&(e.addLinkedRegion(t),e.stopLinkingMode())},validate(){let t=!0;return e.traverseTree(e=>{if(t=null==e.validate?void 0:e.validate(),!1===t)return Qe}),null==t||t},traverseTree:t=>st.traverseTree(e.root,t),beforeSend(){e.traverseTree(e=>{null==e||null==e.beforeSend||e.beforeSend()}),e.stopLinkingMode(),e.unselectAll()},deleteRegion(t){if(t.isReadOnly())return;const{regions:n}=e.regionStore,i=n.filter(e=>e.parentID===t.id);if(i)for(const e of i)e.setParentID(t.parentID);t.classification||(0,u._$)(e).events.invoke("entityDelete",t),e.relationStore.deleteNodeRelation(t),"polygonregion"!==t.type&&"vectorregion"!==t.type||(0,u.Yo)(t),(0,u.zr)(t),e.setIsDrawing(!1)},deleteArea(e){(0,u.zr)(e)},undo(){const{history:t,regionStore:n}=e;if(null!=t&&t.canUndo){var i,o;let c=!1;const d=n.selectedIds,u=n.findRegion(null!=(i=d[d.length-1])?i:null==(o=n.regions[n.regions.length-1])?void 0:o.id);if("polygonregion"===(null==u?void 0:u.type)){var s,a;c=(null!=(s=null==u||null==(a=u.points)?void 0:a.length)?s:0)<=1}else if("vectorregion"===(null==u?void 0:u.type)){var r,l;c=(null!=(r=null==u||null==(l=u.vertices)?void 0:l.length)?r:0)<=1}t.undo(),n.selectRegionsByIds(d),c&&(u.setDrawing(!1),e.setIsDrawing(!1))}},redo(){const{history:t,regionStore:n}=e;if(null!=t&&t.canRedo){const e=n.selectedIds;t.redo(),n.selectRegionsByIds(e)}},updateObjects(t=!0){t&&e.unselectAll(),e.names.forEach(e=>null==e.needsUpdate?void 0:e.needsUpdate()),e.updateAppearenceFromState();const n=Array.from(e.areas.values()).filter(e=>e.isDrawing);n.length&&e.regionStore.selection._updateResultsFromRegions(n)},updateAppearenceFromState(){e.areas.forEach(e=>null==e.updateAppearenceFromState?void 0:e.updateAppearenceFromState())},setInitialValues(){e.names.forEach(e=>{if(e.type.endsWith("labels")){var t;const n=null==(t=e.children)?void 0:t.find(e=>e.initiallySelected);n&&n.setSelected(!0)}})},setDefaultValues(){e.names.forEach(t=>{var n;["choices","taxonomy"].includes(null==t?void 0:t.type)&&null!=(n=t.preselectedValues)&&n.length&&e.createResult({},{[null==t?void 0:t.type]:t.preselectedValues},t,t.toname)})},addVersions(t){e.versions=Object.assign({},e.versions,t),t.draft&&e.setDraftSelected()},toggleDraft(t){const n=e.draftSelected,i=null!=t?t:!n;i!==n&&(i&&!e.versions.draft||(e.autosave.flush(),e.pauseAutosave(),e.deleteAllRegions({deleteReadOnly:!0}),i?e.deserializeResults(e.versions.draft):e.deserializeResults(e.versions.result),e.draftSelected=i,e.updateObjects(),e.startAutosave()))},startAutosave:(0,u.L3)(function*(){if((0,u._$)(e).events.hasEvent("submitDraft")&&!e.isReadOnly()){if(yield(0,E.delay)(0),e.autosave)return e.autosave.cancel(),void(e.autosave.paused=!1);e.autosave=ec()(()=>{e.autosave.paused||e.saveDraft()},e.autosaveDelay,{leading:!1}),(0,u.aQ)(e.areas,e.autosave)}}),async saveDraft(t){if(e.submissionStarted)return;if(!e.editable)return;const n=e.serializeAnnotation({fast:!0});return e.setDraftSelected(),e.versions.draft=n,e.setDraftSaving(!0),e.store.submitDraft(e,t).then(t=>(e.onDraftSaved(t),t))},submissionInProgress(){e.submissionStarted=Date.now()},saveDraftImmediately(){e.autosave&&e.autosave.flush()},async saveDraftImmediatelyWithResults(t){if(e.submissionStarted||e.isDraftSaving)return{};e.setDraftSaving(!0);return await e.saveDraft(t)},pauseAutosave(){e.autosave&&(e.autosave.paused=!0,e.autosave.cancel())},beforeDestroy(){var t;null==(t=e.autosave)||null==t.cancel||t.cancel()},setDraftId(t){e.draftId=t},setDraftSelected(t=!0){e.draftSelected=t},onDraftSaved(){e.setDraftSaved(en.UDate.currentISODate()),e.setDraftSaving(!1)},dropDraft(){e.autosave&&(e.autosave.cancel(),e.draftId=0,e.draftSelected=!1,e.draftSaved=void 0,e.versions.draft=void 0)},setDraftSaving(t=!1){e.isDraftSaving=t},setDraftSaved(t){e.draftSaved=t},afterAttach(){e.traverseTree(e=>{e.annotationAttached&&e.annotationAttached()}),e.history.onUpdate(e.updateObjects),e.startAutosave()},afterCreate(){if((0,Ne.VS)(Ne.cE)){const{names:t,toNames:n}=st.extractNames(e.root);t.forEach((t,n)=>e.names.set(n,t)),n.forEach((t,n)=>e.toNames.set(n,t)),st.traverseTree(e.root,t=>{var n;const i=null!=(n=t.id)?n:t.name;i&&e.ids.set(st.cleanUpId(i),t),e.store.task&&t.updateValue&&t.updateValue(e.store)})}e.userGenerate&&!e.sentUserGenerate&&(e.loadedDate=new Date)},setupHotKeys(){nf.unbindAll();let t=0,n=null;const i="shift+space";let o=i;e.traverseTree(e=>{e&&e.onHotKey&&e.hotkey&&nf.addKey(e.hotkey,e.onHotKey,void 0,e.hotkeyScope)}),e.traverseTree(e=>{!e||e.hotkey||"audio"!==e.type&&"audioplus"!==e.type||(t>0?o=`${i}+${t+1}`:n=e,e.hotkey=o,nf.addKey(o,e.onHotKey,"Play an audio",Fn.ALL_SCOPES),t++)}),e.traverseTree(e=>{if(e&&e.onHotKey&&!e.hotkey){const t=nf.makeComb();if(!t)return;e.hotkey=t,nf.addKey(e.hotkey,e.onHotKey)}}),n&&t>1&&(n.hotkey=`${i}+1`,nf.addKey(n.hotkey,n.onHotKey),nf.removeKey(i));const{enableHotkeys:s}=e.store.settings;Fn.setScope(s?Fn.DEFAULT_SCOPE:"__none__")},createResult(t,n,i,o,s=!1,a=[]){var r,l;o||"textarea"!==i.type||(o=e.objects[0]);const c=e.names.get(null!=(r=o.name)?r:o),d={from_name:e.names.get(i.name),to_name:c,type:i.resultType,value:n,readonly:e.readonly},h=Object.assign({id:I(),object:c},t,{value:t,results:[d]}),g=null==e||null==(l=e.areas)?void 0:l.put(h);if(null==c||null==c.afterResultCreated||c.afterResultCreated(g),g)return He.ff.isActive(He.ff.FF_MULTIPLE_LABELS_REGIONS)&&a.forEach(e=>{g.setValue(e)}),e.updateAppearenceFromState(),g.classification||(0,u._$)(e).events.invoke("entityCreate",g),s||e.afterCreateResult(g,i),g},afterCreateResult(t,n){e.store.settings.selectAfterCreate?t.classification||setTimeout(()=>(0,u._n)(t)&&e.selectArea(t)):n.isLabeling&&e.unselectAll(!0)},appendResults(t){if(!e.editable||e.readonly)return;const n={},i=e.regionStore.regions.length;for(const e of t){const t=e.id;n[t]||(n[t]=I()),e.id=n[t]}return e.deserializeResults(t),e.updateObjects(),e.regionStore.regions.slice(i)},serializeAnnotation(t){document.body.style.cursor="wait";const n=e.results.map(e=>e.serialize(t)).filter(Boolean).concat(e.relationStore.serialize(t));return document.body.style.cursor="default",n},fixBrokenAnnotation:t=>(null!=t?t:[]).reduce((t,n)=>{var i;if(!n)return t;const o=null!=(i=structuredClone(n))?i:{};if("relation"===o.type)return t.push(n),t;"htmllabels"===o.type&&(o.type="hypertextlabels"),o.normalization&&(o.meta=Object.assign({},o.meta,{text:[o.normalization]}));const s=e.names;if(o.type.endsWith("labels")){const t=Object.keys(o.value);for(const n of t)if(n.endsWith("labels")&&(!s.has(o.from_name)||!o.value[n].length&&!s.get(o.from_name).allowempty)&&(delete o.value[n],s.has(o.to_name))){const t=s.get(o.to_name),n=e.toNames.get(t.name);if(null!=n&&n.length){const e=o.type.replace(/labels$/,""),t=o.type,i="labels";for(const s of[e,t,i]){const e=n.find(e=>e.type===s);if(e){o.type=s,o.from_name=e.name;break}}}}}return s.has(o.from_name)&&s.has(o.to_name)&&t.push(o),(e=>{if(!(0,E.isDefined)(o.original_width))return;if(!s.has(o.to_name))return;const t=s.get(o.to_name);if("image"!==t.type)return;const n=t.findImageEntity(null!=(e=o.item_index)?e:0);n&&!n.imageLoaded&&(n.setNaturalWidth(o.original_width),n.setNaturalHeight(o.original_height))})(),t},[]),setSuggestions(t){const{history:n}=e;e.suggestions.clear(),t&&(e.deserializeResults(t,{suggestions:!0}),e.isSuggestionsAccepting=!0,(0,u.Zn)(e).autoAcceptSuggestions?((0,Ne.VS)(Ne.$b)&&e.history.setReplaceNextUndoState(!0),e.acceptAllSuggestions()):e.suggestions.forEach(t=>{t.supportSuggestions||(e.acceptSuggestion(t.id),(0,Ne.VS)(Ne.$b)&&n.setReplaceNextUndoState(!0))}),e.isSuggestionsAccepting=!1,(0,Ne.VS)(Ne.$b)||n.freeze("richtext:suggestions"),e.names.forEach(e=>null==e.needsUpdate?void 0:e.needsUpdate({suggestions:!0})),(0,Ne.VS)(Ne.$b)||(n.setReplaceNextUndoState(!0),n.unfreeze("richtext:suggestions")))},cleanClassificationAreas(){const t={},n=[];e.areas.forEach(e=>{const i=e.results[0].from_name.name,o=e.item_index;var s;e.classification&&(null!=(s=t[i])&&s[o]&&n.push(t[i][o]),t[i]=t[i]||{},t[i][o]=e.id)});for(const t of n)e.areas.delete(t)},deserializeResults(t,{suggestions:n=!1,hidden:i=!1}={}){try{const o=e.prepareAnnotation(t),s=n?e.suggestions:e.areas;e._initialAnnotationObj=o;for(const t of o)e.deserializeSingleResult(t,e=>s.get(e),e=>s.put(e));if(e.cleanClassificationAreas(),!i)for(const t of e.results)t.area.classification&&(null==t.from_name.updateFromResult||t.from_name.updateFromResult(t.mainValue));for(const t of o)"relation"===t.type&&e.relationStore.deserializeRelation(`${t.from_id}#${e.id}`,`${t.to_id}#${e.id}`,t.direction,t.labels)}catch(t){console.error(t),e.list.addErrors([Os.generalError(t)])}},deserializeAnnotation:(...t)=>(console.warn("deserializeAnnotation() is deprecated. Use deserializeResults() instead"),e.deserializeResults(...t)),prepareAnnotation(t){let n=t;return"object"!=typeof n&&(n=JSON.parse(n)),n=e.fixBrokenAnnotation(null!=n?n:[]),n},deserializeSingleResult(t,n,i){if("relation"!==t.type){var o;const{id:a,value:r,type:l}=t,c=(0,Se.A)(t,tf);let{from_name:d,to_name:u}=c;const h=null!=(o=e.names.get(c.to_name))?o:{},g=h.type,m=`${a||I()}#${e.id}`,p=`${c.from_name}@${m}`,f=e.prepareValue(r,g);(0,Ne.VS)(Ne.cE)&&(u=`${u}@${e.id}`,d=`${d}@${e.id}`);let v=n(m);if(!v){v=i(Object.assign({id:m,object:u},c,of(f),{value:f})),(0,Ne.VS)(Ne.gF)&&Object.defineProperty(v,"_rawResult",{value:Object.freeze(structuredClone(t))})}const y=Object.assign({},c,{id:p,type:l,value:f,from_name:d,to_name:u});if(v.addResult(y),null==v.applyAdditionalDataFromResult||v.applyAdditionalDataFromResult(y),!l.endsWith("labels")&&f.labels&&h.mergeLabelsAndResults){const t=f.labels,n=e.toNames.get(h.name).filter(e=>e.type.endsWith("labels")).find(e=>null==e?void 0:e.findLabel(t[0]));var s;if(n)v.setValue(n),null==(s=v.results.find(e=>e.type.endsWith("labels")))||s.setValue(t)}}},prepareValue(e,t){switch(t){case"text":case"hypertext":case"richtext":{const t=(0,E.isDefined)(e.start)&&(0,E.isDefined)(e.end),n=!(0,E.isDefined)(e.startOffset)&&!(0,E.isDefined)(e.endOffset);if(t&&n)return Object.assign({},e,{start:"",end:"",startOffset:Number(e.start),endOffset:Number(e.end),isText:!0});break}default:return e}return e},acceptAllSuggestions(){for(const t of e.suggestions.keys())e.acceptSuggestion(t);e.deleteAllDynamicregions((0,Ne.VS)(Ne.$b))},rejectAllSuggestions(){for(const t of e.suggestions.keys())e.suggestions.delete(t);e.deleteAllDynamicregions((0,Ne.VS)(Ne.$b))},deleteAllDynamicregions(t=!1){for(const n of e.regions)n.dynamic&&(t&&n.setDrawing(!0),n.deleteRegion())},acceptSuggestion(t){const n=e.suggestions.get(t);let i=t;const o=n.classification;if((0,Ne.VS)(Ne.jS))if(o){const t=n.results[0],o=e.areas.values();for(const e of o){const n=e.results[0];if(n.from_name===t.from_name&&n.to_name===t.to_name&&n.item_index===t.item_index){i=e.id;break}}}else{const t=e.areas.get(n.cleanId);t&&(i=t.id)}e.areas.set(i,Object.assign({},n.toJSON(),{id:i,fromSuggestion:!0}));const s=e.areas.get(i),a=s.object.activeStates();for(const e of a)s.setValue(e);e.suggestions.delete(t)},rejectSuggestion(t){e.suggestions.delete(t)},resetReady(){e.objects.forEach(e=>null==e.setReady?void 0:e.setReady(!1)),e.areas.forEach(e=>null==e.setReady?void 0:e.setReady(!1))}})),lf=u.gK.compose("Annotation",N,rf),cf=["id","reg","box","frame","workingArea","selected","draggable","listening","onDragMove"],df=(0,b.PA)(e=>{var t;let{id:n,reg:i,box:o,frame:s,workingArea:a,selected:r,draggable:l,listening:c,onDragMove:d}=e,u=(0,Se.A)(e,cf);const h=tr(i,{includeFill:!0}),{realWidth:g,realHeight:m,scale:p}=a,v=(0,f.useMemo)(()=>({x:o.x*g/100,y:o.y*m/100,width:o.width*g/100,height:o.height*m/100,rotation:o.rotation}),[o,g,m]),y=e=>{const t=e.target;"dragmove"===e.type&&d(e),i.updateShape(((e,t)=>{const{realWidth:n,realHeight:i}=t;return{x:e.x()/n*100,y:e.y()/i*100,width:e.width()/n*100,height:e.height()/i*100,rotation:e.rotation()}})(t,a),s)};return(0,ae.jsxs)(us.YJ,{children:[(0,ae.jsx)(Ba,{reg:i,box:v,scale:p,color:h.strokeColor,strokeWidth:h.strokeWidth,adjacent:!0}),(0,ae.jsx)(us.rw,Object.assign({id:n},v,{fill:null!=(t=h.fillColor)?t:"#fff",stroke:h.strokeColor,strokeScaleEnabled:!1,selected:r,draggable:l,listening:c,opacity:i.hidden?0:1,onTransform:e=>{((e,t)=>{const n=e.scaleX(),i=e.scaleY();"rect"===t&&(e.width(Math.max(Ss.X,e.width()*n)),e.height(Math.max(Ss.Y,e.height()*i)));e.scaleX(1),e.scaleY(1)})(e.target,"rect")},onTransformEnd:y,onDragMove:y,onDragEnd:y},u))]})}),uf=(e,t,n,i,o)=>{const s=Math.sqrt(n*n+i*i);o+=Math.atan2(i,n);return{x:e+s*Math.cos(o),y:t+s*Math.sin(o)}},hf=(e,t=!0)=>(n,i)=>{if(!t)return i;const o=(e=>{const{x:t,y:n,width:i,height:o}=e,s=e.rotation,a=uf(t,n,0,0,s),r=uf(t,n,i,0,s),l=uf(t,n,i,o,s),c=uf(t,n,0,o,s),d=Math.min(a.x,r.x,l.x,c.x),u=Math.min(a.y,r.y,l.y,c.y);return{x:d,y:u,width:Math.max(a.x,r.x,l.x,c.x)-d,height:Math.max(a.y,r.y,l.y,c.y)-u}})(i),s=Object.assign({},i);return[o.x<=e.x,o.y<=e.y,o.x+o.width>=e.x+e.width,o.y+o.height>=e.y+e.height].some(Boolean)?n:s},gf=(e,t=!0)=>function(n){if(!t)return;const i=null!=this&&this.nodes?this.nodes():[n.target],o=(e=>{let t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;return e.forEach(e=>{t=Math.min(t,e.x),n=Math.min(n,e.y),i=Math.max(i,e.x+e.width),o=Math.max(o,e.y+e.height)}),{x:t,y:n,width:i-t,height:o-n}})(i.map(e=>e.getClientRect()));i.forEach(t=>{const n=t.getAbsolutePosition(),i=o.x-e.x-n.x,s=o.y-e.y-n.y,a=Object.assign({},n);o.x-e.x<0&&(a.x=-i),o.y-e.y<0&&(a.y=-s),o.x-e.x+o.width>e.width&&(a.x=e.width-o.width-i),o.y-e.y+o.height>e.height&&(a.y=e.height-o.height-s),t.setAbsolutePosition(a)})},mf=["id","reg","item","stageRef","currentFrame"],pf=e=>(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(us.rw,Object.assign({},e,{strokeWidth:2,stroke:"#fff"})),(0,ae.jsx)(us.rw,Object.assign({},e,{fill:(0,ft.A)("#617ADA").alpha(.1).css(),strokeWidth:2,stroke:"#617ADA",dash:[2,2]}))]}),ff=(0,b.PA)(({regions:e,item:t,locked:n,isDrawing:i,workinAreaCoordinates:o,stageRef:s,onDragMove:a,currentFrame:r})=>{const l=null!=r?r:t.frame;return(0,ae.jsx)(ae.Fragment,{children:e.map(e=>(0,ae.jsx)(vf,{id:e.id,reg:e,item:t,workingArea:o,draggable:!e.isReadOnly()&&!i&&!n,selected:e.selected||e.inSelection,listening:!e.locked&&!e.hidden,stageRef:s,onDragMove:a,currentFrame:l},e.id))})}),vf=(0,b.PA)(e=>{let{id:t,reg:n,item:i,stageRef:o,currentFrame:s}=e,a=(0,Se.A)(e,mf);const r=null!=s?s:i.frame,l=n.getShape(r);return n.isInLifespan(r)&&l&&(0,ae.jsx)(df,Object.assign({id:t,reg:n,box:l,frame:r,onClick:e=>{const t=(0,u.k2)(n,lf);t&&t.isLinkingMode&&(o.current.container().style.cursor=w.A.DEFAULT_CURSOR),n.setHighlight(!1),n.onClickRegion(e)}},a))}),yf=(0,b.PA)(({item:e,regions:t,width:n,height:i,zoom:o,workingArea:s,locked:a=!1,allowRegionsOutsideWorkingArea:r=!0,pan:l={x:0,y:0},stageRef:c,currentFrame:d})=>{var u,h;const[g,m]=(0,f.useState)(),[p,v]=(0,f.useState)(!1),y=t.filter(t=>(t.selected||t.inSelection)&&!t.hidden&&!t.isReadOnly()&&t.isInLifespan(e.frame)),b=!a;t.map(e=>(0,E.fixMobxObserve)(e.sequence));const x=(0,f.useMemo)(()=>{const e=s.width*o,t=s.height*o,a=Math.abs(l.x)>=Math.abs((n-e)/2),r=Math.abs(l.y)>=Math.abs((i-t)/2),c=l.x>0?1:-1,d=l.y>0?1:-1,u=(Math.abs(l.x)-Math.abs((n-e)/2))*c,h=(Math.abs(l.y)-Math.abs((i-t)/2))*d,g=a?u:0,m=r?h:0;return{width:e,height:t,x:(n-e)/2+l.x-g,y:(i-t)/2+l.y-m,scale:o,realWidth:s.width,realHeight:s.height}},[l.x,l.y,o,s,n,i]),w=(0,f.useMemo)(()=>({width:x.width,height:x.height,scaleX:o,scaleY:o,position:{x:x.x,y:x.y}}),[x,o]),S=(0,f.useCallback)((e,t)=>{const{x:n,y:i}=x;return{x:(e-n)/o,y:(t-i)/o}},[x,o]);(0,f.useEffect)(()=>{if(!p&&g){const{width:t,height:n}=s;let i=g.x/t*100,o=g.y/n*100,a=g.width/t*100,r=g.height/n*100;a<0&&(a*=-1,i-=a),r<0&&(r*=-1,o-=r);const l={x:i,y:o,width:a,height:r};e.addVideoRegion(l),m(null)}},[p,x,s]);const C=({x:e,y:t})=>r?{x:e,y:t}:{x:xm()(e,0,x.realWidth),y:xm()(t,0,x.realHeight)},k=b?{onMouseDown:t=>{var n;if(t.target!==c.current||null!=(n=e.annotation)&&n.isReadOnly())return;const{x:i,y:o}=C(S(t.evt.offsetX,t.evt.offsetY)),s=((e,t)=>!!r||e>0&&t>0&&e<x.realWidth&&t<x.realHeight)(i,o);s&&(e.annotation.unselectAreas(),m({x:i,y:o,width:0,height:0}),v(!0))},onMouseMove:t=>{var n;if(!p||null!=(n=e.annotation)&&n.isReadOnly())return!1;const{x:i,y:o}=C(S(t.evt.offsetX,t.evt.offsetY));m(e=>Object.assign({},e,{width:i-e.x,height:o-e.y}))},onMouseUp:t=>{var n;if(!p||null!=(n=e.annotation)&&n.isReadOnly())return!1;const{x:i,y:o}=C(S(t.evt.offsetX,t.evt.offsetY));Math.abs(g.x-i)<5&&Math.abs(g.y-o)<5?m(null):m(e=>Object.assign({},e,{width:i-e.x,height:o-e.y})),v(!1)}}:{};return(0,ae.jsxs)(us.BI,Object.assign({ref:c,width:n,height:i,style:{position:"absolute",zIndex:1},listening:b},k,{children:[(0,ae.jsx)(us.Wd,Object.assign({},w,{children:(0,ae.jsx)(ff,{regions:t,item:e,layerProps:w,locked:a,isDrawing:p,workinAreaCoordinates:x,onDragMove:gf(x,!r),stageRef:c,currentFrame:d})})),null!=(u=e.annotation)&&u.isReadOnly()||!p?null:(0,ae.jsx)(us.Wd,Object.assign({},w,{children:(0,ae.jsx)(pf,Object.assign({},g))})),(null==(h=e.annotation)||!h.isReadOnly())&&(null==y?void 0:y.length)>0?(0,ae.jsx)(us.Wd,{children:(0,ae.jsx)(us.Ge,{ref:e=>{if(!e)return;const t=e.getStage(),n=y.map(e=>t.findOne(`#${e.id}`)).filter(Boolean);e.nodes(n),e.getLayer().batchDraw()},keepRatio:!1,ignoreStroke:!0,flipEnabled:!1,boundBoxFunc:hf(x,!r),onDragMove:gf(x,!r)})}):null]}))}),bf=He.ff.isActive(He.ff.FF_SYNCED_BUFFERING);const xf=(0,b.PA)(({item:e})=>{const[t,n]=(0,f.useState)(!1);return(0,ae.jsx)(vm,{configModal:t,onSetModal:n,speed:e.speed,onSpeedChange:e.handleSpeed,loopTimelineRegion:e.loopTimelineRegion,onLoopTimelineRegionChange:e.setLoopTimelineRegion,minSpeed:e.minplaybackspeed})}),wf=(0,b.WQ)("store")((0,b.PA)(({item:e,store:t})=>{var n,i,o;if(!e._value)return null;const s=!t.settings.videoDrawOutside,a=(0,f.useRef)(),r=(0,f.useRef)(),l=(0,f.useRef)(),c=(0,f.useRef)(),[d,u]=(0,f.useState)(!1),[h,g]=(0,f.useState)(0),[m,p]=(0,f.useState)(!1),[v,y]=(0,f.useState)(1),b=(0,f.useRef)({isScrubbing:!1,wasPlaying:!1,timeoutId:null,lastChangeTime:0}),x=(0,f.useRef)(null),[S,C]=(0,f.useState)(null),[k,P]=(0,f.useState)({width:0,height:0,ratio:1}),[{zoom:R,pan:j},{setZoomAndPan:N,setZoom:T,setPan:A}]=function(e,t,n){const[i,o]=(0,f.useState)({zoom:1,pan:{x:0,y:0}}),s=(0,f.useRef)({});s.current.video=e,s.current.canvas=t,s.current.shouldClampPan=n;const a=(0,f.useCallback)((e,t)=>{if(!n)return e;const i=(0,E.clamp)((s.current.video.width*t-s.current.canvas.width)/2,0,Number.POSITIVE_INFINITY),o=(0,E.clamp)((s.current.video.height*t-s.current.canvas.height)/2,0,Number.POSITIVE_INFINITY);return{x:(0,E.clamp)(e.x,-i,i),y:(0,E.clamp)(e.y,-o,o)}},[]);return[i,{setZoomAndPan:(0,f.useCallback)(e=>o(t=>{const n=e instanceof Function?e(t):e,{zoom:i,pan:o}=t,s=$m(n.zoom);if(s===i)return t;if(s===n.zoom)return{zoom:n.zoom,pan:a(n.pan,n.zoom)};const r=(s-i)/(n.zoom-i),l={x:o.x+(n.pan.x-o.x)*r,y:o.y+(n.pan.y-o.y)*r};return{pan:a(l,s),zoom:s}}),[]),setZoom:(0,f.useCallback)(e=>o(({zoom:t,pan:n})=>{const i=$m(e instanceof Function?e(t):e);return{zoom:i,pan:{x:n.x/t*i,y:n.y/t*i}}}),[]),setPan:(0,f.useCallback)(e=>o(t=>(e=e instanceof Function?e(t.pan):e,Object.assign({},t,{pan:e}))),[])}]}(k,e.ref.current?{width:e.ref.current.width,height:e.ref.current.height}:{width:0,height:0},s),[I,M]=(0,f.useState)(!1),[K,D,O,L]=Fu(!1),z=Zm({onEnterFullscreen(){D()},onExitFullscreen(){O()}}),B=(0,f.useCallback)(e=>{if(e!==v&&h){const t=(0,E.clamp)(e,1,h);y(t)}},[v,h]),F=(0,f.useCallback)(e=>{e!==h&&g(e)},[h]),H=(0,f.useMemo)(()=>(0,E.isDefined)(null==e?void 0:e.videoControl),[e]),V=(0,f.useMemo)(()=>(0,E.isDefined)(null==e?void 0:e.timelineControl),[e]);(0,f.useEffect)(()=>{const e=l.current,t=e=>{e.shiftKey&&e.preventDefault()};return e.addEventListener("wheel",t),()=>e.removeEventListener("wheel",t)},[]),(0,f.useEffect)(()=>{const e=e=>{if(e.code.startsWith("Shift")&&(e.preventDefault(),!I)){M(!0);const e=t=>{t.code.startsWith("Shift")&&(M(!1),document.removeEventListener("keyup",e))};document.addEventListener("keyup",e)}};let t;document.addEventListener("keydown",e);const n=new _(()=>{t&&cancelAnimationFrame(t),t=requestAnimationFrame(()=>(()=>{const e=l.current;e&&C([e.clientWidth,e.clientHeight])})())}),[i,o]=[l.current,a.current];return n.observe(i),n.observe(o),()=>{document.removeEventListener("keydown",e),t&&cancelAnimationFrame(t),n.unobserve(i),n.unobserve(o),n.disconnect()}},[]),(0,f.useEffect)(()=>{const e=z.getElement();K&&!e?z.enter(c.current):!K&&e&&z.exit()},[K]);const $=(0,f.useCallback)(t=>{if(!t.shiftKey||!r.current)return;const n=0===Math.abs(t.deltaY)?t.deltaX:t.deltaY,i=n>0?1:-1,o=Math.abs(25e-5*n),s=i*(0,E.clamp)(o,.05,.5);requestAnimationFrame(()=>{N(({zoom:t,pan:n})=>{const i=t+s,o=i/t,a=r.current.pointerPos.x-e.ref.current.width/2,l=r.current.pointerPos.y-e.ref.current.height/2;return{zoom:i,pan:{x:n.x*o+a*(1-o),y:n.y*o+l*(1-o)}}})})},[]),W=(0,f.useCallback)(t=>{if(!I)return;const n=t.pageX,i=t.pageY,o=t=>{const o=e.ref.current.adjustPan(j.x+(t.pageX-n),j.y+(t.pageY-i));requestAnimationFrame(()=>{A(o)})},s=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",s)},[I,j]),U=(0,f.useCallback)(()=>{T(e=>e+.1)},[]),G=(0,f.useCallback)(()=>{T(e=>e-.1)},[]),Y=(0,f.useCallback)(()=>{N({zoom:e.ref.current.videoDimensions.ratio,pan:{x:0,y:0}})},[]),X=(0,f.useCallback)(()=>{N({zoom:1,pan:{x:0,y:0}})},[]),q=(0,f.useCallback)((t,n)=>{B(t),F(n),e.setOnlyFrame(t)},[e,B,F]),Z=(0,f.useCallback)(({length:t,videoDimensions:n})=>{u(!0),T(n.ratio),P(n),F(t),e.setOnlyFrame(1),e.setLength(t),e.setReady(!0)},[e,F]),J=(0,f.useCallback)(e=>{P(e)},[]),Q=(0,f.useCallback)(()=>{p(!1),B(h)},[h,B,p]),ee=(0,f.useCallback)(()=>{p(t=>(e.ref.current.playing||(e.ref.current.play(),e.triggerSyncPlay()),!0))},[e]),te=(0,f.useCallback)(()=>{p(t=>(e.ref.current.playing&&(e.ref.current.pause(),e.triggerSyncPause()),!1))},[]),ne=(0,f.useCallback)(()=>{bf&&e.isBuffering?e.triggerSyncPlay(!0):ee()},[]),ie=(0,f.useCallback)(()=>{bf&&e.isBuffering?e.triggerSyncPause(!0):te()}),oe=(0,f.useCallback)((t,n,i)=>{const o=e.findRegion(n),s=(null==o?void 0:o.selected)||(null==o?void 0:o.inSelection);!o||(0,E.isDefined)(i)&&s===i||o.onClickRegion()},[e]),se=(0,f.useCallback)((t,n,i)=>{e.regs.filter(e=>e.selected||e.inSelection).forEach(e=>{switch(n){case"lifespan_add":case"lifespan_remove":e.toggleLifespan(i.frame);break;case"keypoint_add":e.addKeypoint(i.frame);break;case"keypoint_remove":e.removeKeypoint(i.frame);break;default:console.warn("unknown action")}})},[e.regs]),re=(0,f.useCallback)(t=>{if(v!==t){const i=Date.now(),o=b.current,s=i-o.lastChangeTime<100;var n;if(o.lastChangeTime=i,m&&!o.isScrubbing)o.isScrubbing=!0,o.wasPlaying=!0,null==(n=e.ref.current)||n.pause(),e.triggerSyncPause(),o.timeoutId&&clearTimeout(o.timeoutId),o.timeoutId=setTimeout(()=>{if(o.isScrubbing=!1,o.wasPlaying&&e.ref.current&&!e.ref.current.playing){var t;const n=null==(t=e.ref.current.videoRef)?void 0:t.current,i=()=>{e.ref.current&&!e.ref.current.playing&&(e.ref.current.play(),e.triggerSyncPlay())};null!=n&&n.seeking?n.addEventListener("seeked",i,{once:!0}):i()}o.wasPlaying=!1},200);B(t),x.current&&cancelAnimationFrame(x.current),s?x.current=requestAnimationFrame(()=>{x.current=null,e.setFrame(t)}):e.setFrame(t)}},[e,v,m]);(0,f.useEffect)(()=>()=>{const t=b.current;t.timeoutId&&clearTimeout(t.timeoutId),x.current&&cancelAnimationFrame(x.current),e.ref.current=null},[]);const le=e.regs.map(e=>{var t,n,i,o;const s=null!=(t=null!=(n=null==(i=e.style)?void 0:i.fillcolor)?n:null==(o=e.tag)?void 0:o.fillcolor)?t:w.l.fillcolor,a=e.labels.join(", ")||"Empty",r=e.type.includes("timeline"),l=e.sequence;return{id:e.cleanId,index:e.region_index,label:a,color:s,visible:!e.hidden,selected:e.selected||e.inSelection,sequence:l,timeline:r,locked:e.locked}});if(e.timelineControl&&le.reverse(),null!=(n=e.timelineControl)&&null!=(n=n.selectedLabels)&&n.length&&!e.annotation.selectionSize&&!e.drawingRegion){const t=e.timelineControl.selectedLabels[0];le.unshift({id:"new",label:t.value,color:t.background,visible:!0,selected:!0,sequence:[],timeline:!0})}return(0,ae.jsx)(Es,{item:e,children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("video-segmentation").mod({fullscreen:K}).toClassName(),ref:c,children:[null==(i=e.errors)?void 0:i.map((e,t)=>(0,ae.jsx)(ve,{error:e},`err-${t}`)),(0,ae.jsx)("div",{className:(0,Nn.cn)("video").mod({fullscreen:K}).toClassName(),ref:a,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("video").elem("main").toClassName(),ref:l,style:{height:Number(e.height)},onMouseDown:W,onWheel:$,children:S&&(0,ae.jsxs)(ae.Fragment,{children:[d&&H&&(0,ae.jsx)(yf,{item:e,zoom:R,pan:j,locked:I,regions:e.regs,width:S[0],height:S[1],workingArea:k,allowRegionsOutsideWorkingArea:!s,stageRef:r,currentFrame:v}),(0,ae.jsx)(Gm,{ref:e.ref,src:e._value,width:S[0],height:S[1],muted:e.muted,zoom:R,pan:j,speed:e.speed,framerate:e.framerate,buffering:e.isBuffering,allowInteractions:!1,allowPanOffscreen:!s,onFrameChange:q,onLoad:Z,onResize:J,onEnded:Q,onPlay:ee,onPause:te,onSeeked:e.handleSeek,onBuffering:e.handleBuffering,loopFrameRange:e.loopTimelineRegion,selectedFrameRange:e.selectedFrameRange})]})})}),d&&(0,ae.jsx)(zm,{className:(0,Nn.cn)("video-segmentation").elem("timeline").toClassName(),playing:bf&&e.isBuffering?e.wasPlayingBeforeBuffering:m,buffering:!!bf&&e.isBuffering,length:h,position:v,regions:le,height:e.timelineheight,altHopSize:t.settings.videoHopSize,allowFullscreen:!1,fullscreen:K,defaultStepSize:16,disableView:!V&&!H,framerate:e.framerate,controls:{FramesControl:!0},readonly:null==(o=e.annotation)?void 0:o.isReadOnly(),customControls:[{position:"left",component:()=>(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(xf,{item:e}),(0,ae.jsx)(Pn.msM.Trigger,{inline:K,content:(0,ae.jsxs)(um,{size:"auto",closeDropdownOnItemClick:!1,children:[(0,ae.jsx)(um.Item,{onClick:U,children:"Zoom In"}),(0,ae.jsx)(um.Item,{onClick:G,children:"Zoom Out"}),(0,ae.jsx)(um.Item,{onClick:Y,children:"Zoom To Fit"}),(0,ae.jsx)(um.Item,{onClick:X,children:"Zoom 100%"})]}),children:(0,ae.jsx)(Pn.$nd,{size:"small",variant:"neutral",look:"string",children:(0,ae.jsx)(kn.mc3,{})})},"dd")]})}],onPositionChange:re,onPlay:ne,onPause:ie,onFullscreenToggle:L,onSelectRegion:oe,onStartDrawing:e.startDrawing,onFinishDrawing:e.finishDrawing,onAction:se})]})})}));we.addTag("video",ap,wf),we.addObjectType(ap);var Sf=n(76694);const Cf={board:"board--RCWAA",column:"column--gZT9f",columnTitle:"columnTitle--D1Oix",item:"item--SAih8",itemLine:"itemLine--J7fhn",itemTitle:"itemTitle--cZnga",itemIcon:"itemIcon--CZVk2",collapsed:"collapsed--wo2M4",dropArea:"dropArea--OHu8G"},kf=e=>{var t;const{item:n,index:i,readonly:o}=e,s=(0,f.useMemo)(()=>n.html?(0,fe.sanitizeHtml)(n.html):"",[n.html]),[a,r,l]=(0,f.useContext)(Tf),c=null!=(t=r[n.id])&&t,d=a?()=>l(n.id,!c):void 0,u=[Cf.item,"htx-ranker-item"];return a&&u.push(c?Cf.collapsed:Cf.expanded),(0,ae.jsx)(Sf.sx,{draggableId:n.id,index:i,isDragDisabled:o,children:e=>(0,ae.jsxs)("div",Object.assign({},e.draggableProps,e.dragHandleProps,{style:Object.assign({},e.draggableProps.style),className:u.join(" "),ref:e.innerRef,"data-ranker-id":n.id,children:[n.title&&(0,ae.jsxs)("div",{className:Cf.itemTitle,onClick:d,children:[(0,ae.jsx)(Pn.o5u,{variant:"title",size:"small",children:n.title}),a&&(0,ae.jsx)(Pn.$nd,{type:"button",variant:"neutral",leading:c?(0,ae.jsx)(kn.rIS,{}):(0,ae.jsx)(kn.Vh6,{}),look:"string",size:"small",className:"ml-auto"})]}),n.body&&(0,ae.jsx)("p",{className:Cf.itemLine,children:n.body}),n.html&&(0,ae.jsx)("p",{className:Cf.itemLine,dangerouslySetInnerHTML:{__html:s}}),(0,ae.jsx)("p",{className:Cf.itemLine,children:n.id})]}))})},Pf=["children"],Rf=e=>{let{children:t}=e,n=(0,Se.A)(e,Pf);const[i,o]=(0,f.useState)(!1);return(0,f.useEffect)(()=>{const e=requestAnimationFrame(()=>o(!0));return()=>{cancelAnimationFrame(e)}},[]),i?(0,ae.jsx)(Sf.gL,Object.assign({},n,{children:t})):null},jf=({items:e,title:t})=>{const[,n,i]=(0,f.useContext)(Tf),o=e.every(e=>n[e.id]);return(0,ae.jsxs)("div",{className:Cf.columnTitle,children:[(0,ae.jsx)(Pn.o5u,{variant:"title",size:"large",children:t}),(0,ae.jsx)(Pn.$nd,{type:"button",onClick:()=>i(e.map(e=>e.id),!o),"aria-label":o?"Expand column":"Collapse column",variant:"neutral",leading:o?(0,ae.jsx)(kn.rIS,{}):(0,ae.jsx)(kn.Vh6,{}),look:"string",size:"small"})]})},Nf=e=>{const{column:t,items:n,readonly:i}=e,[o]=(0,f.useContext)(Tf),s=o?(0,ae.jsx)(jf,{items:n,title:t.title}):(0,ae.jsx)("div",{className:Cf.columnTitle,children:(0,ae.jsx)(Pn.o5u,{variant:"title",size:"medium",children:t.title})});return(0,ae.jsxs)("div",{className:[Cf.column,"htx-ranker-column"].join(" "),children:[s,(0,ae.jsx)(Rf,{droppableId:t.id,children:e=>(0,ae.jsxs)("div",Object.assign({ref:e.innerRef},e.droppableProps,{className:Cf.dropArea,children:[n.map((e,t)=>(0,ae.jsx)(kf,{item:e,index:t,readonly:i},e.id)),e.placeholder]}))})]})},Tf=(0,f.createContext)([!0,{},(e,t)=>{}]),_f=({inputData:e,handleChange:t,readonly:n,collapsible:i=!0})=>{const[o,s]=(0,f.useState)(e),[a,r]=(0,f.useState)({}),l=(0,f.useCallback)((e,t)=>{const n=(Array.isArray(e)?e:[e]).reduce((e,n)=>Object.assign({},e,{[n]:t}),{});r(e=>Object.assign({},e,n))},[]);(0,f.useEffect)(()=>{s(e)},[e]);return(0,ae.jsx)(Tf.Provider,{value:[i,a,l],children:(0,ae.jsx)(Sf.JY,{onDragEnd:e=>{var n;const{destination:i,source:a,draggableId:r}=e;if(!i||i.droppableId===a.droppableId&&i.index===a.index)return;if(o.columns.find(e=>e.id===a.droppableId)===o.columns.find(e=>e.id===i.droppableId)){const e=[...o.itemIds[a.droppableId]];e.splice(a.index,1),e.splice(i.index,0,r);const n=Object.assign({},o.itemIds,{[a.droppableId]:e}),l=Object.assign({},o,{itemIds:n});return s(l),void(t&&t(n))}const l=[...o.itemIds[a.droppableId]];l.splice(a.index,1);const c=[...null!=(n=o.itemIds[i.droppableId])?n:[]];c.splice(i.index,0,r);const d=Object.assign({},o.itemIds,{[a.droppableId]:l,[i.droppableId]:c}),u=Object.assign({},o,{itemIds:d});t&&t(d),s(u)},children:(0,ae.jsx)("div",{className:Cf.board,children:(0,ae.jsx)(ae.Fragment,{children:o.columns.map(e=>{var t,i;const s=null!=(t=null==(i=o.itemIds[e.id])?void 0:i.map(e=>o.items[e]))?t:[];return(0,ae.jsx)(Nf,{column:e,items:s,readonly:n},e.id)})})})})})},Af=u.gK.model({type:"list",value:u.gK.maybeNull(u.gK.string),_value:u.gK.frozen([]),title:u.gK.optional(u.gK.string,"")}).views(e=>({get ranker(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.filter(e=>"ranker"===e.type)},get items(){return Object.fromEntries(e._value.map(e=>[e.id,e]))}})).views(e=>({get dataSource(){return{items:e.items,columns:[{id:e.name,title:e.title}],itemIds:{[e.name]:Object.keys(e.items)}}},get result(){var t;return null==(t=e.annotation)?void 0:t.results.find(t=>t.from_name===e)}})).actions(e=>({updateValue(t){const n=Oe(e.value,t.task.dataObj);Array.isArray(n)&&(e._value=n.map(e=>Object.assign({},e,{id:String(e.id)})))}})),If=u.gK.compose("ListModel",gn,Fe,Te,Af),Mf=(0,b.WQ)("store")((0,b.PA)(({item:e})=>{const t=e.dataSource;return t?e.ranker?null:(0,ae.jsx)(f.StrictMode,{children:(0,ae.jsx)(_f,{inputData:t,readonly:!0})}):null}));we.addTag("list",If,Mf),we.addObjectType(If);const Ef=e=>(e<10?"0":"")+e,Kf=u.gK.model({toname:u.gK.maybeNull(u.gK.string),format:u.gK.maybeNull(u.gK.string),only:u.gK.maybeNull(u.gK.string),min:u.gK.maybeNull(u.gK.string),max:u.gK.maybeNull(u.gK.string),step:u.gK.maybeNull(u.gK.string),defaultvalue:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string)}),Df=u.gK.model({pid:u.gK.optional(u.gK.string,I),type:"datetime"}).views(e=>({selectedValues:()=>e.datetime,get holdsState(){return!(e.onlyTime&&!(0,E.isDefined)(e.time))&&((0,E.isDefined)(e.month)||(0,E.isDefined)(e.year))},get showDate(){return!e.only||e.only.includes("date")},get showTime(){return!e.only||e.only.includes("time")},get onlyTime(){return"time"===e.only},get showMonth(){var t,n;return(null==(t=e.only)?void 0:t.includes("month"))&&!(null!=(n=e.only)&&n.includes("date"))},get showYear(){var t;return null==(t=e.only)?void 0:t.includes("year")},getISODate(t){if(e.onlyYear)return t;if(e.onlyTime)return;const n=e.parseDateTime(t);return[n.getFullYear(),Ef(n.getMonth()+1),Ef(n.getDate())].join("-")},get date(){var t;return null!=(t=e.only)&&t.includes("year")?e.year:e.month&&e.year?[e.year,Ef(e.month),Ef(e.day)].join("-"):void 0},get datetime(){const t=e.time||"00:00";if(e.onlyTime)return t;if(!e.date)return e.year?e.year:void 0;const n=new Date(e.date+"T"+t);return e.formatDateTime(n)},get isValid(){return!(e.min&&e.date<e.min)&&!(e.max&&e.date>e.max)}})).volatile(()=>({updateValue:!1,day:void 0,month:void 0,year:void 0,time:void 0})).volatile(e=>{let t;return t=e.onlyTime?String:e.format?e.format:e.showTime?"%Y-%m-%dT%H:%M":"%Y-%m-%d",{formatTime:wg.DCK("%H:%M"),formatDateTime:wg.DCK(t),parseDateTime:wg.T6w(t)}}).volatile(e=>{var t,n;const i=[],o=[],s=wg.DCK("%B"),a=new Date,r=t=>{var n;return"current"===t?a.getFullYear():4===t.length?Number.parseInt(t):null==(n=e.parseDateTime(t))?void 0:n.getFullYear()},l=r(null!=(t=e.min)?t:"2000");for(let t=r(null!=(n=e.max)?n:"current");t>=l;t--)i.push(t);a.setDate(1);for(let e=0;e<12;e++)a.setMonth(e),o[e]=s(a);return{months:o,years:i}}).actions(e=>({setNeedsUpdate(t){e.updateValue=t},needsUpdate(){e.setNeedsUpdate(!0),e.result?e.setDateTime(e.result.mainValue):e.resetDateTime()},unselectAll(){},resetDate(){e.day=void 0,e.month=void 0,e.year=void 0},resetDateTime(){e.resetDate(),e.time=void 0},validDateFormat(e){const t=e.split("-").map(e=>Number.parseInt(e,10)),n=t[0];return!(isNaN(new Date(e))||!(n<=9999&&n>=1e3))&&t},setDateTime(t){if(e.onlyTime)return void(e.time=t);const n=e.parseDateTime(t);if(!n)return e.resetDateTime();e.day=n.getDate(),e.month=n.getMonth()+1,e.year=n.getFullYear(),e.showTime&&(e.time=e.formatTime(n))},onMonthChange(t){e.month=+t||void 0,e.updateResult()},onYearChange(t){e.year=+t||void 0,e.updateResult()},setDate(t){t?(e.day=t[2],e.month=t[1],e.year=t[0]):(e.day=void 0,e.month=void 0,e.year=void 0),e.updateResult()},onTimeChange(t){e.time=t.target.value||void 0,e.updateResult()},updateFromResult(){this.needsUpdate()},requiredModal(){dn.warning(e.requiredmessage||`DateTime "${e.name}" is required.`)}})).actions(e=>{const t={validateValue:e.validateValue};return{validateValue(n){var i;if(!t.validateValue(n))return!1;const o=[];if(!n)return!0;let s=e.getISODate(n);null!=(i=e.only)&&i.includes("year")&&(s=s.slice(0,4));const{min:a,max:r}=e;return a&&s<a&&o.push(`min date is ${a}`),r&&s>r&&o.push(`max date is ${r}`),!o.length||(dn.warning(`Date "${s}" is not valid: ${o.join(", ")}.`),!1)}}}),Of=u.gK.compose("DateTimeModel",Bd,Cu,gu,Ye,ut,...(0,Ne.VS)(Ne.gF)?[du]:[],Te,Kf,Df),Lf=(0,b.WQ)("store")((0,b.PA)(({item:e})=>{var t;const n=e.isReadOnly(),i=e.perRegionVisible()?{margin:"0 0 1em"}:{display:"none"},o={style:{width:"auto",marginRight:"4px",borderColor:e.isValid?void 0:"red"}},[s,a]=[e.min,e.max].map(e=>{var t;return null==e||null==(t=e.match(/\d?\d:\d\d/))?void 0:t[0]}),[r,l]=(0,f.useState)("");e.updateValue&&(!e.showDate||void 0!==e.date&&e.date===r||l(e.date||""),e.setNeedsUpdate(!1));return(0,ae.jsxs)("div",{className:"htx-datetime",style:i,ref:e.elementRef,children:[e.showMonth&&(0,ae.jsx)(Pn.l6P,Object.assign({},o,{name:`${e.name}-date`,disabled:n,value:e.month,placeholder:"Month...",onChange:t=>n?void 0:e.onMonthChange(t),options:e.months.map((e,t)=>({value:t+1,label:e})),isInline:!0})),e.showYear&&(0,ae.jsx)(Pn.l6P,Object.assign({},o,{name:`${e.name}-year`,disabled:n,value:e.year||"",placeholder:"Year...",onChange:t=>n?void 0:e.onYearChange(t),options:e.years,isInline:!0})),e.showDate&&(0,ae.jsx)("input",Object.assign({},o,{type:"date",readOnly:n,name:`${e.name}-date`,value:r,min:e.min,max:e.max,onChange:n?void 0:t=>{const n=t.target.value,i=e.validDateFormat(n);l(n),n&&!i||e.setDate(i)},onBlur:n?void 0:()=>{r!==e.date&&l(e.date||"")}})),e.showTime&&(0,ae.jsx)("input",Object.assign({},o,{type:"time",readOnly:n,name:`${e.name}-time`,value:null!=(t=e.time)?t:"",min:s,max:a,onChange:n?void 0:e.onTimeChange}))]})}));we.addTag("datetime",Of,Lf);const zf=(e,t)=>{const n=Number(e);return(0,E.isDefined)(e)&&Number.isFinite(n)?n:t},Bf=u.gK.model({toname:u.gK.maybeNull(u.gK.string),min:u.gK.maybeNull(u.gK.string),max:u.gK.maybeNull(u.gK.string),step:u.gK.maybeNull(u.gK.string),defaultvalue:u.gK.maybeNull(u.gK.string),slider:u.gK.optional(u.gK.boolean,!1),hotkey:u.gK.maybeNull(u.gK.string)}),Ff=u.gK.model({pid:u.gK.optional(u.gK.string,I),type:"number",number:u.gK.maybeNull(u.gK.number)}).views(e=>({selectedValues:()=>e.number,get holdsState(){return(0,E.isDefined)(e.number)}})).actions(e=>{const t={validateValue:e.validateValue};return{validateValue(n){if(!t.validateValue(n))return!1;if(!(0,E.isDefined)(n))return!0;const i=[];if((0,E.isDefined)(e.min)&&n<e.min&&i.push(`Value must be greater than or equal to ${e.min}`),(0,E.isDefined)(e.max)&&n>e.max&&i.push(`Value must be less than or equal to ${e.max}`),(0,E.isDefined)(e.step)){const t=Number.parseFloat(e.step),s=(0,E.isDefined)(e.min)?+e.min:0,a=n-s,r=Math.round(a/t)*t+s,l=1e-8;if(Math.abs(n-r)>l){var o;const e=Math.floor(a/t)*t+s,n=e+t,r=(null==(o=t.toString().split(".")[1])?void 0:o.length)||0;i.push(`The two nearest valid values are ${e.toFixed(r)} and ${n.toFixed(r)}`)}}return!i.length||(dn.warning(`Number "${n}" is not valid: ${i.join(", ")}.`),!1)},getSelectedString:()=>`${e.number} star`,needsUpdate(){e.result?e.number=e.result.mainValue:e.number=null},beforeSend(){if((0,E.isDefined)(e.defaultvalue))if(e.perregion&&e.required){const n=e.toNameTag;for(const i of null!=(t=null==n?void 0:n.allRegs)?t:[]){var t;i.results.some(t=>t.from_name===e)||i.results.push({area:i,from_name:e,to_name:n,type:e.resultType,value:{[e.valueType]:+e.defaultvalue}})}}else(0,E.isDefined)(e.number)||e.setNumber(+e.defaultvalue)},unselectAll(){},setNumber(t){e.number=t,e.updateResult()},onChange(t){const n=+t.target.value;isNaN(n)||(e.setNumber(n),t.target.value=(0,E.isDefined)(e.number)?e.number:"")},updateFromResult(){this.needsUpdate()},requiredModal(){dn.warning(e.requiredmessage||`Number "${e.name}" is required.`)},increaseValue(){const t=zf(e.min,0),n=zf(e.max,Number.POSITIVE_INFINITY),i=((e,t=1)=>{const n=Number(e);return Number.isFinite(n)&&n>0?n:t})(e.step),o=zf(e.defaultvalue,t),s=zf(e.number,o),a=s+i>n?t:s+i;e.setNumber(a)},onHotKey:()=>e.increaseValue()}}),Hf=u.gK.compose("NumberModel",Bd,Cu,gu,Ye,ut,...(0,Ne.VS)(Ne.gF)?[du]:[],Te,Bf,Ff),Vf=(0,b.WQ)("store")((0,b.PA)(({item:e,store:t})=>{var n,i,o,s,a;const r=e.perRegionVisible()?{display:"flex",alignItems:"center"}:{display:"none"},l=e.slider?{padding:"9px 0px",border:0}:{},c=e.isReadOnly(),d=(0,Nn.cn)("number").toClassName();return(0,ae.jsxs)("div",{className:d,style:r,ref:e.elementRef,children:[(0,ae.jsx)("input",{disabled:c,style:l,type:e.slider?"range":"number",name:e.name,value:null!=(n=null!=(i=e.number)?i:e.defaultvalue)?n:"",step:null!=(o=e.step)?o:1,min:(0,E.isDefined)(e.min)?Number(e.min):void 0,max:(0,E.isDefined)(e.max)?Number(e.max):void 0,onChange:c?void 0:e.onChange}),e.slider&&(0,ae.jsx)("output",{style:{marginLeft:"5px"},children:null!=(s=null!=(a=e.number)?a:e.defaultvalue)?s:""}),t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,ae.jsxs)("sup",{style:{fontSize:"9px"},children:["[",e.hotkey,"]"]})]})}));we.addTag("number",Hf,Vf);const $f=u.gK.model({toname:u.gK.maybeNull(u.gK.string),selectionstyle:u.gK.maybeNull(u.gK.string),leftclass:u.gK.maybeNull(u.gK.string),rightclass:u.gK.maybeNull(u.gK.string)}),Wf=u.gK.model({type:"pairwise",selected:u.gK.maybeNull(u.gK.enumeration(["left","right","none"]))}).views(e=>({get names(){return e.toname.split(",")},get left(){if(e.annotation&&e.annotation.names)return e.annotation.names.get(e.names[0])},get right(){if(e.annotation&&e.annotation.names)return e.annotation.names.get(e.names[1])},get valueType(){return"selected"}})).actions(e=>({updateResult(){const{result:t,selected:n}=e;"none"===n?t&&t.area.removeResult(t):t?t.setValue(n):e.annotation.createResult({},{selected:n},e,e.name)},setResult(t="none"){if(e.selected=t,!e.left||!e.right)return void console.warn("Pairwise: left or right object reference is missing. Check toName and config.",{left:e.left,right:e.right});const n="cursor-pointer hover:bg-primary-emphasis-subtle transition-colors rounded-sm";"className"===e._selectionType?(e.left.addProp("className","left"===t?`${n} ${e._selection}`:`${n} border border-transparent`),e.right.addProp("className","right"===t?`${n} ${e._selection}`:`${n} border border-transparent`),e.left.addProp("style",{}),e.right.addProp("style",{})):(e.left.addProp("style","left"===t?e._selection:{border:"1px solid transparent",borderRadius:"0.125rem"}),e.right.addProp("style","right"===t?e._selection:{border:"1px solid transparent",borderRadius:"0.125rem"}),e.left.addProp("className",n),e.right.addProp("className",n))},selectLeft(){e.setResult("left"===e.selected?"none":"left"),e.updateResult()},selectRight(){e.setResult("right"===e.selected?"none":"right"),e.updateResult()},afterCreate(){let t;if(2===e.names.length&&e.names[0]!==e.names[1]||dn.error("Incorrect toName parameter on Pairwise, must be two names separated by a comma: name1,name2"),e.selectionstyle){const n=st.cssConverter(e.selectionstyle);t={};for(const e in n)t[e]=n[e];e._selectionType="style"}else t="bg-primary-background border border-primary-border-subtle rounded-sm",e._selectionType="className";e._selection=t},needsUpdate(){e.result?e.setResult(e.result.value.selected):e.setResult()},annotationAttached(){setTimeout(()=>{var t;e.left&&e.right&&(e.left.addProp("onClick",e.selectLeft),e.right.addProp("onClick",e.selectRight),e.setResult(null==(t=e.result)?void 0:t.value.selected))})}})),Uf=u.gK.compose("PairwiseModel",Bd,$f,Wf,Te);we.addTag("pairwise",Uf,()=>null),we.addObjectType(Uf);const Gf="_",Yf=u.gK.model({type:"ranker",toname:u.gK.maybeNull(u.gK.string),collapsible:u.gK.optional(u.gK.boolean,!0),children:je.unionArray(["bucket"])}).views(e=>({get list(){const t=e.annotation.names.get(e.toname);return"list"===t.type?t:null},get buckets(){return st.filterChildrenOfType(e,"BucketModel")},get defaultBucket(){var t;return e.buckets.length>0?null==(t=e.buckets.find(e=>e.default))?void 0:t.name:e.name},get rankOnly(){return!e.buckets.length},get columns(){if(!e.list)return[];if(e.rankOnly)return[{id:e.name,title:e.list.title}];const t=e.buckets.map(e=>{var t;return{id:e.name,title:null!=(t=e.title)?t:""}});return e.defaultBucket||t.unshift({id:Gf,title:e.list.title}),t}})).views(e=>({get dataSource(){var t,n,i;const o=null==(t=e.list)?void 0:t._value,s=null==(n=e.list)?void 0:n.items,a=Object.keys(s),r=e.columns,l=Object.fromEntries(e.columns.map(e=>[e.id,[]])),c=null==(i=e.result)?void 0:i.value.ranker;let d={};if(!o)return[];var u;if(c){if(d=Object.assign({},l,c),!e.defaultBucket){const t=e.columns.map(e=>e.id),n=Object.entries(c).filter(([e])=>t.includes(e)).flatMap(([e,t])=>t),i=a.filter(e=>!n.includes(e));var h;if(i.length)d[Gf]=[...null!=(h=d[Gf])?h:[],...i]}}else d=Object.assign({},l,{[null!=(u=e.defaultBucket)?u:Gf]:a});return{items:s,columns:r,itemIds:d}},get result(){var t;return null==(t=e.annotation)?void 0:t.results.find(t=>t.from_name===e)}})).actions(e=>({createResult(t){e.annotation.createResult({},{ranker:t},e,e.list)},updateResult(t){e.result?e.result.setValue(t):e.createResult(t)},beforeSend(){var t,n;if(!e.list)return;if(e.result)return;const i=Object.keys(null==(t=e.list)?void 0:t.items),o=Object.fromEntries(e.columns.map(e=>[e.id,[]]));o[null!=(n=e.defaultBucket)?n:Gf]=i,e.createResult(o)}})),Xf=u.gK.compose("RankerModel",Bd,Te,Yf,Ye),qf=(0,b.WQ)("store")((0,b.PA)(({item:e})=>{const t=e.dataSource;return t?(0,ae.jsx)(_f,{inputData:t,handleChange:e.updateResult,readonly:e.isReadOnly(),collapsible:e.collapsible}):null})),Zf=u.gK.model("BucketModel",{id:u.gK.optional(u.gK.identifier,I),type:"bucket",name:u.gK.string,title:u.gK.maybeNull(u.gK.string),default:u.gK.optional(u.gK.boolean,!1)}),Jf=(0,b.WQ)("store")((0,b.PA)(({item:e})=>(0,ae.jsx)("h1",{children:e.name})));we.addTag("ranker",Xf,qf),we.addTag("bucket",Zf,Jf),we.addObjectType(Xf);var Qf=n(97141);const ev=u.gK.model({value:u.gK.maybeNull(u.gK.string),alias:u.gK.maybeNull(u.gK.string),background:u.gK.optional(Ce.color,"#333333"),hotkey:u.gK.maybeNull(u.gK.string)}),tv=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"shortcut",_value:u.gK.optional(u.gK.string,"")}).volatile(()=>({hotkeyScope:Fn.INPUT_SCOPE})).actions(e=>({onClick(){const t=(0,u.PA)(e,2);t.onShortcut&&(t.onShortcut(e.value),null==t.returnFocus||t.returnFocus())},onHotKey(t){const n=(0,u.PA)(e,2),i=(t.target||t.srcElement).name;if(n.name===i||i.startsWith(`${n.name}:`))return t.preventDefault(),e.onClick()}})),nv=u.gK.compose("ShortcutModel",ev,tv,Fe),iv=(0,b.WQ)("store")((0,b.PA)(({item:e,store:t})=>{const n={background:(0,ft.A)(e.background).alpha(.15),color:"#333333",cursor:"pointer",margin:"5px"};return(0,ae.jsxs)(Qf.A,{"data-shortcut":!0,onClick:t=>(t.preventDefault(),t.stopPropagation(),e.onClick(),!1),style:n,children:[e.alias?e.alias:e._value,t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,ae.jsxs)(Tn,{children:["[",e.hotkey,"]"]})]})}));we.addTag("shortcut",nv,iv);var ov=n(44318);var sv=n(12784),av=n.n(sv);const rv=f.forwardRef(({treeData:e,onChange:t},n)=>{(0,f.useImperativeHandle)(n,()=>({resetValue(){s(""),t(e,[])},focus(){var e;return null==(e=i.current)?void 0:e.focus()}}));const i=(0,f.useRef)(),[o,s]=(0,f.useState)("");(0,f.useEffect)(()=>{const n=l(e,o);t(n.filteredDataTree,null)},[e]);const a=(0,f.useCallback)(e=>"string"==typeof e?e:"object"==typeof e.props.children?a(e.props.children):e.props.children,[]),r=(0,f.useCallback)((e,t)=>{const n=String(e).toLowerCase(),i=a(t.title);return!!n&&String(i).toLowerCase().includes(n)},[]),l=(0,f.useCallback)((e,t)=>{const n=[];if(!t)return{filteredDataTree:e,expandedKeys:n};const i=(e,o=!1)=>e.reduce((e,s)=>{const a=s.children,l=o||r(t,s),c=null!=a&&a.length?i(a,l):void 0;var d;(l||null!=c&&c.length)&&(!o&&null!=(d=s.children)&&d.length&&n.push(s.key),e.push(Object.assign({},s,{isLeaf:!(null!=c&&c.length),children:c})));return e},[]);return{filteredDataTree:i(e),expandedKeys:n}},[]),c=(0,f.useCallback)(av()(async n=>{const i=l(e,n.target.value);t(i.filteredDataTree,i.expandedKeys)},300),[e]);return(0,ae.jsx)("input",{ref:i,value:o,onChange:e=>{s(e.target.value),c(e)},onKeyDown:e=>{"Backspace"!==e.key&&"Delete"!==e.key||e.stopPropagation()},placeholder:"Search","data-testid":"taxonomy-search",name:"taxonomy-search-input",className:(0,Nn.cn)("taxonomy-search-input").toClassName()})}),lv=({items:e,selected:t,onChange:n,onLoadData:i,options:o,isEditable:s=!0})=>{var a;const r=(0,f.useRef)(null),[l,c]=(0,f.useState)([]),[d,u]=(0,f.useState)([]),[h,g]=(0,f.useState)([]),m=o.pathSeparator,p={minWidth:null!=(a=o.minWidth)?a:200,maxWidth:o.maxWidth},v=void 0===o.dropdownWidth||+o.dropdownWidth,y=!!o.maxUsages&&t.length>=o.maxUsages,b=t.map(e=>e.map(e=>e.value).join(m)),x=t.map(e=>({value:e.map(e=>e.value).join(m),label:o.showFullPath?e.map(e=>e.label).join(m):e.at(-1).label}));(0,f.useEffect)(()=>{c(((e,t,n)=>{const i=e=>{const t=e=>(0,ae.jsx)("span",{className:"htx-taxonomy-item-color",style:{background:e.color},children:e.label});return e.hint?(0,ae.jsx)(Pn.m_M,{title:e.hint,children:e.color?t(e):(0,ae.jsx)("span",{children:e.label})}):e.color?t(e):e.label},o=e=>{var s,a;const r=e.path.join(t.pathSeparator),l=!1!==e.isLeaf&&!(null!=(s=e.children)&&s.length),c=t.leafsOnly&&!l,d=t.maxUsagesReached&&!n.includes(r);return{title:i(e),value:r,key:r,isLeaf:l,disableCheckbox:c||d,children:null==(a=e.children)?void 0:a.map(o)}};return e.map(o)})(e,Object.assign({},o,{maxUsagesReached:y}),b))},[e,y]);const w=(0,f.useCallback)(async e=>null==i?void 0:i(e.value.split(m)),[]),S=(0,f.useCallback)((e,t)=>{u(e),null!=t&&t.length?g(t):g(void 0)},[]),C=(0,f.useCallback)(e=>(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(rv,{ref:r,treeData:l,onChange:S}),e]}),[l]),k=(0,f.useCallback)(e=>{var t;e?setTimeout(()=>{var e;null==(e=r.current)||e.focus()},200):null==(t=r.current)||t.resetValue()},[r]);return(0,ae.jsx)(ov.A,{treeData:d,value:x,labelInValue:!0,onChange:e=>n(null,e.map(e=>e.value.split(m))),loadData:w,treeCheckable:!0,showSearch:!1,showArrow:!0,dropdownRender:C,onDropdownVisibleChange:k,treeExpandedKeys:h,onTreeExpand:e=>{g(e)},treeCheckStrictly:!0,showCheckedStrategy:ov.A.SHOW_ALL,treeExpandAction:!1,dropdownMatchSelectWidth:v,placeholder:o.placeholder||"Click to add...",style:p,className:"htx-taxonomy",popupClassName:"htx-taxonomy-dropdown",disabled:!s})},cv=u.gK.model("SharedStoreModel",{id:u.gK.identifier,locked:!1,children:je.unionArray(["choice"])}).actions(e=>({setChildren(t){e.children=t},clear(){e.children=[]},lock(){e.locked=!0},unlock(){e.locked=!1},destroy(){e.clear(),(0,u.Yo)(e)}})),dv=new Map,uv=new Set,hv=u.gK.optional(u.gK.maybeNull(u.gK.string),null),gv=u.gK.optional(u.gK.maybeNull(u.gK.late(()=>u.gK.reference(cv))),null),mv=u.gK.model("SharedStoreMixin",{sharedstore:hv,store:gv}).views(e=>({get children(){return e.sharedChildren},get locked(){var t,n;return null!=(t=null==(n=e.store)?void 0:n.locked)&&t},set children(t){var n;null==(n=e.store)||n.lock(),e.store.setChildren(t)},get sharedChildren(){var t;return null!=(t=e.store.children)?t:[]},get storeId(){var t;return null!=(t=e.sharedstore)?t:e.name}})).actions(e=>({afterCreate(){if(!(0,u.$Q)(()=>e.store)){const t=dv.get(e.storeId),n=je.getParentOfTypeString(e,"AnnotationStore");if(!n)return;n.addSharedStore(t),uv.add(e.storeId),e.store=e.storeId}}})).preProcessSnapshot(e=>{var t;const n=null!=(t=e.sharedstore)?t:e.name;var i,o;uv.has(n)?e.store=n:dv.set(n,cv.create({id:n,children:null!=(i=null!=(o=e._children)?o:e.children)?i:[]}));return e}),pv=()=>{dv.clear(),uv.clear()},fv={taxonomy:"lsf-taxonomy",taxonomy__loading:"lsf-taxonomy__loading",taxonomy__new:"lsf-taxonomy__new"},vv=["alias","children","isLeaf","value"],yv=u.gK.model({toname:u.gK.maybeNull(u.gK.string),labeling:u.gK.optional(u.gK.boolean,!1),leafsonly:u.gK.optional(u.gK.boolean,!1),showfullpath:u.gK.optional(u.gK.boolean,!1),legacy:u.gK.optional(u.gK.boolean,!1),pathseparator:u.gK.optional(u.gK.string," / "),apiurl:u.gK.maybeNull(u.gK.string),placeholder:"",minwidth:u.gK.maybeNull(u.gK.string),maxwidth:u.gK.maybeNull(u.gK.string),dropdownwidth:u.gK.maybeNull(u.gK.string),maxusages:u.gK.maybeNull(u.gK.string),value:u.gK.optional(u.gK.string,"")});const bv=new Map,xv=u.gK.model({}).views(e=>({get result(){if(!e.isLabeling&&!e.perregion)return e.peritem?e._perItemResult:e.annotation.results.find(t=>t.from_name===e);const t=e.annotation.highlightedNode;return t?e.annotation.results.find(n=>n.from_name===e&&n.area===t):null},get canRemoveItems(){return!e.isLabeling||!e.result}})).actions(e=>{const t={updateResult:e.updateResult};return{updateResult(){if(!e.isLabeling)return t.updateResult();e.result&&e.result.area.setValue(e)},findLabel(t){let n,i="",o=e.items;for(const a of t){var s;if(n=null==(s=o)?void 0:s.find(e=>e.path.at(-1)===a),!n)return null;o=n.children,i=e.showfullpath&&i?i+e.pathseparator+n.label:n.label}const a={value:i,id:t.join(e.pathseparator)};return n.color&&(a.background=n.color,a.parent={}),a}}}),wv=u.gK.model({pid:u.gK.optional(u.gK.string,I),type:"taxonomy",_children:je.unionArray(["choice"])}).volatile(()=>({maxUsagesReached:!1,selected:[],loading:!0,_api:"",_items:[]})).views(e=>({get children(){return e._children},set children(t){e._children=t},get isLabeling(){return(0,Ne.VS)(Ne.um)&&e.labeling},get userLabels(){return e.annotation.store.userLabels},get holdsState(){return e.selected.length>0},get isSelected(){return e.holdsState},get hasValue(){return e.holdsState},get valueType(){return"taxonomy"},get tiedChildren(){return st.filterChildrenOfType(e,"ChoiceModel")},get preselectedValues(){return e.tiedChildren.filter(e=>!0===e.selected&&!e.isSkipped).map(e=>e.resultValue)},get isLoadedByApi(){return(0,Ne.VS)(Ne.yD)&&!!e.apiurl},get items(){var t,n;if(e.isLoadedByApi)return e._items;const i=function(e){const t=(e,t=[])=>{const i=new Set,o=[];for(const s of e)i.has(s.value)||(i.add(s.value),o.push(n(s,t)));return o},n=(e,n=[])=>{var i;const o=e.value,s=e.hint,a=[...n,null!=(i=e.alias)?i:o],r={label:o,path:a,depth:n.length,hint:s};return e.color&&(r.color=e.color),e.children&&(r.children=t(e.children,a)),r};return e?Array.isArray(e)?t(e):t([e]):[]}(e.children),o=null!=(t=null==(n=e.userLabels)?void 0:n.controls[e.name])?t:[];for(const e of o){let t={children:i};const{origin:n,path:o}=e,a=o.length-1;for(let e=0;e<a;e++){var s;if(t=null==(s=t.children)?void 0:s.find(t=>t.label===o[e]),!t)break}t&&(t.children||(t.children=[]),t.children.push({label:o[a],path:o,depth:a,origin:n}))}return i},get selectedItems(){return e.selected.map(t=>{let n=e.items;const i=[];for(const e of t){var o,s;const t=n.find(t=>t.path.at(-1)===e);i.push({label:null!=(o=null==t?void 0:t.label)?o:e,value:e}),n=null!=(s=null==t?void 0:t.children)?s:[]}return i})},get defaultChildType(){return"choice"},selectedValues:()=>e.selected,findItemByValueOrAlias(t){const n=e=>{for(const i of e){const e=i.label,o=i.path[i.path.length-1];if(i.value=e,o!==e&&(i.alias=o),i.value===t||i.alias===t)return i;if(i.children){const e=n(i.children,t);if(e)return e}}};return n(e.items)}})).actions(e=>({afterAttach(){var t;if(e.isLoadedByApi)return;const n=null!=(t=bv.get(e.name))?t:[];e.store&&n.length!==e.children.length?e.updateChildren():e.loading=!1},afterClone(t){e.selected=[...t.selected]},loadItems:(0,u.L3)(function*(t){if(!e._api)return;let n,i={};if(t){n={children:e.items};for(const e of t){var o;if(n=null==(o=n.children)?void 0:o.find(t=>t.path.at(-1)===e),!n)return}}if(t&&(!1!==n.isLeaf||n.children))return;e.loading=!0;const s=new URL(e._api);null==t||t.forEach(e=>s.searchParams.append("path",e)),s.username&&s.password&&(i={headers:new Headers({Authorization:`Basic ${btoa(`${s.username}:${s.password}`)}`})},s.username="",s.password="");try{var a;const o=yield fetch(s,i),{ok:r,status:l,statusText:c}=o;if(!r)throw new Error(`${l} ${c}`);const d=yield o.json(),u=null!=(a=d.items)?a:d,h=(e,t)=>e.map(e=>{let{alias:n,children:i,isLeaf:o,value:s}=e,a=(0,Se.A)(e,vv);const r=Object.assign({label:s,path:[...t,null!=n?n:s],depth:t.length,isLeaf:o},a);return i&&(r.children=h(i,r.path)),r}),g=h(u,null!=t?t:[]);t?(n.children=g,e._items=[...e._items]):e._items=g}catch(t){const n=Ds.A.ERR_LOADING_HTTP({attr:"apiUrl",error:String(t),url:e.apiurl});e.annotationStore.addErrors([Os.generalError(n)]),console.error(t)}e.loading=!1}),beforeDestroy(){bv.delete(e.name)},updateChildren(){var t;const n=null!=(t=bv.get(e.name))?t:[];if(n.length){const t=(0,u.Zn)(e),i=e=>{null==e||e.map(e=>{null==e.updateValue||e.updateValue(t),i(e.children)})};e._children=n,e.children=[...n],e.store.unlock(),bv.delete(e.name),i(e.children)}e.loading=!1},requiredModal(){dn.warning(e.requiredmessage||`Taxonomy "${e.name}" is required.`)},needsUpdate(){e.result?e.selected=e.result.mainValue:e.selected=[],e.maxUsagesReached=e.selected.length>=e.maxusages},updateFromResult(){e.needsUpdate()},onChange(t,n){(!1!==e.canRemoveItems||n.length)&&(e.selected=n.map(e=>{var t;return null!=(t=e.path)?t:e}),e.maxUsagesReached=e.selected.length>=e.maxusages,e.updateResult())},unselectAll(){(0,Ne.VS)(Ne.um)&&e.isLabeling&&(e.selected=[])},onAddLabel(t){var n;null==(n=e.userLabels)||n.addLabel(e.name,t)},onDeleteLabel(t){var n;null==(n=e.userLabels)||n.deleteLabel(e.name,t)}})).actions(e=>{const t={validate:e.validate};return{validate(){if(!t.validate()||e.maxusages&&e.selected.length>e.maxusages)return!1},beforeSend(){e.maxusages&&e.selected.length>e.maxusages&&dn.warning(`The number of options selected (${e.selected.length}) exceed the maximum allowed (${e.maxusages}). To proceed, first unselect excess options for:\r\n â€¢ Taxonomy (${e.name})`)}}}).actions(e=>{const t={updateValue:e.updateValue};return{updateValue:(0,u.L3)(function*(n){var i;if(!e.isLoadedByApi)return null==t.updateValue?void 0:t.updateValue(n);e._api=Oe(e.apiurl,n.task.dataObj),e._api=null!=(i=yield n.presignUrlForProject(e._api))?i:e._api,yield e.loadItems()})}}).preProcessSnapshot(e=>{var t;const n=null!=(t=e._children)?t:e.children;return n&&!bv.has(e.name)&&bv.set(e.name,n),delete e._children,delete e.children,e}),Sv=u.gK.compose("TaxonomyModel",Bd,Cu,yv,Ld,Te,gu,wv,mv,ut,...(0,Ne.VS)(Ne.gF)?[du]:[],...(0,Ne.VS)(Ne.um)?[xv]:[],Ye,rh,Au),Cv=(0,b.PA)(({item:e})=>{const t=[fv.taxonomy,"taxonomy",(0,Ne.VS)(Ne.yD)?fv.taxonomy__new:""].filter(Boolean).join(" "),n=e.perRegionVisible()&&e.isVisible?{}:{display:"none"},i={showFullPath:e.showfullpath,leafsOnly:e.leafsonly,pathSeparator:e.pathseparator,maxUsages:e.maxusages,maxWidth:e.maxwidth,minWidth:e.minwidth,dropdownWidth:e.dropdownwidth,placeholder:e.placeholder,canRemoveItems:e.canRemoveItems},o=!e.isLoadedByApi||!e.items.length;return e.loading&&(0,Ne.VS)(Ne.yD)&&o?(0,ae.jsx)("div",{className:t,style:n,children:(0,ae.jsx)("div",{className:fv.taxonomy__loading,children:(0,ae.jsx)(y.A,{size:"small"})})}):(0,ae.jsx)("div",{className:t,style:n,ref:e.elementRef,children:(0,Ne.VS)(Ne.yD)&&!e.legacy?(0,ae.jsx)(lv,{items:e.items,selected:e.selectedItems,onChange:e.onChange,onLoadData:e.loadItems,onAddLabel:e.userLabels&&e.onAddLabel,onDeleteLabel:e.userLabels&&e.onDeleteLabel,options:i,isEditable:!e.isReadOnly()}):(0,ae.jsx)(nh,{items:e.items,selected:e.selected,onChange:e.onChange,onAddLabel:e.userLabels&&e.onAddLabel,onDeleteLabel:e.userLabels&&e.onDeleteLabel,options:i,isEditable:!e.isReadOnly()})})});we.addTag("taxonomy",Sv,Cv);const kv=u.gK.model({controlledTags:je.unionTag(["HyperText"])}),Pv=u.gK.model("HyperTextLabelsModel",{type:"hypertextlabels",children:je.unionArray(["label","header","view","hypertext"])}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0},get serializableValue(){const t={};return t[e.resultType]=e.selectedValues(),t},get resultType(){return"hypertextlabels"},get valueType(){return"hypertextlabels"}})),Rv=u.gK.compose(Bd,Zd,Pv,kv,Kd,Dd.props({_child:"LabelModel"})),jv=u.gK.compose("HyperTextLabelsModel",Rv),Nv=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("hypertextlabels",jv,Nv);const Tv=u.gK.model({opacity:u.gK.optional(u.gK.string,"0.9"),fillcolor:u.gK.maybeNull(u.gK.string),strokeWidth:u.gK.optional(u.gK.number,1),strokeColor:u.gK.optional(u.gK.string,"#f48a42")}),_v=u.gK.model("TimeSeriesLabelesModel",{pid:u.gK.optional(u.gK.string,I),type:"timeserieslabels",children:je.unionArray(["labels","label","choice"])}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t?t.filter(e=>!0===e.isSelected):null}})),Av=Kd.props({_type:"timeserieslabels"}).views(e=>({get shouldBeUnselected(){return"single"===e.choice}})),Iv=u.gK.compose(Bd,Zd,_v,Tv,Av,Dd.props({_child:"LabelModel"})),Mv=u.gK.compose("TimeSeriesLabelsModel",Iv),Ev=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("timeserieslabels",Mv,Ev);const Kv=u.gK.model({toname:u.gK.maybeNull(u.gK.string)}),Dv=u.gK.model("TimelineLabelsModel",{pid:u.gK.optional(u.gK.string,I),type:"timelinelabels"}),Ov=u.gK.compose("TimelineLabelsModel",Bd,Zd,Dv,Kv,Dd.props({_child:"LabelModel"})),Lv=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("timelinelabels",Ov,Lv);const zv=u.gK.model({toname:u.gK.maybeNull(u.gK.string)}),Bv=u.gK.model("VideoRectangleModel",{pid:u.gK.optional(u.gK.string,I),type:"videorectangle"}),Fv=u.gK.compose("VideoRectangleModel",Bd,Bv,zv),Hv=(0,b.PA)(()=>null);we.addTag("videorectangle",Fv,Hv);const Vv=u.gK.model().volatile(()=>({isSeparated:!0})).views(e=>({get obj(){var t;return null==(t=e.annotation)?void 0:t.names.get(e.toname)},get selectedLabels(){return[]},selectedValues:()=>[],getResultValue:()=>({})})),$v=u.gK.model().actions(e=>({afterAttach(){var t;if(He.ff.isActive(Ne.cE)&&e.annotationStore.initialized)return void(e.tools=e.annotationStore.names.get(e.name).tools);const n=null!=(t=e.toolNames)?t:[],i=pd.getInstance({name:e.toname}),o={manager:i,control:e},s={};n.forEach(e=>{if(e in l){const t=l[e].create({},o);s[e]=t}}),e.tools=s,i.addToolsFromControl(e)}})),Wv=u.gK.model({toname:u.gK.maybeNull(u.gK.string),strokewidth:u.gK.optional(u.gK.string,"15")}),Uv=u.gK.model({type:"brush",removeDuplicatesNamed:"Erase"}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0}})).volatile(()=>({toolNames:["Brush","Erase"]})),Gv=u.gK.compose("BrushModel",Bd,Te,Vv,Wv,Uv,$v);we.addTag("brush",Gv,()=>null);const Yv=u.gK.model({controlledTags:je.unionTag(["Image"])}),Xv=u.gK.model("BrushLabelsModel",{type:"brushlabels",children:je.unionArray(["label","header","view","hypertext"])}),qv=u.gK.compose("BrushLabelsModel",Bd,Zd,Xv,Gv,Yv,Kd,Dd.props({_child:"LabelModel"})),Zv=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("brushlabels",qv,Zv);const Jv=u.gK.model({toname:u.gK.maybeNull(u.gK.string),strokewidth:u.gK.optional(u.gK.string,"15")}),Qv=u.gK.model({type:"bitmask",removeDuplicatesNamed:"BitmaskErase"}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0}})).volatile(()=>({toolNames:["Bitmask","BitmaskErase"]})),ey=u.gK.compose("BitmaskModel",Bd,Te,Vv,Jv,Qv,$v);we.addTag("bitmask",ey,()=>null);const ty=u.gK.model({controlledTags:je.unionTag(["Image"])}),ny=u.gK.model("BitmaskLabelsModel",{type:"bitmaskregion",children:je.unionArray(["label","header","view","hypertext"])}),iy=u.gK.compose("BitmaskLabelsModel",Bd,Zd,ny,ey,ty,Kd,Dd.props({_child:"LabelModel"})),oy=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("bitmasklabels",iy,oy);const sy=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.2"),fillcolor:u.gK.optional(Ce.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(Ce.color,"#f48a42"),fillopacity:u.gK.maybeNull(Ce.range()),canrotate:u.gK.optional(u.gK.boolean,!0)}),ay=u.gK.model({type:"ellipse"}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0}})).volatile(()=>({toolNames:["Ellipse"]})),ry=u.gK.compose("EllipseModel",Bd,Te,Vv,sy,ay,$v);we.addTag("ellipse",ry,()=>null);const ly=u.gK.model("EllipseLabelsModel",{type:"ellipselabels",children:je.unionArray(["label","header","view","hypertext"])}),cy=u.gK.compose(Bd,Zd,ly,ry,Kd,Dd.props({_child:"LabelModel"})),dy=u.gK.compose("EllipseLabelsModel",cy),uy=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("ellipselabels",dy,uy);const hy=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.9"),fillcolor:u.gK.optional(Ce.color,"#8bad00"),snap:u.gK.optional(u.gK.string,"none"),strokecolor:u.gK.optional(Ce.color,"#8bad00"),strokewidth:u.gK.optional(u.gK.string,"2")}),gy=u.gK.model({type:"keypoint"}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0}})).volatile(()=>({toolNames:["KeyPoint"],snapMode:ta})),my=u.gK.compose("KeyPointModel",Bd,Te,Vv,hy,gy,$v);we.addTag("keypoint",my,()=>null);const py=u.gK.model({controlledTags:je.unionTag(["Image"])}),fy=u.gK.model("KeyPointLabelsModel",{type:"keypointlabels",children:je.unionArray(["label","header","view","hypertext"])}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0}})),vy=u.gK.compose(Bd,Zd,fy,my,py,Kd,Dd.props({_child:"LabelModel"})),yy=u.gK.compose("KeyPointLabelsModel",vy),by=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("keypointlabels",yy,by);const xy=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.6"),blurradius:u.gK.optional(u.gK.string,"5"),defaultthreshold:u.gK.optional(u.gK.string,"15")}),wy=u.gK.model({type:"magicwand",removeDuplicatesNamed:"Erase"}).views(e=>({get hasStates(){const t=e.states();return t&&t.length>0}})).volatile(()=>({toolNames:["MagicWand","Erase"]})),Sy=u.gK.compose("MagicWandModel",Bd,Te,Vv,xy,wy,$v);we.addTag("magicwand",Sy,()=>null);const Cy=Fn("Polygons"),ky=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.2"),fillcolor:u.gK.optional(Ce.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"2"),strokecolor:u.gK.optional(Ce.color,"#f48a42"),snap:u.gK.optional(u.gK.string,"none"),pointsize:u.gK.optional(u.gK.string,"small"),pointstyle:u.gK.optional(u.gK.string,"circle")}),Py=u.gK.model({controlledTags:je.unionTag(["Image"])}),Ry=u.gK.model({type:"polygon",_value:u.gK.optional(u.gK.string,"")}).volatile(()=>({toolNames:["Polygon"]})).actions(e=>({initializeHotkeys(){Cy.addNamed("polygon:undo",()=>{var t;null!=(t=e.annotation)&&t.selected&&e.annotation.isDrawing&&e.annotation.undo()}),Cy.addNamed("polygon:redo",()=>{var t;null!=(t=e.annotation)&&t.selected&&e.annotation.isDrawing&&e.annotation.redo()})},disposeHotkeys(){Cy.removeNamed("polygon:undo"),Cy.removeNamed("polygon:redo")},afterCreate(){e.initializeHotkeys()},beforeDestroy(){e.disposeHotkeys()}})),jy=u.gK.compose("PolygonModel",Bd,Te,Vv,ky,Py,$v,Ry);we.addTag("polygon",jy,()=>null);const Ny=u.gK.model({controlledTags:je.unionTag(["Image"])}),Ty=u.gK.model("PolygonLabelsModel",{type:"polygonlabels",children:je.unionArray(["label","header","view","hypertext"])}),_y=u.gK.compose(Bd,Zd,Ty,jy,Ny,Kd,Dd.props({_child:"LabelModel"})),Ay=u.gK.compose("PolygonLabelsModel",_y),Iy=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("polygonlabels",Ay,Iy);Fn("Vectors");const My=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.2"),fillcolor:u.gK.optional(Ce.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"2"),strokecolor:u.gK.optional(Ce.color,"#f48a42"),snap:u.gK.optional(u.gK.string,"none"),pointsize:u.gK.optional(u.gK.string,"small"),pointstyle:u.gK.optional(u.gK.string,"circle"),closable:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!1),curves:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!1),minpoints:u.gK.optional(u.gK.maybeNull(u.gK.string),null),maxpoints:u.gK.optional(u.gK.maybeNull(u.gK.string),null),skeleton:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!1),pointsizeenabled:u.gK.optional(u.gK.maybeNull(u.gK.string),"5"),pointsizedisabled:u.gK.optional(u.gK.maybeNull(u.gK.string),"3")}),Ey=u.gK.model({controlledTags:je.unionTag(["Image"])}),Ky=u.gK.model({type:"vector",_value:u.gK.optional(u.gK.string,"")}).volatile(()=>({toolNames:["Vector"]})),Dy=u.gK.compose("VectorModel",Bd,Te,Vv,My,Ey,$v,Ky);we.addTag("vector",Dy,()=>null);const Oy=u.gK.model({controlledTags:je.unionTag(["Image"])}),Ly=u.gK.model("VectorLabelsModel",{type:"vectorlabels",closable:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!1),curves:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!1),minpoints:u.gK.optional(u.gK.maybeNull(u.gK.string),null),maxpoints:u.gK.optional(u.gK.maybeNull(u.gK.string),null),skeleton:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!1),pointsizeenabled:u.gK.optional(u.gK.maybeNull(u.gK.string),"5"),pointsizedisabled:u.gK.optional(u.gK.maybeNull(u.gK.string),"3"),opacity:u.gK.optional(u.gK.maybeNull(u.gK.string),"1"),children:je.unionArray(["label","vectorlabel","header","view","hypertext"])}),zy=u.gK.compose("VectorLabelsModel",Bd,Zd,Ly,Dy,Oy,Kd,Dd.props({_child:"LabelModel"})),By=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("vectorlabels",zy,By);const Fy=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Ce.range(),"0.2"),fillcolor:u.gK.optional(Ce.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(Ce.color,"#f48a42"),fillopacity:u.gK.maybeNull(Ce.range()),canrotate:u.gK.optional(u.gK.boolean,!0),snap:u.gK.optional(u.gK.string,"none")}),Hy=u.gK.model({type:"rectangle"}).volatile(()=>({toolNames:["Rect","Rect3Point"]})),Vy=u.gK.compose("RectangleModel",Bd,Te,Vv,Fy,Hy,$v);we.addTag("rectangle",Vy,()=>null);const $y=u.gK.model({controlledTags:je.unionTag(["Image"])}),Wy=u.gK.model("RectangleLabelsModel",{pid:u.gK.optional(u.gK.string,I),type:"rectanglelabels",children:je.unionArray(["label","header","view","hypertext"])}),Uy=u.gK.compose(Bd,Zd,Wy,Vy,$y,Kd,Dd.props({_child:"LabelModel"})),Gy=u.gK.compose("RectangleLabelsModel",Uy),Yy=(0,b.PA)(({item:e})=>(0,ae.jsx)(Jd,{item:e}));we.addTag("rectanglelabels",Gy,Yy);const Xy=u.gK.model({choice:u.gK.optional(u.gK.enumeration(["single","multiple"]),"multiple")}),qy=u.gK.model({id:u.gK.optional(u.gK.identifier,I),pid:u.gK.optional(u.gK.string,I),type:"relations",children:je.unionArray(["relation"])}).views(e=>({get values(){return e.children.map(e=>e.value)},findRelation:t=>e.children.find(e=>e.value===t)})).actions(()=>({})),Zy=u.gK.compose("RelationsModel",qy,Xy);we.addTag("relations",Zy,()=>null);const Jy=u.gK.model({value:u.gK.maybeNull(u.gK.string),background:u.gK.optional(Ce.color,w.A.RELATION_BACKGROUND)}),Qy=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"relation"}).actions(()=>({})),eb=u.gK.compose("RelationModel",Jy,Qy);we.addTag("relation",eb,()=>null);var tb=n(68703);const{Panel:nb}=tb.A,ib=u.gK.model({type:"panel",_value:u.gK.optional(u.gK.string,""),value:u.gK.optional(u.gK.string,""),open:u.gK.maybeNull(u.gK.boolean),children:je.unionArray(["view","header","labels","label","table","taxonomy","choices","choice","collapse","datetime","number","rating","ranker","rectangle","ellipse","polygon","keypoint","brush","bitmask","magicwand","rectanglelabels","bitmasklabels","ellipselabels","polygonlabels","vector","vectorlabels","keypointlabels","brushlabels","hypertextlabels","text","audio","image","hypertext","audioplus","list","dialog","textarea","pairwise","style","label","relations","filter","timeseries","timeserieslabels","paragraphs","paragraphlabels","pdf","video","videorectangle","timelinelabels","custominterface",...we.customTags.map(e=>e.tag.toLowerCase())])}).views(e=>({get isIndependent(){var t;return!(null==(t=e.children)||!t.some(e=>!0===e.isIndependent))}})),ob=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"collapse",size:u.gK.optional(u.gK.string,"4"),style:u.gK.maybeNull(u.gK.string),_value:u.gK.optional(u.gK.string,""),value:u.gK.optional(u.gK.string,""),bordered:u.gK.optional(u.gK.boolean,!1),accordion:u.gK.optional(u.gK.boolean,!0),open:u.gK.maybeNull(u.gK.boolean),children:je.unionArray(["panel"])}).views(e=>({get store(){return(0,u.Zn)(e)},get isIndependent(){var t;return!(null==(t=e.children)||!t.some(e=>!0===e.isIndependent))}})),sb=u.gK.compose("CollapseModel",Te,ob,Fe),ab=(0,b.PA)(({item:e})=>{const t=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&e.store.hasInterface("annotation:bulk"),n=e.children.filter(e=>"panel"===e.type&&(!t||e.isIndependent)),i=n.filter(t=>{var n;return null!=(n=t.open)?n:e.open}).map(e=>`panel-${e.value}`),o=e.accordion?i.length>0?[i[0]]:[]:i;return(0,ae.jsx)(tb.A,{bordered:e.bordered,accordion:e.accordion,defaultActiveKey:o,children:n.map((t,n)=>(0,ae.jsx)(nb,{header:t._value||t.value||`Panel ${n+1}`,forceRender:!0,children:st.renderChildren(t,e.annotation)},`panel-${t.value}`))})});we.addTag("panel",u.gK.compose("PanelModel",ib,Fe),()=>{}),we.addTag("collapse",sb,ab);var rb=n(70821),lb=n(92132);const cb={block:"block--fqozC",block_selected:"block_selected--BXxdo",name:"name--sC49k",tag:"tag--efLdj",date:"date--h1U4a"};class db extends f.Component{render(){let e,t,n,i=`${cb.block}`;return this.props.hint&&(e=(0,ae.jsx)(Qf.A,{color:"blue",children:this.props.hint})),this.props.bg&&(t=this.props.bg),this.props.selected&&(i=`${i} ${cb.block_selected}`,e=(0,ae.jsx)("div",{children:(0,ae.jsx)(Qf.A,{color:"magenta",children:"Selected Message"})}),this.props.hint&&(e=(0,ae.jsx)("div",{className:cb.tag,children:(0,ae.jsx)(Qf.A,{color:"magenta",children:this.props.hint})}))),this.props.date&&(n=(0,ae.jsx)("span",{className:cb.date,children:this.props.date})),(0,ae.jsxs)("div",{className:i,style:{background:t,width:"max-content",maxWidth:"100%"},children:[(0,ae.jsxs)("span",{className:cb.name,children:[this.props.name,":Â "]}),(0,ae.jsx)("p",{className:cb.text,children:this.props.text}),n,e]})}}db.propTypes={name:me.PropTypes.string.isRequired,text:me.PropTypes.string.isRequired,selected:me.PropTypes.bool,date:me.PropTypes.string,hint:me.PropTypes.string};const ub=u.gK.model({name:u.gK.string,text:u.gK.string,selected:u.gK.optional(u.gK.boolean,!1),date:u.gK.optional(u.gK.string,""),hint:u.gK.optional(u.gK.string,"")}),hb=u.gK.model({value:u.gK.maybeNull(u.gK.string),name:u.gK.maybeNull(u.gK.string)}),gb=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"Dialog",data:u.gK.map(ub)}),mb=u.gK.compose("DialogModel",hb,gb,Te),pb=(0,b.WQ)("store")((0,b.PA)(({store:e,item:t})=>{if(!e.task||!e.task.dataObj)return(0,ae.jsx)(rb.A,{});const n=[];let i=t.value;return"$"===i.charAt(0)&&(i=i.substr(1)),e.task.dataObj[i].forEach((e,t)=>{let i;e.name&&(i=(0,pt.convertToRGBA)((0,pt.stringToColor)(e.name),.1)),n.push((0,ae.jsx)(db,{name:e.name,hint:e.hint,text:e.text,selected:e.selected,date:e.date,id:e.id,bg:i},t))}),(0,ae.jsxs)("div",{children:[(0,ae.jsx)("div",{style:{display:"flex",flexFlow:"column",maxHeight:"500px",overflowY:"scroll",paddingRight:"10px",marginTop:"10px"},children:n}),(0,ae.jsx)(lb.A,{dashed:!0})]})}));we.addTag("dialog",mb,pb);const fb=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"header",size:u.gK.optional(u.gK.string,"4"),style:u.gK.maybeNull(u.gK.string),_value:u.gK.optional(u.gK.string,""),value:u.gK.optional(u.gK.string,""),underline:u.gK.optional(u.gK.boolean,!1)}),vb=u.gK.compose("HeaderModel",fb,Fe),yb=(0,b.PA)(({item:e})=>{var t,n;const i=(0,E.clamp)(Number.parseInt(e.size),1,5),o=e.style?st.cssConverter(e.style):{margin:"10px 0"},s={1:{variant:"display",size:"small"},2:{variant:"headline",size:"large"},3:{variant:"headline",size:"small"},4:{variant:"title",size:"large"},5:{variant:"title",size:"medium"}};return(0,ae.jsx)(Pn.o5u,{variant:(null==(t=s[i])?void 0:t.variant)||"headline",size:(null==(n=s[i])?void 0:n.size)||"small",style:o,className:e.underline?"underline":"",children:e._value})});we.addTag("header",vb,yb);var bb=n(31410);const xb=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"markdown",value:u.gK.optional(u.gK.string,""),_value:u.gK.optional(u.gK.string,""),classname:u.gK.optional(u.gK.string,""),style:u.gK.maybeNull(u.gK.string),idattr:u.gK.optional(u.gK.string,"")}).actions(e=>({updateValue(t){var n,i;const o=Oe(e.value,null!=(n=null==t||null==(i=t.task)?void 0:i.dataObj)?n:{});e._value=o.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g,"")}})),wb=u.gK.compose("MarkdownModel",Fe,Au,Te,xb),Sb=(0,b.PA)(({item:e})=>{const t=e.style?st.cssConverter(e.style):{};return!1===e.isVisible&&(t.display="none"),(0,ae.jsx)("div",{id:e.idattr,className:e.classname,style:t,children:(0,ae.jsx)(bb.o,{text:e._value||"",allowHtml:!0})})});we.addTag("markdown",wb,Sb);const Cb=u.gK.model({classname:u.gK.optional(u.gK.string,""),display:u.gK.optional(u.gK.string,"block"),style:u.gK.maybeNull(u.gK.string),idattr:u.gK.optional(u.gK.string,"")}),kb=u.gK.model({id:u.gK.identifier,type:"view",children:je.unionArray(["view","header","markdown","labels","label","table","taxonomy","choices","choice","collapse","datetime","number","rating","ranker","rectangle","ellipse","polygon","keypoint","brush","bitmask","magicwand","rectanglelabels","ellipselabels","polygonlabels","vector","vectorlabels","keypointlabels","brushlabels","hypertextlabels","timeserieslabels","bitmasklabels","text","audio","image","hypertext","richtext","timeseries","audioplus","list","dialog","textarea","pairwise","style","relations","filter","pagedview","paragraphs","paragraphlabels","pdf","video","videorectangle","timelinelabels","custominterface",...we.customTags.map(e=>e.tag.toLowerCase())])}).views(e=>({get isIndependent(){return!0}})),Pb=u.gK.compose("ViewModel",Cb,kb,Au,Te),Rb=(0,b.PA)(({item:e})=>{let t={};return"inline"===e.display&&(t={display:"inline-block",marginRight:"15px"}),e.style&&(t=st.cssConverter(e.style)),!1===e.isVisible&&(t.display="none"),(0,ae.jsx)("div",{id:e.idattr,className:e.classname,style:t,children:st.renderChildren(e,e.annotation)})});we.addTag("view",Pb,Rb);const jb=u.gK.model({id:u.gK.optional(u.gK.identifier,I),type:"style",value:u.gK.optional(u.gK.string,"")}).views(e=>({get isIndependent(){return!0}})),Nb=u.gK.compose("StyleModel",jb),Tb=(0,b.PA)(({item:e})=>(0,ae.jsx)("style",{dangerouslySetInnerHTML:{__html:(0,fe.sanitizeHtml)(e.value)}}));we.addTag("style",Nb,Tb);const _b=u.gK.model({casesensetive:u.gK.optional(u.gK.boolean,!1),cleanup:u.gK.optional(u.gK.boolean,!0),placeholder:u.gK.optional(u.gK.string,"Quick Filter"),minlength:u.gK.optional(u.gK.string,"3"),hotkey:u.gK.maybeNull(u.gK.string)}),Ab=u.gK.model(Object.assign({type:"filter",_value:u.gK.maybeNull(u.gK.string)},(0,Ne.VS)(Ne.cE)?{id:u.gK.identifier,name:u.gK.string}:{name:u.gK.identifier},{toname:u.gK.maybeNull(u.gK.string)})).views(e=>({get toTag(){return e.annotation.names.get(e.toname)},get isIndependent(){var t,n;return null!=(t=null==(n=e.toTag)?void 0:n.isIndependent)&&t}})).actions(e=>({applyFilter(){let t=e._value;const n=e.toTag.tiedChildren;Number(e.minlength)>t.length?n.filter(e=>!e.visible).forEach(e=>e.setVisible(!0)):(e.casesensetive||(t=t.toLowerCase()),n.forEach(n=>{let i=n._value;e.casesensetive||(i=i.toLowerCase()),-1!==i.indexOf(t)?n.setVisible(!0):n.setVisible(!1)}))},applyFilterEv(t){const{value:n}=t.target;e._value=n,e.applyFilter()},onHotKey:()=>(e._ref&&e._ref.focus(),!1),setInputRef(t){e._ref=t},selectFirstElement(){e.toTag.selectFirstVisible()&&e.cleanup&&(e._value="",e.applyFilter())}})),Ib=u.gK.compose("FilterModel",Ab,_b,Fe,Te),Mb=(0,b.PA)(({item:e})=>{const t=e.toTag;return-1===t.type.indexOf("labels")&&-1===t.type.indexOf("choices")?null:(0,ae.jsx)(ou.A,{ref:t=>{e.setInputRef(t)},value:e._value,size:"small",onChange:e.applyFilterEv,onPressEnter:e.selectFirstElement,placeholder:e.placeholder})});var Eb;we.addTag("filter",Ib,Mb);const Kb=u.gK.compose("CustomInterfaceModel",Bd,u.gK.model({type:"custominterface"})),Db=({children:e})=>(0,ae.jsx)("code",{className:"text-sm font-mono bg-neutral-surface border border-neutral-border rounded px-tighter py-tightest",children:e});if(!(null!=(Eb=APP_SETTINGS)&&null!=(Eb=Eb.billing)&&Eb.enterprise||we.models.custominterface)){const e=(0,b.PA)(({item:e})=>(0,ae.jsxs)("div",{className:"py-base",children:[(0,ae.jsx)(Pn.l43,{})," ",(0,ae.jsx)(Db,{children:"custominterface"===e.type?"CustomInterface":"React"})," tag is only available in"," ",(0,ae.jsx)("a",{className:"no-go",href:"https://docs.humansignal.com/guide/label_studio_compare",target:"_blank",rel:"noreferrer",children:"Enterprise"}),"."]}));we.addTag("custominterface",Kb,e),we.addObjectType(Kb)}const Ob=["direction","size","className","style","children","spread","stretch","align","collapsed","truncated"],Lb=e=>{let{direction:t="horizontal",size:n,className:i,style:o,children:s,spread:a,stretch:r,align:l,collapsed:c,truncated:d}=e,u=(0,Se.A)(e,Ob);return(0,ae.jsx)("div",Object.assign({style:o},u,{className:(0,Nn.cn)("space").mod({direction:t,size:n,spread:a,stretch:r,align:l,collapsed:c,truncated:d}).mix(i).toClassName(),children:s}))};function zb(e){const t=[e];let n;for(;n=t.pop();){const e=Object.keys(n),i=Object.getOwnPropertyDescriptors(n);if(!("svg"===n.elementType))for(const o of e){const e=n[o],s=i[o].writable;e&&s&&("_debugOwner"!==o&&"object"==typeof e&&{}.hasOwnProperty.call(e,"stateNode")&&t.push(n[o]),"object"!=typeof e&&"function"!=typeof e||(n[o]=null))}}}function Bb(e){const t=Object.keys(e);for(const e of t){const t=RegExp(/^__reactProps(\$[^$]+)$/).exec(e);if(t)return t[1]}return""}function Fb(e,t){for(const n of e){if(n.isConnected)return;if("svg"===n.tagName)return;const e=Object.keys(n).filter(e=>e.startsWith("__react")&&(!RegExp(/^(?:__reactProps|__reactFiber)/).exec(e)||RegExp(new RegExp(`\\${t}$`)).exec(e)));if(e.length){for(const t of e)zb(n[t]),n[t]=null;n.childNodes&&Fb(n.childNodes,t)}}}const Hb=new WeakMap;function Vb(e,t="default"){Hb.has(e)||Hb.set(e,new Map);const n=Hb.get(e);return n.has(t)||n.set(t,function(){let e=null;return t=>{if(t)e=t;else if(e){const t=e,n=Bb(t);e=null,setTimeout(()=>{Fb([t],n)})}}}()),n.get(t)}var $b=n(94447),Wb=n(44909),Ub=n(66174);function Gb({annotation:e,root:t}){return(0,f.useLayoutEffect)(()=>()=>{e&&(0,u._n)(e)&&e.resetReady()},[null==e?void 0:e.pk,null==e?void 0:e.id]),t?st.renderItem(t,e):null}const Yb=(0,b.WQ)(({store:e})=>{var t;const n=null==(t=e.annotationStore)?void 0:t.selected;return{store:e,annotation:n,suggestions:null==n?void 0:n.suggestions}}),Xb=Yb((0,b.PA)(({store:e,annotation:t,suggestions:n})=>{if(!e.autoAnnotation)return null;const i=t.hasSuggestionsSupport&&!e.forceAutoAcceptSuggestions,o=e.awaitingSuggestions;return(0,ae.jsxs)("div",{className:(0,Nn.cn)("auto-accept").toClassName(),children:[i&&(0,ae.jsx)("div",{className:(0,Nn.cn)("auto-accept").elem("wrapper").mod({loading:o}).toClassName(),children:(0,ae.jsx)(Lb,{spread:!0,children:n.size>0?(0,ae.jsxs)(Lb,{size:"small",children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("auto-accept").elem("info").toClassName(),children:[n.size," suggestion",n.size>0&&"s"]}),(0,ae.jsx)(Pn.$nd,{className:(0,Nn.cn)("auto-accept").elem("action").mod({type:"reject"}).toClassName(),onClick:()=>t.rejectAllSuggestions(),"data-testid":"bottombar-reject-suggestions-button",children:(0,ae.jsx)(kn.kLH,{})}),(0,ae.jsx)(Pn.$nd,{className:(0,Nn.cn)("auto-accept").elem("action").mod({type:"accept"}).toClassName(),onClick:()=>t.acceptAllSuggestions(),"data-testid":"bottombar-accept-suggestions-button",children:(0,ae.jsx)(kn.iWP,{})})]}):(0,ae.jsx)(Pn.lMk,{checked:e.autoAcceptSuggestions,onChange:t=>e.setAutoAcceptSuggestions(t.target.checked),label:"Auto-Accept Suggestions","data-testid":"bottombar-auto-accept-toggle"})})}),o&&(0,ae.jsx)("div",{className:(0,Nn.cn)("auto-accept").elem("spinner").toClassName()})]})})),qb=(0,b.WQ)("store")((0,b.PA)(({store:e})=>{const t=e.hasInterface("auto-annotation")&&!e.forceAutoAnnotation;return(0,f.useEffect)(()=>{t||e.setAutoAnnotation(!1)},[t]),t?(0,ae.jsx)("div",{className:(0,Nn.cn)("dynamic-preannotations").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("dynamic-preannotations").elem("wrapper").toClassName(),children:(0,ae.jsx)(Lb,{spread:!0,children:(0,ae.jsx)(Pn.lMk,{checked:e.autoAnnotation,onChange:t=>{const n=t.target.checked;e.setAutoAnnotation(n),n||pd.allInstances().forEach(e=>e.selectDefault())},label:"Auto-Annotation","data-testid":"bottombar-auto-annotation-toggle"})})})}):null})),Zb=(0,b.PA)(({entity:e,disabled:t=!1,size:n="md"})=>{const i=e.ground_truth?"Unset this result as a ground truth":"Set this result as a ground truth",o=(0,Ne.VS)(Ne.bA)&&!e.ground_truth?kn.gkI:kn.aGI;return!e.skipped&&!e.userGenerate&&"prediction"!==e.type&&(0,ae.jsx)("div",{className:(0,Nn.cn)("ground-truth").mod({disabled:t,size:n}).toClassName(),children:(0,ae.jsx)(Pn.m_M,{alignment:"top-left",title:i,children:(0,ae.jsx)(Pn.$nd,{size:"small",look:"string",className:"!p-0",onClick:t=>{t.preventDefault(),e.setGroundTruth(!e.ground_truth)},"data-testid":"bottombar-ground-truth-button",children:(0,ae.jsx)(o,{className:(0,Nn.cn)("ground-truth").elem("indicator").mod({active:e.ground_truth,dark:(0,Ne.VS)(Ne.bA)}).toClassName()})})})})}),Jb=(0,b.PA)(({entity:e})=>{const{history:t}=e;return(0,ae.jsxs)("div",{className:(0,Nn.cn)("history-buttons").toClassName(),children:[(0,ae.jsx)(Pn.m_M,{title:"Undo",children:(0,ae.jsx)(Pn.$nd,{variant:"neutral",size:"small","aria-label":"Undo",look:"string",disabled:!(null!=t&&t.canUndo),onClick:()=>e.undo(),className:"aspect-square",leading:(0,ae.jsx)(kn.GFc,{}),"data-testid":"bottombar-undo-button"})}),(0,ae.jsx)(Pn.m_M,{title:"Redo",children:(0,ae.jsx)(Pn.$nd,{variant:"neutral",size:"small",look:"string","aria-label":"Redo",disabled:!(null!=t&&t.canRedo),onClick:()=>e.redo(),className:"aspect-square",leading:(0,ae.jsx)(kn.cHj,{}),"data-testid":"bottombar-redo-button"})}),(0,ae.jsx)(Pn.m_M,{title:"Reset",children:(0,ae.jsx)(Pn.$nd,{variant:"negative",look:"string",size:"small","aria-label":"Reset",disabled:!(null!=t&&t.canUndo),onClick:()=>null==t?void 0:t.reset(),className:"aspect-square",leading:(0,ae.jsx)(kn.Pwl,{}),"data-testid":"bottombar-reset-button"})})]})}),Qb=({store:e})=>{const t=e.annotationStore,n=t.selected,i="prediction"===(null==n?void 0:n.type),o=!0===t.viewingAll,s=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&e.hasInterface("annotation:bulk");return(0,ae.jsxs)("div",{className:(0,Nn.cn)("bottombar").elem("section").toClassName(),children:[!i&&!o&&e.hasInterface("edit-history")&&(0,ae.jsx)(Jb,{entity:n}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("action-buttons").toClassName(),children:[e.description&&e.hasInterface("instruction")&&(0,ae.jsx)(Pn.$nd,{type:"text","aria-label":"Instructions",size:"small",variant:"neutral",look:"string",tooltip:"Show instructions",onClick:()=>e.toggleDescription(),className:"aspect-square",leading:(0,ae.jsx)(kn.mJl,{}),"data-testid":"bottombar-instructions-button"}),(0,ae.jsx)(Pn.$nd,{type:"text","aria-label":"Settings",size:"small",look:"string",variant:"neutral",onClick:()=>e.toggleSettings(),tooltip:"Settings",className:"aspect-square",leading:(0,ae.jsx)(kn.Ni9,{}),"data-testid":"bottombar-settings-button"})]}),e.hasInterface("ground-truth")&&!s&&(0,ae.jsx)(Zb,{entity:n}),!o&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("model-actions").toClassName(),children:[(0,ae.jsx)(qb,{}),(0,ae.jsx)(Xb,{})]})]})};function ex(e){const t=(0,b.WQ)(({store:e})=>{var t;return{store:e,history:null==e||null==(t=e.annotationStore)||null==(t=t.selected)?void 0:t.history}})(e);return t}const tx=ex((0,b.PA)(({store:e,title:t,children:n})=>(0,ae.jsx)(Pn.m_M,{title:t,disabled:!e.settings.enableTooltips,children:n}))),nx=(0,f.memo)((0,b.PA)(({disabled:e,history:t,store:n})=>{const i=n.annotationStore.selected,o=t.canUndo||i.versions.draft;return(0,ae.jsx)(Pn.$nd,{tooltip:"Accept annotation: [ Ctrl+Enter ]","aria-label":"accept-annotation",disabled:e,onClick:async()=>{i.submissionInProgress(),await n.commentStore.commentFormSubmit(),n.acceptAnnotation()},"data-testid":"bottombar-accept-button",children:o?"Fix + Accept":"Accept"},"accept")})),ix={id:"reject",name:"reject",title:"Reject",variant:"negative",look:"outlined",ariaLabel:"reject-annotation",tooltip:"Reject annotation: [ Ctrl+Space ]",disabled:!1},ox=["OW","AD","MA"],sx=(0,f.memo)((0,b.PA)(({disabled:e,store:t,onSkipWithComment:n})=>{var i,o;const s=t.task,a=!!(null==(i=window.APP_SETTINGS)||null==(i=i.billing)?void 0:i.enterprise)&&!1===(null==s?void 0:s.allow_skip),r=null==(o=window.APP_SETTINGS)||null==(o=o.user)?void 0:o.role,l=ox.includes(r),c=!a||l,d=(0,Ne.VS)(Ne.SL)&&!0===t.overlapReached,u=e||!c||d,h=d?t.overlapReachedMessage:c?"Cancel (skip) task [ Ctrl+Space ]":"This task cannot be skipped",g=a&&l;return(0,ae.jsxs)(ae.Fragment,{children:[g&&(0,ae.jsx)(Pn.m_M,{title:"Annotators and Reviewers will not be able to skip this task",children:(0,ae.jsx)(kn.mJl,{width:20,height:20,className:"text-neutral-content ml-auto cursor-pointer"})}),(0,ae.jsx)(Pn.$nd,{"aria-label":"skip-task",disabled:u,look:"outlined",tooltip:h,onClick:async e=>{var i,o;if(!c)return;const s=()=>t.skipTask({}),a=null==(i=t.annotationStore)?void 0:i.selected;null==(o=t.hasInterface("comments:skip"))||o?n(e,s):(null==a||a.submissionInProgress(),await t.commentStore.commentFormSubmit(),t.skipTask({}))},"data-testid":"bottombar-skip-button",children:"Skip"},"skip")]})})),ax=(0,f.memo)((0,b.PA)(({disabled:e,store:t})=>(0,ae.jsx)(Pn.$nd,{tooltip:"Cancel skip: []","aria-label":"cancel-skip",look:"outlined",disabled:e,onClick:async()=>{var e;const n=null==(e=t.annotationStore)?void 0:e.selected;null==n||n.submissionInProgress(),await t.commentStore.commentFormSubmit(),t.unskipTask()},"data-testid":"bottombar-unskip-button",children:"Cancel skip"},"cancel-skip"))),rx=(0,b.PA)(({button:e,disabled:t,onClick:n,variant:i,look:o})=>{var s,a;return(0,ae.jsx)(Pn.$nd,Object.assign({},e.props,{variant:null!=(s=e.variant)?s:i,look:null!=(a=e.look)?a:o,tooltip:e.tooltip,className:"w-[150px]","aria-label":e.ariaLabel,disabled:e.disabled||t,onClick:n,"data-testid":`bottombar-custom-${e.name}-button`,children:e.title}))}),lx=ex((0,b.PA)(({store:e,history:t,annotation:n})=>{const i=e.hasInterface("review")||n.canBeReviewed,o=e.hasInterface("topbar:prevnext"),s=(0,E.isDefined)(e.annotationStore.selectedHistory),{userGenerate:a,sentUserGenerate:r,versions:l,results:c,editable:d}=n,u=(0,Nn.cn)("dropdown").elem("trigger").toClassName(),h=e.customButtons,g=[],[m,p]=(0,f.useState)(!1),v=!d||e.isSubmitting||s||m,y=e.hasInterface("annotations:deny-empty")&&0===c.length,b=(0,f.useCallback)(async(t,i,o)=>{var s,a,r;const{addedCommentThisSession:l,currentComment:c,commentFormSubmit:d}=e.commentStore,u=c[n.id],h=null==(s=null!=(a=null==u?void 0:u.text)?a:u)?void 0:s.trim();if(m)return;p(!0);const g=null==(r=e.annotationStore)?void 0:r.selected;l?(null==g||g.submissionInProgress(),i()):h?(t.preventDefault(),null==g||g.submissionInProgress(),await d(),i()):e.commentStore.setTooltipMessage(o),p(!1)},[e.rejectAnnotation,e.skipTask,e.commentStore.currentComment,e.commentStore.commentFormSubmit,e.commentStore.addedCommentThisSession,m]);if(n.isNonEditableDraft)return(0,ae.jsx)(ae.Fragment,{});const x=h.get("_before"),w=h.get("_replace"),S=null!=w?w:x;if(S){const n=(0,E.toArray)(S);for(const i of n)"string"==typeof i?"accept"===i&&g.push((0,ae.jsx)(nx,{disabled:v,history:t,store:e},i)):g.push((0,ae.jsx)(rx,{disabled:v,button:i,onClick:()=>null==e.handleCustomButton?void 0:e.handleCustomButton(i)},i.name))}if(w)return(0,ae.jsx)("div",{className:(0,Nn.cn)("controls").toClassName(),children:g});if(i){const n=(0,E.toArray)(h.get("reject")),i=n.length>0,o=ix;(i?n.filter(e=>"string"!=typeof e):[o]).forEach(t=>{const n=i?()=>null==e.handleCustomButton?void 0:e.handleCustomButton(t):()=>e.rejectAnnotation({});g.push((0,ae.jsx)(rx,{button:t,disabled:v,onClick:async t=>{var i;const o=null==(i=e.annotationStore)?void 0:i.selected;e.hasInterface("comments:reject")?b(t,n,"Please enter a comment before rejecting"):(null==o||o.submissionInProgress(),await e.commentStore.commentFormSubmit(),n())}},t.name))}),g.push((0,ae.jsx)(nx,{disabled:v,history:t,store:e},"review-accept"))}else if(n.skipped)g.push((0,ae.jsxs)("div",{className:(0,Nn.cn)("controls").elem("skipped-info").toClassName(),children:[(0,ae.jsx)(kn.r7P,{})," Was skipped"]},"skipped")),g.push((0,ae.jsx)(ax,{disabled:v,store:e},"unskip"));else{if(e.hasInterface("skip")){const t=(e,t)=>{b(e,t,"Please enter a comment before skipping")};g.push((0,ae.jsx)(sx,{disabled:v,store:e,onSkipWithComment:t},"skip"))}const i=(0,Ne.VS)(Ne.SL)&&!0===e.overlapReached,s=v||y||i,c=!s&&o,d=({isUpdate:t,onClickMethod:n})=>(0,ae.jsx)("div",{className:"p-tighter rounded",children:(0,ae.jsx)(Pn.$nd,{name:"submit-option",look:"string",size:"small",className:"w-[150px]",onClick:async t=>{var i;t.preventDefault();const o=null==(i=e.annotationStore)?void 0:i.selected;if(null==o||o.submissionInProgress(),"URLSearchParams"in window){const e=new URLSearchParams(window.location.search);e.set("exitStream","true");const t=`${window.location.pathname}?${e.toString()}`;window.history.pushState(null,"",t)}await e.commentStore.commentFormSubmit(),n()},"data-testid":`bottombar-${t?"update":"submit"}-and-exit-button`,children:(t?"Update":"Submit")+" and exit"})});if(a||e.explore&&!a&&e.hasInterface("submit")){const t=i?e.overlapReachedMessage:y?"Empty annotations denied in this project":"Save results: [ Ctrl+Enter ]";g.push((0,ae.jsx)(tx,{title:t,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("controls").elem("tooltip-wrapper").toClassName(),children:(0,ae.jsxs)(Pn.e2v,{children:[(0,ae.jsx)(Pn.$nd,{"aria-label":"Submit current annotation",name:"submit",className:"w-[150px]",disabled:s,onClick:async t=>{var n;if(t.target.classList.contains(u))return;const i=null==(n=e.annotationStore)?void 0:n.selected;null==i||i.submissionInProgress(),await e.commentStore.commentFormSubmit(),e.submitAnnotation()},"data-testid":"bottombar-submit-button",children:"Submit"}),c?(0,ae.jsx)(Pn.msM.Trigger,{alignment:"top-right",content:(0,ae.jsx)("div",{className:"p-tight bg-neutral-surface",children:(0,ae.jsx)(d,{onClickMethod:e.submitAnnotation,isUpdate:!1})}),children:(0,ae.jsx)(Pn.$nd,{disabled:s,"aria-label":"Submit annotation","data-testid":"bottombar-submit-dropdown",children:(0,ae.jsx)(kn.rIS,{})})}):null]})})},"submit"))}else if(a&&r||!a&&e.hasInterface("update")){const o=Boolean((0,Ne.VS)(Ne.I8)||r||l.result),a=(0,Ne.VS)(Ne.I8)&&!t.canUndo&&!n.draftId,h=s||a,m=i?e.overlapReachedMessage:a?"No changes were made":"Update this task: [ Ctrl+Enter ]",p=(0,ae.jsx)(tx,{title:m,children:(0,ae.jsxs)(Pn.e2v,{children:[(0,ae.jsx)(Pn.$nd,{"aria-label":"submit",name:"submit",className:"w-[150px]",disabled:h,onClick:async t=>{var n;if(t.target.classList.contains(u))return;const i=null==(n=e.annotationStore)?void 0:n.selected;null==i||i.submissionInProgress(),await e.commentStore.commentFormSubmit(),e.updateAnnotation()},"data-testid":"bottombar-update-button",children:o?"Update":"Submit"}),c?(0,ae.jsx)(Pn.msM.Trigger,{alignment:"top-right",content:(0,ae.jsx)(d,{onClickMethod:e.updateAnnotation,isUpdate:o}),children:(0,ae.jsx)(Pn.$nd,{disabled:h,"aria-label":"Update annotation","data-testid":"bottombar-update-dropdown",children:(0,ae.jsx)(kn.rIS,{})})}):null]})},"update");g.push(p)}}return(0,ae.jsx)("div",{className:(0,Nn.cn)("controls").toClassName(),children:g})})),cx=["OW","AD","MA"],dx=(0,b.PA)(({store:e})=>{var t,n,i;const o=(0,f.useMemo)(()=>e.taskHistory.findIndex(t=>t.taskId===e.task.id)+1,[e.taskHistory]),[s,a]=(0,f.useState)(0),[r,l]=(0,f.useState)(0);(0,f.useEffect)(()=>{e.commentStore.setAddedCommentThisSession(!1);const t=(0,d.mJ)(()=>e.commentStore.comments.map(e=>e.isDeleted),e=>{l(e.filter(e=>!e).length)});return()=>{null==t||t()}},[]),(0,f.useEffect)(()=>{e.commentStore.addedCommentThisSession&&a(r)},[e.commentStore.addedCommentThisSession]);const c=e.hasInterface("topbar:prevnext"),u=e.hasInterface("topbar:task-counter"),h=e.task,g=!!(null==(t=window.APP_SETTINGS)||null==(t=t.billing)?void 0:t.enterprise)&&!1===(null==h?void 0:h.allow_skip),m=null==(n=window.APP_SETTINGS)||null==(n=n.user)?void 0:n.role,p=cx.includes(m),v=!g||p,y=(0,E.isDefined)(e.annotationStore.selected.pk);let b=!y&&!e.canGoNextTask&&(!(0,Ne.VS)(Ne.JO)||e.hasInterface("skip"))&&!e.hasInterface("review")&&e.hasInterface("postpone")&&v;const x=g&&!p&&!y,w=e.canGoNextTask&&!x,S=b&&!x,C=(0,f.useMemo)(()=>e.canGoPrevTask?"Previous task":"No previous task",[e.canGoPrevTask]),k=(0,f.useMemo)(()=>x?"Submit an annotation to continue":w?"Next task":S?"Postpone task":v?"No next task available":"Cannot postpone: task cannot be skipped",[x,w,S,v]);return e.hasInterface("annotations:comments")&&(0,Ne.VS)(Ne.ow)&&(b=b&&e.commentStore.addedCommentThisSession&&r>=s),(0,ae.jsx)("div",{className:(0,Nn.cn)("bottombar").elem("section").toClassName(),children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("current-task").mod({"with-history":c}).toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("current-task").elem("task-id").toClassName(),children:[null!=(i=e.task.id)?i:I(),c&&u&&((0,Ne.VS)(Ne.P2)?(0,ae.jsxs)("div",{className:(0,Nn.cn)("current-task").elem("task-count").toClassName(),children:[e.queuePosition," of ",e.queueTotal]}):(0,ae.jsxs)("div",{className:(0,Nn.cn)("current-task").elem("task-count").toClassName(),children:[o," of ",e.taskHistory.length]}))]}),c&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("current-task").elem("history-controls").mod({newui:!0}).toClassName(),children:[(0,ae.jsx)(Pn.m_M,{title:C,children:(0,ae.jsx)(Pn.$nd,{"data-testid":"prev-task","aria-label":C,look:"string",disabled:!c||!e.canGoPrevTask,onClick:e.prevTask,variant:"neutral",leading:(0,ae.jsx)(Pn.gu7,{}),size:"small"})}),(0,ae.jsx)(Pn.m_M,{title:k,children:(0,ae.jsx)(Pn.$nd,{"data-testid":"next-task","aria-label":k,look:"string",disabled:!w&&!S,onClick:w?e.nextTask:e.postponeTask,variant:!w&&S?"primary":"neutral",leading:(0,ae.jsx)(Pn.Vjx,{}),size:"small"})})]})]})})}),ux=(0,b.PA)(({store:e})=>{const t=e.annotationStore,n=null==t?void 0:t.selected,i="prediction"===(null==n?void 0:n.type),o=!0===(null==t?void 0:t.viewingAll),s=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&e.hasInterface("annotation:bulk");return e&&!o?(0,ae.jsxs)("div",{className:(0,Nn.cn)("bottombar").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("bottombar").elem("group").toClassName(),children:[!s&&(0,ae.jsx)(dx,{store:e}),(0,ae.jsx)(Qb,{store:e})]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("bottombar").elem("group").toClassName(),children:e.hasInterface("controls")&&(e.hasInterface("review")||!i)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("bottombar").elem("section").mod({flat:!0}).toClassName(),children:(0,ae.jsx)(lx,{annotation:n})})})]}):null}),hx=e=>{const t=e.pk||e.id,n=e.serializeAnnotation(),i=e.versions.draft,o={id:t,result:n};return i&&(o.draft=i),o},gx=(0,b.PA)(({store:e})=>{const t=(0,f.useRef)(),n=(0,f.useRef)(),i=(0,f.useRef)(),o=(0,f.useCallback)(()=>{var o,s,a;const r=null==(o=t.current)?void 0:o.value,l=JSON.parse((null==(s=i.current)?void 0:s.value)||'[{ "result": [] }]'),c=JSON.parse(null==(a=n.current)?void 0:a.value);e.resetState(),e.assignConfig(r),e.assignTask({data:c}),e.initializeStore({annotations:l,predictions:[]});const d=e.annotationStore;d.annotations.length&&d.selectAnnotation(d.annotations[0].id)},[]),s=(0,f.useCallback)(()=>{const t=i.current;if(!t)return;const n=e.annotationStore.selected,o=[hx(n)];t.value=JSON.stringify(o,null,2)},[]),a=(0,f.useCallback)(()=>{const t=i.current;if(!t)return;const{annotations:n,predictions:o}=e.annotationStore,s=[...n,...o].map(hx);t.value=JSON.stringify(s,null,2)},[]);return(0,ae.jsxs)("div",{style:{width:"100%"},children:[(0,ae.jsx)("br",{}),(0,ae.jsx)("h2",{children:"Debug"}),(0,ae.jsxs)("div",{children:[(0,ae.jsx)(Pn.$nd,{size:"small",onClick:a,"aria-label":"Serialize all",children:"Serialize All Annotations"}),(0,ae.jsx)(Pn.$nd,{size:"small",onClick:s,"aria-label":"Serialize current",children:"Serialize Current Annotation"}),(0,ae.jsx)(Pn.$nd,{size:"small",onClick:o,"aria-label":"Load task",children:"Simulate Loading Task"})]}),(0,ae.jsx)(su.A,{children:(0,ae.jsxs)("div",{style:{display:"flex"},children:[(0,ae.jsxs)("div",{style:{flexBasis:"50%"},children:[(0,ae.jsx)("p",{children:"Data"}),(0,ae.jsx)("textarea",{style:{width:"100%"},ref:n,rows:4,defaultValue:e.task.data,className:"is-search"}),(0,ae.jsx)("p",{children:"Config"}),(0,ae.jsx)("textarea",{style:{width:"100%"},ref:t,rows:16,defaultValue:e.config,className:"is-search"})]}),(0,ae.jsxs)("div",{style:{flexBasis:"50%"},children:[(0,ae.jsx)("p",{children:"Annotations"}),(0,ae.jsx)("textarea",{style:{width:"100%"},ref:i,rows:22,className:"is-search"})]})]})})]})}),mx=({title:e,children:t,visible:n,onCancel:i})=>{const o={padding:"0 24px 24px",whiteSpace:"pre-wrap"};return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsxs)(ln.A,{title:"",open:n,maskClosable:!0,footer:null,closable:!0,onCancel:()=>i(),width:"70%",style:{maxHeight:"calc(100vh - 250px)",minWidth:"400px",maxWidth:"800px",borderRadius:"8px",overflow:"hidden",padding:"0"},bodyStyle:{overflow:"auto",maxHeight:"calc(100vh - 250px)",padding:"0px"},children:[(0,ae.jsx)("h2",{style:{position:"sticky",top:"0px",background:"white",padding:"24px 24px 20px",margin:"0px",fontWeight:"400",fontSize:"24"},children:e}),"string"==typeof t?(0,ae.jsx)("p",{style:o,dangerouslySetInnerHTML:{__html:(0,fe.sanitizeHtml)(t)}}):(0,ae.jsx)("p",{style:o,children:t})]})})};var px=n(19686);const fx="container--pU5HK",vx="relationItem--MyZ3F",yx="_highlighting--YEDwO",bx="_highlighted--fZddy",xx=["relation","startNode","endNode","visible"],wx=["tags","taskData"],Sx=({id:e,color:t})=>(0,ae.jsx)("marker",{id:`arrow-${e}`,viewBox:"0 0 10 10",refX:8,refY:5,markerWidth:4,markerHeight:4,orient:"auto-start-reverse",children:(0,ae.jsx)("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:t})}),Cx=({x:e,y:t,width:n,height:i})=>(0,ae.jsx)("rect",{x:e,y:t,width:n,height:i,fill:"none"}),kx=({id:e,command:t,color:n,direction:i,highlight:o})=>{const s=o?"#fa541c":n,a={d:t,stroke:s,fill:"none",strokeLinecap:"round"},r={};return"bi"!==i&&"right"!==i||(r.markerEnd=`url(#arrow-${e})`),"bi"!==i&&"left"!==i||(r.markerStart=`url(#arrow-${e})`),(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("defs",{children:(0,ae.jsx)(Sx,{id:e,color:s})}),o&&(0,ae.jsx)("path",Object.assign({},a,{stroke:n,opacity:.1,strokeWidth:6})),(0,ae.jsx)("path",Object.assign({},a,{opacity:o?1:.6,strokeWidth:2},r))]})},Px=({label:e,position:t})=>{const[n,i]=t,o=(0,f.useRef)(),[s,a]=(0,f.useState)({width:0,height:0,x:0,y:0}),r={transform:`translate(${n}, ${i})`,textAnchor:"middle",dominantBaseline:"middle"};return(0,f.useEffect)(()=>{const e=o.current.getBBox();a({x:e.x-5,y:e.y-3,width:e.width+10,height:e.height+6})},[e]),(0,ae.jsxs)("g",Object.assign({},r,{children:[(0,ae.jsx)("rect",Object.assign({},s,{stroke:"#fff",strokeWidth:2,fill:"#a0a",rx:"3"})),(0,ae.jsx)("text",Object.assign({ref:o},{fill:"white",style:{fontSize:12,fontFamily:"arial"}},{children:e}))]}))},Rx=({id:e,startNode:t,endNode:n,direction:i,rootRef:o,highlight:s,dimm:a,labels:r,visible:l})=>{const c=o.current,d=!0===t.hidden||!0===n.hidden||!l,[,u]=(0,f.useState)(),h=X({id:e,startNode:t,endNode:n,direction:i,labels:r},c),{start:g,end:m}=q(Object.assign({root:c},h)),[p,v]=Z(g,m);if((0,f.useEffect)(()=>(h.onChange(()=>u({})),()=>h.destroy()),[]),g.width<1||g.height<1||m.width<1||m.height<1)return null;const y=[vx];return s&&y.push(bx),(0,ae.jsxs)("g",{id:e,className:y.join(" "),visibility:d?"hidden":"visible",children:[(0,ae.jsx)(Cx,Object.assign({},g)),(0,ae.jsx)(Cx,Object.assign({},m)),(0,ae.jsx)(kx,{id:h.id,command:p,color:h.color,direction:h.direction,highlight:s}),h.label&&(0,ae.jsx)(Px,{label:h.label,position:v})]})},jx=(0,b.PA)(e=>{let{relation:t,startNode:n,endNode:i,visible:o}=e,s=(0,Se.A)(e,xx);const a=[n.getRegionElement?n.getRegionElement():n,i.getRegionElement?i.getRegionElement():i],[r,l]=(0,f.useState)(a[0]&&a[1]);(0,f.useEffect)(()=>{let e;const t=()=>{const n=(0,E.isDefined)(a[0])&&(0,E.isDefined)(a[1]);r!==n?l(n):!1===r&&(e=setTimeout(t,30))};return e=setTimeout(t,30),()=>clearTimeout(e)},[a,r]);const c=o&&t.visible;return r&&t.shouldRender?(0,ae.jsx)(Rx,Object.assign({id:t.id,startNode:n,endNode:i,direction:t.direction,visible:c,labels:t.selectedValues},s)):null});class Nx extends f.PureComponent{constructor(...e){super(...e),this.rootNode=(0,f.createRef)(),this.timer=null,this.state={shouldRender:!1,shouldRenderConnections:Math.random()},this.onResize=()=>{this.setState({shouldRenderConnections:Math.random()})}}componentDidUpdate(){this.rootNode.current&&!this.state.shouldRender&&this.setState({shouldRender:!0})}render(){const{relations:e,visible:t,highlighted:n}=this.props,i=!!n,o={top:0,left:0,width:"100%",height:"100%",position:"absolute",pointerEvents:"none",zIndex:100},s=["relations-overlay",fx];return i&&s.push(yx),(0,ae.jsx)(px.Ay,{onResize:this.onResize,children:()=>(0,ae.jsxs)("svg",{className:s.join(" "),ref:this.rootNode,xmlns:"http://www.w3.org/2000/svg",style:o,children:[(0,ae.jsx)("title",{children:this.state.shouldRender?"Arrow Marker":""}),this.state.shouldRender&&this.renderRelations(e,t,i,n),n?(0,ae.jsx)("use",{xlinkHref:`#${n.id}`}):null]})})}renderRelations(e,t,n,i){return e.map(e=>{const o=i===e;return(0,ae.jsx)(jx,{relation:e,rootRef:this.rootNode,startNode:e.node1,endNode:e.node2,dimm:n&&!o,highlight:o,visible:o||t,shouldUpdate:this.state.shouldRenderConnections},e.id)})}}const Tx=(0,b.PA)(Nx),_x=(0,b.PA)((0,f.forwardRef)(({store:e,tags:t},n)=>{var i;const{relations:o,showConnections:s,highlighted:a}=e;return(0,ae.jsx)(Tx,{ref:n,relations:Array.from(o),visible:s,highlighted:a,tags:Array.from(null!=(i=null==t||null==t.values?void 0:t.values())?i:[])})}));let Ax=null;const Ix=(e,t)=>{if(clearTimeout(Ax),(0,Ne.VS)(Ne.cE)){if(![...e.values()].every(u._n))return!1}else if(!(0,u._n)(e))return;const n=Array.from(e.values()).reduce((e,t)=>{var n;return e&&(null==(n=null==t?void 0:t.isReady)||n)},!0);t(n),n||(Ax=setTimeout(()=>{Ix(e,t)},100))},Mx=(0,b.PA)((0,f.forwardRef)((e,t)=>{let{tags:n,taskData:i}=e,o=(0,Se.A)(e,wx);const[s,a]=(0,f.useState)(!1);return(0,f.useEffect)(()=>(Ix(n,e=>{a(e)}),()=>clearTimeout(Ax)),[i,n]),s&&(0,ae.jsx)(_x,Object.assign({ref:t},o))}));var Ex=n(80373);const Kx={enableHotkeys:{newUI:{title:"Labeling hotkeys",description:"Enables quick selection of labels using hotkeys"},description:"Enable labeling hotkeys",onChangeEvent:"toggleHotkeys",defaultValue:!0},enableTooltips:{newUI:{title:"Show hotkeys on tooltips",description:"Displays keybindings on tools and actions tooltips"},description:"Show hotkey tooltips",onChangeEvent:"toggleTooltips",checked:"",defaultValue:!1},enableLabelTooltips:{newUI:{title:"Show hotkeys on labels",description:"Displays keybindings on labels"},description:"Show labels hotkey tooltips",onChangeEvent:"toggleLabelTooltips",defaultValue:!0},showLabels:{newUI:{title:"Show region labels",description:"Display region label names"},description:"Show labels inside the regions",onChangeEvent:"toggleShowLabels",defaultValue:!1},continuousLabeling:{newUI:{title:"Keep label selected after creating a region",description:"Allows continuous region creation using the selected label"},description:"Keep label selected after creating a region",onChangeEvent:"toggleContinuousLabeling",defaultValue:!1},selectAfterCreate:{newUI:{title:"Select region after creating it",description:"Automatically selects newly created regions"},description:"Select regions after creating",onChangeEvent:"toggleSelectAfterCreate",defaultValue:!1},showLineNumbers:{newUI:{tags:"Text Tag",title:"Show line numbers",description:"Identify and reference specific lines of text in your document"},description:"Show line numbers for Text",onChangeEvent:"toggleShowLineNumbers",defaultValue:!1},preserveSelectedTool:{newUI:{tags:"Image Tag",title:"Keep selected tool",description:"Persists the selected tool across tasks"},description:"Remember Selected Tool",onChangeEvent:"togglepreserveSelectedTool",defaultValue:!0},enableSmoothing:{newUI:{tags:"Image Tag",title:"Pixel smoothing on zoom",description:"Smooth image pixels when zoomed in"},description:"Enable image smoothing when zoom",onChangeEvent:"toggleSmoothing",defaultValue:!0},invertedZoom:{newUI:{tags:"Image Tag",title:"Invert zoom direction",description:"Invert the direction of scroll-to-zoom"},description:"Enable inverted zoom direction",onChangeEvent:"toggleInvertedZoom",defaultValue:!1}},Dx={videoDrawOutside:{description:"Allow drawing outside of video boundaries",defaultValue:!1,type:"boolean"},videoHopSize:{description:"Video hop size",defaultValue:10,type:"number"}},Ox=(0,b.PA)(({store:e,name:t,value:n})=>{const i={onChange:i=>{if(n.onChangeEvent)n.onChangeEvent(i);else if("boolean"===n.type)e.settings.toggleProperty(t);else{const o="number"===n.type?Number(i.target.value):i.target.value;e.settings.setProperty(t,o)}}};return"boolean"===n.type&&(i.checked=e.settings[t]),"boolean"!==n.type&&(i.type=n.type,i.value=e.settings[t],i.placeholder=n.description),"number"===n.type&&(i.step=n.step,i.min=n.min,i.max=n.max),(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").elem("field").toClassName(),children:"boolean"===n.type?(0,ae.jsx)(Pn.Sc0,Object.assign({},i,{children:n.description})):(0,ae.jsxs)("label",{children:[n.description,(0,ae.jsx)(ou.A,Object.assign({},i))]})},t)}),Lx=(0,b.PA)(({store:e,settings:t})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").toClassName(),children:Object.entries(t).map(([t,n])=>n.ff&&!(0,Ne.VS)(n.ff)?null:(0,ae.jsx)(Ox,{name:t,store:e,value:n},t))})),zx=({store:e})=>(0,ae.jsx)(Lx,{store:e,settings:Dx});zx.displayName="VideoSettings",zx.tagName="Video",zx.title="Video";const Bx=(0,Xs.PA)(zx),Fx=(0,Ne.VS)(Ne.bA)?{newUI:!0}:{},Hx=Object.keys(Kx).filter(e=>{const t=Kx[e].flag;return!t||He.ff.isActive(t)});if((0,Ne.VS)(Ne.bA)){const e=Hx.findIndex(e=>"enableTooltips"===e),t=Hx.findIndex(e=>"enableLabelTooltips"===e),n=Hx[e];Hx[e]=Hx[t],Hx[t]=n}const Vx=({children:e})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("settings-tag").toClassName(),children:e}),$x=(0,b.PA)(({store:e})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").mod(Fx).toClassName(),children:Hx.map((t,n)=>{var i;return(0,ae.jsx)("label",{className:(0,Nn.cn)("settings").elem("field").toClassName(),children:(0,Ne.VS)(Ne.bA)?(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("settings__label").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("settings__label").elem("title").toClassName(),children:[Kx[t].newUI.title,null==(i=Kx[t].newUI.tags)?void 0:i.split(",").map(e=>(0,ae.jsx)(Vx,{children:e},e))]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("settings__label").elem("description").toClassName(),children:Kx[t].newUI.description})]}),(0,ae.jsx)(Pn.lMk,{checked:e.settings[t],onChange:e.settings[Kx[t].onChangeEvent],description:Kx[t].description},n)]}):(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Pn.Sc0,{checked:e.settings[t],onChange:e.settings[Kx[t].onChangeEvent],children:Kx[t].description},n),(0,ae.jsx)("br",{})]})},n)})})),Wx=(0,b.PA)(({store:e})=>(0,ae.jsxs)("div",{className:(0,Nn.cn)("settings").mod(Fx).toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").elem("field").toClassName(),children:(0,ae.jsx)(Pn.Sc0,{checked:e.settings.bottomSidePanel,onChange:()=>{e.settings.toggleBottomSP(),setTimeout(E.triggerResizeEvent)},children:"Move sidepanel to the bottom"})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").elem("field").toClassName(),children:(0,ae.jsx)(Pn.Sc0,{checked:e.settings.displayLabelsByDefault,onChange:e.settings.toggleSidepanelModel,children:"Display Labels by default in Results panel"})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").elem("field").toClassName(),children:(0,ae.jsx)(Pn.Sc0,{value:"Show Annotations panel",defaultChecked:e.settings.showAnnotationsPanel,onChange:()=>{e.settings.toggleAnnotationsPanel()},children:"Show Annotations panel"})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("settings").elem("field").toClassName(),children:(0,ae.jsx)(Pn.Sc0,{value:"Show Predictions panel",defaultChecked:e.settings.showPredictionsPanel,onChange:()=>{e.settings.togglePredictionsPanel()},children:"Show Predictions panel"})})]})),Ux={General:{name:"General",component:$x},Hotkeys:{name:"Hotkeys",component:()=>{const e=[{title:"Shortcut",dataIndex:"combo",key:"combo"},{title:"Description",dataIndex:"descr",key:"descr"}],t=Fn.namespaces();return(0,ae.jsx)("div",{className:(0,Nn.cn)("keys").toClassName(),children:(0,ae.jsx)(Ex.A,{size:"small",children:Object.entries(t).map(([t,n])=>{var i,o;return 0===Object.keys(n.descriptions).length?null:(0,ae.jsx)(Ex.A.TabPane,{tab:null!=(i=n.description)?i:t,children:(0,ae.jsx)(vg.A,{columns:e,dataSource:(o=n.descriptions,Object.keys(o).filter(e=>o[e]).map(e=>({key:e,combo:e.split(",").map(e=>(0,ae.jsx)("div",{className:(0,Nn.cn)("keys").elem("key-group").toClassName(),children:e.trim().split("+").map(e=>(0,ae.jsx)("kbd",{className:(0,Nn.cn)("keys").elem("key").toClassName(),children:e},e))},e)),descr:o[e]}))),size:"small"})},t)})})})}}};(0,Ne.VS)(Ne.bA)||(Ux.Layout={name:"Layout",component:Wx});const Gx=Object.keys(Ux)[0],Yx=(0,Ne.VS)(Ne.bA)?{name:"settings-modal",title:"Labeling Interface Settings",closeIcon:(0,ae.jsx)(kn.gzW,{})}:{name:"settings-modal-old",title:"Settings",bodyStyle:{paddingTop:"0"}},Xx=(0,b.PA)(({store:e})=>{const t=(0,f.useMemo)(()=>{const t=Object.values(e.annotationStore.names.toJSON()),n=Object.values(c);return t.reduce((t,i)=>{const o=e.annotationStore.names.get(i).type,s=n.find(({tagName:e})=>e.toLowerCase()===o.toLowerCase());return s&&t.push(s),t},[])},[]);return(0,ae.jsx)(ln.A,{className:(0,Nn.cn)(Yx.name).toClassName(),open:e.showingSettings,onCancel:e.toggleSettings,footer:"",title:Yx.title,closeIcon:Yx.closeIcon,bodyStyle:Yx.bodyStyle,children:(0,ae.jsxs)(Ex.A,{defaultActiveKey:Gx,children:[Object.entries(Ux).map(([t,{name:n,component:i}])=>(0,ae.jsx)(Ex.A.TabPane,{tab:n,children:f.createElement(i,{store:e})},t)),t.map(t=>(0,ae.jsx)(Ex.A.TabPane,{tab:t.title,children:(0,ae.jsx)(t,{store:e})},t.tagName))]})})});function qx(...e){const t=e.filter(Boolean);return t.length<=1?t[0]:e=>{t.forEach(t=>{"function"==typeof t?t(e):t.current=e})}}const Zx=["ref","actionRef","onChange","onInput","onSubmit","value","autoSize","rows","maxRows","className"],Jx=e=>{let{ref:t,actionRef:n,onChange:i,onInput:o,onSubmit:s,value:a,autoSize:r=!0,rows:l=1,maxRows:c=4,className:d}=e,u=(0,Se.A)(e,Zx);const h=!!s,g=[(0,Nn.cn)("textarea").mod({inline:h,autosize:r}),d].join(" ").trim(),m=(0,f.useRef)({rows:l,maxRows:Math.max(c-1,1),lineHeight:24,maxHeight:Number.POSITIVE_INFINITY}),p=(0,f.useRef)(null),v=(0,f.useCallback)(av()(()=>{const e=p.current;if(!e||!m.current||!p.current)return;if(m.current.maxHeight===Number.POSITIVE_INFINITY){e.style.height="auto";const t=p.current.value;p.current.value="",m.current.lineHeight=p.current.scrollHeight/m.current.rows,m.current.maxHeight=m.current.lineHeight*m.current.maxRows,p.current.value=t}let t;e.scrollHeight>m.current.maxHeight?(e.style.overflowY="scroll",t=m.current.maxHeight):(e.style.overflowY="hidden",e.style.height="auto",t=e.scrollHeight);const n=e.value.length,i=e.selectionStart;requestAnimationFrame(()=>{e.style.height=`${t}px`,n===i&&(e.scrollTop=e.scrollHeight)})},10,{leading:!0}),[]);n&&(n.current={update:(e="")=>{p.current&&(p.current.value=e,v())},el:p});const y=(0,f.useCallback)(e=>{null==o||o(e.target.value),v()},[o]),b=(0,f.useCallback)(e=>{null==i||i(e.target.value),v()},[i]);return(0,f.useEffect)(()=>{const e=new ResizeObserver(v);return e.observe(p.current),()=>{p.current&&e.unobserve(p.current)}},[]),(0,f.useEffect)(()=>{p.current&&(p.current.value=a||"",v())},[a]),(0,f.useEffect)(()=>{if(!s)return;const e=e=>{p.current&&"Enter"===e.key&&(e.ctrlKey||(0,E.isMacOS)()&&e.metaKey)&&s(p.current.value)};return p.current&&p.current.addEventListener("keydown",e),()=>{p.current&&p.current.removeEventListener("keydown",e)}},[s]),(0,ae.jsx)("textarea",Object.assign({ref:qx(p,t),className:g,rows:m.current.rows,onChange:b,onInput:y,"aria-label":"TextArea Input","data-testid":"textarea-input"},u))},Qx=(0,b.PA)(({item:e})=>{const{type:t}=null!=e?e:{};if(!t)return"No Label";if(t.includes("label"))return e.value;var n;if("reactcode"===t&&(null!=(n=e.values)&&n.length))return(0,ae.jsx)("div",{className:(0,Nn.cn)("labels-list").toClassName(),children:e.values.map((e,t)=>[t?", ":null,(0,ae.jsx)("div",{className:(0,Nn.cn)("labels-list").toClassName(),children:e.length>50?`${e.slice(0,50)}...`:e},e)])});if(t.includes("region")||t.includes("range")){const t=e.labelings.map(e=>e.selectedLabels||[]),n=[].concat(...t);return(0,ae.jsx)("div",{className:(0,Nn.cn)("labels-list").toClassName(),children:n.map((e,t)=>{const n=e.background||"#000000";return[t?", ":null,(0,ae.jsx)("div",{className:(0,Nn.cn)("labels-list").toClassName(),style:{color:n},children:e.value||"No label"},e.id)]})})}return t.includes("tool")?e.value:void 0}),ew=({linking:e,region:t,result:n,onUnlink:i,interactive:o})=>{const s=e||t,a=(0,f.useMemo)(()=>e?{action:!0}:t?{display:!0}:void 0,[e,t]);return s?(0,ae.jsxs)("div",{className:(0,Nn.cn)("link-state").mod(a).toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state").elem("prefix").toClassName(),children:(0,ae.jsx)(kn.uUV,{})}),(null==a?void 0:a.action)&&"Select an object to link it to this comment.",(null==a?void 0:a.display)&&(0,ae.jsx)(tw,{region:t,result:n,onUnlink:i,interactive:o})]}):null},tw=(0,b.PA)(({region:e,result:t,interactive:n,onUnlink:i})=>{var o;const s=null!=(o=null==e?void 0:e.background)?o:null==e||null==e.getOneColor?void 0:e.getOneColor(),a=e.classification,{mouseEnterHandler:r,mouseLeaveHandler:l,clickHandler:c}=(0,f.useMemo)(()=>{if(!n)return{};return{mouseEnterHandler:()=>{null==e||null==e.setHighlight||e.setHighlight(!0)},mouseLeaveHandler:()=>{null==e||null==e.setHighlight||e.setHighlight(!1)},clickHandler:()=>{if(e.classification)return null;e.annotation.selectArea(e)}}},[n,e]),d=(0,f.useMemo)(()=>{const e=(0,ft.A)(null!=s?s:"#666").alpha(1);return{"--icon-color":e.css(),"--text-color":e.css()}},[s]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("link-state-region").mod({interactive:n}).toClassName(),style:d,onMouseEnter:r,onMouseLeave:l,onClick:c,children:[!a&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state-region").elem("icon").toClassName(),children:(0,ae.jsx)(uc,{node:e})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state-region").elem("index").toClassName(),children:e.region_index})]}),t?(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state-region").elem("title").toClassName(),children:(0,ae.jsx)(nw,{result:t})}):(0,ae.jsxs)("div",{className:(0,Nn.cn)("link-state-region").elem("title").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state-region").elem("label").toClassName(),children:(0,ae.jsx)(Qx,{item:e})}),(null==e?void 0:e.text)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state-region").elem("text").toClassName(),children:e.text.replace(/\\n/g,"\n")})]}),i&&(0,ae.jsx)("div",{className:(0,Nn.cn)("link-state-region").elem("close").toClassName(),children:(0,ae.jsx)(Pn.$nd,{size:"small",variant:"neutral",look:"string",leading:(0,ae.jsx)(kn.gzW,{}),onClick:i,"aria-label":"Unlink comment"})})]})}),nw=(0,b.PA)(({result:e})=>{const{from_name:t,type:n,mainValue:i}=e,{name:o}=t;if("textarea"===n)return[o,i.join(" | ")].join(": ");if("choices"===n)return[o,i.join(", ")].join(": ");if("taxonomy"===n){return[o,i.map(e=>e.join("/")).join(", ")].join(": ")}return[o,String(i)].join(": ")}),iw=({region:e,linking:t,onLinkTo:n})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-form-buttons").toClassName(),children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-form-buttons").elem("buttons").toClassName(),children:[n&&!e&&(0,ae.jsx)(Pn.m_M,{title:"Link to...",children:(0,ae.jsx)("button",{type:"button",className:(0,Nn.cn)("comment-form-buttons").elem("action").mod({highlight:t}).toClassName(),onClick:n,children:(0,ae.jsx)(kn.uUV,{})})}),(0,ae.jsx)("button",{type:"submit",className:(0,Nn.cn)("comment-form-buttons").elem("action").toClassName(),children:(0,ae.jsx)(kn.mDt,{})})]})}),ow=(0,b.PA)(({commentStore:e,annotationStore:t,inline:n=!0})=>{var i;const o=(0,f.useRef)(null),s=(0,f.useRef)({}),a=()=>e.setTooltipMessage(""),r=t.selected&&t.selected.linkingMode===R,[l,c]=(0,f.useState)(),d=(0,f.useCallback)((t=!0)=>{let n=e.commentInProgress;return!n&&t&&(n=Op.create({text:""},{annotationStore:e.annotationStore}),e.setCurrentComment(n)),n},[e]),u=(0,f.useCallback)(e=>{d().setText(e)},[e,t]),h=(0,f.useCallback)(e=>{null==e||null==e.preventDefault||e.preventDefault();if(t.selected&&t.selected.linkingMode===R)return void t.selected.stopLinkingMode();const n=d();c(n),t.selected.startLinkingMode(R,n)},[e,t]),g=(0,f.useCallback)(async t=>{if(null==t||null==t.preventDefault||t.preventDefault(),!o.current||"addComment"===e.loading)return;const n=d(!1),i=null==n?void 0:n.text,s=null==n?void 0:n.regionRef,a=null==n?void 0:n.classifications;if(i.trim()||a)try{e.setCurrentComment(void 0);const t={text:i,regionRef:s,classifications:a};await e.addComment(t)}catch(t){e.setCurrentComment(n),console.error(t)}},[e,t]);(0,f.useEffect)(()=>((0,Ne.VS)(Ne.bA)||(e.setAddedCommentThisSession(!1),a()),()=>a()),[]),(0,f.useEffect)(()=>{var t;(0,Ne.VS)(Ne.bA)&&(e.tooltipMessage&&(null==(t=s.current)||null==(t=t.el)||null==(t=t.current)||t.focus({preventScroll:!0})))},[e.tooltipMessage]),(0,f.useEffect)(()=>{var t;e.setInputRef(null==(t=s.current)?void 0:t.el),e.setCommentFormSubmit(()=>g())},[s,e]);const m=null==(i=t.selected.currentLinkingMode)?void 0:i.comment,p=d(),{text:v="",regionRef:y,classifications:b}=p||{},{region:x,result:w}=y||{},S=!!l&&m===l&&r,C=S||x,k=(0,f.useMemo)(()=>{var e;return Ip(null==b||null==(e=b.default)?void 0:e.values)},[b]),P=e.commentClassificationsItems,j=(0,f.useCallback)(e=>{d().setClassifications(e)},[d]),N=(0,f.useCallback)(async(e,t)=>{const n=t.length>0?{default:{type:"taxonomy",values:t}}:null;j(n)},[j]);return(0,ae.jsxs)("form",{ref:o,className:(0,Nn.cn)("comment-form-new").mod({inline:n,linked:!!x}).toClassName(),onSubmit:g,children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-form-new").elem("text-row").toClassName(),children:[(0,ae.jsx)(Jx,{actionRef:s,name:"comment",placeholder:"Add a comment",value:v,rows:1,maxRows:4,onInput:u,onSubmit:n?g:void 0,onBlur:a}),0===P.length&&(0,ae.jsx)(iw,{region:x,linking:S,onLinkTo:h})]}),P.length>0&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-form-new").elem("classifications-row").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-form-new").elem("category-selector").toClassName(),children:(0,ae.jsx)(lv,{selected:k,items:P,onChange:N,options:Mp})}),(0,ae.jsx)(iw,{region:x,linking:S,onLinkTo:h})]}),C&&(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-form-new").elem("link-state").toClassName(),children:(0,ae.jsx)(ew,{linking:S,region:x,result:w,onUnlink:null==p?void 0:p.unsetLink})}),e.tooltipMessage&&(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-form-new").elem("tooltipMessage").toClassName(),children:e.tooltipMessage})]})}),sw=(0,b.PA)(({value:e="",inline:t=!0,onChange:n,onSubmit:i,onBlur:o,rows:s=1,maxRows:a=4,classifications:r})=>{const l=(0,f.useRef)(null),c=(0,f.useRef)({}),d=(0,f.useCallback)(async e=>{var t;if(null==e||null==e.preventDefault||e.preventDefault(),!l.current)return;const n=null==(t=new FormData(l.current).get("comment"))?void 0:t.trim();(n||r)&&(null==i||i(n))},[i]),u=(0,f.useCallback)(e=>{null==n||n(e||"")},[n]);return(0,ae.jsxs)("form",{ref:l,className:(0,Nn.cn)("comment-form").mod({inline:t}).toClassName(),onSubmit:d,children:[(0,ae.jsx)(Jx,{actionRef:c,name:"comment",placeholder:"Add a comment",value:e,rows:s,maxRows:a,onChange:n,onInput:u,onSubmit:e=>{t&&(e=e.trim())&&(null==i||i(e))},onBlur:e=>null==o?void 0:o(e)}),(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-form").elem("primary-action").toClassName(),children:(0,ae.jsx)(Pn.$nd,{type:"submit","aria-label":"Submit comment",variant:"neutral",look:"string",children:(0,ae.jsx)(kn.mDt,{})})})]})}),aw=(0,b.PA)(({comment:e,listComments:t,classificationsItems:n})=>{var i,o,s,a;const{classifications:r,updatedAt:l,isEditMode:c,isConfirmDelete:d,createdAt:u,isPersisted:h,isDeleted:g,createdBy:m,text:p,regionRef:v,isResolved:y,updateComment:b,deleteComment:x,setConfirmMode:w,setClassifications:S,setEditMode:C,toggleResolve:k,canResolveAny:P,isHighlighted:R,setHighlighted:j,_commentRef:N}=e,{startLinkingMode:T,currentComment:_,globalLinking:A}=(0,f.useContext)(rw),I=null==(i=window.APP_SETTINGS)?void 0:i.user,M=(null==I?void 0:I.id)===m.id,K=null==(o=e.commentsStore)||null==(o=o.store)?void 0:o.hasInterface("annotations:hide-info"),D=K?{email:M?"Me":"User"}:null,[O,L]=(0,f.useState)(p),[z,B]=(0,f.useState)(),F=null==v?void 0:v.region,H=null==v?void 0:v.result,V=!(!z||_!==z||!A),$=V||F,W=(0,f.useCallback)(e=>{B(e),T(e)},[T]),U=(0,f.useCallback)(()=>{null!=v&&v.region?e.unsetLink():W(e)},[e,W,null==v?void 0:v.region]),G=(0,f.useCallback)(async(e,t)=>{const n=t.length>0?{default:{type:"taxonomy",values:t}}:null;S(n)},[S]),Y=(0,f.useMemo)(()=>{var e;return Ip(null==r||null==(e=r.default)?void 0:e.values)},[r]),X=(0,f.useCallback)(async e=>{await b(e,r),L(e),await t({suppressClearComments:!0})},[b,t,r]);if(g)return null;const q=()=>{const e=new Date(l),t=new Date(u);e.setMilliseconds(0),t.setMilliseconds(0);const n=e>t,i=n?l:u;return h&&i?(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("date").toClassName(),children:(0,ae.jsx)(Pn.m_M,{alignment:"top-right",title:new Date(i).toLocaleString(),children:(0,ae.jsx)("span",{children:`${n?"updated":""} ${(0,E.humanDateDiff)(i)}`})})}):null};return(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-item").mod({resolved:y,highlighted:R}).toClassName(),onMouseEnter:()=>{j(!0)},onMouseLeave:()=>{j(!1)},ref:N,children:[(0,ae.jsxs)(Lb,{spread:!0,size:"medium",truncated:!0,children:[(0,ae.jsxs)(Lb,{size:"small",truncated:!0,children:[(0,ae.jsx)(Pn.an1,{className:(0,Nn.cn)("comment-item").elem("userpic").toClassName(),user:null!=D?D:m,showUsernameTooltip:!0,username:m}),(0,ae.jsx)("span",{className:(0,Nn.cn)("comment-item").elem("name").toClassName(),children:(0,E.userDisplayName)(null!=D?D:m)})]}),(0,ae.jsxs)(Lb,{size:"small",children:[(0,ae.jsx)(kn.iWP,{className:(0,Nn.cn)("comment-item").elem("resolved").toClassName()}),(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("saving").mod({hide:h}).toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("dot").toClassName()})}),!K&&(0,ae.jsx)(q,{})]})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-item").elem("content").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("text").toClassName(),children:c?(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(sw,{value:O,onSubmit:X,classifications:r}),n.length>0&&(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("classifications-row").toClassName(),children:(0,ae.jsx)(lv,{selected:Y,items:n,onChange:G,options:Mp})})]}):d?(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-item").elem("confirmForm").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("question").toClassName(),children:"Are you sure?"}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("comment-item").elem("controls").toClassName(),children:[(0,ae.jsx)(Pn.$nd,{onClick:()=>x(),size:"small",look:"danger",autoFocus:!0,"aria-label":"Delete comment",children:"Yes"}),(0,ae.jsx)(Pn.$nd,{onClick:()=>w(!1),size:"small","aria-label":"Cancel delete",children:"No"})]})]}):(0,ae.jsxs)(ae.Fragment,{children:[(null==r||null==(s=r.default)||null==(s=s.values)?void 0:s.length)>0&&(0,ae.jsx)("ul",{className:(0,Nn.cn)("comment-item").elem("classifications").toClassName(),children:null==r||null==(a=r.default)||null==(a=a.values)?void 0:a.map((e,t)=>(0,ae.jsx)("li",{children:e.join("/")},t))}),O,$&&(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("linkState").toClassName(),children:(0,ae.jsx)(ew,{linking:V,region:F,result:H,interactive:!0})})]})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("comment-item").elem("actions").toClassName(),onClick:e=>{e.stopPropagation(),e.preventDefault()},children:h&&(M||P)&&(0,ae.jsx)(Pn.msM.Trigger,{content:(0,ae.jsxs)(um,{size:"auto",children:[(0,ae.jsx)(um.Item,{onClick:k,children:y?"Unresolve":"Resolve"}),M&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(um.Item,{onClick:()=>{const e=!c;C(e),e||L(p)},children:c?"Cancel edit":"Edit"}),(0,ae.jsx)(um.Item,{onClick:U,children:null!=v&&v.region?"Unlink":"Link to..."}),!d&&(0,ae.jsx)(um.Item,{onClick:()=>{w(!0)},children:"Delete"})]})]}),children:(0,ae.jsx)(Pn.$nd,{size:"small",look:"string",icon:(0,ae.jsx)(kn.dbp,{}),"aria-label":"Comment options"})})})]})]})}),rw=(0,f.createContext)({startLinkingMode:()=>{},globalLinking:!1,currentComment:null}),lw=(0,b.PA)(({commentStore:e})=>{var t,n;const i=(0,f.useCallback)(t=>{e.annotation.startLinkingMode(R,t)},[e]),o=(null==(t=e.annotation)?void 0:t.linkingMode)===R,s=null==(n=e.annotation.currentLinkingMode)?void 0:n.comment,a=(0,f.useMemo)(()=>({startLinkingMode:i,currentComment:s,globalLinking:o}),[i,s,o]);return(0,ae.jsx)(rw.Provider,{value:a,children:(0,ae.jsx)(cw,{commentStore:e})})}),cw=(0,b.PA)(({commentStore:e})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("comments-list").toClassName(),children:e.comments.map(t=>(0,ae.jsx)(aw,{comment:t,listComments:e.listComments,classificationsItems:e.commentClassificationsItems},t.id))})),dw=(0,b.PA)(({annotationStore:e,commentStore:t,cacheKey:n})=>{const i=x();return(0,f.useEffect)(()=>{(async()=>{const e={mounted:i,suppressClearComments:t.isRelevantList};await t.listComments(e),(0,Ne.VS)(Ne.K3)||t.restoreCommentsFromCache(n)})()},[t.annotation.id]),(0,f.useEffect)(()=>{const e=e=>(t.hasUnsaved&&(e.returnValue="You have unpersisted comments which will be lost if continuing."),e);return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[t.hasUnsaved]),(0,ae.jsxs)("div",{className:(0,Nn.cn)("comments").toClassName(),children:[(0,ae.jsx)(ow,{commentStore:t,annotationStore:e,inline:!0}),(0,ae.jsx)(lw,{commentStore:t})]})}),uw=({icon:e,header:t,description:n,learnMore:i})=>{var o;const s="undefined"!=typeof window&&!0===(null==(o=window.APP_SETTINGS)?void 0:o.whitelabel_is_active);return(0,ae.jsxs)("div",{className:"flex flex-col items-center justify-center gap-2 p-6 w-full","data-testid":"empty-state",children:[(0,ae.jsx)("div",{className:"flex items-center justify-center bg-primary-background text-primary-icon rounded-full p-2 mb-2",children:e}),(0,ae.jsxs)("div",{className:"flex flex-col items-center w-full gap-1",children:[(0,ae.jsx)("div",{className:"font-medium text-body-medium leading-tight text-center text-neutral-content","data-testid":"empty-state-header",children:t}),(0,ae.jsx)("div",{className:"text-body-small text-neutral-content-subtler text-center w-full","data-testid":"empty-state-description",children:n})]}),i&&!s&&(0,ae.jsx)("div",{className:"flex justify-center items-center w-full pt-tight mt-tight",children:(0,ae.jsxs)("a",Object.assign({href:i.href,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 text-body-small text-primary-link hover:underline"},i.testId?{"data-testid":i.testId}:{},{children:[i.text,(0,ae.jsx)(Pn.fqm,{width:16,height:16,className:"ml-1"})]}))})]})},hw=(0,b.WQ)(({store:e})=>{var t;const n=e.annotationStore,i=null==n?void 0:n.selected;return{annotationStore:n,selected:null==n?void 0:n.selected,createdBy:null!=(t=null==i?void 0:i.user)?t:{email:null==i?void 0:i.createdBy},createdDate:null==i?void 0:i.createdDate,history:null==n?void 0:n.history,selectedHistory:null==n?void 0:n.selectedHistory}}),gw=(0,b.PA)(({annotation:e,inline:t,isSelected:n})=>{var i;const o=e.history.hasChanges,s=e.list,a=s.store.hasInterface("annotations:hide-info"),r=a?{email:"Me"}:null,[l,c]=(0,f.useState)(!1);return(0,f.useEffect)(()=>{c(!0)},[e.history.history.length]),(0,f.useEffect)(()=>{c(!1)},[e.draftSaved]),o||e.versions.draft?(0,ae.jsx)(fw,{user:null!=(i=null!=r?r:e.user)?i:{email:e.createdBy},date:e.draftSaved,extra:e.isDraftSaving?(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-history").elem("saving").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-history").elem("spin").toClassName()})}):l?(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-history").elem("saving").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-history").elem("dot").toClassName()})}):o?(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-history").elem("saving").toClassName(),children:(0,ae.jsx)(kn.iWP,{className:(0,Nn.cn)("annotation-history").elem("saved").toClassName()})}):null,inline:t,comment:"",acceptedState:"draft_created",selected:n,hideInfo:a,onClick:()=>{s.selectHistory(null),e.toggleDraft(!0)}},"draft"):null}),mw=({reason:e,comment:t})=>{const[n,i]=(0,f.useState)(!1),[o,s]=(0,f.useState)(!1),a=(0,f.useRef)();return(0,f.useLayoutEffect)(()=>{if(a.current){const{clientHeight:e}=a.current,t=e>66;s(t),i(t)}},[]),(0,ae.jsxs)("div",{className:(0,Nn.cn)("history-item").elem("comment").mod({collapsed:n}).toClassName(),ref:a,children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("history-item").elem("comment-content").toClassName(),"data-reason":`${e}${t?": ":""}`,children:t}),o&&(0,ae.jsx)("div",{className:(0,Nn.cn)("history-item").elem("collapse-comment").mod({collapsed:n}).toClassName(),onClick:e=>{e.stopPropagation(),i(e=>!e)},children:n?"Show more":"Show less"})]})},pw=({type:e})=>{const t=(0,f.useMemo)(()=>{switch(e){case"submitted":case"updated":return(0,ae.jsx)(kn.eBz,{style:{color:"#617ADA"}});case"draft_created":return(0,ae.jsx)(kn.lgA,{style:{color:"#617ADA"}});case"accepted":return(0,ae.jsx)(kn.eYs,{style:{color:"#2AA000"}});case"rejected":return(0,ae.jsx)(kn.RVl,{style:{color:"#dd0000"}});case"fixed_and_accepted":return(0,ae.jsx)(kn.eYs,{style:{color:"#FA8C16"}});case"prediction":return(0,ae.jsx)(kn.Ufx,{style:{color:"#944BFF"}});case"imported":return(0,ae.jsx)(kn.L$Q,{style:{color:"#2AA000"}});case"skipped":return(0,ae.jsx)(kn.rU4,{style:{color:"#dd0000"}});case"deleted_review":return(0,ae.jsx)(kn.r6U,{style:{color:"#dd0000"}});case"propagated_annotation":return(0,ae.jsx)(kn.kLp,{style:{color:"#2AA000"}});default:return null}},[e]);return t&&(0,ae.jsx)("div",{className:(0,Nn.cn)("history-item").elem("history-icon").toClassName(),children:t})},fw=(0,b.PA)(({entity:e,user:t,date:n,extra:i,comment:o,acceptedState:s,selected:a=!1,disabled:r=!1,inline:l=!1,hideInfo:c,onClick:d})=>{const u="prediction"===(null==e?void 0:e.type),h=(0,f.useMemo)(()=>{switch(s){case"accepted":return"Accepted";case"rejected":return"Rejected";case"fixed_and_accepted":return"Fixed";case"updated":return"Updated";case"submitted":return"Submitted";case"prediction":return"From prediction";case"imported":return"Imported";case"skipped":return"Skipped";case"draft_created":return"Draft";case"deleted_review":return"Review deleted";case"propagated_annotation":return"Propagated";default:return null}},[]),g=(0,f.useCallback)(e=>{r||d(e)},[d,r]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("history-item").mod({inline:l,selected:a,disabled:r}).toClassName(),onClick:g,children:[(0,ae.jsxs)(Lb,{spread:!0,size:"medium",truncated:!0,children:[(0,ae.jsxs)(Lb,{size:"small",truncated:!0,children:[(0,ae.jsx)(Pn.an1,{className:(0,Nn.cn)("history-item").elem("userpic").mod({prediction:u}).toClassName(),user:t,showUsernameTooltip:!0,username:u?e.createdBy:null,children:u&&(0,ae.jsx)(kn.ccx,{style:{width:16,height:16}})}),(0,ae.jsx)("span",{className:(0,Nn.cn)("history-item").elem("name").toClassName(),children:u?e.createdBy:(0,E.userDisplayName)(t)})]}),!c&&(0,ae.jsxs)(Lb,{size:"small",children:[i&&(0,ae.jsx)("div",{className:(0,Nn.cn)("history-item").elem("date").toClassName(),children:i}),n&&(0,ae.jsx)("div",{className:(0,Nn.cn)("history-item").elem("date").toClassName(),children:(0,ae.jsx)(Pn.m_M,{alignment:"top-right",title:new Date(n).toLocaleString(),children:(0,ae.jsx)("span",{children:(0,E.humanDateDiff)(n)})})})]})]}),(h||o)&&(0,ae.jsxs)(Lb,{className:(0,Nn.cn)("history-item").elem("action").toClassName(),size:"small",children:[s&&(0,ae.jsx)(pw,{type:s}),(0,ae.jsx)(mw,{comment:o,reason:h})]})]})});fw.displayName="HistoryItem";const vw=hw((0,b.PA)(({annotationStore:e,selectedHistory:t,history:n,enabled:i=!0,inline:o=!1,showEmptyState:s=!0,sectionHeader:a,renderEmptyState:r})=>{var l,c;const u=e.selected,h=null!=n&&n.length?n[0]:null,g=u.history.hasChanges,m=e.store.hasInterface("annotations:hide-info"),p=null==(l=window.APP_SETTINGS)?void 0:l.user,f=!e.selectedHistory&&(u.draftSelected||!u.versions.draft&&g),v=null==u||null==(c=u.versions)?void 0:c.draft,y=n&&n.length>0,b=s&&!g&&!v&&!y,x=(0,ae.jsx)(uw,{icon:(0,ae.jsx)(kn.fYt,{width:24,height:24}),header:"View annotation activity",description:(0,ae.jsx)(ae.Fragment,{children:"See a log of user actions for this annotation"})});return b?(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-history").mod({inline:o,empty:!0}).toClassName(),children:[a&&(0,ae.jsx)("div",{className:`${(0,Nn.cn)("annotation-history").elem("section-head").toString()} sr-only`,children:a}),r?r():x]}):(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-history").mod({inline:o}).toClassName(),children:[a&&(0,ae.jsx)("div",{className:`${(0,Nn.cn)("annotation-history").elem("section-head").toString()} sr-only`,children:a}),(0,ae.jsx)(gw,{annotation:u,isSelected:f,inline:o}),i&&n.length>0&&n.map(n=>{var i;const{id:s,user:a,createdDate:r}=n,l=(null==h?void 0:h.id)===n.id,c=l&&!t?!f:(null==t?void 0:t.id)===n.id,v=m?{email:(null==p?void 0:p.id)===a.id?"Me":"User"}:null;return(0,ae.jsx)(fw,{inline:o,user:null!=(i=null!=v?v:a)?i:{email:null==n?void 0:n.createdBy},date:r,comment:n.comment,acceptedState:n.actionType,selected:c,disabled:0===n.results.length,hideInfo:m,onClick:async()=>{g&&(u.saveDraftImmediately(),await(0,d.z7)(()=>!u.isDraftSaving)),l||c?(e.selectHistory(null),u.toggleDraft(c)):e.selectHistory(n)}},s)})]})}));vw.displayName="AnnotationHistory";const yw=(e,t=[])=>{(0,f.useEffect)(()=>{const t={capture:e.capture,passive:e.passive},n=e.elementRef.current,i=n=>{if(e.disabled)return;if(n.defaultPrevented)return;const i=null==e.onMouseDown?void 0:e.onMouseDown(n),o=t=>{null==e.onMouseMove||e.onMouseMove(t,i)},s=n=>{document.removeEventListener("mousemove",o,t),document.removeEventListener("mouseup",s),null==e.onMouseUp||e.onMouseUp(n,i)};document.addEventListener("mousemove",o,t),document.addEventListener("mouseup",s)};return null==n||n.addEventListener("mousedown",i),()=>{null==e.onUnmount||e.onUnmount(),null==n||n.removeEventListener("mousedown",i)}},t)},bw=320,xw=300,ww=500,Sw=24,Cw=["top-left","top-right","bottom-left","bottom-right","top","bottom","right","left"],kw=({name:e,mix:t,root:n,title:i,width:o,maxWidth:s,height:a,visible:r,detached:l,alignment:c,expanded:d,top:u,left:h,relativeTop:g,relativeLeft:m,zIndex:p,tooltip:v,locked:y=!1,positioning:b=!1,onSnap:x,onResize:w,onResizeStart:S,onResizeEnd:C,onVisibilityChange:k,onPositionChange:P,onPositionChangeBegin:R,children:j})=>{const N=(0,f.useRef)(),T=(0,f.useRef)(),_=(0,f.useRef)(),A=(0,f.useRef)({onResize:w,onResizeStart:S,onResizeEnd:C,onPositionChange:P,onPositionChangeBegin:R,onVisibilityChange:k,onSnap:x}),[I,M]=(0,f.useState)(),K=(0,f.useCallback)(t=>{t.stopPropagation(),t.preventDefault(),null==k||k(e,!1)},[k]),D=(0,f.useCallback)(()=>{null==k||k(e,!0)},[k]),O=(0,f.useMemo)(()=>{const e=r?{height:l&&null!=a?a:"100%",width:d?"100%":null!=o?o:bw}:{width:l?null!=o?o:bw:"100%",height:l?26:void 0};return Object.assign({},e,{zIndex:p})},[o,a,r,l,d,p]),L=(0,f.useMemo)(()=>l&&!y?{top:`${g}%`,left:`${m}%`}:{},[l,g,m,y]),z=(0,f.useMemo)(()=>({detached:!y&&l,resizing:(0,E.isDefined)(I),hidden:!r,alignment:l?"left":null!=c?c:"left",disabled:y}),[c,r,l,I,y]),B=(0,f.useMemo)(()=>l?r?(0,ae.jsx)(kn.$Mr,{}):(0,ae.jsx)(kn.yIE,{}):"left"===c?r?(0,ae.jsx)(kn.Gk,{}):(0,ae.jsx)(kn.hIg,{}):"right"===c?r?(0,ae.jsx)(kn.hIg,{}):(0,ae.jsx)(kn.Gk,{}):null,[l,r,c]),F=(0,f.useMemo)(()=>`${r?"Collapse":"Expand"} ${v}`,[r,v]);return(0,f.useEffect)(()=>{Object.assign(A.current,{onResize:w,onResizeStart:S,onResizeEnd:C,onPositionChangeBegin:R,onPositionChange:P,onVisibilityChange:k,onSnap:x})},[w,S,C,P,k,R,x]),yw({elementRef:N,disabled:y||!l&&!r,onMouseDown(t){const i=t.target,o="[class*=__toggle]";if(i.matches(o)||i.closest(o))return;const s=l,a=T.current,r=n.current.getBoundingClientRect(),c=a.getBoundingClientRect(),[d,g]=[t.pageX,t.pageY],[m,p]=[c.left-r.left,c.top-r.top];return null==A.current.onPositionChangeBegin||A.current.onPositionChangeBegin(e,u,h,l),{x:d,y:g,oX:m,oY:p,allowDrag:s}},onMouseMove(t,n){if(n){const{x:r,y:l,oX:c,oY:d}=n;let{allowDrag:u}=n;const[h,g]=[t.pageX,t.pageY];if((i=r,o=h,s=l,a=g,Math.sqrt((o-i)**2+(a-s)**2))>30&&(u=!0),!u)return;const[m,p]=[c+(h-r),d+(g-l)];null==A.current.onPositionChange||A.current.onPositionChange(e,p,m,!0)}var i,o,s,a},onMouseUp(){null==A.current.onSnap||A.current.onSnap(e)}},[N,l,r,y]),yw({elementRef:_,disabled:y||b,capture:!0,passive:!0,onMouseDown(e){const t=e.target.dataset.resize,n=(()=>{switch(t){case"top-left":return"top-left";case"top":case"top-right":return"top";case"left":case"bottom-left":return"left"}})(),i={x:null!==(null==t?void 0:t.match(/left|right/i)),y:null!==(null==t?void 0:t.match(/top|bottom/i))};return M(t),null==A.current.onResizeStart||A.current.onResizeStart(),{pos:[e.pageX,e.pageY],type:t,width:o,maxWidth:s,height:a,top:u,left:h,resizeDirections:i,shift:n}},onMouseMove(t,n){if(n){const{pos:i,width:o,height:s,maxWidth:a,top:r,left:l,resizeDirections:c,shift:d}=n,[u,h]=i,g=c.x?t.pageX-u:0,m=c.y?t.pageY-h:0,p=(0,E.isDefined)(d)&&["left","top-left"].includes(d),f=(0,E.isDefined)(d)&&["top","top-left"].includes(d),v=(0,E.clamp)(p?o-g:o+g,bw,a),y=(0,E.clamp)(f?s-m:s+m,xw,r+s),b=f?r+(s-y):r,x=p?l+(o-v):l;A.current.onResize(e,v,y,b,x)}},onMouseUp(){null==A.current.onResizeEnd||A.current.onResizeEnd(),M(void 0)}},[A,l,o,s,a,u,h,r,y,b]),(0,ae.jsxs)("div",{ref:T,className:(0,Nn.cn)("panel").mix(e).mod(z).toClassName(),style:Object.assign({},O,L),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("panel").elem("content").toClassName(),children:[!y&&(0,ae.jsxs)("div",{ref:N,className:(0,Nn.cn)("panel").elem("header").toClassName(),onClick:l?void 0:D,children:[(r||l)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("panel").elem("title").toClassName(),children:i}),(0,ae.jsx)("div",{className:(0,Nn.cn)("panel").elem("toggle").mod({enabled:r}).toClassName(),onClick:l&&!r?D:K,"data-tooltip":F,children:B})]}),r&&(0,ae.jsx)("div",{className:(0,Nn.cn)("panel").elem("body").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)(e).mix(...Array.isArray(t)?t:[t]).toClassName(),children:j})})]}),r&&!b&&!y&&(0,ae.jsx)("div",{className:(0,Nn.cn)("panel").elem("resizers").mod({locked:b||y}).toClassName(),ref:_,children:Cw.map(e=>("left"===e||"right"===e)&&c!==e||l||l?(0,ae.jsx)("div",{className:(0,Nn.cn)("panel").elem("resizer").mod({drag:e===I}).toClassName(),"data-resize":e},e):null)})]})},Pw={container:"container--d7fgb",labelText:"labelText--ZGgO7",input:"input--HLuCD"},Rw=["label","value","onChange","region","min","max"],jw=(0,b.PA)(({region:e})=>{const{start:t,end:n}=e.ranges[0],i=e.object.length;return(0,ae.jsxs)("div",{className:Pw.container,children:[(0,ae.jsx)(Nw,{label:"Start frame",value:t,onChange:t=>{+t!==e.ranges[0].start&&e.setRange([+t,e.ranges[0].end])},region:e,min:1,max:n}),(0,ae.jsx)(Nw,{label:"End frame",value:n,onChange:t=>{+t!==e.ranges[0].end&&e.setRange([e.ranges[0].start,+t])},region:e,min:t,max:i}),(0,ae.jsx)(Nw,{label:"Duration",value:n-t+1,region:e})]})}),Nw=e=>{let{label:t,value:n,onChange:i,min:o,max:s}=e,a=(0,Se.A)(e,Rw);const r=!i,l=e=>{let t=+e.target.value;o&&t<+o&&(e.target.value=o,t=+o),s&&t>+s&&(e.target.value=s,t=+s),null==i||i(t)};return(0,ae.jsxs)("label",{className:Pw.label,children:[(0,ae.jsx)("span",{className:Pw.labelText,children:t}),(0,ae.jsx)("input",Object.assign({className:Pw.input,type:"number",step:1,readOnly:r,onBlur:l,onClick:l,onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur()},[r?"value":"defaultValue"]:n,min:o,max:s},a),n)]})},Tw=["onChange","type","value","step"],_w=e=>{const t=(e=>{if((0,u.fn)(e)){const t=e.getSubTypes();return(0,u.Cb)(t)?t.name:null}return(0,u.Cb)(e)?e.name:null})(e);return"number"===t?"number":"text"},Aw={angle:kn.oDh},Iw=({region:e})=>{var t;const n=null!=(t=e.editableFields)?t:[];return(0,ae.jsx)("div",{className:(0,Nn.cn)("region-editor").elem("wrapper").toClassName(),children:e.editorEnabled&&n.map((t,n)=>(0,ae.jsx)(Ew,{property:t.property,label:t.label,region:e},`${t.property}-${n}`))})},Mw=(0,b.PA)(({region:e})=>{var t;return(0,ae.jsx)("div",{className:(0,Nn.cn)("region-editor").elem("wrapper-time-control").toClassName(),children:(0,ae.jsx)(bi,{startTime:e.start,endTime:e.end,minTime:0,maxTime:null==e||null==(t=e._ws_region)?void 0:t.duration,isSidepanel:!0,onChangeStartTime:t=>{e.setProperty("start",t)},onChangeEndTime:t=>{e.setProperty("end",t)},showLabels:!0,showDuration:!0})})}),Ew=({property:e,label:t,region:n})=>{const[i,o]=(0,f.useState)(n.getProperty(e)),s=(0,f.useMemo)(()=>n.getPropertyType(e),[n,e]),a=(0,f.useMemo)(()=>(0,u.Cb)(s),[s]),r=(0,f.useMemo)(()=>{if(a)return null;let e=null;if((0,u.CK)(s)){const t=(0,u.fn)(s)?s.getSubTypes().getSubTypes():s.getSubTypes();e=t.some(e=>(0,u.aw)(e)||(0,u.Cb)(e))?t.map(e=>e.value):null}return e},[s,a]),l=(0,f.useMemo)(()=>{if(!a)return!1;return((0,u.fn)(s)?s.getSubTypes():s)===u.gK.boolean},[s,a]),c=(0,f.useMemo)(()=>{if(!a)return!1;const e=(0,u.fn)(s)?s.getSubTypes():s;return e===u.gK.string||e[0]===u.gK.string},[s,a]),h=(0,f.useCallback)(t=>{if(t!==n.getProperty(e))try{n.setProperty(e,t)}catch(e){console.error(e)}},[s,l]);return(0,f.useEffect)(()=>{const t=(0,d.lB)(n,e,({newValue:e,oldValue:t})=>{t.storedValue!==e.storedValue&&o(e.storedValue)});return()=>t()},[n]),(0,ae.jsxs)("label",{className:(0,Nn.cn)("region-editor").elem("property").mod({text:c}).toClassName(),children:[l?(0,ae.jsx)(Pn.Sc0,{className:(0,Nn.cn)("region-editor").elem("input").toClassName(),checked:i,onChange:e=>h(e.target.checked)}):c?(0,ae.jsx)(Kw,{type:"text",value:i,onChange:e=>h(e)}):a?(0,ae.jsx)(Kw,{type:_w(s),step:"0.01",value:i,onChange:e=>h(Number(e))}):r?(0,ae.jsx)(Pn.l6P,{value:i,onChange:e=>h(e),triggerClassName:(0,Nn.cn)("region-editor").elem("select").toClassName(),options:r}):null,(0,ae.jsx)(Dw,{label:t})]})},Kw=e=>{let{onChange:t,type:n,value:i,step:o}=e,s=(0,Se.A)(e,Tw);const[a,r]=(0,f.useState)(i),l=(0,f.useCallback)((e,n=!0)=>{const i=e;r(i),n&&(null==t||t(i))},[t,n]),c=(0,f.useCallback)(e=>{let t=e.target.value,i=!0;"number"===n&&(t.match(/^([0-9,.]+)$/gi)||(i=!1),t.match(/(,|\.)$/)&&(t=t.replace(/,/,"."),i=!1),i&&(t=Number.parseFloat(t))),l(t,i)},[l,n]),d=(0,f.useCallback)(e=>{if("number"===n&&("ArrowUp"===e.key||"ArrowDown"===e.key)){e.preventDefault();const t=e.altKey&&e.shiftKey?.01:e.shiftKey?10:e.altKey?.1:1;let n=Number(a);"ArrowUp"===e.key?n+=t:n-=t,l(n)}},[a,n,o]);(0,f.useEffect)(()=>{l(i)},[i]);const u="text"===n?"textarea":"input";return(0,ae.jsx)(u,Object.assign({},s,{className:(0,Nn.cn)("region-editor").elem("input").toClassName(),type:"text",step:o,onChange:c,onKeyDown:d,value:a,rows:"text"===n?3:void 0}))},Dw=({label:e})=>{const t=(0,f.useMemo)(()=>{if(e.startsWith("icon:")){var t;const n=e.split(":")[1];return null!=(t=Aw[n])?t:null}return null},[e]);return(0,ae.jsx)("span",{className:(0,Nn.cn)("region-editor").elem("text").toClassName(),children:t?(0,ae.jsx)(t,{}):e})},Ow=(0,b.PA)(({region:e})=>{const t="audioregion"===e.type,n="timelineregion"===e.type?jw:t?Mw:Iw;return(0,ae.jsx)("div",{className:(0,Nn.cn)("region-editor").mod({disabled:e.isReadOnly()}).toClassName(),children:(0,ae.jsx)(n,{region:e})})}),Lw=(0,b.PA)(({mainValue:e})=>(0,ae.jsx)("div",{className:"flex flex-col items-start gap-tighter",children:e.map((e,t)=>(0,ae.jsx)("mark",{className:"bg-primary-background px-tighter py-tightest rounded-sm text-neutral-content",children:(0,ae.jsx)(Pn.o5u,{"data-counter":t+1,size:"small",className:"!m-0",children:e})},`${e}-${t}`))})),zw=(0,b.PA)(({mainValue:e})=>(0,ae.jsx)("mark",{className:"bg-primary-background px-tighter py-tightest rounded-sm",children:(0,ae.jsx)(Pn.o5u,{as:"span",size:"small",className:"text-neutral-content",children:e.join(", ")})})),Bw=(0,b.PA)(({mainValue:e})=>(0,ae.jsx)("span",{children:e})),Fw=(0,b.PA)(({mainValue:e})=>(0,ae.jsx)(Pn.p2L,{data:e,showSearch:!1,showFilters:!1,showCopyButton:!1,minHeight:100,maxHeight:300})),Hw=(0,b.PA)(({result:e})=>{const{type:t,mainValue:n}=e,i=(0,f.useMemo)(()=>"rating"===t?(0,ae.jsxs)("div",{className:(0,Nn.cn)("region-meta").elem("result").toClassName(),children:[(0,ae.jsx)(Pn.o5u,{size:"small",children:"Rating: "}),(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("value").toClassName(),children:(0,ae.jsx)(Bw,{mainValue:n})})]}):"textarea"===t?(0,ae.jsxs)("div",{className:(0,Nn.cn)("region-meta").elem("result").toClassName(),children:[(0,ae.jsx)(Pn.o5u,{size:"small",children:"Text: "}),(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("value").toClassName(),children:(0,ae.jsx)(Lw,{mainValue:n})})]}):"choices"===t?(0,ae.jsxs)("div",{className:(0,Nn.cn)("region-meta").elem("result").toClassName(),children:[(0,ae.jsx)(Pn.o5u,{size:"small",children:"Choices: "}),(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("value").toClassName(),children:(0,ae.jsx)(zw,{mainValue:n})})]}):"taxonomy"===t?(0,ae.jsxs)("div",{className:(0,Nn.cn)("region-meta").elem("result").toClassName(),children:[(0,ae.jsx)(Pn.o5u,{size:"small",children:"Taxonomy: "}),(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("value").toClassName(),children:(0,ae.jsx)(zw,{mainValue:n.map(e=>e.join("/"))})})]}):"reactcode"===t?(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("result").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("value").toClassName(),children:(0,ae.jsx)(Fw,{mainValue:n})})}):void 0,[t,n]);return i?(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").toClassName(),children:i}):null}),Vw=(0,b.PA)(({region:e})=>(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("detailed-region").elem("result").toClassName(),children:[(null==e?void 0:e.results).filter(e=>e.canBeSubmitted).map(e=>(0,ae.jsx)(Hw,{result:e},e.pid)),null==e||!e.text||null!=e&&e.ocrtext?null:(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("item").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("region-meta").elem("content").mod({type:"text"}).toClassName(),children:e.text.replace(/\\n/g,"\n")})})})]}),(0,ae.jsx)(Ow,{region:e})]})),$w=(0,b.PA)(({region:e,editMode:t,cancelEditMode:n,enterEditMode:i})=>{var o,s;const a=(0,f.useRef)(),r=t=>{e.setMetaText(t)};return(0,f.useEffect)(()=>{if(t&&a.current){const{current:e}=a;e.focus(),e.setSelectionRange(e.value.length,e.value.length)}},[t]),(0,ae.jsx)(ae.Fragment,{children:t?(0,ae.jsx)("textarea",{ref:e=>a.current=e,placeholder:"Meta",className:(0,Nn.cn)("detailed-region").elem("meta-text").toClassName(),value:e.meta.text,onChange:e=>r(e.target.value),onBlur:e=>{r(e.target.value),null==n||n()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),r(e.target.value),null==n||n())}}):(null==(o=e.meta)?void 0:o.text)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("detailed-region").elem("meta-text").toClassName(),onClick:()=>null==i?void 0:i(),children:null==(s=e.meta)?void 0:s.text})})}),Ww=["children","onClick","variant","look","tooltip","hotkey"],Uw=(0,f.forwardRef)((e,t)=>{var n;let{children:i,onClick:o,variant:s,look:a,tooltip:r,hotkey:l}=e,c=(0,Se.A)(e,Ww);return(0,ae.jsx)($n,{binging:l,children:(0,ae.jsx)(Pn.$nd,Object.assign({},c,{ref:t,onClick:e=>{e.stopPropagation(),null==o||o(e)},variant:s,look:a,size:"smaller",style:Object.assign({},null!=(n=c.style)?n:{}),"aria-label":"string"==typeof i?i:"Region control",tooltip:r,children:i}))})}),Gw=(0,b.PA)(({item:e,annotation:t,hovered:n,locked:i,hotkey:o,variant:s,displayedHotkey:a,look:r,ariaLabel:l,tooltip:c,style:d,onClick:u})=>{if(!e)return null;const h=i||e.isReadOnly()||t.isReadOnly(),g=e.isReadOnly()&&!i;if((0,Ne.VS)(Ne.bA)){const t=Object.assign({},d,{display:e.isReadOnly()||i?void 0:"none"});return(0,ae.jsx)(Uw,{disabled:g,onClick:u,hotkey:o,variant:s,look:r,style:t,"aria-label":l,tooltip:c,children:h?(0,ae.jsx)(kn.xIO,{}):(0,ae.jsx)(kn.O7E,{})})}return(0,ae.jsx)(Uw,{disabled:g,onClick:u,displayedHotkey:a,hotkey:o,variant:s,look:r,style:d,"aria-label":l,tooltip:c,children:h?(0,ae.jsx)(kn.xIO,{}):(0,ae.jsx)(kn.O7E,{})})}),Yw=(0,b.PA)(({region:e})=>{const t=e.labelings.map(e=>e.selectedLabels||[]),n=[].concat(...t);return n.length?(0,ae.jsx)("div",{className:(0,Nn.cn)("labels-list").toClassName(),children:n.map((e,t)=>{const n=e.background||"#000000";return[t?", ":null,(0,ae.jsx)("span",{style:{color:n},children:e.value},e.id)]})}):(0,ae.jsx)("div",{className:(0,Nn.cn)("labels-list").toClassName(),children:e.noLabelView||"No label"})}),Xw=["children"],qw=(0,b.PA)(({region:e,compact:t=!1,withActions:n=!0,withIds:i=!0,mainDetails:o,metaDetails:s})=>{var a,r;const{annotation:l}=e,{selectedRegions:c}=l,[d,u]=(0,f.useState)(!1),h=(0,f.useMemo)(()=>!!c.find(e=>!e.isReadOnly()&&!e.classification),[c]),g=(0,f.useMemo)(()=>{var t,n;const i=null!=(t=null!=(n=e.background)?n:e.getOneColor())?t:"#666";return(0,ft.A)(i).alpha(1)},[e.background,e.style]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("detailed-region").mod({compact:t}).toClassName(),"data-testid":"detailed-region",children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("detailed-region").elem("head").toClassName(),style:{color:g.css()},children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("detailed-region").elem("title").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("detailed-region").elem("icon").toClassName(),children:(0,ae.jsx)(uc,{node:e})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("detailed-region").elem("index").toClassName(),children:(0,ae.jsx)("span",{className:(0,Nn.cn)("detailed-region").elem("index_value").toClassName(),children:e.region_index})}),(0,ae.jsx)(Yw,{region:e})]}),i&&(0,ae.jsx)("span",{children:e.cleanId})]}),o&&(0,ae.jsx)("div",{className:(0,Nn.cn)("detailed-region").elem("content").toClassName(),children:(0,ae.jsx)(o,{region:e})}),e.isDrawing&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("detailed-region").elem("warning").toClassName(),children:[(0,ae.jsx)(kn.iQw,{}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("detailed-region").elem("warning-text").toClassName(),children:["Incomplete ",null!=(a=null==(r=e.type)?void 0:r.replace("region",""))?a:"region"]})]}),n&&(0,ae.jsx)(Zw,{region:e,editMode:d,annotation:l,hasEditableRegions:h,onEditModeChange:u}),s&&(0,ae.jsx)("div",{className:(0,Nn.cn)("detailed-region").elem("content").toClassName(),children:(0,ae.jsx)(s,{region:e,editMode:d,enterEditMode:()=>u(!0),cancelEditMode:()=>u(!1)})})]})}),Zw=(0,b.PA)(({region:e,annotation:t,editMode:n,onEditModeChange:i})=>{const o=[];return o.push((0,ae.jsx)($n,{binging:"region:relation",children:(0,ae.jsx)(Jw,{variant:t.isLinkingMode?"primary":"neutral",look:t.isLinkingMode?"filled":"string",onClick:(n,i)=>{i||(t.isLinkingMode?t.stopLinkingMode():t.startLinkingMode(P,e))},"aria-label":"Create Relation",children:(0,ae.jsx)(kn.ioK,{})},"relation")})),o.push((0,ae.jsx)($n,{binging:"region:meta",children:(0,ae.jsx)(Jw,{look:n?"filled":"string",variant:n?"primary":"neutral",onClick:()=>i(!n),"aria-label":"Edit region's meta",children:(0,ae.jsx)(kn.uID,{})},"meta")})),(0,ae.jsxs)("div",{className:(0,Nn.cn)("region-actions").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("region-actions").elem("group").mod({align:"left"}).toClassName(),children:!e.isReadOnly()&&o}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("region-actions").elem("group").mod({align:"right"}).toClassName(),children:[(0,ae.jsx)(Gw,{item:e,annotation:null==e?void 0:e.annotation,hovered:!0,locked:null==e?void 0:e.locked,onClick:()=>e.setLocked(!e.locked),displayedHotkey:"region:lock",variant:"neutral",look:"string","aria-label":"Unlock Region",tooltip:"Unlock Region"}),e.hideable&&(0,ae.jsx)(Jw,{"aria-label":(e.hidden?"Show":"Hide")+" selected region",variant:"neutral",look:"string",onClick:e.toggleHidden,tooltip:(e.hidden?"Show":"Hide")+" selected region",children:e.hidden?(0,ae.jsx)(kn.r9M,{}):(0,ae.jsx)(kn.C_F,{})}),(0,ae.jsx)(Jw,{variant:"negative",look:"string","aria-label":"Delete selected region",disabled:e.isReadOnly(),tooltip:"Delete selected region",onClick:()=>t.deleteRegion(e),children:(0,ae.jsx)(kn.Eau,{})})]})]})}),Jw=(0,f.forwardRef)((e,t)=>{let{children:n}=e,i=(0,Se.A)(e,Xw);return(0,ae.jsx)(Pn.$nd,Object.assign({ref:t,variant:"neutral",look:"string",size:"small"},i,{children:n}))}),Qw=(0,b.PA)(({relations:e})=>(0,ae.jsx)(ae.Fragment,{children:e.map(e=>(0,ae.jsx)(eS,{relation:e},e.id))})),eS=(0,b.PA)(({relation:e})=>{const[t,n]=(0,f.useState)(!1),i=(0,f.useCallback)(()=>{e.node1&&e.node2&&(n(!0),e.toggleHighlight(),e.setSelfHighlight(!0))},[]),o=(0,f.useCallback)(()=>{e.node1&&e.node2&&(n(!1),e.toggleHighlight(),e.setSelfHighlight(!1))},[]),s=(0,f.useMemo)(()=>{const{direction:t}=e;switch(t){case"left":return(0,ae.jsx)(kn.pyZ,{"data-direction":e.direction});case"right":return(0,ae.jsx)(kn.WVI,{"data-direction":e.direction});case"bi":return(0,ae.jsx)(kn.dOr,{"data-direction":e.direction});default:return null}},[e.direction]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("relations").elem("item").mod({hidden:!e.visible}).toClassName(),onMouseEnter:i,onMouseLeave:o,children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("relations").elem("content").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("icon").toClassName(),onClick:e.rotateDirection,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("direction").toClassName(),children:s})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("relations").elem("nodes").toClassName(),children:[(0,ae.jsx)(qw,{compact:!0,withActions:!1,withIds:!1,region:e.node1}),(0,ae.jsx)(qw,{compact:!0,withActions:!1,withIds:!1,region:e.node2})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("relations").elem("actions").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("action").toClassName(),children:(t||e.showMeta)&&e.hasRelations&&(0,ae.jsx)(Pn.$nd,{primary:e.showMeta,"aria-label":(e.showMeta?"Hide":"Show")+" Relation Labels",type:e.showMeta?void 0:"text",onClick:e.toggleMeta,style:{padding:0},children:(0,ae.jsx)(kn.dd8,{})})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("action").toClassName(),children:(t||!e.visible)&&(0,ae.jsx)(Pn.$nd,{variant:"neutral",look:"string",size:"small",tooltip:"Toggle Visibility",onClick:e.toggleVisibility,"aria-label":(e.visible?"Hide":"Show")+" Relation",children:e.visible?(0,ae.jsx)(kn.C_F,{style:{width:20,height:20}}):(0,ae.jsx)(kn.r9M,{style:{width:20,height:20}})})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("action").toClassName(),children:t&&(0,ae.jsx)(Pn.$nd,{variant:"negative",look:"string",size:"small","aria-label":"Delete Relation",tooltip:"Delete Relation",onClick:()=>{e.node1.setHighlight(!1),e.node2.setHighlight(!1),e.parent.deleteRelation(e)},children:(0,ae.jsx)(kn.Eau,{})})})]})]}),e.showMeta&&(0,ae.jsx)(tS,{relation:e})]})}),tS=(0,b.PA)(({relation:e})=>{const{selectedValues:t,control:n}=e,{children:i,choice:o}=n,s=(0,f.useMemo)(()=>"multiple"===o,[o]),a=(0,f.useCallback)(t=>{const n=(0,E.wrapArray)(t);e.setRelations(n)},[e]),r=(0,f.useMemo)(()=>i.map(e=>({value:e.value,style:{background:e.background}})),[i]);return(0,ae.jsx)("div",{className:(0,Nn.cn)("relation-meta").toClassName(),children:(0,ae.jsx)(Pn.l6P,{multiple:s,style:{width:"100%"},placeholder:"Select labels",value:t,onChange:a,options:r})})}),nS=(0,b.PA)(({relationStore:e})=>{const t=e.orderedRelations;return(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").toClassName(),children:(0,ae.jsx)(Qw,{relations:t})})}),iS=(0,b.PA)(({relationStore:e})=>{var t;const n=(0,f.useCallback)(t=>{t.preventDefault(),t.stopPropagation(),e.toggleAllVisibility()},[e]),i=!(null!=e&&null!=(t=e.relations)&&t.length),o=!(!i&&e.isAllHidden);return(0,ae.jsx)(Pn.$nd,{className:(0,Nn.cn)("relation-controls").mod({hidden:o}).toClassName(),variant:"neutral",look:"string",size:"small",disabled:i,onClick:n,"aria-label":o?"Show all":"Hide all",icon:o?(0,ae.jsx)(kn.liT,{width:16,height:16}):(0,ae.jsx)(kn.CuU,{width:16,height:16}),tooltip:o?"Show all":"Hide all",tooltipTheme:"dark"})}),oS=(0,b.PA)(({relationStore:e})=>{var t;const n=(0,f.useCallback)(t=>{t.preventDefault(),t.stopPropagation(),e.toggleOrder()},[e]),i=!(null!=e&&null!=(t=e.relations)&&t.length),o="asc"===e.order;return(0,ae.jsx)(Pn.$nd,{className:(0,Nn.cn)("relation-controls").mod({order:e.order}).toClassName(),variant:"neutral",look:"string",size:"small",onClick:n,disabled:i,"aria-label":o?"Order by oldest":"Order by newest",icon:o?(0,ae.jsx)(kn.n5,{}):(0,ae.jsx)(kn.WCw,{}),tooltip:o?"Order by oldest":"Order by newest",tooltipTheme:"dark"})}),sS=(0,b.PA)(({relationStore:e})=>(0,ae.jsxs)("div",{className:(0,Nn.cn)("relation-controls").toClassName(),children:[(0,ae.jsx)(iS,{relationStore:e}),(0,ae.jsx)(oS,{relationStore:e})]}));var aS=n(83499);const rS=["currentEntity","regions"],lS=(0,b.PA)(function({selection:e,currentEntity:t}){return(0,ae.jsx)(ae.Fragment,{children:e.size?(0,ae.jsx)(mS,{regions:e}):(0,ae.jsx)(gS,{currentEntity:t})})}),cS=(0,b.WQ)("store")((0,b.PA)(function({store:e}){return(0,ae.jsx)(ae.Fragment,{children:e.hasInterface("annotations:comments")&&e.commentStore.isCommentable&&(0,ae.jsx)("div",{className:(0,Nn.cn)("comments-panel").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("comments-panel").elem("section-tab").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("comments-panel").elem("section-content").toClassName(),children:(0,ae.jsx)(dw,{annotationStore:e.annotationStore,commentStore:e.commentStore,cacheKey:`task.${e.task.id}`})})})})})})),dS=(0,b.WQ)("store")((0,b.PA)(function({currentEntity:e}){const{relationStore:t}=e,n=t.size>0;return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("section-tab").toClassName(),children:n?(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("relations").elem("view-control").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("relations").elem("section-head").toClassName(),children:["Relations (",t.size,")"]}),(0,ae.jsx)(sS,{relationStore:t})]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("relations").elem("section-content").toClassName(),children:(0,ae.jsx)(nS,{relationStore:t})})]}):(0,ae.jsx)(uw,{icon:(0,ae.jsx)(kn.ioK,{width:24,height:24}),header:"Create relations between regions",description:(0,ae.jsx)(ae.Fragment,{children:"Link regions to define relationships between them"}),learnMore:{href:(0,aS.T)("guide/labeling#Add-relations-between-annotations"),text:"Learn more",testId:"relations-panel-learn-more"}})})})})})),uS=(0,b.WQ)("store")((0,b.PA)(function({store:e,currentEntity:t}){var n;const i=e.hasInterface("annotations:history");return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)("div",{className:(0,Nn.cn)("history").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("history").elem("section-tab").toClassName(),children:(0,ae.jsx)(vw,{inline:!0,enabled:i,sectionHeader:(0,ae.jsxs)(ae.Fragment,{children:["Annotation History",(0,ae.jsxs)("span",{children:["#",null!=(n=t.pk)?n:t.id]})]})})})})})})),hS=(0,b.WQ)("store")((0,b.PA)(function({selection:e}){const t=!e||0===e.size;return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)("div",{className:(0,Nn.cn)("info").toClassName(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("info").elem("section-tab").toClassName(),children:t?(0,ae.jsx)(uw,{icon:(0,ae.jsx)(kn.ECq,{width:24,height:24}),header:"View region details",description:(0,ae.jsx)(ae.Fragment,{children:"Select a region to view its properties, metadata and available actions"})}):(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)(mS,{regions:e})})})})})})),gS=(0,b.WQ)("store")((0,b.PA)(function({store:e,currentEntity:t}){var n;const{relationStore:i}=t,o=e.hasInterface("annotations:history");return(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("details").elem("section").toClassName(),children:(0,ae.jsx)(vw,{inline:!0,enabled:o,sectionHeader:(0,ae.jsxs)(ae.Fragment,{children:["Annotation History",(0,ae.jsxs)("span",{children:["#",null!=(n=t.pk)?n:t.id]})]})})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("details").elem("section").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("details").elem("view-control").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("details").elem("section-head").toClassName(),children:["Relations (",i.size,")"]}),(0,ae.jsx)(sS,{relationStore:i})]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("details").elem("section-content").toClassName(),children:(0,ae.jsx)(nS,{relationStore:i})})]}),e.hasInterface("annotations:comments")&&e.commentStore.isCommentable&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("details").elem("section").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("details").elem("section-head").toClassName(),children:"Comments"}),(0,ae.jsx)("div",{className:(0,Nn.cn)("details").elem("section-content").toClassName(),children:(0,ae.jsx)(dw,{annotationStore:e.annotationStore,commentStore:e.commentStore,cacheKey:`task.${e.task.id}`})})]})]})}));gS.displayName="GeneralPanel";const mS=(0,b.PA)(function({regions:e}){return(0,ae.jsx)("div",{children:e.list.map(e=>(0,ae.jsx)(pS,{region:e},e.id))})}),pS=(0,b.PA)(function({region:e}){return(0,ae.jsx)(qw,{region:e,mainDetails:Vw,metaDetails:$w})}),fS=cS,vS=uS,yS=dS,bS=hS,xS=function(){return(0,ae.jsx)("div",{className:(0,Nn.cn)("custom").toClassName(),children:(0,ae.jsx)("div",{id:"react-code-sidebar-portal",className:(0,Nn.cn)("custom").elem("section-tab").toClassName()})})},wS=((0,b.PA)(({currentEntity:e,regions:t})=>{const n=t.selection;return(0,ae.jsx)("div",{className:(0,Nn.cn)("details-tab").toClassName(),children:(0,ae.jsx)(lS,{selection:n,currentEntity:e})})}),(0,b.PA)(e=>{let{currentEntity:t,regions:n}=e,i=(0,Se.A)(e,rS);const o=n.selection;return(0,ae.jsx)(kw,Object.assign({},i,{currentEntity:t,name:"details",title:"Details",children:(0,ae.jsx)(lS,{selection:o,currentEntity:t})}))}));var SS=n(99305);const CS={menu:"menu--T1p4B",seperator:"seperator--KYwdN",icon:"icon--lm29f",option:"option--uu8tw",danger:"danger--_ukYc",trigger:"trigger--eUuJT",open:"open--fDDq9"},kS=({actions:e,className:t})=>{const n=(0,Pn.BKH)();return(0,ae.jsx)("div",{className:(0,_g.A)(CS.contextMenu,t),children:e.map((e,t)=>{var i;return!1!==e.enabled&&(0,ae.jsxs)(f.Fragment,{children:[e.separator&&(0,ae.jsx)("div",{className:CS.seperator}),(0,ae.jsxs)("div",{className:(0,_g.A)(CS.option,e.danger&&CS.danger),onClick:t=>e.onClick(t,{dropdown:n}),children:[e.icon&&(0,ae.jsx)("span",{className:(0,_g.A)(CS.icon,e.iconClassName),children:e.icon}),e.label]})]},null!=(i=e.key)?i:t)})})},PS=({children:e,content:t,onToggle:n,className:i})=>{const[o,s]=(0,f.useState)(!1);return(0,ae.jsx)("div",{className:(0,_g.A)(CS.trigger,o&&CS.open,i),onClick:e=>e.stopPropagation(),children:(0,ae.jsx)(Pn.msM.Trigger,{content:t||void 0,onToggle:e=>{s(e),null==n||n(e)},children:e||(0,ae.jsx)(kn.ViA,{width:28,height:28})})})},RS=(0,b.PA)(({item:e})=>{const[t,n]=(0,f.useState)(!1),i=(0,f.useMemo)(()=>{const t=new URL(window.location.href);return e.annotation.pk&&t.searchParams.set("annotation",e.annotation.pk),e.id&&t.searchParams.set("region",e.id.split("#")[0]),t.toString()},[e]),[o]=(0,He.sc)({defaultText:i}),s=(0,Pn.djX)(),a=(0,f.useCallback)((e,t)=>{var n;o(),null==(n=t.dropdown)||n.close(),s.show({message:"Region link copied to clipboard",type:Pn.CkR.info})},[o]),r=(0,f.useMemo)(()=>[{label:"Copy Region Link",onClick:a,icon:(0,ae.jsx)(kn.AXG,{})}],[a]);return(0,ae.jsx)(PS,{className:(0,Nn.cn)("region-context-menu").mod({open:t}).toClassName(),content:(0,ae.jsx)(kS,{actions:r}),onToggle:e=>n(e),children:(0,ae.jsx)(Pn.$nd,{variant:"neutral",look:"string",size:"smaller","aria-label":"Region options",children:(0,ae.jsx)(kn.dbp,{})})})}),jS=["item","label","isArea"],{localStorage:NS}=window,TS="collapsed-label-pos",_S=(0,f.createContext)({regions:null}),AS=({entity:e})=>(0,ae.jsx)(OS,{node:e}),IS=({isLeaf:e})=>(0,ae.jsx)(DS,{isLeaf:e}),MS=(0,b.PA)(({regions:e,regionsTree:t})=>{const n=(0,f.useRef)(),[i,o]=(0,f.useState)(0);let s=(0,f.useMemo)(()=>{let e=0;return new _(t=>{requestAnimationFrame(()=>{var i,s,a;null!=t&&null!=(i=t[0])&&i.contentRect&&(null==t||null==(s=t[0])||null==(s=s.contentRect)?void 0:s.height)!==e&&(e=(null==t||null==(a=t[0])||null==(a=a.contentRect)?void 0:a.height)||1,n.current&&o(e))})})},[]);(0,f.useEffect)(()=>()=>{var e;null==(e=s)||e.disconnect(),s=null},[]);const a=(0,f.useCallback)(e=>{var t;if(e)null==(t=s)||t.observe(e);else if(n.current){var i;null==(i=s)||i.unobserve(n.current)}n.current=e,o((null==e?void 0:e.clientHeight)||1)},[]),r=KS(),l=e.selection.keys,c=(0,Nn.cn)("tree");let d,u;const h=(0,Ne.VS)(Ne.TU)&&"label"===e.group;if((0,Ne.VS)(Ne.TU)){var g,m,p;const[e,n]=(0,f.useState)(null!=(g=null==(m=NS.getItem(TS))||null==m.split||null==(m=m.split(","))?void 0:m.filter(e=>!!e))?g:[]),i=e=>{NS.setItem(TS,e.join(","))},o=t=>{const o=[...e,t];n(o),i(o)},s=t=>{const o=e.filter(e=>e!==t);n(o),i(o)};d=null!=(p=t.filter(t=>!e.includes(t.pos)).map(e=>e.key))?p:[],u=(n,{node:i})=>{const a=t.find(e=>e.key===i.key);if(!a)return;const r=a.pos;e.includes(r)?s(r):o(r)}}return(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-tree").toClassName(),ref:a,children:!!i&&(0,ae.jsx)(SS.Ay,Object.assign({draggable:"manual"===e.group,multiple:!0,defaultExpandAll:!0,defaultExpandParent:!h,autoExpandParent:!0,checkable:!1,prefixCls:c.toClassName(),className:c.toClassName(),treeData:t,selectedKeys:l,icon:AS,switcherIcon:IS,virtual:!0,itemHeight:34,height:i},r,h?{expandedKeys:d,onExpand:u}:{}),e.group)})}),ES=({regions:e,rootClass:t,footer:n})=>{const i=(0,f.useCallback)((e,n,i,o,s)=>{var a;const{id:r,type:l,hidden:c,isDrawing:d,locked:u,incomplete:h}=null!=e?e:{},g=null!=(a=null==e?void 0:e.background)?a:null==e||null==e.getOneColor?void 0:e.getOneColor(),m=(0,ft.A)(null!=g?g:"#666").alpha(1),p={hidden:c,type:l,isDrawing:d||h};return{idx:n,key:r,type:l,label:(0,ae.jsx)(Qx,{item:e}),hidden:c,entity:e,color:m.css(),style:{"--icon-color":m.css(),"--text-color":m.css(),"--selection-color":m.alpha(.1).css()},className:t.elem("node").mod(p).toClassName(),title:e=>(0,ae.jsx)(LS,Object.assign({},e)),locked:u}},[]),o=e.getRegionsTree(i);return n&&o.push({key:"__footer__",disabled:!0,className:t.elem("node").mod({type:"footer"}).toClassName(),title:n}),o},KS=()=>{const e=(0,f.useCallback)((e,t)=>{const n=t.nativeEvent.ctrlKey||(0,E.isMacOS)()&&t.nativeEvent.metaKey,{node:i}=t,o=null==i?void 0:i.item;if(null==o||!o.annotation)return;const s=o.annotation;if(n)return void s.toggleRegionSelection(o);if(!o.isReadOnly()&&s.isLinkingMode)return s.addLinkedRegion(o),s.stopLinkingMode(),void s.regionStore.unselectAll();const a=!o.selected;a?(s.selectArea(o),null==o.onSelectInOutliner||o.onSelectInOutliner(a)):s.unselectAll()},[]),t=(0,f.useRef)(),n=(0,f.useCallback)(({node:e})=>{var n,i;t.current&&(null==(i=t.current)||i.setHighlight(!1));null==(n=e.item)||n.setHighlight(!0),t.current=e.item},[]),i=(0,f.useCallback)(({node:e})=>{var n,i;(null==e||null==(n=e.item)||n.setHighlight(!1),t.current!==(null==e?void 0:e.item))&&(null==(i=t.current)||i.setHighlight(!1));t.current=void 0},[]),o=i,s=(0,f.useCallback)(e=>{if(!e)return 0;const t=e.item.annotation.regionStore.filterByParentID(e.pid).map(e=>s(e));return t.length?1+Math.max(...t):0},[]);return{onSelect:e,onMouseEnter:n,onMouseLeave:i,onDrop:(0,f.useCallback)(({node:e,dragNode:t,dropPosition:n,dropToGap:i})=>{if(e.classification)return!1;const o=e.props.eventKey,a=t.props.eventKey,r=e.props.pos.split("-"),l=e.item.annotation.regionStore;n-=Number.parseInt(r[r.length-1]);const c=r.length,d=l.findRegionID(a),u=l.findRegionID(o);if(l.unhighlightAll(),2===c&&i&&-1===n)d.setParentID("");else if(-1!==n){var h,g;const e=((null==(h=u.labeling)?void 0:h.selectedLabels)||[]).filter(e=>e.groupcancontain);if(e.length){const t=d.labeling.selectedLabels,n=(0,E.flatten)(e.map(e=>e.groupcancontain.split(","))),i=(0,E.flatten)(t.map(e=>e.alias?[e.alias,e.value]:[e.value]));if(0===n.filter(e=>-1!==i.indexOf(e)).length)return}if(null!=(g=u.labeling)&&null!=(g=g.from_name)&&g.groupdepth){let e=Number(u.labeling.from_name.groupdepth);if(e>=0){e-=s(d);let t=u;for(;t;)t=l.findRegion(t.parentID),e-=1;if(e<0)return}}d.setParentID(u.id)}},[]),onScroll:o}},DS=(0,b.PA)(({isLeaf:e})=>e?null:(0,ae.jsx)(kn.Pl9,{})),OS=(0,b.PA)(({node:e})=>e?(0,ae.jsx)(uc,{node:e}):null),LS=(0,b.PA)(e=>{var t,n;let{item:i,label:o,isArea:s}=e,a=(0,Se.A)(e,jS);null==i||i.highlighted;const[r,l]=(0,f.useState)(!1),c=(0,f.useMemo)(()=>{var e;return s&&null!=(e=i.perRegionDescControls)?e:[]},[null==i?void 0:i.perRegionDescControls,s]),d=(0,f.useMemo)(()=>c.length>0,[c.length]),u=(0,f.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),l(!r)},[r]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner-item").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner-item").elem("content").toClassName(),children:[!a.isGroup&&(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("index").toClassName(),children:a.idx+1}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner-item").elem("title").toClassName(),children:[o,(null==i?void 0:i.text)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("text").toClassName(),children:i.text.replace(/\\n/g,"\n")}),((null==i?void 0:i.isDrawing)||(null==i?void 0:i.incomplete))&&(0,ae.jsx)("span",{className:(0,Nn.cn)("outliner-item").elem("incomplete").toClassName(),children:(0,ae.jsx)(Pn.m_M,{title:`Incomplete ${null!=(t=null==(n=i.type)?void 0:n.replace("region",""))?t:"region"}`,children:(0,ae.jsx)(kn.iQw,{})})})]}),!1!==(null==i?void 0:i.hideable)&&(0,ae.jsx)(BS,{item:i,entity:a.entity,regions:a.children,type:a.type,collapsed:r,hasControls:d&&s,toggleCollapsed:u})]}),!r&&d&&s&&(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("ocr").toClassName(),children:(0,ae.jsx)(FS,{item:i,controls:c,collapsed:r,setCollapsed:l,selected:a.selected})})]})}),zS=(0,b.WQ)(({store:e})=>({store:e})),BS=zS((0,b.PA)(({hovered:e,item:t,entity:n,collapsed:i,regions:o,hasControls:s,type:a,toggleCollapsed:r,store:l})=>{var c;const{regions:d}=(0,f.useContext)(_S),u=(0,f.useMemo)(()=>null!=a&&a.includes("region")||null!=a&&a.includes("range")?n.hidden:!(!(!a||a.includes("label")||null!=a&&a.includes("tool"))||!o)&&Object.values(o).every(({hidden:e})=>e),[n,a,o]),h=(0,f.useCallback)(()=>{null!=a&&a.includes("region")||null!=a&&a.includes("range")?n.toggleHidden():!a||a.includes("label")?d.setHiddenByLabel(!u,n):null!=a&&a.includes("tool")&&d.setHiddenByTool(!u,n)},[t,null==t?void 0:t.toggleHidden,u]),g=(0,f.useCallback)(e=>{r(e)},[r]),m=(0,f.useCallback)(()=>{t.setLocked(e=>!e)},[]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner-item").elem("controls").mod({withControls:s,newUI:(0,Ne.VS)(Ne.bA)}).toClassName(),children:[(0,Ne.VS)(Ne.bA)?(0,ae.jsx)(Pn.m_M,{title:"Confidence Score",children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner-item").elem("control-wrapper").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"predict"}).toClassName(),children:"prediction"===(null==t?void 0:t.origin)&&(0,ae.jsx)(kn.ccx,{style:{width:18,height:18}})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"score"}).toClassName(),children:(0,E.isDefined)(null==t?void 0:t.score)&&t.score.toFixed(2)})]})}):(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"score"}).toClassName(),children:(0,E.isDefined)(null==t?void 0:t.score)&&t.score.toFixed(2)}),(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"dirty"}).toClassName()}),(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"predict"}).toClassName(),children:"prediction"===(null==t?void 0:t.origin)&&(0,ae.jsx)(kn.ccx,{style:{width:18,height:18}})})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner-item").elem("wrapper").toClassName(),children:[l.hasInterface("annotations:copy-link")&&(0,E.isDefined)(null==t||null==(c=t.annotation)?void 0:c.pk)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"menu"}).toClassName(),children:(0,ae.jsx)(RS,{item:t})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"lock"}).toClassName(),children:(0,ae.jsx)(Gw,{item:t,annotation:null==t?void 0:t.annotation,hovered:e,locked:null==t?void 0:t.locked,onClick:m,variant:"neutral",look:"string",tooltip:null!=t&&t.locked?"Unlock Region":"Lock Region"})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"visibility"}).toClassName(),children:(0,Ne.VS)(Ne.bA)?(0,ae.jsx)(Uw,{variant:"neutral",look:"string",onClick:h,style:u?void 0:{display:"none"},children:u?(0,ae.jsx)(kn.r9M,{style:{width:20,height:20}}):(0,ae.jsx)(kn.C_F,{style:{width:20,height:20}})}):(0,ae.jsx)(Uw,{variant:"neutral",look:"string",onClick:h,children:u?(0,ae.jsx)(kn.r9M,{style:{width:20,height:20}}):(0,ae.jsx)(kn.C_F,{style:{width:20,height:20}})})}),s&&(0,ae.jsx)("div",{className:(0,Nn.cn)("outliner-item").elem("control").mod({type:"visibility"}).toClassName(),children:(0,ae.jsx)(Uw,{variant:"neutral",look:"string",onClick:g,children:(0,ae.jsx)(kn.gu7,{style:{transform:`rotate(${i?-90:90}deg)`}})})})]})]})})),FS=(0,b.PA)(({item:e,collapsed:t,setCollapsed:n,selected:i})=>{const o=e.perRegionDescControls||[],s=(0,f.useCallback)(t=>{t.stopPropagation(),i||e.annotation.selectArea(e)},[e,i,t]);return(0,ae.jsx)("div",{className:(0,Nn.cn)("ocr").mod({collapsed:t,empty:!((null==o?void 0:o.length)>0)}).toClassName(),onClick:s,onDragStart:e=>e.stopPropagation(),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("ocr").elem("controls").toClassName(),children:o.map((i,o)=>{const s=we.getPerRegionView(i.type,dt.REGION_LIST),a=e.getOneColor(),r=a?(0,ft.A)(a).alpha(.2).css():void 0;return s?(0,ae.jsx)(s,{item:i,area:e,collapsed:t,setCollapsed:n,color:r,outliner:!0,canDelete:!1},o):null})})})}),HS=(0,b.PA)(({regions:e,footer:t})=>{const n=(0,Nn.cn)("tree"),i=ES({regions:e,rootClass:n,footer:t,grouping:e.group});return(0,ae.jsx)(_S.Provider,{value:{regions:e},children:(0,ae.jsx)(MS,{regions:e,regionsTree:i})})}),VS=(0,f.createContext)({locked:!1}),$S=[["labels","audio"],["labels","videorectangle","video"],["timelinelabels","video"],["timeserieslabels","timeseries"]],WS=(0,b.PA)(({ordering:e,regions:t,orderingDirection:n,onOrderingChange:i,onGroupingChange:o})=>{var s;const a=t.group,r=(0,f.useContext)(VS),l=(0,f.useMemo)(()=>{var e;const n=null==(e=t.annotation)?void 0:e.names;if(!n||0===n.size)return null;const i=Array.from(n.values());return $S.some(e=>e.every(e=>i.some(t=>(null==t?void 0:t.type)===e)))},[null==(s=t.annotation)?void 0:s.names]);(0,f.useEffect)(()=>{"mediaStartTime"===e&&!1===l&&i("date")},[e,l,i]);const c=(0,f.useCallback)(e=>{switch(e){case"manual":return{label:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(kn.uMc,{})," Group Manually"]}),selectedLabel:(0,Ne.VS)(Ne.bA)?"Manual":"Manual Grouping",icon:(0,ae.jsx)(kn.uMc,{width:16,height:16}),tooltip:"Manually Grouped"};case"label":return{label:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(kn.vHH,{})," Group by Label"]}),selectedLabel:(0,Ne.VS)(Ne.bA)?"By Label":"Grouped by Label",icon:(0,ae.jsx)(kn.vHH,{width:16,height:16}),tooltip:"Grouped by Label"};case"type":return{label:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(kn.ECq,{})," Group by Tool"]}),selectedLabel:(0,Ne.VS)(Ne.bA)?"By Tool":"Grouped by Tool",icon:(0,ae.jsx)(kn.ECq,{width:16,height:16}),tooltip:"Grouped by Tool"}}},[]),d=(0,f.useCallback)(e=>{switch(e){case"date":return{label:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(kn.NH8,{})," Order by Time"]}),selectedLabel:"By Time",icon:(0,ae.jsx)(kn.NH8,{width:16,height:16})};case"score":return{label:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(kn.aHw,{})," Order by Score"]}),selectedLabel:"By Score",icon:(0,ae.jsx)(kn.aHw,{width:16,height:16})};case"mediaStartTime":return{label:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(kn.hpC,{})," Order by Media Start Time"]}),selectedLabel:"By Media Start Time",icon:(0,ae.jsx)(kn.hpC,{width:16,height:16})}}},[]),u="asc"===n?(0,ae.jsx)(kn.n5,{}):(0,ae.jsx)(kn.WCw,{});return(0,ae.jsxs)("div",{className:(0,Nn.cn)("view-controls").mod({collapsed:r.locked}).toClassName(),children:[(0,ae.jsx)(US,{value:a,options:["manual","type","label"],onChange:e=>o(e),readableValueForKey:c}),"manual"===a&&(0,ae.jsx)("div",{className:(0,Nn.cn)("view-controls").elem("sort").toClassName(),children:(0,ae.jsx)(US,{value:e,direction:n,options:l?["score","date","mediaStartTime"]:["score","date"],onChange:e=>i(e),readableValueForKey:d,allowClickSelected:!0,extraIcon:u,width:230})}),(0,ae.jsx)(XS,{regions:t})]})}),US=({value:e,options:t,direction:n,allowClickSelected:i,onChange:o,readableValueForKey:s,extraIcon:a,width:r=200})=>{const l=(0,f.useMemo)(()=>s(e),[e]),c=(0,f.useMemo)(()=>t.map(e=>[e,s(e)]),[t,s]),d=(0,f.useMemo)(()=>(0,ae.jsx)(um,{size:"medium",style:{width:r,minWidth:r,borderRadius:(0,Ne.VS)(Ne.bA)&&4},selectedKeys:[e],allowClickSelected:i,children:c.map(([t,i])=>(0,ae.jsx)(GS,{name:t,value:e,direction:n,label:i,onChange:e=>o(e)},t))}),[e,c,l,n,o]);return(0,ae.jsx)(Pn.msM.Trigger,{content:d,style:{width:r},children:(0,ae.jsx)(Pn.$nd,{variant:"neutral",size:"smaller","data-testid":`grouping-${e}`,look:"string",leading:l.icon,trailing:(0,Ne.VS)(Ne.bA)?a:(0,ae.jsx)(YS,{direction:n,name:e,value:e,wrap:!1}),children:l.selectedLabel})})},GS=({value:e,name:t,label:n,direction:i,onChange:o})=>(0,ae.jsx)(um.Item,{name:t,onClick:()=>o(t),children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("view-controls").elem("label").toClassName(),children:[n.label,(0,ae.jsx)(YS,{direction:i,name:t,value:e})]})}),YS=({direction:e,value:t,name:n,wrap:i=!0})=>{const o="asc"===e?(0,ae.jsx)(kn.n5,{}):(0,ae.jsx)(kn.WCw,{});return!e||t!==n||(0,Ne.VS)(Ne.bA)?null:i?(0,ae.jsx)("span",{children:o}):o},XS=(0,b.PA)(({regions:e})=>{var t;const n=(0,f.useCallback)(t=>{t.preventDefault(),t.stopPropagation(),e.toggleVisibility()},[e]),i=!(null!=e&&null!=(t=e.regions)&&t.length),o=!i&&e.isAllHidden;return(0,ae.jsx)(Pn.$nd,{variant:"neutral",size:"smaller",look:"string",disabled:i,onClick:n,"aria-label":o?"Show all regions":"Hide all regions",tooltip:o?"Show all regions":"Hide all regions",children:o?(0,ae.jsx)(kn.liT,{width:16,height:16}):(0,ae.jsx)(kn.CuU,{width:16,height:16})})}),qS=["regions"],ZS=[];ZS.push("ff_hide_all_regions");const JS=()=>(0,ae.jsx)(uw,{icon:(0,ae.jsx)(Pn.vEY,{width:24,height:24}),header:"Labeled regions will appear here",description:(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsxs)("span",{children:["Start labeling and track your results",(0,ae.jsx)("br",{}),"using this panel"]})}),learnMore:{href:(0,aS.T)("guide/labeling"),text:"Learn more",testId:"regions-panel-learn-more"}}),QS=(0,b.PA)(({regions:e})=>{var t,n,i,o,s;const a=(null==e||null==(t=e.regions)?void 0:t.length)>0&&0===(null==e||null==(n=e.filter)?void 0:n.length),r=(0,f.useMemo)(()=>{var t,n,i,o;return null!=e&&null!=(t=e.regions)&&t.length&&null!=(n=e.filter)&&n.length?(null==e||null==(i=e.regions)?void 0:i.length)-(null==e||null==(o=e.filter)?void 0:o.length):0},[null==e||null==(i=e.regions)?void 0:i.length,null==e||null==(o=e.filter)?void 0:o.length]);return(0,ae.jsx)(ae.Fragment,{children:a?(0,ae.jsxs)("div",{className:(0,Nn.cn)("filters-info").toClassName(),children:[(0,ae.jsx)(kn.G_L,{width:21,height:20}),(0,ae.jsx)("div",{className:(0,Nn.cn)("filters-info").elem("filters-title").toClassName(),children:"All regions hidden"}),(0,ae.jsx)("div",{className:(0,Nn.cn)("filters-info").elem("filters-description").toClassName(),children:"Adjust or remove the filters to view"})]}):(null==e||null==(s=e.regions)?void 0:s.length)>0?(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)(HS,{regions:e,footer:r>0&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("filters-info").toClassName(),children:[(0,ae.jsx)(kn.G_L,{width:21,height:20}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("filters-info").elem("filters-title").toClassName(),children:["There ",1===r?"is":"are"," ",r," hidden region",r>1&&"s"]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("filters-info").elem("filters-description").toClassName(),children:"Adjust or remove filters to view"})]})})}):(0,ae.jsx)(JS,{})})}),eC=(0,b.PA)(({regions:e})=>{const t=(0,f.useCallback)(t=>{e.setSort(t)},[e]),n=(0,f.useCallback)(t=>{e.setGrouping(t)},[e]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("outliner").mix(...ZS).toClassName(),children:[(0,ae.jsx)(WS,{ordering:e.sort,regions:e,orderingDirection:e.sortOrder,onOrderingChange:t,onGroupingChange:n}),(0,ae.jsx)(QS,{regions:e})]})}),tC=(0,b.PA)(e=>{let{regions:t}=e,n=(0,Se.A)(e,qS);const[i,o]=(0,f.useState)(t.group),s=(0,f.useCallback)(e=>{t.setSort(e)},[t]),a=(0,f.useCallback)(e=>{t.setGrouping(e),o(e)},[t]);return(0,f.useEffect)(()=>{o(t.group)},[]),t.setGrouping(i),(0,ae.jsxs)(kw,Object.assign({},n,{name:"outliner",mix:ZS,title:"Outliner",children:[(0,ae.jsx)(WS,{ordering:t.sort,regions:t,orderingDirection:t.sortOrder,onOrderingChange:s,onGroupingChange:a}),(0,ae.jsx)(QS,{regions:t})]}))}),nC=e=>{const[t,n]=(0,f.useState)(window.matchMedia(e));return(0,f.useEffect)(()=>{const t=()=>{n(window.matchMedia(e))};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),(0,f.useEffect)(()=>{n(window.matchMedia(e))},[e]),t},iC=e=>{var t;(0,f.useEffect)(()=>{const t=e=>{var t;if(!e)return!1;if(e.nodeType!==Node.ELEMENT_NODE)return!1;const n=e,i=Number.parseInt(null!=(t=n.getAttribute("tabindex"))?t:"",10);return n.matches("a, button, input, textarea, select, details, [tabindex], [contenteditable]")||i>-1},n=()=>{var e;const n=window.getSelection(),i=null==n?void 0:n.focusNode,o=t(i),s=t(document.activeElement);return(null==(e=null==n?void 0:n.isCollapsed)||e)&&!o&&!s},i=t=>{const{clipboardData:n}=t,i=e.serializedSelection;null==n||n.setData("application/json",JSON.stringify(i)),t.preventDefault()},o=e=>{n()&&i(e)},s=t=>{n()&&(t=>{const{clipboardData:n}=t,i=null==n?void 0:n.getData("application/json");try{const n=(i?JSON.parse(i):[]).map(e=>Object.assign({},e,{readonly:!1}));e.appendResults(n),t.preventDefault()}catch(e){return void console.error(e)}})(t)},a=t=>{n()&&(i(t),e.deleteSelectedRegions())};return window.addEventListener("copy",o),window.addEventListener("paste",s),window.addEventListener("cut",a),()=>{window.removeEventListener("copy",o),window.removeEventListener("paste",s),window.removeEventListener("cut",a)}},[null!=(t=e.pk)?t:e.id])},oC=980,sC=(e,t)=>{const n=window.localStorage.getItem(`panel:${e}`);return n?Object.assign({},t,JSON.parse(n)):t},aC=(e,t)=>{window.localStorage.setItem(`panel:${e}`,JSON.stringify(t))},rC={outliner:{title:"Outliner",component:tC,icon:kn.v},details:{title:"Details",component:wS,icon:kn.Iap}},lC=(0,b.PA)(({currentEntity:e,panelsHidden:t,children:n})=>{const i=e.regionStore,o=(0,f.useRef)({width:0,height:0}),s=nC("screen and (max-width: 980px)"),[a,r]=(0,f.useState)(500),[l,c]=(0,f.useState)(!1),[d,u]=(0,f.useState)(!1),[h,g]=(0,f.useState)(!1),[m,p]=(0,f.useState)(!1),v=(0,f.useRef)(),[y,b]=(0,f.useState)(),x=(0,f.useRef)(y);x.current=y;const[w,S]=(0,f.useState)({outliner:sC("outliner",{top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:1,width:bw,height:xw,visible:!0,detached:!1,alignment:"left",maxHeight:ww}),details:sC("details",{top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:1,width:bw,height:xw,visible:!0,detached:!1,alignment:"right",maxHeight:ww})});iC(e);const C=(0,f.useMemo)(()=>l||s.matches,[l,s.matches]),k=(0,f.useCallback)((e,t)=>{S(n=>{const i=Object.assign({},n[e],t);return aC(e,i),Object.assign({},n,{[e]:i})})},[w]),P=(0,f.useCallback)((e,t)=>{const n=w[e],i=N(e,n.top,n.left,t);k(e,{visible:t,storedTop:i.top/o.current.height*100,storedLeft:i.left/o.current.width*100})},[k]),R=(0,f.useCallback)(e=>(0,Ne.VS)(Ne.bA)||void 0===Object.values(w).find(t=>t.alignment===e&&!t.detached),[w]),j=(0,f.useCallback)((e,t,n)=>{const i=e+n,o=t-5;e>=0&&e<=5&&R("left")?b("left"):i<=t&&i>=o&&R("right")?b("right"):b(void 0)},[R]),N=(e,t,n,i)=>{var o,s,a,r;const l=w[e],c=null!=(o=null==(s=v.current)?void 0:s.clientWidth)?o:0,d=l.detached?(null!=i?i:l.visible)?l.height:26:l.height;return{left:(0,E.clamp)(n,0,c-l.width),top:(0,E.clamp)(t,0,(null!=(a=null==(r=v.current)?void 0:r.clientHeight)?a:0)-d)}},T=(0,f.useCallback)(e=>{const t=Object.entries(w).reduce((e,[t,n])=>{const i=Object.assign({},n,{zIndex:1});return g(!0),aC(t,i),Object.assign({},e,{[t]:i})},Object.assign({},w));t[e]=Object.assign({},t[e],{zIndex:15}),aC(e,t[e]),S(t)},[w]),A=(0,f.useCallback)((e,t,n,i)=>{var s,a;const r=w[e],l=null!=(s=null==(a=v.current)?void 0:a.clientWidth)?s:0,{left:c,top:d}=N(e,t,n,r.visible),u=o.current.height-d;j(c,l,r.width),requestAnimationFrame(()=>{k(e,{top:d,left:c,relativeTop:d/o.current.height*100,relativeLeft:c/o.current.width*100,storedLeft:void 0,storedTop:void 0,detached:i,maxHeight:u,alignment:i?void 0:r.alignment})})},[k,j,w]),I=(0,f.useCallback)(()=>{u(()=>!0)},[]),M=(0,f.useCallback)(()=>{u(()=>!1)},[]),K=(0,f.useCallback)(e=>Object.keys(w).filter(t=>{var n;return(null==(n=w[t])?void 0:n.alignment)===e}),[w]),D=(0,f.useCallback)((e,t,n,i,s)=>{const{left:r,top:l}=N(e,i,s),c=o.current.height-l;requestAnimationFrame(()=>{if((0,Ne.VS)(Ne.bA)){var i;K(null==(i=w[e])?void 0:i.alignment).forEach(e=>{k(e,{top:l,left:r,relativeTop:l/o.current.height*100,relativeLeft:r/o.current.width*100,storedLeft:void 0,storedTop:void 0,maxHeight:c,width:(0,E.clamp)(t,bw,a),height:(0,E.clamp)(n,xw,c)})})}else k(e,{top:l,left:r,relativeTop:l/o.current.height*100,relativeLeft:r/o.current.width*100,storedLeft:void 0,storedTop:void 0,maxHeight:c,width:(0,E.clamp)(t,bw,a),height:(0,E.clamp)(n,xw,c)})})},[k,a,w]),O=(0,f.useCallback)(e=>{if(g(!1),!x.current)return;const t={alignment:x.current,detached:!1};if((0,Ne.VS)(Ne.bA)){var n;const o=null==(n=K(x.current).filter(t=>t!==e))?void 0:n[0];var i;if(o)t.width=(0,E.clamp)(null==(i=w[o])?void 0:i.width,bw,a)}k(e,t),b(void 0)},[k]),L=(0,f.useMemo)(()=>({onResize:D,onResizeStart:I,onResizeEnd:M,onPositionChange:A,onVisibilityChange:P,onPositionChangeBegin:T,onSnap:O}),[D,I,M,A,P,O]),z=(0,f.useMemo)(()=>Object.assign({},L,{root:v,regions:i,selection:i.selection,currentEntity:e}),[L,v,i,i.selectio,e]),B=(0,f.useMemo)(()=>{if(t&&(0,Ne.VS)(Ne.bA))return{};const e={paddingLeft:0,paddingRight:0};return C?e:Object.values(w).reduce((e,n)=>{const i=(0,Ne.VS)(Ne.bA)||!t&&!n.detached&&n.visible?n.width:Sw,o="left"===n.alignment?"paddingLeft":"paddingRight";return n.detached?e:Object.assign({},e,{[o]:i})},e)},[t,w,C]),F=(0,f.useMemo)(()=>{if(t)return{};const e={detached:[],left:[],right:[]},n=Object.entries(w);for(const[t,s]of n){var i,o;const{alignment:n,detached:r}=s,l=rC[t],c=l.component,d=l.icon,u={props:Object.assign({},s,z,{top:null!=(i=s.storedTop)?i:s.top,left:null!=(o=s.storedLeft)?o:s.left,tooltip:l.title,icon:(0,ae.jsx)(d,{}),positioning:h,maxWidth:a,zIndex:s.zIndex,expanded:C,alignment:C?"left":s.alignment,locked:C}),Component:c};r?e.detached.push(u):"left"===n?e.left.push(u):"right"===n&&e.right.push(u)}return e},[w,z,t,C,h,a]);(0,f.useEffect)(()=>{const e=v.current;if(!e)return;const t=()=>{var e,t;return(null!=(e=null==(t=v.current)?void 0:t.clientWidth)?e:0)<oC},n=new _(()=>{requestAnimationFrame(()=>{if(!v.current)return;const{clientWidth:e,clientHeight:n}=v.current;e<=oC||(o.current.width=null!=e?e:0,o.current.height=null!=n?n:0,c(t()),r(.4*v.current.clientWidth))})});return e&&(n.observe(e),c(t()),r(.4*e.clientWidth),p(!0)),()=>{e&&n.unobserve(e),n.disconnect()}},[]);const H=(0,f.useMemo)(()=>({locked:C}),[C]);return(0,ae.jsx)(VS.Provider,{value:H,children:(0,ae.jsx)("div",{ref:e=>{e&&(v.current=e,c(e.clientWidth<=oC))},className:(0,Nn.cn)("sidepanels").mod({collapsed:C,newLabelingUI:(0,Ne.VS)(Ne.bA)}).toClassName(),style:Object.assign({},B),children:m&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("sidepanels").elem("content").mod({resizing:d||h}).toClassName(),children:n}),!0!==t&&(0,ae.jsx)(ae.Fragment,{children:Object.entries(F).map(([e,t])=>{const n=t.map(({props:e,Component:t},n)=>(0,ae.jsx)(t,Object.assign({},e),n));return"detached"===e?(0,ae.jsx)(f.Fragment,{children:n},e):(0,ae.jsx)("div",{className:(0,Nn.cn)("sidepanels").elem("wrapper").mod({align:e,snap:y===e&&void 0!==y}).toClassName(),children:n},e)})})]})})})});let cC=function(e){return e.left="left",e.right="right",e}({}),dC=function(e){return e.left="left",e.right="right",e.topRight="right-top",e.topLeft="left-top",e.bottomRight="right-bottom",e.bottomLeft="left-bottom",e}({}),uC=function(e){return e.top="top",e.bottom="bottom",e}({});const hC={order:0,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:1,width:bw,height:xw,visible:!0,detached:!0,alignment:cC.left,maxHeight:ww,panelViews:[]},gC=(e,t)=>{const n=t||e.target,i=n.clientWidth;return e.pageX-n.getBoundingClientRect().left>i/2?cC.right:cC.left},mC=(e,t,n)=>{const i=Object.assign({},e);return i[t]?Object.assign({},i,{[t]:Object.assign({},i[t],{panelViews:i[t].panelViews.filter((e,t)=>t!==n)})}):i},pC=(e,t,n)=>{const i=Object.assign({},e,{[t]:Object.assign({},e[t],{panelViews:e[t].panelViews.map((e,t)=>(e.active=t===n,e))})});return i},fC=e=>{const t=Object.assign({},e);return Object.values(t).forEach(e=>{const t=!e.panelViews.find(e=>e.active);t&&(e.panelViews[0].active=!0)}),t},vC=e=>{const t={};return Object.keys(e).forEach(n=>{const i=`${e[n].panelViews.map(e=>e.name).join("-")}`,o=Object.assign({},e[n]);Object.assign(t,{[i]:o})}),t},yC=e=>{const t=Object.assign({},e);return Object.keys(t).forEach(e=>{0===t[e].panelViews.length&&delete t[e]}),t},bC=(e,t,n)=>{const i=Object.assign({},e,{[t]:Object.assign({},e[t],{panelViews:n?[...e[t].panelViews,Object.assign({},SC,{title:n})]:e[t].panelViews.filter(e=>e.name!==SC.name)})});return i},xC={regions:eC,history:vS,relations:yS,comments:fS,info:bS,custom:xS},wC=[{name:"regions",title:"Regions",component:xC.regions,active:!0},{name:"history",title:"History",component:xC.history,active:!1},{name:"relations",title:"Relations",component:xC.relations,active:!1},{name:"info",title:"Info",component:xC.info,active:!0},{name:"comments",title:"Comments",component:xC.comments,active:!1},{name:"custom",title:"Custom",component:xC.custom,active:!1}],SC=wC[5],CC={"info-comments-history":{order:1,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:bw,height:xw,visible:!0,detached:!1,alignment:cC.right,maxHeight:ww,panelViews:[wC[3],wC[4],wC[1]]},"regions-relations":{order:2,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:bw,height:xw,visible:!0,detached:!1,alignment:cC.right,maxHeight:ww,panelViews:[wC[0],wC[2]]}},kC={"info-history":{order:1,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:bw,height:xw,visible:!0,detached:!1,alignment:cC.right,maxHeight:ww,panelViews:[wC[3],wC[1]]},"regions-relations":{order:2,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:bw,height:xw,visible:!0,detached:!1,alignment:cC.right,maxHeight:ww,panelViews:[wC[0],wC[2]]}},PC=Object.assign({},hC,{name:"breakpointCollapsed",positioning:!1,height:xw,maxHeight:xw,detached:!1,maxWidth:500,zIndex:10,expanded:!0,locked:!0,alignment:cC.left,lockPanelContents:!1,attachedKeys:[],sidePanelCollapsed:{[cC.left]:!1,[cC.right]:!1},setSidePanelCollapsed:()=>{},dragTop:!1,dragBottom:!1,panelViews:[wC[0],wC[1],wC[2],wC[3],wC[4]]}),RC=["top-left","top-right","bottom-left","bottom-right","top","bottom","right","left"],jC=(e,t=!1)=>{var n;const i=window.localStorage.getItem("panelState"),o=i&&JSON.parse(i),s=o&&o.panelData,a={[cC.left]:!1,[cC.right]:!1},r=null!=(n=null==o?void 0:o.collapsedSide)?n:a,l=s&&Object.values(s).flatMap(e=>e.panelViews),c=wC.length-(e?0:1)-(t?0:1);if(!l||l.length!==c){let n=e?CC:kC;return e&&t&&(n=bC(n,"regions-relations",t)),{panelData:n,collapsedSide:a}}const d=yC(((e,t)=>{const n=e=>Object.keys(e).find(t=>e[t].panelViews.some(e=>e.name===SC.name));if(t){var i;const o=n(e),s=o&&(null==(i=e[o])?void 0:i.panelViews.find(e=>e.name===SC.name));if(!s)return bC(e,"regions-relations",t);if(s.title!==t)return bC(bC(e,o,!1),o,t)}else{const t=n(e);if(t)return bC(e,t,!1)}return e})(s,t)),u=fC(d),h=((e,t)=>{const n=Object.assign({},e);return Object.keys(n).filter(e=>n[e]).forEach(e=>{Object.keys(t).some(n=>t[n].alignment===e&&!t[n].detached)||(n[e]=!1)}),n})(r,u);return{panelData:NC(u),collapsedSide:h}},NC=e=>{const t=Object.assign({},e);return Object.keys(t).forEach(e=>{t[e].panelViews.forEach(e=>{e.component=xC[e.name]})}),t},TC=e=>Object.keys(e).filter(t=>!e[t].detached&&e[t].alignment===cC.left),_C=e=>Object.keys(e).filter(t=>!e[t].detached&&e[t].alignment===cC.right),AC=(e,t)=>t===cC.left?TC(e).sort((t,n)=>e[t].order-e[n].order):t===cC.right?_C(e).sort((t,n)=>e[t].order-e[n].order):void 0,IC=(e,t)=>{const n=Object.assign({},e);return[TC(n),_C(n)].forEach(i=>{const o=i.filter(t=>!e[t].visible).length,s=i.filter(t=>e[t].visible),a=Sw*o,r=s.reduce((e,t)=>e+n[t].height,0),l=t-a-r,c=l<0,d=Math.abs(l)/(s.length||1);let u=0;s.forEach(e=>{const t=c?n[e].height-d:n[e].height+d;n[e].visible?(n[e].height=t,n[e].top=u,u+=t):u+=Sw})}),n},MC=(e,t,n)=>{const i=Object.assign({},e),o=AC(i,n);if(null==o||!o.length)return e;const s=o.filter(e=>i[e].visible),a=o.filter(e=>!i[e].visible).length,r=(t-Sw*a)/s.length||1;return s.forEach(e=>{let t=0;i[e].visible?(i[e].height=r,i[e].top=t,t+=r):t+=Sw}),i},EC=(e,t,n,i,o,s=uC.bottom)=>{const a=Object.assign({},e),r=AC(a,n),l=r?r.reduce((t,n)=>t<e[n].width?e[n].width:t,0)||i:i||bw,c=Object.assign({},a,{[t]:Object.assign({},a[t],{width:l,alignment:n,detached:!1})}),d=((e,t,n,i)=>{const o=Object.assign({},e);o[t].order=i===uC.top?0:n.length;let s=i===uC.bottom?0:1;return n.forEach(e=>{t!==e&&(o[e].order=s,s+=1)}),o})(c,t,AC(c,n),s),u=DC(d,t);return MC(u,o,n)},KC=(e,t,n,i,o,s,a)=>{const r=((e,t,n,i,o,s,a)=>Object.assign({},hC,{name:t,panelViews:[Object.assign({},e[n].panelViews[i],{active:!0})],top:s,left:o,relativeTop:s/a.current.height*100,relativeLeft:o/a.current.width*100,visible:!0,detached:!0,zIndex:12}))(e,t,n,i,o,s,a),l=mC(e,n,i),c=yC(l),d=Object.assign({},c,{[`${r.name}`]:r}),u=vC(d),h=fC(u),g=DC(h,r.name);return IC(g,a.current.height)},DC=(e,t)=>{const n=Object.assign({},e),[i,o]=(e=>Object.keys(e).reduce((t,n)=>(e[n].detached?t[0].push({zIndex:e[n].zIndex,panelKey:n}):t[1].push({zIndex:e[n].zIndex,panelKey:n}),t),[[],[]]))(n);let s=12;return o.forEach(e=>n[e.panelKey].zIndex=10),i.sort((e,t)=>e.zIndex-t.zIndex).forEach(e=>{n[e.panelKey].zIndex=s,s++}),n[t].detached&&(n[t].zIndex=i.length+12),n},OC=["name","root","width","maxWidth","height","visible","detached","alignment","top","left","relativeTop","relativeLeft","zIndex","locked","positioning","onSnap","onResize","onGroupHeightResize","onResizeStart","onResizeEnd","onVisibilityChange","onPositionChange","onPositionChangeBegin","children","panelViews","attachedKeys","sidePanelCollapsed","setSidePanelCollapsed","dragTop","dragBottom","lockPanelContents","isBottomPanel","contentRef"],LC=e=>{var t,n,i;let{name:o,root:s,width:a,maxWidth:r,height:l,visible:c,detached:d,alignment:u,top:h,left:g,relativeTop:m,relativeLeft:p,zIndex:v,locked:y=!1,positioning:b=!1,onSnap:x,onResize:w,onGroupHeightResize:S,onResizeStart:C,onResizeEnd:k,onVisibilityChange:P,onPositionChange:R,onPositionChangeBegin:j,children:N,panelViews:T,attachedKeys:_,sidePanelCollapsed:A,setSidePanelCollapsed:I,dragTop:M,dragBottom:K,lockPanelContents:D,isBottomPanel:O,contentRef:L}=e,z=(0,Se.A)(e,OC);const B=(0,f.useRef)(),F=(0,f.useRef)(),H=(0,f.useRef)(),V=(0,f.useRef)(),$=(0,f.useRef)({onResize:w,onGroupHeightResize:S,onResizeStart:C,onResizeEnd:k,onPositionChange:R,onPositionChangeBegin:j,onVisibilityChange:P,onSnap:x}),[W,U]=(0,f.useState)(),G=(0,f.useRef)(o),Y=A[u]&&!d,X=_&&_[0]===o,q=_&&_.includes(o)&&_[0]!==o,Z=!(Y&&!X),J=c&&!Y?"Collapse":"Expand",Q=(null==(t=z.currentEntity)||null==(t=t.store)?void 0:t.settings)||(null==(n=z.currentEntity)?void 0:n.settings),[ee,te]=(0,f.useState)(()=>!(!O||null==Q||!Q.defaultCollapsedBottomPanel)),[ne,ie]=(0,f.useState)(xw),oe=(0,f.useRef)(!1),se=(0,f.useRef)(0),re=(0,f.useRef)(0),le=null!=(i=null==Q?void 0:Q.collapsibleBottomPanel)&&i;$.current={onResize:w,onGroupHeightResize:S,onResizeStart:C,onResizeEnd:k,onPositionChange:R,onPositionChangeBegin:j,onVisibilityChange:P,onSnap:x},G.current=o;const ce=(0,f.useMemo)(()=>{if(O&&ee)return{height:"33px",zIndex:v,borderTop:"1px solid var(--color-neutral-border)"};if(O&&le)return{height:`${ne}px`,zIndex:v};const e=c?{height:y?xw:Y?"100%":null!=l?l:"100%",width:y?"100%":Y?Sw:null!=a?a:"100%"}:{width:Y?"100%":null!=a?a:bw,height:Y?"100%":Sw};return Object.assign({},e,{zIndex:v})},[a,l,c,y,Y,v,O,ee,le,ne]);(0,f.useEffect)(()=>{null!=L&&L.current&&(O&&ee?L.current.style.height="calc(100% - 33px)":O&&le&&(L.current.style.height=`calc(100% - ${ne}px)`))},[ne,O,ee,le]);const de=(0,f.useMemo)(()=>d&&!y?{top:`${m}%`,left:`${p}%`}:{},[d,m,p,y]),ue=(0,f.useMemo)(()=>({detached:!y&&d,hidden:!c,alignment:d?"left":null!=u?u:"left",disabled:y,collapsed:Y,dragTop:M&&_&&_[0]===o,dragBottom:K&&_&&_[_.length-1]===o}),[u,c,d,W,y,Y,M,K]);yw({elementRef:B,disabled:y,onMouseDown(e){var t;const n=e.target,i="[class*=__toggle]";if(n.matches(i)||n.closest(i)||Y)return;const o=F.current,a=s.current.getBoundingClientRect(),r=o.getBoundingClientRect(),l=null==(t=e.target)?void 0:t.getBoundingClientRect(),c=e.clientX-l.left,h=e.clientY-l.top,[g,m]=[e.pageX,e.pageY],[p,f]=[r.left-a.left,r.top-a.top],{current:v}=G,[y,b]=[g-c,m-h];return null==$.current.onPositionChangeBegin||$.current.onPositionChangeBegin(v,y,b,u,d),{x:g,y:m,oX:p,oY:f,allowDrag:!0,alignment:u,key:v}},onMouseMove(e,t){if(!t)return;const{x:n,y:i,oX:o,oY:s,key:a}=t,[r,l]=[e.pageX,e.pageY];var c,d,h,g;if((c=n,d=r,h=i,g=l,Math.sqrt((d-c)**2+(g-h)**2))<30)return;const[m,p]=[o+(r-n),s+(l-i)];null==$.current.onPositionChange||$.current.onPositionChange(a,p,m,!0,u)},onMouseUp(e,t){if(!t)return;const{key:n}=t;null==$.current.onSnap||$.current.onSnap(n)}},[d,c,y,u,o,Y,B.current]),yw({elementRef:H,disabled:y||b,capture:!0,passive:!0,onMouseDown(e){const t=e.target.dataset.resize,n=(()=>{switch(t){case"top-left":return"top-left";case"top":case"top-right":return"top";case"left":case"bottom-left":return"left"}})(),i={x:null!==(null==t?void 0:t.match(/left|right/i)),y:null!==(null==t?void 0:t.match(/top|bottom/i))};return U(t),null==$.current.onResizeStart||$.current.onResizeStart(),{pos:[e.pageX,e.pageY],type:t,width:a,maxWidth:r,height:l,top:h,left:g,resizeDirections:i,shift:n}},onMouseMove(e,t){if(t){const{pos:n,width:i,height:o,maxWidth:s,top:a,left:r,resizeDirections:l,shift:c}=t,[d,u]=n,h=l.x?e.pageX-d:0,g=l.y?e.pageY-u:0,m=(0,E.isDefined)(c)&&["left","top-left"].includes(c),p=(0,E.isDefined)(c)&&["top","top-left"].includes(c),f=(0,E.clamp)(m?i-h:i+h,bw,s),v=(0,E.clamp)(p?o-g:o+g,55,a+o),y=p?a+(o-v):a,b=m?r+(i-f):r,{current:x}=G;$.current.onResize(x,f,v,y,b)}},onMouseUp(){null==$.current.onResizeEnd||$.current.onResizeEnd(),U(void 0)}},[$,d,a,r,l,h,g,c,y,b]),yw({elementRef:V,disabled:y||b,capture:!0,passive:!0,onMouseDown:e=>(U("grouped-top"),null==$.current.onResizeStart||$.current.onResizeStart(),{sY:e.pageY,h:l}),onMouseMove(e,t){if(!t)return;const{sY:n,h:i}=t,o=e.pageY-n,s=i-o,{current:a}=G;null==$.current.onGroupHeightResize||$.current.onGroupHeightResize(a,s,o)},onMouseUp(){null==$.current.onResizeEnd||$.current.onResizeEnd(),U(void 0)}},[$,a,l,h,g,y,b,V.current]);const he=()=>{I(Object.assign({},A,{[u]:!A[u]}))},ge=(0,f.useCallback)(e=>{e.stopPropagation(),e.preventDefault(),null==P||P(o,!c)},[P,o,c]);(0,f.useEffect)(()=>{const e=e=>{if(!oe.current)return;const t=se.current-e.clientY,n=Math.max(100,Math.min(800,re.current+t));ie(n)},t=()=>{oe.current=!1};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[]);return(0,ae.jsxs)("div",{ref:F,className:(0,Nn.cn)("tabs-panel").mod(ue).toClassName(),style:Object.assign({},ce,de),children:[O&&le&&!ee&&(0,ae.jsx)("div",{className:"w-full h-2 absolute -top-2 left-0 cursor-row-resize bg-neutral-emphasis hover:bg-primary-border active:bg-primary-border transition-colors duration-100 select-none z-10",onMouseDown:e=>{e.preventDefault(),e.stopPropagation(),oe.current=!0,se.current=e.clientY,re.current=ne},onDoubleClick:()=>{ie(xw)},role:"separator","aria-orientation":"horizontal",tabIndex:-1}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("tabs-panel").elem("content").toClassName(),children:[!y&&Z&&(0,ae.jsxs)(ae.Fragment,{children:[q&&c&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("grouped-top").mod({drag:"grouped-top"===W}).toClassName(),ref:V,"data-resize":"grouped-top"}),(0,ae.jsxs)("div",{ref:B,onClick:()=>{Y&&he()},id:o,className:(0,Nn.cn)("tabs-panel").elem("header").mod({collapsed:Y}).toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("tabs-panel").elem("header-left").toClassName(),children:[!Y&&(0,ae.jsx)(kn.ORE,{className:(0,Nn.cn)("tabs-panel").elem("icon").toClassName(),style:{pointerEvents:"none"}}),!c&&!Y&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("title").toClassName(),children:T.map(e=>e.title).join(" ")})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("tabs-panel").elem("header-right").toClassName(),children:[(!d||Y)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("toggle").mod({detached:d,collapsed:Y,alignment:u}).toClassName(),onClick:he,"data-tooltip":`${J} Group`,children:cC.left===u?(0,ae.jsx)(kn.gu7,{}):(0,ae.jsx)(kn.Vjx,{})}),!Y&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("toggle").mod({detached:d,collapsed:Y,alignment:u}).toClassName(),onClick:ge,"data-tooltip":J,children:c?(0,ae.jsx)(kn.A8g,{}):(0,ae.jsx)(kn.hHu,{})})]})]})]}),c&&!Y&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("tabs-panel").elem("body").toClassName(),children:[D&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("shield").toClassName()}),(()=>{const e=f.Children.only(N);return f.isValidElement(e)&&"Tabs"===e.type.displayName?f.cloneElement(e,{isBottomPanel:O,bottomCollapsed:ee,setBottomCollapsed:te,settings:Q,panelHeight:ne}):N})()]})]}),c&&!b&&!y&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("resizers").mod({locked:b||y}).toClassName(),ref:H,children:RC.map(e=>!Y&&(("left"===e||"right"===e)&&u!==e||d)?(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs-panel").elem("resizer").mod({drag:e===W}).toClassName(),"data-resize":e},e):null)})]})},zC=["children","type","extra","className","size","waiting","icon","tag","look","primary","danger","hotkey","hotkeyScope","displayedHotkey","tooltip","tooltipTheme","nopadding"],BC=(0,f.forwardRef)((e,t)=>{let{children:n,type:i,extra:o,className:s,size:a,waiting:r,icon:l,tag:c,look:d,primary:u,danger:h,hotkey:g,hotkeyScope:m,displayedHotkey:p,tooltip:v,tooltipTheme:y="light",nopadding:b}=e,x=(0,Se.A)(e,zC);const w=null!=c?c:x.href?"a":"button",S={size:a,waiting:r,type:i,danger:h,nopadding:b,look:null!=d?d:[],withIcon:!!l,withExtra:!!o};u&&(S.look="primary");const C=(0,f.useMemo)(()=>{if(!l)return null;if((0,E.isDefined)(l.props.size))return l;switch(a){case"small":return(0,f.cloneElement)(l,Object.assign({},l.props,{size:12,width:12,height:12}));case"compact":return(0,f.cloneElement)(l,Object.assign({},l.props,{size:14,width:14,height:14}));default:return l}},[l,a]);Vn(g,x.onClick,m);const k=(0,f.createElement)(w,Object.assign({ref:t,type:i},x,{className:(0,Nn.cn)("button").mod(S).mix(s).toClassName()}),(0,ae.jsxs)(ae.Fragment,{children:[C&&(0,ae.jsx)("span",{className:(0,Nn.cn)("button").elem("icon").toClassName(),children:C}),C&&n?(0,ae.jsx)("span",{children:n}):n,void 0!==o?(0,ae.jsx)("div",{className:(0,Nn.cn)("button").elem("extra").toClassName(),children:o}):null]}));return g&&(0,E.isDefined)(Fn.keymap[g])||p&&(0,E.isDefined)(Fn.keymap[p])?(0,ae.jsx)(Fn.Tooltip,{name:g||p,title:v,children:k}):v?(0,ae.jsx)(Pn.m_M,{title:v,theme:y,ref:t,children:k}):k});BC.displayName="Button";BC.Group=({className:e,children:t,collapsed:n})=>(0,ae.jsx)("div",{className:(0,Nn.cn)("button-group").mod({collapsed:n}).mix(e).toClassName(),children:t});const FC=[];var HC=function(e){return e.tabLeft="lsf-drag_over_tab_left",e.tabRight="lsf-drag_over_tab_right",e.emptyTabSpace="lsf-drag_over_empty_tab_space",e}(HC||{});const VC=()=>{FC.forEach(e=>{null==e||e.classList.remove(HC.tabLeft),null==e||e.classList.remove(HC.tabRight),null==e||e.classList.remove(HC.emptyTabSpace)})},$C=({name:e,rootRef:t,tabTitle:n,tabIndex:i,panelKey:o,viewLength:s,children:a,active:r,panelWidth:l,locked:c,breakPointActiveTab:d,setBreakPointActiveTab:u,transferTab:h,createNewPanel:g,setActiveTab:m,checkSnap:p})=>{const v=(0,f.useRef)(),y=(0,f.useRef)(),b=(0,f.useRef)(!1),x=(0,f.useRef)({panelKey:o,tabIndex:i}),[w,S]=(0,f.useState)(!1);x.current={panelKey:o,tabIndex:i},yw({elementRef:v,onMouseDown(e){var n;if(c)return void(u&&u(x.current.tabIndex));if(2===e.buttons)return;const{panelKey:i,tabIndex:o}=Object.assign({},x.current);m(i,o),null==(n=t.current)||n.append(y.current),y.current.style.pointerEvents="all";const s=v.current,a=t.current.getBoundingClientRect(),r=s.getBoundingClientRect(),[l,d]=[e.pageX,e.pageY],[h,g]=[r.left-a.left,r.top-a.top];return{x:l,y:d,oX:h,oY:g,panelKey:i,tabIndex:o}},onMouseMove(e,t){var n,s;if(!t)return;document.body.style.cursor="grabbing",null==(n=window.getSelection())||n.removeAllRanges(),b.current=!0;const{x:a,y:r,oX:c,oY:d}=t,u=e.pageY-(r-d),h=e.pageX-(a-c);y.current&&(S(!0),y.current.style.display="block",y.current.style.top=`${u}px`,y.current.style.left=`${h}px`);const g=document.elementsFromPoint(e.clientX,e.clientY).find((e,t)=>e.id.includes("droppable")&&t>0);let m=gC(e,g);const f=null==(s=y.current)?void 0:s.getBoundingClientRect().height;f&&p(h,l,u,f),VC(),(null==g?void 0:g.id)!==`${o}_${i}_droppable`&&(null!=g&&g.id.includes("droppable-space")&&(m=void 0),((e,t)=>{let n;FC.push(t),e===cC.left&&(n=HC.tabLeft),e===cC.right&&(n=HC.tabRight),void 0===e&&(n=HC.emptyTabSpace),n&&(null==t||t.classList.add(n))})(m,g))},onMouseUp(t,n){var i,o;if(VC(),FC.length=0,null==(i=v.current)||i.append(y.current),null!=(o=y.current)&&o.style&&(y.current.style.display="none",S(!1)),document.body.style.cursor="auto",!n||!b.current)return;b.current=!1;const{x:a,y:r,oX:l,oY:c,panelKey:d,tabIndex:u}=n,[m,p]=[t.pageX-(a-l),t.pageY-(r-c)],f=m<0?0:m,x=p-32,w=x<0?0:x,C=document.elementFromPoint(t.clientX,t.clientY);var k,P;if(null==(k=C)||null==(P=k.id)?void 0:P.includes("droppable")){const e=document.elementFromPoint(t.clientX,t.clientY),n=null==e?void 0:e.id;if(!n||null==n||!n.includes("droppable"))return;const i=n.split("_"),o=i[0],a=Number.parseInt(i[1]),r=gC(t,e);if(u===a&&d===o||1===s&&d===o)return;r&&h(u,d,o,a,r)}else g(e,d,u,f,w)}},[]);const C=()=>(0,ae.jsxs)("div",{id:`${o}_${i}_droppable`,className:(0,Nn.cn)("panel-tabs").elem("tab").mod({active:c?i===d:r}).toClassName(),children:[!c&&(0,ae.jsx)(Pn.ORE,{className:(0,Nn.cn)("panel-tabs").elem("icon").toClassName()}),n]});return(0,ae.jsxs)("div",{className:(0,Nn.cn)("panel-tabs").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("panel-tabs").elem("draggable-tab").toClassName(),id:`${n}-draggable`,ref:v,children:(0,ae.jsx)(C,{})}),(0,ae.jsxs)("div",{ref:y,className:(0,Nn.cn)("panel-tabs").elem("ghost-tab").toClassName(),style:{width:`${l}px`,height:"fit-content",maxHeight:"300px",overflow:"hidden"},children:[(0,ae.jsx)(C,{}),w&&(0,ae.jsx)("div",{className:(0,Nn.cn)("panel-tabs").elem("contents").toClassName(),children:a})]})]})},WC=e=>{var t,n;const i=e.locked?e.panelViews[e.breakPointActiveTab].component:null==(t=e.panelViews)||null==(t=t.find(e=>e.active))?void 0:t.component;return(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("tabs").toClassName(),children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("tabs").elem("tabs-row").toClassName(),children:[e.panelViews.map((t,n)=>{const{component:i}=t;return(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs").elem("tab-container").mod({active:t.active}).toClassName(),children:(0,ae.jsx)($C,{name:t.name,rootRef:e.root,panelKey:e.name,tabIndex:n,active:t.active,tabTitle:t.title,panelWidth:e.width,viewLength:e.panelViews.length,locked:e.locked,transferTab:e.transferTab,createNewPanel:e.createNewPanel,setActiveTab:e.setActiveTab,checkSnap:e.checkSnap,breakPointActiveTab:e.breakPointActiveTab,setBreakPointActiveTab:e.setBreakPointActiveTab,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs").elem("content").toClassName(),children:(0,ae.jsx)(i,Object.assign({},e,{name:"outliner"}),`${t.title}-${n}-ghost`)})},`${t.title}-tab`)},`${t.title}-${n}-tab`)}),(0,ae.jsx)("div",{id:`${e.name}_${e.panelViews.length}-droppable-space`,className:(0,Nn.cn)("tabs").elem("drop-space-after").toClassName()}),e.isBottomPanel&&(null==(n=e.settings)?void 0:n.collapsibleBottomPanel)&&(0,ae.jsx)(BC,{className:"collapsible-bottom-panel-toggle",style:{marginLeft:4,marginRight:5,marginTop:4,display:"flex",height:"24px",width:"24px",padding:0,alignItems:"center",background:"none",border:"none",cursor:"pointer"},onClick:()=>null==e.setBottomCollapsed?void 0:e.setBottomCollapsed(!e.bottomCollapsed),title:e.bottomCollapsed?"Expand Bottom Panel":"Collapse Bottom Panel",children:e.bottomCollapsed?(0,ae.jsx)(Pn.hHu,{}):(0,ae.jsx)(Pn.A8g,{})})]}),!e.bottomCollapsed&&(0,ae.jsx)("div",{className:(0,Nn.cn)("tabs").elem("contents").toClassName(),style:{overflow:"auto"},children:i&&(0,ae.jsx)(i,Object.assign({},e))})]})})};WC.displayName="Tabs";const UC=980,GC=(0,b.PA)(({currentEntity:e,panelsHidden:t,children:n,showComments:i,showCustomTab:o,focusTab:s})=>{var a;const r=e.regionStore,l=(0,f.useRef)({width:0,height:0}),c=nC("screen and (max-width: 980px)"),[d,u]=(0,f.useState)(500),[h,g]=(0,f.useState)(!1),[m,p]=(0,f.useState)(!1),[v,y]=(0,f.useState)(!1),[b,x]=(0,f.useState)(!1),w=(0,f.useRef)(),[S,C]=(0,f.useState)(),k=(0,f.useMemo)(()=>jC(i,o),[i,o]),[P,R]=(0,f.useState)(k.panelData),[j,N]=(0,f.useState)(k.collapsedSide),[T,A]=(0,f.useState)(0),I=(0,f.useRef)(S),M=(0,f.useRef)(j),K=(null==e||null==(a=e.store)?void 0:a.settings)||(null==e?void 0:e.settings),D=(0,f.useRef)(null);M.current=j,I.current=S,iC(e);const O=(0,f.useMemo)(()=>!(null==K||!K.forceBottomPanel)||(h||c.matches),[h,c.matches,null==K?void 0:K.forceBottomPanel]),L=(0,f.useCallback)((e,t)=>{R(n=>{const i=Object.assign({},n[e],t);return Object.assign({},n,{[e]:i})})},[P]),z=(0,f.useCallback)((e,t,n,i,o)=>{R(s=>{const a=s[t].panelViews[e];a&&(a.active=!0);const r=mC(s,t,e),c=((e,t,n,i,o,s)=>{const a=Object.assign({},e),r=a[n];r.panelViews=a[n].panelViews.map(e=>(e.active=!1,e));let l=o+(s===cC.right?1:0);return t===n&&l>0&&(l-=1),r.panelViews.splice(l,0,i),a})(yC(r),t,n,a,i,o),d=DC(c,n),u=vC(d),h=fC(u);return IC(h,l.current.height)}),C(void 0)},[P]),B=(0,f.useCallback)((e,t,n,i,o)=>{if(I.current){var s;const a=I.current.split("-"),r=a[0];if(null!=(s=M.current)&&s[r])return;const c="top"===a[1]?uC.top:uC.bottom,d=l.current.height;R(s=>{const a=KC(s,e,t,n,i,o,l);return EC(a,e,r,bw,d,c)})}else R(s=>KC(s,e,t,n,i,o,l));C(void 0)},[P,j,j[cC.left],j[cC.right]]),F=(0,f.useCallback)((e,t)=>R(n=>pC(n,e,t)),[P]),H=(0,f.useCallback)((e,t)=>{R(n=>{const i=P[e],o=$(e,i.top,i.left,t),s=Object.assign({},n,{[e]:Object.assign({},i,{visible:t,storedTop:o.top/l.current.height*100,storedLeft:o.left/l.current.width*100})});return MC(s,l.current.height,i.alignment)})},[R,P]),V=(0,f.useCallback)((e,t,n,i)=>{var o,s,a,r,c,d;const u=e+t,h=n+i,g=null!=(o=l.current.width)?o:0,m=null!=(s=l.current.height)?s:0,p=u>=g-((null==(a=Object.entries(P).find(([e,t])=>t.alignment===cC.right))?void 0:a[1].width)||0),f=e<=((null==(r=Object.entries(P).find(([e,t])=>t.alignment===cC.left))?void 0:r[1].width)||0),v=n<=5,y=h>=m-5;let b;null!=(c=M.current)&&c[cC.left]||!f||(e<=5&&(b=dC.left),v&&(b=dC.topLeft),y&&(b=dC.bottomLeft)),null!=(d=M.current)&&d[cC.right]||!p||(u>=g-5&&(b=dC.right),v&&(b=dC.topRight),y&&(b=dC.bottomRight)),C(b)},[P]),$=(0,f.useCallback)((e,t,n,i)=>{var o,s,a,r,l;const c=P[e],d=null!=(o=null==(s=w.current)?void 0:s.clientWidth)?o:0,u=(null!=i?i:c.visible)?c.height:Sw,h=c.detached?u:c.height,g=c.height!==(null==(a=w.current)?void 0:a.clientHeight)&&c.detached?h:xw;return{left:(0,E.clamp)(n,0,d-c.width),top:(0,E.clamp)(t,0,(null!=(r=null==(l=w.current)?void 0:l.clientHeight)?r:0)-g)||1}},[P]),W=(0,f.useCallback)(e=>{p(()=>!0),R(t=>DC(t,e))},[P]),U=(0,f.useCallback)((e,t,n,i)=>{const o=P[e],{left:s,top:a}=$(e,t,n,o.visible),r=l.current.height-a;v||P[e].detached||(y(!0),R(t=>((e,t,n)=>{const i=Object.assign({},e),o=i[t].alignment,s={width:bw,detached:!0,height:xw},a=Object.assign({},i,{[t]:Object.assign({},i[t],s)}),r=AC(i,o);return null==r||r.forEach((e,t)=>{i[e].order=t}),MC(a,n,o)})(t,e,l.current.height))),V(s,o.width,a,xw),requestAnimationFrame(()=>{L(e,{top:a,left:s,relativeTop:a/l.current.height*100,relativeLeft:s/l.current.width*100,storedLeft:void 0,storedTop:void 0,detached:i,zIndex:Object.keys(P).length+12,maxHeight:r,alignment:i?void 0:o.alignment})})},[L,V,P,v]),G=(0,f.useCallback)(()=>{p(()=>!0)},[]),Y=(0,f.useCallback)(()=>{p(()=>!1)},[]),X=(0,f.useCallback)((e,t,n)=>{requestAnimationFrame(()=>{R(i=>((e,t,n,i,o)=>{var s;const a=Object.assign({},e),r=AC(a,null==(s=a[t])?void 0:s.alignment),l=o;if(!r)return e;const c=n-a[t].height,d=r.filter(e=>a[e].visible),u=(null==d?void 0:d.findIndex(e=>e===t))-1;if(void 0===u)return e;const h=d[u];r.forEach(e=>{let s=a[e].height;e===t&&(s=n),e===h&&(s-=c),n<=55&&(n=55),a[e].visible&&(a[e]=Object.assign({},a[e],{relativeTop:i/o*100,storedLeft:void 0,storedTop:void 0,maxHeight:l,height:(0,E.clamp)(s,55,o)}))});const g=r.filter(e=>!a[e].visible).length*Sw,m=r.filter(e=>a[e].visible).reduce((e,t)=>e+a[t].height,0);return IC(m+g>o?e:a,o)})(i,e,t,n,l.current.height))})},[R]),q=(0,f.useCallback)(e=>Object.keys(P).filter(t=>{var n;return(null==(n=P[t])?void 0:n.alignment)===e}),[P]),Z=(0,f.useCallback)((e,t,n,i,o)=>{const{left:s,top:a}=$(e,i,o),r=l.current.height-a;requestAnimationFrame(()=>{var i;(P[e].detached?[e]:q(null==(i=P[e])?void 0:i.alignment)).forEach(e=>{L(e,{top:a,left:s,relativeTop:a/l.current.height*100,relativeLeft:s/l.current.width*100,storedLeft:void 0,storedTop:void 0,maxHeight:r,width:(0,E.clamp)(t,bw,d),height:P[e].detached?(0,E.clamp)(n,xw,ww):P[e].height}),C(void 0)})})},[L,d,P]),J=(0,f.useCallback)(e=>{var t;if(y(!1),p(()=>!1),!I.current)return;const n=I.current.split("-"),i=n[0],o="top"===n[1]?uC.top:uC.bottom,s=null==(t=AC(P,i))?void 0:t.filter(t=>t!==e);s&&s.length>0?R(t=>EC(t,e,i,bw,l.current.height,o)):L(e,{height:l.current.height,alignment:i,detached:!1}),C(void 0)},[L,P]),Q=(0,f.useMemo)(()=>({onResize:Z,onGroupHeightResize:X,onResizeStart:G,onResizeEnd:Y,onPositionChange:U,onVisibilityChange:H,onPositionChangeBegin:W,onSnap:J,transferTab:z,createNewPanel:B,setActiveTab:F,checkSnap:V,setBreakPointActiveTab:A}),[Z,X,G,Y,U,H,J,z,B,F]),ee=(0,f.useMemo)(()=>Object.assign({},Q,{root:w,regions:r,selection:r.selection,currentEntity:e}),[Q,r,r.selection,e]),te=(0,f.useMemo)(()=>{const e=TC(P),n=_C(P),i=e.every(e=>!P[e].visible),o=n.every(e=>!P[e].visible),{left:s,right:a}=j,r=e.length&&P[e[0]].width||0,l=n.length&&P[n[0]].width||0;return{paddingLeft:O||t?0:s?Sw:i?0:r,paddingRight:O||t?0:a?Sw:o?0:l}},[t,P,j,O]),ne=(0,f.useMemo)(()=>{if(t)return{};const e={detached:[],left:[],right:[]},n=Object.entries(P);for(const[t,s]of n){var i,o;const{alignment:n,detached:a}=s,r=AC(P,n),l=Object.assign({},s,ee,{name:t,top:null!=(i=s.storedTop)?i:s.top,left:null!=(o=s.storedLeft)?o:s.left,positioning:v,maxWidth:d,zIndex:s.zIndex,expanded:j[n],alignment:s.alignment,locked:O,attachedKeys:r,lockPanelContents:m,breakPointActiveTab:T,sidePanelCollapsed:j,setSidePanelCollapsed:N,dragTop:n===cC.left?S===dC.topLeft:S===dC.topRight,dragBottom:n===cC.left?S===dC.bottomLeft:S===dC.bottomRight});a?e.detached.push(l):"left"===n?e.left.push(l):"right"===n&&e.right.push(l)}return e},[P,ee,m,t,O,v,d,j,S]);(0,f.useEffect)(()=>{Object.keys(P).length&&((e,t)=>{window.localStorage.setItem("panelState",JSON.stringify({panelData:e,collapsedSide:t}))})(P,j)},[P,j]),(0,f.useEffect)(()=>{if(s){const e=Object.assign({},P),t=((e,t)=>{var n;const i=Object.keys(e).find(e=>e.includes(t))||"",o=null==(n=e[i])?void 0:n.panelViews.findIndex(e=>e.name===t);return o>=0?{panelName:i,tab:e[i].panelViews[o],panelViewIndex:o}:void 0})(e,s);if(!t)return;const{panelName:n,tab:i,panelViewIndex:o}=t,{alignment:a,detached:r,visible:l}=e[n];i.active||R(pC(e,n,o)),!r&&j[a]&&N(Object.assign({},j,{[a]:!1})),l||H(n,!0)}},[s]),(0,f.useEffect)(()=>{const e=w.current;if(!e)return;const t=()=>{var e,t;return(null!=(e=null==(t=w.current)?void 0:t.clientWidth)?e:0)<UC},n=new _(()=>{requestAnimationFrame(()=>{if(!w.current)return;const{clientWidth:e,clientHeight:n}=w.current;e<=UC||(l.current.height!==n&&R(IC(P,n)),l.current.width=null!=e?e:0,l.current.height=null!=n?n:0,g(t()),u(.4*w.current.clientWidth))})});return e&&(n.observe(e),g(t()),u(.4*e.clientWidth),x(!0)),()=>{e&&n.unobserve(e),n.disconnect()}},[P]);const ie=(0,f.useMemo)(()=>({locked:O}),[]),oe=(0,f.useMemo)(()=>{const e=Object.assign({},PC);return e.panelViews=PC.panelViews.filter(e=>"comments"!==e.name||i),e},[PC,i]),se=Object.assign({},oe,ee,{breakPointActiveTab:T,setBreakPointActiveTab:A});return(0,ae.jsx)(VS.Provider,{value:ie,children:(0,ae.jsx)("div",{ref:e=>{e&&(w.current=e,g(e.clientWidth<=UC))},className:(0,Nn.cn)("sidepanels").mod({collapsed:O}).toClassName(),style:Object.assign({},te),children:b&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{ref:D,className:(0,Nn.cn)("sidepanels").elem("content").mod({resizing:m||v}).toClassName(),children:n}),!0!==t&&O?(0,ae.jsx)(ae.Fragment,{children:(0,ae.jsx)("div",{className:(0,Nn.cn)("sidepanels").elem("wrapper").toClassName(),children:(0,ae.jsx)(LC,Object.assign({},se,{contentRef:D,isBottomPanel:!0,children:(0,ae.jsx)(WC,Object.assign({},se))}))})}):(0,ae.jsx)(ae.Fragment,{children:Object.entries(ne).map(([e,t],n)=>{const i=t.sort((e,t)=>e.order-t.order).map((t,i)=>(0,ae.jsx)(LC,Object.assign({},t,{children:(0,ae.jsx)(WC,Object.assign({},t))}),`${e}-${i}-${n}`));return"detached"===e?(0,ae.jsx)(f.Fragment,{children:i},e):(0,ae.jsx)("div",{className:(0,Nn.cn)("sidepanels").elem("wrapper").mod({align:e,snap:!m&&S===e&&void 0!==S}).toClassName(),children:i},e)})})]})})})});var YC=n(1671),XC=n(13986),qC=n.n(XC),ZC=n(4583),JC=n(8593),QC=n(49589),ek=n(57958);const tk=["date"],nk=6e4,ik=[[3e4,3e4],[267e4,nk],[Number.MAX_SAFE_INTEGER,18e5]];const ok=e=>{let{date:t}=e,n=(0,Se.A)(e,tk);const[i,o]=(0,f.useState)(Date.now()),s=(0,f.useMemo)(()=>new Date(t).valueOf(),[t]),a=(0,f.useRef)(),r=(0,f.useCallback)(()=>{const e=Date.now()-s,t=function(e=0){const t=ik.findIndex(([t],n)=>t>e||n===ik.length-1),n=t>0?ik[t-1][0]:0,i=ik[t][1];return Math.ceil((e-n+1)/i)*i+n}(e);a.current=window.setTimeout(()=>{o(Date.now())},t-e)},[t]);(0,f.useEffect)(()=>(r(),()=>{clearTimeout(a.current)}),[t,i]);const l="less than a minute ago"===(0,ek.A)(s,{addSuffix:!0})?"seconds ago":(0,ek.A)(s,{addSuffix:!0});return(0,ae.jsx)("time",Object.assign({dateTime:(0,JC.default)(s,"yyyy-MM-dd'T'HH:mm:ss.SSSxxx"),title:(0,JC.default)(s,"PPpp")},n,{children:l}))};var sk=n(78968);const ak=e=>e.unresolved_comment_count>0?"Unresolved Comments":e.comment_count>0?"All Comments Resolved":"",rk=(0,b.WQ)(({store:e})=>({store:e})),lk=(e,t)=>({label:e,backgroundColor:`var(--color-accent-${t}-subtle)`,color:`var(--color-accent-${t}-bold)`}),ck=e=>({backgroundColor:`var(--color-accent-${e}-subtle)`,color:`var(--color-accent-${e}-bold)`});function dk({displayUsername:e,isDraft:t,isDraftSaved:n,isPrediction:i,isSkipped:o,isSubmitted:s,isGroundTruth:a,acceptedState:r,predictionScore:l,lastUpdated:c,annotationId:d,containerRef:u,isTooltipOpen:g,onMouseEnter:m,onMouseLeave:p,position:v}){const y=(0,f.useMemo)(()=>{if(i)return null;if(t||n)return lk("Draft","grape");if(r)switch(r){case"accepted":return lk("Accepted","kale");case"rejected":return lk("Rejected","persimmon");case"fixed":case"fixed_and_accepted":return lk("Fixed","canteloupe")}return s&&!o?lk("Submitted","kale"):null},[i,t,n,r,s,o]),b=(0,f.useCallback)(e=>{if(!e)return null;try{const t=new Date(e);return(0,ZC.default)(t)?(0,JC.default)(t,"MMM dd yyyy, HH:mm:ss"):null}catch(e){return null}},[]),x=(0,f.useMemo)(()=>{const e=[];if(d&&e.push({label:"Annotation ID",value:String(d)}),i?(e.push({label:"Type",value:"Prediction"}),(0,QC.O9)(l)&&e.push({label:"Prediction Score",value:`${(100*l).toFixed(2)}%`})):e.push({label:"Type",value:"Annotation"}),c){const t=b(c);t&&e.push({label:"Last Updated",value:t})}return e},[d,i,l,c,b]);if(!(x.length>0||!!e||!!y||!!o||!!a||!!d))return null;if(!g||!v)return null;const w=(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("tooltipContainer").mod({open:g}).toClassName(),ref:u,onMouseEnter:m,onMouseLeave:p,style:{position:"fixed",top:`${v.top}px`,left:`${v.left}px`},children:[(y||o||a)&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("tooltipBadges").toClassName(),children:[y&&(0,ae.jsx)(Pn.Exy,{className:(0,Nn.cn)("annotation-button").elem("tooltipStatusBadge").toClassName(),style:{backgroundColor:y.backgroundColor,color:y.color,border:"none"},children:y.label}),o&&(0,ae.jsx)(Pn.Exy,{className:(0,Nn.cn)("annotation-button").elem("tooltipStatusBadge").toClassName(),style:Object.assign({},ck("persimmon"),{border:"none"}),children:"Skipped"}),a&&(0,ae.jsx)(Pn.Exy,{className:(0,Nn.cn)("annotation-button").elem("tooltipStatusBadge").toClassName(),style:Object.assign({},ck("canteloupe"),{border:"none"}),children:"Ground Truth"})]}),e&&(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("tooltipContainerTitle").toClassName(),children:e}),x.length>0&&(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("tooltipContainerInfo").toClassName(),children:x.map((e,t)=>(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("infoRow").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("infoRowLabel").toClassName(),children:e.label}),(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("infoRowValue").toClassName(),children:e.value})]},`${e.label}-${e.value}-${t}`))})]});return"undefined"!=typeof document?(0,h.createPortal)(w,document.body):null}const uk=rk((0,b.PA)(({entity:e,capabilities:t,store:n,isGroundTruth:i,iconSize:o,onAnnotationChange:s,annotationStore:a})=>{var r,l,c,d,h;const g=(0,u._n)(e),m=(0,f.useMemo)(()=>{if(!g||!e.pk)return"";const t=new URL(window.location.href);return e.pk&&t.searchParams.set("annotation",e.pk),t.searchParams.delete("region"),t.toString()},[g,e.pk]),[p]=(0,He.sc)({defaultText:m}),v=(0,Pn.djX)(),y=(0,Pn.BKH)(),b=()=>{null==s||s(),null==y||y.close()},x=(0,f.useCallback)(()=>{e.setGroundTruth(!i),b()},[e,i]),w=(0,f.useCallback)(()=>{const t=a.addAnnotationFromPrediction(e);window.setTimeout(()=>{a.selectAnnotation(t.id,{exitViewAll:!0}),b()})},[e,a]),S=(0,f.useCallback)(()=>{p(),null==y||y.close(),null==v||v.show({message:"Annotation link copied to clipboard",type:Pn.CkR.info})},[p,v,y]),[C]=(0,He.sc)({defaultText:null!=(r=null!=(l=null==(c=e.pk)?void 0:c.toString())?l:null==(d=e.id)?void 0:d.toString())?r:""}),k=(0,f.useCallback)(()=>{C(),null==y||y.close(),null==v||v.show({message:"Annotation ID copied to clipboard",type:Pn.CkR.info})},[C,v,y]),P=(0,f.useCallback)(()=>{var t,n;if(!("Enterprise"===(null==(t=window.APP_SETTINGS)||null==(t=t.version)?void 0:t.edition)))return;const i=new URL(window.location.origin),o=(0,Ne.VS)("fflag_feat_all_fit_778_analytics_short");i.pathname=o?"/analytics/member-performance":"/performance",null!=(n=e.user)&&n.id&&i.searchParams.set("user",e.user.id);const s=window.location.pathname.match(/\/projects\/(\d+)/);s&&i.searchParams.set("project",s[1]),window.open(i.toString(),"_blank"),null==y||y.close()},[e,y]),R=(0,f.useCallback)(()=>{a.toggleViewingAllAnnotations(),b()},[a,s]),j=(0,f.useCallback)(()=>{b(),(0,sk.lJ)({title:"Delete annotation?",body:(0,ae.jsxs)(ae.Fragment,{children:["This will ",(0,ae.jsx)("strong",{children:"delete all existing regions"}),". Are you sure you want to delete them?",(0,ae.jsx)("br",{}),"This action cannot be undone."]}),buttonLook:"negative",okText:"Delete",onOk:()=>{e.list.deleteAnnotation(e)}})},[e,s]),N="prediction"===e.type,T=!(0,QC.O9)(e.pk),_=t.groundTruthEnabled&&!N&&!T,A=t.enableCreateAnnotation&&!T,I="Enterprise"===(null==(h=window.APP_SETTINGS)||null==(h=h.version)?void 0:h.edition),M=!!window.location.pathname.match(/\/projects\/(\d+)/),E=(0,f.useMemo)(()=>[{label:"Copy Annotation ID",onClick:k,icon:(0,ae.jsx)(kn.QGK,{width:20,height:20}),enabled:!T},{label:(i?"Unset ":"Set ")+" as Ground Truth",onClick:x,icon:i?(0,ae.jsx)(kn.aGI,{color:"#FFC53D",width:o,height:o}):(0,ae.jsx)(kn.gkI,{width:o,height:o}),enabled:_},{label:"Duplicate Annotation",onClick:w,icon:(0,ae.jsx)(kn.FEH,{width:20,height:20}),enabled:A},{label:"Copy Annotation Link",onClick:S,icon:(0,ae.jsx)(kn.AXG,{}),enabled:!T&&n.hasInterface("annotations:copy-link")},{label:"Open Performance Dashboard",onClick:P,icon:(0,ae.jsx)(kn.kTm,{width:20,height:20}),enabled:I&&M&&!T&&!N},{label:"Show Other Annotations",onClick:R,icon:(0,ae.jsx)(kn.M7M,{width:20,height:20}),enabled:!0},{label:"Delete Annotation",onClick:j,icon:(0,ae.jsx)(kn.Wus,{}),separator:!0,danger:!0,enabled:t.enableAnnotationDelete&&!N}],[e,i,N,T,I,M,t.enableAnnotationDelete,t.enableCreateAnnotation,t.groundTruthEnabled,k,P,R,j,x,w,S,o,n]);return g?(0,ae.jsx)(kS,{actions:E}):null})),hk=(0,b.PA)(({entity:e,capabilities:t,annotationStore:n,onAnnotationChange:i})=>{var o,s,a,r,l;const c=(0,u._n)(e),d=!!c&&"prediction"===e.type,h=c?(0,QC.Jf)(null!=(o=e.user)?o:{firstName:e.createdBy||"Admin"}):"Unknown",[g,m]=(0,f.useState)(),p=c&&!d&&!(0,QC.O9)(e.pk),v=c&&!d&&e.draftId>0,y=c&&!d&&!0===e.skipped,b=c&&!d&&!p&&!v,x=null==(s=n.store)?void 0:s.hasInterface("annotations:hide-info");let w=null;const S=(0,f.useRef)(),C=(0,f.useRef)(),k=(0,f.useRef)(),P=(0,f.useRef)(),R=(0,f.useRef)(),[j,N]=(0,f.useState)(!1),[T,_]=(0,f.useState)(void 0),[A,I]=(0,f.useState)(!1);if(x&&c){var M;const t=n.store.user;w={email:(null==(M=e.user)?void 0:M.id)===t.id||e.createdBy===t.email?"Me":"User"}}const E=w?w.email:h,K=(e=>{if(!e||e.includes("@"))return!1;const t=e.trim().split(/\s+/);return!(t.length<2)&&t.every(e=>/^[a-zA-Z-]+$/.test(e)&&e.length>=2)})(E)?E.length>15?(e=>{if(e.length<=15)return e;const t=e.trim().split(/\s+/);return 0===t.length||1===t.length?e:[t[0],...t.slice(1,-1).map(e=>`${e[0]}.`),`${t[t.length-1][0]}.`].join(" ")})(E):E:E.length>15?qC()(E,8,6,"..."):E,D=(O=e).unresolved_comment_count>0?kn.qLl:O.comment_count>0?kn.f31:null;var O;(0,f.useEffect)(()=>{c&&m(e.ground_truth)},[c,e,e.ground_truth]),(0,f.useEffect)(()=>{function e(e){var t,n;const i=e.target;null!=(t=S.current)&&t.contains(i)||null!=(n=k.current)&&n.contains(i)||N(!1)}return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,f.useEffect)(()=>{const e=e=>{if(window.lastMouseX=e.clientX,window.lastMouseY=e.clientY,j){var t,n;const i=document.elementFromPoint(e.clientX,e.clientY),o=i&&(null==(t=k.current)?void 0:t.contains(i)),s=i&&(null==(n=S.current)?void 0:n.contains(i)),a=null==i||null==i.closest?void 0:i.closest(".annotation-button__trigger");o||s&&!a||N(!1)}};return document.addEventListener("mousemove",e),()=>{document.removeEventListener("mousemove",e)}},[j]),(0,f.useEffect)(()=>()=>{P.current&&clearTimeout(P.current),R.current&&clearTimeout(R.current)},[]);const L=(0,f.useCallback)(()=>{if(S.current){const e=S.current.getBoundingClientRect(),t=250,n=100,i=window.innerHeight-e.bottom,o=e.top;let s,a;s=i<n+20&&o>i?e.top-n-12:e.bottom+12,a=e.left+e.width/2-t/2,a+t>window.innerWidth-20&&(a=window.innerWidth-t-20),a<20&&(a=20),_({top:s,left:a}),requestAnimationFrame(()=>{if(k.current){const t=k.current.getBoundingClientRect(),n=e.left+e.width/2-t.left;k.current.style.setProperty("--tooltip-arrow-position",`${n}px`)}})}},[]),z=(0,f.useCallback)(e=>{var t;if(A)return;R.current&&(clearTimeout(R.current),R.current=void 0);(null==(t=e.target)||null==t.closest?void 0:t.closest(".annotation-button__trigger"))||(P.current&&clearTimeout(P.current),P.current=window.setTimeout(()=>{L(),N(!0)},300))},[L,A]),B=(0,f.useCallback)(e=>{var t,n;P.current&&(clearTimeout(P.current),P.current=void 0),R.current&&clearTimeout(R.current);const i=e.relatedTarget||e.relatedTarget,o=i&&(null==(t=k.current)?void 0:t.contains(i)),s=i&&(null==(n=S.current)?void 0:n.contains(i)),a=null==i||null==i.closest?void 0:i.closest(".annotation-button__trigger");o||s&&!a||(R.current=window.setTimeout(()=>{const e=window.lastMouseX,t=window.lastMouseY;if(void 0!==e&&void 0!==t){var n,i;const o=document.elementFromPoint(e,t),s=o&&(null==(n=k.current)?void 0:n.contains(o)),a=o&&(null==(i=S.current)?void 0:i.contains(o)),r=null==o||null==o.closest?void 0:o.closest(".annotation-button__trigger");s||a&&!r||N(!1)}else N(!1);R.current=void 0},100))},[]),F=(0,f.useCallback)(()=>{R.current&&(clearTimeout(R.current),R.current=void 0),N(!1)},[]),H=(0,f.useCallback)(()=>{A||(P.current&&clearTimeout(P.current),P.current=window.setTimeout(()=>{L(),N(!0)},300))},[L,A]),V=(0,f.useCallback)(()=>{N(!1),P.current&&(clearTimeout(P.current),P.current=void 0),R.current&&(clearTimeout(R.current),R.current=void 0)},[]),$=(0,f.useCallback)(()=>{if(!c)return;const{selected:t,id:i,type:o}=e;t||("prediction"===o?n.selectPrediction(i,{exitViewAll:!0}):n.selectAnnotation(i,{exitViewAll:!0}))},[c,e,n]),W=(0,f.useCallback)(()=>{var t,i,o;if(!("Enterprise"===(null==(t=window.APP_SETTINGS)||null==(t=t.version)?void 0:t.edition))||!c||d)return null;const s=null==n||null==(i=n.store)?void 0:i.task,a=null==s||null==(o=s.dataObj)?void 0:o.source;if(!a)return null;try{var r,l;const t="string"==typeof a?JSON.parse(a):a,n=null==t?void 0:t.annotators,i=null==t?void 0:t.annotations;if(!Array.isArray(n)||!Array.isArray(i))return null;const o=i.findIndex(t=>!(!e.pk||!t.id)&&String(t.id)===String(e.pk));return-1===o||o>=n.length?null:null!=(r=null==(l=n[o])?void 0:l.review)?r:null}catch(e){return null}},[c,d,n,e.pk]);if(!c)return null;const U=W(),G=(e=>{if(!e)return null;let t=null,n="";switch(e){case"accepted":t=kn.TA3,n="accepted";break;case"rejected":t=kn.zaR,n="rejected";break;case"fixed":case"fixed_and_accepted":t=kn.TA3,n="fixed";break;default:return null}const i=(0,Nn.cn)("userpic-badge"),o=(0,_g.A)(i.toString(),i.mod({[n]:!0}).toString());return(0,ae.jsx)("div",{className:o,children:(0,ae.jsx)(t,{})})})(U);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").mod({selected:e.selected,groundTruth:g,draft:p&&!v,draftSaved:v,submitted:b,skipped:y,triggerOpened:A}).toClassName(),"data-annotation-id":null!=(a=e.pk)?a:e.id,ref:S,onMouseEnter:z,onMouseLeave:B,onFocus:H,onBlur:B,children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("mainSection").toClassName(),onClick:$,ref:C,children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("picSection").toClassName(),children:(0,ae.jsx)(Pn.an1,{className:(0,Nn.cn)("annotation-button").elem("userpic").mod({prediction:d}).toClassName(),block:"lsf-annotation-button",username:d?e.createdBy:null,user:null!=(r=null!=w?w:e.user)?r:{email:e.createdBy},size:24,badge:G?{bottomRight:G}:void 0,children:d&&(0,ae.jsx)(kn.ccx,{style:{width:18,height:18}})})}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("main").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("user").toClassName(),children:(0,ae.jsx)("span",{className:(0,Nn.cn)("annotation-button").elem("name").toClassName(),children:K})}),!x&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("info").toClassName(),children:[(0,ae.jsx)(ok,{className:(0,Nn.cn)("annotation-button").elem("date").toClassName(),date:e.createdDate}),d&&(0,QC.O9)(e.score)&&(0,ae.jsxs)("span",{title:`Prediction score = ${e.score}`,children:[" Â· "," ",(100*e.score).toFixed(2),"%"]})]})]}),!d&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotation-button").elem("icons").toClassName(),children:[(e.draftId>0||p)&&(0,ae.jsx)(Pn.m_M,{title:"Draft",children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("icon").mod({draft:!0}).toClassName(),children:(0,ae.jsx)(kn.jrm,{color:"#617ADA"})})}),e.skipped&&(0,ae.jsx)(Pn.m_M,{title:"Skipped",children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("icon").mod({skipped:!0}).toClassName(),children:(0,ae.jsx)(kn.f0x,{color:"#DD0000"})})}),g&&(0,ae.jsx)(Pn.m_M,{title:"Ground-truth",children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("icon").mod({groundTruth:!0}).toClassName(),children:(0,ae.jsx)(kn.h1n,{})})}),D&&(0,ae.jsx)(Pn.m_M,{title:ak(e),children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("icon").mod({comments:!0}).toClassName(),children:(0,ae.jsx)(D,{})})})]}),(0,ae.jsx)(dk,{displayUsername:E,isDraft:p,isDraftSaved:v,isPrediction:d,isSkipped:y,isSubmitted:b,isGroundTruth:g,acceptedState:U,predictionScore:d?e.score:null,lastUpdated:e.createdDate,annotationId:null!=(l=e.pk)?l:e.id,containerRef:k,isTooltipOpen:j,onMouseEnter:z,onMouseLeave:F,position:T})]}),c&&(0,ae.jsx)(Pn.uuj,{content:(0,ae.jsx)(uk,{entity:e,capabilities:t,annotationStore:n,store:n.store,isGroundTruth:g,iconSize:32,onAnnotationChange:i}),onToggle:e=>{I(e),e&&(N(!1),P.current&&(clearTimeout(P.current),P.current=void 0))},children:(0,ae.jsx)("div",{className:(0,Nn.cn)("annotation-button").elem("trigger").toClassName(),onMouseEnter:V,onClick:e=>e.stopPropagation(),children:(0,ae.jsx)(kn.ViA,{width:20,height:20})})})]})}),gk=({index:e,style:t,data:n})=>{const i=n.entities[e];return(0,ae.jsx)("div",{style:Object.assign({},t,{paddingRight:4}),children:(0,ae.jsx)(hk,{entity:i,capabilities:n.capabilities,annotationStore:n.annotationStore,store:n.store},null==i?void 0:i.id)})},mk=(0,b.PA)(({store:e,annotationStore:t})=>{var n;const[i,o]=(0,f.useState)([]),s=e.hasInterface("annotations:tabs"),a=e.hasInterface("predictions:tabs"),r=e.hasInterface("annotations:add-new"),l=e.hasInterface("ground-truth"),c=e.hasInterface("annotations:delete"),d=(0,f.useRef)(null),u=(0,f.useRef)(),h=(0,f.useRef)(),[g,m]=(0,f.useState)(0),[p,v]=(0,f.useState)(0),[y,b]=(0,f.useState)(0),[x,w]=(0,f.useState)(!1),[S,C]=(0,f.useState)(!1),k=(0,f.useMemo)(()=>({enablePredictions:a,enableCreateAnnotation:r,groundTruthEnabled:l,enableAnnotations:s,enableAnnotationDelete:c}),[a,r,l,s,c]),P=(0,f.useMemo)(()=>(0,E.sortAnnotations)(i),[i]),R=204*P.length,j=(0,YC.$m)(YC.mQ)&&P.length>50,N=g<=0,T=g>=R-p,_=R>p,A=(0,f.useCallback)(({scrollOffset:e})=>{m(e)},[]),I=(0,f.useCallback)(()=>{if(d.current){const e=Math.max(0,g-p);d.current.scrollTo(e)}},[g,p]),M=(0,f.useCallback)(()=>{if(d.current){const e=R-p,t=Math.min(e,g+p);d.current.scrollTo(t)}},[g,p,R]),K=(0,f.useCallback)((e,t=!0)=>{if(h.current&&u.current){const e=h.current.clientWidth,n=u.current.clientWidth,i=(0,E.clamp)(t?y-e:y+e,0,n-e);b(i)}},[h,u,y]);(0,f.useEffect)(()=>{var e,t,n,i;j||(w(y<=0),C(y>=(null!=(e=null==(t=u.current)?void 0:t.clientWidth)?e:0)-(null!=(n=null==(i=h.current)?void 0:i.clientWidth)?n:0)))},[P.length,h.current,u.current,y,j]),(0,f.useEffect)(()=>{if(j&&d.current&&t.selected){const e=P.findIndex(e=>{var n;return(null==e?void 0:e.id)===(null==(n=t.selected)?void 0:n.id)});e>=0&&d.current.scrollToItem(e,"center")}},[null==(n=t.selected)?void 0:n.id,P,j]),(0,f.useEffect)(()=>{const e=[];a&&e.push(...t.predictions),s&&e.push(...t.annotations),o(e)},[t,JSON.stringify(t.predictions),JSON.stringify(t.annotations)]);const D=(0,f.useMemo)(()=>({entities:P,capabilities:k,annotationStore:t,store:e}),[P,k,t,e]);return s||a||r?j?(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-carousel").mod({scrolled:g>0,virtualized:!0}).toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-carousel").elem("container").toClassName(),children:(0,ae.jsx)(px.Ay,{children:({width:e,height:t})=>(e!==p&&v(e-77),(0,ae.jsx)(Hu.Y1,{ref:d,layout:"horizontal",height:t,width:e-77,itemCount:P.length,itemSize:204,itemData:D,onScroll:A,overscanCount:5,style:{paddingLeft:4},children:gk}))})}),_&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-carousel").elem("carousel-controls").toClassName(),children:[(0,ae.jsx)(Pn.$nd,{disabled:N,"aria-label":"Carousel left",size:"small",variant:"neutral",onClick:I,children:(0,ae.jsx)(Pn.gu7,{})}),(0,ae.jsx)(Pn.$nd,{disabled:T,"aria-label":"Carousel right",size:"small",variant:"neutral",onClick:M,children:(0,ae.jsx)(Pn.Vjx,{})})]})]}):(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-carousel").mod({scrolled:y>0}).toClassName(),style:{"--carousel-left":`${y}px`},children:[(0,ae.jsx)("div",{ref:h,className:(0,Nn.cn)("annotations-carousel").elem("container").toClassName(),children:(0,ae.jsx)("div",{ref:u,className:(0,Nn.cn)("annotations-carousel").elem("carosel").toClassName(),children:P.map(n=>(0,ae.jsx)(hk,{entity:n,capabilities:k,annotationStore:t,store:e},null==n?void 0:n.id))})}),(!x||!S)&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-carousel").elem("carousel-controls").toClassName(),children:[(0,ae.jsx)(Pn.$nd,{disabled:x,"aria-label":"Carousel left",size:"small",variant:"neutral",onClick:e=>!x&&K(e,!0),children:(0,ae.jsx)(Pn.gu7,{})}),(0,ae.jsx)(Pn.$nd,{disabled:S,"aria-label":"Carousel right",size:"small",variant:"neutral",onClick:e=>!S&&K(e,!1),children:(0,ae.jsx)(Pn.Vjx,{})})]})]}):null}),pk=(0,b.PA)(({isActive:e,onClick:t})=>(0,ae.jsx)("button",{type:"button",className:(0,Nn.cn)("view-all-toggle").mod({selected:e}).toClassName(),onClick:t,"aria-label":"Compare all annotations","aria-pressed":e,"data-testid":"compare-all-toggle",children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("view-all-toggle").elem("mainSection").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("view-all-toggle").elem("iconContainer").toClassName(),children:(0,ae.jsx)(kn.M7M,{})}),(0,ae.jsx)("div",{className:(0,Nn.cn)("view-all-toggle").elem("content").toClassName(),children:(0,ae.jsx)(Pn.o5u,{variant:"label",size:"small",className:(0,Nn.cn)("view-all-toggle").elem("label").toClassName(),children:"Compare All"})})]})})),fk=(0,b.PA)(({entity:e})=>{const{history:t}=e;return(0,ae.jsxs)("div",{className:(0,Nn.cn)("history-buttons").toClassName(),children:[(0,ae.jsx)(Pn.$nd,{variant:"neutral",look:"string","aria-label":"Undo",className:"!p-0",tooltip:"Undo",disabled:!(null!=t&&t.canUndo),onClick:()=>e.undo(),children:(0,ae.jsx)(kn.GFc,{})}),(0,ae.jsx)(Pn.$nd,{variant:"neutral",look:"string","aria-label":"Redo",className:"!p-0",tooltip:"Redo",disabled:!(null!=t&&t.canRedo),onClick:()=>e.redo(),leading:(0,ae.jsx)(kn.cHj,{})}),(0,ae.jsx)(Pn.$nd,{look:"string",variant:"negative","aria-label":"Reset",tooltip:"Reset",className:"!p-0",disabled:!(null!=t&&t.canUndo),onClick:()=>null==t?void 0:t.reset(),leading:(0,ae.jsx)(kn.CA7,{})})]})}),vk=({store:e})=>{const t=e.annotationStore,n=t.selected,i=!n.userGenerate||n.sentUserGenerate,o="prediction"===(null==n?void 0:n.type),s=t.viewingAll,a=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&e.hasInterface("annotation:bulk"),r=(0,f.useCallback)(()=>{t.toggleViewingAllAnnotations()},[t]);return(0,ae.jsxs)("div",{className:(0,Nn.cn)("topbar").elem("section").toClassName(),children:[e.hasInterface("annotations:view-all")&&!a&&(0,ae.jsx)(Pn.m_M,{title:"Compare all annotations",children:(0,ae.jsx)(Pn.$nd,{icon:(0,ae.jsx)(kn.M7M,{}),"aria-label":"Compare all annotations",onClick:()=>r(),variant:s?"primary":"neutral",look:s?"filled":"string",style:{height:36,width:36,padding:0}})}),!s&&!a&&e.hasInterface("ground-truth")&&(0,ae.jsx)(Zb,{entity:n}),!o&&!s&&e.hasInterface("edit-history")&&(0,ae.jsx)(fk,{entity:n}),!s&&!a&&e.hasInterface("annotations:delete")&&(0,ae.jsx)(Pn.m_M,{title:"Delete annotation",children:(0,ae.jsx)(Pn.$nd,{icon:(0,ae.jsx)(kn.Eau,{}),variant:"negative",look:"string",type:"text","aria-label":"Delete",onClick:()=>{(0,sk.lJ)({title:"Delete annotation",body:"This action cannot be undone",buttonLook:"destructive",okText:"Proceed",onOk:()=>n.list.deleteAnnotation(n)})},style:{height:36,width:36,padding:0}})}),!s&&!a&&e.hasInterface("annotations:add-new")&&i&&(0,ae.jsx)(Pn.m_M,{title:`Create copy of current ${n.type}`,children:(0,ae.jsx)(Pn.$nd,{icon:(0,ae.jsx)(kn.bzS,{style:{width:36,height:36}}),variant:"neutral",look:"string",type:"text","aria-label":"Copy Annotation",onClick:t=>{t.preventDefault();const i=e.annotationStore.addAnnotationFromPrediction(n);window.setTimeout(()=>{e.annotationStore.selectAnnotation(i.id)},50)},style:{height:36,width:36,padding:0}})}),(0,ae.jsx)(Pn.$nd,{icon:(0,ae.jsx)(kn.Ni9,{}),variant:"neutral",look:"string","aria-label":"Settings",onClick:()=>e.toggleSettings(),style:{height:36,width:36,padding:0}}),e.description&&e.hasInterface("instruction")&&!a&&(0,ae.jsx)(Pn.$nd,{icon:(0,ae.jsx)(kn.G_L,{style:{width:16,height:16}}),variant:e.showingDescription?"primary":"neutral",look:e.showingDescription?"filled":"string","aria-label":"Instructions",onClick:()=>e.toggleDescription(),style:{height:36,width:36,padding:0}})]})},yk=["entity","selected","onClick","extra"],bk=(0,b.PA)(({store:e,annotationStore:t,commentStore:n})=>{const i=(0,f.useRef)(),[o,s]=(0,f.useState)(!1),a=e.hasInterface("annotations:tabs"),r=e.hasInterface("predictions:tabs"),l=e.hasInterface("annotations:add-new"),c=e.hasInterface("ground-truth"),u=[];r&&u.push(...t.predictions),a&&u.push(...t.annotations);const h=(0,f.useCallback)((e,n)=>{e.selected||(n?t.selectPrediction(e.id):t.selectAnnotation(e.id))},[t]);(0,f.useEffect)(()=>{const e=e=>{const t=e.target,n=i.current;t===n||null!=n&&n.contains(t)||s(!1)};document.addEventListener("click",e);const t=(0,d.mJ)(()=>[...n.comments.map(e=>e.isResolved)],e=>{let t=0,i=0;e.forEach(e=>{i++,e||t++}),n.annotation.setUnresolvedCommentCount(t),n.annotation.setCommentCount(i)});return()=>{document.removeEventListener("click",e),t()}},[]);const g=e=>e.unresolved_comment_count>0?(0,ae.jsx)(kn.QV6,{}):e.comment_count>0?(0,ae.jsx)(kn.RU_,{}):null,m=(e,n)=>{var i;return(0,ae.jsx)(wk,{entity:e,"aria-label":`${e.type} ${n+1}`,selected:e===t.selected,onClick:t=>{t.preventDefault(),t.stopPropagation(),s(!1),null==h||h(e,"prediction"===e.type)},extra:(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-list").elem("icons").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("icon-column").toClassName(),children:g(e)}),(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("icon-column").toClassName(),children:c&&(0,ae.jsx)(Zb,{entity:e,disabled:!0})})]})},`${null!=(i=e.pk)?i:e.id}${e.type}`)};return a||r||l?(0,ae.jsx)("div",{className:(0,Nn.cn)("topbar").elem("section").mod({flat:!0}).toClassName(),children:(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-list").toClassName(),ref:i,children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("selected").toClassName(),children:(0,ae.jsx)(wk,{"aria-label":"Annotations List Toggle",entity:t.selected,onClick:e=>{e.stopPropagation(),s(!o)},extra:u.length>0?(0,ae.jsxs)(Lb,{size:"none",style:{marginRight:-8,marginLeft:8},children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-list").elem("counter").toClassName(),children:[u.indexOf(t.selected)+1,"/",u.length]}),(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("toggle").mod({opened:o}).toClassName()})]}):null})}),o&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-list").elem("list").toClassName(),children:[e.hasInterface("annotations:add-new")&&(0,ae.jsx)(xk,{annotationStore:t,onClick:()=>s(!1)}),(e=>{const t=[],n=[];return e.forEach((e,i)=>{e.pk?n.push(m(e,i)):t.push(m(e,i))}),(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("draft").toClassName(),children:t}),(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("annotation").toClassName(),children:n})]})})(u)]})]})}):null}),xk=(0,b.PA)(({annotationStore:e,onClick:t})=>{const n=(0,f.useCallback)(()=>{const n=e.createAnnotation();e.selectAnnotation(n.id),t()},[e,t]);return(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("create").toClassName(),"aria-label":"Create Annotation",onClick:n,children:(0,ae.jsxs)(Lb,{size:"small",children:[(0,ae.jsx)(Pn.an1,{className:(0,Nn.cn)("annotations-list").elem("userpic").mod({prediction:!0}).toClassName(),children:(0,ae.jsx)(kn.KSs,{})}),"Create Annotation"]})})}),wk=(0,b.PA)(e=>{var t,n,i;let{entity:o,selected:s,onClick:a,extra:r}=e,l=(0,Se.A)(e,yk);const c="prediction"===o.type,d=(0,E.userDisplayName)(null!=(t=o.user)?t:{firstName:o.createdBy||"Admin"});return(0,ae.jsx)("div",Object.assign({},l,{className:(0,Nn.cn)("annotations-list").elem("entity").mod({selected:s}).toClassName(),onClick:a,children:(0,ae.jsxs)(Lb,{spread:!0,children:[(0,ae.jsxs)(Lb,{size:"small",children:[(0,ae.jsx)(Pn.an1,{className:(0,Nn.cn)("annotations-list").elem("userpic").mod({prediction:c}).toClassName(),showUsernameTooltip:!0,username:c?o.createdBy:null,user:null!=(n=o.user)?n:{username:d},children:c&&(0,ae.jsx)(kn.ccx,{color:"#944BFF",style:{width:18,height:18}})}),(0,ae.jsxs)(Lb,{direction:"vertical",size:"none",children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-list").elem("user").toClassName(),children:[(0,ae.jsx)("span",{className:(0,Nn.cn)("annotations-list").elem("name").toClassName(),children:d}),(0,ae.jsxs)("span",{className:(0,Nn.cn)("annotations-list").elem("entity-id").toClassName(),children:["#",null!=(i=o.pk)?i:o.id]})]}),(0,E.isDefined)(o.acceptedState)?(0,ae.jsx)("div",{className:(0,Nn.cn)("annotations-list").elem("review").mod({state:o.acceptedState}).toClassName(),children:o.acceptedState}):(0,ae.jsxs)("div",{className:(0,Nn.cn)("annotations-list").elem("created").toClassName(),children:["created,"," ",(0,ae.jsx)(ok,{className:(0,Nn.cn)("annotations-list").elem("date").toClassName(),date:o.createdDate})]})]})]}),r]})}))}),Sk=(0,b.WQ)("store")((0,b.PA)(({store:e,title:t,children:n})=>(0,ae.jsx)(Pn.m_M,{title:t,disabled:!e.settings.enableTooltips,children:n}))),Ck=(0,b.WQ)(({store:e})=>{var t;return{store:e,history:null==e||null==(t=e.annotationStore)||null==(t=t.selected)?void 0:t.history}}),kk=Ck((0,b.PA)(({store:e,history:t,annotation:n})=>{const i=e.hasInterface("review"),o=(0,E.isDefined)(e.annotationStore.selectedHistory),{userGenerate:s,sentUserGenerate:a,versions:r,results:l,editable:c}=n,d=[],[u,h]=(0,f.useState)(!1),g=!c||e.isSubmitting||o||u,m=e.hasInterface("annotations:deny-empty")&&0===l.length,p=(0,f.useCallback)(async(t,n,i)=>{const{addedCommentThisSession:o,currentComment:s,commentFormSubmit:a,inputRef:r}=e.commentStore;if(!u){if(h(!0),!r.current||o)n();else if((null!=s?s:"").trim())t.preventDefault(),await a(),n();else{const t=r.current;e.commentStore.setTooltipMessage(i),t.scrollIntoView({behavior:"smooth"}),t.focus({preventScroll:!0})}h(!1)}},[e.rejectAnnotation,e.skipTask,e.commentStore.currentComment,e.commentStore.inputRef,e.commentStore.commentFormSubmit,e.commentStore.addedCommentThisSession,u]),v=(0,f.useMemo)(()=>(0,ae.jsx)(Sk,{title:"Reject annotation: [ Ctrl+Space ]",children:(0,ae.jsx)(Pn.$nd,{"aria-label":"Reject current annotation",disabled:g,look:"danger",onClick:async t=>{var n;null==(n=e.hasInterface("comments:reject"))||n?p(t,()=>e.rejectAnnotation({}),"Please enter a comment before rejecting"):(console.log("rejecting"),await e.commentStore.commentFormSubmit(),e.rejectAnnotation({}))},children:"Reject"})},"reject"),[g,e]);if(i)d.push(v),d.push((0,ae.jsx)(Sk,{title:"Accept annotation: [ Ctrl+Enter ]",children:(0,ae.jsx)(Pn.$nd,{"aria-label":"Accept current annotation",disabled:g,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.acceptAnnotation()},children:t.canUndo||n.versions.draft?"Fix + Accept":"Accept"})},"accept"));else if(n.skipped)d.push((0,ae.jsxs)("div",{className:(0,Nn.cn)("controls").elem("skipped-info").toClassName(),children:[(0,ae.jsx)(kn.r7P,{color:"#d00"})," Was skipped"]},"skipped")),d.push((0,ae.jsx)(Sk,{title:"Cancel skip: []",children:(0,ae.jsx)(Pn.$nd,{"aria-label":"Cancel skip and return to annotation",disabled:g,look:"outlined",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.unskipTask()},children:"Cancel skip"})},"cancel-skip"));else{const t=["OW","AD","MA"];if(e.hasInterface("skip")){var y,b;const n=e.task,i=!!(null==(y=window.APP_SETTINGS)||null==(y=y.billing)?void 0:y.enterprise)&&!1===(null==n?void 0:n.allow_skip),o=null==(b=window.APP_SETTINGS)||null==(b=b.user)?void 0:b.role,s=t.includes(o),a=!i||s,r=g||!a,l=a?"Cancel (skip) task: [ Ctrl+Space ]":"This task cannot be skipped";i&&s&&d.push((0,ae.jsx)(Pn.m_M,{title:"Annotators and Reviewers will not be able to skip this task",children:(0,ae.jsx)(kn.mJl,{width:20,height:20,className:"text-neutral-content ml-auto cursor-pointer"})},"skip-info")),d.push((0,ae.jsx)(Sk,{title:l,children:(0,ae.jsx)(Pn.$nd,{"aria-label":"Skip current task",disabled:r,variant:"negative",look:"outlined",onClick:async t=>{var n;a&&(null==(n=e.hasInterface("comments:skip"))||n?p(t,()=>e.skipTask({}),"Please enter a comment before skipping"):(await e.commentStore.commentFormSubmit(),e.skipTask({})))},children:"Skip"})},"skip"))}if(s&&!a||e.explore&&!s&&e.hasInterface("submit")){const t=m?"Empty annotations denied in this project":"Save results: [ Ctrl+Enter ]";d.push((0,ae.jsx)(Sk,{title:t,children:(0,ae.jsx)("div",{className:(0,Nn.cn)("controls").elem("tooltip-wrapper").toClassName(),children:(0,ae.jsx)(Pn.$nd,{"aria-label":"Submit current annotation",disabled:g||m,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.submitAnnotation()},children:"Submit"})})},"submit"))}if(s&&a||!s&&e.hasInterface("update")){const t=a||r.result,n=(0,ae.jsx)(Sk,{title:"Update this task: [ Alt+Enter ]",children:(0,ae.jsx)(Pn.$nd,{"aria-label":"Update current annotation",disabled:g||m,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.updateAnnotation()},children:t?"Update":"Submit"})},"update");d.push(n)}}return(0,ae.jsx)("div",{className:(0,Nn.cn)("controls").toClassName(),children:(0,ae.jsx)("div",{className:"grid grid-flow-col auto-cols-fr gap-tight items-center",children:d})})})),Pk=(0,b.PA)(({store:e})=>{const t=e.annotationStore,n=null==t?void 0:t.selected,i="prediction"===(null==n?void 0:n.type),o=!0===(null==t?void 0:t.viewingAll),s=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&e.hasInterface("annotation:bulk");return(0,Ne.VS)(Ne.bA)&&s||(0,Ne.VS)(Ne.bA)&&!e.hasInterface("annotations:view-all")?null:e?(0,ae.jsx)("div",{className:(0,Nn.cn)("topbar").mod({newLabelingUI:(0,Ne.VS)(Ne.bA)}).toClassName(),children:(0,Ne.VS)(Ne.bA)?(0,ae.jsxs)("div",{className:(0,Nn.cn)("topbar").elem("group").toClassName(),children:[e.hasInterface("annotations:view-all")&&(0,ae.jsx)(pk,{isActive:o,onClick:t.toggleViewingAllAnnotations}),e.hasInterface("annotations:add-new")&&(0,ae.jsx)(Pn.$nd,{className:(0,Nn.cn)("topbar").elem("button").toClassName(),type:o?void 0:"text","aria-label":"Create an annotation",variant:"neutral",size:"small",look:"outlined",tooltip:"Create a new annotation",onClick:t=>{t.preventDefault();const n=e.annotationStore.createAnnotation();e.annotationStore.selectAnnotation(n.id,{exitViewAll:!0})},children:(0,ae.jsx)(kn.uID,{})}),(!o||He.ff.isActive(He.ff.FF_SUMMARY))&&(0,ae.jsx)(mk,{store:e,annotationStore:e.annotationStore,commentStore:e.commentStore})]}):(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("topbar").elem("group").toClassName(),children:[!o&&!s&&(0,ae.jsx)(bk,{store:e,annotationStore:e.annotationStore,commentStore:e.commentStore}),(0,ae.jsx)(vk,{store:e})]}),(0,ae.jsxs)("div",{className:(0,Nn.cn)("topbar").elem("group").toClassName(),children:[!o&&(0,ae.jsx)("div",{className:(0,Nn.cn)("topbar").elem("section").toClassName(),children:(0,ae.jsx)(qb,{})}),!o&&e.hasInterface("controls")&&(e.hasInterface("review")||!i)&&(0,ae.jsx)("div",{className:(0,Nn.cn)("topbar").elem("section").mod({flat:!0}).toClassName(),style:{width:320,boxSizing:"border-box"},children:(0,ae.jsx)(kk,{annotation:n})})]})]})}):null});var Rk=n(59444),jk=n(97609),Nk=n(62629);const Tk=({children:e,prefix:t,colors:n,style:i,thickBorder:o=!1,className:s})=>{const a=Object.assign({},i,(null==n?void 0:n.background)&&{background:n.background},(null==n?void 0:n.border)&&{borderColor:n.border},(null==n?void 0:n.color)&&{color:n.color},o&&(null==n?void 0:n.border)&&{borderLeft:`3px solid ${n.border}`}),r="string"==typeof t&&t.endsWith("%");return e?(0,ae.jsxs)("span",{className:(0,Pn.Tg0)("inline-flex items-center whitespace-nowrap rounded-4 px-2 py-0.5","text-xs border",!(null!=n&&n.background)&&"bg-neutral-surface-subtle",!(null!=n&&n.border)&&"border-neutral-border",!(null!=n&&n.color)&&"text-neutral-content",s),style:a,children:[t&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)("span",{className:"font-semibold",children:t}),r?(0,ae.jsx)("span",{className:"opacity-50 mx-tighter",children:"|"}):(0,ae.jsx)("span",{className:"opacity-50 mx-tightest",children:"Ã—"})]}),e]}):null},_k=({header:e})=>e.column.getCanResize()?(0,ae.jsx)("div",{onMouseDown:e.getResizeHandler(),onTouchStart:e.getResizeHandler(),className:(0,Pn.Tg0)("absolute right-[-3px] top-0 h-full w-[7px] z-1","after:content-[''] after:absolute after:bg-neutral-border","after:right-[3px] after:top-0 after:h-full after:w-[1px] hover:after:w-[2px]","cursor-col-resize select-none touch-none")}):null,Ak=({data_types:e})=>{const t=(0,f.useMemo)(()=>Object.fromEntries(Object.entries(e).map(([e,{value:t}])=>[e,t])),[e]),n=(0,f.useMemo)(()=>{const t=(0,jk.FB)();return Object.entries(e).map(([e,{type:n}])=>t.accessor(e,{id:e,header:()=>(0,ae.jsxs)(ae.Fragment,{children:[e," ",(0,ae.jsx)(Tk,{children:n})]}),cell:({getValue:t})=>{const i=t();return"image"===n?(0,ae.jsx)("img",{src:i,alt:e,className:"w-full"}):"audio"===n?(0,ae.jsx)("audio",{src:i,controls:!0,className:"w-full"}):"video"===n?(0,ae.jsx)("video",{src:i,controls:!0,className:"w-full"}):"object"==typeof i&&null!==i?(0,ae.jsx)(Pn.p2L,{data:i,showSearch:!1,showFilters:!1,showCopyButton:!1,minHeight:100,maxHeight:300}):i},size:300,maxSize:800}))},[e]),i=(0,Nk.N4)({data:[t],columns:n,getCoreRowModel:(0,jk.HT)(),columnResizeMode:"onChange",enableColumnResizing:!0,defaultColumn:{minSize:80,maxSize:800}});return(0,ae.jsx)("div",{className:"overflow-x-auto pb-tight mb-base",children:(0,ae.jsx)("div",{className:"border border-neutral-border rounded-small overflow-hidden",children:(0,ae.jsxs)("table",{className:"w-full",children:[(0,ae.jsx)("thead",{className:"bg-neutral-surface",children:i.getHeaderGroups().map(e=>(0,ae.jsx)("tr",{children:e.headers.map(e=>(0,ae.jsxs)("th",{className:"px-4 py-2 overflow-hidden text-ellipsis text-left whitespace-nowrap font-normal relative",style:{minWidth:e.getSize()},children:[e.isPlaceholder?null:(0,Nk.Kv)(e.column.columnDef.header,e.getContext()),(0,ae.jsx)(_k,{header:e})]},e.id))},e.id))}),(0,ae.jsx)("tbody",{children:i.getRowModel().rows.map(e=>(0,ae.jsx)("tr",{className:"even:bg-neutral-surface",children:e.getVisibleCells().map(e=>(0,ae.jsx)("td",{className:"px-4 py-2 overflow-hidden text-ellipsis align-top",style:{minWidth:e.column.getSize()},children:(0,Nk.Kv)(e.column.columnDef.cell,e.getContext())},e.id))},e.id))})]})})})};var Ik=n(98360);const Mk=w.A.LABEL_BACKGROUND,Ek=e=>{const t=[[255,255,230],[247,237,250],[240,248,255],[255,240,250],[250,250,210],[230,255,250],[242,255,242],[255,250,220],[255,245,238],[225,240,255],[246,246,232]],n=t.length,i=Math.floor(e/n),o=e%n;let[s,a,r]=t[o];s=Math.max(s-10*i,200),a=Math.max(a-10*i,200),r=Math.max(r-10*i,200);return`rgba(${s}, ${a}, ${r}, 0.8)`},Kk=e=>{if(!e.children)return{};const t={};let n=0;for(const i of e.children){const e=i.background,o=e?(0,pt.convertToRGBA)(e,.3):void 0;t[i.value]={value:i.value,border:null!=e?e:Mk,color:o?(0,pt.contrastColor)(o):void 0,background:null!=o?o:Ek(n)},n++}return t},Dk=(e,t)=>{const n=Object.fromEntries(Object.entries(t).map(([e,t])=>[e,Object.assign({},t,{count:0})])),i={background:(0,pt.convertToRGBA)(Mk,.3),border:Mk,count:0};for(const t of e){let e=n[t];e||(e=n[t]=Object.assign({},i,{value:t})),e.count++}return n},Ok="aggregation-row--RR95P",Lk=e=>"textarea"===e.type?e.value.text:e.value[e.type],zk=({control:e,annotations:t,isExpanded:n})=>{const i=t.flatMap(t=>t.results.filter(t=>t.from_name===e.name)),o=t.filter(e=>"annotation"===e.type).length;if(!i.length)return(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-xs italic",children:"N/A"});if(e.type.endsWith("labels")){const t=i.flatMap(e=>Lk(e)).flat(),o=Dk(t,e.label_attrs),s=Object.entries(o).filter(([e,t])=>t.count>0).sort(([,e],[,t])=>t.count-e.count);return(0,ae.jsx)("div",{className:(0,Pn.Tg0)("text-ellipsis",!n&&"line-clamp-2"),children:s.map(([e,t])=>(0,ae.jsx)(Tk,{prefix:t.count,colors:{background:t.background,border:t.border,color:t.color},className:"mr-tighter mb-tighter",thickBorder:!0,children:e},e))})}if("pairwise"===e.type){const e=i.flatMap(e=>Lk(e)).flat(),t={};e.forEach(e=>{t[e]=(t[e]||0)+1});const o=Object.entries(t).sort(([,e],[,t])=>t-e);return(0,ae.jsx)("div",{className:(0,Pn.Tg0)("text-ellipsis",!n&&"line-clamp-2"),children:o.map(([e,t])=>(0,ae.jsx)(Tk,{prefix:t,className:"mr-tighter mb-tighter",children:e},e))})}if("choices"===e.type){const t=i.flatMap(e=>Lk(e)).flat(),s={};t.forEach(e=>{s[e]=(s[e]||0)+1});const a=Object.entries(s).sort(([,e],[,t])=>t-e);return(0,ae.jsx)("div",{className:(0,Pn.Tg0)("text-ellipsis",!n&&"line-clamp-2"),children:a.map(([t,n])=>{var i;return(0,ae.jsx)(Tk,{prefix:`${(n/o*100).toFixed(1)}%`,colors:{background:null==(i=e.label_attrs[t])?void 0:i.background},className:"mr-tighter mb-tighter",children:t},t)})})}if("taxonomy"===e.type){const e=i.flatMap(e=>{var t;return null==(t=Lk(e))?void 0:t.map(e=>e.at(-1))}),t={};e.filter(Boolean).forEach(e=>{const n=Array.isArray(e)?e.join(" / "):e;t[n]=(t[n]||0)+1});const s=Object.entries(t).sort(([,e],[,t])=>t-e);return(0,ae.jsx)("div",{className:(0,Pn.Tg0)("text-ellipsis",!n&&"line-clamp-2"),children:s.map(([e,t])=>(0,ae.jsx)(Tk,{prefix:`${(t/o*100).toFixed(1)}%`,className:"mr-tighter mb-tighter",children:e},e))})}if("rating"===e.type){const e=i.map(e=>Lk(e)).filter(Boolean);if(!e.length)return(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-xs italic",children:"No ratings"});const t=e.reduce((e,t)=>e+t,0)/e.length;return(0,ae.jsxs)("span",{className:"text-sm font-medium text-neutral-content-subtle",children:["Avg: ",(0,ae.jsx)("span",{className:"font-bold",children:t.toFixed(1)})," ",(0,ae.jsx)("span",{className:"text-yellow-500",children:"â˜…"})]})}if("number"===e.type){const e=i.map(e=>Lk(e)).filter(e=>null!=e);if(!e.length)return(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-xs italic",children:"No data"});const t=e.reduce((e,t)=>e+Number(t),0)/e.length;return(0,ae.jsxs)("span",{className:"text-sm font-medium text-neutral-content-subtle",children:["Avg: ",(0,ae.jsx)("span",{className:"font-bold",children:t.toFixed(1)})]})}return(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-xs italic",children:"N/A"})},Bk=()=>(0,ae.jsxs)("div",{className:"flex items-center gap-2",children:[(0,ae.jsx)("div",{className:"h-5 w-16 bg-neutral-surface-subtle rounded animate-pulse"}),(0,ae.jsx)("div",{className:"h-5 w-12 bg-neutral-surface-subtle rounded animate-pulse"})]}),Fk=({control:e,distribution:t,totalAnnotations:n,isExpanded:i})=>{if(!t||0===Object.keys(t.labels).length)return void 0!==(null==t?void 0:t.average)?(0,ae.jsxs)("span",{className:"text-sm font-medium text-neutral-content-subtle",children:["Avg: ",(0,ae.jsx)("span",{className:"font-bold",children:t.average.toFixed(1)}),"rating"===t.type&&(0,ae.jsx)("span",{className:"text-yellow-500",children:" â˜…"})]}):(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-xs italic",children:"N/A"});const o=Object.entries(t.labels).sort(([,e],[,t])=>t-e);return"choices"===t.type||"taxonomy"===t.type?(0,ae.jsx)("div",{className:(0,Pn.Tg0)("text-ellipsis",!i&&"line-clamp-2"),children:o.map(([t,i])=>{var o;return(0,ae.jsx)(Tk,{prefix:`${(i/n*100).toFixed(1)}%`,colors:{background:null==(o=e.label_attrs[t])?void 0:o.background},className:"mr-tighter mb-tighter",children:t},t)})}):(0,ae.jsx)("div",{className:(0,Pn.Tg0)("text-ellipsis",!i&&"line-clamp-2"),children:o.map(([n,i])=>{var o,s,a;return(0,ae.jsx)(Tk,{prefix:i,colors:{background:null==(o=e.label_attrs[n])?void 0:o.background,border:null==(s=e.label_attrs[n])?void 0:s.border,color:null==(a=e.label_attrs[n])?void 0:a.color},className:"mr-tighter mb-tighter",thickBorder:t.type.endsWith("labels"),children:n},n)})})},Hk=({headers:e,controls:t,annotations:n,taskId:i})=>{const[o,s]=(0,f.useState)(!1),[a,r]=(0,f.useState)(!1),l=(0,f.useRef)(null),c=(0,YC.$m)(YC.mQ)&&i,{data:d,isLoading:u,error:h}=(0,Ik.I)({queryKey:["task-agreement",i],queryFn:()=>(async e=>{const t=await fetch(`/api/tasks/${e}/agreement/`);if(!t.ok)throw new Error("Failed to load distribution");return t.json()})(i),enabled:c&&!!i,staleTime:3e4,gcTime:3e5});return(0,f.useLayoutEffect)(()=>{if(!l.current)return;const e=l.current,t=[...e.childNodes].some(t=>{const n=t;return n.firstChild&&n.firstChild.scrollHeight>e.scrollHeight});r(t)},[n,t,d]),(0,ae.jsx)("tr",{ref:l,className:(0,Pn.Tg0)("relative z-2",Ok),children:e.map((e,i)=>{var r;return 0===i?(0,ae.jsx)("td",{className:(0,Pn.Tg0)("px-4 py-2.5 overflow-hidden border-r border-r-neutral-border border-l border-y-2 border-neutral-border-bold bg-neutral-background","sticky left-0 z-20"),style:{width:e.getSize()},children:(0,ae.jsxs)("div",{className:"flex flex-col",children:[a?(0,ae.jsxs)("button",{type:"button",onClick:()=>s(!o),className:"flex items-center gap-2 font-semibold text-neutral-content hover:text-neutral-content transition-colors cursor-pointer",children:[(0,ae.jsx)(Pn.rIS,{size:16,className:(0,Pn.Tg0)("transition-transform",o&&"rotate-180")}),"Distribution"]}):(0,ae.jsx)("span",{className:"font-semibold text-neutral-content",children:"Distribution"}),c&&d&&(0,ae.jsxs)("span",{className:"text-xs text-neutral-content-subtle",children:[d.total_annotations," annotations"]})]})},e.id):(0,ae.jsx)("td",{className:"px-4 py-2.5 overflow-hidden border-y-2 border-neutral-border-bold",style:{width:e.getSize()},children:c&&u?(0,ae.jsx)(Bk,{}):c&&h?(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-xs italic",children:"Failed to load"}):c&&d?(0,ae.jsx)(Fk,{control:t[i-1],distribution:d.distributions[null==(r=t[i-1])?void 0:r.name],totalAnnotations:d.total_annotations,isExpanded:o}):(0,ae.jsx)(zk,{control:t[i-1],annotations:n,isExpanded:o})},e.id)})})};var Vk=n(25588),$k=n(56005),Wk=n.n($k);const Uk=e=>"textarea"===e.type?e.value.text:e.value[e.type],Gk=(e,t)=>{const n=e.flatMap(Uk).flat();if(!n.length)return null;const i=Dk(n,t.label_attrs);return(0,ae.jsx)("span",{className:"flex gap-tighter flex-wrap",children:Object.entries(i).filter(([e,t])=>t.count>0).map(([e,t])=>(0,ae.jsx)(Tk,{prefix:t.count,colors:t,thickBorder:!0,children:e},e))})},Yk={labels:Gk,ellipselabels:Gk,polygonlabels:Gk,vectorlabels:Gk,rectanglelabels:Gk,keypointlabels:Gk,brushlabels:Gk,hypertextlabels:Gk,timeserieslabels:Gk,paragraphlabels:Gk,timelinelabels:Gk,bitmasklabels:Gk,ocrlabels:Gk,datetime:(e,t)=>e.length?t.per_region?null:(0,ae.jsx)("span",{className:"text-sm font-mono",children:Uk(e[0])}):null,number:(e,t)=>e.length?t.per_region?null:(0,ae.jsx)("span",{className:"text-sm font-mono font-semibold",children:Uk(e[0])}):null,choices:(e,t)=>{const n=e.flatMap(Uk).flat(),i=[...new Set(n)];return n.length?(0,ae.jsx)("span",{className:"flex gap-tighter flex-wrap",children:i.map(e=>{var n;return(0,ae.jsx)(Tk,{colors:{background:null==(n=t.label_attrs[e])?void 0:n.background},children:e},e)})}):null},taxonomy:(e,t)=>{if(!e.length)return null;if(t.per_region)return null;const n=Uk(e[0]).map(e=>e.join(" / "));return(0,ae.jsx)("span",{className:"flex gap-tighter flex-wrap",children:n.map(e=>(0,ae.jsx)(Tk,{children:e},e))})},textarea:(e,t)=>{if(!e.length)return null;if(t.per_region)return null;const n=Uk(e[0]);return n?(0,ae.jsx)("div",{className:"text-sm text-ellipsis line-clamp-6 space-y-1",children:n.map((e,t)=>(0,ae.jsx)("p",{className:"break-words",children:e},t))}):null},ranker:e=>{if(!e.length)return null;const t=Uk(e[0]);return(0,ae.jsx)("div",{className:"space-y-1.5",children:Object.entries(t).map(([e,t])=>(0,ae.jsxs)("div",{className:"text-sm",children:[(0,ae.jsx)("span",{className:"font-semibold",children:e}),":"," ",(0,ae.jsx)("span",{className:"inline-flex gap-tighter flex-wrap",children:t.map(e=>(0,ae.jsx)(Tk,{children:e},e))})]},e))})},rating:(e,t)=>{if(!e.length)return null;if(t.per_region)return null;const n=Uk(e[0]);return n?(0,ae.jsx)("span",{className:"text-lg text-yellow-500",children:"â˜…".repeat(n)}):null},reactcode:(e,t)=>{if(!e.length)return null;const n=t.name,i=[];for(const t of e){var o;const e=null==(o=t.value)?void 0:o.reactcode;if(!e)continue;const s=(0,Vk.E)({path:n,json:e,wrap:!1});null!=s&&i.push(s)}if(0===i.length)return(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-sm",children:"â€”"});const s=e=>"object"==typeof e?JSON.stringify(e):String(e);if(i.length>1){const e=Object.groupBy(i,s),t=Object.values(e).every(e=>1===e.length),n=t?i.map(e=>[s(e),[e]]):Object.entries(e).sort((e,t)=>t[1].length-e[1].length),o=n.length>10?n.slice(0,9):n,a=n.length-o.length;return(0,ae.jsxs)("span",{className:"flex gap-tighter flex-wrap",children:[o.map(([e,n])=>{return(0,ae.jsx)(Tk,{prefix:t?void 0:n.length,children:(i=e,i.length<=30?i:`${i.slice(0,30)}â€¦`)},e);var i}),a>0&&(0,ae.jsxs)("span",{className:"text-neutral-content-subtle text-sm",children:["+",a," more"]})]})}const a=i[0];return"boolean"==typeof a?(0,ae.jsx)("span",{className:"text-sm font-mono",children:a?"true":"false"}):"number"==typeof a?(0,ae.jsx)("span",{className:"text-sm font-mono font-semibold",children:a}):"string"==typeof a?(0,ae.jsx)("div",{className:"text-sm text-ellipsis line-clamp-3 break-words",children:(0,ae.jsx)("p",{children:a})}):Array.isArray(a)?(0,ae.jsxs)("span",{className:"flex gap-tighter flex-wrap",children:[a.slice(0,5).map((e,t)=>(0,ae.jsx)(Tk,{children:"object"==typeof e?JSON.stringify(e):String(e)},t)),a.length>5&&(0,ae.jsxs)("span",{className:"text-neutral-content-subtle text-sm",children:["+",a.length-5," more"]})]}):(0,ae.jsx)("span",{className:"text-sm font-mono",children:JSON.stringify(a)})}},Xk=e=>"reactcode"===e.type?e.name.replace(/^\$\.?/,"").replace(/\[\*\]/g,"").split(".").filter(Boolean).map(Wk()).join(" / ")||"Value":e.name,qk=(e,t)=>n=>{var i;const o=n.row.original,s="reactcode"===e.type?e.to_name:e.name,a=o.results.filter(e=>e.from_name===s),r=a.length?null!=(i=null==t?void 0:t(a,e))?i:(0,ae.jsxs)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-4 bg-neutral-surface-subtle text-xs font-medium",children:[a.length," result",a.length>1?"s":""]}):(0,ae.jsx)("span",{className:"text-neutral-content-subtler text-sm",children:"â€”"});return(0,ae.jsx)("div",{className:"min-h-[2rem] flex items-center",children:r})},Zk=e=>{const t=e.toJSON();return Object.assign({},t,{from_name:t.from_name.replace(/@.*$/,"")})},Jk=(0,jk.FB)(),Qk=({hideInfo:e,annotations:t,controls:n,onSelect:i,taskId:o})=>{var s,a,r;const l=null==(s=window.APP_SETTINGS)?void 0:s.user,[c,d]=(0,f.useState)({}),u=(0,f.useRef)(null),h=t.map(t=>{var n,i,o,s,a;return{id:t.pk,type:t.type,user:e?{email:(null==l?void 0:l.id)===(null==(n=t.user)?void 0:n.id)?"Me":"User"}:t.user,createdBy:"prediction"===t.type?t.createdBy:e?(null==l?void 0:l.id)===(null==(i=t.user)?void 0:i.id)?"Me":"User":(0,He.Jf)(t.user),results:"prediction"===t.type?null!=(o=null==(s=t.results)?void 0:s.map(Zk))?o:[]:null!=(a=t.versions.result)?a:[]}});(0,f.useEffect)(()=>{if(u.current&&0===Object.keys(c).length){const e=u.current.querySelectorAll("thead th"),t={};e.forEach((e,i)=>{var o;const s=0===i?"id":null==(o=n[i-1])?void 0:o.name;if(s){const n=e.getBoundingClientRect().width;t[s]=n}}),d(t)}},[n,c]);const g=(0,f.useMemo)(()=>{const t=n.map(e=>Jk.display({id:e.name,header:()=>(0,ae.jsxs)("div",{children:[(0,ae.jsx)("span",{className:"font-semibold text-sm pb-small",children:Xk(e)}),(0,ae.jsx)(Tk,{prefix:e.per_region?"per-region ":"",className:"px-small ml-2",children:e.type})]}),cell:qk(e,Yk[e.type]),size:c[e.name]||150,minSize:120,maxSize:600}));return t.unshift({header:"Annotator",accessorKey:"id",size:c.id||180,minSize:150,maxSize:300,cell:({row:t})=>{const n=t.original;return(0,ae.jsxs)("button",{type:"button",className:"flex gap-tight items-center cursor-pointer hover:bg-neutral-surface-subtle transition-colors p-1 rounded-small -ml-1",onClick:()=>i(n),children:[(0,ae.jsx)(Pn.an1,{user:n.user,className:"prediction"===n.type?"!bg-accent-plum-subtle text-accent-plum-bold":"",children:"prediction"===n.type&&(0,ae.jsx)(Pn.ccx,{size:18})}),(0,ae.jsxs)("div",{className:"flex flex-col items-start",children:[(0,ae.jsx)("span",{className:"text-sm font-medium",children:n.createdBy}),!e&&(0,ae.jsxs)("span",{className:"text-xs text-neutral-content-subtle",children:["#",n.id]})]})]})}}),t},[n,i,e,c]),m=(0,Nk.N4)({data:h,columns:g,getCoreRowModel:(0,jk.HT)(),columnResizeMode:"onChange",enableColumnResizing:!0,defaultColumn:{size:150,minSize:80,maxSize:800}}),p=(0,f.useMemo)(()=>0===n.length||n.every(e=>"reactcode"===e.type),[n]);return(0,ae.jsx)("div",{className:"mb-base",children:(0,ae.jsx)("div",{className:"overflow-x-auto pb-tight",children:(0,ae.jsxs)("table",{ref:u,className:"border border-neutral-border rounded-small w-full",style:{tableLayout:Object.keys(c).length>0?"fixed":"auto",borderCollapse:"separate",borderSpacing:0,width:"calc(100% - 2px)"},children:[(0,ae.jsx)("thead",{className:"sticky top-0 z-10",children:m.getHeaderGroups().map(e=>(0,ae.jsx)("tr",{children:e.headers.map((e,t)=>(0,ae.jsxs)("th",{style:{position:0===t?"sticky":"relative",left:0===t?0:"auto",width:e.getSize(),minWidth:e.column.columnDef.minSize||120,maxWidth:e.column.columnDef.maxSize||600,zIndex:0===t?20:1},className:(0,Pn.Tg0)(p?"border-b border-neutral-border":"","px-4 py-2.5 text-left whitespace-nowrap font-semibold text-sm bg-neutral-surface-subtle",0===t&&"border-r border-neutral-border bg-neutral-surface"),children:[(0,ae.jsx)("div",{className:"overflow-hidden text-ellipsis flex items-start gap-2",children:e.isPlaceholder?null:(0,Nk.Kv)(e.column.columnDef.header,e.getContext())}),(0,ae.jsx)(_k,{header:e})]},e.id))},e.id))}),(0,ae.jsxs)("tbody",{children:[!p&&(0,ae.jsx)(Hk,{headers:null!=(a=null==(r=m.getHeaderGroups()[0])?void 0:r.headers)?a:[],controls:n,annotations:h,taskId:o}),m.getRowModel().rows.map((e,t)=>(0,ae.jsx)("tr",{className:"group",children:e.getVisibleCells().map((e,n)=>{const i=0===n,o=t%2==0,s=t===m.getRowModel().rows.length-1;return(0,ae.jsx)("td",{style:{position:i?"sticky":"relative",left:i?0:"auto",width:e.column.getSize(),zIndex:i?10:"auto"},className:(0,Pn.Tg0)("px-4 py-2.5 align-top overflow-hidden transition-colors",o?"bg-neutral-surface":"bg-neutral-background","group-hover:bg-neutral-surface-subtle",!s&&"border-b border-neutral-border-subtle",i&&"border-r border-neutral-border"),children:(0,Nk.Kv)(e.column.columnDef.cell,e.getContext())},e.id)})},e.id))]})]})})})},eP=({title:e,value:t,info:n})=>(0,ae.jsxs)("div",{className:"flex-1 border border-neutral-border rounded-small p-base bg-neutral-surface-subtle",children:[(0,ae.jsxs)("div",{className:"flex flex-row gap-tighter items-center text-xs font-semibold text-neutral-content-subtle uppercase tracking-wide mb-2",children:[e,n&&(0,ae.jsx)(Pn.m_M,{title:n,children:(0,ae.jsx)(kn.mJl,{size:12,style:{width:16,height:16},className:"text-neutral-content-subtler"})})]}),(0,ae.jsx)("div",{className:"text-headline-large font-bold text-neutral-content",children:t})]}),tP=({values:e})=>(0,ae.jsx)("div",{className:"flex flex-row gap-base",children:e.map(e=>(0,ae.jsx)(eP,Object.assign({},e),e.title))}),nP=({annotations:e,store:t})=>{const n=t.store.task,i=e.filter(e=>e.pk),o=[...t.names],s=o.filter(([e,t])=>t.isControlTag).map(([e,t])=>({name:e,type:t.type,to_name:t.toname,label_attrs:Kk(t),per_region:!!t.perregion})),a=o.filter(([e,t])=>"reactcode"===t.type);for(const[e,t]of a){var r;const n=null!=(r=t.dimensions)?r:[];for(const t of n)s.push({name:t,type:"reactcode",to_name:e,label_attrs:{},per_region:!1})}const l=Object.groupBy(s,e=>e.to_name),c=Object.entries(l).flatMap(([e,t])=>(e=>e.sort((e,t)=>e.per_region&&!t.per_region?1:!e.per_region&&t.per_region?-1:e.type.endsWith("labels")&&!t.type.endsWith("labels")?1:!e.type.endsWith("labels")&&t.type.endsWith("labels")?-1:0))(null!=t?t:[])),d=o.filter(([e,t])=>t.isObjectTag&&(t.value.includes("$")||t.loadedData)),u=Object.fromEntries(d.map(([e,t])=>{var n,i,o,s,a;return[e,{type:t.type,value:null!=(n=null!=(i=null!=(o=null!=(s=null!=(a=t.loadedData)?a:t.parsedValue)?s:t.dataObj)?o:t._url)?i:t._value)?n:t.value}]})),h=[..."number"==typeof(null==n?void 0:n.agreement)?[{title:"Agreement",value:Math.round(100*n.agreement)/100+"%",info:"Overall agreement over all submitted annotations"}]:[],{title:"Annotations",value:i.filter(e=>"annotation"===e.type).length,info:"Number of submitted annotations. Table shows only submitted results, not current drafts."},{title:"Predictions",value:i.filter(e=>"prediction"===e.type).length,info:"Number of predictions. They are not included in the agreement calculation."}];return(0,ae.jsxs)("div",{children:[(0,ae.jsxs)("div",{className:"mb-base",children:[(0,ae.jsx)("h2",{className:"mt-base text-headline-small font-semibold text-neutral-content",children:"Task Summary"}),(0,ae.jsx)(tP,{values:h})]}),(0,ae.jsx)("div",{className:"mb-relaxed",children:(0,ae.jsx)(Qk,{annotations:i,controls:c,onSelect:e=>{"annotation"===e.type?t.selectAnnotation(e.id,{exitViewAll:!0}):t.selectPrediction(e.id,{exitViewAll:!0})},hideInfo:t.store.hasInterface("annotations:hide-info"),taskId:null==n?void 0:n.id})}),(0,ae.jsxs)("div",{className:"mb-relaxed",children:[(0,ae.jsx)("h2",{className:"mb-base text-headline-small font-semibold text-neutral-content",children:"Task Data"}),(0,ae.jsx)(Ak,{data_types:u})]})]})};var iP=n(18869),oP=n(83764);const sP="grid--e4IWo",aP="container--CXRH5",rP="containerVirtualized--aNCuA",lP="left--_1fAk",cP="right--LGT3p",dP=(0,b.PA)((0,f.forwardRef)(({entity:e,selected:t,style:n,onClick:i,bordered:o=!0,prediction:s=!1,displayGroundTruth:a=!1},r)=>{var l,c,d;const u=e.userGenerate&&!e.sentUserGenerate||e.draftSelected,h=e.store.hasInterface("annotations:hide-info");return(0,ae.jsx)("div",{ref:r,"data-annotation-id":null!=(l=e.pk)?l:e.id,className:(0,Nn.cn)("entity-tab").mod({selected:t,bordered:o}).toClassName(),style:n,onClick:t=>{t.preventDefault(),t.stopPropagation(),i&&i(e,s)},children:(0,ae.jsxs)(Lb,{size:"small",children:[(0,ae.jsx)(Pn.an1,{className:(0,Nn.cn)("entity-tab").elem("userpic").mod({prediction:s}).toClassName(),showUsernameTooltip:!0,username:s?e.createdBy:null,user:h?{}:null!=(c=e.user)?c:{email:e.createdBy},children:s&&(0,ae.jsx)(kn.ccx,{style:{width:16,height:16}})}),!h&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("entity-tab").elem("identifier").toClassName(),children:["ID ",null!=(d=e.pk)?d:e.id," ",u&&"*"]}),a&&e.ground_truth&&(0,ae.jsx)(kn.aGI,{className:(0,Nn.cn)("entity-tab").elem("ground-truth").toClassName()}),e.skipped&&(0,ae.jsx)(kn.r7P,{className:(0,Nn.cn)("entity-tab").elem("skipped").toClassName()})]})})})),uP=30;class hP extends f.Component{componentDidMount(){Promise.all(this.props.annotation.objects.map(e=>"image"===e.type?Promise.resolve():e.isReady?Promise.resolve(e.isReady):new Promise(t=>{const n=(0,d.lB)(e,"isReady",()=>{n(),t()})}))).then(()=>{setTimeout(this.props.onFinish,32)})}render(){return(0,ae.jsx)(Gb,{root:this.props.root,annotation:this.props.annotation})}}const gP=(0,b.PA)(({annotation:e,root:t,style:n,onSelect:i})=>(0,ae.jsx)("div",{style:Object.assign({},n,{paddingRight:uP}),children:(0,ae.jsxs)("div",{id:`c-${e.id}`,style:{position:"relative",height:"100%"},children:[(0,ae.jsx)(dP,{entity:e,onClick:()=>i(e),prediction:"prediction"===e.type,bordered:!1,style:{height:44}}),(0,ae.jsx)(Gb,{root:t,annotation:e})]})})),mP=(0,b.PA)(({store:e,annotations:t,root:n})=>{const i=(0,f.useRef)(null),[o,s]=(0,f.useState)(0),a=(0,f.useMemo)(()=>t.filter(e=>!e.hidden),[t]),r=(0,f.useMemo)(()=>{if(o>0){const e=Math.floor((o-uP)/2);return Math.max(e,500)}return 500},[o]),l=a.length*(r+uP),[c,d]=(0,f.useState)(0),u=c<=0,h=c>=l-o,g=l>o,m=(0,f.useCallback)(({scrollOffset:e})=>{d(e)},[]),p=(0,f.useCallback)(()=>{if(i.current){const e=Math.max(0,c-r-uP);i.current.scrollTo(e)}},[c,r]),v=(0,f.useCallback)(()=>{if(i.current){const e=l-o,t=Math.min(e,c+r+uP);i.current.scrollTo(t)}},[c,o,l,r]),y=(0,f.useCallback)(t=>{"annotation"===t.type?e.selectAnnotation(t.id,{exitViewAll:!0}):e.selectPrediction(t.id,{exitViewAll:!0})},[e]),b=(0,f.useMemo)(()=>({annotations:a,root:n,onSelect:y}),[a,n,y]),x=(0,f.useCallback)(({index:e,style:t,data:n})=>{const i=n.annotations[e];return(0,ae.jsx)(gP,{annotation:i,root:n.root,style:t,onSelect:n.onSelect},i.id)},[]);return(0,ae.jsxs)("div",{className:rP,children:[(0,ae.jsx)("div",{className:sP,style:{overflow:"hidden",height:"100%"},children:(0,ae.jsx)(px.Ay,{children:({width:e,height:t})=>(e!==o&&s(e),(0,ae.jsx)(Hu.Y1,{ref:i,layout:"horizontal",height:t,width:e,itemCount:a.length,itemSize:r+uP,itemData:b,onScroll:m,overscanCount:2,children:x}))})}),g&&(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(Pn.$nd,{size:"small",look:"string",onClick:p,className:lP,"aria-label":"Move left",disabled:u,children:(0,ae.jsx)(iP.A,{})}),(0,ae.jsx)(Pn.$nd,{size:"small",look:"string",onClick:v,className:cP,"aria-label":"Move right",disabled:h,children:(0,ae.jsx)(oP.A,{})})]})]})});class pP extends f.Component{constructor(...e){super(...e),this.state={item:0,loaded:new Set},this.container=f.createRef(),this.onFinish=()=>{const e=this.container.current;if(!e)return;const t=e.children[e.children.length-1],n=t.children[t.children.length-1],i=n.cloneNode(!0);e.children[this.state.item].appendChild(i),bt.A.stages.map(e=>e.draw());const o=n.querySelectorAll("canvas");i.querySelectorAll("canvas").forEach((e,t)=>{e.getContext("2d").drawImage(o[t],0,0)});const s=n.querySelectorAll("iframe");i.querySelectorAll("iframe").forEach((e,t)=>{e.contentWindow.document.open(),e.contentWindow.document.write(s[t].contentDocument.documentElement.outerHTML),(0,fe.moveStylesBetweenHeadTags)(s[t].contentDocument.head,e.contentDocument.head)}),this.setState(e=>Object.assign({},e,{loaded:new Set([...e.loaded,this.props.store.selected.id])})),this.renderNext()},this.shift=e=>{const t=this.container.current,n=t.children,i=Array.from(n).findIndex(e=>t.scrollLeft<=e.offsetLeft);if(!t)return;const o=this.props.annotations.length,s=i+e;if(s<0||s>o-1)return;const a=n[s].offsetLeft;t.scrollTo({left:a,top:0,behavior:"smooth"})},this.left=()=>{this.shift(-1)},this.right=()=>{this.shift(1)},this.select=e=>{const{store:t}=this.props;"annotation"===e.type?t.selectAnnotation(e.id,{exitViewAll:!0}):t.selectPrediction(e.id,{exitViewAll:!0})}}shouldComponentUpdate(e,t){return!e.store.selected.selected||t.item>=e.annotations.length||e.annotations[t.item]===e.store.selected}componentDidMount(){(0,Ne.VS)(Ne.cE)||this.props.annotations[0]===this.props.store.selected||this.startRenderCycle()}startRenderCycle(){this.renderNext(0)}renderNext(e){this.setState({item:(0,E.isDefined)(e)?e:this.state.item+1},()=>{this.state.item<this.props.annotations.length?this.props.store._selectItem(this.props.annotations[this.state.item]):this.props.store._unselectAll()})}render(){const e=this.state.item,{annotations:t}=this.props,n=(0,Ne.VS)(Ne.cE)?null:this.props.store.selected,i=e<t.length&&t[e]===n;return(0,ae.jsxs)("div",{className:aP,children:[(0,ae.jsxs)("div",{ref:this.container,className:sP,children:[t.filter(e=>!e.hidden).map(e=>(0,ae.jsxs)("div",{id:`c-${e.id}`,style:{position:"relative"},children:[(0,ae.jsx)(Pn.m_M,{title:"Open Annotation Tab",children:(0,ae.jsx)("div",{children:(0,ae.jsx)(dP,{entity:e,onClick:()=>this.select(e),prediction:"prediction"===e.type,bordered:!1,style:{height:44}})})}),(0,Ne.VS)(Ne.cE)?(0,ae.jsx)(Gb,{root:this.props.root,annotation:e}):!this.state.loaded.has(e.id)&&(0,ae.jsx)("div",{style:{top:0,left:0,position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,ae.jsx)(y.A,{size:"large"})})]},`anno-${e.id}`)),i&&(0,ae.jsxs)("div",{id:"c-tmp",style:{opacity:0,position:"relative",right:99999},children:[(0,ae.jsx)(dP,{entity:n,prediction:"prediction"===n.type,bordered:!1,style:{height:44}}),(0,ae.jsx)(hP,{root:this.props.root,onFinish:this.onFinish,annotation:n},e)]},"anno-tmp")]}),(0,ae.jsx)(Pn.$nd,{size:"small",look:"string",onClick:this.left,className:lP,"aria-label":"Move left",children:(0,ae.jsx)(iP.A,{})}),(0,ae.jsx)(Pn.$nd,{size:"small",look:"string",onClick:this.right,className:cP,"aria-label":"Move right",children:(0,ae.jsx)(oP.A,{})})]})}}function fP(e){const{annotations:t}=e,n=t.filter(e=>!e.hidden).length;return(0,YC.$m)(YC.mQ)&&n>10?(0,ae.jsx)(mP,Object.assign({},e)):(0,ae.jsx)(pP,Object.assign({},e))}const vP=({store:e,annotations:t,root:n})=>{const[i,o]=bn("view-all-tab","summary");return e.store.hasInterface("annotations:summary")&&He.ff.isActive(He.ff.FF_SUMMARY)?(0,ae.jsx)("div",{className:"px-base pt-tighter mt-base",children:(0,ae.jsxs)(Rk.tU,{variant:"default",value:i,onValueChange:e=>o(e),children:[(0,ae.jsxs)(Rk.j7,{children:[(0,ae.jsx)(Rk.Xi,{value:"summary","data-testid":"compare-all-summary-tab",children:"Summary"}),(0,ae.jsx)(Rk.Xi,{value:"compare","data-testid":"compare-all-side-by-side-tab",children:"Side-by-side"})]}),(0,ae.jsx)(Rk.av,{value:"summary",children:(0,ae.jsx)(nP,{store:e,annotations:t})}),(0,ae.jsx)(Rk.av,{value:"compare",children:(0,ae.jsx)(fP,{store:e,annotations:t,root:n})})]})}):(0,ae.jsx)(fP,{store:e,annotations:t,root:n})},yP=e=>{if(null==e||!e.names)return!1;for(const t of e.names.values())if(t.renderInSidebar)return t.sidebar;return!1};class bP extends f.Component{constructor(...e){super(...e),this.relationsRef=f.createRef(),this._notifyScroll=()=>{this.relationsRef.current&&this.relationsRef.current.onResize()}}componentDidMount(){window.blur(),document.body.focus()}renderSuccess(){return(0,ae.jsx)("div",{className:(0,Nn.cn)("editor").toClassName(),children:(0,ae.jsx)(v.Ay,{status:"success",title:(0,u._$)(this.props.store).messages.DONE})})}renderNoAnnotation(){return(0,ae.jsx)("div",{className:(0,Nn.cn)("editor").toClassName(),children:(0,ae.jsx)(v.Ay,{status:"success",title:(0,u._$)(this.props.store).messages.NO_COMP_LEFT})})}renderNothingToLabel(e){return(0,ae.jsxs)("div",{className:(0,Nn.cn)("editor").toClassName(),style:{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",paddingBottom:"30vh"},children:[(0,ae.jsx)(v.Ay,{status:"success",title:(0,u._$)(this.props.store).messages.NO_NEXT_TASK}),(0,ae.jsx)("div",{className:(0,Nn.cn)("sub__result").toClassName(),children:"All tasks in the queue have been completed"}),e.taskHistory.length>0&&(0,ae.jsx)(Pn.$nd,{onClick:t=>e.prevTask(t,!0),variant:"neutral",className:"mx-0 my-4","aria-label":"Previous task",children:"Go to Previous Task"})]})}renderNoAccess(){return(0,ae.jsx)("div",{className:(0,Nn.cn)("editor").toClassName(),children:(0,ae.jsx)(v.Ay,{status:"warning",title:(0,u._$)(this.props.store).messages.NO_ACCESS})})}renderConfigValidationException(e){return(0,ae.jsxs)("div",{className:(0,Nn.cn)("main-view").toClassName(),children:[(0,ae.jsx)("div",{className:(0,Nn.cn)("main-view").elem("annotation").toClassName(),children:(0,ae.jsx)(ye,{errors:this.props.store.annotationStore.validation})}),!(0,Ne.VS)(Ne.bA)&&e.hasInterface("infobar")&&(0,ae.jsxs)("div",{className:(0,Nn.cn)("main-view").elem("infobar").toClassName(),children:["Task #",e.task.id]})]})}renderLoader(){return(0,ae.jsx)(v.Ay,{icon:(0,ae.jsx)(y.A,{size:"large"})})}_renderUI(e,t){var n,i;return t.viewingAll&&(0,u.Zn)(t).hasInterface("annotations:view-all")?this.renderAllAnnotations():(0,ae.jsxs)("div",{className:(0,Nn.cn)("main-view").toClassName(),onScrollCapture:this._notifyScroll,children:[(0,ae.jsxs)("div",{className:(0,Nn.cn)("main-view").elem("annotation").toClassName(),children:[(0,ae.jsx)(Gb,{root:e,annotation:t.selected}),this.renderRelations(t.selected),this.renderCommentsOverlay(t.selected)]}),!(0,Ne.VS)(Ne.bA)&&(0,u.Zn)(t).hasInterface("infobar")&&this._renderInfobar(t)]},null==(n=null!=(i=t.selectedHistory)?i:t.selected)?void 0:n.id)}_renderInfobar(e){const{id:t,queue:n}=(0,u.Zn)(e).task;return(0,ae.jsxs)(Lb,{className:(0,Nn.cn)("main-view").elem("infobar").toClassName(),size:"small",children:[(0,ae.jsxs)("span",{children:["Task #",t]}),n&&(0,ae.jsx)("span",{children:n})]})}renderAllAnnotations(){const e=this.props.store.annotationStore,t=[...e.annotations,...e.predictions];return(0,Ne.VS)(Ne.F5)&&(0,E.sortAnnotations)(t),(0,ae.jsx)(vP,{store:e,annotations:t,root:e.root})}renderRelations(e){var t;const n=e.relationStore,i=null==(t=this.props.store.task)?void 0:t.data;return(0,ae.jsx)(Mx,{store:n,ref:this.relationsRef,tags:e.names,taskData:i},I())}renderCommentsOverlay(e){const{store:t}=this.props,{commentStore:n}=t;return t.hasInterface("annotations:comments")&&n.isCommentable?(0,ae.jsx)(ge,{commentStore:n,annotation:e}):null}render(){var e,t,n,i;const{store:o}=this.props,s=o.annotationStore,a=s.selected&&s.selected.root,{settings:r}=o;if(o.isLoading)return this.renderLoader();if(o.noTask)return this.renderNothingToLabel(o);if(o.noAccess)return this.renderNoAccess();if(o.labeledSuccess)return this.renderSuccess();if(!a)return this.renderNoAnnotation();const l=s.viewingAll,c=(0,ae.jsx)("div",{className:(0,Nn.cn)("main-content").mix(...o.awaitingSuggestions?["requesting"]:[]).toClassName(),children:null===s.validation?this._renderUI(null!=(e=null==(t=s.selectedHistory)?void 0:t.root)?e:a,s):this.renderConfigValidationException(o)}),d=(0,Ne.VS)(Ne.U2)&&!(0,He.EG)()&&o.hasInterface("annotation:bulk"),u=(0,Ne.VS)(Ne.bA);return(0,ae.jsx)("div",{className:(0,Nn.cn)("editor").mod({fullscreen:r.fullscreen}).toClassName(),ref:(0,Ne.VS)(Ne.SM)?Vb(this):null,children:(0,ae.jsxs)($b.Ht,{client:Wb.q,children:[(0,ae.jsx)(Xx,{store:o}),(0,ae.jsx)(b.Kq,{store:o,children:(0,ae.jsxs)(Ub.tE,{children:[u?(0,ae.jsx)(mx,{visible:o.showingDescription,onCancel:()=>o.toggleDescription(),title:o.hasInterface("review")?"Review Instructions":"Labeling Instructions",children:o.description}):(0,ae.jsx)(ae.Fragment,{children:o.showingDescription&&(0,ae.jsx)("div",{className:"p-base mb-base",children:(0,ae.jsx)("div",{dangerouslySetInnerHTML:{__html:(0,fe.sanitizeHtml)(o.description)}})})}),(0,E.isDefined)(o)&&o.hasInterface("topbar")&&(0,ae.jsx)(Pk,{store:o}),(0,ae.jsx)("div",{className:(0,Nn.cn)("wrapper").mod({viewAll:l,bsp:r.effectiveBottomSidePanel,showingBottomBar:u}).toClassName(),children:u?d||!o.hasInterface("side-column")?(0,ae.jsxs)(ae.Fragment,{children:[c,o.hasInterface("topbar")&&(0,ae.jsx)(ux,{store:o})]}):(0,ae.jsxs)(GC,{panelsHidden:l,currentEntity:null!=(n=s.selectedHistory)?n:s.selected,regions:s.selected.regionStore,showComments:o.hasInterface("annotations:comments"),showCustomTab:yP(s.selected),focusTab:o.commentStore.tooltipMessage?"comments":null,children:[c,o.hasInterface("topbar")&&(0,ae.jsx)(ux,{store:o})]}):d||!o.hasInterface("side-column")?c:(0,ae.jsx)(lC,{panelsHidden:l,currentEntity:null!=(i=s.selectedHistory)?i:s.selected,regions:s.selected.regionStore,showComments:o.hasInterface("annotations:comments"),showCustomTab:yP(s.selected),focusTab:o.commentStore.tooltipMessage?"comments":null,children:c})}),(0,ae.jsx)(Ub.US,{})]})}),o.hasInterface("debug")&&(0,ae.jsx)(gx,{store:o})]})})}}const xP=(0,b.PA)(bP),wP={CONFIG:class{static validate(e){const t=[];Ls(e,null,[],t);const n=["id","children","name","toname","controlledTags","parentTypes"],i=[];for(const e of t)try{const o=we.getModelByTag(e.type),s=zs(e,o);null!==s&&i.push(s);const a=Bs(e,o,t);null!==a&&i.push(a);const r=Fs(e,o);null!==r&&i.push(r),i.push(...Vs(e)),i.push(...Hs(e,o,n))}catch(t){i.push(Os.unknownTag(e.type,e.name,e.type))}return i.length?i.map(e=>{return Object.assign({},e,{validType:(t=e.validType,t?((e,t=!0)=>{const n=e.describe().match(/([a-z0-9?|]+)/gi).join("").split("|");if(!1===t){const e=n.indexOf("null?");e>=0&&n.splice(e,1)}return n})(t,!1):null)});var t}):[]}},RESULT:{validate:()=>[]}},SP=Object.keys(wP).reduce((e,t)=>Object.assign({},e,{[t]:t}),{}),CP=u.gK.union(u.gK.string,u.gK.array(u.gK.string)),kP=u.gK.model({modelName:u.gK.string,field:u.gK.string,error:u.gK.string,value:u.gK.maybeNull(u.gK.string),validType:u.gK.maybeNull(CP)}).views(e=>({get identifier(){return[e.modelName,e.field,e.error,e.value].concat(e.validType).filter(e=>null!==e).join("-")}}));class PP{constructor(){this.callbacks=new Set}addErrorCallback(e){return!this.callbacks.has(e)&&(this.callbacks.add(e),!0)}removeErrorCallback(e){return!!this.callbacks.has(e)&&(this.callbacks.delete(e),!0)}validate(e,t){const n=wP[e];let i=[];var o;n?i=(null!=(o=n.validate(t))?o:[]).map(e=>{try{return kP.create(e)}catch(t){throw console.log({compiledError:e}),t}}):console.error(`Unknown validator: ${e}`);setTimeout(()=>{if(i.length)for(const e of this.callbacks)e(i)},0)}}const RP=u.gK.model("StoreExtender",{sharedStores:u.gK.optional(u.gK.map(cv),{})}).actions(e=>({addSharedStore(t){e.sharedStores.set(t.id,t)},beforeReset(){e.sharedStores.forEach(e=>{(0,u.Yo)(e)}),e.sharedStores.clear()},afterReset(){dv.forEach(t=>{e.addSharedStore(t)})},beforeDestroy(){e.sharedStores.forEach(e=>{(0,u.Yo)(e),(0,u.zr)(e)}),e.sharedStores.clear()}})),jP=u.gK.compose("HistoryItem",lf,u.gK.model({comment:u.gK.optional(u.gK.maybeNull(u.gK.string),null),actionType:u.gK.optional(u.gK.maybeNull(u.gK.string),null)})).preProcessSnapshot(e=>{var t,n;return Object.assign({},e,{pk:I(),user:e.created_by,createdDate:e.created_at,actionType:null!=(t=null!=(n=e.action)?n:e.action_type)?t:e.actionType,readonly:!0,editable:!1})}),NP=u.gK.union(lf,jP),TP="annotation-store-viewing-all",_P=u.gK.model("AnnotationStore",{selected:u.gK.maybeNull(u.gK.reference(NP)),selectedHistory:u.gK.maybeNull(u.gK.safeReference(NP)),root:je.allModelsTypes(),names:u.gK.map(u.gK.reference(je.allModelsTypes())),toNames:u.gK.map(u.gK.array(u.gK.reference(je.allModelsTypes()))),annotations:u.gK.array(lf),predictions:u.gK.array(lf),history:u.gK.array(jP),viewingAllAnnotations:u.gK.optional(u.gK.boolean,()=>"true"===window.localStorage.getItem(TP)),validation:u.gK.maybeNull(u.gK.array(kP))}).volatile(()=>({initialized:!1})).views(e=>({get store(){return(0,u.Zn)(e)},get viewingAll(){return!!e.initialized&&(!!e.store.hasInterface("annotations:view-all")&&e.viewingAllAnnotations)}})).actions(e=>{function t(){e.viewingAllAnnotations=!1,window.localStorage.setItem(TP,String(e.viewingAllAnnotations))}function n(t,n,i=!0,o={}){e._unselectAll();const s=n.find(e=>e.id===t||e.pk===String(t))||n[0];if(!s)return null;return e.viewingAll&&!o.exitViewAll||(s.selected=!0),i&&(e.selectedHistory=null,e.history=[]),e.selected=s,s.updateObjects(),"annotation"===s.type&&s.setInitialValues(),s}function i(i,o={}){if(o.exitViewAll&&t(),!e.annotations.length)return null;const{selected:s}=e,a=n(i,e.annotations,!o.retainHistory,o);return!e.viewingAll||o.exitViewAll?a.editable=!0:a.editable=!1,a.setupHotKeys(),(0,u._$)(e).events.invoke("selectAnnotation",a,s,null!=o?o:{}),a.pk&&(0,u.PA)(e).addAnnotationToTaskHistory(a.pk),a}function o(t){return t&&e.addErrors([Os.generalError(t)]),e.root=Pb.create({id:"error"})}function s(t){if(e.root)return;if(!t)return e.root=Pb.create({id:"empty"});let n;try{n=st.treeToModel(t,e.store)}catch(e){return console.error(e),o(e)}const i=we.getModelByTag(n.type),s=we.objectTypes().map(e=>e.name.replace("Model","").toLowerCase()),a=[];e.validate(SP.CONFIG,n);try{e.root=i.create(n)}catch(e){return console.error(e),o(e)}if((0,Ne.VS)(Ne.cE)){const{names:t,toNames:n}=st.extractNames(e.root);return t.forEach(t=>e.names.put(t)),n.forEach((t,n)=>e.toNames.set(n,t)),st.traverseTree(e.root,t=>{e.store.task&&t.updateValue&&t.updateValue(e.store)}),e.initialized=!0,e.root}return st.traverseTree(e.root,t=>{null!=t&&t.name&&(e.addName(t),s.includes(t.type)&&a.push(t.name));t.name&&!s.includes(t.type)&&!t.toname&&1===a.length&&(t.toname=a[0]),t&&t.toname&&e.upsertToName(t),e.store.task&&t.updateValue&&t.updateValue(e.store)}),e.initialized=!0,e.root}function a(t){var n;const{user:i,config:o}=e.store;e.root||s(o);let a=t.pk||t.id;var r;"annotation"===t.type&&a&&isNaN(a)&&(a=null==(r=e.annotations)||null==(r=r[e.annotations.length-1])||null==(r=r.storedValue)?void 0:r.pk);const l=Object.assign({userGenerate:!1,createdDate:en.UDate.currentISODate()},t,{id:I(5),pk:a&&String(a),root:null!=(n=t.root)?n:e.root});return i&&!("createdBy"in l)&&(l.createdBy=i.displayName),t.user&&(l.user=t.user),l}const r=t=>{e.addErrors(t)};return{afterCreate:()=>{e._validator=new PP,e._validator.addErrorCallback(r)},beforeDestroy:()=>{e._validator.removeErrorCallback(r)},toggleViewingAllAnnotations:function(){e.viewingAllAnnotations=!e.viewingAllAnnotations,window.localStorage.setItem(TP,String(e.viewingAllAnnotations)),e.viewingAllAnnotations?(e.selected&&("annotation"===e.selected.type&&e.selected.saveDraftImmediately(),e.selected.unselectAll(),e.selected.selected=!1),(0,Ne.VS)(Ne.F5)&&[...e.predictions,...e.annotations].forEach(t=>{t!==e.selected&&t.updateObjects()}),e.annotations.forEach(e=>{e.editable=!1})):i(e.annotations.at((0,Ne.VS)(Ne.F5)?-1:0).id,{fromViewAll:!0})},initRoot:s,addToName:function(t){e.toNames.set(t.toname,[t.name])},addName:function(t){e.names.put(t)},upsertToName:function(t){const n=e.toNames.get(t.toname);n?n.push(t.name):e.addToName(t)},addPrediction:function(t={}){t.editable=!1,t.type="prediction";const n=a(t);return(0,Ne.VS)(Ne.F5)?(e.predictions.push(n),e.predictions.at(-1)):(e.predictions.unshift(n),e.predictions[0])},addAnnotation:function(t={}){t.type="annotation";const n=a(t);if(n.userGenerate){var i,o;let t;if((0,Ne.VS)(Ne.K3)){const i=(0,E.emailFromCreatedBy)(n.createdBy),o=i&&e.store.users.find(e=>e.email===i);o&&(t=o.id)}n.completed_by=null!=(i=null!=t?t:null==(o=(0,u.Zn)(e).user)?void 0:o.id)?i:void 0}(0,Ne.VS)(Ne.F5)?e.annotations.push(n):e.annotations.unshift(n);const s=e.annotations.at((0,Ne.VS)(Ne.F5)?-1:0);return s.addVersions({result:t.result,draft:t.draft}),s},createAnnotation:function(t={userGenerate:!0}){const n=e.predictions.reduce((e,t)=>[...e,...t._initialAnnotationObj.filter(e=>!1===e.interactive_mode).map(e=>Object.assign({},e))],[]),o=e.addAnnotation(Object.assign({},t,{result:n}));if(n&&n.length){const e={};n.forEach(t=>{if("id"in t){const n=t.id.replace(/#.*$/,`#${o.id}`);e[t.id]=n,t.id=n}}),n.forEach(t=>{t.parent_id&&(e[t.parent_id]?t.parent_id=e[t.parent_id]:t.parent_id=null)}),i(o.id),o.deserializeAnnotation(n),o.reinitHistory()}else o.setDefaultValues();return o},addAnnotationFromPrediction:function(t){const n=t._initialAnnotationObj.map(e=>Object.assign({},e)),o=e.addAnnotation({userGenerate:!0,result:n}),s={};return n.forEach(e=>{if("id"in e){const t=e.id.replace(/#.*$/,`#${o.id}`);s[e.id]=t,e.id=t}}),n.forEach(e=>{e.parent_id&&(s[e.parent_id]?e.parent_id=s[e.parent_id]:e.parent_id=null)}),i(o.id),o.deserializeAnnotation(n),o.reinitHistory(),t.pk&&("prediction"===t.type?o.parent_prediction=Number.parseInt(t.pk):"annotation"===t.type&&(o.parent_annotation=Number.parseInt(t.pk))),o},addHistory:function(t={}){t.type="history",(0,Ne.VS)(Ne.cE)&&(t.root=e.selected.root);const n=a(t);return e.history.push(n),e.history[e.history.length-1]},clearHistory:function(){e.history.forEach(e=>(0,u.zr)(e)),e.history.length=0},selectHistory:function(t){e.selectedHistory=t,setTimeout(()=>{const n=null!=t?t:e.selected;Array.from(n.names.values()).filter(e=>e.isClassificationTag).forEach(e=>e.updateFromResult([])),null==n||n.results.filter(e=>e.area.classification).forEach(e=>null==e.from_name.updateFromResult?void 0:e.from_name.updateFromResult(e.mainValue))}),(0,u._$)(e).events.invoke("selectHistory",e.store,e.selected,e.selectedHistory)},addErrors:t=>{var n;const i=[],o=[...null!=(n=e.validation)?n:[],...t].reduce((e,t)=>{const n=t.identifier;return i.indexOf(n)<0&&(i.push(n),e.push(t)),e},[]);e.validation=o},validate:(t,n)=>e._validator.validate(t,n),selectAnnotation:i,selectPrediction:function(i,o={}){return o.exitViewAll&&t(),n(i,e.predictions,!0,o)},_selectItem:function(t){e._unselectAll(),t.editable=!1,t.selected=!0,e.selected=t,t.updateObjects()},_unselectAll:function(){e.selected&&(e.selected.unselectAll(),e.selected.selected=!1)},deleteAnnotation:function(t){(0,u._$)(e).events.invoke("deleteAnnotation",e.store,t),(0,u.zr)(t),e.clearDeletedParents(t),e.selected=null,e.annotations.length>0&&e.selectAnnotation(e.annotations[0].id)},clearDeletedParents:function(t){null!=t&&t.pk&&e.annotations.forEach(e=>{e.parent_annotation&&+e.parent_annotation===+t.pk&&(e.parent_annotation=null)})},resetAnnotations:()=>{e.selected=null,e.selectedHistory=null,e.annotations=[],e.predictions=[],e.history=[]}}}),AP=u.gK.compose("AnnotationStore",_P,RP),IP=u.gK.model("Project",{id:u.gK.identifierNumber}).views(e=>({get app(){return(0,u.PA)(e)}})),MP="SIDEPANEL_MODE_REGIONS",EP="SIDEPANEL_MODE_LABELS",KP=u.gK.model("SettingsModel",{enableHotkeys:u.gK.optional(u.gK.boolean,!0),enablePanelHotkeys:u.gK.optional(u.gK.boolean,!0),enableTooltips:u.gK.optional(u.gK.boolean,!1),enableLabelTooltips:u.gK.optional(u.gK.boolean,!0),continuousLabeling:!1,selectAfterCreate:!1,fullscreen:u.gK.optional(u.gK.boolean,!1),bottomSidePanel:u.gK.optional(u.gK.boolean,!1),forceBottomPanel:u.gK.optional(u.gK.boolean,!1),collapsibleBottomPanel:u.gK.optional(u.gK.boolean,!1),defaultCollapsedBottomPanel:u.gK.optional(u.gK.boolean,!1),sidePanelMode:u.gK.optional(u.gK.enumeration([MP,EP]),MP),imageFullSize:u.gK.optional(u.gK.boolean,!1),enableAutoSave:u.gK.optional(u.gK.boolean,!1),showLabels:u.gK.optional(u.gK.boolean,!1),showLineNumbers:!1,showAnnotationsPanel:u.gK.optional(u.gK.boolean,!0),showPredictionsPanel:u.gK.optional(u.gK.boolean,!0),preserveSelectedTool:u.gK.optional(u.gK.boolean,!0),enableSmoothing:u.gK.optional(u.gK.boolean,!0),videoHopSize:u.gK.optional(u.gK.number,10),isDestroying:u.gK.optional(u.gK.boolean,!1),videoDrawOutside:u.gK.optional(u.gK.boolean,!1),invertedZoom:u.gK.optional(u.gK.boolean,!1)}).views(e=>({get annotation(){return(0,u.Zn)(e).annotationStore.selected},get displayLabelsByDefault(){return e.sidePanelMode===EP},get effectiveBottomSidePanel(){return!!e.forceBottomPanel||e.bottomSidePanel}})).actions(e=>({beforeDestroy(){e.isDestroying=!0},afterCreate(){try{const{localStorage:e}=window;if(!e)return}catch(e){return}const t="labelStudio:settings",n=localStorage.getItem(t);if(n){const t=JSON.parse(n);"object"==typeof t&&null!==t&&Object.keys(t).forEach(n=>{n in e&&(e[n]=t[n])})}else{const t=(0,u._$)(e);Object.keys(Kx).map(n=>{"boolean"==typeof t.settings[n]?e[n]=t.settings[n]:e[n]=Kx[n].defaultValue})}(0,u.aQ)(e,n=>{setTimeout(()=>{e.isDestroying||localStorage.setItem(t,JSON.stringify(n))})})},toggleShowLabels(){e.showLabels=!e.showLabels;const t=(0,u.Zn)(e).annotationStore.selected;t&&t.updateAppearenceFromState()},toggleShowLineNumbers(){e.showLineNumbers=!e.showLineNumbers},toggleContinuousLabeling(){e.continuousLabeling=!e.continuousLabeling},toggleSelectAfterCreate(){e.selectAfterCreate=!e.selectAfterCreate},toggleSidepanelModel(){e.sidePanelMode=e.sidePanelMode===EP?MP:EP,e.annotation.regionStore.setView(e.displayLabelsByDefault?"labels":"regions")},toggleAutoSave(){e.enableAutoSave=!e.enableAutoSave},togglepreserveSelectedTool(){e.preserveSelectedTool=!e.preserveSelectedTool},toggleHotkeys(){e.enableHotkeys=!e.enableHotkeys,e.enableHotkeys?Fn.setScope(Fn.DEFAULT_SCOPE):Fn.setScope("__none__")},togglePanelHotkeys(){e.enablePanelHotkeys=!e.enablePanelHotkeys},toggleTooltips(){e.enableTooltips=!e.enableTooltips},toggleFullscreen(){e.fullscreen=!e.fullscreen},toggleBottomSP(){e.forceBottomPanel||(e.bottomSidePanel=!e.bottomSidePanel)},toggleImageFS(){e.imageFullSize=!e.imageFullSize},toggleLabelTooltips(){e.enableLabelTooltips=!e.enableLabelTooltips},toggleAnnotationsPanel(){e.showAnnotationsPanel=!e.showAnnotationsPanel},togglePredictionsPanel(){e.showPredictionsPanel=!e.showPredictionsPanel},toggleSmoothing(){e.enableSmoothing=!e.enableSmoothing},setSmoothing(t){e.enableSmoothing=t},toggleInvertedZoom(){e.invertedZoom=!e.invertedZoom},setInvertedZoom(t){e.invertedZoom=t},setVideoHopSize(t){e.videoHopSize=t},setProperty(t,n){e[t]=n},toggleProperty(t){e[t]=!e[t]}})),DP=u.gK.model({enable:u.gK.optional(u.gK.boolean,!1),username:u.gK.string,password:u.gK.string,to:u.gK.string}),OP=u.gK.model("Task",{id:u.gK.maybeNull(u.gK.number),load:u.gK.optional(u.gK.boolean,!1),auth:u.gK.maybeNull(DP),agreement:u.gK.maybeNull(u.gK.number),data:u.gK.maybeNull(u.gK.string),source:u.gK.optional(u.gK.maybeNull(u.gK.string),null),queue:u.gK.optional(u.gK.maybeNull(u.gK.string),null),allow_skip:u.gK.optional(u.gK.maybeNull(u.gK.boolean),!0)}).views(e=>({get app(){return(0,u.PA)(e)},get dataObj(){const t=en.Checkers.isStringJSON(e.data)?JSON.parse(e.data):"object"==typeof e.data?e.data:null;return t&&e.source&&(t.source=e.source),t}})),LP=u.gK.model({controls:u.gK.frozen({})}).actions(e=>({addLabel(t,n){var i;const o={path:n,origin:"session"},s=[...null!=(i=e.controls[t])?i:[],o];e.controls=Object.assign({},e.controls,{[t]:s})},deleteLabel(t,n){if(!e.controls[t])return;const i=e.controls[t].filter(e=>e.path.length!==n.length||!e.path.every((e,t)=>e===n[t]));e.controls=Object.assign({},e.controls,{[t]:i})},init(t){const n={};for(const e in t)n[e]=t[e].map(e=>({origin:"user",path:e}));e.controls=n}})),zP=u.gK.model("CustomButton",{id:u.gK.optional(u.gK.identifier,I),name:u.gK.string,title:u.gK.string,variant:u.gK.maybe(u.gK.enumeration(["primary","neutral","positive","negative","warning","inverted"])),look:u.gK.maybe(u.gK.enumeration(["filled","outlined","string"])),size:u.gK.maybe(u.gK.enumeration(["medium","small","smaller"])),tooltip:u.gK.maybe(u.gK.string),ariaLabel:u.gK.maybe(u.gK.string),disabled:u.gK.maybe(u.gK.boolean),props:u.gK.maybe(u.gK.frozen())}).actions(e=>({updateState(t){for(const n in t)n in e&&(e[n]=t[n])}})),BP=Fn("AppStore","Global Hotkeys"),FP=u.gK.model("AppStore",{config:u.gK.string,task:u.gK.maybeNull(OP),project:u.gK.maybeNull(IP),taskHistory:u.gK.array(u.gK.model({taskId:u.gK.number,annotationId:u.gK.maybeNull(u.gK.string)}),[]),interfaces:u.gK.array(u.gK.string),explore:u.gK.optional(u.gK.boolean,!1),annotationStore:u.gK.optional(AP,{annotations:[],predictions:[],history:[]}),commentStore:u.gK.optional(zp,{comments:[]}),user:u.gK.optional(u.gK.maybeNull(u.gK.safeReference(Ep)),null),debug:!0===window.HTX_DEBUG,settings:u.gK.optional(KP,{}),description:u.gK.maybeNull(u.gK.string),showingSettings:u.gK.optional(u.gK.boolean,!1),showingDescription:u.gK.optional(u.gK.boolean,!1),isLoading:u.gK.optional(u.gK.boolean,!1),isSubmitting:!1,noTask:u.gK.optional(u.gK.boolean,!1),noAccess:u.gK.optional(u.gK.boolean,!1),overlapReached:u.gK.optional(u.gK.boolean,!1),overlapReachedMessage:u.gK.optional(u.gK.string,"Annotation overlap has been reached for this task. Your draft is preserved but cannot be submitted."),labeledSuccess:u.gK.optional(u.gK.boolean,!1),showComments:!1,_autoAnnotation:!1,_autoAcceptSuggestions:!1,awaitingSuggestions:!1,users:u.gK.optional(u.gK.array(Ep),[]),userLabels:(0,Ne.VS)(Ne.RI)?u.gK.optional(LP,{controls:{}}):u.gK.undefined,queueTotal:u.gK.optional(u.gK.number,0),queuePosition:u.gK.optional(u.gK.number,0),commentClassificationConfig:u.gK.maybeNull(u.gK.string),customButtons:u.gK.map(u.gK.union(u.gK.string,zP,u.gK.array(u.gK.union(u.gK.string,zP))))}).preProcessSnapshot(e=>{if("number"!=typeof e.user){var t,n,i;const s=null!=(t=null!=(n=e.user)?n:null==(i=window.APP_SETTINGS)?void 0:i.user)?t:null;var o;if(s)e.user=s.id,e.users=null!=(o=e.users)&&o.length?[s,...e.users.filter(({id:e})=>e!==s.id)]:[s]}return Array.isArray(e.customButtons)&&(e.customButtons={_replace:e.customButtons}),Object.assign({},e,{_autoAnnotation:"true"===localStorage.getItem("autoAnnotation"),_autoAcceptSuggestions:"true"===localStorage.getItem("autoAcceptSuggestions")})}).volatile(()=>({version:"string"==typeof LSF_VERSION?LSF_VERSION:"0.0.0",initialized:!1,hydrated:!1,suggestionsRequest:null,simpleInit:(0,Ne.VS)(Ne.F5)})).views(e=>({get events(){return(0,u._$)(e).events},get hasSegmentation(){return Array.from(e.annotationStore.names.values()).some(e=>!e.getAvailableStates&&!e.perRegionVisible)},get canGoNextTask(){if(e.task&&e.taskHistory&&e.taskHistory.length>1){const t=e.taskHistory[e.taskHistory.length-1].taskId;return e.task.id!==t}return!1},get canGoPrevTask(){if(e.task&&e.taskHistory&&e.taskHistory.length>1){const t=e.taskHistory[0].taskId;return e.task.id!==t}return!1},get forceAutoAnnotation(){return(0,u._$)(e).forceAutoAnnotation},get forceAutoAcceptSuggestions(){return(0,u._$)(e).forceAutoAcceptSuggestions},get autoAnnotation(){return e.forceAutoAnnotation||e._autoAnnotation},get autoAcceptSuggestions(){return e.forceAutoAcceptSuggestions||e._autoAcceptSuggestions}})).actions(e=>{let t;function n(e,t="warning"){dn[t](e)}function i(t,i="Error during submit"){if(e.isSubmitting)return;e.setFlags({isSubmitting:!0});const o=t();e.commentStore.setAddedCommentThisSession(!1),Promise.race([Promise.all([o,(0,E.delay)(200)]),(0,E.delay)(5e3)]).catch(e=>{n((null==e?void 0:e.message)||e||i),console.error(e)}).then(()=>e.setFlags({isSubmitting:!1}))}return{setFlags:function(t){const n=["showingSettings","showingDescription","isLoading","isSubmitting","noTask","noAccess","overlapReached","overlapReachedMessage","labeledSuccess","awaitingSuggestions"];for(const i of n)i in t&&(e[i]=t[i])},addInterface:function(t){return e.interfaces.push(t)},hasInterface:function(...t){return void 0!==e.interfaces.find(e=>t.includes(e))},toggleInterface:function(t,n){const i=e.interfaces.indexOf(t);if(null!=n?n:i<0)i<0&&e.interfaces.push(t);else{if(i<0)return;e.interfaces.splice(i,1)}},afterCreate:function(){pd.setRoot(e),window.Htx=e,e.attachHotkeys(),(0,u._$)(e).events.invoke("labelStudioLoad",e)},assignTask:function(t){t&&!en.Checkers.isString(t.data)&&(t=Object.assign({},t,{data:JSON.stringify(t.data)})),e.task=OP.create(t),e.taskHistory.some(t=>t.taskId===e.task.id)||e.taskHistory.push({taskId:e.task.id,annotationId:null})},assignConfig:function(t){const n=e.annotationStore;e.config=t,n.initRoot(e.config)},resetState:function(){pd.removeAllTools(),Fn.unbindAll(),e.attachHotkeys();const t=e.annotationStore;t&&(null==t.beforeReset||t.beforeReset(),(0,Ne.VS)(Ne.C8)&&pv(),(0,u.Yo)(t),(0,u.zr)(t)),(0,YC.$m)(YC.mQ)&&He.oF.forceClear(),e.annotationStore=AP.create({annotations:[]}),e.initialized=!1},resetAnnotationStore:function(){const t=e.annotationStore;t&&(null==t.beforeReset||t.beforeReset(),null==t.resetAnnotations||t.resetAnnotations())},initializeStore:function({annotations:n=[],completions:i=[],predictions:o=[],annotationHistory:s}){const a=e.annotationStore;var r,l;if(null==a.afterReset||a.afterReset(),a.initialized||(a.initRoot(e.config),!(0,Ne.VS)(Ne.SM)||null!=(r=t)&&r.isRendered()||null==(l=t)||l.render()),e.simpleInit){window.STORE_INIT_OK=!1,o.forEach(e=>{const t=a.addPrediction(e),n=e.result.map(e=>Object.assign({},e,{origin:"prediction"}));t.deserializeResults(n,{hidden:!0})}),[...i,...n].forEach(e=>{a.addAnnotation(e).deserializeResults(e.draft||e.result,{hidden:!0})}),window.STORE_INIT_OK=!0,console.log("LSF: deserialization is finished");const e=a.annotations.at(-1),t=!e&&a.predictions.at(-1);e?(a.selectAnnotation(e.id),e.reinitHistory()):t&&a.selectPrediction(t.id)}else{var c;(null!=o?o:[]).forEach(e=>{const t=a.addPrediction(e);a.selectPrediction(t.id),t.deserializeResults(e.result.map(e=>Object.assign({},e,{origin:"prediction"})))}),null==(c=[...null!=i?i:[],...null!=n?n:[]])||c.forEach(e=>{const t=a.addAnnotation(e);a.selectAnnotation(t.id),t.deserializeResults(e.draft||e.result),t.reinitHistory()});const t=a.annotations.at(-1);t&&t.setInitialValues(),e.setHistory(s)}e.initialized||(e.initialized=!0,(0,u._$)(e).events.invoke("storageInitialized",e))},setHistory:function(t=[]){var n;const i=e.annotationStore;i.clearHistory(),t.length&&null!=(n=i.selected)&&n.pk&&Number(i.selected.pk)===Number(t[0].annotation_id)&&(null!=t?t:[]).forEach(e=>{var t;i.addHistory(e).deserializeResults(null!=(t=e.result)?t:[],{hidden:!0})})},attachHotkeys:function(){BP.unbindAll(),e.hasInterface("submit","update","review")&&BP.addNamed("annotation:submit",()=>{const t=e.annotationStore,n=e.hasInterface("annotations:deny-empty"),i=t.selected,o=0===i.results.length,s=e.hasInterface("review")||i.canBeReviewed,a=!s&&(0,E.isDefined)(i.pk),r=!i.history.canUndo&&!i.draftId,l=(0,Ne.VS)(Ne.I8)&&a&&r;if(!(n&&o||t.viewingAll||l||i.isReadOnly()))if(null==i||i.submissionInProgress(),e.hasInterface("annotation:bulk")){var c;const t=null==(c=e.customButtons)?void 0:c.get("_replace"),n=null==t?void 0:t.find(e=>"submit"===e.name);n&&!n.disabled&&(null==e.handleCustomButton||e.handleCustomButton(n))}else s?e.acceptAnnotation():!a&&e.hasInterface("submit")?e.submitAnnotation():e.hasInterface("update")&&e.updateAnnotation()}),e.hasInterface("skip","review")&&BP.addNamed("annotation:skip",()=>{if(e.annotationStore.viewingAll)return;const t=e.annotationStore.selected;null==t||t.submissionInProgress(),e.hasInterface("review")?e.rejectAnnotation():e.skipTask()}),BP.addNamed("region:delete-all",()=>{const{selected:t}=e.annotationStore;window.confirm((0,u._$)(e).messages.CONFIRM_TO_DELETE_ALL_REGIONS)&&t.deleteAllRegions()}),BP.addNamed("region:relation",()=>{const t=e.annotationStore.selected;t&&t.highlightedNode&&!t.isLinkingMode&&t.startLinkingMode(P,t.highlightedNode)}),BP.addNamed("region:focus",t=>{t.preventDefault();const n=e.annotationStore.selected;n&&n.highlightedNode&&!n.isLinkingMode&&n.highlightedNode.requestPerRegionFocus()}),BP.addNamed("region:unselect",()=>{const t=e.annotationStore.selected;!t||t.isLinkingMode||t.isDrawing||(e.annotationStore.history.forEach(e=>{e.unselectAll()}),t.unselectAll())}),BP.addNamed("region:visibility",()=>{const t=e.annotationStore.selected;t&&!t.isLinkingMode&&t.hideSelectedRegions()}),BP.addNamed("region:lock",()=>{const t=e.annotationStore.selected;t&&!t.isLinkingMode&&t.lockSelectedRegions()}),BP.addNamed("region:visibility-all",()=>{const{selected:t}=e.annotationStore;t.regionStore.toggleVisibility()}),BP.addNamed("annotation:undo",()=>{e.annotationStore.selected.undo()}),BP.addNamed("annotation:redo",()=>{e.annotationStore.selected.redo()}),BP.addNamed("region:exit",t=>{t.stopImmediatePropagation();const n=e.annotationStore.selected,i=pd.allInstances().map(e=>e.findSelectedTool()).filter(Boolean).filter(e=>e.isDrawing);i.length>0?i.forEach(e=>null==e.complete?void 0:e.complete()):n&&n.isLinkingMode?n.stopLinkingMode():n.isDrawing||n.unselectAll()}),BP.addNamed("region:delete",()=>{const t=e.annotationStore.selected;t&&t.deleteSelectedRegions()}),BP.addNamed("region:cycle",()=>{const t=e.annotationStore.selected;t&&t.regionStore.selectNext()}),BP.addNamed("region:duplicate",t=>{const{selected:n}=e.annotationStore,{serializedSelection:i}=n||{};if(null==i||!i.length)return;t.preventDefault();const o=n.appendResults(i);n.selectAreas(o)})},skipTask:function(t){var n,o;if(e.isSubmitting)return;const s=null==(n=window.APP_SETTINGS)||null==(n=n.billing)?void 0:n.enterprise,a=e.task,r=!!s&&!1===(null==a?void 0:a.allow_skip),l=null==(o=window.APP_SETTINGS)||null==(o=o.user)?void 0:o.role,c=["OW","AD","MA"].includes(l);!r||c?i(()=>{(0,u._$)(e).events.invoke("skipTask",e,t),e.incrementQueuePosition()},"Error during skip, try again"):console.warn("Task cannot be skipped: allow_skip is false and user lacks manager role")},unskipTask:function(){e.isSubmitting||i(()=>{(0,u._$)(e).events.invoke("unskipTask",e)},"Error during cancel skipping task, try again")},setTaskHistory:function(t){e.taskHistory=t},submitDraft:function(t,n={}){return new Promise(i=>{const o=(0,u._$)(e).events;if(!o.hasEvent("submitDraft"))return i();const s=o.invokeFirst("submitDraft",e,t,n);s&&s.then?s.then(i):i(s)})},waitForDraftSubmission:function(){return new Promise(t=>{e.annotationStore.selected.isDraftSaving||t();const n=setInterval(()=>{e.annotationStore.selected.isDraftSaving||(clearInterval(n),t())},100)})},submitAnnotation:function(){if(e.isSubmitting)return;const t=e.annotationStore.selected,n=t.exists?"updateAnnotation":"submitAnnotation";t.beforeSend(),t.validate()&&((0,Ne.VS)(Ne.Bg)||t.sendUserGenerate(),i(async()=>{if((0,Ne.VS)(Ne.Bg)){await e.waitForDraftSubmission();const i=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,t,{event:n});if(i&&i.some(e=>!1===e))return;t.sendUserGenerate()}await(0,u._$)(e).events.invoke(n,e,t),e.incrementQueuePosition(),(0,Ne.VS)(Ne.Bg)&&t.dropDraft()}),(0,Ne.VS)(Ne.Bg)||t.dropDraft())},updateAnnotation:function(t){if(e.isSubmitting)return;const n=e.annotationStore.selected;n.beforeSend(),n.validate()&&(i(async()=>{if((0,Ne.VS)(Ne.Bg)){const t=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,n,{event:"updateAnnotation"});if(t&&t.some(e=>!1===e))return}await(0,u._$)(e).events.invoke("updateAnnotation",e,n,t),e.incrementQueuePosition(),(0,Ne.VS)(Ne.Bg)&&(n.dropDraft(),!n.sentUserGenerate&&n.sendUserGenerate())}),(0,Ne.VS)(Ne.Bg)||(n.dropDraft(),!n.sentUserGenerate&&n.sendUserGenerate()))},acceptAnnotation:function(){e.isSubmitting||i(async()=>{const t=e.annotationStore.selected;if(t.beforeSend(),!t.validate())return;if((0,Ne.VS)(Ne.Bg)){const n=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,t,{event:"acceptAnnotation"});if(n&&n.some(e=>!1===e))return}const n=t.history.canUndo||t.versions.draft;t.dropDraft(),await(0,u._$)(e).events.invoke("acceptAnnotation",e,{isDirty:n,entity:t}),e.incrementQueuePosition()},"Error during accept, try again")},rejectAnnotation:function({comment:t=null}){e.isSubmitting||i(async()=>{const n=e.annotationStore.selected;if(n.beforeSend(),!n.validate())return;if((0,Ne.VS)(Ne.Bg)){const t=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,n,{event:"rejectAnnotation"});if(t&&t.some(e=>!1===e))return}const i=n.history.canUndo;n.dropDraft(),await(0,u._$)(e).events.invoke("rejectAnnotation",e,{isDirty:i,entity:n,comment:t}),e.incrementQueuePosition(-1)},"Error during reject, try again")},handleCustomButton:function(t){if(e.isSubmitting)return;const n=t.name;i(async()=>{const i=e.annotationStore.selected;i.beforeSend();const o=i.history.canUndo;await(0,u._$)(e).events.invoke("customButton",e,n,{isDirty:o,entity:i,button:t}),e.incrementQueuePosition(),i.dropDraft()},`Error during handling ${t} button, try again`)},presignUrlForProject:async function(t){const n=await e.events.invoke("presignUrlForProject",e,t);return null==n?void 0:n[0]},setUsers:function(t){e.users.replace(t)},mergeUsers:function(t){e.setUsers(Ap()([...(0,u.dV)(e.users),...t],"id"))},enrichUsers:function(t){const n=(0,u.dV)(e.users),i={};n.forEach(e=>{i[e.id]=e});const o=t.map(e=>Object.assign({},i[e.id],e));e.setUsers(Ap()([...o,...n],"id"))},showModal:n,toggleComments:function(t){return e.showComments=t},toggleSettings:function(){e.showingSettings=!e.showingSettings},toggleDescription:function(){e.showingDescription=!e.showingDescription},setAutoAnnotation:t=>{e._autoAnnotation=t,localStorage.setItem("autoAnnotation",t)},setAutoAcceptSuggestions:t=>{e._autoAcceptSuggestions=t,localStorage.setItem("autoAcceptSuggestions",t)},loadSuggestions:(0,u.L3)(function*(t,n){const i=I();e.suggestionsRequest=i,e.setFlags({awaitingSuggestions:!0});try{const o=yield t;i===e.suggestionsRequest&&(e.annotationStore.selected.setSuggestions(n(o)),e.setFlags({awaitingSuggestions:!1}))}catch(t){e.setFlags({awaitingSuggestions:!1})}}),addAnnotationToTaskHistory:function(t){const n=e.taskHistory.findIndex(({taskId:t})=>t===e.task.id);n>=0&&(e.taskHistory[n].annotationId=t)},nextTask:function(){if(e.canGoNextTask){const{taskId:t,annotationId:n}=e.taskHistory[e.taskHistory.findIndex(t=>t.taskId===e.task.id)+1];(0,u._$)(e).events.invoke("nextTask",t,n),e.incrementQueuePosition()}},prevTask:function(t,n=!1){const i=n?e.taskHistory.length-1:e.taskHistory.findIndex(t=>t.taskId===e.task.id)-1;if(e.canGoPrevTask||n){const{taskId:t,annotationId:n}=e.taskHistory[i];(0,u._$)(e).events.invoke("prevTask",t,n),e.incrementQueuePosition(-1)}},postponeTask:async function(){const t=e.annotationStore.selected;await t.saveDraft({was_postponed:!0}),await(0,u._$)(e).events.invoke("nextTask"),e.incrementQueuePosition()},incrementQueuePosition:function(t=1){e.queuePosition=(0,E.clamp)(e.queuePosition+t,1,e.queueTotal)},beforeDestroy(){pd.removeAllTools(),t=null},setAppControls:function(e){t=e},clearApp:function(){var e;null==(e=t)||e.clear()},renderApp:function(){var e;null==(e=t)||e.render()},selfDestroy(){const t=[];let n;for((0,u.GG)(e,n=>{(0,u.jX)(n)||(0,u.PA)(n)!==e||t.push(n)});n=t.shift();)try{(0,u.zr)(n)}catch(e){console.log("Problem: ",e)}}}}),HP=async(e,t)=>{var i,o,s,a,r,l,c,d,u,h;null!=(i=e.options)&&i.secureMode&&(window.LS_SECURE_MODE=!0);const g=await(async()=>(await n.e(99).then(n.bind(n,64099))).default)();if(null!=(o=e=Object.assign({},e))&&null!=(o=o.settings)&&o.forceBottomPanel&&(e.bottomSidePanel=!0,e.settings=Object.assign({},e.settings||{},{forceBottomPanel:!0})),null!=(s=e)&&s.config||!g.getExample)null!=(a=e)&&a.task&&(e.task=g.getData(e.task));else{const{task:t,config:n}=await g.getExample();e.config=n,e.task=t}null!=(r=e.task)&&r.id&&(e.taskHistory=[{taskId:e.task.id,annotationId:null}]);const m=FP.create(e,Object.assign({},g.configureApplication(e),{events:t}));return m.initializeStore(Object.assign({},null!=(l=e.task)?l:{},{hydrated:null==(c=null==(d=e)?void 0:d.hydrated)||c,users:null!=(u=e.users)?u:[],annotationHistory:null!=(h=e.history)?h:[]})),{store:m,getRoot:g.rootElement}};class VP extends f.Component{constructor(...e){super(...e),this.state={initialized:!1}}componentDidMount(){HP(this.props).then(({store:e})=>{this.store=e,window.Htx=this.store,this.setState({initialized:!0})})}componentDidUpdate(e){this.props.task!==e.task&&(this.store.resetState(),this.store.assignTask(this.props.task),this.store.initializeStore(this.props.task))}render(){return this.state.initialized?(0,ae.jsx)(xP,{store:this.store}):null}}var $P=n(30997);const WP={interfaces:["panel","update","submit","skip","controls","infobar","topbar","instruction","side-column","annotations:history","annotations:tabs","annotations:menu","annotations:current","annotations:add-new","annotations:delete","annotations:view-all","predictions:tabs","predictions:menu","auto-annotation","edit-history"]};class UP{constructor(){this.events=new Map}on(e,t){const n=this.getEventMap(e);n.has(t)||n.add(t)}off(e,t){const n=this.getEventMap(e);n.has(t)&&n.delete(t)}removeAll(e){this.getEventMap(e).clear()}invoke(e,...t){const n=this.getEventMap(e);if(n.size>0)return Promise.all([...n].map(e=>e(...t)))}invokeFirst(e,...t){const n=this.getEventMap(e);if(n.size>0){return Array.from(n)[0](...t)}}hasEvent(e){return this.getEventMap(e).size>0}getEventMap(e){let t;return this.events.has(e)?t=this.events.get(e):(t=new Set,this.events.set(e,t)),t}}(0,d.jK)({isolateGlobalState:!0});class GP{static destroyAll(){GP.instances.forEach(e=>null==e.destroy?void 0:e.destroy()),GP.instances.clear()}getRootElement(e){let t=null;if(t="string"==typeof e?document.getElementById(e):e,!t)throw new Error(`Root element not found (selector: ${e})`);return t}constructor(e,t={}){var n,i;this.options=void 0,this.root=void 0,this.store=void 0,this.reactRoot=void 0,this.destroy=()=>{},this.events=new UP;const o=Object.assign({},WP,t);o.keymap&&Fn.setKeymap(o.keymap),this.root=e,this.options=o,"v18"===(null==(n=o.instanceOptions)?void 0:n.reactVersion)?this.createAppV18():this.createAppV17(),window.Htx&&(window.Htx.Hotkey=Fn),this.supportLegacyEvents(),"v18"!==(null==(i=o.instanceOptions)?void 0:i.reactVersion)&&GP.instances.add(this)}on(e,t){this.events.on(e,t)}off(e,t){(0,E.isDefined)(t)?this.events.off(e,t):this.events.removeAll(e)}async createAppV17(){const{store:e}=await HP(this.options,this.events),t=this.getRootElement(this.root);this.store=e,window.Htx=this.store;const n=!1,i=()=>{(0,h.render)((0,ae.jsx)(xP,{store:this.store}),t)},o=()=>{var e;if(null==(e=t.childNodes)||!e.length)return;const n=[...t.childNodes],i=Bb(n[0]);(0,h.unmountComponentAtNode)(t),Fb(n,i),Fb([t],i)};i(),e.setAppControls({isRendered:()=>n,render:i,clear:o}),this.destroy=()=>{(0,Ne.VS)(Ne.SM)&&o(),pv(),(0,Ne.VS)(Ne.SM)&&this.store.selfDestroy(),(0,u.zr)(this.store),Fn.unbindAll(),(0,Ne.VS)(Ne.SM)&&(this.store=null,this.destroy=null,GP.instances.delete(this))}}async createAppV18(){const{store:e}=await HP(this.options,this.events),t=this.getRootElement(this.root);this.store=e,window.Htx=this.store;let n=!1;const i=()=>{n&&o(),this.reactRoot=(0,g.H)(t);const e=xP;this.reactRoot.render((0,ae.jsx)(e,{store:this.store})),n=!0},o=()=>{this.reactRoot&&n&&(this.reactRoot.unmount(),this.reactRoot=null,n=!1)};i(),e.setAppControls({isRendered:()=>n,render:i,clear:o}),this.destroy=()=>{o(),pv(),(0,u.zr)(this.store),Fn.unbindAll(),this.store=null,window.Htx=null,this.destroy=null}}supportLegacyEvents(){Object.keys($P.A).forEach(e=>{const t=this.options[e];if((0,E.isDefined)(t)){const n=p()(e.replace(/^on/,""));this.events.on(n,t)}})}}GP.Component=VP,GP.instances=new Set,window.LabelStudio=GP;const YP=GP},57160:()=>{},72902:(e,t,n)=>{"use strict";n.r(t),n.d(t,{colorToRGBA:()=>d,colorToRGBAArray:()=>v,contrastColor:()=>f,convertToRGBA:()=>u,getScaleGradient:()=>m,hexToRGBA:()=>c,over:()=>x,removeAlpha:()=>p,rgbArrayToHex:()=>y,rgbaArrayToRGBA:()=>b,rgbaChangeAlpha:()=>g,stringToColor:()=>h});var i=n(21091);const o=["#c22525","#c13025","#bf3b24","#be4624","#bc5124","#bb5b23","#ba6623","#b87023","#b77a22","#b58422","#b48d22","#b39722","#b1a021","#b0aa21","#aaae21","#9ead20","#93ab20","#87aa20","#7ca91f","#71a71f","#66a61f","#5ba41e","#51a31e","#46a21e","#3ca01e","#329f1d","#289d1d","#1e9c1d","#1c9a24","#1c992d","#1c992d"],s={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},a=/^rgba\((25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*(?:,\s*([01]\.?\d*?))\)$/,r=/^rgb\((25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*\)$/;function l(e){const t=[0,0,0];return e&&4===e.length?(t[0]=`0x${e[1]}${e[1]}`,t[1]=`0x${e[2]}${e[2]}`,t[2]=`0x${e[3]}${e[3]}`):e&&7===e.length&&(t[0]=`0x${e[1]}${e[2]}`,t[1]=`0x${e[3]}${e[4]}`,t[2]=`0x${e[5]}${e[6]}`),t.map(e=>+e)}function c(e,t){const n=l(e);let i=.3;return"number"==typeof Number.parseInt(t)&&(i=t),`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${i})`}function d(e,t){if("string"==typeof e){return c(s[e.toLowerCase()],t)}return e}function u(e,t){const n=v(e);return n[3]=Number(t)===t?t:n[3],b(n)}function h(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);let n="#";for(let e=0;e<3;e++){n+=`00${(t>>8*e&255).toString(16)}`.substr(-2)}return n}function g(e,t){return e.replace(/[\d\.]+\)$/g,`${t})`)}function m(e){return o[Math.ceil(30*e)]}const p=(e,t,n,i,o=[255,255,255,1])=>{const s=[];return s[3]=1-(1-i)*(1-o[3]),s[0]=Math.round(e*i/s[3]+o[0]*o[3]*(1-i)/s[3]),s[1]=Math.round(t*i/s[3]+o[1]*o[3]*(1-i)/s[3]),s[2]=Math.round(n*i/s[3]+o[2]*o[3]*(1-i)/s[3]),s},f=e=>{const[t,n,i]=p(...e.match(/([0-9.]{1,3})/g).map(Number));return(299*t+587*n+114*i)/1e3>=128?"rgb(0,0,0)":"rgb(255,255,255)"};function v(e){if(e){if("#"===e.charAt(0)){const t=l(e);return t.push(1),t}let t;if(t=a.exec(e))return t.slice(1,5).map(e=>+e);if(t=r.exec(e)){const e=t.slice(1,4);return e.push(1),e.map(e=>+e)}if("string"==typeof e){const t=l(s[e.toLowerCase()]);return t.push(1),t}}return[0,0,0,1]}function y(e){const t=e.slice(0,3).map(e=>(256|e).toString(16).slice(1));return t.unshift("#"),t.join("")}function b(e){return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`}function x(e,t="white"){e=(0,i.A)(e),t=(0,i.A)(t);const n=e.alpha(),o=t.alpha()*(1-n),s=n+o,a=t.rgb()||[];return(0,i.A)([...e.rgb().map((e,t)=>(n*e+o*a[t])/s),s])}},78438:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var i=n(83960),o=n(21091),s=n(47895),a=n(72902),r=n(84826);function l(e,t,n,i,s,a){const[r,l,c]=(0,o.A)(s).rgb(),d=e.getImageData(0,0,n,i),u=new ArrayBuffer(n*i*4),h=new Uint32Array(u),g=new Uint8ClampedArray(u),m=function(){const e=new ArrayBuffer(2),t=new Uint8Array(e),n=new Uint16Array(e);if(t[0]=170,t[1]=187,48042===n[0])return"little endian";if(43707===n[0])return"big endian";return console.error("Can not determine platform endianness, assuming little endian"),"little endian"}();let p,f,v;"little endian"===m?p=255<<24|c<<16|l<<8|r:"big endian"===m?p=r<<24|l<<16|c<<8|255:(console.error(`Unknown platform endianness (${m}), assuming little endian`),p=255<<24|c<<16|l<<8|r);const y=a;for(v=0;v<=i;v++)for(f=0;f<=n;f++){const e=v*n+f;t[e*y]&&(h[e]=p)}d.data.set(g),e.putImageData(d,0,0)}const c={Region2RLE:function(e){var t;if((0,r.VS)(r.gF))return function(e){const{naturalWidth:t,naturalHeight:n}=e.currentImageEntity,o=document.createElement("canvas");o.width=t,o.height=n,o.style.setProperty("position","absolute"),o.style.setProperty("bottom","200%"),o.style.setProperty("right","200%"),o.style.setProperty("opacity","0");const s=o.getContext("2d");if(document.body.appendChild(o),e.rle&&e.rle.length>0){const o=s.createImageData(t,n);o.data.set((0,i.D)(e.rle)),s.putImageData(o,0,0)}const a=null==e.getMaskImage?void 0:e.getMaskImage();a&&s.drawImage(a,0,0),e.touches.length>0&&e.touches.forEach(e=>{const{relativePoints:i}=e.toJSON(),o=(e,i)=>[t*(e/100),n*(i/100)];s.save(),s.beginPath(),s.moveTo(...o(i[0],i[1]));for(let e=0;e<i.length/2;e++)s.lineTo(...o(i[2*e],i[2*e+1]));s.strokeStyle="#000",s.lineWidth=e.relativeStrokeWidth/100*t,s.lineCap="round",s.lineJoin="round",s.globalCompositeOperation=e.compositeOperation,s.stroke()});const r=s.getImageData(0,0,t,n).data;for(let e=r.length/4;e--;)r[4*e]=r[4*e+1]=r[4*e+2]=r[4*e+3];return o.remove(),(0,i.l)(r,r.length)}(e);const n=e.currentImageEntity.naturalWidth,o=e.currentImageEntity.naturalHeight,s=null==(t=e.object)?void 0:t.stageRef,a=e.parent;if(!s)return void console.error(`Stage not found for area #${e.cleanId}`);const l=s.findOne(`#${e.cleanId}`);if(!l)return console.error(`Layer #${e.id} was not found on Stage`),[];const c=l.visible();!c&&l.show(),l.findOne(".highlight").hide();const d=s.getWidth(),u=s.getHeight(),h=s.getScaleX(),g=s.getScaleY(),m=s.getX(),p=s.getY(),f=s.getOffsetX(),v=s.getOffsetY(),y=s.getRotation();s.setWidth(a.stageWidth).setHeight(a.stageHeight).setScaleX(1).setScaleY(1).setX(0).setY(0).setOffsetX(0).setOffsetY(0).setRotation(0),s.drawScene();const b=l.toCanvas({pixelRatio:n/e.currentImageEntity.stageWidth}).getContext("2d").getImageData(0,0,n,o);for(let e=b.data.length/4;e--;)b.data[4*e]=b.data[4*e+1]=b.data[4*e+2]=b.data[4*e+3];l.findOne(".highlight").show(),s.setWidth(d).setHeight(u).setScaleX(h).setScaleY(g).setX(m).setY(p).setOffsetX(f).setOffsetY(v).setRotation(y),s.drawScene();const x=(0,i.l)(b.data,b.data.length);return!c&&l.hide(),x},RLE2Region:function(e,{color:t=s.A.FILL_COLOR}={}){const{rle:n}=e,a=e.currentImageEntity.naturalWidth,r=e.currentImageEntity.naturalHeight,l=document.createElement("canvas"),c=l.getContext("2d");l.width=a,l.height=r;const d=c.createImageData(a,r),u=(0,i.D)(n);d.data.set(u,0);const h=(0,o.A)(t).rgb();for(let e=d.data.length/4;e--;)d.data[4*e+3]&&(d.data[4*e]=h[0],d.data[4*e+1]=h[1],d.data[4*e+2]=h[2]);c.putImageData(d,0,0);const g=new Image;return g.src=l.toDataURL(),g},mask2DataURL:function(e,t,n,i){const o=document.createElement("canvas"),s=o.getContext("2d");return o.width=t,o.height=n,l(s,e,t,n,i,1),o.toDataURL()},maskDataURL2Image:function(e,{color:t=s.A.FILL_COLOR}={}){return new Promise((n,i)=>{const o=document.createElement("img");o.onload=()=>{const e=document.createElement("canvas"),i=o.width,s=o.height;e.width=i,e.height=s;const a=e.getContext("2d");a.drawImage(o,0,0);const r=a.getImageData(0,0,i,s);l(a,r.data,i,s,t,4),o.src=e.toDataURL(),n(o)},o.src=e})},createBrushSizeCircleCursor:function(e){const t=document.createElement("canvas"),n=t.getContext("2d"),i=e+8,o=i/2,s=e/2;return t.width=i,t.height=i,n.beginPath(),n.arc(o,o,s,0,2*Math.PI,!1),n.lineWidth=3,n.strokeStyle="black",n.stroke(),n.beginPath(),n.arc(o,o,s,0,2*Math.PI,!1),n.lineWidth=2,n.strokeStyle="white",n.stroke(),`url('${t.toDataURL()}') ${o} ${o}, auto`},labelToSVG:(()=>{const e={};return({label:t,score:n})=>{let i=t;if(null!==n&&(i+=n),i in e)return e[i];let o=0;const s=[];if(null!=n){const e=a.getScaleGradient(n);s.push(`<rect x="0" y="0" rx="2" ry="2" width="24" height="14" style="fill:${e};opacity:0.5" />`),s.push(`<text x="3" y="10" style="font-size: 8px; font-family: var(--font-mono);">${n.toFixed(2)}</text>`),o+=26}t&&(s.push(`<text x="${o}" y="11" style="font-size: 9.5px; font-weight: bold; font-family: var(--font-mono);">${t}</text>`),o=o+function(e){const t=document.createElement("svg"),n=document.createElement("text");n.style="font-size: 9.5px; font-weight: bold; color: red; fill: red; font-family: var(--font-mono);",n.innerHTML=e,t.appendChild(n),document.body.appendChild(t);const i=n.getBoundingClientRect().width;return t.remove(),i}(t)+2);const r=function(e){return`'data:image/svg+xml,${(e=e.replace(/\s{2,}/g," ")).replace(/[\r\n%#()<>?[\\\]^`{|}]/g,encodeURIComponent)}'`}(`<svg xmlns="http://www.w3.org/2000/svg" height="16" width="${o}">${s.join("")}</svg>`);return e[i]=r,r}})(),trim:e=>{var t,n;let i,o=e.width,s=e.height;const a=e.getContext("2d"),r={top:null,left:null,right:null,bottom:null};try{i=document.createElement("canvas").getContext("2d");const t=a.getImageData(0,0,e.width,e.height),n=t.data.length;let l,c,d;for(l=0;l<n;l+=4)0!==t.data[l+3]&&(c=l/4%e.width,d=~~(l/4/e.width),null===r.top&&(r.top=d),(null===r.left||c<r.left)&&(r.left=c),(null===r.right||r.right<c)&&(r.right=c),(null===r.bottom||r.bottom<d)&&(r.bottom=d));o=r.right-r.left,s=r.bottom-r.top;const u=a.getImageData(r.left,r.top,o,s);i.canvas.width=o,i.canvas.height=s,i.putImageData(u,0,0)}catch(e){}return{canvas:null!=(t=null==(n=i)?void 0:n.canvas)?t:e,bbox:Object.assign({},r,{width:o,height:s})}}}},81117:()=>{0},83499:(e,t,n)=>{"use strict";function i(e,t){var n;const i="undefined"!=typeof window&&null!=(o=window.APP_SETTINGS)&&null!=(o=o.billing)&&o.enterprise?"https://docs.humansignal.com/":"https://labelstud.io/";var o;const s="undefined"!=typeof window&&(null==(n=window.APP_SETTINGS)||null==(n=n.billing)?void 0:n.enterprise)&&t?t:e;return`${i.replace(/\/$/,"")}/${s.replace(/^\//,"")}`}n.d(t,{T:()=>i})},84411:(e,t,n)=>{"use strict";n.r(t),n.d(t,{applyHighlightStylesToDoc:()=>T,createClass:()=>h,findByXpath:()=>A,findIdxContainer:()=>R,findNodeAt:()=>M,getNodesInRange:()=>y,getTextNodesInRange:()=>b,highlightRange:()=>S,htmlEscape:()=>I,isValidTreeNode:()=>v,labelWithCSS:()=>u,mainOffsets:()=>P,matchesSelector:()=>_,moveStylesBetweenHeadTags:()=>N,normalizeBoundaries:()=>w,removeSpans:()=>j,sanitizeHtml:()=>E,splitBoundaries:()=>C,toGlobalOffset:()=>k,toggleLabelsAndScores:()=>d});var i=n(72829),o=n.n(i),s=n(48862),a=n(47521),r=n.n(a),l=n(78438),c=n(50494);function d(e){const t=t=>{const n=t.getElementsByClassName("htx-highlight");Array.from(n).forEach(t=>{t.classList.contains("htx-manual-label")||(e?t.classList.remove("htx-no-label"):t.classList.add("htx-no-label"))})},n=(0,c.cn)("htx-richtext").toClassName();t(document),document.querySelectorAll(`iframe.${n}`).forEach(e=>t(e.contentWindow.document))}const u=(()=>{const e={};return(t,{index:n,labels:i,score:o})=>{const a=i?i.join(","):"",r=[n,a].filter(Boolean).join(":"),c=s.hashCode(r+o);let d=`htx-label-${c}`;if(d=d.toLowerCase(),d in e)return e[d];t.setAttribute("data-labels",a);return h(`.${d}:after`,`content:${`url(${l.A.labelToSVG({label:r,score:o})})`}`),e[c]=!0,d}})();function h(e,t){const n=document.createElement("style");n.type="text/css",document.getElementsByTagName("head")[0].appendChild(n),(n.sheet||{}).insertRule?n.sheet.insertRule(`${e}{${t}}`,0):(n.styleSheet||n.sheet).addRule(e,t)}function g(e){return e.nodeType===Node.TEXT_NODE}function m(e){for(;e.hasChildNodes();)e=e.firstChild;return e}function p(e){for(;e.hasChildNodes();)e=e.lastChild;return e}function f(e){if(e.firstChild)return e.firstChild;for(;e;){if(e.nextSibling)return e.nextSibling;e=e.parentNode}}function v(e,t){for(;e;){if(t&&e===t)return!0;if(e.nodeType===Node.ELEMENT_NODE&&"true"===e.dataset.skipNode)return!1;e=e.parentNode}return!0}function y(e){const t=e.startContainer,n=e.endContainer,i=e.commonAncestorContainer,o=[];let s;for(s=t.parentNode;s&&(v(s,i)&&o.push(s),s!==i);s=s.parentNode);for(o.reverse(),s=t;s&&(v(s,i)&&o.push(s),s!==n);s=f(s));return o}function b(e){return y(e).filter(e=>g(e))}function x(e,t){const n=e.cloneNode(!1);return n.deleteData(0,t),e.deleteData(t,e.length-t),o()(n,e)}function w(e){let t,n,i,{startContainer:o,startOffset:s,endContainer:a,endOffset:r}=e;function l(e){return!!g(e)&&(!(e===o&&s>0)&&(e!==a||0!==r))}for(o.childNodes.length&&s>0&&(o=p(o.childNodes[s-1]),s=o.length||o.childNodes.length),r<a.childNodes.length&&(a=m(a.childNodes[r]),r=0),t=o,n=e=>e===i?null:function(e){if(e.firstChild)return e.firstChild;for(;!e.nextSibling;)if(!(e=e.parentNode))return null;return e.nextSibling}(e),i=p(a);t&&!l(t);)t=n(t);const c=t;for(t=a,n=e=>e===i?null:function(e){if(e.lastChild)return e.lastChild;for(;!e.previousSibling;)if(!(e=e.parentNode))return null;return e.previousSibling}(e),i=m(o);t&&!l(t);)t=n(t);const d=t;e.setStart(c,0),e.setEnd(d,d.length)}function S(e,t,n){null==t&&(t="htx-annotation");const i=/^\s*$/,o=b(e._range);let s=0;e._range.startOffset===o[s].length&&s++;let a=o.length;a>1&&o[o.length-1].length!==e._range.endOffset&&(a-=1);const r=[];for(let e=s,l=a;e<l;e++){const s=o[e];if(!i.test(s.nodeValue)){const e=window.document.createElement("span");e.style.backgroundColor=n.backgroundColor,e.className=t,s.parentNode.replaceChild(e,s),e.appendChild(s),r.push(e)}}return r}function C(e){let{startContainer:t,endContainer:n}=e;const{startOffset:i,endOffset:o}=e;g(n)&&o>0&&o<n.length&&(n=x(n,o),e.setEnd(n,0)),g(t)&&i>0&&i<t.length&&(t===n?(t=x(t,i),e.setEnd(t,o-i)):t=x(t,i),e.setStart(t,0))}const k=(e,t,n)=>{let i=0;const o=e=>{if(e===t)return i;"#text"===e.nodeName&&(i+=e.length),"BR"===e.nodeName&&(i+=1);for(let t=0;t<=e.childNodes.length;t++){const n=e.childNodes[t];if(n){const e=o(n);if(void 0!==e)return e}}};return n+o(e)},P=e=>{const t=window.getSelection().getRangeAt(0).cloneRange();let n=t.startOffset,i=t.endOffset,o=!1,s=!1;const a=e=>{if("#text"===e.nodeName&&(e===t.startContainer||o||(n+=e.length),e===t.startContainer&&(o=!0),e===t.endContainer||s||(i+=e.length),e===t.endContainer&&(s=!0)),"BR"===e.nodeName&&(o||(n+=1),s||(i+=1)),e.childNodes.length>0)for(let t=0;t<=e.childNodes.length;t++){const n=e.childNodes[t];if(n){const e=a(n);if(e)return e}}};return a(e),{start:n,end:i}},R=(e,t)=>{let n=t;const i=e=>{if(e)if("#text"===e.nodeName){if(n-e.length<=0)return e;n-=e.length}else if("BR"===e.nodeName)n-=1;else if(e.childNodes.length>0)for(let t=0;t<=e.childNodes.length;t++){const n=e.childNodes[t];if(n){const e=i(n);if(e)return e}}};return{node:i(e),len:n}};function j(e){const t=[];e&&e.forEach(e=>{for(;e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);t.push(e.parentNode),e.parentNode.removeChild(e)}),t.forEach(e=>e.normalize())}function N(e,t){const n={},i=document.createDocumentFragment();for(let t=0;t<e.children.length;){const o=e.children[t];if("STYLE"!==(null==o?void 0:o.tagName)){t++;continue}const s=o.sheet;try{const e=s.rules,t=n[o.id]=[];for(let n=0;n<e.length;n++)t.push(e[n].cssText)}finally{i.appendChild(o)}}t.appendChild(i),T(t.ownerDocument,n)}function T(e,t){for(let n=0;n<e.styleSheets.length;n++){const i=e.styleSheets[n].ownerNode;if(i.id)try{const e=t[i.id];if(!e)continue;for(let t=0;t<e.length;t++)i.sheet.insertRule(e[t])}catch(e){}}}const _=(e,t)=>e.matches(t)||null!==e.closest(t),A=(e,t=document)=>(t!==document&&"."!==e[0]&&(e=`.${e}`),document.evaluate(e,t,null,XPathResult.ANY_TYPE,null).iterateNext()),I=e=>{const t=`${e}`,n=/["'&<>]/.exec(t);if(!n)return t;let i,o="",s=0,a=0;for(s=n.index;s<t.length;s++){switch(t.charCodeAt(s)){case 34:i="&quot;";break;case 38:i="&amp;";break;case 39:i="&#39;";break;case 60:i="&lt;";break;case 62:i="&gt;";break;default:continue}a!==s&&(o+=t.substring(a,s)),a=s+1,o+=i}return a!==s?o+t.substring(a,s):o};function M(e,t){for(let n=e.firstChild,i=0;n;)if(n.textContent.length+i>=t){if(!n.firstChild)return[n,t-i];n=n.firstChild}else i+=n.textContent.length,n=n.nextSibling}function E(e=[]){if(!e)return"";const t=["www.youtube.com","youtube.com","www.youtube-nocookie.com","youtube-nocookie.com","youtu.be"],n=["onauxclick","onafterprint","onbeforematch","onbeforeprint","onbeforeunload","onbeforetoggle","onblur","oncancel","oncanplay","oncanplaythrough","onchange","onclick","onclose","oncontextlost","oncontextmenu","oncontextrestored","oncopy","oncuechange","oncut","ondblclick","ondrag","ondragend","ondragenter","ondragleave","ondragover","ondragstart","ondrop","ondurationchange","onemptied","onended","onerror","onfocus","onformdata","onhashchange","oninput","oninvalid","onkeydown","onkeypress","onkeyup","onlanguagechange","onload","onloadeddata","onloadedmetadata","onloadstart","onmessage","onmessageerror","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onoffline","ononline","onpagehide","onpageshow","onpaste","onpause","onplay","onplaying","onpopstate","onprogress","onratechange","onreset","onresize","onrejectionhandled","onscroll","onscrollend","onsecuritypolicyviolation","onseeked","onseeking","onselect","onslotchange","onstalled","onstorage","onsubmit","onsuspend","ontimeupdate","ontoggle","onunhandledrejection","onunload","onvolumechange","onwaiting","onwheel"],i={script:!0,iframe:!0};return r()(e,{allowedTags:!1,allowedAttributes:!1,disallowedTagsMode:"discard",allowVulnerableTags:!0,exclusiveFilter(e){if("iframe"===e.tag){var n;return!(e=>{if(!e)return!1;try{const n=new URL(e);return"https:"===n.protocol&&t.includes(n.hostname)}catch(e){return!1}})(null==(n=e.attribs)?void 0:n.src)}return i[e.tag]},nonTextTags:["script","textarea","option","noscript"],transformTags:{iframe:(e,t)=>({tagName:e,attribs:t}),"*":(e,t)=>(Object.keys(t).forEach(e=>{n.includes(e)&&delete t[e]}),{tagName:e,attribs:t})}})}},84826:(e,t,n)=>{"use strict";var i,o,s,a;n.d(t,{$b:()=>r,Bg:()=>L,C8:()=>T,F2:()=>P,F5:()=>M,Gd:()=>m,Gs:()=>S,H:()=>f,I8:()=>O,JO:()=>B,JZ:()=>F,K3:()=>p,LG:()=>w,P2:()=>I,RI:()=>c,SL:()=>V,SM:()=>j,TU:()=>g,Tm:()=>H,U2:()=>z,VS:()=>W,aT:()=>v,bA:()=>b,cE:()=>y,fw:()=>d,gF:()=>k,id:()=>u,jS:()=>C,ji:()=>h,ow:()=>x,pG:()=>E,pN:()=>K,q$:()=>N,um:()=>A,x0:()=>l,xB:()=>D,y8:()=>R,yD:()=>_});const r="fflag_fix_front_dev_1284_auto_detect_undo_281022_short",l="ff_front_dev_1442_unselect_shape_on_click_outside_080622_short",c="ff_front_dev_1536_taxonomy_user_labels_150222_long",d="ff_front_dev_2669_paragraph_author_filter_210622_short",u="ff_front_dev_2671_anchor_rotate_bbox_010722_short",h="fflag_feat_optic_2123_audio_spectrograms",g="fflag_feat_dev_2755_regions_list_grouped_by_labels_with_ordered_collapse_short",m="fflag_fix_front_dev_2918_labeling_filtered_paragraphs_250822_short",p="fflag-feat-dev-3034-comments-with-drafts-short",f="fflag_feat_front_dev_3077_repeater_tag_loading_performance_short",v="fflag_fix_front_dev_3377_image_regions_shift_on_resize_280922_short",y="fflag_fix_front_dev_3391_interactive_view_all",b="fflag_feat_front_dev_3873_labeling_ui_improvements_short",x="fflag_fix_back_dev_4174_overlap_issue_experiments_10012023_short",w="fflag_feat_front_lsdv_e_278_contextual_scrolling_short",S="fflag_feat_front_bros_199_enable_select_all_in_ner_phrase_short",C="fflag_feat_all_lsdv_e_294_llm_annotations_180723_long",k="fflag_feat_front_lsdv_4583_multi_image_segmentation_short",P="fflag_feat_front_lsdv_4583_6_images_preloading_short",R="fflag_fix_front_lsdv_4600_lead_time_27072023_short",j="fflag_fix_front_lsdv_4620_memory_leaks_100723_short",N="fflag_fix_front_lsdv_4930_selection_tool_fixes_240423_short",T="fflag_fix_front_lsdv_4998_missed_dynamic_children_030523_short",_="fflag_feat_front_lsdv_5451_async_taxonomy_110823_short",A="fflag_feat_front_lsdv_5452_taxonomy_labeling_110823_short",I="fflag_fix_all_optic_79_task_count_is_wrong_short",M="fflag_fix_front_leap_443_select_annotation_once",E="fflag_fix_front_leap_32_zoom_perf_190923_short",K="fflag_fix_leap_466_text_sanitization",D="fflag_fix_leap_246_multi_object_hotkeys_160124_short",O="fflag_feat_all_leap_1081_reviewer_flow_updates",L="fflag_feat_all_leap_883_custom_script_270524_short",z="fflag_feat_all_leap_1181_bulk_annotation_short",B="fflag_feat_front_leap_1173_disable_postpone_skip_short",F="fflag_feat_front_optic_1479_improve_image_tag_memory_usage_short",H="fflag_fix_front_optic_1608_improve_video_frame_seek_precision_short",V="fflag_feat_all_fit_1304_strict_overlap";function $(){var e,t;return Object.assign({},null!=(e=null==(t=window.APP_SETTINGS)?void 0:t.feature_flags)?e:{})}function W(e){var t;const n=$(),i={fflag_fix_front_lsdv_4620_memory_leaks_100723_short:!1};return e in i?i[e]:e in n?!0===n[e]:!0===(null==(t=window.APP_SETTINGS)?void 0:t.feature_flags_default_value)}Object.assign(window,{APP_SETTINGS:Object.assign({},null!=(i=window.APP_SETTINGS)?i:{},{feature_flags:Object.assign({},null!=(o=null==(s=window.APP_SETTINGS)?void 0:s.feature_flags)?o:{},null!=(a=window.FEATURE_FLAGS)?a:{})})}),Object.assign(window,{getFeatureFlags:$,isFF:W})},93512:()=>{}}]);
//# sourceMappingURL=939.js.map